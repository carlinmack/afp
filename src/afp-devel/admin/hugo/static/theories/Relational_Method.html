<div id="Definitions">
<div class="head">
<h1>Theory Definitions</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Relational Method with Message Anonymity for the Verification of Cryptographic Protocols
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The relational method and message anonymity"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Definitions
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

\emph{This paper is dedicated to my mother, my favourite chess opponent -- in addition to being many
other wonderful things!}
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Introduction"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
As Bertrand Russell says in the last pages of \emph{A History of Western Philosophy}, a distinctive
feature of science is that "we can make successive approximations to the truth, in which each new
stage results from an improvement, not a rejection, of what has gone before". When dealing with a
formal verification method for information processing systems, such as Paulson's inductive method
for the verification of cryptographic protocols (cf. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Paulson98"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Paulson20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>), a
more modest goal for this iterative improvement process, yet of significant practical importance, is
to streamline the definitions and proofs needed to model such a system and verify its properties.

With this aim, specially when it comes to verifying protocols using public key cryptography, this
paper proposes an enhancement of the inductive method, named \emph{relational method} for reasons
clarified in what follows, and puts it into practice by verifying a sample protocol. This new method
is the result of some changes to the way how events, states, spy's capabilities, and the protocol
itself are formalized in the inductive method. Here below is a description of these changes, along
with a rationale for them.

  <span class="antiquoted"><span class="antiquoted">➧</span></span>[Events.] In the inductive method, the fundamental building blocks of cryptographic protocols are
events of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Says A B X"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a message being exchanged, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">A</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
the agent that sends it, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">B</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the agent to which it is addressed.
\\However, any exchanged message can be intercepted by the spy and forwarded to any other agent, so
its intended recipient is not relevant for the protocol \emph{security} correctness -- though of
course being relevant for the protocol \emph{functional} correctness. Moreover, a legitimate agent
may also generate messages, e.g. ephemeral private keys, that she will never exchange with any other
agent. To model such an event, a datatype constructor other than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Says</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> should be used. How to
make things simpler?
\\The solution adopted in the relational method is to model events just as ordered pairs of the form
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(A, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">A</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an agent and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a message. If event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(A, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
stands for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">A</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s sending of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to another agent, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">A</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a legitimate agent,
then this event will be accompanied by event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, representing the spy's interception
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(A, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rather stands for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">A</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s generation of private message
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, e.g. an ephemeral private key, for her own exclusive use -- and if the spy has not hacked
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">A</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> so as to steal her private messages as well --, then no companion event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
will occur instead.

  <span class="antiquoted"><span class="antiquoted">➧</span></span>[States.] In the inductive method, the possible states of a cryptographic protocol are modeled as
event \emph{traces}, i.e. lists, and the protocol itself is formalized as a set of such traces.
Consequently, the protocol rules and security properties are expressed as formulae satisfied by any
event trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">evs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> belonging to this set.
\\However, these formulae are such that their truth values depend only on the events contained in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">evs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, rather than on the actual order in which they occur -- in fact, robust protocol rules
and security properties cannot depend on the exact sequence of message exchanges in a scenario where
the spy can freely intercept and forward messages, or even generate and send her own ones. Thus, one
library function, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> set<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and two custom recursive functions, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">used</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">knows</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
are needed to convert event traces into event sets and message sets, respectively.
\\In the relational method, protocol states are simply modeled as event sets, so that the occurrence
of event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(A, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be expressed as the transition to the augmented
state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"insert <span class="main"><span class="main">(</span></span><span class="free"><span class="free">A</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">X</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Hence, states consist of relations between agents and messages. As
a result, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> set<span class="antiquote"><span class="antiquote">}</span></span></span></span> need not be used any longer, whereas functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">used</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">spied</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- the latter one being a replacement for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"knows Spy"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> --, which take a state
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as input, are mere abbreviations for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Range <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">``</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">Spy</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  <span class="antiquoted"><span class="antiquoted">➧</span></span>[Spy's capabilities.] In the inductive method, the spy's attack capabilities are formalized via
two inductively defined functions, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, used to construct the sets of
all the messages that the spy can learn -- <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"analz (knows Spy evs)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- and send to legitimate
agents -- <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"synth (analz (knows Spy evs))"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- downstream of event trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">evs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\\Indeed, the introduction of these functions goes in the direction of decoupling the formalization
of the spy's capabilities from that of the protocol itself, consistently with the fact that what the
spy can do is independent of how the protocol works -- which only matters when it comes to verifying
protocol security.
\\In principle, this promises to provide a relevant benefit: these functions need to be defined, and
their properties to be proven, just once, whereupon such definitions and properties can be reused in
the formalization and verification of whatever protocol.
\\In practice, since both functions are of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"msg set ⇒ msg set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
the datatype defining all possible message formats, this benefit only applies as long as message
formats remain unchanged. However, when it comes to verifying a protocol making use of public key
cryptography, some new message format, and consequently some new related spy's capability as well,
are likely to be required. An example of this will be provided right away by the protocol considered
in this paper.
\\In the relational method, the representation of events as agent-message pairs offers a simpler way
to model the spy's capabilities, namely as supplementary protocol rules, analogous to the inductive
method's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Fake</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rule, augmenting a state by one or more events of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
In addition to eliminating the need for functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">analz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- which, in light
of the above considerations, does not significantly harm reusability --, this choice also abolishes
any distinction between what the spy can learn and what she can send. In fact, a state containing
event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, X)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is interpreted as one where the spy both knows message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and may
have sent it to whatever legitimate agent. Actually, this formalizes the facts that a real-world
attacker is free to send any message she has learned to any other party, and conversely to use any
message she has generated to further augment her knowledge.
\\In the inductive method, the former fact is modeled by property <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">H</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">synth</span></span> <span class="free"><span class="free">H</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but the latter one has no formal counterpart, as in general <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">H</span></span> <span class="main"><span class="main">⊂</span></span> <span class="free"><span class="free">synth</span></span> <span class="free"><span class="free">H</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
This limitation on the spy's capabilities is not significant as long as the protocol makes use of
static keys only, but it is if session keys or ephemeral key pairs are generated -- as happens in
key establishment protocols, even in those using symmetric cryptography alone. In any such case, a
realistic spy must also be able to learn from anything she herself has generated, such as a nonce or
an ephemeral private key -- a result achieved without effort in the relational method.
\\An additional, nontrivial problem for the inductive method is that many protocols, including key
establishment ones, require the spy to be able to generate \emph{fresh} ephemeral messages only, as
otherwise the spy could succeed in breaking the protocol by just guessing the ephemeral messages
already generated at random by some legitimate agent -- a quite unrealistic attack pattern, provided
that such messages vary in a sufficiently wide range. At first glance, this need could be addressed
by extending the inductive definition of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with introduction rules of the form
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Nonce</span></span> <span class="free"><span class="free">n</span></span> <span class="main"><span class="main">∉</span></span> <span class="free"><span class="free">H</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">Nonce</span></span> <span class="free"><span class="free">n</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">synth</span></span> <span class="free"><span class="free">H</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">PriKey</span></span> <span class="free"><span class="free">A</span></span> <span class="main"><span class="main">∉</span></span> <span class="free"><span class="free">H</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">PriKey</span></span> <span class="free"><span class="free">A</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">synth</span></span> <span class="free"><span class="free">H</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
However, private ephemeral messages are not in general included in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"analz (knows Spy evs)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
since nonces may be encrypted with uncompromised keys when exchanged and private keys are usually
not exchanged at all, so this approach would not work. The only satisfactory alternative would be to
change the signature of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">synth</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, e.g. by adding a second input message set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
standing for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"used evs"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or else by replacing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with event trace <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">evs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> itself,
but this would render the function definition much more convoluted -- a problem easily bypassed in
the relational method.

  <span class="antiquoted"><span class="antiquoted">➧</span></span>[Protocol.] In the inductive method, a cryptographic protocol consists of an inductively defined
set of event traces. This enables to prove the protocol security properties by induction using the
induction rule automatically generated as a result of such an inductive definition, i.e. by means of
\emph{rule induction}. Actually, this feature is exactly what gives the method its very name. Hence,
a consistent way to name a protocol verification method using some other form of induction would be
to replace adjective "inductive" with another one referring to that form of induction.
\\The relational method owes its name to this consideration. In this method, the introduction rules
defining \emph{protocol rules}, i.e. the possible transitions between protocol states, are replaced
with \emph{relations} between states, henceforth named \emph{protocol relations}. That is, for any
two states <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, there exists a transition leading from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
just in case the ordered pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">s</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s'</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is contained in at least one protocol relation --
a state of affairs denoted using infix notation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s ⊢ s'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then, the inductively defined set
itself is replaced with the \emph{reflexive transitive closure} of the union of protocol relations.
Namely, any state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may be reached from \emph{initial state} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, viz. is a possible
protocol state, just in case pair <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> lies within this reflexive transitive closure --
a state of affairs denoted using infix notation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"s<span class="hidden">⇩</span><sub>0</sub> ⊨ s"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As a result, rule induction is
replaced with induction over reflexive transitive closures via rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rtrancl_induct<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which is the circumstance that originates the method name.
\\These changes provide the following important benefits.

    <span class="antiquoted"><span class="antiquoted">▪</span></span> Inserting and modifying the formal definition of a protocol is much more comfortable. In fact,
any change even to a single introduction rule within a monolithic inductive set definition entails a
re-evaluation of the whole definition, whereas each protocol relation will have its own stand-alone
definition, which also makes it easier to find errors. This advantage may go almost unnoticed for a
very simple protocol providing for just a few protocol rules, but gets evident in case of a complex
protocol. An example of this will be provided by the protocol considered in this paper: when looking
at the self-contained abbreviations used to define protocol relations, the reader will easily grasp
how much more convoluted an equivalent inductive set definition would have been.

    <span class="antiquoted"><span class="antiquoted">▪</span></span> In addition to induction via rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] rtrancl_induct<span class="antiquote"><span class="antiquote">}</span></span></span></span>, a further powerful reasoning
pattern turns out to be available. It is based on the following general rule applying to reflexive
transitive closures (indeed, a rule so general and useful that it could rightfully become part of
the standard library), later on proven and assigned the name <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">rtrancl_start</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> [display] <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟦</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup></span></span><span class="main"><span class="main">;</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">;</span></span> <span class="main"><span class="main">¬</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">⟧</span></span> <span class="main"><span class="main">⟹</span></span>
<span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">u</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">u</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">r</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">r</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">¬</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">u</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
In natural language, this rule states that for any chain of elements linked by a relation, if some
predicate is false for the first element of the chain and true for the last one, there must exist a
link in the chain where the predicate becomes true.
\\This rule can be used to prove propositions of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟦s ⊨ s'; P s'[; Q]⟧ ⟹ R s'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for
any state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">P</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">¬</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, with an optional additional
assumption <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Q</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, without resorting to induction. Notably, \emph{regularity lemmas} have exactly
this form, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">s<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">X</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">parts</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">used</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for some term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of
type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Q</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, if present, puts some constraint on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or its components.
\\Such a proof consists of two steps. First, lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟦s ⊢ s'; P s'; ¬ P s[; Q]⟧ ⟹ R s'"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
proven by simplification, using the definitions of protocol relations. Then, the target proposition
is proven by applying rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">rtrancl_start</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as a destruction rule (cf. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Paulson20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) and
proving <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by assumption, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">¬</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by simplification, and the residual subgoal
by means of the previous lemma.

In addition to the relational method, this paper is aimed at introducing still another enhancement:
besides message confidentiality and authenticity, it takes into consideration a further important
security property, \emph{message anonymity}. Being legitimate agents identified via natural numbers,
the fact that in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the spy ignores that message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X<span class="hidden">⇩</span><sub>n</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is associated with agent
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">n</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, viz. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X<span class="hidden">⇩</span><sub>n</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s property of being \emph{anonymous} in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, can be expressed
as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X<span class="hidden">⇩</span><sub>n</sub>⟩ ∉ spied s"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where notation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X<span class="hidden">⇩</span><sub>n</sub>⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> refers to a new constructor added to
datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> precisely for this purpose.

A basic constraint upon any protocol relation augmenting the spy's knowledge with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is that the spy must know message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the current state, as it is impossible to identify
the agent associated with an unknown message. There is also an additional, more subtle constraint.
Any such protocol relation either augments a state in which the spy knows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, C X<span class="hidden">⇩</span><sub>1</sub> … X<span class="hidden">⇩</span><sub>m</sub>⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
i.e. containing event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, ⟨n, C X<span class="hidden">⇩</span><sub>1</sub> … X<span class="hidden">⇩</span><sub>m</sub>⟩)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, with event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, ⟨n, X<span class="hidden">⇩</span><sub>i</sub>⟩)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where
$1 \leq i \leq m$ and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">C</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is some constructor of datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or conversely augments
a state containing event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, ⟨n, X<span class="hidden">⇩</span><sub>i</sub>⟩)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Spy, ⟨n, C X<span class="hidden">⇩</span><sub>1</sub> … X<span class="hidden">⇩</span><sub>m</sub>⟩)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. However, the
latter spy's inference is justified only if the compound message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"C X<span class="hidden">⇩</span><sub>1</sub> … X<span class="hidden">⇩</span><sub>m</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is part of a
message generated or accepted by some legitimate agent according to the protocol rules. Otherwise,
that is, if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"C X<span class="hidden">⇩</span><sub>1</sub> … X<span class="hidden">⇩</span><sub>m</sub>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> were just a message generated at random by the spy, her inference
would be as sound as those of most politicians and all advertisements: even if the conclusion were
true, it would be so by pure chance.

This problem can be solved as follows.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> A further constructor <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Log</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, taking a message as input, is added to datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and every protocol relation modeling the generation or acceptance of a message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by some
legitimate agent must augment the current state with event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">Spy</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">Log</span></span> <span class="free"><span class="free">X</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\\In this way, the set of all the messages that have been generated or accepted by some legitimate
agent in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> matches <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Log</span></span> <span class="main"><span class="main">-`</span></span> <span class="free"><span class="free">spied</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> A function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">crypts</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is defined inductively. It takes a message set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as input, and
returns the least message set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">H</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">H'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and for any (even empty) list
of keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">KS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, if the encryption of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃X, Y⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Y, X⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Hash X"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">KS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is contained in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then the encryption of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">KS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
contained in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as well. 
\\In this way, the set of all the messages that are part of messages exchanged by legitimate agents,
viz. that may be mapped to agents, in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> matches <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">crypts</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Log</span></span> <span class="main"><span class="main">-`</span></span> <span class="free"><span class="free">spied</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Another function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">key_sets</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is defined, too. It takes two inputs, a message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
a message set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and returns the set of the sets of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">KS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>' inverse keys for any list of
keys <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">KS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that the encryption of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">KS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is included in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">H</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\\In this way, the fact that in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the spy can map a compound message <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to some
agent, provided that she knows all the keys in set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">U</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, can be expressed through conditions
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">U</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">key_sets</span></span> <span class="free"><span class="free">X</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">crypts</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">Log</span></span> <span class="main"><span class="main">-`</span></span> <span class="free"><span class="free">spied</span></span> <span class="free"><span class="free">s</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">U</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">spied</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\\The choice to define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">key_sets</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> so as to collect the inverse keys of encryption keys, viz.
decryption ones, depends on the fact that the sample protocol verified in this paper uses symmetric
keys alone -- which match their own inverse keys -- for encryption, whereas asymmetric key pairs are
used in cryptograms only for signature generation -- so that the inverse keys are public ones. In
case of a protocol (also) using public keys for encryption, encryption keys themselves should (also)
be collected, since the corresponding decryption keys, i.e. private keys, would be unknown to the
spy by default. This would formalize the fact that encrypted messages can be mapped to agents not
only by decrypting them, but also by recomputing the cryptograms (provided that the plaintexts are
known) and checking whether they match the exchanged ones.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"A sample protocol"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
As previously mentioned, this paper tries the relational method, including message anonymity, by
applying it to the verification of a sample authentication protocol in which Password Authenticated
Connection Establishment (PACE) with Chip Authentication Mapping (cf. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "ICAO15"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) is first
used by an \emph{owner} to establish a secure channel with her own \emph{asset} and authenticate it,
and then the owner sends a password (other than the PACE one) to the asset over that channel so as
to authenticate herself. This enables to achieve a reliable mutual authentication even if the PACE
key is shared by multiple owners or is weak, as happens in electronic passports. Although the PACE
mechanism is specified for use in electronic documents, nothing prevents it in principle from being
used in other kinds of smart cards or even outside of the smart card world, which is the reason why
this paper uses the generic names \emph{asset} and \emph{owner} for the card and the cardholder,
respectively.

In more detail, this protocol provides for the following steps. In this list, messages are specified
using the same syntax that will be adopted in the formal text (for further information about PACE
with Chip Authentication Mapping, cf. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "ICAO15"<span class="antiquote"><span class="antiquote">}</span></span></span></span>).

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Asset n} $\rightarrow$ \emph{Owner n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt (Auth_ShaKey n) (PriKey S)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Owner n} $\rightarrow$ \emph{Asset n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Num 1, PubKey A⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Asset n} $\rightarrow$ \emph{Owner n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Num 2, PubKey B⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Owner n} $\rightarrow$ \emph{Asset n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Num 3, PubKey C⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Asset n} $\rightarrow$ \emph{Owner n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Num 4, PubKey D⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Owner n} $\rightarrow$ \emph{Asset n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt (SesK SK) (PubKey D)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Asset n} $\rightarrow$ \emph{Owner n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Crypt (SesK SK) (PubKey C),"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\\\hspace*{1.5em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt (SesK SK) (Auth_PriK n ⊗ B),"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\\\hspace*{1.5em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt (SesK SK) (Crypt SigK"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\\\hspace*{2em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⦃Hash (Agent n), Hash (Auth_PubKey n)⦄)⦄"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Owner n} $\rightarrow$ \emph{Asset n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt (SesK SK) (Pwd n)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

  <span class="antiquoted"><span class="antiquoted">▸</span></span> \emph{Asset n} $\rightarrow$ \emph{Owner n}:
\\\hspace*{1em}<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt (SesK SK) (Num 0)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

Legitimate agents consist of an infinite population of assets and owners. For each natural number
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">n</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an owner and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is her own asset, and these agents
are assigned the following authentication data.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Key (Auth_ShaKey n)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: static symmetric PACE key shared by both agents.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PriKey n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PubKey n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: static private and public keys stored on
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and used for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s authentication via Chip Authentication Mapping.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Pwd n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: unique password (other than the PACE one) shared by both agents and used for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s authentication.

Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Pwd</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is defined as a constructor of datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and then is injective,
which formalizes the assumption that each asset-owner pair has a distinct password, whereas no such
constraint is put on functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Auth_ShaKey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Auth_PriKey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Auth_PubKey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
which allows multiple asset-owner pairs to be assigned the same keys. On the other hand, function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Auth_PriKey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is constrained to be such that the complement of its range is infinite. As each
protocol run requires the generation of fresh ephemeral private keys, this constraint ensures that
an unbounded number of protocol runs can be carried out. All assumptions are formalized by applying
the definitional approach, viz. without introducing any axiom, and so is this constraint, expressed
by defining function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Auth_PriKey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> using the indefinite description operator <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">SOME</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The protocol starts with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> sending an ephemeral private key encrypted with the PACE
key to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Actually, if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a smart card, the protocol should rather
start with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> sending a plain request for such encrypted nonce, but this preliminary
step is omitted here as it is irrelevant for protocol security. After that, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> generate two ephemeral key pairs each and send the respective public keys to the
other party.

Then, both parties agree on the same session key by deriving it from the ephemeral keys generated
previously (actually, two distinct session keys would be derived, one for encryption and the other
one for MAC computation, but such a level of detail is unnecessary for protocol verification). The
session key is modeled as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Key (SesK SK)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">SesK</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an apposite constructor
added to datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">key</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">SK</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">(</span></span>Some <span class="free"><span class="free">S</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">A</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">B</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">C</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">D</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The adoption of type
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the first component enables to represent as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span>None<span class="main"><span class="main">,</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">A</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">B</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">{</span></span><span class="free"><span class="free">C</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">D</span></span><span class="main"><span class="main">}</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
the wrong session key derived from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PriKey S"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> was encrypted using a key
other than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Key (Auth_ShaKey n)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- which reflects the fact that the protocol goes on even
without the two parties sharing the same session key. The use of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat set"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the other
two components enables the spy to compute <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Key (SesK SK)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if she knows \emph{either} private
key and the other public key referenced by each set, as long as she also knows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PriKey S"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> --
which reflects the fact that given two key pairs, Diffie-Hellman key agreement generates the same
shared secret independently of which of the respective private keys is used for computation.

This session key is used by both parties to compute their authentication tokens. Both encrypt the
other party's second ephemeral public key, but <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> appends two further fields: the
Encrypted Chip Authentication Data, as provided for by Chip Authentication Mapping, and an encrypted
signature of the hash values of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Agent n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PubKey n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Infix notation
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PriK n ⊗ B"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> refers to a constructor of datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">msg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> standing for plain Chip
Authentication Data, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Agent</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is another such constructor standing for agent identification
data. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is expected to validate this signature by also checking <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Agent n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s
hash value against reference identification data known by other means -- otherwise, the spy would
not be forced to know <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PriKey n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to masquerade as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, since she could do
that by just knowing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PriKey m"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for some other <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">m</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, even if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Auth_PriKey</span></span> <span class="free"><span class="free">m</span></span>
<span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">Auth_PriKey</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an electronic passport, the owner, i.e. the inspection
system, could get cardholder's identification data by reading her personal data on the booklet, and
such a signature could be retrieved from the chip (actually through a distinct message, but this is
irrelevant for protocol security as long as the password is sent after the signature's validation)
by reading the Document Security Object -- provided that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Auth_PubKey n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is included within
Data Group 14.

The protocol ends with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Owner n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> sending her password, encrypted with the session key, to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, who validates it and replies with an encrypted acknowledgment.

Here below are some concluding remarks about the way how this sample protocol is formalized.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> A single signature private key, unknown to the spy, is assumed to be used for all legitimate
agents. Similarly, the spy might have hacked some legitimate agent so as to steal her ephemeral
private keys as soon as they are generated, but here all legitimate agents are assumed to be out of
the spy's reach in this respect. Of course, this is just the choice of one of multiple possible
scenarios, and nothing prevents these assumptions from being dropped.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> In the real world, a legitimate agent would use any one of her ephemeral private keys just once,
after which the key would be destroyed. On the contrary, no such constraint is enforced here, since
it turns out to be unnecessary for protocol verification. There is a single exception, required for
the proof of a unicity lemma: after <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> has used <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PriKey B"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to compute her
authentication token, she must discard <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PriKey B"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> so as not to use this key any longer. The
way how this requirement is expressed emphasizes once more the flexibility of the modeling of events
in the relational method: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Asset n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PriKey B"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in this computation only if
event <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(Asset n, PubKey B)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not yet contained in the current state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and then
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is augmented with that event. Namely, events can also be used to model garbage collection!

  <span class="antiquoted"><span class="antiquoted">▪</span></span> The sets of the legitimate agents whose authentication data have been identified in advance (or
equivalently, by means other than attacking the protocol, e.g. by social engineering) by the spy are
defined consistently with the constraint that known data alone can be mapped to agents, as well as
with the definition of initial state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. For instance, the set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">bad_id_prikey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the
agents whose Chip Authentication private keys have been identified is defined as a subset of the set
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">bad_prikey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the agents whose Chip Authentication private keys have been stolen. Moreover,
all the signatures included in assets' authentication tokens are assumed to be already known to the
spy in state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s<span class="hidden">⇩</span><sub>0</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, so that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">bad_id_prikey</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> includes also any agent whose identification
data or Chip Authentication public key have been identified in advance.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> The protocol rules augmenting the spy's knowledge with some message of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
generally require the spy to already know some other message of the same form. There is just one
exception: the spy can infer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, Agent n⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Agent n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This expresses the fact
that the detection of identification data within a message generated or accepted by some legitimate
agent is in itself sufficient to map any known component of that message to the identified agent,
regardless of whether any data were already mapped to that agent in advance.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> As opposed to what happens for constructors <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"(⊗)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"MPair"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, there do not
exist two protocol rules enabling the spy to infer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, Crypt K X⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, Key K⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and vice versa. A single protocol rule is rather defined, which enables the spy
to infer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, Key K⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or vice versa, provided that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Crypt K X"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
has been exchanged by some legitimate agent. In fact, the protocol provides for just one compound
message made up of cryptograms, i.e. the asset's authentication token, and all these cryptograms are
generated using the same encryption key <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"Key (SesK SK)"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Thus, if two such cryptograms have
plaintexts <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X<span class="hidden">⇩</span><sub>1</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X<span class="hidden">⇩</span><sub>2</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the spy knows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X<span class="hidden">⇩</span><sub>1</sub>⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, she can infer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, X<span class="hidden">⇩</span><sub>2</sub>⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
by inferring <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, Key (SesK SK)⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, viz. she need not know <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"⟨n, Crypt (SesK SK) X<span class="hidden">⇩</span><sub>1</sub>⟩"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
to do that.

The formal content is split into the following sections.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Section \ref{Definitions}, \emph{Definitions}, contains all the definitions needed to formalize
the sample protocol by means of the relational method, including message anonymity.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Section \ref{Authentication}, \emph{Confidentiality and authenticity properties}, proves that
the following theorems hold under appropriate assumptions.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">sigkey_secret</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the signature private key is secret.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">auth_shakey_secret</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset-owner pair's PACE key is secret.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">auth_prikey_secret</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset's Chip Authentication private key is secret.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">owner_seskey_unique</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an owner's session key is unknown to other owners.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">owner_seskey_secret</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an owner's session key is secret.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">owner_num_genuine</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the encrypted acknowledgment received by an owner has been
sent by the respective asset.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">owner_token_genuine</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the PACE authentication token received by an owner has
been generated by the respective asset, using her Chip Authentication private key and the same
ephemeral keys used to derive the session key.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">pwd_secret</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset-owner pair's password is secret.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">asset_seskey_unique</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset's session key is unknown to other assets, and
may be used by that asset to compute just one PACE authentication token.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">asset_seskey_secret</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset's session key is secret.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">asset_pwd_genuine</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the encrypted password received by an asset has been sent
by the respective owner.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">asset_token_genuine</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the PACE authentication token received by an asset has
been generated by the respective owner, using the same ephemeral key used to derive the session key.

  Particularly, these proofs confirm that the mutual authentication between an owner and her asset
is reliable even if their PACE key is compromised, unless either their Chip Authentication private
key or their password also is -- namely, the protocol succeeds in implementing a two-factor mutual
authentication.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Section \ref{Anonymity}, \emph{Anonymity properties}, proves that the following theorems hold
under appropriate assumptions.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">pwd_anonymous</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset-owner pair's password is anonymous.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">auth_prikey_anonymous</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset's Chip Authentication private key is
anonymous.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">auth_shakey_anonymous</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: an asset-owner pair's PACE key is anonymous.

  <span class="antiquoted"><span class="antiquoted">▪</span></span> Section \ref{Possibility}, \emph{Possibility properties}, shows how possibility properties (cf.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Paulson98"<span class="antiquote"><span class="antiquote">}</span></span></span></span>) can be proven by constructing sample protocol runs, either ordinary or attack
ones. Two such properties are proven:

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">runs_unbounded</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: for any possible protocol state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and any asset-owner
pair, there exists a state <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s'</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reachable from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in which a protocol run has been
completed by those agents using an ephemeral private key <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"PriKey S"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> not yet exchanged in
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">s</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> -- namely, an unbounded number of protocol runs can be carried out by legitimate agents.

    <span class="antiquoted"><span class="antiquoted">▸</span></span> Theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">pwd_compromised</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: in a scenario not satisfying the assumptions of theorem
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">pwd_anonymous</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the spy can steal an asset-owner pair's password and even identify those
agents.

  The latter is an example of a possibility property aimed at confirming that the assumptions of a
given confidentiality, authenticity, or anonymity property are necessary for it to hold.

For further information about the formal definitions and proofs contained in these sections, see
Isabelle documentation, particularly <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Paulson20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Nipkow20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Krauss20"<span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Nipkow11"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\textbf{Important note.} This sample protocol was already considered in a former paper of mine (cf.
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> "Noce17"<span class="antiquote"><span class="antiquote">}</span></span></span></span>). For any purpose, that paper should be regarded as being obsolete and superseded
by the present paper.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Definitions"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{Definitions}
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> agent_id <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> key_id <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> seskey_in <span class="main">=</span> <span class="quoted"><span class="quoted">"key_id option <span class="main">×</span> key_id set <span class="main">×</span> key_id set"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> agent <span class="main">=</span>
  Asset <span class="quoted">agent_id</span> <span class="main">|</span>
  Owner <span class="quoted">agent_id</span> <span class="main">|</span>
  Spy

<span class="keyword1"><span class="command">datatype</span></span> key <span class="main">=</span>
  SigK <span class="main">|</span>
  VerK <span class="main">|</span>
  PriK <span class="quoted">key_id</span> <span class="main">|</span>
  PubK <span class="quoted">key_id</span> <span class="main">|</span>
  ShaK <span class="quoted">key_id</span> <span class="main">|</span>
  SesK <span class="quoted">seskey_in</span>

<span class="keyword1"><span class="command">datatype</span></span> msg <span class="main">=</span>
  Num <span class="quoted">nat</span> <span class="main">|</span>
  Agent <span class="quoted">agent_id</span> <span class="main">|</span>
  Pwd <span class="quoted">agent_id</span> <span class="main">|</span>
  Key <span class="quoted">key</span> <span class="main">|</span>
  Mult <span class="quoted">key_id</span> <span class="quoted">key_id</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">⊗</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span> <span class="main">|</span>
  Hash <span class="quoted">msg</span> <span class="main">|</span>
  Crypt <span class="quoted">key</span> <span class="quoted">msg</span> <span class="main">|</span>
  MPair <span class="quoted">msg</span> <span class="quoted">msg</span> <span class="main">|</span>
  IDInfo <span class="quoted">agent_id</span> <span class="quoted">msg</span> <span class="main">|</span>
  Log <span class="quoted">msg</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_MPair"</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span><span class="main">,</span> args<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">⦃</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">⦄</span><span class="keyword3">)</span>"</span><span class="main">)</span>
  <span class="quoted">"_IDInfo"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>agent_id<span class="main">,</span> msg<span class="main">]</span> <span class="main">⇒</span> msg"</span></span>      <span class="main">(</span><span class="quoted">"<span class="keyword3">(2</span><span class="keyword1">⟨</span>_<span class="keyword1">,</span><span class="keyword3">/ </span>_<span class="keyword1">⟩</span><span class="keyword3">)</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">⦄</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="main">⦃</span><span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">⦄</span><span class="main">⦄</span>"</span>
  <span class="quoted">"<span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> MPair <span class="free">X</span> <span class="free">Y</span>"</span>
  <span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span>"</span> <span class="main">⇌</span> <span class="quoted">"<span class="keyword1">CONST</span> IDInfo <span class="free">n</span> <span class="free">X</span>"</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SigKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">SigKey</span> <span class="main">≡</span> Key SigK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">VerKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">VerKey</span> <span class="main">≡</span> Key VerK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PriKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">PriKey</span> <span class="main">≡</span> Key <span class="main">∘</span> PriK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">PubKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">PubKey</span> <span class="main">≡</span> Key <span class="main">∘</span> PubK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ShaKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ShaKey</span> <span class="main">≡</span> Key <span class="main">∘</span> ShaK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">SesKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"seskey_in <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">SesKey</span> <span class="main">≡</span> Key <span class="main">∘</span> SesK"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">InvK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> SigK <span class="main">=</span> VerK"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> VerK <span class="main">=</span> SigK"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> <span class="main">(</span>PriK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> PubK <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> <span class="main">(</span>PubK <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> PriK <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> <span class="main">(</span>ShaK <span class="free"><span class="bound"><span class="entity">SK</span></span></span><span class="main">)</span> <span class="main">=</span> ShaK <span class="free"><span class="bound"><span class="entity">SK</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">InvK</span> <span class="main">(</span>SesK <span class="free"><span class="bound"><span class="entity">SK</span></span></span><span class="main">)</span> <span class="main">=</span> SesK <span class="free"><span class="bound"><span class="entity">SK</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">InvKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">InvKey</span> <span class="main">≡</span> Key <span class="main">∘</span> InvK"</span></span>


<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">parts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

parts_used <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

parts_crypt <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

parts_fst <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

parts_snd <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">parts</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">crypts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set <span class="main">⇒</span> msg set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">H</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>

crypts_used <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

crypts_hash <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr Crypt <span class="free"><span class="bound"><span class="entity">KS</span></span></span> <span class="main">(</span>Hash <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span> <span class="main">⟹</span> foldr Crypt <span class="free"><span class="bound"><span class="entity">KS</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

crypts_fst <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr Crypt <span class="free"><span class="bound"><span class="entity">KS</span></span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span> <span class="main">⟹</span> foldr Crypt <span class="free"><span class="bound"><span class="entity">KS</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span>"</span></span> <span class="main">|</span>

crypts_snd <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr Crypt <span class="free"><span class="bound"><span class="entity">KS</span></span></span> <span class="main">⦃</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">⦄</span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span> <span class="main">⟹</span> foldr Crypt <span class="free"><span class="bound"><span class="entity">KS</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∈</span> <span class="free">crypts</span> <span class="free">H</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">key_sets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg set <span class="main">⇒</span> msg set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">key_sets</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">{</span>InvKey <span class="main">`</span> set <span class="bound">KS</span> <span class="main">|</span> <span class="bound">KS</span><span class="main">.</span> foldr Crypt <span class="bound">KS</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parts_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">parts_msg</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> parts <span class="main">{</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">crypts_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">crypts_msg</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> crypts <span class="main">{</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">key_sets_msg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"msg <span class="main">⇒</span> msg <span class="main">⇒</span> msg set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">key_sets_msg</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> key_sets <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">seskey_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"seskey_in <span class="main">⇒</span> key_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">seskey_set</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">seskey_set</span> <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Auth_PriK</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key_id"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Auth_PriK</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">f</span><span class="main">.</span> infinite <span class="main">(</span><span class="main">-</span> range <span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Auth_PriKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Auth_PriKey</span> <span class="main">≡</span> PriKey <span class="main">∘</span> Auth_PriK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Auth_PubKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Auth_PubKey</span> <span class="main">≡</span> PubKey <span class="main">∘</span> Auth_PriK"</span></span>

<span class="keyword1"><span class="command">consts</span></span> Auth_ShaK <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key_id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Auth_ShaKey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Auth_ShaKey</span> <span class="main">≡</span> ShaK <span class="main">∘</span> Auth_ShaK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Sign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key_id <span class="main">⇒</span> msg"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Sign</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> Crypt SigK <span class="main">⦃</span>Hash <span class="main">(</span>Agent <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>PubKey <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">⦄</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> key_id <span class="main">⇒</span> key_id <span class="main">⇒</span> key_id <span class="main">⇒</span> seskey_in <span class="main">⇒</span> msg"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Token</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">SK</span></span></span> <span class="main">≡</span> <span class="main">⦃</span>Crypt <span class="main">(</span>SesK <span class="free"><span class="bound"><span class="entity">SK</span></span></span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">,</span>
  Crypt <span class="main">(</span>SesK <span class="free"><span class="bound"><span class="entity">SK</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free"><span class="bound"><span class="entity">SK</span></span></span><span class="main">)</span> <span class="main">(</span>Sign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">⦄</span>"</span></span>


<span class="keyword1"><span class="command">consts</span></span> bad_agent <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_pwd <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_shak <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_id_pwd <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_id_prik <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_id_pubk <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">consts</span></span> bad_id_shak <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bad_prik</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"key_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_prik</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">⊆</span> range Auth_PriK"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bad_prikey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_prikey</span> <span class="main">≡</span> Auth_PriK <span class="main">-`</span> bad_prik"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bad_shakey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_shakey</span> <span class="main">≡</span> Auth_ShaK <span class="main">-`</span> bad_shak"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bad_id_password</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_id_password</span> <span class="main">≡</span> bad_id_pwd <span class="main">∩</span> bad_pwd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bad_id_prikey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_id_prikey</span> <span class="main">≡</span> <span class="main">(</span>bad_agent <span class="main">∪</span> bad_id_pubk <span class="main">∪</span> bad_id_prik<span class="main">)</span> <span class="main">∩</span> bad_prikey"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bad_id_pubkey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_id_pubkey</span> <span class="main">≡</span> bad_agent <span class="main">∪</span> bad_id_pubk <span class="main">∪</span> bad_id_prik <span class="main">∩</span> bad_prikey"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">bad_id_shakey</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bad_id_shakey</span> <span class="main">≡</span> bad_id_shak <span class="main">∩</span> bad_shakey"</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> event <span class="main">=</span> <span class="quoted"><span class="quoted">"agent <span class="main">×</span> msg"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> state <span class="main">=</span> <span class="quoted"><span class="quoted">"event set"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">used</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">used</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Range <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">spied</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> msg set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">spied</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">``</span> <span class="main">{</span>Spy<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">state</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">s<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≡</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Auth_PriKey <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> insert VerKey
  <span class="main">(</span>range Num <span class="main">∪</span> range Auth_PubKey <span class="main">∪</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Sign <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
   Agent <span class="main">`</span> bad_agent <span class="main">∪</span> Pwd <span class="main">`</span> bad_pwd <span class="main">∪</span> PriKey <span class="main">`</span> bad_prik <span class="main">∪</span> ShaKey <span class="main">`</span> bad_shak <span class="main">∪</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Pwd <span class="bound">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">`</span> bad_id_password <span class="main">∪</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Auth_PriKey <span class="bound">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">`</span> bad_id_prikey <span class="main">∪</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Auth_PubKey <span class="bound">n</span><span class="main">⟩</span><span class="main">)</span> <span class="main">`</span> bad_id_pubkey <span class="main">∪</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="bound">n</span><span class="main">)</span><span class="main">⟩</span><span class="main">)</span> <span class="main">`</span> bad_id_shakey<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_asset_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_asset_i</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">S</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span><span class="main">(</span>Spy<span class="main">,</span> Log <span class="main">(</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
  PriKey <span class="bound">S</span> <span class="main">∉</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_owner_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_owner_ii</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">S</span> <span class="bound">A</span> <span class="bound">K</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Owner <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Crypt <span class="bound">K</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∧</span>
  Crypt <span class="bound">K</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> used <span class="bound">s</span> <span class="main">∧</span>
  PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_asset_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_asset_ii</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span> <span class="main">∈</span> used <span class="bound">s</span> <span class="main">∧</span>
  PriKey <span class="bound">B</span> <span class="main">∉</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_owner_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_owner_iii</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Owner <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span> <span class="main">∈</span> used <span class="bound">s</span> <span class="main">∧</span>
  PriKey <span class="bound">C</span> <span class="main">∉</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_asset_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_asset_iii</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">D</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span> <span class="main">∈</span> used <span class="bound">s</span> <span class="main">∧</span>
  PriKey <span class="bound">D</span> <span class="main">∉</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_owner_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_owner_iv</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">S</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span> <span class="bound">K</span> <span class="bound">SK</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Owner <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">{</span>Crypt <span class="bound">K</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> used <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>Owner <span class="bound">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">n</span> <span class="keyword1">then</span> Some <span class="bound">S</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_asset_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_asset_iv</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">S</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span> <span class="bound">SK</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Asset <span class="bound">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">,</span>
      Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">{</span>Asset <span class="bound">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span>
    <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">,</span>
    Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> used <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_owner_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_owner_v</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Owner <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Token <span class="bound">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="bound">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
  Token <span class="bound">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span> <span class="main">∈</span> used <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="bound">SK</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_asset_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_asset_v</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">SK</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Asset <span class="bound">n</span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="bound">n</span><span class="main">)</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">s</span> <span class="main">∧</span>
  Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_prik</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_prik</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> PriKey <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_pubk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_pubk</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  PriKey <span class="bound">A</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_sesk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_sesk</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span> <span class="bound">S</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> SesKey <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_fact</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_fact</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span>
  <span class="bound">A</span> <span class="main">⊗</span> <span class="bound">B</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span>PriKey <span class="bound">A</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> PriKey <span class="bound">B</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_mult</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_hash</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> Hash <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">X</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_dec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_dec</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">K</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>Crypt <span class="bound">K</span> <span class="bound">X</span><span class="main">,</span> InvKey <span class="bound">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_enc</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">K</span> <span class="bound">X</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="bound">K</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span><span class="bound">X</span><span class="main">,</span> Key <span class="bound">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_sep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_sep</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_con</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_con</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_agent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_agent</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Agent <span class="bound">n</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  Agent <span class="bound">n</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_invk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_invk</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">K</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> InvKey <span class="bound">K</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">{</span>InvKey <span class="bound">K</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Key <span class="bound">K</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_sesk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_sesk</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">SK</span> <span class="bound">X</span> <span class="bound">U</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">{</span>PubKey <span class="bound">A</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">A</span> <span class="main">∈</span> seskey_set <span class="bound">SK</span> <span class="main">∧</span>
  SesKey <span class="bound">SK</span> <span class="main">∈</span> <span class="bound">U</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∈</span> key_sets <span class="bound">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_fact</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_fact</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_mult</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">U</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∪</span> <span class="main">{</span>PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">,</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∈</span> key_sets <span class="main">(</span><span class="bound">A</span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_hash</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_hash</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">X</span> <span class="bound">U</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Hash <span class="bound">X</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">X</span><span class="main">,</span> Hash <span class="bound">X</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> Hash <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∈</span> key_sets <span class="main">(</span>Hash <span class="bound">X</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_crypt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_crypt</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">X</span> <span class="bound">U</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> IDInfo <span class="bound">n</span> <span class="main">`</span> insert <span class="bound">X</span> <span class="bound">U</span> <span class="main">∧</span>
  insert <span class="bound">X</span> <span class="bound">U</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">K</span> <span class="main">∈</span> <span class="bound">U</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">K</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∈</span> key_sets <span class="bound">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_sep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_sep</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rel_id_con</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel_id_con</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="bound">n</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="bound">U</span><span class="main">.</span>
  <span class="bound">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span> <span class="main">∨</span> <span class="main">⟨</span><span class="bound">n</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
  <span class="bound">U</span> <span class="main">∈</span> key_sets <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>state <span class="main">×</span> state<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">≡</span> rel_asset_i <span class="main">∪</span> rel_owner_ii <span class="main">∪</span> rel_asset_ii <span class="main">∪</span> rel_owner_iii <span class="main">∪</span>
  rel_asset_iii <span class="main">∪</span> rel_owner_iv <span class="main">∪</span> rel_asset_iv <span class="main">∪</span> rel_owner_v <span class="main">∪</span> rel_asset_v <span class="main">∪</span>
  rel_prik <span class="main">∪</span> rel_pubk <span class="main">∪</span> rel_sesk <span class="main">∪</span> rel_fact <span class="main">∪</span> rel_mult <span class="main">∪</span> rel_hash <span class="main">∪</span> rel_dec <span class="main">∪</span>
  rel_enc <span class="main">∪</span> rel_sep <span class="main">∪</span> rel_con <span class="main">∪</span> rel_id_agent <span class="main">∪</span> rel_id_invk <span class="main">∪</span> rel_id_sesk <span class="main">∪</span>
  rel_id_fact <span class="main">∪</span> rel_id_mult <span class="main">∪</span> rel_id_hash <span class="main">∪</span> rel_id_crypt <span class="main">∪</span> rel_id_sep <span class="main">∪</span> rel_id_con"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">in_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> rel"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">in_rel_rtrancl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">)</span> <span class="main">∈</span> rel<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Authentication">
<div class="head">
<h1>Theory Authentication</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Relational Method with Message Anonymity for the Verification of Cryptographic Protocols
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Confidentiality and authenticity properties"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Authentication
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Definitions.html">Definitions</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{Authentication}
›</span></span>


<span class="keyword1"><span class="command">proposition</span></span> rtrancl_start <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?Q</span> <span class="free">x</span> <span class="free">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟶</span><span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?Q</span> <span class="free">x</span> <span class="skolem">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?Q</span> <span class="free">x</span> <span class="skolem">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="var">?Q</span> <span class="free">x</span> <span class="skolem">z</span> <span class="bound">u</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">x</span> <span class="skolem">y</span> <span class="skolem">u</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">x</span> <span class="skolem">z</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">proposition</span></span> state_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊨</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> spied_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊨</span> <span class="free">s'</span> <span class="main">⟹</span> spied <span class="free">s</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Image_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> state_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> used_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊨</span> <span class="free">s'</span> <span class="main">⟹</span> used <span class="free">s</span> <span class="main">⊆</span> used <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Range_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> state_subset<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_ii_init<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    PriKey <span class="free">A</span> <span class="main">∉</span> spied s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> spied_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> auth_prikey_used<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> Auth_PriKey <span class="free">n</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> used_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_i_used<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> owner_ii_used<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_ii_used<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> owner_iii_used<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_iii_used<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_i_unique <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_i_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> asset_i_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> owner_ii_unique <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> owner_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> owner_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_ii_unique <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> asset_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> auth_prikey_asset_i <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">m</span><span class="main">)</span> <span class="main">(</span>Auth_PriKey <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> auth_prikey_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> auth_pubkey_owner_ii <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> Auth_PubKey <span class="free">n</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> auth_prikey_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> auth_pubkey_asset_ii <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> Auth_PubKey <span class="free">n</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> auth_prikey_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_i_owner_ii <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_i_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> owner_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_i_asset_ii <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_i_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> asset_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_ii_owner_ii <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> owner_ii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_iii_owner_iii <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_iii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">m</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> owner_iii_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_iv_state <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> owner_v_state <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> Token <span class="free">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_v_state <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_Un_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> owner_seskey_nonce_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      fst <span class="free">SK</span> <span class="main">=</span> None<span class="main">;</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span>
  fst <span class="free">SK</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">split</span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> owner_seskey_nonce <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
  fst <span class="free">SK</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> owner_seskey_nonce_1<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> owner_seskey_other <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_seskey_nonce <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> asset_seskey_other <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">declare</span></span> Range_Un_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">proposition</span></span> used_prod <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> used <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_snd<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>parts <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> <span class="free">H'</span> <span class="main">⟹</span> parts <span class="free">H</span> <span class="main">⊆</span> parts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> <span class="free">H</span> <span class="main">⟹</span> parts_msg <span class="free">X</span> <span class="main">⊆</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">H</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_union_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="free">H</span> <span class="main">∪</span> parts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_union_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="free">H</span> <span class="main">∪</span> parts <span class="free">H'</span> <span class="main">⊆</span> parts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UnE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">=</span> parts <span class="free">H</span> <span class="main">∪</span> parts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_union_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_union_2<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_insert<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> parts_msg <span class="free">X</span> <span class="main">∪</span> parts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_def parts_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_num <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Num <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Num <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_pwd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Pwd <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Key <span class="free">K</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_mult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Hash <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_crypt_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_crypt_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_crypt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>parts_msg <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_crypt_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_crypt_2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_mpair_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">{</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_mpair_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> parts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">{</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> parts.induct<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_mpair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">=</span> insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>parts_msg <span class="free">X</span> <span class="main">∪</span> parts_msg <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_mpair_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_mpair_2<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_idinfo <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_msg_trace <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts_msg <span class="main">(</span>Log <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Log <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_idinfo <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>IDInfo <span class="free">n</span> <span class="main">`</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> IDInfo <span class="free">n</span> <span class="main">`</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_trace <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>Log <span class="main">`</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> Log <span class="main">`</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_dec<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>InvK <span class="free">K</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span>
    <span class="free">Y</span> <span class="main">∈</span> parts_msg <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_enc<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> Key <span class="free">K</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span>
    <span class="free">Y</span> <span class="main">∈</span> parts_msg <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_sep<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span>
    <span class="free">Z</span> <span class="main">∈</span> parts_msg <span class="free">X</span> <span class="main">∨</span> <span class="free">Z</span> <span class="main">∈</span> parts_msg <span class="free">Y</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">Z</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_con<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span>
    <span class="free">Z</span> <span class="main">∈</span> parts_msg <span class="free">X</span> <span class="main">∨</span> <span class="free">Z</span> <span class="main">∈</span> parts_msg <span class="free">Y</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">Z</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> parts_msg_mono <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_init_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>used s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">⊆</span> used s<span class="hidden">⇩</span><sub>0</sub> <span class="main">∪</span> range <span class="main">(</span>Hash <span class="main">∘</span> Agent<span class="main">)</span> <span class="main">∪</span>
    range <span class="main">(</span>Hash <span class="main">∘</span> Auth_PubKey<span class="main">)</span> <span class="main">∪</span>
    range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⦃</span>Hash <span class="main">(</span>Agent <span class="bound">n</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>Auth_PubKey <span class="bound">n</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts.induct<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">clarify</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parts_init_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"used s<span class="hidden">⇩</span><sub>0</sub> <span class="main">∪</span> range <span class="main">(</span>Hash <span class="main">∘</span> Agent<span class="main">)</span> <span class="main">∪</span> range <span class="main">(</span>Hash <span class="main">∘</span> Auth_PubKey<span class="main">)</span> <span class="main">∪</span>
    range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⦃</span>Hash <span class="main">(</span>Agent <span class="bound">n</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>Auth_PubKey <span class="bound">n</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">⊆</span> parts <span class="main">(</span>used s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_init<span class="main">:</span>
 <span class="quoted"><span class="quoted">"parts <span class="main">(</span>used s<span class="hidden">⇩</span><sub>0</sub><span class="main">)</span> <span class="main">=</span> used s<span class="hidden">⇩</span><sub>0</sub> <span class="main">∪</span> range <span class="main">(</span>Hash <span class="main">∘</span> Agent<span class="main">)</span> <span class="main">∪</span>
    range <span class="main">(</span>Hash <span class="main">∘</span> Auth_PubKey<span class="main">)</span> <span class="main">∪</span>
    range <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">⦃</span>Hash <span class="main">(</span>Agent <span class="bound">n</span><span class="main">)</span><span class="main">,</span> Hash <span class="main">(</span>Auth_PubKey <span class="bound">n</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_init_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> parts_init_2<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_prikey_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="free">K</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="free">K</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">n</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> Key <span class="free">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_prikey<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="free">K</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">n</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> Key <span class="free">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_prikey_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_pubkey_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="bound">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
  SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_pubkey<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="bound">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_pubkey_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_key_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="free">K</span> <span class="main">(</span>Key <span class="free">K'</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="free">K</span> <span class="main">(</span>Key <span class="free">K'</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">K'</span> <span class="main">∉</span> range PriK <span class="main">∪</span> range PubK<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">{</span>Key <span class="free">K'</span><span class="main">,</span> Key <span class="free">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert
 image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_key<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="free">K</span> <span class="main">(</span>Key <span class="free">K'</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span>
    <span class="free">K'</span> <span class="main">∉</span> range PriK <span class="main">∪</span> range PubK<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">{</span>Key <span class="free">K'</span><span class="main">,</span> Key <span class="free">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_key_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_sign_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free">n</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free">n</span> <span class="free">A</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span> <span class="main">∨</span> SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert
 image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_sign<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free">n</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span> SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_sign_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_pwd_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="free">K</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="free">K</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="free">K</span> <span class="main">=</span> SesK <span class="bound">SK</span> <span class="main">∧</span> <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> Key <span class="free">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert
 image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_pwd<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="free">K</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="free">K</span> <span class="main">=</span> SesK <span class="bound">SK</span> <span class="main">∧</span> <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> Key <span class="free">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_pwd_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_num_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span> SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_num<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span> SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_num_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_mult_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="free">B</span> <span class="bound">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">{</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_crypt_mult<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="free">B</span> <span class="bound">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_crypt_mult_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> converse_rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> state_subset <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> spied_subset <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_mult_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span> <span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">SK</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Auth_PriK <span class="bound">n</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span> <span class="main">∧</span>
      Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> PriKey <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_mult<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Auth_PriK <span class="bound">n</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> PriKey <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_mult_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_mpair_key_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span>
    <span class="free">X</span> <span class="main">=</span> Key <span class="free">K</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">=</span> Key <span class="free">K</span> <span class="main">∧</span> <span class="free">K</span> <span class="main">∉</span> range PubK<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_mpair_key<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span>
    <span class="free">X</span> <span class="main">=</span> Key <span class="free">K</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">=</span> Key <span class="free">K</span> <span class="main">∧</span> <span class="free">K</span> <span class="main">∉</span> range PubK<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_mpair_key_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_mpair_pwd_start<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span>
    <span class="free">X</span> <span class="main">=</span> Pwd <span class="free">n</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">=</span> Pwd <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">{</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_mpair_pwd<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span> <span class="free">X</span> <span class="main">=</span> Pwd <span class="free">n</span> <span class="main">∨</span> <span class="free">Y</span> <span class="main">=</span> Pwd <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">{</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> parts_mpair_pwd_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_pubkey_false_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted">False</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">n</span><span class="main">,</span> Token <span class="bound">n</span> <span class="main">(</span>Auth_PriK <span class="bound">n</span><span class="main">)</span> <span class="bound">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">C</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">n</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">B</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">n</span> <span class="bound">B</span> <span class="free">C</span> <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?S</span> <span class="free">s'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_pubkey_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B C D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">n</span> <span class="skolem">B</span> <span class="free">C</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?R</span> <span class="skolem">n</span> <span class="skolem">B</span> <span class="free">C</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="var">?U</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">D</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">B</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">n</span> <span class="bound">B</span> <span class="skolem">D</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="var">?S</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> parts_crypt_pubkey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> state_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> B<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> E<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"spied <span class="free">s</span> <span class="main">⊆</span> spied <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Image_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> F<span class="main"><span class="keyword3">,</span></span> <span class="operator">contradiction</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">n'</span> <span class="skolem">B'</span> <span class="skolem">D</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">D'</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A'</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">D</span><span class="main">,</span> <span class="bound">D'</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="skolem">n'</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B'</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="skolem">n'</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D'</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="var">?U</span> <span class="bound">D'</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="skolem">n'</span><span class="main">,</span> PubKey <span class="skolem">B'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">n'</span> <span class="skolem">B'</span> <span class="skolem">D</span> <span class="free">s</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">D'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">C</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?U</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> parts_pubkey_false<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span><span class="main">;</span> SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  False"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> parts_pubkey_false_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> rev_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> state_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> rev_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> spied_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">proposition</span></span> asset_ii_spied_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="bound">SK</span><span class="main">.</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="free">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="bound">SK</span><span class="main">.</span> <span class="var">?P</span> <span class="free">n</span> <span class="bound">C</span> <span class="bound">SK</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">⊗</span> <span class="bound">A</span> <span class="main">∈</span> spied <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> PriKey <span class="bound">A</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> B C D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> FalseE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>PriK <span class="free">B</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_used <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> mp<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>PriKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">m</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="free">B</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_prikey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_asset_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ E<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Key <span class="main">(</span>PriK <span class="free">B</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>PriKey <span class="free">B</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>PriKey <span class="free">B</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="free"><span class="free"><span class="free">B</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">B</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> PriKey <span class="free">B</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> PriKey <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="free"><span class="free"><span class="free">B</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">A</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">⊗</span> <span class="skolem">A</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span> <span class="main">∨</span> <span class="free">B</span> <span class="main">⊗</span> <span class="skolem">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊗</span> <span class="skolem">A</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊗</span> <span class="skolem">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">B</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="free">B</span><span class="main">,</span> PriKey <span class="skolem">A</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> Auth_PriK <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> Auth_PubKey <span class="skolem">m</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_pubkey_asset_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span> <span class="bound">SK</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">v</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>PriKey <span class="skolem">A</span><span class="main">,</span> PriKey <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> parts_mult_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∉</span> spied <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∈</span> spied <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> spied_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">SK</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    J<span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="skolem">SK</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Auth_PriK <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> rev_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> state_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ E<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="skolem">SK</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="skolem">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">m</span> <span class="bound">C</span> <span class="skolem">SK</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">,</span> SesKey <span class="skolem">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_mult_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G J<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">∉</span> spied <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m'</span> <span class="skolem">C</span> <span class="skolem">SK</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m'</span> <span class="skolem">C</span> <span class="skolem">SK</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> state_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> H<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="skolem">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">∧</span>
    snd <span class="main">(</span>snd <span class="skolem">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="skolem">m'</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="skolem">m'</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="skolem">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="skolem">m'</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m'</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ E<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> asset_ii_spied<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="bound">SK</span><span class="main">.</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="free">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">u</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∉</span> spied <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">⊨</span> <span class="bound">w</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">⊢</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span>
    PriKey <span class="free">B</span> <span class="main">∉</span> spied <span class="bound">w</span> <span class="main">∧</span> PriKey <span class="free">B</span> <span class="main">∈</span> spied <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∉</span> spied <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">B</span> <span class="main">∈</span> spied <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⊢</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> F<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> state_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> asset_ii_spied_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⊆</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> state_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">proposition</span></span> asset_iv_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> Token <span class="free">m</span> <span class="main">(</span>Auth_PriK <span class="free">m</span><span class="main">)</span> <span class="free">B</span> <span class="free">C'</span> <span class="free">SK'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">C'</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">SK'</span> <span class="main">=</span> <span class="free">SK</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cases_simp <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">m</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">n</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">C'</span> <span class="main">=</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">SK'</span> <span class="main">=</span> <span class="free">SK</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">¬</span> <span class="main">(</span><span class="var">?P</span> <span class="free">m</span> <span class="free">C'</span> <span class="free">SK'</span> <span class="bound">u</span> <span class="main">∧</span> <span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="free">m</span> <span class="free">C'</span> <span class="free">SK'</span> <span class="bound">v</span> <span class="main">∧</span> <span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rtrancl_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">C'</span> <span class="free">SK'</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="free">n</span> <span class="free">C'</span> <span class="free">SK'</span> <span class="skolem">u</span> <span class="main">∨</span> <span class="main">¬</span> <span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="free">n</span> <span class="free">C'</span> <span class="free">SK'</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> D F G H<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span> <span class="main">∧</span>
      Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="skolem">u</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> F G I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">C'</span> <span class="free">SK'</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> D F G H<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">C'</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span> <span class="main">∧</span>
      Crypt <span class="main">(</span>SesK <span class="free">SK'</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="skolem">u</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> F H I<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">C'</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK'</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">m</span> <span class="free">C'</span> <span class="free">SK'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n</span> <span class="free">C</span> <span class="free">SK</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> sigkey_secret<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> SigKey <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"SigKey <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SigKey <span class="main">∉</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> B C<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> SigKey<span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> SigKey <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>SigKey<span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>SigKey<span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>SigKey<span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>SigKey<span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"SigK"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> SigKey<span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> SigKey<span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> SigKey<span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"SigK"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> parts_sign_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> Sign <span class="free">n</span> <span class="free">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">;</span> Sign <span class="free">n</span> <span class="free">A</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">A</span> <span class="main">=</span> Auth_PriK <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> sigkey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> parts_sign<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> Sign <span class="free">n</span> <span class="free">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">A</span> <span class="main">=</span> Auth_PriK <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 Range_iff image_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_sign_start<span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> auth_shakey_secret<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_shakey<span class="main">⟧</span> <span class="main">⟹</span>
    Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> B C<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Key <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Auth_ShaKey <span class="free"><span class="free"><span class="free">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Auth_ShaKey <span class="free"><span class="free"><span class="free">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> auth_prikey_secret<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_prikey"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∉</span> spied s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span>
    Auth_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="bound">u</span> <span class="main">∧</span> Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">.</span> <span class="main">(</span>Auth_PriK <span class="free">n</span> <span class="main">⊗</span> <span class="bound">B</span> <span class="main">∈</span> spied <span class="skolem">u</span> <span class="main">∨</span> <span class="bound">B</span> <span class="main">⊗</span> Auth_PriK <span class="free">n</span> <span class="main">∈</span> spied <span class="skolem">u</span><span class="main">)</span> <span class="main">∧</span>
    PriKey <span class="bound">B</span> <span class="main">∈</span> spied <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> D E F<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> FalseE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>PriK <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> used <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_prikey_used <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>PriKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">m</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_prikey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>Auth_PriKey <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_prikey_asset_i <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Key <span class="main">(</span>PriK <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Auth_PriKey <span class="free">n</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Auth_PriKey <span class="free">n</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="main"><span class="main"><span class="main">(</span></span></span>Auth_PriK <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>PriK <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Auth_PriKey <span class="free">n</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> Auth_PriKey <span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="main"><span class="main"><span class="main">(</span></span></span>Auth_PriK <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span>
       <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">B</span> <span class="main">∈</span> spied <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"Auth_PriK <span class="free">n</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">∈</span> spied <span class="skolem">u</span> <span class="main">∨</span> <span class="skolem">B</span> <span class="main">⊗</span> Auth_PriK <span class="free">n</span> <span class="main">∈</span> spied <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Auth_PriK <span class="free">n</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">B</span> <span class="main">⊗</span> Auth_PriK <span class="free">n</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊗</span> Auth_PriK <span class="free">n</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊗</span> Auth_PriK <span class="free">n</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">B</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="skolem">B</span><span class="main">,</span> PriKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> Auth_PubKey <span class="free">n</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_pubkey_asset_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Auth_PriK <span class="free">n</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Auth_PriK <span class="free">n</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>PriKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">,</span> PriKey <span class="skolem">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Auth_PriK <span class="free">n</span> <span class="main">=</span> Auth_PriK <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="skolem">m</span> <span class="main">∈</span> spied <span class="skolem">u</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="bound">SK</span><span class="main">.</span> <span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> Token <span class="skolem">m</span> <span class="main">(</span>Auth_PriK <span class="skolem">m</span><span class="main">)</span> <span class="skolem">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> asset_ii_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C G<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> asset_ii_secret<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_prikey<span class="main">;</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    PriKey <span class="free">B</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_ii_spied<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> auth_prikey_secret<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> asset_i_secret <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
    PriKey <span class="free">S</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_induct <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">⟶</span>
      PriKey <span class="free">S</span> <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">S</span> <span class="main">∉</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> D E F<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">S</span> <span class="main">∈</span> used <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_used <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> mp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span> <span class="main">∉</span> used <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">m</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="free">S</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_prikey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>InvK <span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_shakey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C B<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="free">S</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">S</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="free">S</span><span class="main">,</span> PriKey <span class="skolem">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">m</span> <span class="main">∧</span> <span class="main">_</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Auth_PriKey <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_prikey_asset_i <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="skolem">A</span> <span class="main">⊗</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">S</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">S</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="skolem">A</span><span class="main">,</span> PriKey <span class="free">S</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>ShaK <span class="main">(</span>Auth_ShaK <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_asset_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C _ <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>PriKey <span class="free">S</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>PriKey <span class="free">S</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="free"><span class="free"><span class="free">S</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> PriKey <span class="free">S</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> PriKey <span class="free">S</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="free"><span class="free"><span class="free">S</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> owner_ii_secret <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span>
  PriKey <span class="free">A</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">⟶</span> PriKey <span class="free">A</span> <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">A</span> <span class="main">∉</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> B C D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Key <span class="main">(</span>PubK <span class="free">A</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_ii_used <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> mp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span> <span class="main">∉</span> used <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">K</span> <span class="main">=</span> Auth_ShaKey <span class="bound">m</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_prikey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Key <span class="main">(</span>PubK <span class="free">A</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="free">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> PriKey <span class="skolem">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">m</span> <span class="main">∧</span> <span class="main">_</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Key <span class="main">(</span>PubK <span class="free">A</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> Auth_PubKey <span class="skolem">m</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_pubkey_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="skolem">B</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊗</span> <span class="free">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="skolem">B</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="skolem">B</span><span class="main">,</span> PriKey <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> Key <span class="main">(</span>PubK <span class="free">A</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>PriKey <span class="free">A</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>PriKey <span class="free">A</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="free"><span class="free"><span class="free">A</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> PriKey <span class="free">A</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> PriKey <span class="free">A</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"PriK <span class="free"><span class="free"><span class="free">A</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>PriK <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> seskey_spied <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span> <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="skolem">s</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> B C D<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> FalseE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>SesKey <span class="free">SK</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>SesKey <span class="free">SK</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"SesK <span class="free"><span class="free"><span class="free">SK</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_key <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> K <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"SesK <span class="free"><span class="free"><span class="free">SK</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> owner_seskey_shakey<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    fst <span class="free">SK</span> <span class="main">=</span> None"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_nonce <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
    <span class="bound">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seskey_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="skolem">S</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Auth_ShaKey <span class="free">n</span> <span class="main">=</span> Auth_ShaKey <span class="bound">m</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="bound">m</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>PriKey <span class="skolem">S</span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?R</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_prikey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_shakey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∉</span> bad_shakey"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">S</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">m</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">S</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> owner_seskey_prikey<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_prikey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">A</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">A</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">A'</span> <span class="bound">C</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="bound">A'</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">A'</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">A'</span> <span class="bound">C</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?R</span> <span class="bound">A'</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seskey_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">A'</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">A'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">A</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_le_m1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">A'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?R</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_ii_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">A'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?R</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B D<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="free">B</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> asset_seskey_shakey<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">S</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">S</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_seskey_nonce <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">S</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_i_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seskey_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">S</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> owner_seskey_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> Token <span class="free">m</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?Q</span> <span class="free">m</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="var">?S</span> <span class="bound">C</span> <span class="bound">D</span> <span class="main">∧</span> <span class="var">?T</span> <span class="free">m</span> <span class="bound">A</span> <span class="main">∧</span> <span class="var">?U</span> <span class="free">m</span> <span class="bound">C</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="free">m</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?Q</span> <span class="free">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="var">?S</span> <span class="bound">C</span> <span class="bound">D</span> <span class="main">∧</span> <span class="var">?T</span> <span class="free">n</span> <span class="bound">A</span> <span class="main">∧</span> <span class="var">?U</span> <span class="free">n</span> <span class="bound">C</span> <span class="bound">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="free">n</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> D <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">B''</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">m</span> <span class="skolem">A''</span> <span class="skolem">B''</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Token <span class="free">m</span> <span class="skolem">A''</span> <span class="skolem">B''</span> <span class="skolem">C</span> <span class="free">SK</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A''</span> <span class="main">⊗</span> <span class="skolem">B''</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B''</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">C'</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">i</span><span class="main">,</span> Token <span class="bound">i</span> <span class="main">(</span>Auth_PriK <span class="bound">i</span><span class="main">)</span> <span class="skolem">B''</span> <span class="bound">C'</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span><span class="skolem">A''</span> <span class="main">⊗</span> <span class="skolem">B''</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">B''</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">C'</span><span class="main">.</span> <span class="var">?W</span> <span class="bound">i</span> <span class="skolem">B''</span> <span class="bound">C'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="var">?V</span> <span class="bound">D</span> <span class="main">∧</span> <span class="bound">D</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule_tac</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">C'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">B''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="skolem">i</span> <span class="skolem">B''</span> <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?R</span> <span class="bound">A</span> <span class="skolem">B''</span> <span class="main">∧</span> <span class="var">?S</span> <span class="skolem">C'</span> <span class="bound">D</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B''</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
      Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> PubKey <span class="skolem">B''</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?X</span> <span class="skolem">i</span> <span class="skolem">B''</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?W</span> <span class="skolem">i</span> <span class="skolem">B''</span> <span class="skolem">C'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">i</span> <span class="skolem">B''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B''</span> <span class="main">≠</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B''</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">i</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="skolem">i</span> <span class="skolem">B''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="free">m</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B''</span> <span class="main">≠</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B''</span> <span class="main">=</span> <span class="skolem">A'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">i</span> <span class="skolem">A'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="skolem">i</span> <span class="skolem">B''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="free">n</span> <span class="skolem">A'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?V</span> <span class="skolem">B''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">A''</span> <span class="main">⊗</span> <span class="skolem">B''</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">D</span> <span class="bound">E</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="var">?V</span> <span class="bound">D</span> <span class="main">∧</span> <span class="bound">E</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">D</span><span class="main">,</span> PriKey <span class="bound">E</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seskey_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">D</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">D</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≠</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?X</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_ii_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="free">m</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≠</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">A'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">A'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?X</span> <span class="skolem">A'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_ii_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="free">n</span> <span class="skolem">A'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">A'</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_le_m1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">D</span><span class="main">,</span> <span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_disjoint <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≠</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">A'</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="skolem">A'</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> contrapos_nn<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="free">n</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="free">n</span> <span class="skolem">A'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_ii_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="free">m</span> <span class="skolem">A</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> owner_seskey_secret<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> Token <span class="free">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="main">∧</span> <span class="var">?R</span> <span class="bound">B</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey <span class="main">∨</span> <span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_prikey"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> auth_prikey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sign <span class="free">n</span> <span class="skolem">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Auth_PriK <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_sign <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="skolem">B</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Auth_PriK <span class="free">n</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> Auth_PriK <span class="free">n</span> <span class="main">=</span> Auth_PriK <span class="bound">m</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>PriKey <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span><span class="main">,</span> PriKey <span class="skolem">B</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="var">?S</span> <span class="bound">m</span> <span class="main">∧</span> <span class="var">?T</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∉</span> bad_prikey"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_prikey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">B</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_shakey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?P</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> owner_num_genuine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_num <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">SK'</span><span class="main">.</span> SesK <span class="free">SK</span> <span class="main">=</span> SesK <span class="bound">SK'</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="skolem">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK'</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>Pwd <span class="skolem">m</span><span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">m</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> owner_token_genuine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="free">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"Token <span class="free">n</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> Auth_PriK <span class="free">n</span> <span class="main">∧</span> <span class="free">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="free">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">A</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="free">B</span> <span class="main">∧</span> <span class="var">?R</span> <span class="free">C</span> <span class="main">∧</span> <span class="var">?S</span> <span class="free">n</span> <span class="free">B</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free">n</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span> SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_sign <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="var">?S</span> <span class="free">n</span> <span class="bound">B</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?T</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="var">?U</span> <span class="bound">C</span> <span class="bound">D</span> <span class="main">∧</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?V</span> <span class="free">n</span> <span class="bound">D</span> <span class="main">∧</span> <span class="var">?W</span> <span class="free">n</span> <span class="bound">B</span> <span class="bound">C</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="skolem">C'</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">n</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="free">n</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="free">n</span> <span class="skolem">B'</span> <span class="skolem">C'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sign <span class="free">n</span> <span class="free">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_sign <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">B</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span> <span class="bound">C''</span><span class="main">.</span> <span class="var">?W</span> <span class="bound">m</span> <span class="free">B</span> <span class="bound">C''</span><span class="main">)</span> <span class="main">∨</span> <span class="main">{</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_mult <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="skolem">m</span> <span class="free">B</span> <span class="skolem">C''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?T</span> <span class="bound">A</span> <span class="free">B</span> <span class="main">∧</span> <span class="var">?U</span> <span class="skolem">C''</span> <span class="bound">D</span> <span class="main">∧</span> <span class="var">?S</span> <span class="skolem">m</span> <span class="free">B</span> <span class="main">∧</span> <span class="var">?V</span> <span class="skolem">m</span> <span class="bound">D</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="skolem">m</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A <span class="quoted"><span class="quoted">‹<span class="var">?W</span> <span class="skolem">m</span> <span class="free">B</span> <span class="skolem">C''</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">m</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> Token <span class="free">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="var">?T</span> <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="var">?U</span> <span class="bound">C</span> <span class="bound">D</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?X</span> <span class="bound">A</span> <span class="main">∧</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">A''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">A''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">A''</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?T</span> <span class="skolem">A'</span> <span class="skolem">B'</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="free">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">A''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A''</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">≤</span> card <span class="main">{</span><span class="skolem">A'</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> card_insert_le_m1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A''</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">∉</span> <span class="main">{</span><span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> notI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">=</span> <span class="skolem">B'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">n</span> <span class="skolem">A''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?S</span> <span class="free">n</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="skolem">A''</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">m</span> <span class="skolem">A''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?S</span> <span class="skolem">m</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="skolem">A''</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">A''</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="skolem">B'</span><span class="main">,</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">{</span><span class="free">B</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">n</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?S</span> <span class="free">n</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="free">C</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>Owner <span class="bound">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="bound">B</span><span class="main">.</span> <span class="var">?W</span> <span class="bound">n</span> <span class="bound">B</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_pubkey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">C'</span><span class="main">,</span> <span class="skolem">D</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?U</span> <span class="skolem">C'</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="free">n</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?V</span> <span class="free">n</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iii_owner_iii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">n</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?W</span> <span class="free">n</span> <span class="skolem">B'</span> <span class="skolem">C'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">n</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="free">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="free">C</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?S</span> <span class="free">n</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> pwd_secret<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_pwd <span class="main">∪</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pwd <span class="free">n</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_induct <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> B<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"Pwd <span class="free">n</span> <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pwd <span class="free">n</span> <span class="main">∉</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> D E<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="skolem">K</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="skolem">K</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="skolem">K</span> <span class="main">=</span> SesK <span class="bound">SK</span> <span class="main">∧</span> <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> Key <span class="skolem">K</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">SK</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">SK</span><span class="main">)</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">SK</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">SK</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">SK</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="skolem">SK</span> <span class="main">∉</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C _ <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">SK</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>InvK <span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">SK</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⦄</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">X</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_mpair_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> asset_seskey_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> Token <span class="free">m</span> <span class="main">(</span>Auth_PriK <span class="free">m</span><span class="main">)</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span> <span class="free">B</span> <span class="free">C</span> <span class="free">SK</span> <span class="free">s</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">B'</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> <span class="free">C'</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> cases_simp <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">B'</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">B</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">insert</span> B C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> asset_iv_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">≠</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="free">B'</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">C'</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B'</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> PubKey <span class="free">B'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">m</span> <span class="free">B'</span> <span class="free">C'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">A</span><span class="main">,</span> <span class="free">B'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">m</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B'</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">n</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free">B</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">i</span> <span class="bound">C</span><span class="main">.</span> <span class="main">(</span>Asset <span class="bound">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">A</span> <span class="bound">C</span> <span class="free">SK</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> parts_pubkey_false <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
      <span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
      <span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
      <span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">j</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ E<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span> <span class="bound">A</span> <span class="bound">C</span><span class="main">.</span> fst <span class="free">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span> <span class="bound">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">C</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">{</span>PriKey <span class="bound">S</span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="free">s</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seskey_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∈</span> spied <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?S</span> <span class="free">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?S</span> s<span class="hidden">⇩</span><sub>0</sub>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> bex_simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> bspec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> asset_ii_init <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">u</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">⊢</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">⊨</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="var">?S</span> <span class="bound">u</span> <span class="main">∧</span> <span class="var">?S</span> <span class="bound">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊢</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?S</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">A</span> <span class="main">∉</span> spied <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        K<span class="main">:</span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">A</span> <span class="main">∈</span> spied <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> rtrancl_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
       <span class="main">(</span><span class="operator">erule_tac</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⊢</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">A</span> <span class="main">∉</span> spied <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">⊨</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PriKey <span class="skolem">A</span> <span class="main">∈</span> spied <span class="skolem">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> K<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> spied_subset<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">contradiction</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="skolem">i</span> <span class="main">∈</span> spied <span class="skolem">u</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">C</span> <span class="bound">SK</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">i</span> <span class="skolem">A</span> <span class="bound">C</span> <span class="bound">SK</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_spied_start <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E F K J<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">SK'</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">i</span> <span class="skolem">A</span> <span class="skolem">C'</span> <span class="skolem">SK'</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">i</span> <span class="skolem">A</span> <span class="skolem">C'</span> <span class="skolem">SK'</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> rev_subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> state_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">j</span> <span class="skolem">A</span> <span class="skolem">C</span> <span class="free">SK</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="skolem">C'</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">∧</span> <span class="skolem">SK'</span> <span class="main">=</span> <span class="free">SK</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iv_unique <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="skolem">C</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> parts_pubkey_false <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> notI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
          <span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span> <span class="main">∧</span>
          <span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span> <span class="main">∧</span>
          <span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="skolem">j</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="skolem">i</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="skolem">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> N<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> state_subset <span class="main"><span class="main">[</span></span><span class="operator">OF</span> M<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_ii_owner_ii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∈</span> spied <span class="skolem">u</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">u</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> seskey_spied <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> asset_seskey_secret<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_pwd <span class="main">∪</span> bad_prikey<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey <span class="main">∨</span> <span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Pwd <span class="free">n</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> pwd_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">SK'</span><span class="main">.</span> SesK <span class="free">SK</span> <span class="main">=</span> SesK <span class="bound">SK'</span> <span class="main">∧</span>
      <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK'</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
      <span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> owner_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> asset_seskey_shakey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> asset_pwd_genuine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_pwd <span class="main">∪</span> bad_prikey<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> used <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">SK'</span><span class="main">.</span> SesK <span class="free">SK</span> <span class="main">=</span> SesK <span class="bound">SK'</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK'</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> Key <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> parts_crypt_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SesKey <span class="free">SK</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> asset_token_genuine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_pwd <span class="main">∪</span> bad_prikey<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="free">D</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_pwd_genuine <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span><span class="main">.</span> Token <span class="free">n</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="free">SK</span> <span class="main">∈</span> used <span class="free">s</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">∈</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_v_state <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="free">SK</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> snd <span class="main">(</span>snd <span class="free">SK</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="free">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">C</span> <span class="bound">D</span> <span class="main">∧</span> <span class="main">_</span> <span class="main">∧</span> <span class="var">?Q</span> <span class="bound">C</span> <span class="main">∧</span> <span class="var">?R</span> <span class="bound">D</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> owner_seskey_other <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">C</span> <span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">D'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≠</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> asset_iii_owner_iii <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">C</span> <span class="skolem">D'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span> <span class="skolem">D'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Anonymity">
<div class="head">
<h1>Theory Anonymity</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Relational Method with Message Anonymity for the Verification of Cryptographic Protocols
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Anonymity properties"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Anonymity
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Authentication.html">Authentication</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{Anonymity}
›</span></span>


<span class="keyword1"><span class="command">proposition</span></span> crypts_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> <span class="free">H'</span> <span class="main">⟹</span> crypts <span class="free">H</span> <span class="main">⊆</span> crypts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_union_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">⊆</span> crypts <span class="free">H</span> <span class="main">∪</span> crypts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_union_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="free">H</span> <span class="main">∪</span> crypts <span class="free">H'</span> <span class="main">⊆</span> crypts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> UnE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_union<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">=</span> crypts <span class="free">H</span> <span class="main">∪</span> crypts <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_union_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_union_2<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_insert<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">(</span>insert <span class="free">X</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> crypts_msg <span class="free">X</span> <span class="main">∪</span> crypts <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_def crypts_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_num <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span>Num <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Num <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span>Agent <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Agent <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_pwd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Pwd <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Key <span class="free">K</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_mult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_hash_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">{</span>Hash <span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> crypts_hash<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_hash_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">{</span><span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> crypts <span class="main">{</span>Hash <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subst</span> id_apply <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> foldr_Nil <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_hash<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>crypts_msg <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_hash_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_hash_2<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_comp<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> crypts <span class="free">H</span> <span class="main">⟹</span> Crypt <span class="free">K</span> <span class="free">X</span> <span class="main">∈</span> crypts <span class="main">(</span>Crypt <span class="free">K</span> <span class="main">`</span> <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply
 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span>"</span></span><span class="main"><span class="main">]</span></span> foldr_Cons <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> crypts_hash <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> crypts_fst <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> crypts_snd<span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_crypt_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> Crypt <span class="free">K</span> <span class="main">`</span> crypts <span class="main">{</span><span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> rev_mp<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_crypt_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span> <span class="main">`</span> crypts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">⊆</span> crypts <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> bexE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> crypts_comp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_crypt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Crypt <span class="free">K</span> <span class="main">`</span> crypts_msg <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_crypt_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_crypt_2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_mpair_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts <span class="main">{</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> crypts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> crypts_mpair_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">{</span><span class="free">X</span><span class="main">}</span> <span class="main">∪</span> crypts <span class="main">{</span><span class="free">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> crypts <span class="main">{</span><span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> crypts.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subst</span> id_apply <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> foldr_Nil <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> crypts_fst <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">rule</span> crypts_snd<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_used<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> crypts_msg_mpair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"crypts_msg <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">=</span> insert <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts_msg <span class="free">X</span> <span class="main">∪</span> crypts_msg <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_mpair_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_mpair_2<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> foldr_crypt_size<span class="main">:</span>
 <span class="quoted"><span class="quoted">"size <span class="main">(</span>foldr Crypt <span class="free">KS</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> size <span class="free">X</span> <span class="main">+</span> length <span class="free">KS</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">KS</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets <span class="free">X</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> <span class="free">H'</span> <span class="main">⟹</span> key_sets <span class="free">X</span> <span class="free">H</span> <span class="main">⊆</span> key_sets <span class="free">X</span> <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_union<span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets <span class="free">X</span> <span class="main">(</span><span class="free">H</span> <span class="main">∪</span> <span class="free">H'</span><span class="main">)</span> <span class="main">=</span> key_sets <span class="free">X</span> <span class="free">H</span> <span class="main">∪</span> key_sets <span class="free">X</span> <span class="free">H'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_insert<span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets <span class="free">X</span> <span class="main">(</span>insert <span class="free">Y</span> <span class="free">H</span><span class="main">)</span> <span class="main">=</span> key_sets_msg <span class="free">X</span> <span class="free">Y</span> <span class="main">∪</span> key_sets <span class="free">X</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> insert_def key_sets_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> key_sets_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_eq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> arg_cong <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">size</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldr_crypt_size<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_num <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span>Num <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> Num <span class="free">n</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_agent <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span>Agent <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> Agent <span class="free">n</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_pwd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> Pwd <span class="free">n</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_key <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span>Key <span class="free">K</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> Key <span class="free">K</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_mult <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_hash <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span>Hash <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> Hash <span class="free">Y</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> key_sets_crypt_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> Crypt <span class="free">K</span> <span class="free">Y</span> <span class="main">⟹</span>
    key_sets <span class="free">X</span> <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">Y</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">(</span>InvKey <span class="free">K</span><span class="main">)</span> <span class="main">`</span> key_sets <span class="free">X</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rev_mp<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> key_sets_crypt_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"insert <span class="main">(</span>InvKey <span class="free">K</span><span class="main">)</span> <span class="main">`</span> key_sets <span class="free">X</span> <span class="main">{</span><span class="free">Y</span><span class="main">}</span> <span class="main">⊆</span> key_sets <span class="free">X</span> <span class="main">{</span>Crypt <span class="free">K</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def image_iff<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> arg_cong <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Crypt <span class="free"><span class="free"><span class="free">K</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> comp_apply
 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Crypt <span class="free">K</span>"</span></span><span class="main"><span class="main">]</span></span> foldr_Cons <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> conj_commute<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_crypt <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">(</span>Crypt <span class="free">K</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> Crypt <span class="free">K</span> <span class="free">Y</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span>
    insert <span class="main">(</span>InvKey <span class="free">K</span><span class="main">)</span> <span class="main">`</span> key_sets_msg <span class="free">X</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> equalityI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> key_sets_crypt_1 <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> key_sets_crypt_2 <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_msg_mpair <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets_msg <span class="free">X</span> <span class="main">⦃</span><span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">⦄</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">X</span> <span class="main">=</span> <span class="main">⦃</span><span class="free">Y</span><span class="main">,</span> <span class="free">Z</span><span class="main">⦄</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_msg_def key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_range<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> key_sets <span class="free">X</span> <span class="free">H</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">⊆</span> range Key"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_crypts_hash<span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets <span class="main">(</span>Hash <span class="free">X</span><span class="main">)</span> <span class="main">(</span>crypts <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> key_sets <span class="free">X</span> <span class="main">(</span>crypts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_crypts_fst<span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> key_sets <span class="free">X</span> <span class="main">(</span>crypts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_crypts_snd<span class="main">:</span>
 <span class="quoted"><span class="quoted">"key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="free">H</span><span class="main">)</span> <span class="main">⊆</span> key_sets <span class="free">Y</span> <span class="main">(</span>crypts <span class="free">H</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_sets_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> log_spied_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span>
    Log <span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> Log <span class="free">X</span> <span class="main">∈</span> spied <span class="free">s</span><span class="main">;</span>
    Log <span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  Log <span class="free">X</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> log_spied <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    Log <span class="free">X</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span>
  Log <span class="free">X</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> log_spied_1<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> log_dec<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>InvK <span class="free">K</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  key_sets <span class="free">Y</span> <span class="main">(</span>crypts <span class="main">{</span><span class="bound">Y</span><span class="main">.</span> Log <span class="bound">Y</span> <span class="main">=</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> key_sets <span class="free">Y</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> key_sets_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_dec
 <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> log_spied <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> log_sep<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
    key_sets <span class="free">Z</span> <span class="main">(</span>crypts <span class="main">{</span><span class="bound">Z</span><span class="main">.</span> Log <span class="bound">Z</span> <span class="main">=</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> key_sets <span class="free">Z</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    key_sets <span class="free">Z</span> <span class="main">(</span>crypts <span class="main">{</span><span class="bound">Z</span><span class="main">.</span> Log <span class="bound">Z</span> <span class="main">=</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> key_sets <span class="free">Z</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> key_sets_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule</span> parts_sep <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Z <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> parts_sep <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Z <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_msg_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> log_spied <span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> idinfo_spied_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span><span class="main">;</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_spied <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> idinfo_spied_1<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> idinfo_dec<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="free">K</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>InvK <span class="free">K</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">Y</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">X</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">Y</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⟨</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">Y</span></span></span><span class="main"><span class="main"><span class="main">⟩</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> idinfo_spied<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_sep<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">s'</span> <span class="main">=</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">;</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">Z</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">X</span> <span class="main">∨</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">Z</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">Y</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">Z</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> parts_sep <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Z <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⟨</span></span></span><span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">Z</span></span></span><span class="main"><span class="main"><span class="main">⟩</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> idinfo_spied<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> idinfo_msg_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span> <span class="free">X</span> <span class="main">∈</span> spied <span class="free">s</span><span class="main">;</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s'</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">X</span> <span class="main">∈</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc
 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> idinfo_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> idinfo_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_msg <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span>
  <span class="free">X</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> idinfo_msg_1<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> parts_agent<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_agent<span class="main">⟧</span> <span class="main">⟹</span> Agent <span class="free">n</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> parts_init<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert image_iff<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> idinfo_init_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_id_password <span class="main">∪</span> bad_id_pubkey <span class="main">∪</span> bad_id_shakey<span class="main">;</span>
    <span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s</span><span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> idinfo_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> idinfo_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="main"><span class="keyword3">|</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> parts_agent <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_init<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_id_password <span class="main">∪</span> bad_id_pubkey <span class="main">∪</span> bad_id_shakey<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> idinfo_init_1<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> idinfo_mpair_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> rel_id_hash <span class="main">∪</span> rel_id_crypt <span class="main">∪</span> rel_id_sep <span class="main">∪</span> rel_id_con<span class="main">;</span>
    <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span>
      key_sets <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s'</span><span class="main">⟧</span> <span class="main">⟹</span>
  key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Image_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> subsetD
 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> key_sets_crypts_hash<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> key_sets_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">drule</span> spec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ex_in_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> subsetD
 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> key_sets_crypts_fst<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">OF</span> key_sets_crypts_snd<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> idinfo_mpair_2 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∉</span> rel_id_hash <span class="main">∪</span> rel_id_crypt <span class="main">∪</span> rel_id_sep <span class="main">∪</span> rel_id_con<span class="main">;</span>
    <span class="main">∀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span>
      key_sets <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s'</span><span class="main">⟧</span> <span class="main">⟹</span>
  key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_def Un_iff de_Morgan_disj<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq crypts_union key_sets_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> idinfo_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
 <span class="operator">drule</span> idinfo_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_mpair <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span>
  key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">X</span> <span class="skolem">Y</span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">s</span> <span class="main">⟶</span>
      key_sets <span class="main">⦃</span><span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"key_sets <span class="main">⦃</span><span class="skolem">X</span><span class="main">,</span> <span class="skolem">Y</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> rel_id_hash <span class="main">∪</span> rel_id_crypt <span class="main">∪</span> rel_id_sep <span class="main">∪</span> rel_id_con"</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> idinfo_mpair_2<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> idinfo_mpair_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">proposition</span></span> key_sets_pwd_empty<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    key_sets <span class="main">(</span>Hash <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
    key_sets <span class="main">⦃</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
    key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⦄</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> key_sets <span class="var">?X</span> <span class="main">(</span><span class="var">?H</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> key_sets <span class="var">?Y</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">∧</span> key_sets <span class="var">?Z</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Image_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"key_sets <span class="main">(</span>Hash <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?H</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
      key_sets <span class="main">⦃</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">(</span><span class="var">?H</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
      key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⦄</span> <span class="main">(</span><span class="var">?H</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"key_sets <span class="main">(</span>Hash <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?H</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
    key_sets <span class="main">⦃</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="free">X</span><span class="main">⦄</span> <span class="main">(</span><span class="var">?H</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span>
    key_sets <span class="main">⦃</span><span class="free">X</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⦄</span> <span class="main">(</span><span class="var">?H</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> B C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     image_iff Image_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq crypts_union
     key_sets_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_insert key_sets_insert<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">frule</span> log_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?X</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">frule</span> log_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?Y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> log_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?Z</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
     <span class="operator">frule</span> log_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Z <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?X</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> log_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Z <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?Y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">drule</span> log_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Z <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var"><span class="var">?Z</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> key_sets_pwd_seskey <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="free">U</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="skolem">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> B C D<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span>
     <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff Image_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq crypts_union
     key_sets_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_insert key_sets_insert <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">blast</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> log_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> log_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> subsetD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> pwd_anonymous_1 <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="free">n</span> <span class="main">∉</span> bad_id_password<span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> SesKey <span class="bound">SK</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">_</span><span class="main">;</span> <span class="main">_</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="free">s</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊢</span> <span class="skolem">s'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">s</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="skolem">s'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> B C D<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">drule</span> idinfo_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> idinfo_sep <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">|</span></span>
     <span class="operator">insert</span> key_sets_pwd_empty <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span>
     conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> key_sets_pwd_seskey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span>
     idinfo_mpair <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> key_sets_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> pwd_anonymous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_id_password"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_pwd <span class="main">∪</span> bad_prikey<span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>bad_id_pubkey <span class="main">∪</span> bad_id_shak<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_id_password <span class="main">∪</span> bad_id_pubkey <span class="main">∪</span> bad_id_shakey"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> idinfo_init <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> SesKey <span class="bound">SK</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">SK</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?Q</span> <span class="bound">SK</span> <span class="main">∨</span> <span class="var">?R</span> <span class="bound">SK</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pwd_anonymous_1 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">SK</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">SK</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">SK</span> <span class="main">∨</span> <span class="var">?R</span> <span class="skolem">SK</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">SK</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> contrapos_pp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">SK</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> owner_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">SK</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_pwd <span class="main">∪</span> bad_prikey<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> contrapos_pp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">SK</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> asset_seskey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">proposition</span></span> idinfo_pwd_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_agent"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s'</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">≠</span> Pwd <span class="free">n</span><span class="main">;</span>
    <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">≠</span> Pwd <span class="free">n</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> SesKey <span class="bound">SK</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
         <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> parts_agent <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> key_sets_pwd_empty
 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc
 <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> idinfo_dec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> idinfo_sep
 <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> spec<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> FalseE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> FalseE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">U</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span> <span class="bound">X</span> <span class="main">=</span> Pwd <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="skolem">K</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> Pwd <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> key_sets <span class="skolem">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> range Key"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> key_sets_range<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span> <span class="bound">X</span> <span class="main">=</span> Pwd <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="skolem">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Pwd <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> key_sets <span class="skolem">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="skolem">U</span> <span class="main">=</span> <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> key_sets_pwd_seskey <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">U</span> <span class="bound">V</span><span class="main">.</span> <span class="main">(</span>Spy<span class="main">,</span> Key <span class="main">(</span>SesK <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">U</span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">U</span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">U</span><span class="main">,</span> <span class="bound">V</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">U</span> <span class="skolem">K</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">⟶</span> <span class="bound">X</span> <span class="main">=</span> Pwd <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="skolem">K</span><span class="main">⟩</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> Pwd <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> key_sets <span class="skolem">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">⊆</span> range Key"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> key_sets_range<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> idinfo_pwd<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> <span class="bound">X</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">≠</span> Pwd <span class="free">n</span><span class="main">;</span>
    <span class="free">n</span> <span class="main">∉</span> bad_id_pubkey <span class="main">∪</span> bad_id_shakey<span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> SesKey <span class="bound">SK</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_start<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule</span> idinfo_pwd_start <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> r_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> rtrancl_trans<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> state_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> auth_prikey_anonymous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_id_prikey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> bad_prikey <span class="main">∩</span> <span class="main">(</span>bad_id_password <span class="main">∪</span> bad_id_shak<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Auth_PriKey <span class="free">n</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Auth_PriKey <span class="free">n</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_id_password <span class="main">∪</span> bad_id_pubkey <span class="main">∪</span> bad_id_shakey"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> idinfo_init <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Auth_PriKey <span class="free">n</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> idinfo_msg <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> auth_prikey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_id_pubkey"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_id_shakey"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> SesKey <span class="bound">SK</span> <span class="main">∈</span> spied <span class="free">s</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∨</span>
       <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">SK</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">SK</span> <span class="main">∧</span> <span class="main">(</span><span class="var">?Q</span> <span class="bound">SK</span> <span class="main">∨</span> <span class="var">?R</span> <span class="bound">SK</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> idinfo_pwd <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Auth_PriKey <span class="free"><span class="free"><span class="free">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">SK</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">SK</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">SK</span> <span class="main">∨</span> <span class="var">?R</span> <span class="skolem">SK</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">SK</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey <span class="main">∩</span> bad_prikey"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> contrapos_pp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">SK</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> owner_seskey_secret
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="skolem">SK</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_pwd <span class="main">∪</span> bad_prikey<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> contrapos_pp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">SK</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> asset_seskey_secret
         <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> auth_shakey_anonymous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_id_shakey"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> bad_shakey <span class="main">∩</span> <span class="main">(</span>bad_id_password <span class="main">∪</span> bad_id_pubkey<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∉</span> spied <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">⟩</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_id_password <span class="main">∪</span> bad_id_pubkey <span class="main">∪</span> bad_id_shakey"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> idinfo_init <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> spied <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> idinfo_msg <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_shakey"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> auth_shakey_secret <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Possibility">
<div class="head">
<h1>Theory Possibility</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       The Relational Method with Message Anonymity for the Verification of Cryptographic Protocols
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Possibility properties"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Possibility
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Anonymity.html">Anonymity</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{Possibility}
›</span></span>


<span class="keyword1"><span class="command">type_synonym</span></span> seskey_tuple <span class="main">=</span> <span class="quoted"><span class="quoted">"key_id <span class="main">×</span> key_id <span class="main">×</span> key_id <span class="main">×</span> key_id <span class="main">×</span> key_id"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> stage <span class="main">=</span> <span class="quoted"><span class="quoted">"state <span class="main">×</span> seskey_tuple"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pred_asset_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pred_asset_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
  <span class="main">∃</span><span class="bound">S</span><span class="main">.</span> PriKey <span class="bound">S</span> <span class="main">∉</span> used <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="bound">S</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span><span class="main">(</span>Spy<span class="main">,</span> Log <span class="main">(</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_asset_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_asset_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_asset_i <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pred_owner_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pred_owner_ii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">∃</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_owner_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_owner_ii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_owner_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_asset_i <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pred_asset_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pred_asset_ii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">∃</span><span class="bound">B</span><span class="main">.</span> PriKey <span class="bound">B</span> <span class="main">∉</span> used <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="bound">B</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_asset_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_asset_ii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_asset_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_owner_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pred_owner_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pred_owner_iii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> PriKey <span class="bound">C</span> <span class="main">∉</span> used <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="bound">C</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_owner_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_owner_iii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_owner_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_asset_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pred_asset_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pred_asset_iii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> PriKey <span class="bound">D</span> <span class="main">∉</span> used <span class="bound">s</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>insert <span class="main">(</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="bound">D</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_asset_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_asset_iii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_asset_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_owner_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">x</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">stage_owner_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stage_owner_iv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
  <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span>insert <span class="main">(</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∪</span>
    <span class="main">{</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_owner_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_owner_iv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> stage_owner_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_asset_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">stage_asset_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stage_asset_iv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
  <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Token <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">,</span>
      Token <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_asset_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_asset_iv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> stage_asset_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_owner_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">stage_owner_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stage_owner_v</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
  <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Token <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_owner_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_owner_v</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> stage_owner_v <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_asset_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">stage_asset_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stage_asset_v</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span>
  <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  <span class="main">(</span><span class="bound">s</span> <span class="main">∪</span> <span class="main">{</span>Asset <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
    <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> Log <span class="main">`</span> <span class="main">{</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
    <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_asset_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> state <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_asset_v</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> stage_asset_v <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>run_owner_v <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> prikey_unused_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used s<span class="hidden">⇩</span><sub>0</sub><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_super <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">-</span></span></span> range Auth_PriK"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 image_def bad_prik_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI2 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Auth_PriK_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> someI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">n</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prikey_unused_2<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> infinite <span class="main">{</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="free">s</span><span class="main">}</span><span class="main">⟧</span> <span class="main">⟹</span>
    infinite <span class="main">{</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="free">s'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="operator">subst</span> conj_commute <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> Int_commute<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_conj_eq Collect_neg_eq
 Diff_eq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Diff_infinite_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> msg.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> key.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> prikey_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="free">s</span><span class="main">}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> infinite_imp_nonempty<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prikey_unused_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prikey_unused_2<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> pubkey_unused_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">s</span> <span class="main">⊢</span> <span class="free">s'</span><span class="main">;</span> PubKey <span class="free">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span> <span class="main">⟶</span> PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s</span><span class="main">;</span>
    PubKey <span class="free">A</span> <span class="main">∈</span> parts <span class="main">(</span>used <span class="free">s'</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
  PriKey <span class="free">A</span> <span class="main">∈</span> used <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> disjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parts_insert
 image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> RangeI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">drule</span> parts_used<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> parts_snd<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> disj_assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">drule</span> parts_dec <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_enc <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_sep <span class="main"><span class="keyword3">|</span></span> <span class="operator">drule</span> parts_con<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pubkey_unused <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    PriKey <span class="free">A</span> <span class="main">∉</span> used <span class="free">s</span> <span class="main">⟶</span>
  PubKey <span class="free">A</span> <span class="main">∉</span> parts <span class="main">(</span>used <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> parts_init<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Range_iff image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> contrapos_nn <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ pubkey_unused_1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_asset_i_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> pred_asset_i <span class="free">n</span> <span class="free">s</span> <span class="main">(</span>run_asset_i <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> prikey_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> run_asset_i_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_i_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_asset_i <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_i_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> r_into_rtrancl<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_asset_i"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_i_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">case</span> run_asset_i <span class="free">n</span> <span class="free">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_i_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_i_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_asset_i <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_i_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_i_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="main">(</span>fst <span class="main">(</span>run_asset_i <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prikey_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rtrancl_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> run_asset_i_rel<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_owner_ii_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> pred_owner_ii <span class="free">n</span> <span class="main">(</span>run_asset_i <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>run_owner_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_i_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> run_owner_ii_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_ii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_owner_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_asset_i_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> run_asset_i_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> run_owner_ii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_asset_i <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_ii"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_ii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">case</span> run_owner_ii <span class="free">n</span> <span class="free">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">{</span><span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_asset_i_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_owner_ii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_ii_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_owner_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_asset_i_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_owner_ii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_ii_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">B</span><span class="main">.</span> PriKey <span class="bound">B</span> <span class="main">∉</span> used <span class="main">(</span>fst <span class="main">(</span>run_owner_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prikey_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rtrancl_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> run_owner_ii_rel<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_asset_ii_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> pred_asset_ii <span class="free">n</span> <span class="main">(</span>run_owner_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>run_asset_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_owner_ii_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> run_asset_ii_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_ii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_asset_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_owner_ii_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> run_owner_ii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> run_asset_ii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_owner_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_asset_ii"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_ii_msg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> run_asset_ii <span class="free">n</span> <span class="free">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
    insert <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">)</span>
      <span class="main">(</span><span class="main">{</span>Asset <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span>
       <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> run_owner_ii_msg <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> run_asset_ii_ex <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> run_owner_ii_rel <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> rtrancl_trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pubkey_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_ii_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_asset_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_owner_ii_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_asset_ii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_ii_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> PriKey <span class="bound">C</span> <span class="main">∉</span> used <span class="main">(</span>fst <span class="main">(</span>run_asset_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prikey_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rtrancl_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> run_asset_ii_rel<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_owner_iii_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> pred_owner_iii <span class="free">n</span> <span class="main">(</span>run_asset_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>run_owner_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_ii_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> run_owner_iii_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_owner_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_asset_ii_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> run_asset_ii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> run_owner_iii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_asset_ii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_iii"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">case</span> run_owner_iii <span class="free">n</span> <span class="free">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">{</span>Asset <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
      <span class="main">{</span>Owner <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_asset_ii_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_owner_iii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iii_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_owner_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_asset_ii_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_owner_iii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iii_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">D</span><span class="main">.</span> PriKey <span class="bound">D</span> <span class="main">∉</span> used <span class="main">(</span>fst <span class="main">(</span>run_owner_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> prikey_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> rtrancl_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> run_owner_iii_rel<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_asset_iii_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> pred_asset_iii <span class="free">n</span> <span class="main">(</span>run_owner_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>run_asset_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_owner_iii_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> run_asset_iii_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_iii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_asset_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_owner_iii_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> run_owner_iii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> run_asset_iii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_owner_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_asset_iii"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_iii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">case</span> run_asset_iii <span class="free">n</span> <span class="free">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">{</span>Asset <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">,</span>
        <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
      <span class="main">{</span>Owner <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_owner_iii_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_asset_iii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_iii_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_asset_iii <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> run_owner_iii_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_asset_iii_ex <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> run_owner_iv_rel_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> run_asset_iii <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">S</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">D</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_owner_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">_</span><span class="main">;</span> <span class="main">_</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_asset_iii_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_asset_iii_msg
 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_iv"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def run_owner_iv_def
 Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Auth_ShaKey <span class="free"><span class="free"><span class="free">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iv_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_owner_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> run_owner_iv_rel_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"run_asset_iii <span class="free">n</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iv_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> run_owner_iv <span class="free">n</span> <span class="free">s</span><span class="main">;</span>
      <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">{</span>Asset <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">⦄</span><span class="main">,</span>
        <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">D</span><span class="main">⦄</span><span class="main">}</span> <span class="main">∪</span>
      <span class="main">{</span>Owner <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="bound">A</span><span class="main">⦄</span><span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="bound">C</span><span class="main">⦄</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">,</span>
        Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">D</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">∧</span>
      <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> PubKey <span class="bound">B</span><span class="main">)</span> <span class="main">∉</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_iii_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_owner_iv_def split_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_iv_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_owner_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_iii_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_owner_iv_def split_def Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_asset_iv_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_asset_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_owner_iv_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_owner_iv_msg
 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_owner_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_asset_iv"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 rel_def run_asset_iv_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_iv_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> run_asset_iv <span class="free">n</span> <span class="free">s</span><span class="main">;</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      insert <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span>
        <span class="main">(</span><span class="main">{</span>Asset <span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">,</span> Token <span class="free">n</span> <span class="main">(</span>Auth_PriK <span class="free">n</span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">}</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_owner_iv_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_asset_iv_def split_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_iv_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_asset_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_owner_iv_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_asset_iv_def split_def Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_owner_v_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_owner_v <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_asset_iv_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_asset_iv_msg
 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_asset_iv <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_v"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 rel_def run_owner_v_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_v_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> run_owner_v <span class="free">n</span> <span class="free">s</span><span class="main">;</span>
      <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">{</span><span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_iv_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_owner_v_def split_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_owner_v_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_owner_v <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_asset_iv_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_owner_v_def split_def Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">proposition</span></span> run_asset_v_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">⊨</span> fst <span class="main">(</span>run_asset_v <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> run_owner_v_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_owner_v_msg
 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>run_owner_v <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_asset_v"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 rel_def run_asset_v_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_v_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> run_asset_v <span class="free">n</span> <span class="free">s</span><span class="main">;</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">{</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_owner_v_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_asset_v_def split_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> run_asset_v_nonce<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> PriKey <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>run_asset_v <span class="free">n</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> used <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> run_owner_v_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_asset_v_def split_def Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> runs_unbounded_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span><span class="main">;</span> run_asset_v <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">S</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">D</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">s'</span> <span class="bound">S</span> <span class="bound">SK</span><span class="main">.</span> <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">∧</span>
      <span class="main">{</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
       <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">∧</span>
      <span class="free">s</span> <span class="main">⊨</span> <span class="bound">s'</span> <span class="main">∧</span> fst <span class="bound">SK</span> <span class="main">=</span> Some <span class="bound">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span>Some <span class="free"><span class="free"><span class="free">S</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">A</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">B</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">{</span></span></span><span class="free"><span class="free"><span class="free">C</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">D</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> run_asset_v_nonce <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> asset_i_used <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> run_asset_v_rel <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> run_asset_v_msg <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> runs_unbounded<span class="main">:</span>
 <span class="quoted"><span class="quoted">"s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span> <span class="bound">S</span> <span class="bound">SK</span><span class="main">.</span> <span class="free">s</span> <span class="main">⊨</span> <span class="bound">s'</span> <span class="main">∧</span> fst <span class="bound">SK</span> <span class="main">=</span> Some <span class="bound">S</span> <span class="main">∧</span>
    <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span> <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="free">s</span> <span class="main">∧</span>
    <span class="main">{</span><span class="main">(</span>Owner <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     <span class="main">(</span>Asset <span class="free">n</span><span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Num <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> runs_unbounded_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"run_asset_v <span class="free">n</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_i</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_i</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Auth_PriKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> s<span class="hidden">⇩</span><sub>0</sub><span class="main">,</span>
    Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_owner_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_ii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_owner_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>pwd_spy_i <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_ii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_ii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_owner_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⦄</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_owner_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_iii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> pred_owner_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>pwd_spy_ii <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_iii</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_iii</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_owner_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⦄</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_owner_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_iv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> stage_owner_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>pwd_spy_iii <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_sep_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_sep_map</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_owner_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="bound">A</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_sep_agr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_sep_agr</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_spy_sep_map <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="bound">C</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_sesk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_sesk</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_sep_agr <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
    <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_mult</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_spy_sesk <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_enc_pubk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_enc_pubk</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_mult <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_enc_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_enc_mult</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_enc_pubk <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
    <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_enc_sign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_enc_sign</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_enc_mult <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
    <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_con</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_con</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_enc_sign <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
    <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊗</span> <span class="bound">B</span><span class="main">)</span><span class="main">,</span>
      Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_iv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_iv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_con <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Token <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">B</span> <span class="bound">C</span> <span class="bound">SK</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_owner_v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_v</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> stage_owner_v <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>pwd_spy_iv <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_dec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_dec</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_owner_v <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_id_prik</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_prik</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_spy_dec <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="bound">S</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_id_pubk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_pubk</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_spy_id_prik <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PubKey <span class="bound">S</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_id_sesk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_sesk</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_id_pubk <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
    <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pwd_spy_id_pwd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> stage"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_pwd</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="keyword1">case</span> pwd_spy_id_sesk <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">proposition</span></span> key_sets_crypts_subset<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">U</span> <span class="main">∈</span> key_sets <span class="free">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">H</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="free">H</span> <span class="main">⊆</span> <span class="free">H'</span><span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">U</span> <span class="main">∈</span> key_sets <span class="free">X</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="free">H'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span><span class="main">;</span> <span class="main">_</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetD <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?A</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> key_sets_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> crypts_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_i_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_i_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">(</span><span class="main">{</span>PriKey <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span>
  Auth_PriKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Sign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> Crypt <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>PriKey <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">,</span>
  <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Key <span class="main">(</span>Auth_ShaKey <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">⟩</span><span class="main">}</span> <span class="main">∪</span> range Num<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_i_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_i <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> r_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>s<span class="hidden">⇩</span><sub>0</sub><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_enc"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_i_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_i_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_i <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_i_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_i_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_i_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span><span class="main">.</span> PriKey <span class="bound">A</span> <span class="main">∉</span> used <span class="main">(</span>fst <span class="main">(</span>pwd_spy_i <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_i_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prikey_unused<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_owner_ii_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_ii_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  pwd_spy_i_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="main">1</span><span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⦄</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_ii_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    pred_owner_ii <span class="free">n</span> <span class="main">(</span>pwd_spy_i <span class="free">n</span><span class="main">)</span> <span class="main">(</span>pwd_owner_ii <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_i_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pwd_owner_ii_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_ii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_owner_ii <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_i_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> pwd_spy_i_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> pwd_owner_ii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_i <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_ii"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_ii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_owner_ii <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_owner_ii_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> pwd_spy_i_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_owner_ii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq crypts_union key_sets_union<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_insert key_sets_insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_ii_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_ii_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  pwd_owner_ii_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>PriKey <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span>
    <span class="main">⦃</span>Num <span class="numeral">2</span><span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⦄</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_ii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_ii <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_owner_ii_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_owner_ii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_owner_ii <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_con"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_ii_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_ii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_ii <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_ii_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_owner_ii_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_ii_def split_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_ii_unused<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> PriKey <span class="bound">C</span> <span class="main">∉</span> used <span class="main">(</span>fst <span class="main">(</span>pwd_spy_ii <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_ii_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prikey_unused<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_owner_iii_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_iii_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  pwd_spy_ii_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">⦃</span>Num <span class="numeral">3</span><span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">⦄</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_iii_ex<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    pred_owner_iii <span class="free">n</span> <span class="main">(</span>pwd_spy_ii <span class="free">n</span><span class="main">)</span> <span class="main">(</span>pwd_owner_iii <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_ii_unused<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> pwd_owner_iii_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> someI_ex<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_iii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_owner_iii <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_ii_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> pwd_spy_ii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> pwd_owner_iii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_ii <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_iii"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_iii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_owner_iii <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_owner_iii_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> pwd_spy_ii_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_owner_iii_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_iii_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_iii_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  pwd_owner_iii_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Spy<span class="main">}</span> <span class="main">×</span> <span class="main">{</span>PriKey <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">,</span>
    <span class="main">⦃</span>Num <span class="numeral">4</span><span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">⦄</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_iii_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_iii <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_owner_iii_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_owner_iii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_owner_iii <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_con"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_iii_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_iii_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_iii <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_iii_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_owner_iii_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_iii_def split_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_owner_iv_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_iv_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Owner <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>pwd_spy_iii_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pwd_owner_iv_rel_1<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey<span class="main">;</span> pwd_spy_iii <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">S</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">D</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
    s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_owner_iv <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">_</span><span class="main">;</span> <span class="main">_</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_iii_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_iii_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_iv"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def pwd_owner_iv_def
 Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Auth_ShaKey <span class="free"><span class="free"><span class="free">n</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_iv_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_owner_iv <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> pwd_owner_iv_rel_1<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"pwd_spy_iii <span class="free">n</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_iv_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_owner_iv <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_owner_iv_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_iii_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_owner_iv_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_sep_map_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_sep_map_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>pwd_owner_iv_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_sep_map_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_sep_map <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_owner_iv_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_owner_iv_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_owner_iv <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_sep"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_sep_map_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_sep_map_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_sep_map <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_sep_map_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_owner_iv_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_sep_map_def split_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_sep_agr_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_sep_agr_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main">(</span>pwd_spy_sep_map_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_sep_agr_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_sep_agr <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_sep_map_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_sep_map_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_sep_map <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_sep"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_sep_agr_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_sep_agr_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_sep_agr <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_sep_agr_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_sep_map_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_sep_agr_def split_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_sesk_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_sesk_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>pwd_spy_sep_agr_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_sesk_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_sesk <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_sep_agr_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_sep_agr_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_sep_agr <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_sesk"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_sesk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_sesk_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_sesk <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_sesk_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_sep_agr_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_sesk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_mult_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_mult_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">(</span>pwd_spy_sesk_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_mult_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_mult <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_sesk_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_sesk_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_sesk <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_mult"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_mult_def split_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_mult_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_mult <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_mult_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_sesk_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_mult_def split_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_enc_pubk_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_enc_pubk_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>PubKey <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>pwd_spy_mult_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_enc_pubk_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_enc_pubk <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_mult_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_mult_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_mult <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_enc"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_enc_pubk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_enc_pubk_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_enc_pubk <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_enc_pubk_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_mult_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_enc_pubk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_enc_mult_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_enc_mult_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>pwd_spy_enc_pubk_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_enc_mult_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_enc_mult <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_enc_pubk_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_enc_pubk_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_enc_pubk <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_enc"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_enc_mult_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_enc_mult_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_enc_mult <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_enc_mult_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_enc_pubk_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_enc_mult_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_enc_sign_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_enc_sign_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>pwd_spy_enc_mult_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_enc_sign_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_enc_sign <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_enc_mult_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_enc_mult_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_enc_mult <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_enc"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_enc_sign_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_enc_sign_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_enc_sign <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_enc_sign_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_enc_mult_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_enc_sign_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_con_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_con_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⦃</span>Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">,</span>
    Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Sign <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">⦄</span><span class="main">)</span>
    <span class="main">(</span>pwd_spy_enc_sign_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_con_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_con <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_enc_sign_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_enc_sign_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_enc_sign <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_con"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_con_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_con_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_con <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_con_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_enc_sign_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_con_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_iv_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_iv_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> Token <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Auth_PriK <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="bound">SK</span><span class="main">)</span>
    <span class="main">(</span>pwd_spy_con_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_iv_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_iv <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_con_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_con_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_con <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_con"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_iv_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_iv_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_iv <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_iv_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_con_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_iv_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_owner_v_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_owner_v_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> Crypt <span class="main">(</span>SesK <span class="bound">SK</span><span class="main">)</span> <span class="main">(</span>Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pwd_spy_iv_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_v_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_owner_v <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_iv_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_iv_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_iv <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_owner_v"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_owner_v_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_owner_v_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_owner_v <span class="free">n</span><span class="main">;</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      pwd_owner_v_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_iv_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_owner_v_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Image_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span>
 <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq crypts_union key_sets_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> crypts_insert
 key_sets_insert<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pwd_spy_dec_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_dec_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> insert <span class="main">(</span>Spy<span class="main">,</span> Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>pwd_owner_v_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_dec_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_dec <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_owner_v_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_owner_v_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_owner_v <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_dec"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_dec_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_dec_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_dec <span class="free">n</span><span class="main">;</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      pwd_spy_dec_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>Key <span class="main">(</span>Auth_ShaKey <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>PriKey <span class="bound">S</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_owner_v_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_dec_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_id_prik_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_prik_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PriKey <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>pwd_spy_dec_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_prik_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_id_prik <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_dec_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_dec_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_dec <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_id_crypt"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_id_prik_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_prik_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_id_prik <span class="free">n</span><span class="main">;</span>
      <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      pwd_spy_id_prik_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_dec_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_id_prik_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_id_pubk_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_pubk_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> PubKey <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>pwd_spy_id_prik_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_pubk_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_id_pubk <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_id_prik_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_id_prik_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_id_prik <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_id_invk"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_id_pubk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_pubk_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_id_pubk <span class="free">n</span><span class="main">;</span>
      <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      pwd_spy_id_pubk_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_id_prik_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_id_pubk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pwd_spy_id_sesk_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_sesk_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
  insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> SesKey <span class="bound">SK</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>pwd_spy_id_pubk_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_sesk_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_id_sesk <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_id_pubk_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_id_pubk_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_id_pubk <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_id_sesk"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_id_sesk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI
 <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Some <span class="main"><span class="main"><span class="main">(</span></span></span>fst <span class="main"><span class="main"><span class="main">(</span></span></span>snd <span class="main"><span class="main"><span class="main">(</span></span></span>pwd_spy_id_pubk <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_sesk_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">=</span> pwd_spy_id_sesk <span class="free">n</span><span class="main">;</span>
      <span class="bound">SK</span> <span class="main">=</span> <span class="main">(</span>Some <span class="bound">S</span><span class="main">,</span> <span class="main">{</span><span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">in</span>
      pwd_spy_id_sesk_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="main">{</span>SesKey <span class="bound">SK</span><span class="main">}</span> <span class="main">∈</span> key_sets <span class="main">(</span>Pwd <span class="free">n</span><span class="main">)</span> <span class="main">(</span>crypts <span class="main">(</span>Log <span class="main">-`</span> spied <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_id_pubk_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_id_sesk_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> conjI <span class="main"><span class="keyword3">|</span></span> <span class="operator">erule</span> key_sets_crypts_subset<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pwd_spy_id_pwd_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agent_id <span class="main">⇒</span> seskey_tuple <span class="main">⇒</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pwd_spy_id_pwd_state</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> insert <span class="main">(</span>Spy<span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Pwd <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>pwd_spy_id_sesk_state <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_pwd_rel<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> fst <span class="main">(</span>pwd_spy_id_pwd <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⊨</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rtrancl_into_rtrancl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_id_sesk_rel<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> pwd_spy_id_sesk_msg<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>pwd_spy_id_sesk <span class="free">n</span><span class="main">)</span><span class="main">,</span> <span class="var">?t</span><span class="main">)</span> <span class="main">∈</span> rel_id_crypt"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_def
 pwd_spy_id_pwd_def split_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> pwd_spy_id_pwd_msg<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span>
    <span class="keyword1">case</span> pwd_spy_id_pwd <span class="free">n</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⇒</span>
      pwd_spy_id_pwd_state <span class="free">n</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">A</span><span class="main">,</span> <span class="bound">B</span><span class="main">,</span> <span class="bound">C</span><span class="main">,</span> <span class="bound">D</span><span class="main">)</span> <span class="main">⊆</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> pwd_spy_id_sesk_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pwd_spy_id_pwd_def split_def Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> pwd_compromised<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> bad_prikey <span class="main">∩</span> bad_id_shakey <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> s<span class="hidden">⇩</span><sub>0</sub> <span class="main">⊨</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">{</span>Pwd <span class="free">n</span><span class="main">,</span> <span class="main">⟨</span><span class="free">n</span><span class="main">,</span> Pwd <span class="free">n</span><span class="main">⟩</span><span class="main">}</span> <span class="main">⊆</span> spied <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">(</span></span></span>pwd_spy_id_pwd <span class="free"><span class="free"><span class="free">n</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> pwd_spy_id_pwd_rel<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> pwd_spy_id_pwd_msg<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>


<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>