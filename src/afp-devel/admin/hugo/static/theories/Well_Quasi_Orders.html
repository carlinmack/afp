<div id="Infinite_Sequences">
<div class="head">
<h1>Theory Infinite_Sequences</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infinite Sequences›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some useful constructions on and facts about infinite sequences.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Infinite_Sequences
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The set of all infinite sequences over elements from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">SEQ</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">::</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-SEQ_iff"><span class="command">lemma</span></span> SEQ_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SEQ_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>-th "column" of a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B›</span></span></span></span> of infinite sequences.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ith</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">|</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-ithI"><span class="command">lemma</span></span> ithI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> ith <span class="free">B</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_def<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-ithE"><span class="command">lemma</span></span> ithE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> ith <span class="free">B</span> <span class="free">i</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">B</span><span class="main">;</span> <span class="bound">f</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_def<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-ith_conv"><span class="command">lemma</span></span> ith_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ith <span class="free">B</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The restriction of a set <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>B›</span></span></span></span> of sequences to sequences that are equal to a given sequence
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span> up to position <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>i›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eq_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_upto</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">g</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">g</span> <span class="bound">j</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-eq_uptoI"><span class="command">lemma</span></span> eq_uptoI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span> <span class="main">∈</span> <span class="free">B</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">∈</span> eq_upto <span class="free">B</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-eq_uptoE"><span class="command">lemma</span></span> eq_uptoE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span> <span class="main">∈</span> eq_upto <span class="free">B</span> <span class="free">f</span> <span class="free">i</span><span class="main">;</span> <span class="main">⟦</span><span class="free">g</span> <span class="main">∈</span> <span class="free">B</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-eq_upto_Suc"><span class="command">lemma</span></span> eq_upto_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">g</span> <span class="main">∈</span> eq_upto <span class="free">B</span> <span class="free">f</span> <span class="free">i</span><span class="main">;</span> <span class="free">g</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">∈</span> eq_upto <span class="free">B</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def less_Suc_eq<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-eq_upto_0"><span class="command">lemma</span></span> eq_upto_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_upto <span class="free">B</span> <span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-eq_upto_cong"><span class="command">lemma</span></span> eq_upto_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_upto <span class="free">B</span> <span class="free">f</span> <span class="free">i</span> <span class="main">=</span> eq_upto <span class="free">C</span> <span class="free">g</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic Order on Infinite Sequences›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">LEX</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">j</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">LEXEQ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span>LEX <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>

<span class="keyword1" id="Infinite_Sequences-LEX_imp_not_LEX"><span class="command">lemma</span></span> LEX_imp_not_LEX<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="free">f</span> <span class="free">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> LEX <span class="free">P</span> <span class="free">g</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="free">g</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_imp_less_or_eq<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> LEX <span class="free">P</span> <span class="free">g</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹LEX <span class="free">P</span> <span class="free">f</span> <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LEX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Infinite_Sequences-LEX_cases"><span class="command">lemma</span></span> LEX_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="main">|</span> <span class="main">(</span>neq<span class="main">)</span> <span class="free">k</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>

<span class="keyword1" id="Infinite_Sequences-LEX_imp_less"><span class="command">lemma</span></span> LEX_imp_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∨</span> <span class="free">g</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="main">≠</span> <span class="free">g</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> LEX_cases<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> linorder_neqE_nat<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Minimal_Elements">
<div class="head">
<h1>Theory Minimal_Elements</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Minimal elements of sets w.r.t. a well-founded and transitive relation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Minimal_Elements
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Infinite_Sequences.html">Infinite_Sequences</a>
  <a href="../Open_Induction/Restricted_Predicates.html">Open_Induction.Restricted_Predicates</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> minimal_element <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">A</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> po<span class="main">:</span> <span class="quoted"><span class="quoted">"po_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_elt</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Minimal_Elements-minimal"><span class="command">lemma</span></span> minimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="bound">y</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">z</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> wf <span class="keyword2"><span class="keyword">and</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wfp_on_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> less <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> less <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> po <span class="main">[</span><span class="operator">THEN</span> po_on_imp_transp_on<span class="main">,</span> <span class="operator">unfolded</span> transp_on_def<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Minimal_Elements-min_elt_ex"><span class="command">lemma</span></span> min_elt_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">using</span></span> minimal <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Minimal_Elements-min_elt_mem"><span class="command">lemma</span></span> min_elt_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_elt <span class="free">B</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> someI_ex <span class="main">[</span><span class="operator">OF</span> min_elt_ex <span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_elt_def<span class="main">)</span>

<span class="keyword1" id="Minimal_Elements-min_elt_minimal"><span class="command">lemma</span></span> min_elt_minimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">y</span> <span class="main">(</span>min_elt <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> someI_ex <span class="main">[</span><span class="operator">OF</span> min_elt_ex <span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_elt_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A lexicographically minimal sequence w.r.t.\ a given set of sequences <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>C›</span></span></span></span>›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lexmin</span>
<span class="keyword2"><span class="keyword">where</span></span>
  lexmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lexmin</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> min_elt <span class="main">(</span>ith <span class="main">(</span>eq_upto <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free">lexmin</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">declare</span></span> lexmin <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Minimal_Elements-eq_upto_lexmin_non_empty"><span class="command">lemma</span></span> eq_upto_lexmin_non_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">⊆</span> eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">i</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> min_elt_mem <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> lexmin<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_upto_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Minimal_Elements-lexmin_SEQ_mem"><span class="command">lemma</span></span> lexmin_SEQ_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lexmin <span class="free">C</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq_upto_lexmin_non_empty <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmin <span class="free">C</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> min_elt_mem <span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lexmin<span class="main">)</span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Minimal_Elements-non_empty_ith"><span class="command">lemma</span></span> non_empty_ith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> eq_upto_lexmin_non_empty <span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_def<span class="main">)</span>

<span class="keyword1" id="Minimal_Elements-lexmin_minimal"><span class="command">lemma</span></span> lexmin_minimal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span> <span class="main">(</span>lexmin <span class="free">C</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> min_elt_minimal <span class="main">[</span><span class="operator">OF</span> non_empty_ith<span class="main">,</span> <span class="operator">folded</span> lexmin<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Minimal_Elements-lexmin_mem"><span class="command">lemma</span></span> lexmin_mem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> lexmin <span class="free">C</span> <span class="free">i</span> <span class="main">∈</span> ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> min_elt_mem <span class="main">[</span><span class="operator">OF</span> non_empty_ith<span class="main">,</span> <span class="operator">folded</span> lexmin<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Minimal_Elements-LEX_chain_on_eq_upto_imp_ith_chain_on"><span class="command">lemma</span></span> LEX_chain_on_eq_upto_imp_ith_chain_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain_on <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="main">(</span>eq_upto <span class="free">C</span> <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain_on <span class="free">P</span> <span class="main">(</span>ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> eq_upto <span class="free">C</span> <span class="free">f</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> eq_upto <span class="free">C</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">g</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">h</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">∧</span> <span class="skolem">h</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_def eq_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">g</span> <span class="skolem">h</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">h</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">g</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> SEQ_iff chain_on_imp_subset linorder_neqE_nat minimal subsetCE<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">h</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> *
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> SEQ_iff chain_on_imp_subset linorder_neqE_nat minimal subsetCE<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_on_def<span class="main">)</span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Least_Enum">
<div class="head">
<h1>Theory Least_Enum</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Enumerations of Well-Ordered Sets in Increasing Order›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Least_Enum
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> infinitely_many1 <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> infm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Enumerate the elements of a well-ordered infinite set in increasing order.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enum</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enum</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&gt;</span> <span class="free">enum</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Enum-enum_mono"><span class="command">lemma</span></span> enum_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"enum <span class="free">i</span> <span class="main">&lt;</span> enum <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> infm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> LeastI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Least_Enum-enum_less"><span class="command">lemma</span></span> enum_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> enum <span class="free">i</span> <span class="main">&lt;</span> enum <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> enum_mono <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lift_Suc_mono_less<span class="main">)</span>

<span class="keyword1" id="Least_Enum-enum_P"><span class="command">lemma</span></span> enum_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>enum <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> infm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> LeastI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> infinitely_many2 <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> wellorder <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">N</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> infm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">≥</span><span class="free">N</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Enumerate the elements of a well-ordered infinite set that form a chain w.r.t.\ a given predicate
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> starting from a given index <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">N</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in increasing order.
›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">enumchain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumchain</span> <span class="main">0</span> <span class="main">=</span> <span class="free">N</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">enumchain</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="free">enumchain</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">enumchain</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Least_Enum-enumchain_mono"><span class="command">lemma</span></span> enumchain_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≤</span> enumchain <span class="free">i</span> <span class="main">∧</span> enumchain <span class="free">i</span> <span class="main">&lt;</span> enumchain <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enumchain <span class="main">0</span> <span class="main">≥</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span>enumchain <span class="main">0</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>enumchain <span class="main">0</span><span class="main">)</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> LeastI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≤</span> enumchain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span>enumchain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>enumchain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> LeastI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Least_Enum-enumchain_chain"><span class="command">lemma</span></span> enumchain_chain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>enumchain <span class="free">i</span><span class="main">)</span> <span class="main">(</span>enumchain <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span>enumchain <span class="main">0</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>enumchain <span class="main">0</span><span class="main">)</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> LeastI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enumchain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enumchain_mono <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span>enumchain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>enumchain <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> LeastI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Almost_Full">
<div class="head">
<h1>Theory Almost_Full</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Almost-Full Property›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Almost_Full
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Sublist.html">HOL-Library.Sublist</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Ramsey.html">HOL-Library.Ramsey</a>"</span>
  <span class="quoted">"<a href="../Regular-Sets/Regexp_Method.html">Regular-Sets.Regexp_Method</a>"</span>
  <span class="quoted">"<a href="../Abstract-Rewriting/Seq.html">Abstract-Rewriting.Seq</a>"</span>
  <a href="Least_Enum.html">Least_Enum</a>
  <a href="Infinite_Sequences.html">Infinite_Sequences</a>
  <a href="../Open_Induction/Restricted_Predicates.html">Open_Induction.Restricted_Predicates</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*TODO: move*)</span>
<span class="keyword1" id="Almost_Full-le_Suc_eq'"><span class="command">lemma</span></span> le_Suc_eq'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> Suc <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> Suc <span class="bound">x'</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Almost_Full-ex_leq_Suc"><span class="command">lemma</span></span> ex_leq_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span>Suc <span class="free">j</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="free">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq'<span class="main">)</span>

<span class="keyword1" id="Almost_Full-ex_less_Suc"><span class="command">lemma</span></span> ex_less_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="free">j</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_0_disj<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions and Facts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An infinite sequence is \emph{good} whenever there are indices <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">i</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="free"><span class="free">i</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span> <span class="free"><span class="free">j</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">good</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">good</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A sequence that is not good is called \emph{bad}.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bad</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">¬</span> good <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1" id="Almost_Full-goodI"><span class="command">lemma</span></span> goodI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">j</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> good <span class="free">P</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full-goodE"><span class="command">lemma</span></span> goodE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="free">f</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full-badE"><span class="command">lemma</span></span> badE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bad <span class="free">P</span> <span class="free">f</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">almost_full_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">almost_full_on</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> SEQ <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> good <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Almost_Full-almost_full_onI"><span class="command">lemma</span></span> almost_full_onI <span class="main">[</span><span class="operator">Pure.intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> good <span class="free">P</span> <span class="bound">f</span><span class="main">)</span> <span class="main">⟹</span> almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> almost_full_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Almost_Full-almost_full_onD"><span class="command">lemma</span></span> almost_full_onD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="free">j</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> almost_full_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An equivalent inductive definition›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">af</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    now<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">af</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
  <span class="main">|</span> later<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">af</span> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">af</span> <span class="free">A</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="Almost_Full-af_imp_almost_full_on"><span class="command">lemma</span></span> af_imp_almost_full_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">thesis</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>later <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> later <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> later <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> later<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-af_mono"><span class="command">lemma</span></span> af_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="free">P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>now <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="skolem">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> af.now<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>later <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> af.later <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">Q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="skolem">Q</span> <span class="skolem">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> later<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> later<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-accessible_on_imp_af"><span class="command">lemma</span></span> accessible_on_imp_af<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"accessible_on <span class="free">P</span> <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">v</span> <span class="bound">u</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> <span class="free">P</span> <span class="bound">v</span> <span class="bound">u</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="main">¬</span> <span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> af.now af_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> af.later<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-wfp_on_imp_af"><span class="command">lemma</span></span> wfp_on_imp_af<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wfp_on_accessible_on_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> accessible_on_imp_af af.later<span class="main">)</span>

<span class="keyword1" id="Almost_Full-af_leq"><span class="command">lemma</span></span> af_leq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"af UNIV <span class="main">(</span><span class="main">(≤)</span> <span class="main">::</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_less <span class="main">[</span><span class="operator">folded</span> wfP_def wfp_on_UNIV<span class="main">,</span> <span class="operator">THEN</span> wfp_on_imp_af<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">NOTAF</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="main">¬</span> af <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Almost_Full-not_af"><span class="command">lemma</span></span> not_af<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> af <span class="free">A</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">¬</span> af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af.simps <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">F</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span> <span class="main">=</span> NOTAF <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> NOTAF <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">in</span> <span class="free">F</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Almost_Full-almost_full_on_imp_af"><span class="command">lemma</span></span> almost_full_on_imp_af<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> af<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"af <span class="free">A</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> af <span class="free">A</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"F <span class="free">A</span> <span class="free">P</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span>
    <span class="main">¬</span> af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>F <span class="free">A</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>F <span class="free">A</span> <span class="free">P</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>F <span class="free">A</span> <span class="free">P</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> af <span class="free">A</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> af.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NOTAF <span class="free">A</span> <span class="skolem">P</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="skolem">P</span> <span class="main">(</span>NOTAF <span class="free">A</span> <span class="skolem">P</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> NOTAF_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> af <span class="free">A</span> <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> af.intros<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"NOTAF <span class="free">A</span> <span class="skolem">P</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> af <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="skolem">P</span> <span class="main">(</span>NOTAF <span class="free">A</span> <span class="skolem">P</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> NOTAF_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> this <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ex_leq_Suc ex_less_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> back_subst <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> af <span class="free">A</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"F <span class="free">A</span> <span class="free">P</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> af <span class="main">[</span><span class="operator">unfolded</span> almost_full_on_def<span class="main">,</span> <span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> not_af <span class="main">[</span><span class="operator">OF</span> * <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> good_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> NOTAF F

<span class="keyword1" id="Almost_Full-almost_full_on_UNIV"><span class="command">lemma</span></span> almost_full_on_UNIV<span class="main">:</span>
  <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def good_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full-almost_full_on_imp_reflp_on"><span class="command">lemma</span></span> almost_full_on_imp_reflp_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reflp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def reflp_on_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full-almost_full_on_subset"><span class="command">lemma</span></span> almost_full_on_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> almost_full_on <span class="free">P</span> <span class="free">B</span> <span class="main">⟹</span> almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full-almost_full_on_mono"><span class="command">lemma</span></span> almost_full_on_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> almost_full_on_def almost_full_on_subset good_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Every sequence over elements of an almost-full set has a homogeneous subsequence.
›</span></span>
<span class="keyword1" id="Almost_Full-almost_full_on_imp_homogeneous_subseq"><span class="command">lemma</span></span> almost_full_on_imp_homogeneous_subseq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ</span><span class="main">::</span>nat <span class="main">⇒</span> nat<span class="main">.</span> <span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">φ</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">}</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">-</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">Z</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">Z</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="skolem">h</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="skolem">h</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟷</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def Y_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="skolem">h</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ramsey2 <span class="main">[</span><span class="operator">OF</span> infinite_UNIV_nat this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"infinite <span class="skolem">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="skolem">h</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> infinitely_many1 <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_nat_iff_unbounded<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&lt;</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> enum_P <span class="keyword2"><span class="keyword">and</span></span> enum_less <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>enum <span class="skolem">i</span><span class="main">,</span> enum <span class="skolem">j</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> enum_less <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> X_def doubleton_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> enum_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> enum_P <span class="keyword2"><span class="keyword">and</span></span> enum_less <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>enum <span class="skolem">i</span><span class="main">,</span> enum <span class="skolem">j</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> enum_less <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>enum <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Y_def X_def doubleton_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> good <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> enum<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹almost_full_on <span class="free">P</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Almost full relations do not admit infinite antichains.
›</span></span>
<span class="keyword1" id="Almost_Full-almost_full_on_imp_no_antichain_on"><span class="command">lemma</span></span> almost_full_on_imp_no_antichain_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> antichain_on <span class="free">P</span> <span class="free">f</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"antichain_on <span class="free">P</span> <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> good_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"incomparable <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If the image of a function is almost-full then also its preimage is almost-full.
›</span></span>
<span class="keyword1" id="Almost_Full-almost_full_on_map"><span class="command">lemma</span></span> almost_full_on_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="free">A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">h</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹almost_full_on <span class="free">Q</span> <span class="free">B</span>›</span></span> <span class="main">[</span><span class="operator">unfolded</span> almost_full_on_def<span class="main">,</span> <span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∘</span> <span class="skolem">f</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> good_def comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The homomorphic image of an almost-full set is almost-full.
›</span></span>
<span class="keyword1" id="Almost_Full-almost_full_on_hom"><span class="command">lemma</span></span> almost_full_on_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> af<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">h</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">h</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> choice <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">h</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">Q</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="free">Q</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> bad <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> hom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="free">P</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> af <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The monomorphic preimage of an almost-full set is almost-full.
›</span></span>
<span class="keyword1" id="Almost_Full-almost_full_on_mon"><span class="command">lemma</span></span> almost_full_on_mon<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">h</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> af<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mon <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="free">P</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> bad <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> mon <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def inj_on_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> af <span class="keyword2"><span class="keyword">and</span></span> ** <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Every total and well-founded relation is almost-full.
›</span></span>
<span class="keyword1" id="Almost_Full-total_on_and_wfp_on_imp_almost_full_on"><span class="command">lemma</span></span> total_on_and_wfp_on_imp_almost_full_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> almost_full_on <span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> almost_full_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> badE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹total_on <span class="free">P</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> total_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wfp_on <span class="free">P</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">unfolding</span></span> wfp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-Nil_imp_good_list_emb"><span class="command">lemma</span></span> Nil_imp_good_list_emb <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">i</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"good <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bad <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">unfolding</span></span> good_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-ne_lists"><span class="command">lemma</span></span> ne_lists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"tl <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Almost_Full-list_emb_eq_length_induct"><span class="command">lemma</span></span> list_emb_eq_length_induct <span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> Nil Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> list_emb <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">,</span> 3-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_emb_length<span class="main">)</span>

<span class="keyword1" id="Almost_Full-list_emb_eq_length_P"><span class="command">lemma</span></span> list_emb_eq_length_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_emb_eq_length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Special Case: Finite Sets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Every reflexive relation on a finite set is almost-full.
›</span></span>
<span class="keyword1" id="Almost_Full-finite_almost_full_on"><span class="command">lemma</span></span> finite_almost_full_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span>nat set"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="var">?I</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> finite <span class="keyword2"><span class="keyword">and</span></span> finite_subset <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pigeonhole_infinite <span class="main">[</span><span class="operator">OF</span> this 1<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infinite_nat_iff_unbounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> refl <span class="keyword2"><span class="keyword">and</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reflp_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">l</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-eq_almost_full_on_finite_set"><span class="command">lemma</span></span> eq_almost_full_on_finite_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(=)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_almost_full_on <span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reflp_on_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Further Results›</span></span>

<span class="keyword1" id="Almost_Full-af_trans_extension_imp_wf"><span class="command">lemma</span></span> af_trans_extension_imp_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subrel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> af<span class="main">:</span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"transp_on <span class="free">Q</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> wfp_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> notI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> strict <span class="free">Q</span> <span class="main">(</span><span class="bound">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span><span class="main">¯¯</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> chain_transp_on_less <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> transp_on_strict <span class="main">[</span><span class="operator">THEN</span> transp_on_converse<span class="main">,</span> <span class="operator">OF</span> trans<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> subrel <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> af <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def good_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-af_trans_imp_wf"><span class="command">lemma</span></span> af_trans_imp_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="main">(</span>strict <span class="free">P</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> af_trans_extension_imp_wf<span class="main">)</span>

<span class="keyword1" id="Almost_Full-wf_and_no_antichain_imp_qo_extension_wf"><span class="command">lemma</span></span> wf_and_no_antichain_imp_qo_extension_wf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp_on <span class="main">(</span>strict <span class="free">P</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> anti<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> antichain_on <span class="free">P</span> <span class="bound">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subrel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qo<span class="main">:</span> <span class="quoted"><span class="quoted">"qo_on <span class="free">Q</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qo <span class="keyword1"><span class="command">unfolding</span></span> qo_on_def transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"transp_on <span class="main">(</span><span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span><span class="main">¯¯</span><span class="main">)</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> transp_on_converse<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wfp_on <span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> strict <span class="free">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wfp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span>strict <span class="free">Q</span><span class="main">)</span><span class="main">¯¯</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> chain_transp_on_less <span class="main">[</span><span class="operator">OF</span> this *<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subrel <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="skolem">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> subchain <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">,</span> <span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">g</span> <span class="bound">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> strict <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="main">[</span><span class="operator">unfolded</span> wfp_on_def not_ex<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> A
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> choice <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="bound">k</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">h</span> <span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">h</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">^^</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">k</span> <span class="main">&gt;</span> <span class="bound">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">i</span></span></span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lift_Suc_mono_less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> mono <span class="main">[</span><span class="operator">THEN</span> *<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> incomparable <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="main">¬</span> incomparable <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> anti <span class="main">[</span><span class="operator">unfolded</span> not_ex<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Almost_Full-every_qo_extension_wf_imp_af"><span class="command">lemma</span></span> every_qo_extension_wf_imp_af<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
    qo_on <span class="bound">Q</span> <span class="free">A</span> <span class="main">⟶</span> wfp_on <span class="main">(</span>strict <span class="bound">Q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"qo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹qo_on <span class="free">P</span> <span class="free">A</span>›</span></span>
    <span class="keyword1"><span class="command">have</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qo_on_imp_reflp_on qo_on_imp_transp_on<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≥</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le_imp_less<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> restrict_to <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">(</span>sup <span class="skolem">P'</span> <span class="skolem">D</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="skolem">D</span> <span class="keyword1">OO</span> <span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span> <span class="keyword1">OO</span> <span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">j</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def reflp_on_restrict_to_rtranclp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"*"</span> dual_order.strict_trans1 less_Suc_eq_le refl reflp_on_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_imp_less_Suc less_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="skolem">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qo_on <span class="skolem">Q</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qo_on_def reflp_on_def transp_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="main">(</span>strict <span class="skolem">Q</span><span class="main">)</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ext <span class="main">[</span><span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">Q</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> strict <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sup <span class="skolem">P'</span> <span class="skolem">D</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sup <span class="skolem">P'</span> <span class="skolem">D</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> sup <span class="main">(</span><span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="main">(</span><span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">OO</span> <span class="main">(</span><span class="skolem">D</span> <span class="keyword1">OO</span> <span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="bound">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∪</span> <span class="bound">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="main">(</span><span class="bound">B</span> <span class="keyword1">O</span> <span class="bound">A</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">regexp</span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="main">[</span><span class="operator">to_pred</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup <span class="main">(</span><span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="main">(</span><span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">OO</span> <span class="main">(</span><span class="skolem">D</span> <span class="keyword1">OO</span> <span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">OO</span> <span class="main">(</span><span class="skolem">D</span> <span class="keyword1">OO</span> <span class="skolem">P'</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> less_le relcompp.relcompI tranclp_into_tranclp2<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> A <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> strict <span class="skolem">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> wfp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Minimal_Bad_Sequences">
<div class="head">
<h1>Theory Minimal_Bad_Sequences</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Constructing Minimal Bad Sequences›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Minimal_Bad_Sequences
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Almost_Full.html">Almost_Full</a>
  <a href="Minimal_Elements.html">Minimal_Elements</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A locale capturing the construction of minimal bad sequences over values from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">A</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Where
  minimality is to be understood w.r.t.\ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">size</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of an element.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> mbs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> size<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">size</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a well-founded measure, whenever some element satisfies a property
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then there is a size-minimal such element.
›</span></span>
<span class="keyword1" id="Minimal_Bad_Sequences-minimal"><span class="command">lemma</span></span> minimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> size <span class="bound">y</span> <span class="main">≤</span> size <span class="free">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> size <span class="bound">z</span> <span class="main">&lt;</span> size <span class="bound">y</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted">size</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> size <span class="bound">y</span> <span class="main">&lt;</span> size <span class="skolem">x</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">y</span> <span class="main">&lt;</span> size <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Minimal_Bad_Sequences-less_not_eq"><span class="command">lemma</span></span> less_not_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> size <span class="free">x</span> <span class="main">&lt;</span> size <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The set of all bad sequences over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">BAD</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> SEQ <span class="free">A</span><span class="main">.</span> bad <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Minimal_Bad_Sequences-BAD_iff"><span class="command">lemma</span></span> BAD_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> BAD <span class="free">P</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> bad <span class="free">P</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> BAD_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A partial order on infinite bad sequences.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">geseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">geseq</span> <span class="main">=</span>
    <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">f</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> size <span class="main">(</span><span class="bound">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The strict part of the above order.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gseq</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> size <span class="main">(</span><span class="bound">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Minimal_Bad_Sequences-geseq_iff"><span class="command">lemma</span></span> geseq_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> geseq <span class="main">⟷</span>
    <span class="free">f</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> size <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> geseq_def<span class="main">)</span>

<span class="keyword1" id="Minimal_Bad_Sequences-gseq_iff"><span class="command">lemma</span></span> gseq_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟷</span> <span class="free">f</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="free">g</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> size <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_def<span class="main">)</span>

<span class="keyword1" id="Minimal_Bad_Sequences-geseqE"><span class="command">lemma</span></span> geseqE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> geseq"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> size <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> geseq_iff<span class="main">)</span>

<span class="keyword1" id="Minimal_Bad_Sequences-gseqE"><span class="command">lemma</span></span> gseqE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> gseq"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> size <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">j</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> min_elt_size<span class="main">?</span><span class="main">:</span> minimal_element <span class="quoted"><span class="quoted">"measure_on size UNIV"</span></span> <span class="quoted"><span class="free">A</span></span>
<span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"measure_on size UNIV <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> size <span class="bound">x</span> <span class="main">&lt;</span> size <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> po_on_def irreflp_on_def transp_on_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> wfp_on_UNIV <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wfp_on_subset<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> measure_on_def inv_image_betw_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A lower bound to all sequences in a set of sequences <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lb</span> <span class="main">≡</span> lexmin <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Minimal_Bad_Sequences-eq_upto_BAD_mem"><span class="command">lemma</span></span> eq_upto_BAD_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> <span class="free">g</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">j</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Assume that there is some infinite bad sequence <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> BAD_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> BAD <span class="free">P</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When there is a bad sequence, then filtering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"BAD <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> w.r.t.~positions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">lb</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> never
  yields an empty set of sequences.
›</span></span>
<span class="keyword1" id="Minimal_Bad_Sequences-eq_upto_BAD_non_empty"><span class="command">lemma</span></span> eq_upto_BAD_non_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> eq_upto_lexmin_non_empty <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"BAD <span class="free">P</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> BAD_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Minimal_Bad_Sequences-non_empty_ith"><span class="command">lemma</span></span> non_empty_ith<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ith <span class="main">(</span>eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="free">i</span><span class="main">)</span> <span class="free">i</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ith <span class="main">(</span>eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="free">i</span><span class="main">)</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_upto_BAD_non_empty <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span>
  lb_minimal <span class="main">=</span> min_elt_minimal <span class="main">[</span><span class="operator">OF</span> non_empty_ith<span class="main">,</span> <span class="operator">folded</span> lexmin<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span>
  lb_mem <span class="main">=</span> min_elt_mem <span class="main">[</span><span class="operator">OF</span> non_empty_ith<span class="main">,</span> <span class="operator">folded</span> lexmin<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"lb"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a infinite bad sequence.
›</span></span>
<span class="keyword1" id="Minimal_Bad_Sequences-lb_BAD"><span class="command">lemma</span></span> lb_BAD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lb <span class="main">∈</span> BAD <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> lb <span class="bound">j</span> <span class="main">∈</span> ith <span class="main">(</span>eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="bound">j</span><span class="main">)</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lb_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> lb <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ith_conv<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> eq_upto_BAD_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> lb"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>lb <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>lb <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lb <span class="skolem">j</span> <span class="main">∈</span> ith <span class="main">(</span>eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="skolem">j</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">j</span> <span class="main">=</span> lb <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">≤</span> <span class="skolem">j</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">=</span> lb <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_le_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="main">(</span>lb <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>lb <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">g</span> <span class="main">∈</span> eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  There is no infinite bad sequence that is strictly smaller than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">lb</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Minimal_Bad_Sequences-lb_lower_bound"><span class="command">lemma</span></span> lb_lower_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span>lb<span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟶</span> <span class="bound">g</span> <span class="main">∉</span> BAD <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lb<span class="main">,</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">∈</span> gseq"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span>lb <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> lb <span class="bound">j</span> <span class="main">=</span> <span class="skolem">g</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> lb_minimal
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">∉</span> ith <span class="main">(</span>eq_upto <span class="main">(</span>BAD <span class="free">P</span><span class="main">)</span> lb <span class="skolem">i</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∉</span> BAD <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If there is at least one bad sequence, then there is also a minimal one.
›</span></span>
<span class="keyword1" id="Minimal_Bad_Sequences-lower_bound_ex"><span class="command">lemma</span></span> lower_bound_ex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> BAD <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟶</span> <span class="bound">g</span> <span class="main">∉</span> BAD <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lb_BAD <span class="keyword2"><span class="keyword">and</span></span> lb_lower_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Minimal_Bad_Sequences-gseq_conv"><span class="command">lemma</span></span> gseq_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟷</span> <span class="free">f</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">∧</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> geseq"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_def geseq_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_not_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is a minimal bad sequence.›</span></span>
<span class="keyword1" id="Minimal_Bad_Sequences-mbs"><span class="command">lemma</span></span> mbs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> BAD <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟶</span> good <span class="free">P</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lower_bound_ex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_conv geseq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Higman_OI">
<div class="head">
<h1>Theory Higman_OI</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Proof of Higman's Lemma via Open Induction›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Higman_OI
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Open_Induction/Open_Induction.html">Open_Induction.Open_Induction</a>
  <a href="Minimal_Elements.html">Minimal_Elements</a>
  <a href="Almost_Full.html">Almost_Full</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some facts about the suffix relation›</span></span>

<span class="keyword1" id="Higman_OI-wfp_on_strict_suffix"><span class="command">lemma</span></span> wfp_on_strict_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wfp_on strict_suffix <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wfp_on_mono <span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_refl<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"measure_on length <span class="free"><span class="free"><span class="free">A</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_suffix_def suffix_def<span class="main">)</span>

<span class="keyword1" id="Higman_OI-po_on_strict_suffix"><span class="command">lemma</span></span> po_on_strict_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"po_on strict_suffix <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strict_suffix_def po_on_def transp_on_def irreflp_on_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic Order on Infinite Sequences›</span></span>

<span class="keyword1" id="Higman_OI-antisymp_on_LEX"><span class="command">lemma</span></span> antisymp_on_LEX<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"irreflp_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"antisymp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"antisymp_on <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> SEQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">f</span> <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">g</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">g</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>min <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>min <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> SEQ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> antisymp_on_def min_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> SEQ <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> irreflp_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Higman_OI-LEX_trans"><span class="command">lemma</span></span> LEX_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="free">g</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="free">f</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def transp_on_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> less_trans linorder_neqE_nat<span class="main">)</span>

<span class="keyword1" id="Higman_OI-qo_on_LEXEQ"><span class="command">lemma</span></span> qo_on_LEXEQ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> qo_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qo_on_def reflp_on_def transp_on_def <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"LEXEQ <span class="free">P</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LEX_trans<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> minimal_element
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Higman_OI-glb_LEX_lexmin"><span class="command">lemma</span></span> glb_LEX_lexmin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chain_on <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="free">C</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"glb <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmin <span class="free">C</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lexmin_SEQ_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
  <span class="keyword1"><span class="command">note</span></span> lex <span class="main">=</span> LEX_imp_less <span class="main">[</span><span class="operator">folded</span> irreflp_on_def<span class="main">,</span> <span class="operator">OF</span> po <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> po_on_imp_irreflp_on<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>lexmin C›</span></span> is a lower bound›</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lb <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LEXEQ <span class="free">P</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> lexmin <span class="free">C</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> LeastI_ex <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> i_def<span class="main">]</span>
        <span class="keyword2"><span class="keyword">and</span></span> not_less_Least <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="bound">i</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> i_def<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">=</span> lexmin <span class="free">C</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">∈</span> ith <span class="main">(</span>eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>lexmin <span class="free">C</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lexmin_minimal <span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">C</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eq_upto_lexmin_non_empty <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>lexmin <span class="free">C</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> lex <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> lex <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def chain_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹<span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>lexmin C›</span></span> is greater than or equal to any other lower bound›</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> lb<span class="main">:</span> <span class="quoted"><span class="quoted">"lb <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="free">C</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LEXEQ <span class="free">P</span> <span class="skolem">f</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> lexmin <span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> LeastI_ex <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">folded</span> i_def<span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> not_less_Least <span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="bound">i</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> i_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">i</span> <span class="main">≠</span> lexmin <span class="free">C</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">j</span> <span class="main">=</span> lexmin <span class="free">C</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> eq_upto <span class="free">C</span> <span class="main">(</span>lexmin <span class="free">C</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eq_upto_lexmin_non_empty <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_upto_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">h</span> <span class="bound">j</span> <span class="main">=</span> lexmin <span class="free">C</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> lb <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">∈</span> <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LEX <span class="free">P</span> <span class="skolem">f</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lb_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> neq <span class="keyword2"><span class="keyword">and</span></span> eq <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">∈</span> <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lex<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Higman_OI-dc_on_LEXEQ"><span class="command">lemma</span></span> dc_on_LEXEQ<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dc_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chain_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain_on <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmin <span class="skolem">C</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lexmin_SEQ_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"glb <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="main">(</span>lexmin <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> glb_LEX_lexmin <span class="main"><span class="main">[</span></span><span class="operator">OF</span> chain <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"glb <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="main">(</span>lexmin <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> glb_def lb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹lexmin <span class="skolem">C</span> <span class="main">∈</span> SEQ <span class="free">A</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> SEQ <span class="free">A</span><span class="main">.</span> glb <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Properties that only depend on finite initial segments of a sequence
  (i.e., which are open with respect to the product topology).
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pt_open_on</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">f</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Higman_OI-pt_open_onD"><span class="command">lemma</span></span> pt_open_onD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pt_open_on <span class="free">Q</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pt_open_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Higman_OI-pt_open_on_good"><span class="command">lemma</span></span> pt_open_on_good<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pt_open_on <span class="main">(</span>good <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> pt_open_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">Q</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> good <span class="free">Q</span> <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"good <span class="free">Q</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> good <span class="free">Q</span> <span class="bound">g</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ballI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">Q</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> good <span class="free">Q</span> <span class="bound">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> good <span class="free">Q</span> <span class="bound">g</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">Q</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> minimal_element
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Higman_OI-pt_open_on_imp_open_on_LEXEQ"><span class="command">lemma</span></span> pt_open_on_imp_open_on_LEXEQ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pt_open_on <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"open_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"chain_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> glb <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="bound">g</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"glb <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> glb<span class="main">:</span> <span class="quoted"><span class="quoted">"glb <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> glb_def lb_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> chain <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chain_on <span class="main">(</span>LEX <span class="free">P</span><span class="main">)</span> <span class="skolem">C</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chain_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> glb_LEX_lexmin <span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ne<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmin <span class="skolem">C</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> lexmin_SEQ_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> glb_unique <span class="main">[</span><span class="operator">OF</span> _ g this glb *<span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> antisymp_on_LEX <span class="main">[</span><span class="operator">OF</span> po_on_imp_irreflp_on <span class="main"><span class="main">[</span></span><span class="operator">OF</span> po<span class="main"><span class="main">]</span></span> po_on_imp_antisymp_on <span class="main"><span class="main">[</span></span><span class="operator">OF</span> po<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lexmin <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="main">[</span><span class="operator">THEN</span> pt_open_onD<span class="main">,</span> <span class="operator">OF</span> Q g<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> SEQ <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="bound">h</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> eq_upto_lexmin_non_empty <span class="main">[</span><span class="operator">OF</span> C ne<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> eq_upto <span class="skolem">C</span> <span class="skolem">g</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">∈</span><span class="skolem">C</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Higman_OI-open_on_good"><span class="command">lemma</span></span> open_on_good<span class="main">:</span>
  <span class="quoted"><span class="quoted">"open_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="main">(</span>good <span class="free">Q</span><span class="main">)</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pt_open_on_imp_open_on_LEXEQ pt_open_on_good<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Higman_OI-open_on_LEXEQ_imp_pt_open_on_counterexample"><span class="command">lemma</span></span> open_on_LEXEQ_imp_pt_open_on_counterexample<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> False<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minimal_element <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"open_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pt_open_on <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"minimal_element <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def po_on_def irreflp_on_def transp_on_def wfp_on_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"open_on <span class="main">(</span>LEXEQ <span class="free">P</span><span class="main">)</span> <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P_def open_on_def chain_on_def SEQ_def glb_def lb_def LEX_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pt_open_on <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> SEQ <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"pt_open_on <span class="free">Q</span> <span class="main">(</span>SEQ <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">f</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="bound">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pt_open_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Q_def f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">∈</span>SEQ <span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="bound">g</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">f</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span> <span class="main"><span class="main"><span class="main">:=</span></span></span> <span class="free"><span class="free"><span class="free">a</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f_def Q_def A_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Higman_OI-higman"><span class="command">lemma</span></span> higman<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> minimal_element <span class="quoted">strict_suffix</span> <span class="quoted"><span class="quoted">"lists <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">intro</span> po_on_strict_suffix wfp_on_strict_suffix<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">presume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> SEQ <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> qo_on_LEXEQ <span class="main">[</span><span class="operator">OF</span> po_on_imp_transp_on <span class="main"><span class="main">[</span></span><span class="operator">OF</span> po_on_strict_suffix<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> dc_on_LEXEQ <span class="keyword2"><span class="keyword">and</span></span> open_on_good
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> open_induct_on<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">i</span> <span class="main">=</span> hd <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> SEQ <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> h_def ne_lists<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> almost_full_on_imp_homogeneous_subseq <span class="main">[</span><span class="operator">OF</span> assms this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="bound">j</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="skolem">i</span> <span class="keyword1">else</span> tl <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> f'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">∈</span> SEQ <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> SEQ <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f'_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list.set_sel<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">f'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">f'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f'_def h_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict_suffix <span class="main">(</span><span class="skolem">f'</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> f'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LEX strict_suffix <span class="skolem">f'</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LEX_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> LEX_imp_not_LEX <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strict <span class="main">(</span>LEXEQ strict_suffix<span class="main">)</span> <span class="skolem">f'</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> po_on_strict_suffix <span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> po_on_def irreflp_on_def transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> less<span class="main">(</span>2<span class="main">)</span> <span class="main">[</span><span class="operator">OF</span> f' this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="skolem">f'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb<span class="main">:</span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">f'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">f'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> 2 <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span><span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">with</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">f'</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Almost_Full_Relations">
<div class="head">
<h1>Theory Almost_Full_Relations</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Almost-Full Relations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Almost_Full_Relations
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Minimal_Bad_Sequences.html">Minimal_Bad_Sequences</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mbs<span class="main">)</span> mbs'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span> <span class="main">∈</span> BAD <span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟶</span> good <span class="free">P</span> <span class="bound">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> mbs <span class="keyword1"><span class="command">unfolding</span></span> almost_full_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(*TODO: move to Option.thy of Isabelle/HOL?*)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Adding a Bottom Element to a Set›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">with_bot</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> option set"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main"><span class="free"><span class="hidden">⇩</span><sub>⊥</sub></span></span> <span class="main">=</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Almost_Full_Relations-with_bot_iff"><span class="command">lemma</span></span> with_bot_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Some <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> with_bot_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full_Relations-NoneI"><span class="command">lemma</span></span> NoneI <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"None <span class="main">∈</span> <span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> with_bot_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full_Relations-not_None_the_mem"><span class="command">lemma</span></span> not_None_the_mem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> None <span class="main">⟹</span> the <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Almost_Full_Relations-with_bot_cases"><span class="command">lemma</span></span> with_bot_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">u</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Almost_Full_Relations-with_bot_empty_conv"><span class="command">lemma</span></span> with_bot_empty_conv <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">=</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> with_bot_cases<span class="main">)</span>

<span class="keyword1" id="Almost_Full_Relations-with_bot_UNIV"><span class="command">lemma</span></span> with_bot_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"UNIV<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> UNIV<span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∈</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Adding a Bottom Element to an Almost-Full Set›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">option_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">option_le</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> None <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">option_le</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> None <span class="main">=</span> False"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">option_le</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Almost_Full_Relations-None_imp_good_option_le"><span class="command">lemma</span></span> None_imp_good_option_le <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"good <span class="main">(</span>option_le <span class="free">P</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> goodI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free"><span class="free">i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="Almost_Full_Relations-almost_full_on_with_bot"><span class="command">lemma</span></span> almost_full_on_with_bot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>option_le <span class="free">P</span><span class="main">)</span> <span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">≠</span> None"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> almost_full_onD <span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"the <span class="main">∘</span> <span class="skolem">f</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ** <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Disjoint Union of Almost-Full Sets›</span></span>

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">sum_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_le</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_le</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">sum_le</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Almost_Full_Relations-not_sum_le_cases"><span class="command">lemma</span></span> not_sum_le_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sum_le <span class="free">P</span> <span class="free">Q</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="free">a</span> <span class="main">=</span> Inl <span class="bound">x</span><span class="main">;</span> <span class="free">b</span> <span class="main">=</span> Inl <span class="bound">y</span><span class="main">;</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="free">a</span> <span class="main">=</span> Inr <span class="bound">x</span><span class="main">;</span> <span class="free">b</span> <span class="main">=</span> Inr <span class="bound">y</span><span class="main">;</span> <span class="main">¬</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="free">a</span> <span class="main">=</span> Inl <span class="bound">x</span><span class="main">;</span> <span class="free">b</span> <span class="main">=</span> Inr <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="free">a</span> <span class="main">=</span> Inr <span class="bound">x</span><span class="main">;</span> <span class="free">b</span> <span class="main">=</span> Inl <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="free">thesis</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sum.exhaust <span class="main"><span class="main">[</span></span><span class="operator">case_product</span> sum.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When two sets are almost-full, then their disjoint sum is almost-full.
›</span></span>
<span class="keyword1" id="Almost_Full_Relations-almost_full_on_Plus"><span class="command">lemma</span></span> almost_full_on_Plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>sum_le <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">-`</span> Inl <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?J</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">-`</span> Inr <span class="main">`</span> <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?J</span> <span class="main">=</span> <span class="main">(</span>UNIV<span class="main">::</span>nat set<span class="main">)</span> <span class="main">-</span> <span class="var">?I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?P</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="var">?I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> infinitely_many1 <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> Inr <span class="main">`</span> <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_nat_iff_unbounded<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Inl <span class="bound">x</span> <span class="main">⟹</span> False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> enum_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Inr_Inl_False<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> projr <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enum_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> sum.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enum <span class="skolem">i</span> <span class="main">&lt;</span> enum <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enum_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> bad <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>enum <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>enum <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> not_sum_le_cases<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="free">Q</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹almost_full_on <span class="free">Q</span> <span class="free">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> B
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="free">Q</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def almost_full_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?I</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> infinitely_many1 <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> Inl <span class="main">`</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_nat_iff_unbounded<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> Inr <span class="bound">x</span> <span class="main">⟹</span> False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> enum_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Inr_Inl_False<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> projl <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>enum <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enum_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> sum.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="quoted">nat</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"enum <span class="skolem">i</span> <span class="main">&lt;</span> enum <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> enum_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> bad <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>enum <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>enum <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?f</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> not_sum_le_cases<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="free">P</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹almost_full_on <span class="free">P</span> <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> A
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def almost_full_on_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dickson's Lemma for Almost-Full Relations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When two sets are almost-full, then their Cartesian product is almost-full.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">prod_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prod_le</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">p1</span><span class="main">,</span> <span class="bound">p2</span><span class="main">)</span> <span class="main">(</span><span class="bound">q1</span><span class="main">,</span> <span class="bound">q2</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P1</span></span></span> <span class="bound">p1</span> <span class="bound">q1</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P2</span></span></span> <span class="bound">p2</span> <span class="bound">q2</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Almost_Full_Relations-prod_le_True"><span class="command">lemma</span></span> prod_le_True <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"prod_le <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">P</span> <span class="main">(</span>fst <span class="free">a</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_le_def<span class="main">)</span>

<span class="keyword1" id="Almost_Full_Relations-almost_full_on_Sigma"><span class="command">lemma</span></span> almost_full_on_Sigma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P1</span> <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P2</span> <span class="free">A2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>prod_le <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span> <span class="main">(</span><span class="free">A1</span> <span class="main">×</span> <span class="free">A2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?P</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?W</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P1</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P2</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SigmaE fst_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> SigmaE snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> almost_full_on_imp_homogeneous_subseq <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fst<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="bound">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="var">?W</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> snd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">φ</span> <span class="main">∈</span> SEQ <span class="free">A2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P2</span> <span class="main">(</span>snd <span class="main">∘</span> <span class="skolem">f</span> <span class="main">∘</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta prod_le_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> mono <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bad <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Higman's Lemma for Almost-Full Relations›</span></span>

<span class="keyword1" id="Almost_Full_Relations-almost_full_on_lists"><span class="command">lemma</span></span> almost_full_on_lists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> mbs <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> mbs' <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> BAD <span class="var">?P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟶</span> good <span class="var">?P</span> <span class="bound">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> hd <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> tl <span class="main">(</span><span class="skolem">m</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">h</span> <span class="bound">i</span> <span class="main">#</span> <span class="skolem">t</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def t_def<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">h</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne_lists <span class="main">[</span><span class="operator">OF</span> ne<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> lists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> almost_full_on_imp_homogeneous_subseq <span class="main">[</span><span class="operator">OF</span> assms this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="bound">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> bad_t<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?P</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">∘</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">∘</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> m<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> list_emb_Cons2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> less <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> bad <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="keyword1">else</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> m'_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">m'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">m</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> m'_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≥</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">m'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">m'</span> <span class="bound">i</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne_lists <span class="main">[</span><span class="operator">OF</span> ne<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> lists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_def t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">m'</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def m'_geq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">φ</span> <span class="main">0</span><span class="main">.</span> <span class="skolem">m'</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">m</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_less<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> gseq"</span></span> <span class="keyword1"><span class="command">using</span></span> lists <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="var">?P</span> <span class="skolem">m'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_less<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> bad <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_geq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bad_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m'_less m'_geq<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> list_emb_Cons <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h_def t_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="main">0</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">φ</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> bad <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> min <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Natural Numbers›</span></span>

<span class="keyword1" id="Almost_Full_Relations-almost_full_on_UNIV_nat"><span class="command">lemma</span></span> almost_full_on_UNIV_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(≤)</span> <span class="main">(</span>UNIV <span class="main">::</span> nat set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"subseq <span class="main">::</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">::</span> bool list set<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>UNIV <span class="main">::</span> nat set<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ex_list_of_length surj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(≤)</span> <span class="main">(</span>length <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">::</span> bool list set<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> almost_full_on_hom<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≤</span> length <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_emb_length<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> almost_full_on_lists <span class="main">[</span><span class="operator">OF</span> eq_almost_full_on_finite_set <span class="main"><span class="main">[</span></span><span class="operator">OF</span> this<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> UNIV"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lists_UNIV <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Well_Quasi_Orders">
<div class="head">
<h1>Theory Well_Quasi_Orders</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Well-Quasi-Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Well_Quasi_Orders
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Almost_Full_Relations.html">Almost_Full_Relations</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Basic Definitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wqo_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wqo_on</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟷</span> transp_on <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> almost_full_on <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_UNIV"><span class="command">lemma</span></span> wqo_on_UNIV<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> almost_full_on_UNIV <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def transp_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_onI"><span class="command">lemma</span></span> wqo_onI <span class="main">[</span><span class="operator">Pure.intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>transp_on <span class="free">P</span> <span class="free">A</span><span class="main">;</span> almost_full_on <span class="free">P</span> <span class="free">A</span><span class="main">⟧</span> <span class="main">⟹</span> wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wqo_on_def almost_full_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_imp_reflp_on"><span class="command">lemma</span></span> wqo_on_imp_reflp_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> reflp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> almost_full_on_imp_reflp_on <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_imp_transp_on"><span class="command">lemma</span></span> wqo_on_imp_transp_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_imp_almost_full_on"><span class="command">lemma</span></span> wqo_on_imp_almost_full_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_imp_qo_on"><span class="command">lemma</span></span> wqo_on_imp_qo_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> qo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> qo_on_def wqo_on_imp_reflp_on wqo_on_imp_transp_on<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_imp_good"><span class="command">lemma</span></span> wqo_on_imp_good<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> good <span class="free">P</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def almost_full_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_subset"><span class="command">lemma</span></span> wqo_on_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> wqo_on <span class="free">P</span> <span class="free">B</span> <span class="main">⟹</span> wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> almost_full_on_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> transp_on_subset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> wqo_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalent Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a quasi-order <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the following statements are equivalent:
  \begin{enumerate}
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a almost-full.
  \item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does neither allow decreasing chains nor antichains.
  \item Every quasi-order extending <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-founded.
  \end{enumerate}
›</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_af_conv"><span class="command">lemma</span></span> wqo_af_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟷</span> almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> qo_on_def wqo_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_wf_and_no_antichain_conv"><span class="command">lemma</span></span> wqo_wf_and_no_antichain_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟷</span> wfp_on <span class="main">(</span>strict <span class="free">P</span><span class="main">)</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> antichain_on <span class="free">P</span> <span class="bound">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wqo_af_conv <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> af_trans_imp_wf <span class="main">[</span><span class="operator">OF</span> _ assms <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> qo_on_imp_transp_on<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_imp_no_antichain_on <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> wf_and_no_antichain_imp_qo_extension_wf <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> every_qo_extension_wf_imp_af <span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_extensions_wf_conv"><span class="command">lemma</span></span> wqo_extensions_wf_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> qo_on <span class="bound">Q</span> <span class="free">A</span> <span class="main">⟶</span> wfp_on <span class="main">(</span>strict <span class="bound">Q</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wqo_af_conv <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> af_trans_imp_wf <span class="main">[</span><span class="operator">OF</span> _ assms <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> qo_on_imp_transp_on<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_imp_no_antichain_on <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> wf_and_no_antichain_imp_qo_extension_wf <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> every_qo_extension_wf_imp_af <span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_imp_wfp_on"><span class="command">lemma</span></span> wqo_on_imp_wfp_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span> <span class="main">⟹</span> wfp_on <span class="main">(</span>strict <span class="free">P</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> wqo_on_imp_qo_on wqo_wf_and_no_antichain_conv<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The homomorphic image of a wqo set is wqo.
›</span></span>
<span class="keyword1" id="Well_Quasi_Orders-wqo_on_hom"><span class="command">lemma</span></span> wqo_on_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_hom <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> wqo_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The monomorphic preimage of a wqo set is wqo.
›</span></span>
<span class="keyword1" id="Well_Quasi_Orders-wqo_on_mon"><span class="command">lemma</span></span> wqo_on_mon<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">h</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wqo<span class="main">:</span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> wqo_on_imp_transp_on <span class="main">[</span><span class="operator">OF</span> wqo<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bij_betw_def transp_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_mon <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wqo_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Type Class for Well-Quasi-Orders›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In a well-quasi-order (wqo) every infinite sequence is good.
›</span></span>
<span class="keyword1"><span class="command">class</span></span> wqo <span class="main">=</span> preorder <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> good<span class="main">:</span> <span class="quoted"><span class="quoted">"good <span class="main">(≤)</span> <span class="free">f</span>"</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_class"><span class="command">lemma</span></span> wqo_on_class <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="main">(≤)</span> <span class="main">(</span>UNIV <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> wqo<span class="main">)</span> set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> good <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def transp_on_def almost_full_on_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_UNIV_class_wqo"><span class="command">lemma</span></span> wqo_on_UNIV_class_wqo <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> UNIV <span class="main">⟹</span> class.wqo <span class="free">P</span> <span class="main">(</span>strict <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def almost_full_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> transp_on_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma converts between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> wqo_on<span class="antiquote"><span class="antiquote">}</span></span></span></span> (for the special case that the domain is the
  universe of a type) and the class predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> class.wqo<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1" id="Well_Quasi_Orders-wqo_on_UNIV_conv"><span class="command">lemma</span></span> wqo_on_UNIV_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> UNIV <span class="main">⟷</span> class.wqo <span class="free">P</span> <span class="main">(</span>strict <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> class.wqo_def class.preorder_def class.wqo_axioms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def almost_full_on_def transp_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The strict part of a wqo is well-founded.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> wqo<span class="main">)</span> <span class="quoted"><span class="quoted">"wfP <span class="main">(&lt;)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"class.wqo <span class="main">(≤)</span> <span class="main">(&lt;)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(≤)</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> less_le_not_le <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> wqo_on_UNIV_conv <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> wqo_on_imp_wfp_on <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_le_not_le <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> wfp_on_UNIV <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_with_bot"><span class="command">lemma</span></span> wqo_on_with_bot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>option_le <span class="free">P</span><span class="main">)</span> <span class="free">A</span><span class="main"><span class="hidden">⇩</span><sub>⊥</sub></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> trans <span class="main">[</span><span class="operator">unfolded</span> transp_on_def<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="var">?P</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transp_on_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> with_bot_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> trans<span class="main">)</span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_with_bot
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_option_UNIV"><span class="command">lemma</span></span> wqo_on_option_UNIV <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> UNIV <span class="main">⟹</span> wqo_on <span class="main">(</span>option_le <span class="free">P</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wqo_on_with_bot <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When two sets are wqo, then their disjoint sum is wqo.
›</span></span>
<span class="keyword1" id="Well_Quasi_Orders-wqo_on_Plus"><span class="command">lemma</span></span> wqo_on_Plus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>sum_le <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">&lt;+&gt;</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> trans <span class="main">[</span><span class="operator">unfolded</span> transp_on_def<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="var">?P</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> trans<span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_Plus <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_sum_UNIV"><span class="command">lemma</span></span> wqo_on_sum_UNIV <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> UNIV <span class="main">⟹</span> wqo_on <span class="free">Q</span> UNIV <span class="main">⟹</span> wqo_on <span class="main">(</span>sum_le <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wqo_on_Plus <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Dickson's Lemma›</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_Sigma"><span class="command">lemma</span></span> wqo_on_Sigma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P1</span> <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P2</span> <span class="free">A2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>prod_le <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span> <span class="main">(</span><span class="free">A1</span> <span class="main">×</span> <span class="free">A2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P1</span> <span class="free">A1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P2</span> <span class="free">A2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="var">?P</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> transp_on_def prod_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_Sigma <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P1</span></span> <span class="quoted"><span class="free">A1</span></span> <span class="quoted"><span class="free">P2</span></span> <span class="quoted"><span class="free">A2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> dickson <span class="main">=</span> wqo_on_Sigma

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_prod_UNIV"><span class="command">lemma</span></span> wqo_on_prod_UNIV <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> UNIV <span class="main">⟹</span> wqo_on <span class="free">Q</span> UNIV <span class="main">⟹</span> wqo_on <span class="main">(</span>prod_le <span class="free">P</span> <span class="free">Q</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wqo_on_Sigma <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Higman's Lemma›</span></span>

<span class="keyword1" id="Well_Quasi_Orders-transp_on_list_emb"><span class="command">lemma</span></span> transp_on_list_emb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> list_emb_trans <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_lists"><span class="command">lemma</span></span> wqo_on_lists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> <span class="main">(</span>lists <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> almost_full_on_lists
    <span class="keyword2"><span class="keyword">and</span></span> transp_on_list_emb <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> higman <span class="main">=</span> wqo_on_lists

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_list_UNIV"><span class="command">lemma</span></span> wqo_on_list_UNIV <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> UNIV <span class="main">⟹</span> wqo_on <span class="main">(</span>list_emb <span class="free">P</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wqo_on_lists <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted">UNIV</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Every reflexive and transitive relation on a finite set is a wqo.
›</span></span>
<span class="keyword1" id="Well_Quasi_Orders-finite_wqo_on"><span class="command">lemma</span></span> finite_wqo_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp_on <span class="free">P</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> finite_almost_full_on <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wqo_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-finite_eq_wqo_on"><span class="command">lemma</span></span> finite_eq_wqo_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(=)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_wqo_on <span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> reflp_on_def transp_on_def<span class="main">)</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_lists_over_finite_sets"><span class="command">lemma</span></span> wqo_on_lists_over_finite_sets<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>list_emb <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> list set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wqo_on_lists <span class="main">[</span><span class="operator">OF</span> finite_eq_wqo_on <span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>finite<span class="main">)</span> set"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_map"><span class="command">lemma</span></span> wqo_on_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P'</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wqo_on <span class="free">P</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wqo_on_imp_transp_on<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P'</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wqo_on <span class="free">Q</span> <span class="free">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> subset
    <span class="keyword1"><span class="command">unfolding</span></span> wqo_on_def transp_on_def P'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wqo_on <span class="free">P</span> <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wqo_on_imp_almost_full_on<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wqo_on <span class="free">Q</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">Q</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wqo_on_imp_almost_full_on<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P'</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">.</span> <span class="skolem">f</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> almost_full_on_imp_homogeneous_subseq <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹almost_full_on <span class="free">P</span> <span class="free">A</span>›</span></span> this<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">g</span> <span class="bound">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> chain_transp_on_less <span class="main">[</span><span class="operator">OF</span> ** <span class="quoted"><span class="quoted">‹transp_on <span class="free">P</span> <span class="free">A</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">h</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword2"><span class="keyword">and</span></span> subset <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹almost_full_on <span class="free">Q</span> <span class="free">B</span>›</span></span> <span class="main">[</span><span class="operator">unfolded</span> almost_full_on_def good_def<span class="main">,</span> <span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span><span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="main">::</span> <span class="quoted">nat</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="var">?g</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> ** <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> P'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> g <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P'</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> good_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Well_Quasi_Orders-wqo_on_UNIV_nat"><span class="command">lemma</span></span> wqo_on_UNIV_nat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wqo_on <span class="main">(≤)</span> <span class="main">(</span>UNIV <span class="main">::</span> nat set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wqo_on_def transp_on_def
  <span class="keyword1"><span class="command">using</span></span> almost_full_on_UNIV_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Kruskal">
<div class="head">
<h1>Theory Kruskal</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Kruskal's Tree Theorem›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kruskal
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Well_Quasi_Orders.html">Well_Quasi_Orders</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> kruskal_tree <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">mk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>size<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">root</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">trees</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> size_arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">trees</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">args</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">s</span> <span class="main">&lt;</span> size <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> root_mk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">root</span> <span class="main">(</span><span class="free">mk</span> <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_mk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">args</span> <span class="main">(</span><span class="free">mk</span> <span class="free">f</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mk_root_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">trees</span> <span class="main">⟹</span> <span class="free">mk</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">root</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">args</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trees_root<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">trees</span> <span class="main">⟹</span> <span class="free">root</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trees_arity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">trees</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">args</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">root</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> trees_args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">trees</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">args</span> <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">trees</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Kruskal-mk_inject"><span class="command">lemma</span></span> mk_inject <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> length <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">,</span> length <span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk</span> <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">mk</span> <span class="free">g</span> <span class="free">ts</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span> <span class="main">∧</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk</span> <span class="free">f</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">mk</span> <span class="free">g</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">(</span><span class="free">mk</span> <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free">root</span> <span class="main">(</span><span class="free">mk</span> <span class="free">g</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">args</span> <span class="main">(</span><span class="free">mk</span> <span class="free">f</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free">args</span> <span class="main">(</span><span class="free">mk</span> <span class="free">g</span> <span class="free">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> root_mk <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> root_mk <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword2"><span class="keyword">and</span></span> args_mk <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> args_mk <span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">emb</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span>
<span class="keyword2"><span class="keyword">where</span></span>
  arg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">;</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">trees</span><span class="main">;</span>
    <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">;</span> <span class="free">emb</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">emb</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">mk</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  list_emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">;</span> length <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
    <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">trees</span><span class="main">;</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">trees</span><span class="main">;</span>
    <span class="free">P</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">;</span> list_emb <span class="main">(</span><span class="free">emb</span> <span class="free">P</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">emb</span> <span class="free">P</span> <span class="main">(</span><span class="free">mk</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">mk</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">monos</span></span> list_emb_mono

<span class="keyword1" id="Kruskal-almost_full_on_trees"><span class="command">lemma</span></span> almost_full_on_trees<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>emb <span class="free">P</span><span class="main">)</span> <span class="free">trees</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> mbs <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> mbs' <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> bad<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> BAD <span class="var">?P</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">.</span> <span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∈</span> gseq <span class="main">⟶</span> good <span class="var">?P</span> <span class="bound">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> trees<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">trees</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">root</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">args</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>set <span class="main">(</span><span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">mk</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def a_def mk_root_args <span class="main"><span class="main">[</span></span><span class="operator">OF</span> trees<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span> <span class="bound">i</span> <span class="main">∈</span> lists <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_def S_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> arity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trees_arity <span class="main">[</span><span class="operator">OF</span> trees<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def a_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sig<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> length <span class="main">(</span><span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trees_root <span class="main">[</span><span class="operator">OF</span> trees<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_def r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a_trees<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">trees</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_def trees_args <span class="main"><span class="main">[</span></span><span class="operator">OF</span> trees<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="var">?P</span> <span class="skolem">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bad_s<span class="main">:</span> <span class="quoted"><span class="quoted">"bad <span class="var">?P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> LeastI_ex <span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> sk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">k</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> args<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">s</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="bound">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> Least_le n_def<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="keyword1">then</span> <span class="skolem">m</span> <span class="skolem">i</span> <span class="keyword1">else</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    
    <span class="keyword1"><span class="command">have</span></span> m'_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="skolem">m'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">m</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> m'_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="skolem">m'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bad <span class="var">?P</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"good <span class="var">?P</span> <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m'</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_less<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> bad <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_geq<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bad_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> emb <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_less m'_geq<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> args <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> emb.arg <span class="main">[</span><span class="operator">OF</span> sig <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="main">]</span></span> _ a_trees <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="main">]</span></span> ** *<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> bad <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> gseq"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> SEQ <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trees <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">∈</span> SEQ <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trees <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword2"><span class="keyword">and</span></span> trees_args <span class="main">[</span><span class="operator">OF</span> trees<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_def a_def S_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m'_less<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="skolem">m'</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">&lt;</span> size <span class="main">(</span><span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sk <span class="keyword2"><span class="keyword">and</span></span> size_arg <span class="main">[</span><span class="operator">OF</span> trees<span class="main">,</span> <span class="operator">unfolded</span> m<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m m'_geq root_mk <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sig<span class="main"><span class="main">]</span></span> args_mk <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sig<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gseq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> min <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> almost_full_on_lists <span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">THEN</span> almost_full_on_imp_homogeneous_subseq<span class="main">,</span> <span class="operator">OF</span> lists<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">φ</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">φ</span> <span class="bound">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lemb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">⟹</span> list_emb <span class="var">?P</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> roots<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trees <span class="main">[</span><span class="operator">THEN</span> trees_root<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∘</span> <span class="skolem">φ</span> <span class="main">∈</span> SEQ <span class="free">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"good <span class="free">P</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">∘</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> almost_full_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">r</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> lemb <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">(</span><span class="skolem">φ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sig <span class="keyword2"><span class="keyword">and</span></span> arity <span class="keyword2"><span class="keyword">and</span></span> a_trees <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> emb.list_emb<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> less <span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> bad <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span>
  emb_mk2 <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> arg list_emb<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"emb <span class="free">P</span> <span class="free">s</span> <span class="main">(</span><span class="free">mk</span> <span class="free">g</span> <span class="free">ts</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span>
  list_emb_Nil2_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
  list_emb_Cons_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Kruskal-list_emb_trans_right"><span class="command">lemma</span></span> list_emb_trans_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span> 1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_emb_Nil2_cases list_emb_Cons_cases<span class="main">)</span>

<span class="keyword1" id="Kruskal-emb_trans"><span class="command">lemma</span></span> emb_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="bound">h</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">g</span> <span class="bound">h</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">f</span> <span class="bound">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">P</span> <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">P</span> <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emb <span class="free">P</span> <span class="free">s</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>arg <span class="skolem">f</span> <span class="skolem">m</span> <span class="skolem">ts</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emb.arg<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb <span class="skolem">f</span> <span class="skolem">m</span> <span class="skolem">g</span> <span class="skolem">n</span> <span class="skolem">ss</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹emb <span class="free">P</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">mk</span> <span class="skolem">f</span> <span class="skolem">ss</span><span class="main">)</span>›</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> emb_mk2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> arg
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_emb_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emb.arg<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> list_emb
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> emb.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trans list_emb_trans_right<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Kruskal-transp_on_emb"><span class="command">lemma</span></span> transp_on_emb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="main">(</span>emb <span class="free">P</span><span class="main">)</span> <span class="free">trees</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword2"><span class="keyword">and</span></span> emb_trans <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Kruskal-kruskal"><span class="command">lemma</span></span> kruskal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>emb <span class="free">P</span><span class="main">)</span> <span class="free">trees</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> almost_full_on_trees <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> transp_on_emb wqo_on_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Kruskal_Examples">
<div class="head">
<h1>Theory Kruskal_Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Kruskal_Examples
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Kruskal.html">Kruskal</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> tree <span class="main">=</span> Node <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">node</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">node</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">succs</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succs</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">trees</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">trees</span> <span class="free">A</span> <span class="main">⟹</span> Node <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∈</span> <span class="free">trees</span> <span class="free">A</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trees UNIV <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tree"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> trees UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trees.intros<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> kruskal_tree_tree<span class="main">:</span> kruskal_tree <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">×</span> UNIV"</span></span> <span class="quoted">Node</span> <span class="quoted">node</span> <span class="quoted">succs</span> <span class="quoted"><span class="quoted">"trees <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">A</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">t</span></span></span></span></span></span></span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trees.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl not_less_eq size_list_estimation<span class="main">)</span>

<span class="keyword1"><span class="command">thm</span></span> kruskal_tree_tree.almost_full_on_trees
<span class="keyword1"><span class="command">thm</span></span> kruskal_tree_tree.kruskal

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">tree_emb</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> kruskal_tree_tree.emb <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>prod_le <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Kruskal_Examples-wqo_on_trees"><span class="command">lemma</span></span> wqo_on_trees<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>tree_emb <span class="free">A</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>trees <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wqo_on_Sigma <span class="main">[</span><span class="operator">OF</span> assms wqo_on_UNIV<span class="main">,</span> <span class="operator">THEN</span> kruskal_tree_tree.kruskal<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tree_emb_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
If the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-quasi-ordered by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>, then trees of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> tree"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
are well-quasi-ordered by the homeomorphic embedding relation.
›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> tree <span class="main">::</span> <span class="main">(</span><span class="quoted">wqo</span><span class="main">)</span> <span class="quoted">wqo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> tree_emb UNIV <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> tree<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> class.wqo.of_class.intro<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_tree_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> less_tree_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wqo_on_trees <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">UNIV</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> <span class="quoted">"term"</span> <span class="main">=</span> Var <span class="tfree"><span class="quoted"><span class="tfree">'v</span></span></span> <span class="main">|</span> Fun <span class="tfree"><span class="quoted"><span class="tfree">'f</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'v</span><span class="main">)</span> term list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">root</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">args</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">args</span> <span class="main">(</span>Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">gterms</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">F</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> length <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">gterms</span> <span class="free">F</span> <span class="main">⟹</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∈</span> <span class="free">gterms</span> <span class="free">F</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> kruskal_term<span class="main">:</span> kruskal_tree <span class="quoted"><span class="free">F</span></span> <span class="quoted">Fun</span> <span class="quoted">root</span> <span class="quoted">args</span> <span class="quoted"><span class="quoted">"gterms <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">F</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">t</span></span></span></span></span></span></span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gterms.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl not_less_eq size_list_estimation<span class="main">)</span>

<span class="keyword1"><span class="command">thm</span></span> kruskal_term.almost_full_on_trees

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">terms</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">terms</span> <span class="main">⟹</span> Fun <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∈</span> <span class="free">terms</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> kruskal_variadic<span class="main">:</span> kruskal_tree <span class="quoted">UNIV</span> <span class="quoted">Fun</span> <span class="quoted">root</span> <span class="quoted">args</span> <span class="quoted">terms</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">t</span></span></span></span></span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> terms.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl not_less_eq size_list_estimation<span class="main">)</span>

<span class="keyword1"><span class="command">thm</span></span> kruskal_variadic.almost_full_on_trees

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> exp <span class="main">=</span> V <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> C <span class="quoted">nat</span> <span class="main">|</span> Plus <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> exp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> exp"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> symb <span class="main">=</span> v <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> c <span class="quoted">nat</span> <span class="main">|</span> p

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mk</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk</span> <span class="main">(</span>v <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> V <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mk</span> <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> C <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">mk</span> p <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">=</span> Plus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rt</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rt</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>v <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">::</span>nat<span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rt</span> <span class="main">(</span>C <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>c <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">rt</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>p<span class="main">,</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ags</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ags</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ags</span> <span class="main">(</span>C <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">ags</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">exps</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"V <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">exps</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"C <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∈</span> <span class="free">exps</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free">exps</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">exps</span> <span class="main">⟹</span> Plus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∈</span> <span class="free">exps</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rt <span class="main">(</span>mk p <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>p<span class="main">,</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ts</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ags <span class="main">(</span>mk p <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">ts</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> kruskal_exp<span class="main">:</span> kruskal_tree
  <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span>v <span class="bound">x</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>c <span class="bound">n</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> True<span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span>p<span class="main">,</span> <span class="numeral">2</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="quoted">mk</span> <span class="quoted">rt</span> <span class="quoted">ags</span> <span class="quoted">exps</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">t</span></span></span></span></span></span></span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exps.cases<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">thm</span></span> kruskal_exp.almost_full_on_trees

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> tree_emb V C Plus v c p

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Wqo_Instances">
<div class="head">
<h1>Theory Wqo_Instances</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Instances of Well-Quasi-Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Wqo_Instances
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Kruskal.html">Kruskal</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Option Type is Well-Quasi-Ordered›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">wqo</span><span class="main">)</span> <span class="quoted">wqo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> option_le <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> class.wqo.of_class.intro<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_option_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> less_option_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Sum Type is Well-Quasi-Ordered›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sum <span class="main">::</span> <span class="main">(</span><span class="quoted">wqo</span><span class="main">,</span> <span class="quoted">wqo</span><span class="main">)</span> <span class="quoted">wqo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> sum_le <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> class.wqo.of_class.intro<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_sum_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> less_sum_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pairs are Well-Quasi-Ordered›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If types <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are well-quasi-ordered by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>
and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span>, then pairs of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> <span class="main"><span class="main">×</span></span> <span class="tfree"><span class="tfree">'b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are well-quasi-ordered by
the pointwise combination of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Q›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">wqo</span><span class="main">,</span> <span class="quoted">wqo</span><span class="main">)</span> <span class="quoted">wqo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> prod_le <span class="main">(≤)</span> <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> class.wqo.of_class.intro<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_prod_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> less_prod_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists are Well-Quasi-Ordered›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-quasi-ordered by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>P›</span></span></span></span>, then
lists of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are well-quasi-ordered by the homeomorphic
embedding relation.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">wqo</span><span class="main">)</span> <span class="quoted">wqo</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> list_emb <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">::</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> class.wqo.of_class.intro<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_list_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> less_list_def <span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Multiset_Extension">
<div class="head">
<h1>Theory Multiset_Extension</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Multiset Extension of Orders (as Binary Predicates)›</span></span>

<span class="comment1">(*TODO: move theory (and maybe rename)*)</span>

<span class="keyword1"><span class="command">theory</span></span> Multiset_Extension
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Open_Induction/Restricted_Predicates.html">Open_Induction.Restricted_Predicates</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">multisets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> multiset set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">multisets</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">M</span><span class="main">.</span> set_mset <span class="bound">M</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Multiset_Extension-in_multisets_iff"><span class="command">lemma</span></span> in_multisets_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">⟷</span> set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-empty_multisets"><span class="command">lemma</span></span> empty_multisets <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> multisets <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_multisets_iff<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-multisets_union"><span class="command">lemma</span></span> multisets_union <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">⟹</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">⟹</span> <span class="free">M</span> <span class="main">+</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_multisets_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulex1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mulex1</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span><span class="bound">M</span><span class="main">,</span> <span class="bound">N</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Multiset_Extension-mulex1_empty"><span class="command">lemma</span></span> mulex1_empty <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">M</span> <span class="main">{#}</span> <span class="main">⟷</span> False"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_less_empty <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex1_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex1_add"><span class="command">lemma</span></span> mulex1_add<span class="main">:</span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">N</span> <span class="main">(</span><span class="free">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> mulex1 <span class="free">P</span> <span class="bound">M</span> <span class="free">M0</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">K</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="bound">K</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">b</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="free">M0</span> <span class="main">+</span> <span class="bound">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_add <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">M0</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex1_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex1_self_add_right"><span class="command">lemma</span></span> mulex1_self_add_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">A</span> <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">thm</span></span> mult1_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">{#}</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">,</span> add_mset <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mulex1_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-empty_mult1"><span class="command">lemma</span></span> empty_mult1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">{#}</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-empty_mulex1"><span class="command">lemma</span></span> empty_mulex1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="main">{#}</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> empty_mult1 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mulex1_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mulex_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mulex_on</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span>restrict_to <span class="main">(</span>mulex1 <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">(</span>multisets <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mulex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mulex</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> mulex_on <span class="free"><span class="bound"><span class="entity">P</span></span></span> UNIV"</span></span>

<span class="keyword1" id="Multiset_Extension-mulex_on_induct"><span class="command">lemma</span></span> mulex_on_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> mulex_on<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">M</span> <span class="main">∈</span> multisets <span class="free">A</span><span class="main">;</span> <span class="bound">N</span> <span class="main">∈</span> multisets <span class="free">A</span><span class="main">;</span> mulex1 <span class="free">P</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">M</span> <span class="bound">N</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">L</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">.</span> <span class="main">⟦</span>mulex_on <span class="free">P</span> <span class="free">A</span> <span class="bound">L</span> <span class="bound">M</span><span class="main">;</span> <span class="free">Q</span> <span class="bound">L</span> <span class="bound">M</span><span class="main">;</span> <span class="bound">N</span> <span class="main">∈</span> multisets <span class="free">A</span><span class="main">;</span> mulex1 <span class="free">P</span> <span class="bound">M</span> <span class="bound">N</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">L</span> <span class="bound">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mulex_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Multiset_Extension-mulex_on_self_add_singleton_right"><span class="command">lemma</span></span> mulex_on_self_add_singleton_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">M</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict_to <span class="main">(</span>mulex1 <span class="free">P</span><span class="main">)</span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span> <span class="free">M</span> <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mulex_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-singleton_multisets"><span class="command">lemma</span></span> singleton_multisets <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-union_multisetsD"><span class="command">lemma</span></span> union_multisetsD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_multisetsD"><span class="command">lemma</span></span> mulex_on_multisetsD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∈</span> multisets <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension-union_multisets_iff"><span class="command">lemma</span></span> union_multisets_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> union_multisetsD<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-add_mset_multisets_iff"><span class="command">lemma</span></span> add_mset_multisets_iff <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"add_mset <span class="free">a</span> <span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> union_multisets_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_trans"><span class="command">lemma</span></span> mulex_on_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">L</span> <span class="free">M</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">L</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-transp_on_mulex_on"><span class="command">lemma</span></span> transp_on_mulex_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"transp_on <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mulex_on_trans <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> transp_on_def<span class="main">)</span>
  
<span class="keyword1" id="Multiset_Extension-mulex_on_add_right"><span class="command">lemma</span></span> mulex_on_add_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">N</span> <span class="main">(</span>add_mset <span class="free">a</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mulex_on_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-empty_mulex_on"><span class="command">lemma</span></span> empty_mulex_on <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">{#}</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">a</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> add <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> add <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mulex_on_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_self_add_right"><span class="command">lemma</span></span> mulex_on_self_add_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">K</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">a</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> add <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> add <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mulex_on_add_right <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-mult1_singleton"><span class="command">lemma</span></span> mult1_singleton <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">y</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span><span class="free">x</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="skolem"><span class="skolem">a</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">y</span><span class="main">#}</span> <span class="main">=</span> add_mset <span class="skolem">a</span> <span class="skolem">M0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟶</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_eq_conv_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-mulex1_singleton"><span class="command">lemma</span></span> mulex1_singleton <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult1_singleton <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mulex1_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-singleton_mulex_onI"><span class="command">lemma</span></span> singleton_mulex_onI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">{#</span><span class="free">x</span><span class="main">#}</span> <span class="main">{#</span><span class="free">y</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-reflclp_mulex_on_add_right"><span class="command">lemma</span></span> reflclp_mulex_on_add_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Multiset_Extension-reflclp_mulex_on_add_right'"><span class="command">lemma</span></span> reflclp_mulex_on_add_right' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="main">(</span><span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reflclp_mulex_on_add_right <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_union_right"><span class="command">lemma</span></span> mulex_on_union_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> multisets <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">a</span> <span class="skolem">K</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="skolem">K</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_union_right'"><span class="command">lemma</span></span> mulex_on_union_right' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> multisets <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mulex_on_union_right <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Adapted from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> all_accessible<span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> "<a href="../../HOL/HOL-Library/Multiset.html"></a><a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Multiset_Extension-accessible_on_mulex1_multisets"><span class="command">lemma</span></span> accessible_on_mulex1_multisets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wfp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">∈</span>multisets <span class="free">A</span><span class="main">.</span> accessible_on <span class="main">(</span>mulex1 <span class="free">P</span><span class="main">)</span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span> <span class="bound">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?acc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"accessible_on <span class="var">?P</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">M0</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> M0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="skolem">M0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M0</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wf_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">b</span> <span class="skolem">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="var">?acc</span> <span class="main">(</span><span class="bound">M</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span><span class="bound">M</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">b</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> acc_hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">M</span> <span class="skolem">M0</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span><span class="bound">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">a</span> <span class="skolem">M0</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span>add_mset <span class="skolem">a</span> <span class="skolem">M0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> accessible_onI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"add_mset <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">M0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">N</span> <span class="main">(</span>add_mset <span class="skolem">a</span> <span class="skolem">M0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">M</span><span class="main">.</span> <span class="bound">M</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">M</span> <span class="skolem">M0</span> <span class="main">∧</span> <span class="skolem">N</span> <span class="main">=</span> <span class="bound">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">K</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="bound">K</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">b</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="bound">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mulex1_add <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">N</span></span> <span class="quoted"><span class="skolem">M0</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">N</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE disjE conjE<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">M</span> <span class="skolem">M0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> acc_hyp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∧</span> <span class="var">?P</span> <span class="skolem">M</span> <span class="skolem">M0</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">∈</span> <span class="var">?A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">M</span> <span class="skolem">M0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> N<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">K</span>
        <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">b</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> N <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">N</span> <span class="main">∈</span> <span class="var">?A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">K</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> empty
          <span class="keyword1"><span class="command">from</span></span> M0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">K</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> add.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> wf_hyp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="var">?acc</span> <span class="bound">M</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span><span class="bound">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> add <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span><span class="skolem">M0</span> <span class="main">+</span> <span class="main">(</span>add_mset <span class="skolem">x</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> N<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> tedious_reasoning <span class="main">=</span> this

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="skolem">M</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> accessible_onI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">b</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">a</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> add <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="var">?acc</span> <span class="bound">M</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span>add_mset <span class="skolem">a</span> <span class="bound">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">b</span> <span class="skolem">a</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="var">?acc</span> <span class="bound">M</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span><span class="bound">M</span> <span class="main">+</span> <span class="main">{#</span><span class="bound">b</span><span class="main">#}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="var">?acc</span> <span class="bound">M</span> <span class="main">⟶</span> <span class="var">?acc</span> <span class="main">(</span>add_mset <span class="skolem">a</span> <span class="bound">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="skolem">M'</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> accessible_on_imp_mem<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span>add_mset <span class="skolem">a</span> <span class="skolem">M'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> tedious_reasoning <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> _ r<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?acc</span> <span class="main">(</span><span class="skolem">M</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?acc</span> <span class="main">(</span>add_mset <span class="skolem">a</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> wfp_on_mulex1_multisets <span class="main">=</span>
  accessible_on_mulex1_multisets <span class="main">[</span><span class="operator">THEN</span> accessible_on_imp_wfp_on<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> irreflp_on_mulex1 <span class="main">=</span>
  wfp_on_mulex1_multisets <span class="main">[</span><span class="operator">THEN</span> wfp_on_imp_irreflp_on<span class="main">]</span>

<span class="keyword1" id="Multiset_Extension-wfp_on_mulex_on_multisets"><span class="command">lemma</span></span> wfp_on_mulex_on_multisets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wfp_on <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wfp_on_mulex1_multisets <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mulex_on_def wfp_on_restrict_to_tranclp_wfp_on_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> irreflp_on_mulex_on <span class="main">=</span>
  wfp_on_mulex_on_multisets <span class="main">[</span><span class="operator">THEN</span> wfp_on_imp_irreflp_on<span class="main">]</span>

<span class="keyword1" id="Multiset_Extension-mulex1_union"><span class="command">lemma</span></span> mulex1_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">M</span> <span class="free">N</span> <span class="main">⟹</span> mulex1 <span class="free">P</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex1_def mult1_union<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_union"><span class="command">lemma</span></span> mulex_on_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mulex1_union<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> base <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict_to <span class="main">(</span>mulex1 <span class="free">P</span><span class="main">)</span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">L</span> <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mulex1_union<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> step <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict_to <span class="main">(</span>mulex1 <span class="free">P</span><span class="main">)</span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">L</span><span class="main">)</span> <span class="main">(</span><span class="free">K</span> <span class="main">+</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-mulex_on_union'"><span class="command">lemma</span></span> mulex_on_union'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">K</span><span class="main">)</span> <span class="main">(</span><span class="free">N</span> <span class="main">+</span> <span class="free">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mulex_on_union <span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_add_mset"><span class="command">lemma</span></span> mulex_on_add_mset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span>add_mset <span class="free">m</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">m</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mulex_on_union'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension-union_mulex_on_mono"><span class="command">lemma</span></span> union_mulex_on_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="free">C</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">B</span> <span class="free">D</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mulex_on_multisetsD mulex_on_trans mulex_on_union mulex_on_union'<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_add_mset'"><span class="command">lemma</span></span> mulex_on_add_mset'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span>add_mset <span class="free">m</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">n</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> mulex_on_union<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_add_mset_mono"><span class="command">lemma</span></span> mulex_on_add_mset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span>add_mset <span class="free">m</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>add_mset <span class="free">n</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">M</span></span><span class="main">]</span> add_mset_add_single<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> union_mulex_on_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-union_mulex_on_mono1"><span class="command">lemma</span></span> union_mulex_on_mono1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> multisets <span class="free">F</span> <span class="main">⟹</span> <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">F</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free">A</span> <span class="free">C</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">B</span> <span class="free">D</span> <span class="main">⟹</span>
    mulex_on <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> union_mulex_on_mono mulex_on_union<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-union_mulex_on_mono2"><span class="command">lemma</span></span> union_mulex_on_mono2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">∈</span> multisets <span class="free">F</span> <span class="main">⟹</span> mulex_on <span class="free">P</span> <span class="free">F</span> <span class="free">A</span> <span class="free">C</span> <span class="main">⟹</span> <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">F</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="free">B</span> <span class="free">D</span> <span class="main">⟹</span>
    mulex_on <span class="free">P</span> <span class="free">F</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">+</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> union_mulex_on_mono mulex_on_union'<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mult1_mono"><span class="command">lemma</span></span> mult1_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult1_def multisets_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> subsetD<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex1_mono"><span class="command">lemma</span></span> mulex1_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">Q</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult1_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">]</span>
    <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mulex1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_mono"><span class="command">lemma</span></span> mulex_on_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">Q</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rel</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>restrict_to <span class="main">(</span>mulex1 <span class="bound">P</span><span class="main">)</span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?rel</span> <span class="free">P</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?rel</span> <span class="free">Q</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> tranclp.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>r_into_trancl <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mulex1_mono <span class="main">[</span><span class="operator">OF</span> * this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> r_into_trancl
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trancl_into_trancl <span class="skolem">L</span> <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> mulex1_mono <span class="main">[</span><span class="operator">OF</span> * this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> trancl_into_trancl
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rel</span> <span class="free">Q</span> <span class="skolem">M</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="var">?rel</span> <span class="free">Q</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>+</sup><span class="hidden">⇧</span><sup>+</sup></span> <span class="skolem">L</span> <span class="skolem">M</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tranclp.trancl_into_trancl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-mult1_reflcl"><span class="command">lemma</span></span> mult1_reflcl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult1 <span class="main">(</span><span class="free">R</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mult1_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex1_reflclp"><span class="command">lemma</span></span> mulex1_reflclp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="main">(</span><span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span><span class="main">)</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mulex1_mono <span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ _ assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_reflclp"><span class="command">lemma</span></span> mulex_on_reflclp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="main">(</span><span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span><span class="main">)</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mulex_on_mono <span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                  

<span class="keyword1" id="Multiset_Extension-surj_on_multisets_mset"><span class="command">lemma</span></span> surj_on_multisets_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">M</span><span class="main">∈</span>multisets <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">∈</span>lists <span class="free">A</span><span class="main">.</span> <span class="bound">M</span> <span class="main">=</span> mset <span class="bound">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">∈</span>lists <span class="free">A</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">=</span> mset <span class="bound">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">a</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mset <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">a</span> <span class="skolem">M</span> <span class="main">=</span> mset <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Multiset_Extension-image_mset_lists"><span class="command">lemma</span></span> image_mset_lists <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mset <span class="main">`</span> lists <span class="free">A</span> <span class="main">=</span> multisets <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> surj_on_multisets_mset <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> mem_Collect_eq multisets_def set_mset_mset subsetI<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-multisets_UNIV"><span class="command">lemma</span></span> multisets_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"multisets UNIV <span class="main">=</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_mset_lists lists_UNIV surj_mset<span class="main">)</span>

<span class="keyword1" id="Multiset_Extension-non_empty_multiset_induct"><span class="command">lemma</span></span> non_empty_multiset_induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> singleton add<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">{#</span><span class="bound">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">M</span><span class="main">.</span> <span class="free">P</span> <span class="bound">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>add_mset <span class="bound">x</span> <span class="bound">M</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Multiset_Extension-mulex_on_all_strict"><span class="command">lemma</span></span> mulex_on_all_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="free">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">Y</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> non_empty_multiset_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>singleton <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="skolem">Y</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mulex1_def mult1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> singleton <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">x</span> <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">M</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span> <span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">-</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="var">?Z</span> <span class="main">+</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> multiset_eq_iff<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> multisets <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multiset_partition union_multisets_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">M</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="var">?Y</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="var">?Z</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="var">?Z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?Z</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">y</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> add.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_diff_count <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="var">?Z</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mulex1_def mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> multisets <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_union_cancelL multiset_partition union_multisetsD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex_on_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="main">(</span><span class="var">?Y</span> <span class="main">+</span> <span class="var">?Z</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">x</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> union_mulex_on_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma shows that the textbook definition (e.g.,
``Term Rewriting and All That'') is the same as the one used below.›</span></span>
<span class="keyword1" id="Multiset_Extension-diff_set_Ex_iff"><span class="command">lemma</span></span> diff_set_Ex_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">⊆#</span> <span class="free">M</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="main">-</span> <span class="free">X</span><span class="main">)</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Z</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> <span class="bound">Z</span> <span class="main">+</span> <span class="free">X</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">Z</span> <span class="main">+</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_left' multiset_diff_union_assoc union_commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mulex_on<span class="antiquote"><span class="antiquote">}</span></span></span></span> is equivalent to the textbook definition
of multiset-extension for transitive base orders.›</span></span>
<span class="keyword1" id="Multiset_Extension-mulex_on_alt_def"><span class="command">lemma</span></span> mulex_on_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"transp_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="free">M</span> <span class="free">N</span> <span class="main">⟷</span> <span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span> <span class="bound">Z</span><span class="main">.</span>
    <span class="bound">X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">Z</span> <span class="main">+</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="bound">Z</span> <span class="main">+</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="bound">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="bound">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">M</span> <span class="free">N</span> <span class="main">⟷</span> <span class="var">?Q</span> <span class="free">M</span> <span class="free">N</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>base <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">b</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mulex1_def mult1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">L</span> <span class="skolem">M</span> <span class="skolem">N</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">Z</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mulex1 <span class="free">P</span> <span class="skolem">M</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹mulex1 <span class="free">P</span> <span class="skolem">M</span> <span class="skolem">N</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">M0</span></span> <span class="skolem"><span class="skolem">K</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> add_mset <span class="skolem">a</span> <span class="skolem">M0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M0</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">b</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mulex1_def mult1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L M<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The remainder of the proof is adapted from the proof of Lemma 2.5.4. of
    the book ``Term Rewriting and All That.''›</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"add_mset <span class="skolem">a</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">Z</span><span class="main">.</span> <span class="skolem">N</span> <span class="main">=</span> <span class="bound">Z</span> <span class="main">+</span> <span class="var">?X</span> <span class="main">∧</span> <span class="skolem">L</span> <span class="main">=</span> <span class="bound">Z</span> <span class="main">+</span> <span class="var">?Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊆#</span> <span class="skolem">N</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M N M' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> Multiset.diff_subset_eq_self add.commute add_diff_cancel_right<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="var">?X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?Y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">M</span><span class="main">.</span> count <span class="bound">M</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ic</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> int <span class="main">(</span><span class="var">?c</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="main">⊆#</span> <span class="skolem">N</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?c</span> <span class="skolem">N</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subseteq_mset_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?c</span> <span class="skolem">M0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ic</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="var">?X</span> <span class="main">+</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">=</span> int <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?c</span> <span class="var">?X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> int <span class="main">(</span><span class="var">?c</span> <span class="skolem">N</span> <span class="main">-</span> <span class="main">(</span><span class="var">?c</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?ic</span> <span class="skolem">N</span> <span class="main">-</span> <span class="main">(</span><span class="var">?ic</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span> <span class="main">+</span> <span class="var">?ic</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="skolem">Y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> of_nat_diff <span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ic</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?ic</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">-</span> <span class="var">?ic</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ic</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?ic</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?ic</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">-</span> <span class="var">?ic</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ic</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?ic</span> <span class="main">{#</span><span class="skolem">a</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="var">?ic</span> <span class="skolem">K</span> <span class="main">-</span> <span class="var">?ic</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ic</span> <span class="skolem">N</span> <span class="main">-</span> <span class="var">?ic</span> <span class="var">?X</span><span class="main">)</span> <span class="main">+</span> <span class="var">?ic</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?ic</span> <span class="skolem">L</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> L' M' N
          <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="skolem">L</span> <span class="main">=</span> <span class="var">?c</span> <span class="main">(</span><span class="skolem">N</span> <span class="main">-</span> <span class="var">?X</span> <span class="main">+</span> <span class="var">?Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_set_Ex_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="var">?Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="var">?X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="var">?Y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="var">?X</span> <span class="main">∧</span> <span class="free">P</span> <span class="skolem">y</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">K</span> <span class="main">-</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_diffD<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> Y <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> multisets <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈#</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">N</span> <span class="main">∈</span> multisets <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">∈</span> multisets <span class="free">A</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">K</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M' multisets_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> trans <span class="keyword1"><span class="command">unfolding</span></span> transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">-</span> <span class="skolem">K</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_diff_count not_in_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="free">M</span> <span class="free">N</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="skolem">Y</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="skolem">X</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> mulex_on_all_strict <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mulex_on <span class="free">P</span> <span class="free">A</span> <span class="skolem">Y</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">N</span> <span class="main">∈</span> multisets <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∈</span> multisets <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> N<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">M</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> M N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mulex_on_union<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Wqo_Multiset">
<div class="head">
<h1>Theory Wqo_Multiset</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:      Well-Quasi-Orders
    Author:     Christian Sternagel &lt;c.sternagel@gmail.com&gt;
    Maintainer: Christian Sternagel
    License:    LGPL
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Multiset Extension Preserves Well-Quasi-Orders›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Wqo_Multiset
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Multiset_Extension.html">Multiset_Extension</a>
  <a href="Well_Quasi_Orders.html">Well_Quasi_Orders</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Wqo_Multiset-list_emb_imp_reflclp_mulex_on"><span class="command">lemma</span></span> list_emb_imp_reflclp_mulex_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_emb <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span> 1<span class="main">,</span> 2<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb_Nil <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> empty_mulex_on <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb_Cons <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mulex_on_self_add_singleton_right <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>list_emb_Cons2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> union_mulex_on_mono mulex_on_add_mset
             mulex_on_add_mset' mulex_on_add_mset_mono
             <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multisets_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The (reflexive closure of the) multiset extension of an almost-full relation
is almost-full.›</span></span>
<span class="keyword1" id="Wqo_Multiset-almost_full_on_multisets"><span class="command">lemma</span></span> almost_full_on_multisets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> almost_full_on_hom <span class="main">[</span><span class="operator">OF</span> _ almost_full_on_lists<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">P</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted">mset</span><span class="main">,</span>
    <span class="operator">OF</span> list_emb_imp_reflclp_mulex_on<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Wqo_Multiset-wqo_on_multisets"><span class="command">lemma</span></span> wqo_on_multisets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="free">P</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wqo_on <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> transp_on_mulex_on <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"multisets <span class="free">A</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp_on <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> transp_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> almost_full_on_multisets <span class="main">[</span><span class="operator">OF</span> assms <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> wqo_on_imp_almost_full_on<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"almost_full_on <span class="main">(</span>mulex_on <span class="free">P</span> <span class="free">A</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup><span class="hidden">⇧</span><sup>=</sup></span> <span class="main">(</span>multisets <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>