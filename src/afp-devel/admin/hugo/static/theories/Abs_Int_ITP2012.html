<div id="Complete_Lattice_ix">
<div class="head">
<h1>Theory Complete_Lattice_ix</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Complete Lattice (indexed)"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Complete_Lattice_ix
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A complete lattice is an ordered type where every set of elements has
a greatest lower (and thus also a leats upper) bound. Sets are the
prototypical complete lattice where the greatest lower bound is
intersection. Sometimes that set of all elements of a type is not a complete
lattice although all elements of the same shape form a complete lattice, for
example lists of the same length, where the list elements come from a
complete lattice. We will have exactly this situation with annotated
commands. This theory introduces a slightly generalised version of complete
lattices where elements have an ``index'' and only the set of elements with
the same index form a complete lattice; the type as a whole is a disjoint
union of complete lattices. Because sets are not types, this requires a
special treatment.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Complete_Lattice_ix <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">L</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>order set"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">Glb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> Glb_lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">L</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Glb</span> <span class="free">i</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Glb_greatest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">:</span> <span class="free">L</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">b</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">(</span><span class="free">Glb</span> <span class="free">i</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> Glb_in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">L</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">Glb</span> <span class="free">i</span> <span class="free">A</span> <span class="main">:</span> <span class="free">L</span> <span class="free">i</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lfp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'i</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lfp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free">Glb</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">:</span> <span class="free">L</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">a</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> index_lfp<span class="main">:</span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="free">i</span> <span class="main">:</span> <span class="free">L</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lfp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Glb_in_L<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lfp_lowerbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">:</span> <span class="free">L</span> <span class="free">i</span><span class="main">;</span>  <span class="free">f</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> lfp <span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Glb_lower<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lfp_greatest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">:</span> <span class="free">L</span> <span class="free">i</span><span class="main">;</span>  <span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">u</span> <span class="main">:</span> <span class="free">L</span> <span class="free">i</span><span class="main">;</span> <span class="free">f</span> <span class="bound">u</span> <span class="main">≤</span> <span class="bound">u</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">u</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> lfp <span class="free">f</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Glb_greatest<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lfp_unfold<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">:</span> <span class="free">L</span> <span class="bound">i</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">:</span> <span class="free">L</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>lfp <span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span> index_lfp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>lfp <span class="free">f</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> lfp <span class="free">f</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lfp_greatest<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lfp_lowerbound monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono<span class="main"><span class="main">]</span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="free">f</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span>lfp <span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 1 monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono<span class="main"><span class="main">]</span></span> lfp_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="ACom">
<div class="head">
<h1>Theory ACom</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Annotated Commands"</span></span>

<span class="keyword1"><span class="command">theory</span></span> ACom
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-IMP/Com.html">HOL-IMP.Com</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> acom <span class="main">=</span>
  SKIP <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>                           <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">SKIP</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">{</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 61<span class="main">)</span> <span class="main">|</span>
  Assign <span class="quoted">vname</span> <span class="quoted">aexp</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>              <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">::=</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">{</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>1000<span class="main">,</span> 61<span class="main">,</span> 0<span class="main">]</span> 61<span class="main">)</span> <span class="main">|</span>
  Seq <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom<span class="main">)</span>"</span></span>       <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">;;</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">//</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_"</span>  <span class="main">[</span>60<span class="main">,</span> 61<span class="main">]</span> 60<span class="main">)</span> <span class="main">|</span>
  If <span class="quoted">bexp</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom<span class="main">)</span>"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">IF</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">ELSE</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">//</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">{</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">,</span> 0<span class="main">]</span> 61<span class="main">)</span> <span class="main">|</span>
  While <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted">bexp</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom<span class="main">)</span>"</span></span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="main">(</span><span class="quoted">"<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">{</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">//</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">WHILE</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">/ </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">DO</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">//</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">{</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3"><span class="keyword3">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span>  <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 61<span class="main">,</span> 0<span class="main">]</span> 61<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">post</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">post</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">post</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">strip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> com"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">strip</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> com.SKIP"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">strip</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">strip</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">strip</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">strip</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">strip</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">strip</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">anno</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> com <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> com.SKIP <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">anno</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">annos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">annos</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">annos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::=</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">annos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">C2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">annos</span> <span class="free"><span class="bound"><span class="entity">C1</span></span></span> <span class="main">@</span> <span class="free">annos</span> <span class="free"><span class="bound"><span class="entity">C2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">annos</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">C1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">C2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span>  <span class="free">annos</span> <span class="free"><span class="bound"><span class="entity">C1</span></span></span> <span class="main">@</span> <span class="free">annos</span> <span class="free"><span class="bound"><span class="entity">C2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">annos</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">annos</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_acom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'b</span> acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">map_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> post_map_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"post<span class="main">(</span>map_acom <span class="free">f</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span>post <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>map_acom <span class="free">f</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_acom_SKIP<span class="main">:</span>
 <span class="quoted"><span class="quoted">"map_acom <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="free">S'</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="bound">S</span><span class="main">}</span> <span class="main">∧</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_acom_Assign<span class="main">:</span>
 <span class="quoted"><span class="quoted">"map_acom <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">::=</span> <span class="free">e</span> <span class="main">{</span><span class="free">S'</span><span class="main">}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span><span class="main">::=</span><span class="free">e</span> <span class="main">{</span><span class="bound">S</span><span class="main">}</span> <span class="main">∧</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_acom_Seq<span class="main">:</span>
 <span class="quoted"><span class="quoted">"map_acom <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c1'</span><span class="main">;;</span><span class="free">c2'</span> <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">c1</span><span class="main">;;</span><span class="bound">c2</span> <span class="main">∧</span> map_acom <span class="free">f</span> <span class="bound">c1</span> <span class="main">=</span> <span class="free">c1'</span> <span class="main">∧</span> map_acom <span class="free">f</span> <span class="bound">c2</span> <span class="main">=</span> <span class="free">c2'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_acom_If<span class="main">:</span>
 <span class="quoted"><span class="quoted">"map_acom <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1'</span> <span class="keyword1">ELSE</span> <span class="free">c2'</span> <span class="main">{</span><span class="free">S'</span><span class="main">}</span> <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">S</span> <span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="bound">c1</span> <span class="keyword1">ELSE</span> <span class="bound">c2</span> <span class="main">{</span><span class="bound">S</span><span class="main">}</span> <span class="main">∧</span> map_acom <span class="free">f</span> <span class="bound">c1</span> <span class="main">=</span> <span class="free">c1'</span> <span class="main">∧</span> map_acom <span class="free">f</span> <span class="bound">c2</span> <span class="main">=</span> <span class="free">c2'</span> <span class="main">∧</span> <span class="free">S'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_acom_While<span class="main">:</span>
 <span class="quoted"><span class="quoted">"map_acom <span class="free">f</span> <span class="free">w</span> <span class="main">=</span> <span class="main">{</span><span class="free">I'</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c'</span> <span class="main">{</span><span class="free">P'</span><span class="main">}</span> <span class="main">⟷</span>
 <span class="main">(</span><span class="main">∃</span><span class="bound">I</span> <span class="bound">P</span> <span class="bound">c</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="main">{</span><span class="bound">I</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="bound">c</span> <span class="main">{</span><span class="bound">P</span><span class="main">}</span> <span class="main">∧</span> map_acom <span class="free">f</span> <span class="bound">c</span> <span class="main">=</span> <span class="free">c'</span> <span class="main">∧</span> <span class="free">I'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">I</span> <span class="main">∧</span> <span class="free">P'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> strip_anno<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>anno <span class="free">a</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_eq_SKIP<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> com.SKIP <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="bound">P</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_eq_Assign<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> <span class="free">x</span><span class="main">::=</span><span class="free">e</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span><span class="main">::=</span><span class="free">e</span> <span class="main">{</span><span class="bound">P</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_eq_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> <span class="free">c1</span><span class="main">;;</span><span class="free">c2</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">d1</span> <span class="bound">d2</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">d1</span><span class="main">;;</span><span class="bound">d2</span> <span class="main">&amp;</span> strip <span class="bound">d1</span> <span class="main">=</span> <span class="free">c1</span> <span class="main">&amp;</span> strip <span class="bound">d2</span> <span class="main">=</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_eq_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">d1</span> <span class="bound">d2</span> <span class="bound">P</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="bound">d1</span> <span class="keyword1">ELSE</span> <span class="bound">d2</span> <span class="main">{</span><span class="bound">P</span><span class="main">}</span> <span class="main">&amp;</span> strip <span class="bound">d1</span> <span class="main">=</span> <span class="free">c1</span> <span class="main">&amp;</span> strip <span class="bound">d2</span> <span class="main">=</span> <span class="free">c2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_eq_While<span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c1</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">I</span> <span class="bound">d1</span> <span class="bound">P</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="main">{</span><span class="bound">I</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="bound">d1</span> <span class="main">{</span><span class="bound">P</span><span class="main">}</span> <span class="main">&amp;</span> strip <span class="bound">d1</span> <span class="main">=</span> <span class="free">c1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">lemma</span></span> set_annos_anno<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>annos <span class="main">(</span>anno <span class="free">a</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_annos_same<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">C1</span> <span class="main">=</span> strip <span class="free">C2</span> <span class="main">⟹</span> size<span class="main">(</span>annos <span class="free">C1</span><span class="main">)</span> <span class="main">=</span> size<span class="main">(</span>annos <span class="free">C2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">C2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C1</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_eq_SKIP strip_eq_Assign strip_eq_Seq strip_eq_If strip_eq_While<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> size_annos_same2 <span class="main">=</span> eqTrueI<span class="main">[</span><span class="operator">OF</span> size_annos_same<span class="main">]</span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Collecting">
<div class="head">
<h1>Theory Collecting</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Collecting Semantics of Commands"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Collecting
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Complete_Lattice_ix.html">Complete_Lattice_ix</a> <a href="ACom.html">ACom</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Annotated commands as a complete lattice"</span></span>

<span class="comment1">(* Orderings could also be lifted generically (thus subsuming the
instantiation for preord and order), but then less_eq_acom would need to
become a definition, eg less_eq_acom = lift2 less_eq, and then proofs would
need to unfold this defn first. *)</span>

<span class="keyword1"><span class="command">instantiation</span></span> acom <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">order</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">less_eq_acom</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span>acom <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1'</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv'</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Inv</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Inv'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">less_eq_acom</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> SKIP_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SKIP</span> <span class="main">{</span><span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="bound">S'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">≤</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Assign_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">::=</span> <span class="free">e</span> <span class="main">{</span><span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">::=</span> <span class="free">e</span> <span class="main">{</span><span class="bound">S'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">≤</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Seq_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span><span class="main">;;</span><span class="free">c2</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c1'</span> <span class="bound">c2'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">c1'</span><span class="main">;;</span><span class="bound">c2'</span> <span class="main">∧</span> <span class="free">c1</span> <span class="main">≤</span> <span class="bound">c1'</span> <span class="main">∧</span> <span class="free">c2</span> <span class="main">≤</span> <span class="bound">c2'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> If_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="main">{</span><span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">c1'</span> <span class="bound">c2'</span> <span class="bound">S'</span><span class="main">.</span> <span class="free">c</span><span class="main">=</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="bound">c1'</span> <span class="keyword1">ELSE</span> <span class="bound">c2'</span> <span class="main">{</span><span class="bound">S'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">c1</span> <span class="main">≤</span> <span class="bound">c1'</span> <span class="main">∧</span> <span class="free">c2</span> <span class="main">≤</span> <span class="bound">c2'</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">≤</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> While_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Inv</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">Inv'</span> <span class="bound">c'</span> <span class="bound">P'</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="main">{</span><span class="bound">Inv'</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="bound">c'</span> <span class="main">{</span><span class="bound">P'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">≤</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">Inv</span> <span class="main">≤</span> <span class="bound">Inv'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">≤</span> <span class="bound">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_acom</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">less_acom</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_acom_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_acom.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SKIP_le Assign_le Seq_le If_le While_le<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_acom.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sub<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sub<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sub<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sub<span class="hidden">⇩</span><sub>1</sub></span><span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sub<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sub<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">sub<span class="hidden">⇩</span><sub>2</sub></span><span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invar</span><span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> com <span class="main">⇒</span> <span class="tfree">'a</span> acom set <span class="main">⇒</span> <span class="tfree">'b</span> acom"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> com.SKIP <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>post <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>post <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span>
  <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">(</span>sub<span class="hidden">⇩</span><sub>1</sub> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">;;</span> <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">(</span>sub<span class="hidden">⇩</span><sub>2</sub> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span>
  <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">(</span>sub<span class="hidden">⇩</span><sub>1</sub> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">(</span>sub<span class="hidden">⇩</span><sub>2</sub> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
  <span class="main">{</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>post <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span>
 <span class="main">{</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>invar <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">}</span>
 <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">lift</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>sub<span class="hidden">⇩</span><sub>1</sub> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>
 <span class="main">{</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span>post <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Complete_Lattice_ix <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">c</span><span class="main">.</span> <span class="main">{</span><span class="bound">c'</span><span class="main">.</span> strip <span class="bound">c'</span> <span class="main">=</span> <span class="bound">c</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"lift Inter"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">A</span> _ <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">:</span><span class="skolem">A</span> <span class="main">⟹</span> lift Inter <span class="main">(</span>strip <span class="skolem">a</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Seq <span class="keyword1"><span class="command">from</span></span> Seq.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Seq.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> If <span class="keyword1"><span class="command">from</span></span> If.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> If.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> While <span class="keyword1"><span class="command">from</span></span> While.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> While.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">b</span> <span class="skolem">i</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> SKIP <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>SKIP_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Assign <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Assign_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Seq <span class="keyword1"><span class="command">from</span></span> Seq.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Seq.IH <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Seq_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> If <span class="keyword1"><span class="command">from</span></span> If.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> If_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> If.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> While <span class="keyword1"><span class="command">from</span></span> While.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> While_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> While.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>lift Inter <span class="skolem">i</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Seq <span class="keyword1"><span class="command">from</span></span> Seq.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_eq_Seq subset_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Seq.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> If <span class="keyword1"><span class="command">from</span></span> If.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> If.IH <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_eq_If<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> While <span class="keyword1"><span class="command">from</span></span> While.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> While.IH <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> strip_eq_While<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span> post <span class="free">c</span> <span class="main">≤</span> post <span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_acom.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Collecting semantics"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"state set <span class="main">⇒</span> state set acom <span class="main">⇒</span> state set acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="bound">s'</span> <span class="main">=</span> <span class="bound">s</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> aval <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">step</span> <span class="main">(</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
   <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">step</span> <span class="main">{</span><span class="bound"><span class="bound">s</span></span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">step</span> <span class="main">{</span><span class="bound"><span class="bound">s</span></span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">¬</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
   <span class="main">{</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">∪</span> post <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∪</span> post <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="main">(</span><span class="free">step</span> <span class="main">{</span><span class="bound"><span class="bound">s</span></span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">.</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">{</span><span class="main">{</span><span class="bound"><span class="bound">s</span></span><span class="main">:</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">.</span> <span class="main">¬</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> state set acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">CS</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono2_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">≤</span> <span class="free">c2</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">⊆</span> <span class="free">S2</span> <span class="main">⟹</span> step <span class="free">S1</span> <span class="free">c1</span> <span class="main">≤</span> step <span class="free">S2</span> <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_eq_acom.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_post<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span><span class="main">(</span><span class="operator">metis</span> le_post subsetD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> le_post subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_step<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>step <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monoI mono2_step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_step<span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>step <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lfp_cs_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step <span class="free">S</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> step <span class="free">S</span> <span class="main">(</span>lfp <span class="main">(</span>step <span class="free">S</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _  mono_step<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_step<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> CS_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"CS <span class="free">c</span> <span class="main">=</span> step UNIV <span class="main">(</span>CS <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> CS_def lfp_cs_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_CS<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>CS <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CS_def index_lfp<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_Int0">
<div class="head">
<h1>Theory Abs_Int0</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Abstract Interpretation Abstractly"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int0
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
  <a href="Collecting.html">Collecting</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Orderings"</span></span>

<span class="keyword1"><span class="command">class</span></span> preord <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">le</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">⊑</span></span></span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> le_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">⊑</span></span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> le_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">⊑</span></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main"><span class="free">⊑</span></span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main"><span class="free">⊑</span></span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mono</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mono</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> monoD<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span> <span class="main">⟹</span> mono <span class="free">g</span> <span class="main">⟹</span> mono <span class="main">(</span><span class="free">g</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> le_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Note: no antisymmetry. Allows implementations where some abstract
element is implemented by two different values <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≠</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⊑</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">y</span></span> <span class="main"><span class="main">⊑</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Antisymmetry is not
needed because we never compare elements for equality but only for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊑›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> SL_top <span class="main">=</span> preord <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">join</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">⊔</span></span></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">Top</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">⊤</span></span></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> join_ge1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main"><span class="free">⊔</span></span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> join_ge2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main"><span class="free">⊔</span></span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> join_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main"><span class="free">⊔</span></span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="main"><span class="free">⊤</span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_le_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join_ge1 join_ge2 join_least le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_join_disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join_ge1 join_ge2 le_trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">SL_top</span><span class="main">)</span> <span class="quoted">SL_top</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊤</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_apply<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">⊔</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_fun_def preord_class.le_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def Top_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> acom <span class="main">::</span> <span class="main">(</span><span class="quoted">preord</span><span class="main">)</span> <span class="quoted">preord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">le_acom</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preord<span class="main">)</span>acom <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">le_acom</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">le_acom</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">le_acom</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1'</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">le_acom</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="main">∧</span> <span class="free">le_acom</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">le_acom</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="main">∧</span> <span class="free">le_acom</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="main">∧</span> <span class="free">le_acom</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">le_acom</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv'</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="main">∧</span> <span class="free">le_acom</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Inv</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">Inv'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">le_acom</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SKIP</span> <span class="main">{</span><span class="free">S</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">SKIP</span> <span class="main">{</span><span class="bound">S'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">⊑</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">::=</span> <span class="free">e</span> <span class="main">{</span><span class="free">S</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">S'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="free">x</span> <span class="main">::=</span> <span class="free">e</span> <span class="main">{</span><span class="bound">S'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">⊑</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span><span class="main">;;</span><span class="free">c2</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">c1'</span> <span class="bound">c2'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="bound">c1'</span><span class="main">;;</span><span class="bound">c2'</span> <span class="main">∧</span> <span class="free">c1</span> <span class="main">⊑</span> <span class="bound">c1'</span> <span class="main">∧</span> <span class="free">c2</span> <span class="main">⊑</span> <span class="bound">c2'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span> <span class="main">{</span><span class="free">S</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">c1'</span> <span class="bound">c2'</span> <span class="bound">S'</span><span class="main">.</span> <span class="free">c</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="bound">c1'</span> <span class="keyword1">ELSE</span> <span class="bound">c2'</span> <span class="main">{</span><span class="bound">S'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">c1</span> <span class="main">⊑</span> <span class="bound">c1'</span> <span class="main">∧</span> <span class="free">c2</span> <span class="main">⊑</span> <span class="bound">c2'</span> <span class="main">∧</span> <span class="free">S</span> <span class="main">⊑</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">Inv</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span> <span class="main">{</span><span class="free">P</span><span class="main">}</span> <span class="main">⊑</span> <span class="free">w</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">Inv'</span> <span class="bound">c'</span> <span class="bound">P'</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> <span class="main">{</span><span class="bound">Inv'</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="bound">c'</span> <span class="main">{</span><span class="bound">P'</span><span class="main">}</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">⊑</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">Inv</span> <span class="main">⊑</span> <span class="bound">Inv'</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">⊑</span> <span class="bound">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Lifting"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">preord</span><span class="main">)</span><span class="quoted">preord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">le_option</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊑</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"None <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"Some <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⊑</span> None <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊑</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free">x</span> <span class="main">⊑</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">&amp;</span> <span class="free">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">SL_top</span><span class="main">)</span><span class="quoted">SL_top</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">join_option</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"None <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> None <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_None2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> None <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> Some <span class="main">⊤</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span><span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_option_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bot_acom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>SL_top<span class="main">)</span>option acom"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">⊥<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="main">=</span> anno None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip_bot_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_acom_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bot_acom<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟶</span> <span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_acom_def<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">c'</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">c'</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">c'</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">c'</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">c'</span></span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Post-fixed point iteration"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pfp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>preord<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pfp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> while_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pfp_pfp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pfp <span class="free">f</span> <span class="free">x0</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> while_option_stop<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> pfp_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pfp_least<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pfp <span class="free">f</span> <span class="free">x0</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">p</span> <span class="main">⊑</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-<span class="main">)</span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pfp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
 <span class="entity">lpfp<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>SL_top<span class="main">)</span>option acom <span class="main">⇒</span> <span class="tfree">'a</span> option acom<span class="main">)</span> <span class="main">⇒</span> com <span class="main">⇒</span> <span class="tfree">'a</span> option acom option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">lpfp<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> pfp <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lpfpc_pfp<span class="main">:</span> <span class="quoted"><span class="quoted">"lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="free">f</span> <span class="free">c0</span> <span class="main">=</span> Some <span class="free">c</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pfp_pfp lpfp<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_pfp<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pfp <span class="free">f</span> <span class="free">x0</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x0</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">unfolding</span></span> pfp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_lpfpc<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> strip<span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strip <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> strip_pfp<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span> lpfp<span class="hidden">⇩</span><sub>c</sub>_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> strip_bot_acom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lpfpc_least<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"strip <span class="free">p</span> <span class="main">=</span> <span class="free">c0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">p</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lp<span class="main">:</span> <span class="quoted"><span class="quoted">"lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="free">f</span> <span class="free">c0</span> <span class="main">=</span> Some <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> pfp_least<span class="main">[</span><span class="operator">OF</span> _ _ bot_acom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹strip <span class="free">p</span> <span class="main">=</span> <span class="free">c0</span>›</span></span><span class="main"><span class="main">]</span></span> lp<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> lpfp<span class="hidden">⇩</span><sub>c</sub>_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  mono <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">p</span> <span class="main">⊑</span> <span class="free">p</span>›</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Abstract Interpretation"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">γ_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">γ_fun</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">γ_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">γ_option</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> None <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">γ_option</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The interface for abstract values:›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Val_abs <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>SL_top <span class="main">⇒</span> val set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono_gamma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">γ</span> <span class="free">a</span> <span class="main">⊆</span> <span class="free">γ</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> gamma_Top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">⊤</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">num'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> <span class="tfree">'av</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">plus'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gamma_num'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">:</span> <span class="free">γ</span><span class="main">(</span><span class="free">num'</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> gamma_plus'<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a1</span> <span class="main">⟹</span> <span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a2</span> <span class="main">⟹</span> <span class="free">n1</span><span class="main">+</span><span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span><span class="main">(</span><span class="free">plus'</span> <span class="free">a1</span> <span class="free">a2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'av</span> st <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vname <span class="main">⇒</span> <span class="tfree">'av</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abs_Int_Fun <span class="main">=</span> Val_abs <span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>SL_top <span class="main">⇒</span> val set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aval'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> <span class="tfree">'av</span> st <span class="main">⇒</span> <span class="tfree">'av</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">aval'</span> <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free">num'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">aval'</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">aval'</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free">plus'</span> <span class="main">(</span><span class="free">aval'</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">aval'</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option <span class="main">⇒</span> <span class="tfree">'av</span> st option acom <span class="main">⇒</span> <span class="tfree">'av</span> st option acom"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">S</span> <span class="main">⇒</span> Some<span class="main">(</span><span class="bound">S</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> aval' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">step'</span> <span class="main">(</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
   <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊔</span> post <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊔</span> post <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="main">(</span><span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">Inv</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> <span class="tfree">'av</span> st option acom option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">AI</span> <span class="main">=</span> lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> strip_step'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>step' <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">γ<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st <span class="main">⇒</span> state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">==</span> γ_fun <span class="free">γ</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">γ<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option <span class="main">⇒</span> state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">==</span> γ_option γ<span class="hidden">⇩</span><sub>f</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">γ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option acom <span class="main">⇒</span> state set acom"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">==</span> map_acom γ<span class="hidden">⇩</span><sub>o</sub>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_f_Top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>f</sub> Top <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_fun_def γ_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_o_Top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>o</sub> Top <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_option_def<span class="main">)</span>

<span class="comment1">(* FIXME (maybe also le → sqle?) *)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gamma_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊑</span> <span class="free">g</span> <span class="main">⟹</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">f</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def γ_fun_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mono_gamma<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gamma_o<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">⊑</span> <span class="free">sa'</span> <span class="main">⟹</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">sa</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">sa'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sa</span></span> <span class="quoted"><span class="free">sa'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_option.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_gamma_f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gamma_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ca</span> <span class="main">⊑</span> <span class="free">ca'</span> <span class="main">⟹</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">ca</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">ca'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ca</span></span> <span class="quoted"><span class="free">ca'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mono_gamma_o<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Soundness:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aval'_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">S</span> <span class="main">⟹</span> aval <span class="free">a</span> <span class="free">s</span> <span class="main">:</span> <span class="free">γ</span><span class="main">(</span>aval' <span class="free">a</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gamma_num' gamma_plus' γ_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_gamma_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">S</span><span class="main">;</span> <span class="free">i</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub><span class="main">(</span><span class="free">S</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step_preserves_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S'</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span> <span class="main">⟧</span> <span class="main">⟹</span> step <span class="free">S</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="free">S'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SKIP <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>SKIP_le map_acom_SKIP<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Assign <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Assign_le  map_acom_Assign <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aval'_sound in_gamma_update
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Seq <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Seq_le map_acom_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_post post_map_acom<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>If <span class="skolem">b</span> <span class="skolem">c1</span> <span class="skolem">c2</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="skolem">b</span> <span class="keyword1">THEN</span> <span class="skolem">c1'</span> <span class="keyword1">ELSE</span> <span class="skolem">c2'</span> <span class="main">{</span><span class="skolem">P'</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c2'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> If_le map_acom_If<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">c1</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>post <span class="skolem">c1'</span> <span class="main">⊔</span> post <span class="skolem">c2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>›</span></span> join_ge1 le_post mono_gamma_o order_trans post_map_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">c2</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>post <span class="skolem">c1'</span> <span class="main">⊔</span> post <span class="skolem">c2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c2</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c2'</span>›</span></span> join_ge2 le_post mono_gamma_o order_trans post_map_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> If.IH subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">I</span> <span class="skolem">b</span> <span class="skolem">c1</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">I'</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="skolem">b</span> <span class="keyword1">DO</span> <span class="skolem">c1'</span> <span class="main">{</span><span class="skolem">P'</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_acom_While While_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∪</span> post <span class="skolem">c1</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">(</span><span class="skolem">S'</span> <span class="main">⊔</span> post <span class="skolem">c1'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S'</span>›</span></span> le_post<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> join_ge1 join_ge2 le_sup_iff mono_gamma_o order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> While.IH subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AI_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"AI <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟹</span> CS <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CS_def AI_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"step' <span class="main">⊤</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lpfpc_pfp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_lpfpc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"step UNIV <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> step_preserves_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">⊤</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_gamma_c<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono_gamma_c order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Monotonicity"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> <span class="free">c'</span> <span class="main">⟹</span> post <span class="free">c</span> <span class="main">⊑</span> post <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> Abs_Int_Fun_mono <span class="main">=</span> Abs_Int_Fun <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono_plus'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">⊑</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">plus'</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">plus'</span> <span class="free">b1</span> <span class="free">b2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_aval'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> aval' <span class="free">e</span> <span class="free">S</span> <span class="main">⊑</span> aval' <span class="free">e</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_fun_def mono_plus'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">S</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">a</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">S'</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">a'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_fun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_step'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c'</span> <span class="main">⟹</span> step' <span class="free">S</span> <span class="free">c</span> <span class="main">⊑</span> step' <span class="free">S'</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def mono_update mono_aval' mono_post le_join_disj
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Problem: not executable because of the comparison of abstract states,
i.e. functions, in the post-fixedpoint computation.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_State">
<div class="head">
<h1>Theory Abs_State</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Abstract State with Computable Ordering"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abs_State
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_Int0.html">Abs_Int0</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Char_ord.html">HOL-Library.Char_ord</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span>
  <span class="comment1">(* Library import merely to allow string lists to be sorted for output *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A concrete type of state with computable <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊑›</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> st <span class="main">=</span> FunDom <span class="quoted"><span class="quoted">"vname <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="quoted">"vname list"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">fun</span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fun</span> <span class="main">(</span>FunDom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dom</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dom</span> <span class="main">(</span>FunDom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inter_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_st</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span>fun <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> x <span class="main">←</span> sort<span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_acom</span> <span class="main">=</span> map_acom <span class="main">(</span>map_option show_st<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">show_acom_opt</span> <span class="main">=</span> map_option show_acom"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:</span> set<span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="keyword1">then</span> fun <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">⊤</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span>
  FunDom <span class="main">(</span><span class="main">(</span>fun <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> set<span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="keyword1">then</span> dom <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> dom <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_update<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>update <span class="free">S</span> <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lookup <span class="free">S</span><span class="main">)</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_def update_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ_st</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">γ</span></span></span><span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> st <span class="main">::</span> <span class="main">(</span><span class="quoted">SL_top</span><span class="main">)</span> <span class="quoted">SL_top</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">le_st</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set<span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">.</span> lookup <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">x</span> <span class="main">⊑</span> fun <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">join_st</span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">=</span>
 FunDom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fun <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">x</span> <span class="main">⊔</span> fun <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inter_list <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> FunDom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊤</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lookup_def preord_class.le_trans top<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def join_st_def Top_st_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">⊑</span> <span class="free">F'</span> <span class="main">⟹</span> lookup <span class="free">F</span> <span class="free">x</span> <span class="main">⊑</span> lookup <span class="free">F'</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_def le_st_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> update <span class="free">S</span> <span class="free">x</span> <span class="free">a</span> <span class="main">⊑</span> update <span class="free">S'</span> <span class="free">x</span> <span class="free">a'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def update_def<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> Gamma <span class="main">=</span> Val_abs <span class="keyword2"><span class="keyword">where</span></span> γ<span class="main">=</span><span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>SL_top <span class="main">⇒</span> val set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">γ<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st <span class="main">⇒</span> state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ<span class="hidden">⇩</span><sub>f</sub></span> <span class="main">==</span> γ_st <span class="free">γ</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">γ<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option <span class="main">⇒</span> state set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ<span class="hidden">⇩</span><sub>o</sub></span> <span class="main">==</span> γ_option γ<span class="hidden">⇩</span><sub>f</sub>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">γ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option acom <span class="main">⇒</span> state set acom"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">==</span> map_acom γ<span class="hidden">⇩</span><sub>o</sub>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_f_Top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>f</sub> Top <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Top_st_def γ_st_def lookup_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_o_Top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>o</sub> Top <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_option_def<span class="main">)</span>

<span class="comment1">(* FIXME (maybe also le → sqle?) *)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gamma_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊑</span> <span class="free">g</span> <span class="main">⟹</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">f</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>γ_st_def subset_iff lookup_def le_st_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I mono_gamma gamma_Top subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gamma_o<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">⊑</span> <span class="free">sa'</span> <span class="main">⟹</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">sa</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">sa'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sa</span></span> <span class="quoted"><span class="free">sa'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_option.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_gamma_f<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_gamma_c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ca</span> <span class="main">⊑</span> <span class="free">ca'</span> <span class="main">⟹</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">ca</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">ca'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ca</span></span> <span class="quoted"><span class="free">ca'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mono_gamma_o<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_gamma_option_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">:</span> γ_option <span class="free">r</span> <span class="free">u</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u'</span><span class="main">.</span> <span class="free">u</span> <span class="main">=</span> Some <span class="bound">u'</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">:</span> <span class="free">r</span> <span class="bound">u'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_Int1">
<div class="head">
<h1>Theory Abs_Int1</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Computable Abstract Interpretation"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int1
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_State.html">Abs_State</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Abstract interpretation over type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>st›</span></span></span></span> instead of
functions.›</span></span>

<span class="keyword1"><span class="command">context</span></span> Gamma
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aval'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> <span class="tfree">'av</span> st <span class="main">⇒</span> <span class="tfree">'av</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">aval'</span> <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free">num'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">aval'</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> lookup <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">aval'</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free">plus'</span> <span class="main">(</span><span class="free">aval'</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">aval'</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aval'_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">S</span> <span class="main">⟹</span> aval <span class="free">a</span> <span class="free">s</span> <span class="main">:</span> <span class="free">γ</span><span class="main">(</span>aval' <span class="free">a</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gamma_num' gamma_plus' γ_st_def lookup_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The for-clause (here and elsewhere) only serves the purpose of fixing
the name of the type parameter <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'av</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which would otherwise be renamed to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abs_Int <span class="main">=</span> Gamma <span class="keyword2"><span class="keyword">where</span></span> γ<span class="main">=</span><span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>SL_top <span class="main">⇒</span> val set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option <span class="main">⇒</span> <span class="tfree">'av</span> st option acom <span class="main">⇒</span> <span class="tfree">'av</span> st option acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">S</span> <span class="main">⇒</span> Some<span class="main">(</span>update <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>aval' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">step'</span> <span class="main">(</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c1'</span> <span class="main">=</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;</span> <span class="bound">c2'</span> <span class="main">=</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
   <span class="keyword1">in</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="bound">c1'</span> <span class="keyword1">ELSE</span> <span class="bound">c2'</span> <span class="main">{</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊔</span> post <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊔</span> post <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">Inv</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> <span class="tfree">'av</span> st option acom option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">AI</span> <span class="main">=</span> lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> strip_step'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>step' <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Soundness:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_gamma_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">S</span><span class="main">;</span> <span class="free">i</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub><span class="main">(</span>update <span class="free">S</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_st_def lookup_update<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The soundness proofs are textually identical to the ones for the step
function operating on states as functions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_preserves_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S'</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span> <span class="main">⟧</span> <span class="main">⟹</span> step <span class="free">S</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="free">S'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SKIP <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>SKIP_le map_acom_SKIP<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Assign <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Assign_le  map_acom_Assign <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aval'_sound in_gamma_update
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Seq <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Seq_le map_acom_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_post post_map_acom<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>If <span class="skolem">b</span> <span class="skolem">c1</span> <span class="skolem">c2</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">c2'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="keyword1">IF</span> <span class="skolem">b</span> <span class="keyword1">THEN</span> <span class="skolem">c1'</span> <span class="keyword1">ELSE</span> <span class="skolem">c2'</span> <span class="main">{</span><span class="skolem">P'</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c2</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c2'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> If_le map_acom_If<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">c1</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>post <span class="skolem">c1'</span> <span class="main">⊔</span> post <span class="skolem">c2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>›</span></span> join_ge1 le_post mono_gamma_o order_trans post_map_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">c2</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>post <span class="skolem">c1'</span> <span class="main">⊔</span> post <span class="skolem">c2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c2</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c2'</span>›</span></span> join_ge2 le_post mono_gamma_o order_trans post_map_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> If.IH subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">I</span> <span class="skolem">b</span> <span class="skolem">c1</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c1'</span></span> <span class="skolem"><span class="skolem">I'</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">I'</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="skolem">b</span> <span class="keyword1">DO</span> <span class="skolem">c1'</span> <span class="main">{</span><span class="skolem">P'</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">I'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_acom_While While_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∪</span> post <span class="skolem">c1</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">(</span><span class="skolem">S'</span> <span class="main">⊔</span> post <span class="skolem">c1'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S'</span>›</span></span> le_post<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">c1'</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> join_ge1 join_ge2 le_sup_iff mono_gamma_o order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> While.IH subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AI_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"AI <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟹</span> CS <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CS_def AI_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"step' <span class="main">⊤</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lpfpc_pfp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_lpfpc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"step UNIV <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> step_preserves_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">⊤</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_gamma_c<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono_gamma_c order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Monotonicity"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abs_Int_mono <span class="main">=</span> Abs_Int <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono_plus'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">⊑</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">plus'</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">plus'</span> <span class="free">b1</span> <span class="free">b2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_aval'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> aval' <span class="free">e</span> <span class="free">S</span> <span class="main">⊑</span> aval' <span class="free">e</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def mono_plus'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">a'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> update <span class="free">S</span> <span class="free">x</span> <span class="free">a</span> <span class="main">⊑</span> update <span class="free">S'</span> <span class="free">x</span> <span class="free">a'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def update_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_step'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c'</span> <span class="main">⟹</span> step' <span class="free">S</span> <span class="free">c</span> <span class="main">⊑</span> step' <span class="free">S'</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def mono_update mono_aval' mono_post le_join_disj
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Ascending Chain Condition"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">strict</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="main">-</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">^-1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">acc</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">==</span> wf<span class="main">(</span><span class="main">(</span>strict <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">^-1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strict_inv_image<span class="main">:</span> <span class="quoted"><span class="quoted">"strict<span class="main">(</span>inv_image <span class="free">r</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> inv_image <span class="main">(</span>strict <span class="free">r</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> acc_inv_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"acc <span class="free">r</span> <span class="main">⟹</span> acc <span class="main">(</span>inv_image <span class="free">r</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_inv_image strict_inv_image wf_inv_image<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ACC for option type:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> acc_option<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"acc <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preord<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"acc <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preord option<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_eq_minimal<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xo</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Qo</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xo</span> <span class="main">:</span> <span class="skolem">Qo</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> Some <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">Qo</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">yo</span><span class="main">∈</span><span class="skolem">Qo</span><span class="main">.</span> <span class="main">∀</span><span class="bound">zo</span><span class="main">.</span> <span class="bound">yo</span> <span class="main">⊑</span> <span class="bound">zo</span> <span class="main">∧</span> <span class="main">~</span> <span class="bound">zo</span> <span class="main">⊑</span> <span class="bound">yo</span> <span class="main">⟶</span> <span class="bound">zo</span> <span class="main">∉</span> <span class="skolem">Qo</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">zo</span><span class="main">∈</span><span class="skolem">Qo</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">zo</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"None <span class="main">∈</span> <span class="skolem">Qo</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xo</span> <span class="main">:</span> <span class="skolem">Qo</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> not_Some_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_eq_minimal<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?Q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"Some <span class="improper">z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ACC for abstract states, via measure functions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measure_st<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>strict<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>SL_top<span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">^-1</span> <span class="main">&lt;=</span> measure <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>SL_top<span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">m</span> <span class="bound">y</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>strict<span class="main">{</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span><span class="bound">S'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>SL_top st<span class="main">)</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊑</span> <span class="bound">S'</span><span class="main">}</span><span class="main">)</span><span class="main">^-1</span> <span class="main">⊆</span>
  measure<span class="main">(</span><span class="main">%</span><span class="bound">fd</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">x</span></span><span class="main">|</span> <span class="bound">x</span><span class="main">∈</span>set<span class="main">(</span>dom <span class="bound">fd</span><span class="main">)</span> <span class="main">∧</span> <span class="main">~</span> <span class="main">⊤</span> <span class="main">⊑</span> fun <span class="bound">fd</span> <span class="bound">x</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span>fun <span class="bound">fd</span> <span class="bound">x</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> st"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊑</span> <span class="skolem">S'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="skolem">S'</span> <span class="main">⊑</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="skolem">S'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun <span class="skolem">S'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">:</span><span class="var">?X</span><span class="main">.</span> <span class="main">~</span> <span class="main">⊤</span> <span class="main">⊑</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">:</span><span class="var">?Y</span><span class="main">.</span> <span class="main">~</span> <span class="main">⊤</span> <span class="main">⊑</span> <span class="var">?g</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊑</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="var">?g</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span> <span class="main">≤</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">~</span> <span class="skolem">S'</span> <span class="main">⊑</span> <span class="skolem">S</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">:</span> <span class="var">?X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">~</span> lookup <span class="skolem">S'</span> <span class="skolem">u</span> <span class="main">⊑</span> <span class="var">?f</span> <span class="skolem">u</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">:</span> <span class="var">?X'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> preord_class.le_trans top<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y'</span><span class="main">-</span><span class="var">?X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊑</span> <span class="skolem">S'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">&lt;=</span> <span class="var">?X'</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊑</span> <span class="skolem">S'</span>›</span></span> le_st_def lookup_def preord_class.le_trans<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="var">?Y'</span><span class="main">-</span><span class="var">?X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">)</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_Diff_Int<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Y'</span><span class="main">-</span><span class="var">?X</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_empty_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X'</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="var">?Y'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊑</span> <span class="skolem">S'</span>›</span></span> u
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">:</span><span class="var">?X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">:</span><span class="var">?Y'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="skolem">u</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_strict_mono_ex1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?X'</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">&lt;=</span> <span class="var">?X'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∉</span> <span class="var">?Y'</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">&lt;=</span> <span class="var">?X'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u</span><span class="main">}</span> <span class="main">&lt;=</span> <span class="var">?X'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">=</span> <span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">u</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">∉</span> <span class="var">?Y'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?X'</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="var">?Y'</span><span class="main">∩</span><span class="var">?X</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span> <span class="main">&lt;=</span> <span class="var">?X'</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="var">?X'</span><span class="main">-</span><span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">u</span><span class="main">}</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">:</span><span class="var">?X'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X'</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">:</span> <span class="var">?X'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_absorb<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y'</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X'</span><span class="main">.</span> <span class="free">m</span><span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> measure_def inv_image_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹ACC for acom. First the ordering on acom is related to an ordering on
lists of annotations.›</span></span>

<span class="comment1">(* FIXME mv and add [simp] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> listrel_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">,</span> <span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span><span class="free">ys</span><span class="main">)</span> <span class="main">∈</span> listrel <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>listrel.Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> listrel_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">xs1</span><span class="main">,</span><span class="free">ys1</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">xs2</span><span class="main">,</span><span class="free">ys2</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span>
  <span class="main">⟹</span> <span class="main">(</span><span class="free">xs1</span><span class="main">@</span><span class="free">xs2</span><span class="main">,</span> <span class="free">ys1</span><span class="main">@</span><span class="free">ys2</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listrel_iff_zip<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> listrel_app_same_size<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">xs1</span> <span class="main">=</span> size <span class="free">ys1</span> <span class="main">⟹</span> size <span class="free">xs2</span> <span class="main">=</span> size <span class="free">ys2</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">xs1</span><span class="main">@</span><span class="free">xs2</span><span class="main">,</span> <span class="free">ys1</span><span class="main">@</span><span class="free">ys2</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="free">xs1</span><span class="main">,</span><span class="free">ys1</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="free">xs2</span><span class="main">,</span><span class="free">ys2</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listrel_iff_zip<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> listrel_converse<span class="main">:</span> <span class="quoted"><span class="quoted">"listrel<span class="main">(</span><span class="free">r</span><span class="main">^-1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>listrel <span class="free">r</span><span class="main">)</span><span class="main">^-1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span><span class="main">,</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">:</span> listrel<span class="main">(</span><span class="free">r</span><span class="main">^-1</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">:</span> listrel <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listrel.Nil<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listrel_Cons_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* It would be nice to get rid of refl &amp; trans and build them into the proof *)</span>
<span class="keyword1"><span class="command">lemma</span></span> acc_listrel<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">*</span><span class="tfree">'a</span><span class="main">)</span>set"</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"acc <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"acc <span class="main">(</span>listrel <span class="free">r</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹refl <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> refl_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹trans <span class="free">r</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mx</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    mx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">S</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">:</span><span class="bound">S</span> <span class="main">⟹</span> <span class="skolem">mx</span> <span class="bound">S</span> <span class="main">:</span> <span class="bound">S</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">mx</span> <span class="bound">S</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">:</span> strict <span class="free">r</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_eq_minimal<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"listrel <span class="free">r</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="bound">ys</span><span class="main">∈</span><span class="skolem">Q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">zs</span><span class="main">.</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">∈</span> strict <span class="var">?R</span> <span class="main">⟶</span> <span class="bound">zs</span> <span class="main">∉</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">Q</span> <span class="bound">ys</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">ys</span> <span class="bound">Q</span><span class="main">.</span> size <span class="bound">ys</span> <span class="main">&lt;</span> size <span class="skolem">xs</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">:</span> <span class="bound">Q</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ms</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">Q</span> <span class="bound">ms</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">:</span> <span class="skolem">Q</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">Q</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">ys</span><span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="main">∃</span><span class="bound">bs</span><span class="main">.</span> size <span class="bound">bs</span> <span class="main">=</span> size <span class="skolem">ys</span> <span class="main">∧</span> <span class="bound">a</span><span class="main">#</span><span class="bound">bs</span> <span class="main">:</span> <span class="skolem">Q</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> <span class="var">?Q1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xs</span> <span class="main">:</span> <span class="skolem">Q</span>›</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> mx<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">∈</span> <span class="var">?Q1</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">m1</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> strict <span class="free">r</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">∉</span> <span class="var">?Q1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ms1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">ms1</span> <span class="main">=</span> size <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span><span class="main">#</span><span class="skolem">ms1</span> <span class="main">:</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">ms1</span> <span class="main">&lt;</span> size <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">bs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">m1'</span><span class="main">.</span> <span class="main">(</span><span class="bound">m1'</span><span class="main">,</span><span class="skolem">m1</span><span class="main">)</span><span class="main">:</span><span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">m1</span><span class="main">,</span><span class="bound">m1'</span><span class="main">)</span><span class="main">:</span><span class="free">r</span> <span class="main">∧</span> <span class="bound">m1'</span><span class="main">#</span><span class="bound">bs</span> <span class="main">:</span> <span class="skolem">Q</span> <span class="main">∧</span> size <span class="bound">bs</span> <span class="main">=</span> size <span class="skolem">ms1</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms1</span> <span class="main">:</span> <span class="var">?Q2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m1</span><span class="main">#</span><span class="skolem">ms1</span> <span class="main">:</span> <span class="skolem">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refl<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹size <span class="skolem">ms1</span> <span class="main">&lt;</span> size <span class="skolem">xs</span>›</span></span> this<span class="main">]</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ms</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?Q2</span> <span class="skolem">ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m1'</span><span class="main">,</span><span class="skolem">m1</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">m1</span><span class="main">,</span><span class="skolem">m1'</span><span class="main">)</span> <span class="main">:</span> <span class="free">r</span> <span class="main">∧</span> <span class="skolem">m1'</span><span class="main">#</span><span class="skolem">ms</span> <span class="main">:</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ab</span><span class="main">.</span> <span class="main">(</span><span class="skolem">m1'</span><span class="main">#</span><span class="skolem">ms</span><span class="main">,</span><span class="bound">ab</span><span class="main">)</span> <span class="main">:</span> strict <span class="var">?R</span> <span class="main">⟶</span> <span class="bound">ab</span> <span class="main">∉</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listrel_Cons_iff<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ms1</span> <span class="main">=</span> length <span class="skolem">ys</span>›</span></span> listrel_eq_len trans<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">ms1</span> <span class="main">=</span> length <span class="skolem">ys</span>›</span></span> listrel_eq_len trans<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> m1' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_eq_minimal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> converse_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> le_iff_le_annos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="main">⊑</span> <span class="free">c2</span> <span class="main">⟷</span>
 <span class="main">(</span>annos <span class="free">c1</span><span class="main">,</span> annos <span class="free">c2</span><span class="main">)</span> <span class="main">:</span> listrel<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span> <span class="main">∧</span> strip <span class="free">c1</span> <span class="main">=</span> strip <span class="free">c2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> listrel.Nil listrel_Cons_iff listrel_app size_annos_same2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> listrel_app_same_size size_annos_same<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> le_acom_subset_same_annos<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>strict<span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">c'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preord acom<span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c'</span><span class="main">}</span><span class="main">)</span><span class="main">^-1</span> <span class="main">⊆</span>
  <span class="main">(</span>strict<span class="main">(</span>inv_image <span class="main">(</span>listrel<span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="bound">a'</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> annos<span class="main">)</span><span class="main">)</span><span class="main">^-1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_le_annos<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> acc_acom<span class="main">:</span> <span class="quoted"><span class="quoted">"acc <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">a'</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>preord<span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="bound">a'</span><span class="main">}</span> <span class="main">⟹</span>
  acc <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span><span class="bound">c'</span><span class="main">::</span><span class="tfree">'a</span> acom<span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ le_acom_subset_same_annos<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> acc_inv_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> acc_listrel<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> refl_on_def trans_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Termination of the fixed-point finders, assuming monotone functions:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pfp_termination<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>preord"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"acc <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">x0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> pfp <span class="free">f</span> <span class="free">x0</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pfp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_while_option_Some<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">%</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">⊑</span></span> <span class="free"><span class="free">f</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span> <span class="main">⊑</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">⊑</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x0</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">x0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="free">f</span><span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lpfpc_termination<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>SL_top<span class="main">)</span>option acom <span class="main">⇒</span> <span class="tfree">'a</span> option acom<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"acc <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> strip<span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lpfp<span class="hidden">⇩</span><sub>c</sub>_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pfp_termination<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> acc_acom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> acc_option<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_acom assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> Abs_Int_mono
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AI_Some_measure<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>strict<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">^-1</span> <span class="main">&lt;=</span> measure <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">m</span> <span class="bound">y</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> AI <span class="free">c</span> <span class="main">=</span> Some <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> AI_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> lpfpc_termination<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_measure measure_st<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> mono_step'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> strip_step'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_Int2">
<div class="head">
<h1>Theory Abs_Int2</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Backward Analysis of Expressions"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int2
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_Int1.html">Abs_Int1</a> <span class="quoted">"<a href="../../HOL/HOL-IMP/Vars.html">HOL-IMP.Vars</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">preord</span><span class="main">,</span><span class="quoted">preord</span><span class="main">)</span> <span class="quoted">preord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">le_prod</span></span> <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">⊑</span> fst <span class="free"><span class="bound"><span class="entity">p2</span></span></span> <span class="main">∧</span> snd <span class="free"><span class="bound"><span class="entity">p1</span></span></span> <span class="main">⊑</span> snd <span class="free"><span class="bound"><span class="entity">p2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> le_prod_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> le_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> bot

<span class="keyword1"><span class="command">class</span></span> L_top_bot <span class="main">=</span> SL_top <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">meet</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">⊓</span></span></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free"><span class="free"><span class="free">bot</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">⊥</span></span></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> meet_le1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">⊓</span></span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> meet_le2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main"><span class="free">⊓</span></span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> meet_greatest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main"><span class="free">⊓</span></span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊥</span></span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_meet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">x'</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">y'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x'</span> <span class="main">⊓</span> <span class="free">y'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> meet_greatest meet_le1 meet_le2 le_trans<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> Val_abs1_gamma <span class="main">=</span>
  Gamma <span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>L_top_bot <span class="main">⇒</span> val set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> inter_gamma_subset_gamma_meet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="free">a1</span> <span class="main">∩</span> <span class="free">γ</span> <span class="free">a2</span> <span class="main">⊆</span> <span class="free">γ</span><span class="main">(</span><span class="free">a1</span> <span class="main">⊓</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> gamma_Bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_gamma_meet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a1</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a2</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">:</span> <span class="free">γ</span><span class="main">(</span><span class="free">a1</span> <span class="main">⊓</span> <span class="free">a2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI inter_gamma_subset_gamma_meet subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_meet<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ</span><span class="main">(</span><span class="free">a1</span> <span class="main">⊓</span> <span class="free">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free">γ</span> <span class="free">a1</span> <span class="main">∩</span> <span class="free">γ</span> <span class="free">a2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equalityI inter_gamma_subset_gamma_meet le_inf_iff mono_gamma meet_le1 meet_le2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">locale</span></span> Val_abs1 <span class="main">=</span>
  Val_abs1_gamma <span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted"><span class="free">γ</span></span>
   <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>L_top_bot <span class="main">⇒</span> val set"</span></span> <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">test_num'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">filter_plus'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">*</span> <span class="tfree">'av</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="free">filter_less'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">*</span> <span class="tfree">'av</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> test_num'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">test_num'</span> <span class="free">n</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> filter_plus'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">filter_plus'</span> <span class="free">a</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">n1</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a1</span> <span class="main">⟹</span> <span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a2</span> <span class="main">⟹</span> <span class="free">n1</span><span class="main">+</span><span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">n1</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">b1</span> <span class="main">∧</span> <span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">b2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> filter_less'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">filter_less'</span> <span class="main">(</span><span class="free">n1</span><span class="main">&lt;</span><span class="free">n2</span><span class="main">)</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">=</span> <span class="main">(</span><span class="free">b1</span><span class="main">,</span><span class="free">b2</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">n1</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a1</span> <span class="main">⟹</span> <span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a2</span> <span class="main">⟹</span> <span class="free">n1</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">b1</span> <span class="main">∧</span> <span class="free">n2</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">b2</span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> Abs_Int1 <span class="main">=</span>
  Val_abs1 <span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span>L_top_bot <span class="main">⇒</span> val set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_gamma_join_UpI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S1</span> <span class="main">∨</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S2</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span><span class="free">S1</span> <span class="main">⊔</span> <span class="free">S2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> join_ge1 join_ge2 mono_gamma_o rev_subsetD<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">aval''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> <span class="tfree">'av</span> st option <span class="main">⇒</span> <span class="tfree">'av</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">aval''</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> None <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">aval''</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">sa</span></span></span><span class="main">)</span> <span class="main">=</span> aval' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">sa</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> aval''_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S</span> <span class="main">⟹</span> aval <span class="free">a</span> <span class="free">s</span> <span class="main">:</span> <span class="free">γ</span><span class="main">(</span>aval'' <span class="free">a</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aval'_sound<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Backward analysis"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">afilter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> <span class="tfree">'av</span> <span class="main">⇒</span> <span class="tfree">'av</span> st option <span class="main">⇒</span> <span class="tfree">'av</span> st option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">afilter</span> <span class="main">(</span>N <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">test_num'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">afilter</span> <span class="main">(</span>V <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">S</span> <span class="main">⇒</span>
  <span class="keyword1">let</span> <span class="bound">a'</span> <span class="main">=</span> lookup <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> <span class="bound">a'</span> <span class="main">⊑</span> <span class="main">⊥</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some<span class="main">(</span>update <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">a'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">afilter</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">a1</span><span class="main">,</span><span class="bound">a2</span><span class="main">)</span> <span class="main">=</span> <span class="free">filter_plus'</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>aval'' <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span>aval'' <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
  <span class="keyword1">in</span> <span class="free">afilter</span> <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">a1</span> <span class="main">(</span><span class="free">afilter</span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">a2</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹The test for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bot<span class="antiquote"><span class="antiquote">}</span></span></span></span> in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> V<span class="antiquote"><span class="antiquote">}</span></span></span></span>-case is important: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span>
bot<span class="antiquote"><span class="antiquote">}</span></span></span></span> indicates that a variable has no possible values, i.e.\ that the current
program point is unreachable. But then the abstract state should collapse to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Put differently, we maintain the invariant that in an abstract
state of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span><span class="quoted"><span class="quoted">"Some <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, all variables are mapped to non-<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span>
bot<span class="antiquote"><span class="antiquote">}</span></span></span></span> values. Otherwise the (pointwise) join of two abstract states, one of
which contains <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bot<span class="antiquote"><span class="antiquote">}</span></span></span></span> values, may produce too large a result, thus
making the analysis less precise.›</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bfilter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bexp <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'av</span> st option <span class="main">⇒</span> <span class="tfree">'av</span> st option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bfilter</span> <span class="main">(</span>Bc <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bfilter</span> <span class="main">(</span>Not <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="free">bfilter</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bfilter</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">b1</span></span></span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="keyword1">then</span> <span class="free">bfilter</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> True <span class="main">(</span><span class="free">bfilter</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> True <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="free">bfilter</span> <span class="free"><span class="bound"><span class="entity">b1</span></span></span> False <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊔</span> <span class="free">bfilter</span> <span class="free"><span class="bound"><span class="entity">b2</span></span></span> False <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bfilter</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">e2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">res1</span><span class="main">,</span><span class="bound">res2</span><span class="main">)</span> <span class="main">=</span> <span class="free">filter_less'</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">(</span>aval'' <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="main">(</span>aval'' <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>
   <span class="keyword1">in</span> afilter <span class="free"><span class="bound"><span class="entity">e1</span></span></span> <span class="bound">res1</span> <span class="main">(</span>afilter <span class="free"><span class="bound"><span class="entity">e2</span></span></span> <span class="bound">res2</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> afilter_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S</span> <span class="main">⟹</span> aval <span class="free">e</span> <span class="free">s</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">(</span>afilter <span class="free">e</span> <span class="free">a</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> N <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> test_num'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> Some <span class="skolem">S'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="skolem">S'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_gamma_option_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">x</span> <span class="main">:</span> <span class="free">γ</span> <span class="main">(</span>lookup <span class="skolem">S'</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_st_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">x</span> <span class="main">:</span> <span class="free">γ</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> V <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> V<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_update Let_def γ_st_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> mono_gamma emptyE in_gamma_meet gamma_Bot subset_empty<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_plus'<span class="main">[</span><span class="operator">OF</span> _ aval''_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> aval''_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Plus<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bfilter_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S</span> <span class="main">⟹</span> <span class="free">bv</span> <span class="main">=</span> bval <span class="free">b</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>bfilter <span class="free">b</span> <span class="free">bv</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">bv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Bc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">b1</span> <span class="skolem">b2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_gamma_join_UpI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Less <span class="skolem">e1</span> <span class="skolem">e2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">hypsubst_thin</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> afilter_sound filter_less' aval''_sound Less<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span> st option <span class="main">⇒</span> <span class="tfree">'av</span> st option acom <span class="main">⇒</span> <span class="tfree">'av</span> st option acom"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">S</span> <span class="main">⇒</span> Some<span class="main">(</span>update <span class="bound">S</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>aval' <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span> <span class="free">step'</span> <span class="main">(</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c1'</span> <span class="main">=</span> <span class="free">step'</span> <span class="main">(</span>bfilter <span class="free"><span class="bound"><span class="entity">b</span></span></span> True <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;</span> <span class="bound">c2'</span> <span class="main">=</span> <span class="free">step'</span> <span class="main">(</span>bfilter <span class="free"><span class="bound"><span class="entity">b</span></span></span> False <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span>
   <span class="keyword1">in</span> <span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="bound">c1'</span> <span class="keyword1">ELSE</span> <span class="bound">c2'</span> <span class="main">{</span>post <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="main">⊔</span> post <span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">step'</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">{</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⊔</span> post <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">}</span>
   <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">step'</span> <span class="main">(</span>bfilter <span class="free"><span class="bound"><span class="entity">b</span></span></span> True <span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
   <span class="main">{</span>bfilter <span class="free"><span class="bound"><span class="entity">b</span></span></span> False <span class="free"><span class="bound"><span class="entity">Inv</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AI</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> <span class="tfree">'av</span> st option acom option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">AI</span> <span class="main">=</span> lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip_step'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip<span class="main">(</span>step' <span class="free">S</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Soundness"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_gamma_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub> <span class="free">S</span><span class="main">;</span> <span class="free">i</span> <span class="main">:</span> <span class="free">γ</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">s</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">i</span><span class="main">)</span> <span class="main">:</span> γ<span class="hidden">⇩</span><sub>f</sub><span class="main">(</span>update <span class="free">S</span> <span class="free">x</span> <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_st_def lookup_update<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step_preserves_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="free">S'</span><span class="main">;</span> <span class="free">cs</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">ca</span> <span class="main">⟧</span> <span class="main">⟹</span> step <span class="free">S</span> <span class="free">cs</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="free">S'</span> <span class="free">ca</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ca</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> SKIP <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>SKIP_le map_acom_SKIP<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Assign <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Assign_le  map_acom_Assign <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> aval'_sound in_gamma_update
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Seq <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Seq_le map_acom_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_post post_map_acom<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>If <span class="skolem">b</span> <span class="skolem">cs1</span> <span class="skolem">cs2</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ca1</span></span> <span class="skolem"><span class="skolem">ca2</span></span> <span class="skolem"><span class="skolem">Pa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ca</span><span class="main">=</span> <span class="keyword1">IF</span> <span class="skolem">b</span> <span class="keyword1">THEN</span> <span class="skolem">ca1</span> <span class="keyword1">ELSE</span> <span class="skolem">ca2</span> <span class="main">{</span><span class="skolem">Pa</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">Pa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">ca1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs2</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">ca2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> If_le map_acom_If<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">cs1</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>post <span class="skolem">ca1</span> <span class="main">⊔</span> post <span class="skolem">ca2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">ca1</span>›</span></span> join_ge1 le_post mono_gamma_o order_trans post_map_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"post <span class="skolem">cs2</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub><span class="main">(</span>post <span class="skolem">ca1</span> <span class="main">⊔</span> post <span class="skolem">ca2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs2</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">ca2</span>›</span></span> join_ge2 le_post mono_gamma_o order_trans post_map_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> If.IH subset_iff bfilter_sound<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">I</span> <span class="skolem">b</span> <span class="skolem">cs1</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ca1</span></span> <span class="skolem"><span class="skolem">Ia</span></span> <span class="skolem"><span class="skolem">Pa</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ca</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">Ia</span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="skolem">b</span> <span class="keyword1">DO</span> <span class="skolem">ca1</span> <span class="main">{</span><span class="skolem">Pa</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">Ia</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">Pa</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">ca1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_acom_While While_le<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∪</span> post <span class="skolem">cs1</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">(</span><span class="skolem">S'</span> <span class="main">⊔</span> post <span class="skolem">ca1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="skolem">S'</span>›</span></span> le_post<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">cs1</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="skolem">ca1</span>›</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> join_ge1 join_ge2 le_sup_iff mono_gamma_o order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> While.IH subset_iff bfilter_sound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AI_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"AI <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟹</span> CS <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CS_def AI_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"lpfp<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"step' <span class="main">⊤</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lpfpc_pfp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_lpfpc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"step UNIV <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> step_preserves_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">⊤</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_gamma_c<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono_gamma_c order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Commands over a set of variables"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Key invariant: the domains of all abstract states are subsets of the
set of variables of the program.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">domo</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">S'</span> <span class="main">⇒</span> set<span class="main">(</span>dom <span class="bound">S'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Com</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vname set <span class="main">⇒</span> <span class="tfree">'a</span> st option acom set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Com</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span> <span class="main">∈</span> set<span class="main">(</span>annos <span class="bound">c</span><span class="main">)</span><span class="main">.</span> domo <span class="bound">S</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domo_Top<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domo <span class="main">⊤</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domo_def Top_st_def Top_option_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bot_acom_Com<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c</span> <span class="main">∈</span> Com <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_acom_def Com_def domo_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> post_in_annos<span class="main">:</span> <span class="quoted"><span class="quoted">"post <span class="free">c</span> <span class="main">:</span> set<span class="main">(</span>annos <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> domo_join<span class="main">:</span> <span class="quoted"><span class="quoted">"domo <span class="main">(</span><span class="free">S</span> <span class="main">⊔</span> <span class="free">T</span><span class="main">)</span> <span class="main">⊆</span> domo <span class="free">S</span> <span class="main">∪</span> domo <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def join_st_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domo_afilter<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="free">a</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> domo <span class="free">S</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> domo<span class="main">(</span>afilter <span class="free">a</span> <span class="free">i</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domo_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domo_def Let_def update_def lookup_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> domo_bfilter<span class="main">:</span> <span class="quoted"><span class="quoted">"vars <span class="free">b</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> domo <span class="free">S</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> domo<span class="main">(</span>bfilter <span class="free">b</span> <span class="free">bv</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bv</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domo_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> le_sup_iff subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> domo_join<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domo_afilter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> step'_Com<span class="main">:</span>
  <span class="quoted"><span class="quoted">"domo <span class="free">S</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> vars<span class="main">(</span>strip <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">⟹</span> step' <span class="free">S</span> <span class="free">c</span> <span class="main">:</span> Com <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def domo_def update_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def ball_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> post_in_annos<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def ball_Un<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Un_assoc domo_join order_trans post_in_annos subset_Un_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domo_bfilter<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domo_join le_sup_iff post_in_annos subset_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domo_bfilter<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domo_bfilter<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Monotonicity"</span></span>

<span class="keyword1"><span class="command">locale</span></span> Abs_Int1_mono <span class="main">=</span> Abs_Int1 <span class="main">+</span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono_plus'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">⊑</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">plus'</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">plus'</span> <span class="free">b1</span> <span class="free">b2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> mono_filter_plus'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">⊑</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">b2</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">⊑</span> <span class="free">r'</span> <span class="main">⟹</span>
  <span class="free">filter_plus'</span> <span class="free">r</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">filter_plus'</span> <span class="free">r'</span> <span class="free">b1</span> <span class="free">b2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> mono_filter_less'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a1</span> <span class="main">⊑</span> <span class="free">b1</span> <span class="main">⟹</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">b2</span> <span class="main">⟹</span>
  <span class="free">filter_less'</span> <span class="free">bv</span> <span class="free">a1</span> <span class="free">a2</span> <span class="main">⊑</span> <span class="free">filter_less'</span> <span class="free">bv</span> <span class="free">b1</span> <span class="free">b2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_aval'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> aval' <span class="free">e</span> <span class="free">S</span> <span class="main">⊑</span> aval' <span class="free">e</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def mono_plus'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_aval''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> aval'' <span class="free">e</span> <span class="free">S</span> <span class="main">⊑</span> aval'' <span class="free">e</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_aval'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mono_afilter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⊑</span> <span class="free">r'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> afilter <span class="free">e</span> <span class="free">r</span> <span class="free">S</span> <span class="main">⊑</span> afilter <span class="free">e</span> <span class="free">r'</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">r'</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> test_num' Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mono_gamma subsetD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> list a b c d<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="improper">list</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mono_lookup<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mono_meet le_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> mono_meet mono_lookup mono_update<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> mono_aval'' mono_filter_plus'<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> le_prod_def<span class="main"><span class="main">]</span></span> fst_conv snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_bfilter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> bfilter <span class="free">b</span> <span class="free">r</span> <span class="free">S</span> <span class="main">⊑</span> bfilter <span class="free">b</span> <span class="free">r</span> <span class="free">S'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_ge1<span class="main"><span class="main">]</span></span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ join_ge2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> mono_aval'' mono_afilter mono_filter_less'<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> le_prod_def<span class="main"><span class="main">]</span></span> fst_conv snd_conv<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_step'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊑</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c'</span> <span class="main">⟹</span> step' <span class="free">S</span> <span class="free">c</span> <span class="main">⊑</span> step' <span class="free">S'</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">S'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_post mono_bfilter mono_update mono_aval' Let_def le_join_disj
  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_step'2<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>step' <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def mono_step'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_Int2_ivl">
<div class="head">
<h1>Theory Abs_Int2_ivl</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Interval Analysis"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int2_ivl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_Int2.html">Abs_Int2</a> <span class="quoted">"<a href="../../HOL/HOL-IMP/Abs_Int_Tests.html">HOL-IMP.Abs_Int_Tests</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> ivl <span class="main">=</span> I <span class="quoted"><span class="quoted">"int option"</span></span> <span class="quoted"><span class="quoted">"int option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">γ_ivl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span>
  I <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> <span class="main">(</span>Some <span class="bound">h</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">l</span><span class="main">..</span><span class="bound">h</span><span class="main">}</span> <span class="main">|</span>
  I <span class="main">(</span>Some <span class="bound">l</span><span class="main">)</span> None <span class="main">⇒</span> <span class="main">{</span><span class="bound">l</span><span class="main">..}</span> <span class="main">|</span>
  I None <span class="main">(</span>Some <span class="bound">h</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">{..</span><span class="bound">h</span><span class="main">}</span> <span class="main">|</span>
  I None None <span class="main">⇒</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">I_Some_Some</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> ivl"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">{</span>_<span class="keyword1">…</span>_<span class="keyword1">}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main"><span class="free">…</span></span><span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">==</span> I <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">I_Some_None</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> ivl"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">{</span>_<span class="keyword1">…}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main"><span class="free">…}</span></span> <span class="main">==</span> I <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">lo</span></span></span><span class="main">)</span> None"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">I_None_Some</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> ivl"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">{…</span>_<span class="keyword1">}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="free">{…</span></span><span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">==</span> I None <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">hi</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">I_None_None</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ivl"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword1">{…}</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="free">{…}</span></span> <span class="main">==</span> I None None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">num_ivl</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">…</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_ivl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> ivl <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">in_ivl</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>I <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">in_ivl</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>I <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> None<span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">in_ivl</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>I None <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">in_ivl</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">(</span>I None None<span class="main">)</span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">plus</span><span class="main">)</span><span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">plus_option</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">+</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">…</span><span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_empty</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">…</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty<span class="main">(</span>I <span class="free">l</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">l</span> <span class="keyword1">of</span> Some <span class="bound">l</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="keyword1">of</span> Some <span class="bound">h</span> <span class="main">⇒</span> <span class="bound">h</span><span class="main">&lt;</span><span class="bound">l</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty <span class="free">i</span> <span class="main">⟹</span> γ_ivl <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_ivl_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">plus_ivl</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">|</span> is_empty <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> empty <span class="keyword1">else</span>
  <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>I <span class="bound">l1</span> <span class="bound">h1</span><span class="main">,</span> I <span class="bound">l2</span> <span class="bound">h2</span><span class="main">)</span> <span class="main">⇒</span> I <span class="main">(</span><span class="bound">l1</span><span class="main">+</span><span class="bound">l2</span><span class="main">)</span> <span class="main">(</span><span class="bound">h1</span><span class="main">+</span><span class="bound">h2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ivl <span class="main">::</span> <span class="quoted">SL_top</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">le_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> int option <span class="main">⇒</span> int option <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">le_option</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Some <span class="bound">j</span> <span class="main">⇒</span> <span class="bound">i</span><span class="main">≤</span><span class="bound">j</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> Some <span class="bound">j</span> <span class="main">⇒</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">|</span> None <span class="main">⇒</span> True<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">le_aux</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">le_aux</span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">)</span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>le_option False <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">&amp;</span> le_option True <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">le_ivl</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="keyword1">then</span> True <span class="keyword1">else</span>
  <span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> False <span class="keyword1">else</span> le_aux <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> int option <span class="main">⇒</span> int option <span class="main">⇒</span> int option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">min_option</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> le_option <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> int option <span class="main">⇒</span> int option <span class="main">⇒</span> int option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">max_option</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> le_option <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">o2</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">o1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span>
 <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>I <span class="bound">l1</span> <span class="bound">h1</span><span class="main">,</span> I <span class="bound">l2</span> <span class="bound">h2</span><span class="main">)</span> <span class="main">⇒</span>
          I <span class="main">(</span>min_option False <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">(</span>max_option True <span class="bound">h1</span> <span class="bound">h2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> <span class="main">{…}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ivl_def le_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_ivl_def le_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ivl_def join_ivl_def le_option_def min_option_def max_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ivl_def join_ivl_def le_option_def min_option_def max_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ivl_def join_ivl_def le_option_def min_option_def max_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_ivl_def le_ivl_def le_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">instantiation</span></span> ivl <span class="main">::</span> <span class="quoted">L_top_bot</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">⊓</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">∨</span> is_empty <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> empty <span class="keyword1">else</span>
  <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>I <span class="bound">l1</span> <span class="bound">h1</span><span class="main">,</span> I <span class="bound">l2</span> <span class="bound">h2</span><span class="main">)</span> <span class="main">⇒</span>
    I <span class="main">(</span>max_option False <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">(</span>min_option True <span class="bound">h1</span> <span class="bound">h2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">=</span> empty"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>meet_ivl_def empty_def le_ivl_def le_option_def max_option_def min_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def meet_ivl_def le_ivl_def le_option_def max_option_def min_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ivl_def meet_ivl_def empty_def le_option_def max_option_def min_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_ivl_def empty_def le_ivl_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">minus</span><span class="main">)</span><span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">minus_option</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">-</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">minus_ivl</span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">|</span> is_empty <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="keyword1">then</span> empty <span class="keyword1">else</span>
  <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>I <span class="bound">l1</span> <span class="bound">h1</span><span class="main">,</span> I <span class="bound">l2</span> <span class="bound">h2</span><span class="main">)</span> <span class="main">⇒</span> I <span class="main">(</span><span class="bound">l1</span><span class="main">-</span><span class="bound">h2</span><span class="main">)</span> <span class="main">(</span><span class="bound">h1</span><span class="main">-</span><span class="bound">l2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gamma_minus_ivl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n1</span> <span class="main">:</span> γ_ivl <span class="free">i1</span> <span class="main">⟹</span> <span class="free">n2</span> <span class="main">:</span> γ_ivl <span class="free">i2</span> <span class="main">⟹</span> <span class="free">n1</span><span class="main">-</span><span class="free">n2</span> <span class="main">:</span> γ_ivl<span class="main">(</span>minus_ivl <span class="free">i1</span> <span class="free">i2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_ivl_def γ_ivl_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_plus_ivl</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="comment1">⌦‹if is_empty i then empty else›</span>
  <span class="free"><span class="bound"><span class="entity">i1</span></span></span> <span class="main">⊓</span> minus_ivl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i2</span></span></span> <span class="main">⊓</span> minus_ivl <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">i1</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filter_less_ivl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> ivl <span class="main">⇒</span> ivl <span class="main">⇒</span> ivl <span class="main">*</span> ivl"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">filter_less_ivl</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">)</span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> is_empty<span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">)</span> <span class="main">∨</span> is_empty<span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>empty<span class="main">,</span> empty<span class="main">)</span> <span class="keyword1">else</span>
   <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span>
   <span class="keyword1">then</span> <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">(</span>min_option True <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">h2</span></span></span> <span class="main">-</span> Some <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         I <span class="main">(</span>max_option False <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="main">+</span> Some <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span>
   <span class="keyword1">else</span> <span class="main">(</span>I <span class="main">(</span>max_option False <span class="free"><span class="bound"><span class="entity">l1</span></span></span> <span class="free"><span class="bound"><span class="entity">l2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">h1</span></span></span><span class="main">,</span> I <span class="free"><span class="bound"><span class="entity">l2</span></span></span> <span class="main">(</span>min_option True <span class="free"><span class="bound"><span class="entity">h1</span></span></span> <span class="free"><span class="bound"><span class="entity">h2</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Val_abs
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_ivl</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> γ_ivl_def le_ivl_def le_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_ivl_def Top_ivl_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_ivl_def num_ivl_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_ivl_def plus_ivl_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Val_abs1_gamma
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_ivl</span>
<span class="keyword2"><span class="keyword">defines</span></span> aval_ivl <span class="main">=</span> <span class="quoted">aval'</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_ivl_def meet_ivl_def empty_def min_option_def max_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bot_ivl_def γ_ivl_def empty_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mono_minus_ivl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i1</span> <span class="main">⊑</span> <span class="free">i1'</span> <span class="main">⟹</span> <span class="free">i2</span> <span class="main">⊑</span> <span class="free">i2'</span> <span class="main">⟹</span> minus_ivl <span class="free">i1</span> <span class="free">i2</span> <span class="main">⊑</span> minus_ivl <span class="free">i1'</span> <span class="free">i2'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_ivl_def empty_def le_ivl_def le_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">global_interpretation</span></span> Val_abs1
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> test_num' <span class="main">=</span> <span class="quoted">in_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> filter_plus' <span class="main">=</span> <span class="quoted">filter_plus_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> filter_less' <span class="main">=</span> <span class="quoted">filter_less_ivl</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> γ_ivl_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_plus_ivl_def<span class="main">)</span>
      <span class="main">(</span><span class="operator">metis</span> gamma_minus_ivl add_diff_cancel add.commute<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 _ _ <span class="skolem">a1</span> <span class="skolem">a2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">a2</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> γ_ivl_def min_option_def max_option_def le_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int1
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> test_num' <span class="main">=</span> <span class="quoted">in_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> filter_plus' <span class="main">=</span> <span class="quoted">filter_plus_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> filter_less' <span class="main">=</span> <span class="quoted">filter_less_ivl</span>
<span class="keyword2"><span class="keyword">defines</span></span> afilter_ivl <span class="main">=</span> <span class="quoted">afilter</span>
<span class="keyword2"><span class="keyword">and</span></span> bfilter_ivl <span class="main">=</span> <span class="quoted">bfilter</span>
<span class="keyword2"><span class="keyword">and</span></span> step_ivl <span class="main">=</span> <span class="quoted">step'</span>
<span class="keyword2"><span class="keyword">and</span></span> AI_ivl <span class="main">=</span> <span class="quoted">AI</span>
<span class="keyword2"><span class="keyword">and</span></span> aval_ivl' <span class="main">=</span> <span class="quoted">aval''</span>
<span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Monotonicity:›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int1_mono
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> test_num' <span class="main">=</span> <span class="quoted">in_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> filter_plus' <span class="main">=</span> <span class="quoted">filter_plus_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> filter_less' <span class="main">=</span> <span class="quoted">filter_less_ivl</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_ivl_def le_ivl_def le_option_def empty_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits ivl.splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_plus_ivl_def le_prod_def mono_meet mono_minus_ivl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">a1</span> <span class="skolem">b1</span> <span class="skolem">a2</span> <span class="skolem">b2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b1</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">a2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_prod_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_def le_ivl_def le_option_def min_option_def max_option_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Tests"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test1_ivl<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Better than <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>AI_const›</span></span></span></span>:›</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test3_const<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test4_const<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test6_const<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test2_ivl<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test2_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test2_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test2_ivl<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Fixed point reached in 2 steps. Not so if the start value of x is known:›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test3_ivl<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Takes as many iterations as the actual execution. Would diverge if
loop did not terminate. Worse still, as the following example shows: even if
the actual execution terminates, the analysis may not. The value of y keeps
decreasing as the analysis is iterated, no matter how long:›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">50</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test4_ivl<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Relationships between variables are NOT captured:›</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl test5_ivl<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Again, the analysis would not terminate:›</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">50</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_ivl<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_Int3">
<div class="head">
<h1>Theory Abs_Int3</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Widening and Narrowing"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int3
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_Int2_ivl.html">Abs_Int2_ivl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">class</span></span> WN <span class="main">=</span> SL_top <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">widen</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">∇</span></span></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> widen1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main"><span class="free">∇</span></span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> widen2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main"><span class="free">∇</span></span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">narrow</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1">△</span></span></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">assumes</span></span> narrow1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main"><span class="free">△</span></span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> narrow2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main"><span class="free">△</span></span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Intervals"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ivl <span class="main">::</span> <span class="quoted">WN</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">widen_ivl</span></span> <span class="free"><span class="bound"><span class="entity">ivl1</span></span></span> <span class="free"><span class="bound"><span class="entity">ivl2</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="comment1">⌦‹if is_empty ivl1 then ivl2 else
   if is_empty ivl2 then ivl1 else›</span>
     <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ivl1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ivl2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>I <span class="bound">l1</span> <span class="bound">h1</span><span class="main">,</span> I <span class="bound">l2</span> <span class="bound">h2</span><span class="main">)</span> <span class="main">⇒</span>
       I <span class="main">(</span><span class="keyword1">if</span> le_option False <span class="bound">l2</span> <span class="bound">l1</span> <span class="main">∧</span> <span class="bound">l2</span> <span class="main">≠</span> <span class="bound">l1</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="bound">l1</span><span class="main">)</span>
         <span class="main">(</span><span class="keyword1">if</span> le_option True <span class="bound">h1</span> <span class="bound">h2</span> <span class="main">∧</span> <span class="bound">h1</span> <span class="main">≠</span> <span class="bound">h2</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="bound">h1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">narrow_ivl</span></span> <span class="free"><span class="bound"><span class="entity">ivl1</span></span></span> <span class="free"><span class="bound"><span class="entity">ivl2</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="comment1">⌦‹if is_empty ivl1 ∨ is_empty ivl2 then empty else›</span>
     <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ivl1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ivl2</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>I <span class="bound">l1</span> <span class="bound">h1</span><span class="main">,</span> I <span class="bound">l2</span> <span class="bound">h2</span><span class="main">)</span> <span class="main">⇒</span>
       I <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l1</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="bound">l2</span> <span class="keyword1">else</span> <span class="bound">l1</span><span class="main">)</span>
         <span class="main">(</span><span class="keyword1">if</span> <span class="bound">h1</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="bound">h2</span> <span class="keyword1">else</span> <span class="bound">h1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="keyword1"><span class="command">qed</span></span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen_ivl_def narrow_ivl_def le_option_def le_ivl_def empty_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split if_splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Abstract State"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> st <span class="main">::</span> <span class="main">(</span><span class="quoted">WN</span><span class="main">)</span><span class="quoted">WN</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">widen_st</span></span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="main">=</span>
  FunDom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fun <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="bound">x</span> <span class="main">∇</span> fun <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inter_list <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F1</span></span></span><span class="main">)</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">narrow_st</span></span> <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="main">=</span>
  FunDom <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fun <span class="free"><span class="bound"><span class="entity">F1</span></span></span> <span class="bound">x</span> <span class="main">△</span> fun <span class="free"><span class="bound"><span class="entity">F2</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>inter_list <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F1</span></span></span><span class="main">)</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">F2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen_st_def le_st_def lookup_def widen1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen_st_def le_st_def lookup_def widen2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> narrow_st_def le_st_def lookup_def narrow1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> narrow_st_def le_st_def lookup_def narrow2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Option"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> option <span class="main">::</span> <span class="main">(</span><span class="quoted">WN</span><span class="main">)</span><span class="quoted">WN</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">widen_option</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"None <span class="main">∇</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∇</span> None <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∇</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∇</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">narrow_option</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"None <span class="main">△</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">△</span> None <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">△</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">△</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> widen_option.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> widen_option.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> narrow_option.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> narrow1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> narrow_option.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> narrow2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Annotated commands"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map2_acom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SKIP</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x'</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c1'</span></span></span><span class="main">;;</span><span class="free"><span class="bound"><span class="entity">c2'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span><span class="main">;;</span> <span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c1</span></span></span> <span class="free"><span class="bound"><span class="entity">c1'</span></span></span> <span class="keyword1">ELSE</span> <span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c2</span></span></span> <span class="free"><span class="bound"><span class="entity">c2'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">a3</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">a4</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span><span class="main">}</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free">map2_acom</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a4</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">widen_acom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>WN<span class="main">)</span>acom <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">widen_acom</span> <span class="main">==</span> map2_acom <span class="main">(∇)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">narrow_acom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>WN<span class="main">)</span>acom <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span>"</span> 65<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">narrow_acom</span> <span class="main">==</span> map2_acom <span class="main">(△)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> widen1_acom<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> strip <span class="free">c'</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> widen2_acom<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c</span> <span class="main">=</span> strip <span class="free">c'</span> <span class="main">⟹</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> widen2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> narrow1_acom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> narrow1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> narrow2_acom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_acom.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> narrow2<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Post-fixed point computation"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iter_widen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>WN<span class="main">)</span>acom option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iter_widen</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iter_narrow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>WN acom option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iter_narrow</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> while_option <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pfp_wn</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>WN<span class="main">)</span>option acom <span class="main">⇒</span> <span class="tfree">'a</span> option acom<span class="main">)</span> <span class="main">⇒</span> com <span class="main">⇒</span> <span class="tfree">'a</span> option acom option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pfp_wn</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> iter_widen <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
                     <span class="main">|</span> Some <span class="bound">c'</span> <span class="main">⇒</span> iter_narrow <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">c'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip_map2_acom<span class="main">:</span>
 <span class="quoted"><span class="quoted">"strip <span class="free">c1</span> <span class="main">=</span> strip <span class="free">c2</span> <span class="main">⟹</span> strip<span class="main">(</span>map2_acom <span class="free">f</span> <span class="free">c1</span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2_acom.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> iter_widen_pfp<span class="main">:</span> <span class="quoted"><span class="quoted">"iter_widen <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_widen_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> while_option_stop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_while<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">.</span> strip <span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"while_option <span class="free">P</span> <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strip <span class="free">c'</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c'</span><span class="main">.</span> strip <span class="bound">c'</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_iter_widen<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>WN acom <span class="main">⇒</span> <span class="tfree">'a</span> acom"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">.</span> strip <span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iter_widen <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"strip <span class="free">c'</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">.</span> strip<span class="main">(</span><span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> strip_map2_acom<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> strip_while<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_widen_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_narrow_pfp<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mono <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">c0</span> <span class="main">⊑</span> <span class="free">c0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iter_narrow <span class="free">f</span> <span class="free">c0</span> <span class="main">=</span> Some <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">∧</span> <span class="free">c</span> <span class="main">⊑</span> <span class="free">c0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">c</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> conjunct1<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="main">=</span> conjunct2<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?c'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="var">?c'</span> <span class="main">⊑</span> <span class="free">f</span> <span class="skolem">c</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹mono <span class="free">f</span>›</span></span> narrow2_acom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊑</span> <span class="var">?c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> narrow1_acom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="var">?c'</span> <span class="main">⊑</span> <span class="var">?c'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c'</span> <span class="main">⊑</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> narrow2_acom<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> <span class="free">c0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c'</span> <span class="main">⊑</span> <span class="free">c0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">,</span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span> iter_narrow_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    assms<span class="main">(</span>2<span class="main">)</span> le_refl
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pfp_wn_pfp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mono <span class="free">f</span><span class="main">;</span>  pfp_wn <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> pfp_wn_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> iter_widen_pfp iter_narrow_pfp <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_pfp_wn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">c</span><span class="main">.</span> strip<span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span><span class="main">;</span> pfp_wn <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟧</span> <span class="main">⟹</span> strip <span class="free">c'</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pfp_wn_def iter_narrow_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> strip_map2_acom strip_while strip_bot_acom strip_iter_widen<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> Abs_Int2 <span class="main">=</span> Abs_Int1_mono
<span class="keyword2"><span class="keyword">where</span></span> γ<span class="main">=</span><span class="quoted"><span class="free">γ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'av</span><span class="main">::</span><span class="main">{</span>WN<span class="main">,</span>L_top_bot<span class="main">}</span> <span class="main">⇒</span> val set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AI_wn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"com <span class="main">⇒</span> <span class="tfree">'av</span> st option acom option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">AI_wn</span> <span class="main">=</span> pfp_wn <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> AI_wn_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"AI_wn <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟹</span> CS <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CS_def AI_wn_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"pfp_wn <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> pfp_wn_pfp<span class="main">[</span><span class="operator">OF</span> mono_step'2 1<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"step' <span class="main">⊤</span> <span class="free">c'</span> <span class="main">⊑</span> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_pfp_wn<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_lowerbound<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">,</span></span><span class="operator">OF</span> 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"step UNIV <span class="main">(</span>γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> step_preserves_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">⊆</span> γ<span class="hidden">⇩</span><sub>o</sub> <span class="main">⊤</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"γ<span class="hidden">⇩</span><sub>c</sub> <span class="main">(</span>step' <span class="main">⊤</span> <span class="free">c'</span><span class="main">)</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_gamma_c<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>step UNIV<span class="main">)</span> <span class="free">c</span> <span class="main">≤</span> γ<span class="hidden">⇩</span><sub>c</sub> <span class="free">c'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mono_gamma_c order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int2
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> test_num' <span class="main">=</span> <span class="quoted">in_ivl</span>
<span class="keyword2"><span class="keyword">and</span></span> filter_plus' <span class="main">=</span> <span class="quoted">filter_plus_ivl</span> <span class="keyword2"><span class="keyword">and</span></span> filter_less' <span class="main">=</span> <span class="quoted">filter_less_ivl</span>
<span class="keyword2"><span class="keyword">defines</span></span> AI_ivl' <span class="main">=</span> <span class="quoted">AI_wn</span>
<span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Tests"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">step_up_ivl</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> step_ivl <span class="main">⊤</span> <span class="bound">c</span><span class="main">)</span><span class="main">^^</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">step_down_ivl</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> step_ivl <span class="main">⊤</span> <span class="bound">c</span><span class="main">)</span><span class="main">^^</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> test3_ivl<span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> AI_ivl<span class="antiquote"><span class="antiquote">}</span></span></span></span> needed as many iterations as
the loop took to execute. In contrast, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> AI_ivl'<span class="antiquote"><span class="antiquote">}</span></span></span></span> converges in a
constant number of steps:›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_up_ivl <span class="main">1</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_up_ivl <span class="numeral">2</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_up_ivl <span class="numeral">3</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_up_ivl <span class="numeral">4</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_up_ivl <span class="numeral">5</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_down_ivl <span class="main">1</span> <span class="main">(</span>step_up_ivl <span class="numeral">5</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_down_ivl <span class="numeral">2</span> <span class="main">(</span>step_up_ivl <span class="numeral">5</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span>step_down_ivl <span class="numeral">3</span> <span class="main">(</span>step_up_ivl <span class="numeral">5</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test3_ivl<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Now all the analyses terminate:›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl' test4_ivl<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl' test5_ivl<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_ivl' test6_ivl<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Termination: Intervals"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">m_ivl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ivl <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m_ivl</span> <span class="free"><span class="bound"><span class="entity">ivl</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ivl</span></span></span> <span class="keyword1">of</span> I <span class="bound">l</span> <span class="bound">h</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="bound">l</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">h</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_ivl_height<span class="main">:</span> <span class="quoted"><span class="quoted">"m_ivl <span class="free">ivl</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_ivl_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m_ivl_anti_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">::</span>ivl<span class="main">)</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> m_ivl <span class="free">x</span> <span class="main">≤</span> m_ivl <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_ivl_def le_option_def le_ivl_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> m_ivl_widen<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">y</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> m_ivl<span class="main">(</span><span class="free">x</span> <span class="main">∇</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> m_ivl <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_ivl_def widen_ivl_def le_option_def le_ivl_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.splits option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Top_less_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">⟹</span> m_ivl <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_ivl_def le_option_def le_ivl_def empty_def Top_ivl_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.split option.split if_splits<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">n_ivl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ivl <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">n_ivl</span> <span class="free"><span class="bound"><span class="entity">ivl</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">-</span> m_ivl <span class="free"><span class="bound"><span class="entity">ivl</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_ivl_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>ivl<span class="main">)</span> <span class="main">⊑</span> <span class="free">y</span> <span class="main">⟹</span> n_ivl <span class="free">x</span> <span class="main">≤</span> n_ivl <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> n_ivl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_le_mono2 m_ivl_anti_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> n_ivl_narrow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">~</span> <span class="free">x</span> <span class="main">⊑</span> <span class="free">x</span> <span class="main">△</span> <span class="free">y</span> <span class="main">⟹</span> n_ivl<span class="main">(</span><span class="free">x</span> <span class="main">△</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> n_ivl <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_ivl_def m_ivl_def narrow_ivl_def le_option_def le_ivl_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ivl.splits option.splits if_splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Termination: Abstract State"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m_st</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set<span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span>fun <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_st_height<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>dom <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"m_st m_ivl <span class="free">S</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_st_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set<span class="main">(</span>dom <span class="free">S</span><span class="main">)</span><span class="main">.</span> m_ivl <span class="main">(</span>fun <span class="free">S</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>set<span class="main">(</span>dom <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>m_ivl_height<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> card <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_st_anti_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S1</span> <span class="main">⊑</span> <span class="free">S2</span> <span class="main">⟹</span> m_st m_ivl <span class="free">S2</span> <span class="main">≤</span> m_st m_ivl <span class="free">S1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_st_def le_st_def lookup_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun <span class="free">S1</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun <span class="free">S2</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?Y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">⟶</span> <span class="var">?f</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="main">∨</span> <span class="main">⊤</span> <span class="main">⊑</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≤</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_ivl_anti_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?Y</span><span class="main">-</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> asm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Top_less_ivl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="var">?Y</span><span class="main">-</span><span class="var">?X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?Y</span><span class="main">∩</span><span class="var">?X</span><span class="main">)</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_Diff_Int<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">-</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.union_disjoint<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">-</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">∩</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_mono2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="keyword1">Int</span> <span class="var">?X</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ Int_lower2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_st_widen<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">S2</span> <span class="main">⊑</span> <span class="free">S1</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"m_st m_ivl <span class="main">(</span><span class="free">S1</span> <span class="main">∇</span> <span class="free">S2</span><span class="main">)</span> <span class="main">&lt;</span> m_st m_ivl <span class="free">S1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun <span class="free">S1</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fun <span class="free">S2</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> lookup <span class="free">S2</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="var">?f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">∩</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span> <span class="main">∇</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&lt;</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">:</span> <span class="var">?Y</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">∩</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sum_strict_mono_ex1<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">∩</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span> <span class="main">∇</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> m_ivl <span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> m_ivl_anti_mono widen1<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">∩</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span> <span class="main">∇</span> <span class="var">?g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">:</span><span class="var">?X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">:</span><span class="var">?Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> lookup <span class="free">S2</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="var">?f</span> <span class="skolem">x</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI m_ivl_widen lookup_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_mono2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Int_lower1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">~:</span> <span class="var">?Y</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">∩</span><span class="var">?Y</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">:</span><span class="var">?X</span> <span class="main">∧</span> <span class="skolem">x</span><span class="main">:</span><span class="var">?Y</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"m_ivl<span class="main">(</span><span class="var">?f</span> <span class="skolem">x</span> <span class="main">∇</span> <span class="var">?g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> m_ivl <span class="main">(</span><span class="var">?f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> m_ivl_anti_mono widen1<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_ivl_widen<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> lookup <span class="free">S2</span> <span class="skolem">x</span> <span class="main">⊑</span> <span class="var">?f</span> <span class="skolem">x</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.le_refl add_strict_increasing gr0I not_less0<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>insert <span class="skolem">x</span> <span class="main">(</span><span class="var">?X</span><span class="main">∩</span><span class="var">?Y</span><span class="main">)</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">~:</span> <span class="var">?Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="var">?X</span><span class="main">.</span> m_ivl<span class="main">(</span><span class="var">?f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sum_mono2<span class="main">)</span><span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">:</span><span class="var">?X</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def widen_st_def m_st_def Int_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_st</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span>lookup <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_st_mono<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S1</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S2</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S1</span> <span class="main">⊑</span> <span class="free">S2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"n_st n_ivl <span class="free">X</span> <span class="free">S1</span> <span class="main">≤</span> n_st n_ivl <span class="free">X</span> <span class="free">S2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> n_ivl<span class="main">(</span>lookup <span class="free">S1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> n_ivl<span class="main">(</span>lookup <span class="free">S2</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def lookup_def n_ivl_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_st_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_st_narrow<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S1</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"set<span class="main">(</span>dom <span class="free">S2</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S2</span> <span class="main">⊑</span> <span class="free">S1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">S1</span> <span class="main">⊑</span> <span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"n_st n_ivl <span class="free">X</span> <span class="main">(</span><span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span><span class="main">)</span> <span class="main">&lt;</span> n_st n_ivl <span class="free">X</span> <span class="free">S1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> n_ivl <span class="main">(</span>lookup <span class="main">(</span><span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> n_ivl <span class="main">(</span>lookup <span class="free">S1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def narrow_st_def lookup_def n_ivl_mono narrow2
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> n_ivl <span class="main">(</span>lookup <span class="main">(</span><span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&lt;</span> n_ivl <span class="main">(</span>lookup <span class="free">S1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_st_def narrow_st_def lookup_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> n_ivl_narrow
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> n_ivl<span class="main">(</span>lookup <span class="main">(</span><span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> n_ivl<span class="main">(</span>lookup <span class="free">S1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_strict_mono_ex1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">X</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_st_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Termination: Option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m_o</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">+</span><span class="main">1</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_o_anti_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> domo <span class="free">S2</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">⊑</span> <span class="free">S2</span> <span class="main">⟹</span>
  m_o <span class="main">(</span>m_st m_ivl<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="free">X</span><span class="main">)</span> <span class="free">S2</span> <span class="main">≤</span> m_o <span class="main">(</span>m_st m_ivl<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="free">X</span><span class="main">)</span> <span class="free">S1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_option.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def m_o_def m_st_anti_mono le_SucI m_st_height
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> m_o_widen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">X</span><span class="main">;</span> domo <span class="free">S2</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">;</span> <span class="main">¬</span> <span class="free">S2</span> <span class="main">⊑</span> <span class="free">S1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  m_o <span class="main">(</span>m_st m_ivl<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">S1</span> <span class="main">∇</span> <span class="free">S2</span><span class="main">)</span> <span class="main">&lt;</span> m_o <span class="main">(</span>m_st m_ivl<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> card <span class="free">X</span><span class="main">)</span> <span class="free">S1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_o_def domo_def m_st_height less_Suc_eq_le m_st_widen
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">n_o</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">opt</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">x</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_o_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"domo <span class="free">S1</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> domo <span class="free">S2</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">S1</span> <span class="main">⊑</span> <span class="free">S2</span> <span class="main">⟹</span>
  n_o <span class="main">(</span>n_st n_ivl <span class="free">X</span><span class="main">)</span> <span class="free">S1</span> <span class="main">≤</span> n_o <span class="main">(</span>n_st n_ivl <span class="free">X</span><span class="main">)</span> <span class="free">S2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_option.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def n_o_def n_st_mono
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> n_o_narrow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">X</span><span class="main">;</span> domo <span class="free">S1</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">;</span> domo <span class="free">S2</span> <span class="main">⊆</span> <span class="free">X</span><span class="main">;</span> <span class="free">S2</span> <span class="main">⊑</span> <span class="free">S1</span><span class="main">;</span> <span class="main">¬</span> <span class="free">S1</span> <span class="main">⊑</span> <span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span> <span class="main">⟧</span>
  <span class="main">⟹</span> n_o <span class="main">(</span>n_st n_ivl <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span><span class="main">)</span> <span class="main">&lt;</span> n_o <span class="main">(</span>n_st n_ivl <span class="free">X</span><span class="main">)</span> <span class="free">S1</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> narrow_option.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> n_o_def domo_def n_st_narrow<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> domo_widen_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domo <span class="main">(</span><span class="free">S1</span> <span class="main">∇</span> <span class="free">S2</span><span class="main">)</span> <span class="main">⊆</span> domo <span class="free">S1</span> <span class="main">∪</span> domo <span class="free">S2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> widen_option.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def widen_st_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> domo_narrow_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"domo <span class="main">(</span><span class="free">S1</span> <span class="main">△</span> <span class="free">S2</span><span class="main">)</span> <span class="main">⊆</span> domo <span class="free">S1</span> <span class="main">∪</span> domo <span class="free">S2</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S1</span></span> <span class="quoted"><span class="free">S2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> narrow_option.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def narrow_st_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Termination: Commands"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> strip_widen_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c'</span> <span class="main">=</span> strip <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>WN acom<span class="main">)</span> <span class="main">⟹</span>  strip <span class="main">(</span><span class="free">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"widen<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2_acom.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> strip_narrow_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip <span class="free">c'</span> <span class="main">=</span> strip <span class="main">(</span><span class="free">c</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>WN acom<span class="main">)</span> <span class="main">⟹</span>  strip <span class="main">(</span><span class="free">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> strip <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"narrow<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2_acom.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> annos_widen_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c1</span> <span class="main">=</span> strip <span class="main">(</span><span class="free">c2</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>WN acom<span class="main">)</span> <span class="main">⟹</span>
  annos<span class="main">(</span><span class="free">c1</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="bound">x</span><span class="main">∇</span><span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>annos <span class="free">c1</span><span class="main">)</span> <span class="main">(</span>annos<span class="main">(</span><span class="free">c2</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>WN acom<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"widen<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2_acom.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_annos_same2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> annos_narrow_acom<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c1</span> <span class="main">=</span> strip <span class="main">(</span><span class="free">c2</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>WN acom<span class="main">)</span> <span class="main">⟹</span>
  annos<span class="main">(</span><span class="free">c1</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c2</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">%</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span><span class="bound">x</span><span class="main">△</span><span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>annos <span class="free">c1</span><span class="main">)</span> <span class="main">(</span>annos<span class="main">(</span><span class="free">c2</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>WN acom<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"narrow<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="quoted"><span class="free">c1</span></span> <span class="quoted"><span class="free">c2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2_acom.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_annos_same2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> widen_acom_Com<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c2</span> <span class="main">=</span> strip <span class="free">c1</span> <span class="main">⟹</span>
  <span class="free">c1</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c1</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c2</span><span class="main">)</span> <span class="main">:</span> Com <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> S S' x<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> in_set_zipE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> widen_st_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> narrow_acom_Com<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strip <span class="free">c2</span> <span class="main">=</span> strip <span class="free">c1</span> <span class="main">⟹</span>
  <span class="free">c1</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">⟹</span> <span class="free">c2</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c1</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c2</span><span class="main">)</span> <span class="main">:</span> Com <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Com_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rename_tac</span> S S' x<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> in_set_zipE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domo_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">S'</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> narrow_st_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m_c</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">as</span> <span class="main">=</span> annos <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">in</span> <span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="main">0</span><span class="main">..&lt;</span>size <span class="bound">as</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">(</span><span class="bound">as</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measure_m_c<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c'</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">::</span>ivl st option acom<span class="main">.</span>
     strip <span class="bound">c'</span> <span class="main">=</span> strip <span class="bound">c</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">∧</span> <span class="bound">c'</span> <span class="main">:</span> Com <span class="free">X</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">c'</span> <span class="main">⊑</span> <span class="bound">c</span><span class="main">}</span><span class="main">¯</span>
    <span class="main">⊆</span> measure<span class="main">(</span>m_c<span class="main">(</span>m_o <span class="main">(</span>m_st m_ivl<span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>card<span class="main">(</span><span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_c_def Let_def Com_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"length<span class="main">(</span>annos <span class="improper">c'</span><span class="main">)</span> <span class="main">=</span> length<span class="main">(</span>annos <span class="improper">c</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_annos_same2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_strict_mono_ex1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> m_o_anti_mono<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> domo_widen_subset<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> widen1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_le_annos listrel_iff_nth<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> m_o_widen<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> measure_n_c<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c'</span><span class="main">)</span> <span class="main">|</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span>
  strip <span class="bound">c</span> <span class="main">=</span> strip <span class="bound">c'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">∈</span> Com <span class="free">X</span> <span class="main">∧</span> <span class="bound">c'</span> <span class="main">∈</span> Com <span class="free">X</span> <span class="main">∧</span> <span class="bound">c'</span> <span class="main">⊑</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c'</span><span class="main">}</span><span class="main">¯</span>
  <span class="main">⊆</span> measure<span class="main">(</span>m_c<span class="main">(</span>n_o <span class="main">(</span>n_st n_ivl <span class="free">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_c_def Let_def Com_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"length<span class="main">(</span>annos <span class="improper">c'</span><span class="main">)</span> <span class="main">=</span> length<span class="main">(</span>annos <span class="improper">c</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_annos_same2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> sum_strict_mono_ex1<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> n_o_mono<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> domo_narrow_subset <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> narrow2<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_le_annos listrel_iff_nth<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_iff_le_annos listrel_iff_nth<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> n_o_narrow<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Termination: Post-Fixed Point Iterations"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_widen_termination<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>WN acom"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> P_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> P_widen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">c'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">(</span><span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf<span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">::</span><span class="tfree">'a</span> acom<span class="main">,</span><span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="bound">c'</span><span class="main">)</span><span class="main">|</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="main">~</span> <span class="bound">c'</span> <span class="main">⊑</span> <span class="bound">c</span><span class="main">}</span><span class="main">^-1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c0</span> <span class="main">⊑</span> <span class="free">f</span> <span class="free">c0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> iter_widen <span class="free">f</span> <span class="free">c0</span> <span class="main">=</span> Some <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_widen_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_while_option_Some<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">cc'</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">f</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">cc'</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> P_f<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c0</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">c</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_f P_widen<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_narrow_termination<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> P_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">(</span><span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf<span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">)</span><span class="main">|</span><span class="bound">c</span> <span class="bound">c'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">~</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">}</span><span class="main">^-1</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> iter_narrow <span class="free">f</span> <span class="free">c0</span> <span class="main">=</span> Some <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_narrow_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wf_while_option_Some<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">c</span> <span class="main">⊑</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">c'</span> <span class="main">=</span> <span class="bound">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> P_f<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">c0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="free">c0</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">c</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">c</span> <span class="keyword1">△<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P_f<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_winden_step_ivl_termination<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">.</span> iter_widen <span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">c0</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iter_widen_termination<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
  P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">%</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> strip <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">c0</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">:</span></span> Com<span class="main"><span class="main">(</span></span>vars <span class="free"><span class="free">c0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step'_Com bot_acom<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_measure<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_m_c<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"vars <span class="free"><span class="free">c0</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> finite_cvars<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_narrow_step_ivl_termination<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c0</span> <span class="main">∈</span> Com <span class="main">(</span>vars<span class="main">(</span>strip <span class="free">c0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> step_ivl <span class="main">⊤</span> <span class="free">c0</span> <span class="main">⊑</span> <span class="free">c0</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">c</span><span class="main">.</span> iter_narrow <span class="main">(</span>step_ivl <span class="main">⊤</span><span class="main">)</span> <span class="free">c0</span> <span class="main">=</span> Some <span class="bound">c</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iter_narrow_termination<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
  P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">%</span></span><span class="bound"><span class="bound">c</span></span><span class="main"><span class="main">.</span></span> strip <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">=</span></span> strip <span class="free"><span class="free">c0</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">:</span></span> Com<span class="main"><span class="main">(</span></span>vars<span class="main"><span class="main">(</span></span>strip <span class="free"><span class="free">c0</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> step_ivl <span class="main"><span class="main">⊤</span></span> <span class="bound"><span class="bound">c</span></span> <span class="main"><span class="main">⊑</span></span> <span class="bound"><span class="bound">c</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step'_Com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> narrow2_acom<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mono_step'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_refl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ narrow1_acom<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_subset<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> wf_measure<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> subset_trans<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> measure_n_c<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"vars<span class="main"><span class="main">(</span></span>strip <span class="free"><span class="free">c0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> finite_cvars<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_least domo_Top order_refl step'_Com strip_step'<span class="main">)</span>

<span class="comment1">(* FIXME: simplify type system: Combine Com(X) and vars &lt;= X?? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> while_Com<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> st option acom"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"while_option <span class="free">P</span> <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">c</span><span class="main">.</span> strip<span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">::</span><span class="tfree">'a</span> st option acom<span class="main">.</span> <span class="bound">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span> <span class="main">⟶</span> vars<span class="main">(</span>strip <span class="bound">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vars<span class="main">(</span>strip <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> while_option_rule<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c'</span><span class="main">.</span> <span class="bound">c'</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span> <span class="main">∧</span> vars<span class="main">(</span>strip <span class="bound">c'</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2-<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iter_widen_Com<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>WN st option acom <span class="main">⇒</span> <span class="tfree">'a</span> st option acom"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iter_widen <span class="free">f</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span> <span class="main">⟶</span> vars<span class="main">(</span>strip <span class="bound">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">c</span><span class="main">.</span> strip<span class="main">(</span><span class="free">f</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> strip <span class="bound">c</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>strip <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c'</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span> <span class="main">⟶</span> vars<span class="main">(</span>strip <span class="bound">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="keyword1">∇<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">f</span> <span class="bound">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> widen_acom_Com assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> while_Com<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">simplified</span> iter_widen_def<span class="main"><span class="main">]</span></span> _ this assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">context</span></span> Abs_Int2
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iter_widen_step'_Com<span class="main">:</span>
  <span class="quoted"><span class="quoted">"iter_widen <span class="main">(</span>step' <span class="main">⊤</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> Some <span class="free">c'</span> <span class="main">⟹</span> vars<span class="main">(</span>strip <span class="free">c</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>
   <span class="main">⟹</span> <span class="free">c'</span> <span class="main">:</span> Com<span class="main">(</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"strip <span class="free">c'</span><span class="main">=</span> strip <span class="free">c</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> strip_iter_widen strip_step'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> iter_widen_Com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> step'_Com<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">theorem</span></span> AI_ivl'_termination<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> AI_ivl' <span class="free">c</span> <span class="main">=</span> Some <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> AI_wn_def pfp_wn_def iter_winden_step_ivl_termination <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iter_narrow_step_ivl_termination<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bot_acom_Com iter_widen_step'_Com<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ subset_refl<span class="main"><span class="main">]</span></span> strip_iter_widen strip_step'<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> iter_widen_pfp<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="comment1">(* interesting(?) relic
lemma widen_assoc:
  "~ (y::ivl) ⊑ x ⟹ ~ z ⊑ x ∇ y ⟹ ((x::ivl) ∇ y) ∇ z = x ∇ (y ∇ z)"
apply(cases x)
apply(cases y)
apply(cases z)
apply(rename_tac x1 x2 y1 y2 z1 z2)
apply(simp add: le_ivl_def)
apply(case_tac x1)
apply(case_tac x2)
apply(simp add:le_option_def widen_ivl_def split: if_splits option.splits)
apply(simp add:le_option_def widen_ivl_def split: if_splits option.splits)
apply(case_tac x2)
apply(simp add:le_option_def widen_ivl_def split: if_splits option.splits)
apply(case_tac y1)
apply(case_tac y2)
apply(simp add:le_option_def widen_ivl_def split: if_splits option.splits)
apply(case_tac z1)
apply(auto simp add:le_option_def widen_ivl_def split: if_splits option.splits ivl.splits)[1]
apply(auto simp add:le_option_def widen_ivl_def split: if_splits option.splits ivl.splits)[1]
apply(case_tac y2)
apply(auto simp add:le_option_def widen_ivl_def split: if_splits option.splits ivl.splits)[1]
apply(case_tac z1)
apply(auto simp add:le_option_def widen_ivl_def split: if_splits ivl.splits option.splits)[1]
apply(case_tac z2)
apply(auto simp add:le_option_def widen_ivl_def split: if_splits option.splits)[1]
apply(auto simp add:le_option_def widen_ivl_def split: if_splits option.splits)[1]
done

lemma widen_step_trans:
  "~ (y::ivl) ⊑ x ⟹ ~ z ⊑ x ∇ y ⟹ ∃u. (x ∇ y) ∇ z = x ∇ u ∧ ~ u ⊑ x"
by (metis widen_assoc preord_class.le_trans widen1)
*)</span>
</pre>
</div><div id="Abs_Int1_const">
<div class="head">
<h1>Theory Abs_Int1_const</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int1_const
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_Int1.html">Abs_Int1</a> <span class="quoted">"<a href="../../HOL/HOL-IMP/Abs_Int_Tests.html">HOL-IMP.Abs_Int_Tests</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Constant Propagation"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> const <span class="main">=</span> Const <span class="quoted">val</span> <span class="main">|</span> Any

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">γ_const</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">γ_const</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">γ_const</span> <span class="main">(</span>Any<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">plus_const</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">plus_const</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Const<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_const</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Any"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_const_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"plus_const <span class="free">a1</span> <span class="free">a2</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">a1</span><span class="main">,</span><span class="free">a2</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>Const <span class="bound">m</span><span class="main">,</span> Const <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> Const<span class="main">(</span><span class="bound">m</span><span class="main">+</span><span class="bound">n</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Any<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split const.split<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> const <span class="main">::</span> <span class="quoted">SL_top</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">le_const</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⊑</span> Any <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"Const <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⊑</span> Const <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"Any <span class="main">⊑</span> Const <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">join_const</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"Const <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⊔</span> Const <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">then</span> Const <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">else</span> Any<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⊔</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Any"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> Any"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_const_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">global_interpretation</span></span> Val_abs
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_const</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">Const</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_const</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Top_const_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_const_cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> const.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_const</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">Const</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_const</span>
<span class="keyword2"><span class="keyword">defines</span></span> AI_const <span class="main">=</span> <span class="quoted">AI</span> <span class="keyword2"><span class="keyword">and</span></span> step_const <span class="main">=</span> <span class="quoted">step'</span> <span class="keyword2"><span class="keyword">and</span></span> aval'_const <span class="main">=</span> <span class="quoted">aval'</span>
<span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Tests"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test1_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test1_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test1_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test1_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_const test1_const<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_const test2_const<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_const test3_const<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test4_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test4_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test4_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test4_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_const test4_const<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test5_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test5_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test5_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test5_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test5_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">5</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test5_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_const test5_const<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">3</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">5</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">6</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">7</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">8</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">9</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">10</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span><span class="main">(</span>step_const <span class="main">⊤</span><span class="main">)</span><span class="main">^^</span><span class="numeral">11</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">⊥<span class="hidden">⇩</span><sub>c</sub></span> test6_const<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_const test6_const<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Monotonicity:›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int_mono
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_const</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">Const</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_const</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_const_cases <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> const.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Termination:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m_const</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> Const <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Any <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measure_const<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>strict<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>const<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">^-1</span> <span class="main">⊆</span> measure m_const"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_const_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> const.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> measure_const_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>const<span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="bound">x</span> <span class="main">⟶</span> m_const <span class="bound">x</span> <span class="main">=</span> m_const <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_const_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> const.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> AI_const <span class="free">c</span> <span class="main">=</span> Some <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> AI_Some_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measure_const measure_const_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Abs_Int1_parity">
<div class="head">
<h1>Theory Abs_Int1_parity</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Tobias Nipkow *)</span>

<span class="keyword1"><span class="command">theory</span></span> Abs_Int1_parity
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Abs_Int1.html">Abs_Int1</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Parity Analysis"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> parity <span class="main">=</span> Even <span class="main">|</span> Odd <span class="main">|</span> Either

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Instantiation of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> preord<span class="antiquote"><span class="antiquote">}</span></span></span></span> with type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">parity</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> parity <span class="main">::</span> <span class="quoted">preord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First the definition of the interface function <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊑›</span></span></span></span>. Note that
the header of the definition must refer to the ascii name <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> le<span class="antiquote"><span class="antiquote">}</span></span></span></span> of the
constants as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>le_parity›</span></span></span></span> and the definition is named <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>le_parity_def›</span></span></span></span>.  Inside the definition the symbolic names can be used.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">le_parity</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> Either <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Now the instance proof, i.e.\ the proof that the definition fulfills
the axioms (assumptions) of the class. The initial proof-step generates the
necessary proof obligations.›</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">parity</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">parity</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊑</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Instantiation of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> SL_top<span class="antiquote"><span class="antiquote">}</span></span></span></span> with type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">parity</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> parity <span class="main">::</span> <span class="quoted">SL_top</span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">join_parity</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⊑</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> Either<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">Top_parity</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">=</span> Either"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Now the instance proof. This time we take a lazy shortcut: we do not
write out the proof obligations but use the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>goali›</span></span></span></span> primitive to refer
to the assumptions of subgoal i and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>case?›</span></span></span></span> to refer to the
conclusion of subgoal i. The class axioms are presented in the same order as
in the class definition.›</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="comment1">(*join1*)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def join_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="comment1">(*join2*)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def join_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="comment1">(*join least*)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def join_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4 <span class="comment1">(*Top*)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def Top_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Now we define the functions used for instantiating the abstract
interpretation locales. Note that the Isabelle terminology is
\emph{interpretation}, not \emph{instantiation} of locales, but we use
instantiation to avoid confusion with abstract interpretation.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">γ_parity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parity <span class="main">⇒</span> val set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">γ_parity</span> Even <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">γ_parity</span> Odd  <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">γ_parity</span> Either <span class="main">=</span> UNIV"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">num_parity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"val <span class="main">⇒</span> parity"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">num_parity</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Even <span class="keyword1">else</span> Odd<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">plus_parity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parity <span class="main">⇒</span> parity <span class="main">⇒</span> parity"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">plus_parity</span> Even Even <span class="main">=</span> Even"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_parity</span> Odd  Odd  <span class="main">=</span> Even"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_parity</span> Even Odd  <span class="main">=</span> Odd"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_parity</span> Odd  Even <span class="main">=</span> Odd"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_parity</span> Either <span class="free"><span class="bound"><span class="entity">y</span></span></span>  <span class="main">=</span> Either"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">plus_parity</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Either  <span class="main">=</span> Either"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹First we instantiate the abstract value interface and prove that the
functions on type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">parity</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> have all the necessary properties:›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> Val_abs
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_parity</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_parity</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_parity</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span> <span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹of the locale axioms›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted">parity</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊑</span> <span class="skolem">b</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"γ_parity <span class="skolem">a</span> <span class="main">⊆</span> γ_parity <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> <span class="keyword1"><span class="command">txt</span></span><span class="quoted"><span class="plain_text">‹The rest in the lazy, implicit way›</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Top_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 _ <span class="skolem">a1</span> _ <span class="skolem">a2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a1</span></span> <span class="quoted"><span class="skolem">a2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parity.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> parity.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">presburger</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Instantiating the abstract interpretation locale requires no more
proofs (they happened in the instatiation above) but delivers the
instantiated abstract interpreter which we call AI:›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_parity</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_parity</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_parity</span>
<span class="keyword2"><span class="keyword">defines</span></span> aval_parity <span class="main">=</span> <span class="quoted">aval'</span> <span class="keyword2"><span class="keyword">and</span></span> step_parity <span class="main">=</span> <span class="quoted">step'</span> <span class="keyword2"><span class="keyword">and</span></span> AI_parity <span class="main">=</span> <span class="quoted">AI</span>
<span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Tests"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test1_parity</span> <span class="main">=</span>
  <span class="inner_quoted">''x''</span> <span class="main">::=</span> N <span class="main">1</span><span class="main">;;</span>
  <span class="keyword1">WHILE</span> Less <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">100</span><span class="main">)</span> <span class="keyword1">DO</span> <span class="inner_quoted">''x''</span> <span class="main">::=</span> Plus <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">2</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_parity test1_parity<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">test2_parity</span> <span class="main">=</span>
  <span class="inner_quoted">''x''</span> <span class="main">::=</span> N <span class="main">1</span><span class="main">;;</span>
  <span class="keyword1">WHILE</span> Less <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">100</span><span class="main">)</span> <span class="keyword1">DO</span> <span class="inner_quoted">''x''</span> <span class="main">::=</span> Plus <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">3</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span>step_parity <span class="main">⊤</span> <span class="main">^^</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>anno None test2_parity<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span>step_parity <span class="main">⊤</span> <span class="main">^^</span><span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>anno None test2_parity<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span>step_parity <span class="main">⊤</span> <span class="main">^^</span><span class="numeral">3</span><span class="main">)</span> <span class="main">(</span>anno None test2_parity<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span>step_parity <span class="main">⊤</span> <span class="main">^^</span><span class="numeral">4</span><span class="main">)</span> <span class="main">(</span>anno None test2_parity<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom <span class="main">(</span><span class="main">(</span>step_parity <span class="main">⊤</span> <span class="main">^^</span><span class="numeral">5</span><span class="main">)</span> <span class="main">(</span>anno None test2_parity<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"show_acom_opt <span class="main">(</span>AI_parity test2_parity<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Termination"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Abs_Int_mono
<span class="keyword2"><span class="keyword">where</span></span> γ <span class="main">=</span> <span class="quoted">γ_parity</span> <span class="keyword2"><span class="keyword">and</span></span> num' <span class="main">=</span> <span class="quoted">num_parity</span> <span class="keyword2"><span class="keyword">and</span></span> plus' <span class="main">=</span> <span class="quoted">plus_parity</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">a1</span> <span class="skolem">a2</span> <span class="skolem">b1</span> <span class="skolem">b2</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a1</span></span> <span class="quoted"><span class="skolem">a2</span></span> <span class="quoted"><span class="skolem">b1</span></span> <span class="quoted"><span class="skolem">b2</span></span>
   <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parity.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> parity.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> parity.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> parity.exhaust<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* FIXME - UGLY! *)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_parity_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">m_parity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"parity <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">m_parity</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">=</span>Either <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> measure_parity<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>strict<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span>parity<span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span><span class="main">^-1</span> <span class="main">⊆</span> measure m_parity"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_parity_def le_parity_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> measure_parity_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">::</span>parity<span class="main">.</span> <span class="bound">x</span> <span class="main">⊑</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊑</span> <span class="bound">x</span> <span class="main">⟶</span> m_parity <span class="bound">x</span> <span class="main">=</span> m_parity <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_parity_def le_parity_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> AI_parity_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c'</span><span class="main">.</span> AI_parity <span class="free">c</span> <span class="main">=</span> Some <span class="bound">c'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> AI_Some_measure<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measure_parity measure_parity_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>