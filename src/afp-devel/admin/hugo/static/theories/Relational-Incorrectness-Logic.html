<div id="RelationalIncorrectness">
<div class="head">
<h1>Theory RelationalIncorrectness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> RelationalIncorrectness
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-IMP/Big_Step.html">HOL-IMP.Big_Step</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Author: Toby Murray *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Under-Approximate Relational Judgement"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This is the relational analogue of OHearn's~\cite{OHearn_19} and de Vries \&amp; Koutavas'~\cite{deVries_Koutavas_11}
  judgements.

  Note that in our case it doesn't really make sense to talk about ``erroneous'' states: the
  presence of an error can be seen only by the violation of a relation. Unlike O'Hearn, we cannot
  encode it directly into the semantics of our programs, without giving them a relational semantics.
  We use the standard big step semantics of IMP unchanged.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> rassn <span class="main">=</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> state <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">ir_valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rassn <span class="main">⇒</span> com <span class="main">⇒</span> com <span class="main">⇒</span> rassn <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ir_valid</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Rules of the Logic"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">flip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rassn <span class="main">⇒</span> rassn"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flip</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s'</span> <span class="bound">s</span>"</span></span>


<span class="keyword1"><span class="command">inductive</span></span>
  <span class="entity">ir_hoare</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rassn <span class="main">⇒</span> com <span class="main">⇒</span> com <span class="main">⇒</span> rassn <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  ir_Skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> SKIP <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_If_True<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> 
                 <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_If_False<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> 
                  <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">THEN</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">ELSE</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_Seq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> SKIP <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">⟹</span> <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Seq <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span> <span class="main">|</span>
  ir_Assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="bound">t</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> aval <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">t</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> SKIP <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span>
              <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Assign <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_While_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span> SKIP <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span>
                  <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_While_True<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">;;</span> <span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span>
                  <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_While_backwards_frontier<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> SKIP <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
                                <span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span>
                                <span class="free">ir_hoare</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">DO</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span> <span class="main">|</span>
  ir_conseq<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q'</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span>
                   <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q'</span></span></span>"</span></span> <span class="main">|</span>
  ir_disj<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">⟹</span> <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">⟹</span>
                   <span class="free">ir_hoare</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">P<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">Q<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  ir_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ir_hoare</span> <span class="main">(</span>flip <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="main">(</span>flip <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ir_hoare</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Simple Derived Rules"</span></span>

<span class="keyword1" id="RelationalIncorrectness-meh_simp"><span class="command">lemma</span></span> meh_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>SKIP<span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span> <span class="main">=</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1" id="RelationalIncorrectness-ir_pre"><span class="command">lemma</span></span> ir_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span>  <span class="main">⟹</span>
                  ir_hoare <span class="free">P'</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> ir_conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_post"><span class="command">lemma</span></span> ir_post<span class="main">:</span> <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q'</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span>  <span class="main">⟹</span>
                  ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> ir_conseq<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Soundness"</span></span>

<span class="keyword1" id="RelationalIncorrectness-Skip_ir_valid"><span class="command">lemma</span></span> Skip_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> SKIP <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-sym_ir_valid"><span class="command">lemma</span></span> sym_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span>flip <span class="free">P</span><span class="main">)</span> <span class="free">c'</span> <span class="free">c</span> <span class="main">(</span>flip <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def flip_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-If_True_ir_valid"><span class="command">lemma</span></span> If_True_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">c</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">a</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="free">P</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-If_False_ir_valid"><span class="command">lemma</span></span> If_False_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">c</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">c</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">a</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="free">P</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-Seq1_ir_valid"><span class="command">lemma</span></span> Seq1_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">Q</span> <span class="free">d</span> SKIP <span class="free">R</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span> <span class="free">d</span><span class="main">)</span> <span class="free">c'</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-Seq2_ir_valid"><span class="command">lemma</span></span> Seq2_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> SKIP <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">Q</span> <span class="free">d</span> <span class="free">c'</span> <span class="free">R</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span> <span class="free">d</span><span class="main">)</span> <span class="free">c'</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-Seq_ir_valid"><span class="command">lemma</span></span> Seq_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">Q</span> <span class="free">d</span> <span class="free">d'</span> <span class="free">R</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span><span class="free">c'</span><span class="main">;;</span> <span class="free">d'</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-Assign_blah"><span class="command">lemma</span></span> Assign_blah<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">x</span> <span class="main">=</span> aval <span class="free">e</span> <span class="main">(</span><span class="free">t</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>
       <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">,</span> <span class="free">t</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Assign 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_triv fun_upd_upd<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-Assign_ir_valid"><span class="command">lemma</span></span> Assign_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span> <span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">t</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> aval <span class="free">e</span> <span class="main">(</span><span class="bound">t</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="main">(</span>Assign <span class="free">x</span> <span class="free">e</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-While_False_ir_valid"><span class="command">lemma</span></span> While_False_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="free">P</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-While_True_ir_valid"><span class="command">lemma</span></span> While_True_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>Seq <span class="free">c</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="free">P</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>


<span class="keyword1" id="RelationalIncorrectness-While_backwards_frontier_ir_valid'"><span class="command">lemma</span></span> While_backwards_frontier_ir_valid'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">t'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="free">k</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> post last <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> asm  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> WhileFalse WhileTrue add.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> final_iteration<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> final_iteration<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="skolem">q</span> <span class="skolem">r'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="skolem">q</span> <span class="main">∧</span>  <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">r</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_1_eq_Suc semiring_normalization_rules<span class="main"><span class="main">(</span></span>24<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> final_iteration <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="RelationalIncorrectness-While_backwards_frontier_ir_valid"><span class="command">lemma</span></span> While_backwards_frontier_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> ir_valid <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c</span> SKIP <span class="main">(</span><span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span><span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> meh_simp ir_valid_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> While_backwards_frontier_ir_valid'<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-conseq_ir_valid"><span class="command">lemma</span></span> conseq_ir_valid<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q'</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span>
                  ir_valid <span class="free">P'</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-disj_ir_valid"><span class="command">lemma</span></span> disj_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> ir_valid <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
                  ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∨</span> <span class="free">P<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∨</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> soundness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ir_hoare.induct<span class="main">)</span>
              <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Skip_ir_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conseq_ir_valid<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Completeness"</span></span>

<span class="keyword1" id="RelationalIncorrectness-ir_Skip_Skip"><span class="command">lemma</span></span> ir_Skip_Skip<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> SKIP SKIP <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_hoare_Skip_Skip"><span class="command">lemma</span></span> ir_hoare_Skip_Skip<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> SKIP SKIP <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> soundness ir_valid_def meh_simp ir_conseq ir_Skip <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_Seq1"><span class="command">lemma</span></span> ir_valid_Seq1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="main">(</span><span class="free">c1</span><span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="free">c1</span> <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="free">c2</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_Seq1'"><span class="command">lemma</span></span> ir_valid_Seq1'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="main">(</span><span class="free">c1</span><span class="main">;;</span> <span class="free">c2</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="free">c2</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="free">c2</span> SKIP <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> SeqE<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_track_history"><span class="command">lemma</span></span> ir_valid_track_history<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_If"><span class="command">lemma</span></span> ir_valid_If<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c1</span> <span class="keyword1">ELSE</span> <span class="free">c2</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c1</span> <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c1</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
   ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c2</span> <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c2</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Inspired by the 
  ``<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"p(n) = {σ | you can get back from σ to some state in p by executing C backwards n times}"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>''
  part of OHearn~\cite{OHearn_19}.
›</span></span>
<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">get_back</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_back</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">get_back</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> bval <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">get_back</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">s</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="comment1">(* Currently not used anywhere *)</span>
<span class="keyword1" id="RelationalIncorrectness-ir_valid_get_back"><span class="command">lemma</span></span> ir_valid_get_back<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span>get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span>get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">using</span></span>  WhileTrue get_back.simps<span class="main">(</span>2<span class="main">)</span> ir_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* both this an the next one get used in the completeness proof *)</span>
<span class="keyword1" id="RelationalIncorrectness-ir_valid_While1"><span class="command">lemma</span></span> ir_valid_While1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span>get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   <span class="main">(</span>ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c</span> SKIP <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">t'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u'</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">s</span> <span class="skolem">u</span> <span class="skolem">u'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span>get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span> 
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span>"</span></span> 
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u'</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span>
         <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="skolem">s</span>"</span></span>
         <span class="quoted"><span class="quoted">"get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span> <span class="skolem">s</span> <span class="skolem">t'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span> <span class="bound">s</span> <span class="skolem">t'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">u'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> Suc.prems<span class="main">(</span>6<span class="main">)</span> Suc.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_While3"><span class="command">lemma</span></span> ir_valid_While3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span>get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   <span class="main">(</span>ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u</span> <span class="main">∧</span>  <span class="free">Q</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">s'</span> <span class="skolem">s</span> <span class="skolem">u</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ir_valid <span class="main">(</span>get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span> 
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span>"</span></span> 
         <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t'</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">u</span> <span class="skolem">t'</span>"</span></span>
         <span class="quoted"><span class="quoted">"bval <span class="free">b</span> <span class="skolem">s</span>"</span></span>
         <span class="quoted"><span class="quoted">"get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span> <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> get_back <span class="free">P</span> <span class="free">b</span> <span class="free">c</span> <span class="free">k</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">t'</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>3<span class="main">)</span> Suc.prems<span class="main">(</span>4<span class="main">)</span> Suc.prems<span class="main">(</span>6<span class="main">)</span> Suc.prems<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* not used anywhere *)</span>
<span class="keyword1" id="RelationalIncorrectness-ir_valid_While2"><span class="command">lemma</span></span> ir_valid_While2<span class="main">:</span>
   <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-assign_upd_blah"><span class="command">lemma</span></span> assign_upd_blah<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">x1</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="free">x1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">x1</span> <span class="main">:=</span> aval <span class="free">x2</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-Assign_complete"><span class="command">lemma</span></span> Assign_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="main">(</span><span class="free">x1</span> <span class="main">::=</span> <span class="free">x2</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">t</span><span class="main">(</span><span class="free">x1</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">t</span> <span class="free">x1</span> <span class="main">=</span> aval <span class="free">x2</span> <span class="main">(</span><span class="free">t</span><span class="main">(</span><span class="free">x1</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v <span class="keyword2"><span class="keyword">and</span></span> q <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x1</span> <span class="main">::=</span> <span class="free">x2</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ir_valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">smt</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">x1</span> <span class="keyword1">then</span> <span class="skolem">s</span> <span class="free">x1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="skolem">s</span><span class="main">(</span><span class="free">x1</span> <span class="main">:=</span> aval <span class="free">x2</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">s'</span> <span class="main">∧</span> aval <span class="free">x2</span> <span class="skolem">s</span> <span class="main">=</span> aval <span class="free">x2</span> <span class="main">(</span><span class="skolem">s</span><span class="main">(</span><span class="free">x1</span> <span class="main">:=</span> <span class="skolem">s</span> <span class="free">x1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assign_upd_blah 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> assign_upd_blah a 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AssignE fun_upd_same fun_upd_triv fun_upd_upd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ir_Skip_sym <span class="main">=</span> ir_sym<span class="main">[</span><span class="operator">OF</span> ir_Skip<span class="main">,</span> <span class="operator">simplified</span> flip_def<span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> completeness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> SKIP
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> SKIP <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Assign <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Assign_complete Assign <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Seq <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"ir_hoare <span class="skolem">P</span> <span class="skolem">c1</span> <span class="skolem">c'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ir_valid_Seq1 Seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq1<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip_sym<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> SeqE ir_valid_def Seq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>If <span class="skolem">x1</span> <span class="skolem">c1</span> <span class="skolem">c2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="skolem">x1</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">c1</span> <span class="skolem">c'</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c1</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> bval <span class="skolem">x1</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       f<span class="main">:</span> <span class="quoted"><span class="quoted">" ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="skolem">x1</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">c2</span> <span class="skolem">c'</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c2</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="skolem">x1</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ir_valid_If If <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="comment1">(* consider both cases of the if via conseq, disj, then _True and _False *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_conseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_disj<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True<span class="main"><span class="keyword3">,</span></span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> t<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_False<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f<span class="main">)</span>    
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> IfE ir_valid_def If<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>While <span class="skolem">x1</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> get_back <span class="skolem">P</span> <span class="skolem">x1</span> <span class="skolem">c</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="skolem">x1</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">c</span> SKIP <span class="main">(</span>get_back <span class="skolem">P</span> <span class="skolem">x1</span> <span class="skolem">c</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ir_valid_While1  While
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> get_back.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ir_valid_def meh_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="skolem">x1</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">c</span> <span class="skolem">c'</span>
                    <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span>  <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> bval <span class="skolem">x1</span> <span class="bound">s</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> 
                    <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="skolem">x1</span> <span class="keyword1">DO</span> <span class="skolem">c</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">u</span> <span class="main">∧</span> <span class="skolem">Q</span> <span class="bound">u</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ir_valid_While3<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">]</span> While <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> gb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">t</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="skolem">x1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span>
                    <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> get_back <span class="skolem">P</span> <span class="skolem">x1</span> <span class="skolem">c</span> <span class="bound">n</span> <span class="bound">t</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="skolem">x1</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> get_back.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="comment1">(* use the frontier rule much as in OHearn POPL *)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_conseq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"get_back <span class="skolem">P</span> <span class="skolem">x1</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ir_While_backwards_frontier<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> a<span class="main">)</span>
      <span class="comment1">(* consider both cases of the While via conseq, disj, then _True and _False *)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_conseq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_disj<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> get_back <span class="skolem">P</span> <span class="skolem">x1</span> <span class="skolem">c</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> Q<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">t</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="skolem">x1</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ir_While_False<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gb<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_True<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> b<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip_sym<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> get_back.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> While.prems WhileE ir_valid_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>




<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"A Decomposition Principle: Proofs via Under-Approximate Hoare Logic"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We show the under-approximate analogue holds for Beringer's~\cite{Beringer_11} decomposition
  principle for over-approximate relational logic.
›</span></span>


<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">decomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rassn <span class="main">⇒</span> com <span class="main">⇒</span> com <span class="main">⇒</span> rassn <span class="main">⇒</span> rassn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decomp</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">t</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span> <span class="bound">t'</span>"</span></span>


<span class="keyword1" id="RelationalIncorrectness-ir_valid_decomp1"><span class="command">lemma</span></span> ir_valid_decomp1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="free">c</span> SKIP <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> ir_valid <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def meh_simp decomp_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_decomp2"><span class="command">lemma</span></span> ir_valid_decomp2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> SKIP <span class="free">R</span> <span class="main">∧</span> ir_valid <span class="free">R</span> SKIP <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def meh_simp decomp_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_valid_decomp"><span class="command">lemma</span></span> ir_valid_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span>ir_valid <span class="free">P</span> <span class="free">c</span> SKIP <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> ir_valid <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ir_valid_decomp1 ir_valid_decomp2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Completeness with soundness means we can prove proof rules about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ir_hoare</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in terms
  of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ir_valid</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="RelationalIncorrectness-ir_to_Skip"><span class="command">lemma</span></span> ir_to_Skip<span class="main">:</span>     
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span>ir_hoare <span class="free">P</span> <span class="free">c</span> SKIP <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span> <span class="main">∧</span> ir_hoare <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> soundness completeness ir_valid_decomp 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  O'Hearn's under-approximate Hoare triple, for the ``ok'' case (since that is the only case we have)
  This is also likely the same as from the "Reverse Hoare Logic" paper (SEFM).
›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> assn <span class="main">=</span> <span class="quoted"><span class="quoted">"state <span class="main">⇒</span> bool"</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">ohearn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"assn <span class="main">⇒</span> com <span class="main">⇒</span> assn <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ohearn</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="RelationalIncorrectness-fold_ohearn1"><span class="command">lemma</span></span> fold_ohearn1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> <span class="free">c</span> SKIP <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> ohearn <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ir_valid_def ohearn_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-fold_ohearn2"><span class="command">lemma</span></span> fold_ohearn2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_valid <span class="free">P</span> SKIP <span class="free">c'</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> ohearn <span class="main">(</span><span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="free">c'</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ir_valid_def ohearn_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> relational_via_hoare<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> ohearn <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span> <span class="free">c</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> ohearn <span class="main">(</span>decomp <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="bound">t</span><span class="main">)</span> <span class="free">c'</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">Q</span><span class="main">.</span> ir_hoare <span class="bound">P</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">Q</span> <span class="main">=</span> ir_valid <span class="bound">P</span> <span class="bound">c</span> <span class="bound">c'</span> <span class="bound">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> soundness completeness <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ir_to_Skip a fold_ohearn1 fold_ohearn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Deriving Proof Rules from Completeness"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Note that we can more easily derive proof rules sometimes by appealing to the
   corresponding properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ir_valid</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> than from the proof rules directly.

  We see more examples of this later on when we consider examples.
›</span></span>

<span class="keyword1" id="RelationalIncorrectness-ir_Seq2"><span class="command">lemma</span></span> ir_Seq2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> SKIP <span class="free">Q</span> <span class="main">⟹</span> ir_hoare <span class="free">Q</span> <span class="free">d</span> <span class="free">c'</span> <span class="free">R</span> <span class="main">⟹</span> ir_hoare <span class="free">P</span> <span class="main">(</span>Seq <span class="free">c</span> <span class="free">d</span><span class="main">)</span> <span class="free">c'</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> soundness completeness Seq2_ir_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="RelationalIncorrectness-ir_Seq"><span class="command">lemma</span></span> ir_Seq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="free">c</span> <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span> ir_hoare <span class="free">Q</span> <span class="free">d</span> <span class="free">d'</span> <span class="free">R</span> <span class="main">⟹</span> ir_hoare <span class="free">P</span> <span class="main">(</span>Seq <span class="free">c</span> <span class="free">d</span><span class="main">)</span> <span class="main">(</span>Seq <span class="free">c'</span> <span class="free">d'</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> soundness completeness Seq_ir_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Examples"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Some Derived Proof Rules"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
First derive some proof rules -- here not by appealing to completeness but just using
the existing rules 
›</span></span>

<span class="keyword1" id="RelationalIncorrectness-ir_If_True_False"><span class="command">lemma</span></span> ir_If_True_False<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">Q</span> <span class="main">⟹</span> 
   ir_hoare <span class="free">P</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b'</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_False<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_def<span class="main">)</span>


<span class="keyword1" id="RelationalIncorrectness-ir_Assign_Assign"><span class="command">lemma</span></span> ir_Assign_Assign<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">::=</span> <span class="free">e</span><span class="main">)</span> <span class="main">(</span><span class="free">x'</span> <span class="main">::=</span> <span class="free">e'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">t</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">t'</span><span class="main">(</span><span class="free">x'</span> <span class="main">:=</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="free">x</span> <span class="main">=</span> aval <span class="free">e</span> <span class="main">(</span><span class="bound">t</span><span class="main">(</span><span class="free">x</span> <span class="main">:=</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t'</span> <span class="free">x'</span> <span class="main">=</span> aval <span class="free">e'</span> <span class="main">(</span><span class="bound">t'</span><span class="main">(</span><span class="free">x'</span> <span class="main">:=</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_sym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"prog1"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A tiny insecure program. Note that we only need to reason on one path through this program to
  detect that it is insecure. 
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">low_eq</span> <span class="main">::</span> <span class="quoted">rassn</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">low_eq</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="inner_quoted">''low''</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="inner_quoted">''low''</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">low_neq</span> <span class="main">::</span> <span class="quoted">rassn</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">low_neq</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">¬</span> low_eq <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prog1</span> <span class="main">::</span> <span class="quoted">com</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prog1</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="main">(</span>Less <span class="main">(</span>N <span class="main">0</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">THEN</span> <span class="main">(</span>Assign <span class="inner_quoted">''low''</span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">ELSE</span> <span class="main">(</span>Assign <span class="inner_quoted">''low''</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We prove that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">prog1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is definitely insecure. To do that, we need to find some non-empty
  post-relation that implies insecurity. The following property encodes the idea that the 
  post-relation is non-empty, i.e. represents a feasible pair of execution paths.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nontrivial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rassn <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nontrivial</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Note the property we prove here explicitly encodes the fact that the postcondition can be anything
  that implies insecurity, i.e. implies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">low_neq</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In particular we should not necessarily
  expect it to cover the entirely of all states that satisfy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">low_neq</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 

  Also note that we also have to prove that the postcondition is non-trivial. This is necessary to 
  make sure that the violation we find is not an infeasible path.
›</span></span>
<span class="keyword1" id="RelationalIncorrectness-prog1"><span class="command">lemma</span></span> prog1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> ir_hoare low_eq prog1 prog1 <span class="bound">Q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟶</span> low_neq <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> nontrivial <span class="bound">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prog1_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True_False<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nontrivial_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"More Derived Proof Rules for Examples"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BEq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"aexp <span class="main">⇒</span> aexp <span class="main">⇒</span> bexp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BEq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> And <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="RelationalIncorrectness-BEq_aval"><span class="command">lemma</span></span> BEq_aval<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"bval <span class="main">(</span>BEq <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>aval <span class="free">a</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>aval <span class="free">b</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> BEq_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_If_True_True"><span class="command">lemma</span></span> ir_If_True_True<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="free">P</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b'</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ir_If_True ir_sym flip_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_If_False_False"><span class="command">lemma</span></span> ir_If_False_False<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="free">P</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b'</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ir_If_False ir_sym flip_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_If'"><span class="command">lemma</span></span> ir_If'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="free">P</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">IF</span> <span class="free">b'</span> <span class="keyword1">THEN</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">ELSE</span> <span class="free">c<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">∨</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_pre<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_disj<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True_True<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_False_False<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="RelationalIncorrectness-ir_While_triv"><span class="command">lemma</span></span> ir_While_triv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> SKIP SKIP <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="free">P</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ir_While_False ir_sym flip_def<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_While'"><span class="command">lemma</span></span> ir_While'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span><span class="main">;;</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">c'</span><span class="main">;;</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> SKIP SKIP <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span>
   ir_hoare <span class="free">P</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">Q<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∨</span> <span class="free">Q<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_pre<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_disj<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_True<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_sym<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_True<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_sym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_triv<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"client0"</span></span>   

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">low_eq_strong</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">low_eq_strong</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="inner_quoted">''high''</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="inner_quoted">''high''</span><span class="main">)</span> <span class="main">∧</span> low_eq <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span>"</span></span>

<span class="keyword1" id="RelationalIncorrectness-low_eq_strong_upd"><span class="command">lemma</span></span> low_eq_strong_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">var</span> <span class="main">≠</span> <span class="inner_quoted">''high''</span> <span class="main">∧</span> <span class="free">var</span> <span class="main">≠</span> <span class="inner_quoted">''low''</span> <span class="main">⟹</span> low_eq_strong<span class="main">(</span><span class="free">s</span><span class="main">(</span><span class="free">var</span> <span class="main">:=</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span><span class="main">(</span><span class="free">var</span> <span class="main">:=</span> <span class="free">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> low_eq_strong <span class="free">s</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A variation on client0 from O'Hearn~\cite{OHearn_19}: how to reason about loops via a single unfolding
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">client0</span> <span class="main">::</span> <span class="quoted">com</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">client0</span> <span class="main">≡</span> <span class="main">(</span>Assign <span class="inner_quoted">''x''</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span><span class="main">;;</span>
              <span class="main">(</span>While <span class="main">(</span>Less <span class="main">(</span>N <span class="main">0</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''n''</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span><span class="main">(</span>Assign <span class="inner_quoted">''x''</span> <span class="main">(</span>Plus <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''n''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;;</span>
                      <span class="main">(</span>Assign <span class="inner_quoted">''n''</span> <span class="main">(</span>V <span class="inner_quoted">''nondet''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;;</span>
              <span class="main">(</span>If <span class="main">(</span>BEq <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">2000000</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign <span class="inner_quoted">''low''</span> <span class="main">(</span>V <span class="inner_quoted">''high''</span><span class="main">)</span><span class="main">)</span> SKIP<span class="main">)</span><span class="main">)</span>"</span></span>



<span class="keyword1" id="RelationalIncorrectness-client0"><span class="command">lemma</span></span> client0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> ir_hoare low_eq client0 client0 <span class="bound">Q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟶</span> low_neq <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> nontrivial <span class="bound">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> client0_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted">low_eq_strong</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ir_pre<span class="main">)</span>  
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_triv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>


    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True_True<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="comment1">(* ugh having to manually do constraint solving here... *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def nontrivial_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''x''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''high''</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''n''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''nondet''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''low''</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> undefined"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''x''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''high''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''n''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''nondet''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''low''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> undefined"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="comment1">(* Not needed? *)</span>
<span class="keyword1" id="RelationalIncorrectness-ir_While_backwards"><span class="command">lemma</span></span> ir_While_backwards<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> ir_hoare <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> <span class="free">c</span> SKIP <span class="main">(</span><span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
                       ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span><span class="main">)</span> SKIP <span class="free">c'</span> <span class="free">Q</span> <span class="main">⟹</span>
                       ir_hoare <span class="main">(</span><span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="free">c'</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_backwards_frontier<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_False<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Derive a variant of the backwards variant rule"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we appeal to completeness again to derive this rule from the corresponding
        property about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ir_valid</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"A variant of the frontier rule"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Agin we derive this rule by appealing to completeness and the corresponding property of
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">ir_valid</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1" id="RelationalIncorrectness-While_backwards_frontier_both_ir_valid'"><span class="command">lemma</span></span> While_backwards_frontier_both_ir_valid'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="bound">t'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">t</span> <span class="bound">t'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> post<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="free">k</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> post last <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> asm  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> WhileFalse WhileTrue add.right_neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> final_iteration<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">r'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_shift<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> final_iteration<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">k</span> <span class="skolem">q</span> <span class="skolem">q'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="skolem">q</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="skolem">q'</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">r</span> <span class="main">∧</span> <span class="main">(</span><span class="free">c'</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">r'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_1_eq_Suc semiring_normalization_rules<span class="main"><span class="main">(</span></span>24<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> final_iteration <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="RelationalIncorrectness-While_backwards_frontier_both_ir_valid"><span class="command">lemma</span></span> While_backwards_frontier_both_ir_valid<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> ir_valid <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="free">Q</span> <span class="main">⟹</span>
   ir_valid <span class="main">(</span><span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ir_valid_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> While_backwards_frontier_both_ir_valid'<span class="main">)</span>

<span class="keyword1" id="RelationalIncorrectness-ir_While_backwards_frontier_both"><span class="command">lemma</span></span> ir_While_backwards_frontier_both<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
   ir_hoare <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="free">Q</span><span class="main">⟧</span>
   <span class="main">⟹</span> ir_hoare <span class="main">(</span><span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> soundness completeness While_backwards_frontier_both_ir_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following rule then follows easily as a special case
›</span></span>
<span class="keyword1" id="RelationalIncorrectness-ir_While_backwards_both"><span class="command">lemma</span></span> ir_While_backwards_both<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> ir_hoare <span class="main">(</span><span class="main">λ</span> <span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">c</span> <span class="free">c'</span> <span class="main">(</span><span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
                       ir_hoare <span class="main">(</span><span class="free">P</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b</span> <span class="keyword1">DO</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">WHILE</span> <span class="free">b'</span> <span class="keyword1">DO</span> <span class="free">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b</span> <span class="bound">s</span> <span class="main">∧</span> <span class="main">¬</span> bval <span class="free">b'</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_backwards_frontier_both<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ir_While_False ir_sym flip_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"client1"</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An example roughly equivalent to cient1 from O'Hearn~\cite{OHearn_19}0 

  In particular we use the backwards variant rule to reason about the loop.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">client1</span> <span class="main">::</span> <span class="quoted">com</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">client1</span> <span class="main">≡</span> <span class="main">(</span>Assign <span class="inner_quoted">''x''</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span><span class="main">;;</span>
              <span class="main">(</span>While <span class="main">(</span>Less <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>V <span class="inner_quoted">''n''</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span><span class="main">(</span>Assign <span class="inner_quoted">''x''</span> <span class="main">(</span>Plus <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;;</span>
              <span class="main">(</span>If <span class="main">(</span>BEq <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">2000000</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign <span class="inner_quoted">''low''</span> <span class="main">(</span>V <span class="inner_quoted">''high''</span><span class="main">)</span><span class="main">)</span> SKIP<span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="RelationalIncorrectness-client1"><span class="command">lemma</span></span> client1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> ir_hoare low_eq client1 client1 <span class="bound">Q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟶</span> low_neq <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> nontrivial <span class="bound">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> client1_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted">low_eq_strong</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ir_pre<span class="main">)</span>  
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_pre<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_backwards_both<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">n</span></span> <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">s'</span></span><span class="main"><span class="main">.</span></span> low_eq_strong <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">=</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">=</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''n''</span></span> <span class="main"><span class="main">∧</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">≤</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''n''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_post<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True_True<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="comment1">(* ugh having to manually do constraint solving here... *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def nontrivial_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''x''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''high''</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''n''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''nondet''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''low''</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> undefined"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''x''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''high''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''n''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''nondet''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''low''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> undefined"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"client2"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An example akin to client2 from O'Hearn~\cite{OHearn_19}. 

  Note that this example is carefully written to show use of the frontier rule first to
  reason up to the broken loop iteration, and then we unfold the loop at that point to
  reason about the broken iteration, and then use the plain backwards variant rule to
  reason over the remainder of the loop.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">client2</span> <span class="main">::</span> <span class="quoted">com</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">client2</span> <span class="main">≡</span> <span class="main">(</span>Assign <span class="inner_quoted">''x''</span> <span class="main">(</span>N <span class="main">0</span><span class="main">)</span><span class="main">;;</span>
              <span class="main">(</span>While <span class="main">(</span>Less <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">4000000</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">(</span><span class="main">(</span>Assign <span class="inner_quoted">''x''</span> <span class="main">(</span>Plus <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;;</span>
                       <span class="main">(</span>If <span class="main">(</span>BEq <span class="main">(</span>V <span class="inner_quoted">''x''</span><span class="main">)</span> <span class="main">(</span>N <span class="numeral">2000000</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Assign <span class="inner_quoted">''low''</span> <span class="main">(</span>V <span class="inner_quoted">''high''</span><span class="main">)</span><span class="main">)</span> SKIP<span class="main">)</span><span class="main">)</span>
                       <span class="main">)</span>
              <span class="main">)</span>"</span></span>

<span class="keyword1" id="RelationalIncorrectness-client2"><span class="command">lemma</span></span> client2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Q</span><span class="main">.</span> ir_hoare low_eq client2 client2 <span class="bound">Q</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="bound">s'</span> <span class="main">⟶</span> low_neq <span class="bound">s</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∧</span> nontrivial <span class="bound">Q</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> client2_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted">low_eq_strong</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ir_pre<span class="main">)</span>  
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_pre<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_backwards_frontier_both<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">n</span></span> <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">s'</span></span><span class="main"><span class="main">.</span></span> low_eq_strong <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">=</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">=</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≥</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">2000000</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≥</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">2000000</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">1</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_post<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If'<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Skip_Skip<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While'<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_True_True<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_pre<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_While_backwards_both<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">n</span></span> <span class="bound"><span class="bound">s</span></span> <span class="bound"><span class="bound">s'</span></span><span class="main"><span class="main">.</span></span>  <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">2000000</span></span> <span class="main"><span class="main">+</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">=</span></span> <span class="numeral"><span class="numeral">2000000</span></span> <span class="main"><span class="main">+</span></span> int <span class="bound"><span class="bound">n</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≥</span></span> <span class="numeral"><span class="numeral">2000000</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">4000000</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≥</span></span> <span class="numeral"><span class="numeral">2000000</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''x''</span></span> <span class="main"><span class="main">≤</span></span> <span class="numeral"><span class="numeral">4000000</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''low''</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''high''</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''low''</span></span> <span class="main"><span class="main">=</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''high''</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">s</span></span> <span class="inner_quoted"><span class="inner_quoted">''high''</span></span> <span class="main"><span class="main">≠</span></span> <span class="bound"><span class="bound">s'</span></span> <span class="inner_quoted"><span class="inner_quoted">''high''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>


     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Seq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_Assign_Assign<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> ir_If_False_False<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="comment1">(* ugh having to manually do constraint solving here... *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> low_eq_strong_def nontrivial_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''x''</span> <span class="keyword1">then</span> <span class="numeral">4000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''high''</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''n''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''nondet''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''low''</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> undefined"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''x''</span> <span class="keyword1">then</span> <span class="numeral">4000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''high''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''n''</span> <span class="keyword1">then</span> <span class="numeral">2000000</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''nondet''</span> <span class="keyword1">then</span> <span class="main">-</span><span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">v</span> <span class="main">=</span> <span class="inner_quoted">''low''</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> undefined"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>