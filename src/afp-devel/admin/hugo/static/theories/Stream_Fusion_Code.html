<div id="Stream_Fusion">
<div class="head">
<h1>Theory Stream_Fusion</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Stream_Fusion.thy
 Authors: Alexandra Maximova, ETH Zurich
          Andreas Lochbihler, ETH Zurich
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stream fusion implementation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stream_Fusion
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹stream_fusion.ML›</span>

<span class="keyword1"><span class="command">simproc_setup</span></span> stream_fusion <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span>"</span></span><span class="main">)</span> <span class="main">=</span> <span class="quoted">‹K <span class="entity">Stream_Fusion.fusion_simproc</span>›</span>
<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stream_fusion<span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Install stream fusion as a simproc in the preprocessor for code equations›</span></span>
<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹<span class="entity">Code_Preproc.map_pre</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ss</span> <span class="main">=&gt;</span> <span class="entity">ss</span> addsimprocs <span class="main">[</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">simproc</span> "stream_fusion"<span class="antiquote">}</span></span></span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/stream_fusion.ML">
<div class="head">
<h1>File ‹stream_fusion.ML›</h1>
</div>
<pre class="source"><span class="comment1">(* Title: stream_fusion.ML
  Author: Alexandra Maximova, ETH Zurich,
          Andreas Lochbihler, ETH Zurich 

Implementation of the stream fusion transformation as a simproc for the preprocessor of the
code generator
*)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">STREAM_FUSION</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> get_rules<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> thm list
  <span class="keyword1"><span class="keyword">val</span></span> get_conspats<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> <span class="main">(</span>term * thm<span class="main">)</span> list
  <span class="keyword1"><span class="keyword">val</span></span> match_consumer<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> term <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> add_fusion_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_fusion_rule<span class="main">:</span> thm <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> add_unstream<span class="main">:</span> string <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> del_unstream<span class="main">:</span> string <span class="main">-&gt;</span> Context.generic <span class="main">-&gt;</span> Context.generic
  <span class="keyword1"><span class="keyword">val</span></span> get_unstream<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> string list
  <span class="keyword1"><span class="keyword">val</span></span> fusion_add<span class="main">:</span> attribute
  <span class="keyword1"><span class="keyword">val</span></span> fusion_del<span class="main">:</span> attribute
  <span class="keyword1"><span class="keyword">val</span></span> fusion_conv<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> conv
  <span class="keyword1"><span class="keyword">val</span></span> fusion_simproc<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> cterm <span class="main">-&gt;</span> thm option
  <span class="keyword1"><span class="keyword">val</span></span> trace<span class="main">:</span> bool Config.T
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Stream_Fusion</span> <span class="main">:</span> <span class="entity">STREAM_FUSION</span> <span class="main">=</span> 
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">type</span></span> <span class="entity">fusion_rules</span> <span class="main">=</span> 
  <span class="main">{</span> rules <span class="main">:</span> thm Item_Net.T<span class="main">,</span>
    conspats <span class="main">:</span> <span class="main">(</span>term * thm<span class="main">)</span> Item_Net.T<span class="main">,</span>
    unstream <span class="main">:</span> string list
  <span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_fusion_rules</span> <span class="entity">f1</span> <span class="entity">f2</span> <span class="entity">f3</span>
  <span class="main">{</span><span class="entity">rules</span><span class="main">,</span> <span class="entity">conspats</span><span class="main">,</span> <span class="entity">unstream</span><span class="main">}</span>
  <span class="main">=</span>
  <span class="main">{</span>rules <span class="main">=</span> <span class="entity">f1</span> <span class="entity">rules</span><span class="main">,</span>
   conspats <span class="main">=</span> <span class="entity">f2</span> <span class="entity">conspats</span><span class="main">,</span>
   unstream <span class="main">=</span> <span class="entity">f3</span> <span class="entity">unstream</span><span class="main">}</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_rules</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">map_fusion_rules</span> <span class="entity">f</span> I I<span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_conspats</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">map_fusion_rules</span> I <span class="entity">f</span> I<span class="main">;</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">map_unstream</span> <span class="entity">f</span> <span class="main">=</span> <span class="entity">map_fusion_rules</span> I I <span class="entity">f</span><span class="main">;</span>


<span class="comment1">(* producers: theorems about producers, have 'unstream' only on the lhs *)</span>
<span class="comment1">(* consumers: theorems about consumers, have 'unstream' only on the rhs *)</span>
<span class="comment1">(* transformers: theorems about transformers, have 'unstream' on both sides *)</span>
<span class="comment1">(* conspats: patterns of consumers that have matching theorems in consumers *)</span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">Fusion_Rules</span> <span class="main">=</span> Generic_Data
<span class="main">(</span>
  <span class="keyword1"><span class="keyword">type</span></span> <span class="entity">T</span> <span class="main">=</span> <span class="entity">fusion_rules</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">empty</span> <span class="main">=</span> <span class="main">{</span>rules <span class="main">=</span> Thm.full_rules<span class="main">,</span>
               conspats <span class="main">=</span> Item_Net.init <span class="main">(</span>Thm.eq_thm_prop o apply2 snd<span class="main">)</span> <span class="main">(</span>single o fst<span class="main">)</span><span class="main">,</span>
               unstream <span class="main">=</span> <span class="main">[</span><span class="main">]</span><span class="main">}</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">extend</span> <span class="main">=</span> I<span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">merge</span> 
    <span class="main">(</span><span class="main">{</span>rules <span class="main">=</span> <span class="entity">r</span><span class="main">,</span> conspats <span class="main">=</span> <span class="entity">cp</span><span class="main">,</span> unstream <span class="main">=</span> <span class="entity">u</span><span class="main">}</span><span class="main">,</span>
     <span class="main">{</span>rules <span class="main">=</span> <span class="entity">r'</span><span class="main">,</span> conspats <span class="main">=</span> <span class="entity">cp'</span><span class="main">,</span> unstream <span class="main">=</span> <span class="entity">u'</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span>rules <span class="main">=</span> Item_Net.merge <span class="main">(</span><span class="entity">r</span><span class="main">,</span> <span class="entity">r'</span><span class="main">)</span><span class="main">,</span>
     conspats <span class="main">=</span> Item_Net.merge <span class="main">(</span><span class="entity">cp</span><span class="main">,</span> <span class="entity">cp'</span><span class="main">)</span><span class="main">,</span>
     unstream <span class="main">=</span> Library.merge <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="main">(</span><span class="entity">u</span><span class="main">,</span> <span class="entity">u'</span><span class="main">)</span><span class="main">}</span>
<span class="main">)</span><span class="main">;</span>


<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_rules</span> <span class="main">=</span> Item_Net.content o <span class="main">#</span>rules o Fusion_Rules.get o Context.Proof<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_conspats</span> <span class="main">=</span> Item_Net.content o <span class="main">#</span>conspats o Fusion_Rules.get o Context.Proof<span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">get_unstream</span> <span class="main">=</span> <span class="main">#</span>unstream o Fusion_Rules.get o Context.Proof<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">match_consumer</span> <span class="entity">ctxt</span> <span class="entity">t</span> <span class="main">=</span> 
  Context.Proof <span class="entity">ctxt</span>
  |&gt; Fusion_Rules.get
  |&gt; <span class="main">#</span>conspats
  |&gt; <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">net</span> <span class="main">=&gt;</span> Item_Net.retrieve_matching <span class="entity">net</span> <span class="entity">t</span><span class="main">)</span>
  |&gt; not o null

<span class="keyword1"><span class="keyword">datatype</span></span> <span class="entity">classification</span> <span class="main">=</span> <span class="entity">ProducerTransformer</span> <span class="main">|</span> <span class="entity">Consumer</span> <span class="keyword2"><span class="keyword">of</span></span> term

<span class="comment1">(* used to find out if a 'unstream' is present in a term *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="main">(</span><span class="main">(</span>Const <span class="main">(</span><span class="entity">c</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span> $ <span class="entity">t</span><span class="main">)</span> <span class="main">=</span>
    member <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">ts</span> <span class="entity">c</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> $ <span class="main">(</span><span class="entity">u</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="entity">u</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="main">(</span>Abs <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="entity">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="entity">occur_in</span> <span class="entity">ts</span> <span class="entity">t</span>
  <span class="main">|</span> <span class="entity">occur_in</span> <span class="main">_</span> <span class="main">_</span> <span class="main">=</span> false<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">first_depth</span> <span class="main">(</span><span class="entity">t1</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span> <span class="main">=</span> <span class="entity">first_depth</span> <span class="entity">t1</span> <span class="keyword2"><span class="keyword">in</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">d</span>+<span class="inner_numeral">1</span><span class="main">)</span> <span class="keyword2"><span class="keyword">end</span></span> <span class="main">|</span>
    <span class="entity">first_depth</span> <span class="entity">t1</span> <span class="main">=</span> <span class="main">(</span><span class="entity">t1</span><span class="main">,</span><span class="inner_numeral">0</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mk_conspat</span> <span class="entity">rhs</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="entity">d</span><span class="main">)</span> <span class="main">=</span> <span class="entity">first_depth</span> <span class="entity">rhs</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">types</span> <span class="main">=</span> binder_types <span class="main">(</span>fastype_of <span class="entity">f</span><span class="main">)</span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">(</span><span class="entity">vfixes</span><span class="main">,</span> <span class="entity">ctxt1</span><span class="main">)</span> <span class="main">=</span> Variable.variant_fixes <span class="main">(</span>replicate <span class="entity">d</span> <span class="inner_quoted">"x"</span><span class="main">)</span> <span class="entity">ctxt</span> 
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="main">(</span>hd o Variable.export_terms <span class="entity">ctxt1</span> <span class="entity">ctxt</span> o single<span class="main">)</span> <span class="main">(</span>list_comb <span class="main">(</span><span class="entity">f</span><span class="main">,</span> map Free <span class="main">(</span><span class="entity">vfixes</span> ~~ <span class="entity">types</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">classify</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">case</span></span> Thm.full_prop_of <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">of</span></span> <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Trueprop<span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> "HOL.eq"<span class="antiquote">}</span></span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> $ <span class="entity">lhs</span> $ <span class="entity">rhs</span><span class="main">)</span><span class="main">)</span> <span class="main">=&gt;</span>
    <span class="keyword2"><span class="keyword">let</span></span> <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">unstream</span> <span class="main">=</span> <span class="entity">get_unstream</span> <span class="entity">ctxt</span> <span class="keyword2"><span class="keyword">in</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">occur_in</span> <span class="entity">unstream</span> <span class="entity">lhs</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="entity">ProducerTransformer</span>
      <span class="keyword2"><span class="keyword">else</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">occur_in</span> <span class="entity">unstream</span> <span class="entity">rhs</span> <span class="keyword2"><span class="keyword">then</span></span> SOME <span class="main">(</span><span class="entity">Consumer</span> <span class="main">(</span><span class="entity">mk_conspat</span> <span class="entity">rhs</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">else</span></span> NONE
    <span class="keyword2"><span class="keyword">end</span></span>
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> NONE<span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sym</span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> sym<span class="antiquote">}</span></span></span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">format_error</span> <span class="entity">ctxt</span> <span class="entity">thm</span> <span class="main">=</span>
  warning <span class="main">(</span>Pretty.string_of <span class="main">(</span>Pretty.block <span class="main">[</span>
    Pretty.str <span class="inner_quoted">"Wrong format for fusion rule: "</span><span class="main">,</span>
    Pretty.brk <span class="inner_numeral">2</span><span class="main">,</span>
    Syntax.pretty_term <span class="main">(</span>Context.proof_of <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">register</span> <span class="entity">thm</span> NONE <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">format_error</span> <span class="entity">ctxt</span> <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
<span class="main">|</span> <span class="entity">register</span> <span class="entity">thm</span> <span class="main">(</span>SOME <span class="entity">ProducerTransformer</span><span class="main">)</span> <span class="main">=</span> Fusion_Rules.map <span class="main">(</span>
    <span class="entity">map_rules</span> <span class="main">(</span>Item_Net.update <span class="main">(</span><span class="entity">sym</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> <span class="entity">register</span> <span class="entity">thm</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">Consumer</span> <span class="entity">cp</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Fusion_Rules.map <span class="main">(</span>
    <span class="entity">map_rules</span> <span class="main">(</span>Item_Net.update <span class="main">(</span><span class="entity">sym</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> o <span class="entity">map_conspats</span> <span class="main">(</span>Item_Net.update <span class="main">(</span><span class="entity">cp</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">unregister</span> <span class="entity">thm</span> NONE <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">format_error</span> <span class="entity">ctxt</span> <span class="entity">thm</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="entity">ctxt</span>
  <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span>
<span class="main">|</span> <span class="entity">unregister</span> <span class="entity">thm</span> <span class="main">(</span>SOME <span class="entity">ProducerTransformer</span><span class="main">)</span> <span class="main">=</span> Fusion_Rules.map <span class="main">(</span>
    <span class="entity">map_rules</span> <span class="main">(</span>Item_Net.remove <span class="main">(</span><span class="entity">sym</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
<span class="main">|</span> <span class="entity">unregister</span> <span class="entity">thm</span> <span class="main">(</span>SOME <span class="main">(</span><span class="entity">Consumer</span> <span class="entity">cp</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Fusion_Rules.map <span class="main">(</span>
    <span class="entity">map_rules</span> <span class="main">(</span>Item_Net.remove <span class="main">(</span><span class="entity">sym</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span> o <span class="entity">map_conspats</span> <span class="main">(</span>Item_Net.remove <span class="main">(</span><span class="entity">cp</span><span class="main">,</span> <span class="entity">thm</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_fusion_rule</span> <span class="entity">thm</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">register</span> <span class="entity">thm</span> <span class="main">(</span><span class="entity">classify</span> <span class="main">(</span>Context.proof_of <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thm</span><span class="main">)</span> <span class="entity">ctxt</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_fusion_rule</span> <span class="entity">thm</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">unregister</span> <span class="entity">thm</span> <span class="main">(</span><span class="entity">classify</span> <span class="main">(</span>Context.proof_of <span class="entity">ctxt</span><span class="main">)</span> <span class="entity">thm</span><span class="main">)</span> <span class="entity">ctxt</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">add_unstream</span> <span class="entity">c</span> <span class="main">=</span> Fusion_Rules.map <span class="main">(</span><span class="entity">map_unstream</span> <span class="main">(</span>insert <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">c</span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">del_unstream</span> <span class="entity">c</span> <span class="main">=</span> Fusion_Rules.map <span class="main">(</span><span class="entity">map_unstream</span> <span class="main">(</span>remove <span class="main">(</span><span class="keyword1"><span class="keyword">op</span></span> <span class="main">=</span><span class="main">)</span> <span class="entity">c</span><span class="main">)</span><span class="main">)</span>

<span class="comment1">(* attributes and setup *)</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fusion_add</span> <span class="main">=</span> Thm.declaration_attribute <span class="entity">add_fusion_rule</span><span class="main">;</span>
<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">fusion_del</span> <span class="main">=</span> Thm.declaration_attribute <span class="entity">del_fusion_rule</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span>
  Theory.setup
   <span class="main">(</span><span class="entity">Attrib.setup</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "stream_fusion"<span class="antiquote">}</span></span></span> <span class="main">(</span><span class="entity">Attrib.add_del</span> <span class="entity">fusion_add</span> <span class="entity">fusion_del</span><span class="main">)</span>
      <span class="inner_quoted">"declaration of a rule for stream fusion"</span> #&gt;
    Global_Theory.add_thms_dynamic
      <span class="main">(</span><span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "stream_fusion"<span class="antiquote">}</span></span></span><span class="main">,</span> Item_Net.content o <span class="main">#</span>rules o Fusion_Rules.get<span class="main">)</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">trace</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "stream_fusion_trace"<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">tracing</span> <span class="entity">ctxt</span> <span class="entity">msg</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">trace</span> <span class="keyword2"><span class="keyword">then</span></span> Output.tracing <span class="main">(</span><span class="entity">msg</span> <span class="main">(</span><span class="main">)</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fusion_conv</span> <span class="entity">ctxt</span> <span class="main">=</span> <span class="entity">Simplifier.rewrite</span> <span class="main">(</span>put_simpset <span class="entity">HOL_basic_ss</span> <span class="entity">ctxt</span> addsimps <span class="entity">get_rules</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">fusion_simproc</span> <span class="entity">ctxt</span> <span class="entity">ct</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">let</span></span>
    <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">matches</span> <span class="main">=</span> <span class="entity">match_consumer</span> <span class="entity">ctxt</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">in</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">matches</span> <span class="keyword2"><span class="keyword">then</span></span> 
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">tracing</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Pretty.string_of <span class="main">(</span>Pretty.block 
          <span class="main">[</span>Pretty.str <span class="inner_quoted">"Trying stream fusion on "</span><span class="main">,</span>
           Pretty.brk <span class="inner_numeral">2</span><span class="main">,</span>
           Syntax.pretty_term <span class="entity">ctxt</span> <span class="main">(</span>Thm.term_of <span class="entity">ct</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">thm</span> <span class="main">=</span> <span class="entity">fusion_conv</span> <span class="entity">ctxt</span> <span class="entity">ct</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">failed</span> <span class="main">=</span> Thm.is_reflexive <span class="entity">thm</span> <span class="keyword1"><span class="keyword">orelse</span></span> <span class="entity">occur_in</span> <span class="main">(</span><span class="entity">get_unstream</span> <span class="entity">ctxt</span><span class="main">)</span> <span class="main">(</span>Thm.term_of <span class="main">(</span>Thm.rhs_of <span class="entity">thm</span><span class="main">)</span><span class="main">)</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="main">_</span> <span class="main">=</span> <span class="entity">tracing</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> Pretty.string_of <span class="main">(</span>Pretty.block 
          <span class="main">[</span>Pretty.str <span class="main">(</span><span class="keyword2"><span class="keyword">if</span></span> <span class="entity">failed</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="inner_quoted">"FAILED: "</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="inner_quoted">"SUCCEEDED: "</span><span class="main">)</span><span class="main">,</span>
           Pretty.brk <span class="inner_numeral">2</span><span class="main">,</span>
           Syntax.pretty_term <span class="entity">ctxt</span> <span class="main">(</span>Thm.prop_of <span class="entity">thm</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">failed</span> <span class="keyword2"><span class="keyword">then</span></span> NONE <span class="keyword2"><span class="keyword">else</span></span> SOME <span class="entity">thm</span>
      <span class="keyword2"><span class="keyword">end</span></span>
    <span class="keyword2"><span class="keyword">else</span></span> NONE
  <span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

</pre>
</div><div id="Stream_Fusion_List">
<div class="head">
<h1>Theory Stream_Fusion_List</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Stream_Fusion_List.thy
 Authors: Alexandra Maximova, ETH Zurich
          Andreas Lochbihler, ETH Zurich
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stream fusion for finite lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stream_Fusion_List
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Stream_Fusion.html">Stream_Fusion</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_option_mono <span class="main">[</span><span class="operator">partial_function_mono</span><span class="main">]</span><span class="main">:</span> <span class="comment1">(* To be moved to HOL *)</span>
  <span class="quoted"><span class="quoted">"mono_option <span class="free">f</span> <span class="main">⟹</span> mono_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_option <span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> monotoneI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> monotoneD<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flat_ord_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The type of generators for finite lists›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> step <span class="main">=</span> Done <span class="main">|</span> <span class="entity">is_Skip</span><span class="main">:</span> Skip <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="main">|</span> <span class="entity">is_Yield</span><span class="main">:</span> Yield <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> step"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Raw generators may not end in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Done<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but may lead to infinitely many <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Yield<span class="antiquote"><span class="antiquote">}</span></span></span></span>s 
  in a row. Such generators cannot be converted to finite lists, because it corresponds to an
  infinite list. Therefore, we introduce the type of generators that always end in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Done<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  after finitely many steps.
›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">terminates_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  stop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Done <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">terminates_on</span> <span class="free">g</span>"</span></span>
<span class="main">|</span> pause<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Skip <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∈</span> <span class="free">terminates_on</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">terminates_on</span> <span class="free">g</span>"</span></span>
<span class="main">|</span> unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∈</span> <span class="free">terminates_on</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">terminates_on</span> <span class="free">g</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">terminates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">terminates</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="main">(</span>terminates_on <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminatesI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> terminates <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> terminatesD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"terminates <span class="free">g</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_on_stop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"terminates_on <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done<span class="main">)</span> <span class="main">=</span> UNIV"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.stop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_terminates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="free">g</span> <span class="bound">s</span> <span class="main">=</span> Skip <span class="bound">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> yield<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span> <span class="bound">a</span><span class="main">.</span> <span class="free">g</span> <span class="bound">s</span> <span class="main">=</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹wf <span class="free">R</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_induct <span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">consumes</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> wf<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> skip<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf.IH<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Skip <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_on.pause<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> yield<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf.IH<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Yield <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_on.unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_on.stop<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>option<span class="main">)</span> <span class="entity">terminates_within</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">terminates_within</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Some <span class="main">0</span>
  <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">terminates_within</span> <span class="bound">s'</span><span class="main">)</span>
  <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">terminates_within</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_on_conv_dom_terminates_within<span class="main">:</span>
  <span class="quoted"><span class="quoted">"terminates_on <span class="free">g</span> <span class="main">=</span> dom terminates_within"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI iffI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> terminates_within <span class="skolem">s</span> <span class="main">=</span> Some <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">subst</span> terminates_within.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> dom terminates_within"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> dom terminates_within"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"terminates_within <span class="skolem">s</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> terminates_within.raw_induct<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 1<span class="main"><span class="main">,</span></span> <span class="operator">consumes</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">terminates_within</span> <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Done
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.stop<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="skolem">s</span> <span class="main">=</span> Skip <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.pause<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">g</span> <span class="skolem">s</span> <span class="main">=</span> Yield <span class="skolem">a</span> <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_wfE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">R</span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="main">=</span> Skip <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="free">g</span> <span class="bound">s</span> <span class="main">=</span> Yield <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> the <span class="main">(</span>terminates_within <span class="free">g</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span> <span class="main">=</span> Skip <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"terminates_within <span class="free">g</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> terminates_on_conv_dom_terminates_within <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>terminates_within <span class="free">g</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">&lt;</span> the <span class="main">(</span>terminates_within <span class="free">g</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_within.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">a</span>
    <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span> <span class="main">=</span> Yield <span class="skolem">a</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"terminates_within <span class="free">g</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> terminates_on_conv_dom_terminates_within <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s'</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">subst</span> terminates_within.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">ultimately</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> generator <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> raw_generator<span class="main">.</span> terminates <span class="bound">g</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> generator Generator
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done<span class="main">)</span> <span class="main">∈</span> <span class="var">?generator</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on_stop terminates_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_generator

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">unstream</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unstream</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> <span class="main">[]</span>
   <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">unstream</span> <span class="bound">s'</span>
   <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">#</span> <span class="free">unstream</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>generator <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generator<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_wfE<span class="main">)</span><span class="main">(</span><span class="operator">erule</span> <span class="quoted">"termination"</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Done <span class="main">⟹</span> unstream <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Skip <span class="free">s'</span> <span class="main">⟹</span> unstream <span class="free">s</span> <span class="main">=</span> unstream <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Yield <span class="free">x</span> <span class="free">s'</span> <span class="main">⟹</span> unstream <span class="free">s</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> unstream <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> unstream.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">force</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">force</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Done <span class="main">⇒</span> None 
     <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">force</span> <span class="bound">s'</span>
     <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>generator <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> generator<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_wfE<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="quoted">"termination"</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> force_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Done <span class="main">⟹</span> force <span class="free">s</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Skip <span class="free">s'</span> <span class="main">⟹</span> force <span class="free">s</span> <span class="main">=</span> force <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Yield <span class="free">x</span> <span class="free">s'</span> <span class="main">⟹</span> force <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> force.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_force_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"force <span class="free">s</span> <span class="main">=</span> None <span class="main">⟹</span> unstream <span class="free">s</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> force.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_force_Some <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"force <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">⟹</span> unstream <span class="free">s</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> unstream <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> force.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Context.theory_map <span class="main">(</span><span class="entity">Stream_Fusion.add_unstream</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> unstream<span class="antiquote">}</span></span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Producers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion to streams›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stream_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">)</span> step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stream_raw</span> <span class="main">[]</span> <span class="main">=</span> Done"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">stream_raw</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_stream_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"terminates stream_raw"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on stream_raw"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> stream <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list<span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"stream_raw"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_stream_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_stream<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream stream <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> replicate<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replicate_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replicate_raw</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">0</span> <span class="main">=</span> Done"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replicate_raw</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> terminates_replicate_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>replicate_raw <span class="free">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>replicate_raw <span class="free">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> replicate_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"replicate_raw"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_replicate_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_replicate_prod <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>replicate_prod <span class="free">x</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> replicate <span class="free">n</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replicate_prod.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> upt<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upt_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">upt_raw</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Done <span class="keyword1">else</span> Yield <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_upt_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>upt_raw <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>upt_raw <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="skolem">s</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat.induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_raw_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upt_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat<span class="main">,</span> nat<span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"upt_raw"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_upt_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_upt_prod <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>upt_prod <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> upt <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="free">m</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_prod.rep_eq upt_conv_Cons upt_raw_def unstream.simps<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> upto<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">upto_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> <span class="main">(</span>int<span class="main">,</span> int<span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">upto_raw</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> Yield <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> Done<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_upto_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>upto_raw <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>upto_raw <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"nat<span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">s</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upto_raw_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upto_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> <span class="main">(</span>int<span class="main">,</span> int<span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"upto_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_upto_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_upto_prod <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>upto_prod <span class="free">n</span><span class="main">)</span> <span class="free">m</span> <span class="main">=</span> upto <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upto_prod.rep_eq upto.simps upto_raw_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Nil_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> generator_Nil_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"generator Nil_prod <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> Nil_prod.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_Nil_prod <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream Nil_prod <span class="main">()</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> generator_Nil_prod<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consumers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> nth<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nth_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nth_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nth_cons <span class="free">s</span> <span class="free">n</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">=&gt;</span> undefined <span class="free">n</span>
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">=&gt;</span> nth_cons <span class="bound">s'</span> <span class="free">n</span>
    <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">=&gt;</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">n</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">=&gt;</span> <span class="bound">x</span> <span class="main">|</span> Suc <span class="bound">n'</span> <span class="main">=&gt;</span> nth_cons <span class="bound">s'</span> <span class="bound">n'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_cons_def nth_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">length</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">length_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">length_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> length <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length_cons <span class="free">s</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> <span class="main">0</span>
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> length_cons <span class="bound">s'</span>
    <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="main">1</span> <span class="main">+</span> length_cons <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_length_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_length_cons</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> length <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_length_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_length_cons <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> <span class="free">n</span> <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> gen_length_cons <span class="free">n</span> <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> gen_length_cons <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_length_cons_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_gen_length <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gen_length_cons <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> length <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_length_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_gen_length2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gen_length_cons <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> List.gen_length <span class="free">n</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> List.gen_length_def gen_length_cons_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> foldr<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">foldr_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">foldr_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> foldr <span class="free">f</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free">z</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldr_cons <span class="free">s</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> <span class="free">z</span>
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> foldr_cons <span class="bound">s'</span>
    <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">(</span>foldr_cons <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldr_cons_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> foldl<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">foldl_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">foldl_cons</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> foldl <span class="free">f</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_cons <span class="free">z</span> <span class="free">s</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> <span class="free">z</span>
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> foldl_cons <span class="free">z</span> <span class="bound">s'</span>
    <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> foldl_cons <span class="main">(</span><span class="free">f</span> <span class="free">z</span> <span class="bound">a</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_cons_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fold<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fold_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fold_cons</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold_cons <span class="free">z</span> <span class="free">s</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> <span class="free">z</span>
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> fold_cons <span class="free">z</span> <span class="bound">s'</span>
    <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> fold_cons <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="free">z</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fold_cons_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> List.null<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">null_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">null_cons</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> List.null <span class="main">(</span>unstream <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> null_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"null_cons <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> null_cons <span class="free">g</span> <span class="bound">s'</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> null_cons_def null_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> hd<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hd_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hd_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> hd <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hd_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"hd_cons <span class="free">s</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> undefined
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> hd_cons <span class="bound">s'</span>
    <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_cons_def hd_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> last<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">last_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">last_cons</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> the <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> last <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"last_cons <span class="free">x</span> <span class="free">s</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> the <span class="free">x</span>
             <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> last_cons <span class="free">x</span> <span class="bound">s'</span>
             <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> last_cons <span class="main">(</span>Some <span class="bound">a</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_last_cons <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_cons None <span class="free">s</span> <span class="main">=</span> last <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_cons_def last_def option.the_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sum_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> monoid_add<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sum_list_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sum_list_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> sum_list <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_list_cons <span class="free">s</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> <span class="main">0</span>
    <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> sum_list_cons <span class="bound">s'</span>
    <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="bound">a</span> <span class="main">+</span> sum_list_cons <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="free">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_list_cons_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> list_all2<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_all2_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'s2</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">list_all2_cons</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">=</span> list_all2 <span class="free">P</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_all2_cons1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'s2</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">list_all2_cons1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sg'</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">=</span> list_all2 <span class="free">P</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sg'</span></span></span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_cons <span class="free">sg</span> <span class="free">sh</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">sg</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> null_cons <span class="free">h</span> <span class="free">sh</span>
   <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> list_all2_cons <span class="bound">sg'</span> <span class="free">sh</span>
   <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> list_all2_cons1 <span class="bound">a</span> <span class="bound">sg'</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_cons_def null_cons_def List.null_def list_all2_cons1_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_cons1_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all2_cons1 <span class="free">x</span> <span class="free">sg'</span> <span class="free">sh</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">h</span> <span class="free">sh</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> False
   <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> list_all2_cons1 <span class="free">x</span> <span class="free">sg'</span> <span class="bound">sh'</span>
   <span class="main">|</span> Yield <span class="bound">y</span> <span class="bound">sh'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">∧</span> list_all2_cons <span class="free">sg'</span> <span class="bound">sh'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_cons_def null_cons_def List.null_def list_all2_cons1_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> list_all<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_all_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">list_all_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> list_all <span class="free">P</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all_cons <span class="free">s</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> list_all_cons <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">∧</span> list_all_cons <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_cons_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ord.lexordp<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> ord <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lexord_fusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'s2</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lexord_fusion</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> ord_class.lexordp <span class="main">(</span>unstream <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">(</span>unstream <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lexord_eq_fusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'s2</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lexord_eq_fusion</span> <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">=</span> lexordp_eq <span class="main">(</span>unstream <span class="free"><span class="bound"><span class="entity">g1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">(</span>unstream <span class="free"><span class="bound"><span class="entity">g2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexord_fusion_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lexord_fusion <span class="free">g1</span> <span class="free">g2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g1</span> <span class="free">s1</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> <span class="main">¬</span> null_cons <span class="free">g2</span> <span class="free">s2</span>
   <span class="main">|</span> Skip <span class="bound">s1'</span> <span class="main">⇒</span> lexord_fusion <span class="free">g1</span> <span class="free">g2</span> <span class="bound">s1'</span> <span class="free">s2</span>
   <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s1'</span> <span class="main">⇒</span> 
     <span class="main">(</span><span class="keyword1">case</span> force <span class="free">g2</span> <span class="free">s2</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> False
      <span class="main">|</span> Some <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> lexord_fusion <span class="free">g1</span> <span class="free">g2</span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lexord_fusion_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g1</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"force <span class="free">g2</span> <span class="free">s2</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> option.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> null_cons_def null_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexord_eq_fusion_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lexord_eq_fusion <span class="free">g1</span> <span class="free">g2</span> <span class="free">s1</span> <span class="free">s2</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="keyword1">case</span> generator <span class="free">g1</span> <span class="free">s1</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> True
   <span class="main">|</span> Skip <span class="bound">s1'</span> <span class="main">⇒</span> lexord_eq_fusion <span class="free">g1</span> <span class="free">g2</span> <span class="bound">s1'</span> <span class="free">s2</span>
   <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s1'</span> <span class="main">⇒</span>
     <span class="main">(</span><span class="keyword1">case</span> force <span class="free">g2</span> <span class="free">s2</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> False
      <span class="main">|</span> Some <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">∨</span> <span class="main">¬</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> lexord_eq_fusion <span class="free">g1</span> <span class="free">g2</span> <span class="bound">s1'</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> lexord_eq_fusion_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g1</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"force <span class="free">g2</span> <span class="free">s2</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> option.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span>
  lexord_fusion_code ord.lexord_fusion_code
  lexord_eq_fusion_code ord.lexord_eq_fusion_code

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span> <span class="main">=</span>
  lexord_fusion_def ord.lexord_fusion_def
  lexord_eq_fusion_def ord.lexord_eq_fusion_def

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transformers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> map<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">map_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_raw</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done
   <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="bound">s'</span>
   <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_map_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>map_raw <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>map_raw <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> map_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"map_raw"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_map_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_map_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>map_trans <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_trans.rep_eq map_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> drop<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">drop_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">drop_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>
   <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Suc <span class="bound">n</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_drop_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>drop_raw <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>drop_raw <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> drop_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"drop_raw"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_drop_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_drop_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>drop_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">n</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> nat.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> dropWhile<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dropWhile_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
  <span class="comment1">― ‹Boolean flag indicates whether we are still in dropping phase›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dropWhile_raw</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>True<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>
   <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span> <span class="keyword1">then</span> Skip <span class="main">(</span>True<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">else</span> Yield <span class="bound">a</span> <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dropWhile_raw</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_dropWhile_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>dropWhile_raw <span class="free">P</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>dropWhile_raw <span class="free">P</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>stop <span class="skolem">s</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.stop<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pause <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.pause<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.pause terminates_on.unfold<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> dropWhile_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"dropWhile_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_dropWhile_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_dropWhile_trans_False<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>dropWhile_trans <span class="free">P</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dropWhile_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_dropWhile_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>dropWhile_trans <span class="free">P</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> dropWhile <span class="free">P</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span> unstream_dropWhile_trans_False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dropWhile_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dropWhile_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> take<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">take_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">take_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Done"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">take_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> 
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_take_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>take_raw <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>take_raw <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> take_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"take_raw"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_take_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_take_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>take_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> nat.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> takeWhile<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">takeWhile_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">takeWhile_raw</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span> <span class="keyword1">then</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="keyword1">else</span> Done<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_takeWhile_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>takeWhile_raw <span class="free">P</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>takeWhile_raw <span class="free">P</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> terminates_on.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_raw_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> takeWhile_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"takeWhile_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_takeWhile_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_takeWhile_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>takeWhile_trans <span class="free">P</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> takeWhile <span class="free">P</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_trans.rep_eq takeWhile_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> append<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">append_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span> <span class="main">+</span> <span class="tfree">'sh</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">append_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">sh_start</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Skip <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">sh_start</span></span></span><span class="main">)</span> <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Inl <span class="bound">sg'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>Inl <span class="bound">sg'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">append_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">sh_start</span></span></span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Inr <span class="bound">sh'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sh'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>Inr <span class="bound">sh'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_on_append_raw_Inr<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inr <span class="free">sh</span> <span class="main">∈</span> terminates_on <span class="main">(</span>append_raw <span class="free">g</span> <span class="free">h</span> <span class="free">sh_start</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sh</span> <span class="main">∈</span> terminates_on <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sh</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_append_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>append_raw <span class="free">g</span> <span class="free">h</span> <span class="free">sh_start</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>append_raw <span class="free">g</span> <span class="free">h</span> <span class="free">sh_start</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">sg</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>append_raw <span class="free">g</span> <span class="free">h</span> <span class="free">sh_start</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Inl
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros terminates_on_append_raw_Inr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹terminates <span class="free">h</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on_append_raw_Inr<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹terminates <span class="free">h</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> append_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span> <span class="main">+</span> <span class="tfree">'sh</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"append_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_append_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_append_trans_Inr<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>append_trans <span class="free">g</span> <span class="free">h</span> <span class="free">sh</span><span class="main">)</span> <span class="main">(</span>Inr <span class="free">sh'</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">h</span> <span class="free">sh'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sh'</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sh'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">h</span> <span class="skolem">sh'</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_append_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>append_trans <span class="free">g</span> <span class="free">h</span> <span class="free">sh</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">sg</span><span class="main">)</span> <span class="main">=</span> append <span class="main">(</span>unstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sg</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> unstream_append_trans_Inr 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> filter<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">filter_raw</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">a</span> <span class="keyword1">then</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="keyword1">else</span> Skip <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_filter_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>filter_raw <span class="free">P</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>filter_raw <span class="free">P</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">a</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_raw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> filter_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"filter_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_filter_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_filter_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>filter_trans <span class="free">P</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_trans.rep_eq filter_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span><span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> zip<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">zip_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sg</span> <span class="main">×</span> <span class="tfree">'sh</span> <span class="main">×</span> <span class="tfree">'a</span> option<span class="main">)</span> raw_generator"</span></span>
  <span class="comment1">― ‹We search first the left list for the next element and cache it in the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="tfree">'a</span> option"</span><span class="antiquote">}</span></span>
        part of the state once we found one›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">zip_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">sg'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">sg'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">,</span> Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">zip_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">,</span> <span class="bound">sh'</span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">b</span> <span class="bound">sh'</span> <span class="main">⇒</span> Yield <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">,</span> <span class="bound">sh'</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_zip_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>zip_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span> option"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sg</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>zip_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>›</span></span> None
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sg</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sh</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">sg</span> <span class="skolem">a</span> <span class="skolem">sg'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">h</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sg'</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> Some <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>zip_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros unfold.IH<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> unfold.hyps <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.pause<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.stop terminates_on.pause<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">h</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>›</span></span> Some
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sg</span></span> <span class="quoted"><span class="skolem">a'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">sh</span> <span class="skolem">b</span> <span class="skolem">sh'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh'</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>zip_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros unfold.IH<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> unfold.hyps <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.stop terminates_on.pause<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> zip_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span><span class="tfree">'sg</span> <span class="main">×</span> <span class="tfree">'sh</span> <span class="main">×</span> <span class="tfree">'a</span> option<span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"zip_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_zip_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_zip_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>zip_trans <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> zip <span class="main">(</span>unstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>        
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sg</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sh</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">sg'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Yield<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>zip_trans <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span><span class="skolem">sg'</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> Some <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> zip <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="skolem">sg'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="skolem">sh</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sh</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">h</span> <span class="skolem">sh</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_trans.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Yield <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> tl<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tl_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'sg</span><span class="main">)</span> raw_generator"</span></span>
  <span class="comment1">― ‹The Boolean flag stores whether we have already skipped the first element›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tl_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span>False<span class="main">,</span> <span class="bound">sg'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span>True<span class="main">,</span><span class="bound">sg'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tl_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="keyword1">of</span>
      Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span>True<span class="main">,</span> <span class="bound">sg'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>True<span class="main">,</span> <span class="bound">sg'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_tl_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>tl_raw <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">sg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">sg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sg</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>True<span class="main">,</span> <span class="skolem">sg</span><span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>tl_raw <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sg</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>False<span class="main">,</span> <span class="skolem">sg</span><span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>tl_raw <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sg</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros calculation<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>tl_raw <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">sg</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> tl_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'sg</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"tl_raw"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_tl_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_tl_trans_True<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>tl_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_tl_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>tl_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> unstream_tl_trans_True
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> butlast<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">butlast_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
  <span class="comment1">― ‹The <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">"<span class="tfree">'a</span> option"</span><span class="antiquote">}</span></span> caches the previous element we have seen›</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">butlast_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>None<span class="main">,</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>None<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">butlast_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_butlast_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>butlast_raw <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> option <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ma</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ma</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>butlast_raw <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ma</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ma</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ma</span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> butlast_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"butlast_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_butlast_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_butlast_trans_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>butlast_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">b</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_butlast_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>butlast_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span>None<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 unstream_butlast_trans_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> concat<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We only do the easy version here where
  the generator has type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span> list<span class="main"><span class="main">,</span></span><span class="tfree"><span class="tfree">'s</span></span><span class="main"><span class="main">)</span></span> generator"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, not <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'a</span></span><span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'si</span></span><span class="main"><span class="main">)</span></span> generator<span class="main"><span class="main">,</span></span> <span class="tfree"><span class="tfree">'s</span></span><span class="main"><span class="main">)</span></span> generator"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">concat_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">concat_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">xs</span> <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">concat_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_concat_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>concat_raw <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>concat_raw <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>stop <span class="skolem">s</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.stop terminates_on.unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pause <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.pause terminates_on.unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.pause terminates_on.unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> concat_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"concat_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_concat_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_concat_trans_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>concat_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span>concat <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>concat_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">(</span>concat <span class="main">(</span>unstream <span class="free">g</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Done
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted">Nil</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_concat_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>concat_trans <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> unstream_concat_trans_gen append_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> splice<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> splice_state <span class="main">=</span> Left <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="main">|</span> Right <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span> <span class="main">|</span> Left_only <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Right_only <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">splice_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'sg</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> splice_state<span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splice_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Left_only <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Left_only <span class="bound">sg'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>Left_only <span class="bound">sg'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">splice_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Skip <span class="main">(</span>Right_only <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Left <span class="bound">sg'</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>Right <span class="bound">sg'</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">splice_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Right_only <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Right_only <span class="bound">sh'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sh'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>Right_only <span class="bound">sh'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">splice_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">h</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Skip <span class="main">(</span>Left_only <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> Skip <span class="main">(</span>Right <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="bound">sh'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sh'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>Left <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="bound">sh'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_splice_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"terminates <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sg</span>
    <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Left_only <span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sh</span>
    <span class="keyword1"><span class="command">from</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Right_only <span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sg</span> <span class="skolem">sh</span>
    <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Left <span class="skolem">sg</span> <span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sg</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sh</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">sg</span> <span class="skolem">a</span> <span class="skolem">sg'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Right <span class="skolem">sg'</span> <span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros unfold.IH calculation<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> unfold.hyps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros calculation<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sg</span> <span class="skolem">sh</span>
    <span class="keyword1"><span class="command">from</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="free">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Right <span class="skolem">sg</span> <span class="skolem">sh</span> <span class="main">∈</span> terminates_on <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sg</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros calculation<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>splice_raw <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> splice_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'sg</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> splice_state<span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"splice_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_splice_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_splice_trans_Right_only<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>splice_trans <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Right_only <span class="free">sh</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">h</span> <span class="free">sh</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sh</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sh</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">h</span> <span class="skolem">sh</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_splice_trans_Left_only<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>splice_trans <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Left_only <span class="free">sg</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free">sg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sg</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_splice_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>splice_trans <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Left <span class="free">sg</span> <span class="free">sh</span><span class="main">)</span> <span class="main">=</span> splice <span class="main">(</span>unstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">sg</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sh</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sg</span> <span class="skolem">sh</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Done
    <span class="keyword1"><span class="command">with</span></span> unstream_splice_trans_Right_only<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">sg'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">sg'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Yield<span class="main">]</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">#</span> <span class="main">(</span>unstream <span class="main">(</span>splice_trans <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>Right <span class="skolem">sg'</span> <span class="skolem">sh</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> splice <span class="main">(</span>unstream <span class="free">g</span> <span class="skolem">sg</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">h</span> <span class="skolem">sh</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">sh</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">h</span> <span class="skolem">sh</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Done
        <span class="keyword1"><span class="command">with</span></span> unstream_splice_trans_Left_only<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="skolem">sg'</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Yield <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">sh'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Yield <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">b</span> <span class="skolem">sh'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="quoted"><span class="quoted">‹generator <span class="free">g</span> <span class="skolem">sg</span> <span class="main">=</span> Yield <span class="skolem">a</span> <span class="skolem">sg'</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Yield <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splice_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> list_update<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_update_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_update_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> 
   <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Yield <span class="bound">a</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span>
                   <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> Yield <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>
                   <span class="keyword1">else</span> Yield <span class="bound">a</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_list_update_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>list_update_raw <span class="free">g</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>list_update_raw <span class="free">g</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span> <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>list_update_raw <span class="free">g</span> <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.stop terminates_on.pause<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> list_update_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span>  generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"list_update_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_list_update_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_lift_update_trans_None<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>list_update_trans <span class="free">g</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_list_update_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>list_update_trans <span class="free">g</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> list_update <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span> <span class="free">n</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Done
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> unstream_lift_update_trans_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_update_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> removeAll<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">removeAll_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">removeAll_raw</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Skip <span class="bound">s'</span> <span class="keyword1">else</span> Yield <span class="bound">a</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_removeAll_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>removeAll_raw <span class="free">b</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span>removeAll_raw <span class="free">b</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> removeAll_raw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> removeAll_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> removeAll_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"removeAll_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_removeAll_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_removeAll_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>removeAll_trans <span class="free">b</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> removeAll <span class="free">b</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> removeAll_trans.rep_eq removeAll_raw_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> removeAll_trans.rep_eq removeAll_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> remove1<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove1_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove1_raw</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> 
   <span class="main">|</span> Yield <span class="bound">y</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> Skip <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">else</span> Yield <span class="bound">y</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_remove1_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>remove1_raw <span class="free">b</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>remove1_raw <span class="free">b</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>stop <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.stop<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pause <span class="skolem">s</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_on.pause<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unfold <span class="skolem">s</span> <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
   <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> remove1_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator "</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"remove1_raw"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> terminates_remove1_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_remove1_trans_False<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>remove1_trans <span class="free">b</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_remove1_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>remove1_trans <span class="free">b</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> remove1 <span class="free">b</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">a</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Yield <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span> unstream_remove1_trans_False<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_trans.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove1_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(#)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Cons_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Cons_raw</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">y</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="bound">y</span> <span class="main">(</span>False<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_Cons_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>Cons_raw <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> terminatesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>False<span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>Cons_raw <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>Cons_raw <span class="free">x</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Cons_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Cons_raw</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_Cons_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_Cons_trans_False<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>Cons_trans <span class="free">x</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We do not declare <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Cons_trans<span class="antiquote"><span class="antiquote">}</span></span></span></span> as a transformer.
  Otherwise, literal lists would be transformed into streams which adds a significant overhead
  to the stream state.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> unstream_Cons_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>Cons_trans <span class="free">x</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> unstream <span class="free">g</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> unstream_Cons_trans_False<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons_trans.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> List.maps<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Stream version based on Coutts \cite{Coutts2010PhD}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We restrict the function for generating the inner lists to terminating
  generators because the code generator does not directly supported nesting abstract
  datatypes in other types.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">maps_raw</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">×</span> <span class="tfree">'sg</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">×</span> <span class="tfree">'sg</span><span class="main">)</span> option<span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maps_raw</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> None<span class="main">)</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">maps_raw</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g''</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> generator <span class="free"><span class="bound"><span class="entity">g''</span></span></span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g''</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g''</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_on_maps_raw_Some<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>maps_raw <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> Some <span class="main">(</span><span class="free">g''</span><span class="main">,</span> <span class="free">s''</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> terminates_on <span class="main">(</span>maps_raw <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> generator<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g''</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s''</span> <span class="main">∈</span> terminates_on <span class="main">(</span>generator <span class="free">g''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_maps_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>maps_raw <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> generator <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> option"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">mgs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">mgs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>maps_raw <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">mgs</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">mgs</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">mgs</span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> terminates_on_maps_raw_Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> maps_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">×</span> <span class="tfree">'sg</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> generator <span class="main">×</span> <span class="tfree">'sg</span><span class="main">)</span> option<span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"maps_raw"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_maps_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_maps_trans_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>maps_trans <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Some <span class="main">(</span><span class="free">g''</span><span class="main">,</span> <span class="free">s''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g''</span> <span class="free">s''</span> <span class="main">@</span> unstream <span class="main">(</span>maps_trans <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s''</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g''</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g''</span> <span class="skolem">s''</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_trans.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_maps_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>maps_trans <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> List.maps <span class="main">(</span>case_prod unstream <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">x</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> unstream_maps_trans_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_trans.rep_eq maps_simps split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_trans.rep_eq maps_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The rule <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] unstream_map_trans<span class="antiquote"><span class="antiquote">}</span></span></span></span> is too complicated for fusion because of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">split</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  which does not arise naturally from stream fusion rules. Moreover, according to Farmer et al.
  \cite{FarmerHoenerGill2014PEPM}, this fusion is too general for further optimisations because the
  generators of the inner list are generated by the outer generator and therefore compilers may
  think that is was not known statically. 

  Instead, they propose a weaker version using <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>flatten›</span></span></span></span> below.
  (More precisely, Coutts already mentions this approach in his PhD thesis \cite{Coutts2010PhD},
  but dismisses it because it requires a stronger rewriting engine than GHC has. But Isabelle's
  simplifier language is sufficiently powerful.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fix_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> step <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> step"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fix_step</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> Done <span class="main">=</span> Done"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fix_step</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Skip <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fix_step</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fix_gen_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fix_gen_raw</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> fix_step <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_fix_gen_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> terminates <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates <span class="main">(</span>fix_gen_raw <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="main">(</span><span class="free">g</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on <span class="main">(</span>fix_gen_raw <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fix_gen <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"fix_gen_raw"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> terminates_fix_gen_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_fix_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>fix_gen <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> unstream <span class="main">(</span><span class="free">g</span> <span class="free">a</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">a</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="main">(</span><span class="free">g</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fix_gen.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g''</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s'</span><span class="main">)</span> raw_generator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">flatten_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s'</span> option<span class="main">)</span> raw_generator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flatten_raw</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> None<span class="main">)</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">flatten_raw</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">s''</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g''</span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Some <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Some <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> terminates_flatten_raw<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g''</span>"</span></span> <span class="quoted"><span class="quoted">"terminates <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"terminates flatten_raw"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">st</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s'</span> option"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ms</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ms</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">st</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">s''</span>
    <span class="keyword3"><span class="command">assume</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> terminates_on flatten_raw"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">g''</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">∈</span> terminates_on <span class="free">g''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> Some <span class="skolem">s''</span><span class="main">)</span> <span class="main">∈</span> terminates_on flatten_raw"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros s<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> Some <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹terminates <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">∈</span> terminates_on flatten_raw"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">ms</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ms</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">ms</span></span></span></span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> terminates_on.intros <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Some<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> flatten <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s'</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s'</span> option<span class="main">)</span> generator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"flatten_raw"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> terminates_flatten_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_flatten_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>flatten <span class="free">f</span> <span class="free">g''</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> Some <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> unstream <span class="free">g''</span> <span class="free">s'</span> <span class="main">@</span> unstream <span class="main">(</span>flatten <span class="free">f</span> <span class="free">g''</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g''</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g''</span> <span class="skolem">s'</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatten.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹HO rewrite equations can express the variable capture in the generator unlike GHC rules›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> unstream_flatten_fix_gen <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>flatten <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fix_gen <span class="free">g''</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span>
   List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> unstream <span class="main">(</span><span class="free">g''</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">x</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> unstream_flatten_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fix_gen <span class="free">g''</span>"</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 3<span class="main"><span class="main">)</span></span> unstream.simps<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatten.rep_eq maps_simps unstream_fix_gen<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatten.rep_eq maps_simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Separate fusion rule when the inner generator does not depend on the elements of the outer stream.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> unstream_flatten <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span>flatten <span class="free">f</span> <span class="free">g''</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> unstream <span class="free">g''</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"generator <span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">x</span> <span class="skolem">s'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> unstream_flatten_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g''</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="skolem">s'</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flatten.rep_eq maps_simps o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> maps_simps flatten.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Stream_Fusion_LList">
<div class="head">
<h1>Theory Stream_Fusion_LList</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Stream_Fusion_LList
  Author: Andreas Lochbihler, ETH Zurich *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Stream fusion for coinductive lists›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stream_Fusion_LList <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Stream_Fusion_List.html">Stream_Fusion_List</a>
  <a href="../Coinductive/Coinductive_List.html">Coinductive.Coinductive_List</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  There are two choices of how many <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Skip<span class="antiquote"><span class="antiquote">}</span></span></span></span>s may occur consecutively.
  \begin{itemize}
  \item A generator for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> llist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may return only finitely many <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Skip<span class="antiquote"><span class="antiquote">}</span></span></span></span>s before
    it has to decide on a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Done<span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Yield<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then, we can define stream versions
    for all functions that can be defined by corecursion up-to. This in particular excludes
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lfilter<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Moreover, we have to prove that every generator satisfies this
    restriction.
  \item A generator for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> llist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> may return infinitely many <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Skip<span class="antiquote"><span class="antiquote">}</span></span></span></span>s in a row.
    Then, the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lunstream›</span></span></span></span> function suffers from the same difficulties as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lfilter<span class="antiquote"><span class="antiquote">}</span></span></span></span> with
    definitions, but we can define it using the least fixpoint approach described in
    \cite{LochbihlerHoelzl2014ITP}. Consequently, we can only fuse transformers that are monotone and
    continuous with respect to the ccpo ordering. This in particular excludes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lappend<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \end{itemize}
  Here, we take the both approaches where we consider the first preferable to the second.
  Consequently, we define producers such that they produce generators of the first kind, if possible.
  There will be multiple equations for transformers and consumers that deal with all the different
  combinations for their parameter generators. Transformers should yield generators of the first
  kind whenever possible. Consumers can be defined using <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lunstream›</span></span></span></span> and refined with custom
  code equations, i.e., they can operate with infinitely many <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>Skip›</span></span></span></span>s in a row. We just
  have to lift the fusion equation to the first kind, too.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> step"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">productive_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="entity">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  Done<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Done <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">productive_on</span> <span class="free">g</span>"</span></span>
<span class="main">|</span> Skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Skip <span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">∈</span> <span class="free">productive_on</span> <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">productive_on</span> <span class="free">g</span>"</span></span>
<span class="main">|</span> Yield<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="free">productive_on</span> <span class="free">g</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">productive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">productive</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> productive_on <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> UNIV"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> productiveI <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> productive_on <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> productive <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> productive_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> productive_onI <span class="main">[</span><span class="operator">dest</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="free">g</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> productive_on <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> productive_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A type of generators that eventually will yield something else than a skip.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator' <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">g</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator<span class="main">.</span> productive <span class="bound">g</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> lgenerator Abs_lgenerator'
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done<span class="main">)</span> <span class="main">∈</span> <span class="var">?lgenerator'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros productiveI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_lgenerator'

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversions to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> llist"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Infinitely many consecutive <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Skip</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">function_internals</span><span class="main">]</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>llist<span class="main">)</span> <span class="entity">lunstream</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> llist"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lunstream</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> 
     Done <span class="main">⇒</span> LNil <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> <span class="free">lunstream</span> <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> LCons <span class="bound">x</span> <span class="main">(</span><span class="free">lunstream</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> lunstream.simps<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Done <span class="main">⟹</span> lunstream <span class="free">s</span> <span class="main">=</span> LNil"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Skip <span class="free">s'</span> <span class="main">⟹</span> lunstream <span class="free">s</span> <span class="main">=</span> lunstream <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Yield <span class="free">x</span> <span class="free">s'</span> <span class="main">⟹</span> lunstream <span class="free">s</span> <span class="main">=</span> LCons <span class="free">x</span> <span class="main">(</span>lunstream <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_sels<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> lnull_lunstream<span class="main">:</span> <span class="quoted"><span class="quoted">"lnull <span class="main">(</span>lunstream <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lnull <span class="main">(</span>lunstream <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lhd_lunstream<span class="main">:</span> <span class="quoted"><span class="quoted">"lhd <span class="main">(</span>lunstream <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lhd <span class="main">(</span>lunstream <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ltl_lunstream<span class="main">:</span> <span class="quoted"><span class="quoted">"ltl <span class="main">(</span>lunstream <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> LNil <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> ltl <span class="main">(</span>lunstream <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="bound">s'</span> <span class="main">⇒</span> lunstream <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhd_def lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Finitely many consecutive <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Skip</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> lunstream' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> llist"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">lunstream</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream'_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lgenerator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Done <span class="main">⟹</span> lunstream' <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> LNil"</span></span>
  <span class="quoted"><span class="quoted">"lgenerator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Skip <span class="free">s'</span> <span class="main">⟹</span> lunstream' <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> lunstream' <span class="free">g</span> <span class="free">s'</span>"</span></span>
  <span class="quoted"><span class="quoted">"lgenerator <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> Yield <span class="free">x</span> <span class="free">s'</span> <span class="main">⟹</span> lunstream' <span class="free">g</span> <span class="free">s</span> <span class="main">=</span> LCons <span class="free">x</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream'_sels<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> lnull_lunstream'<span class="main">:</span> <span class="quoted"><span class="quoted">"lnull <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="keyword1">case</span> lgenerator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lnull <span class="main">(</span>lunstream' <span class="free">g</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lhd_lunstream'<span class="main">:</span> <span class="quoted"><span class="quoted">"lhd <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> lgenerator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lhd <span class="main">(</span>lunstream' <span class="free">g</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ltl_lunstream'<span class="main">:</span> <span class="quoted"><span class="quoted">"ltl <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> lgenerator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> LNil <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> ltl <span class="main">(</span>lunstream' <span class="free">g</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="bound">s'</span> <span class="main">⇒</span> lunstream' <span class="free">g</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_sels<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">setup</span></span> <span class="quoted">‹Context.theory_map <span class="main">(</span>fold
  <span class="entity">Stream_Fusion.add_unstream</span> <span class="main">[</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lunstream<span class="antiquote">}</span></span><span class="main">,</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const_name</span> lunstream'<span class="antiquote">}</span></span><span class="main">]</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Producers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion to streams›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lstream</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> llist<span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lstream</span> LNil <span class="main">=</span> Done"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lstream</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_lstream_conv_case_llist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> lstream <span class="free">xs</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> <span class="free">done</span> <span class="main">|</span> Skip <span class="bound">xs'</span> <span class="main">⇒</span> <span class="free">skip</span> <span class="bound">xs'</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">xs'</span> <span class="main">⇒</span> <span class="free">yield</span> <span class="bound">x</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free">xs</span> <span class="keyword1">of</span> LNil <span class="main">⇒</span> <span class="free">done</span> <span class="main">|</span> LCons <span class="bound">x</span> <span class="bound">xs'</span> <span class="main">⇒</span> <span class="free">yield</span> <span class="bound">x</span> <span class="bound">xs'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> llist.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mcont2mcont_lunstream<span class="main">[</span><span class="operator">THEN</span> llist.mcont2mcont<span class="main">,</span> <span class="operator">simp</span><span class="main">,</span> <span class="operator">cont_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> mcont_lunstream<span class="main">:</span> <span class="quoted"><span class="quoted">"mcont lSup lprefix lSup lprefix <span class="main">(</span>lunstream lstream<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> llist.fixp_preserves_mcont1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lunstream.mono lunstream_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_lstream_conv_case_llist<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_lstream<span class="main">:</span> <span class="quoted"><span class="quoted">"lunstream lstream <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> lstream' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span> llist<span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">lstream</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> llist"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on lstream"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream'_lstream<span class="main">:</span> <span class="quoted"><span class="quoted">"lunstream' lstream' <span class="free">xs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> lunstream_lstream<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> iterates<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iterates_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iterates_raw</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Yield <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_iterates_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>iterates_raw <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> iterates <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iterates_raw_def lunstream_sels<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> iterates_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lgenerator'"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">iterates_raw</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productiveI productive_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iterates_raw_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream'_iterates_prod <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>iterates_prod <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> iterates <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lunstream_iterates_raw<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> unfold_llist<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unfold_llist_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">unfold_llist_raw</span> <span class="free"><span class="bound"><span class="entity">stop</span></span></span> <span class="free"><span class="bound"><span class="entity">head</span></span></span> <span class="free"><span class="bound"><span class="entity">tail</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">stop</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> Done <span class="keyword1">else</span> Yield <span class="main">(</span><span class="free"><span class="bound"><span class="entity">head</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tail</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_unfold_llist_raw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>unfold_llist_raw <span class="free">stop</span> <span class="free">head</span> <span class="free">tail</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> unfold_llist <span class="free">stop</span> <span class="free">head</span> <span class="free">tail</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_sels unfold_llist_raw_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> unfold_llist_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">unfold_llist_raw</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> productiveI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">stop</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">head</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">tail</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="main">(</span>unfold_llist_raw <span class="skolem">stop</span> <span class="skolem">head</span> <span class="skolem">tail</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">stop</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unfold_llist_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream'_unfold_llist_prod <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>unfold_llist_prod <span class="free">stop</span> <span class="free">head</span> <span class="free">tail</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> unfold_llist <span class="free">stop</span> <span class="free">head</span> <span class="free">tail</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lunstream_unfold_llist_raw<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> inf_llist<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inf_llist_raw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inf_llist_raw</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Yield <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_inf_llist_raw<span class="main">:</span> <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>inf_llist_raw <span class="free">f</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> ldropn <span class="free">n</span> <span class="main">(</span>inf_llist <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_sels inf_llist_raw_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> inf_llist_prod <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat<span class="main">)</span> lgenerator'"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">inf_llist_raw</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productiveI productive_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_llist_raw_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inf_llist_prod_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>inf_llist_prod <span class="free">f</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> inf_llist <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_inf_llist_raw<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Consumers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lhd<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lhd_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lhd_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> lhd <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lhd_cons_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lhd_cons <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span> Done <span class="main">⇒</span> undefined <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lhd_cons <span class="bound">s'</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lhd_cons_def lunstream_simps lhd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lhd_cons_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lhd_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> lhd <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lhd_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> llength<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_llength_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enat <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_llength_cons</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> llength <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_llength_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_llength_cons <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> <span class="free">n</span> <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> gen_llength_cons <span class="free">n</span> <span class="bound">s'</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="bound">s'</span> <span class="main">⇒</span> gen_llength_cons <span class="main">(</span>eSuc <span class="free">n</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_llength_cons_def lunstream_simps iadd_Suc_right iadd_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_llength_cons_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_llength_cons <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> llength <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_llength_cons_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator'"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gen_llength_cons'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enat <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> enat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_llength_cons'</span> <span class="main">=</span> gen_llength_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gen_llength_cons'_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_llength_cons' <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> lgenerator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> <span class="free">n</span> <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> gen_llength_cons' <span class="free">n</span> <span class="bound">s'</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="bound">s'</span> <span class="main">⇒</span> gen_llength_cons' <span class="main">(</span>eSuc <span class="free">n</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_llength_cons'_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> step.case_cong<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> gen_llength_cons_code<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> gen_llength_cons'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gen_llength_cons' <span class="main">0</span> <span class="free">s</span> <span class="main">=</span> llength <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gen_llength_cons'_def gen_llength_cons_fusion lunstream'.rep_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lnull<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lnull_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lnull_cons</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">⟷</span> lnull <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lnull_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lnull_cons <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lnull_cons <span class="bound">s'</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lnull_cons_def lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator'"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lnull_cons'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lnull_cons'</span> <span class="main">=</span> lnull_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lnull_cons'_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lnull_cons' <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> lgenerator <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lnull_cons' <span class="bound">s'</span> <span class="main">|</span> Yield <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lnull_cons'_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> step.case_cong<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> lnull_cons_code<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lnull_cons'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lnull_cons' <span class="free">s</span> <span class="main">⟷</span> lnull <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lnull_cons'_def lnull_cons_def lunstream'.rep_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> llist_all2<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> lgenerator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">llist_all2_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sg</span> <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">llist_all2_cons</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">⟷</span> llist_all2 <span class="free">P</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">llist_all2_cons1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'sg</span> <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">llist_all2_cons1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sg'</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">=</span> llist_all2 <span class="free">P</span> <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sg'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> llist_all2_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"llist_all2_cons <span class="free">sg</span> <span class="free">sh</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">sg</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> lnull_cons <span class="free">h</span> <span class="free">sh</span>
   <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> llist_all2_cons <span class="bound">sg'</span> <span class="free">sh</span>
   <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">sg'</span> <span class="main">⇒</span> llist_all2_cons1 <span class="bound">a</span> <span class="bound">sg'</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> llist_all2_cons_def lnull_cons_def llist_all2_cons1_def lunstream_simps lnull_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> llist_all2_cons1_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"llist_all2_cons1 <span class="free">x</span> <span class="free">sg'</span> <span class="free">sh</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="free">sh</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> False
   <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> llist_all2_cons1 <span class="free">x</span> <span class="free">sg'</span> <span class="bound">sh'</span>
   <span class="main">|</span> Yield <span class="bound">y</span> <span class="bound">sh'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">∧</span> llist_all2_cons <span class="free">sg'</span> <span class="bound">sh'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> llist_all2_cons_def lnull_cons_def lnull_def llist_all2_cons1_def lunstream_simps<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> llist_all2_cons_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"llist_all2_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="main">(</span>lgenerator <span class="free">h</span><span class="main">)</span> <span class="free">P</span> <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> llist_all2 <span class="free">P</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> llist_all2_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> llist_all2_cons_fusion3 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"llist_all2_cons <span class="free">g</span> <span class="main">(</span>lgenerator <span class="free">h</span><span class="main">)</span> <span class="free">P</span> <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> llist_all2 <span class="free">P</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> llist_all2_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> llist_all2_cons_fusion4 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"llist_all2_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">P</span> <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> llist_all2 <span class="free">P</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> llist_all2_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lnth<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lnth_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lnth_cons</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> lnth <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lnth_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lnth_cons <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">s</span> <span class="keyword1">of</span>
    Done <span class="main">⇒</span> undefined <span class="free">n</span>
  <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> lnth_cons <span class="free">n</span> <span class="bound">s'</span>
  <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> lnth_cons <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lnth_cons_def lunstream_simps lnth_LNil <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lnth_cons_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lnth_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> lnth <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lnth_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lprefix<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> lgenerator"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lprefix_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'sg</span> <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lprefix_cons</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">⟷</span> lprefix <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sg</span></span></span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lprefix_cons1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'sg</span> <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lprefix_cons1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">sg'</span></span></span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span> <span class="main">⟷</span> lprefix <span class="main">(</span>LCons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">sg'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free"><span class="bound"><span class="entity">sh</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lprefix_cons_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lprefix_cons <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">g</span> <span class="free">sg</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> True <span class="main">|</span> Skip <span class="bound">sg'</span> <span class="main">⇒</span> lprefix_cons <span class="bound">sg'</span> <span class="free">sh</span> <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">sg'</span> <span class="main">⇒</span> lprefix_cons1 <span class="bound">x</span> <span class="bound">sg'</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lprefix_cons_def lprefix_cons1_def lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lprefix_cons1_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lprefix_cons1 <span class="free">x</span> <span class="free">sg'</span> <span class="free">sh</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="free">sh</span> <span class="keyword1">of</span>
     Done <span class="main">⇒</span> False <span class="main">|</span> Skip <span class="bound">sh'</span> <span class="main">⇒</span> lprefix_cons1 <span class="free">x</span> <span class="free">sg'</span> <span class="bound">sh'</span>
   <span class="main">|</span> Yield <span class="bound">y</span> <span class="bound">sh'</span> <span class="main">⇒</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∧</span> lprefix_cons <span class="free">sg'</span> <span class="bound">sh'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lprefix_cons_def lprefix_cons1_def lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lprefix_cons_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lprefix_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="main">(</span>lgenerator <span class="free">h</span><span class="main">)</span> <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> lprefix <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lprefix_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lprefix_cons_fusion3 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lprefix_cons <span class="free">g</span> <span class="main">(</span>lgenerator <span class="free">h</span><span class="main">)</span> <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> lprefix <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lprefix_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lprefix_cons_fusion4 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lprefix_cons <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">sg</span> <span class="free">sh</span> <span class="main">⟷</span> lprefix <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lprefix_cons_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transformers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lmap<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lmap_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lmap_trans</span> <span class="main">=</span> map_raw"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_lmap_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="free">s</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> lmap_trans <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="free">s</span> <span class="main">=</span> lmap <span class="free">f</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lprefix_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lmap_trans_def map_raw_def lunstream_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">cont_intro</span><span class="main">]</span> <span class="main">=</span> ccpo.admissible_leI<span class="main">[</span><span class="operator">OF</span> llist_ccpo<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lmap_trans_def map_raw_def lunstream_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> lmap_trans' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">lmap_trans</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="main">(</span>lmap_trans <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lmap_trans_def map_raw_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream'_lmap_trans' <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>lmap_trans' <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> lmap <span class="free">f</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lunstream_lmap_trans<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ltake<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltake_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span>enat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltake_trans</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Done <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> 
    Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">|</span> Yield <span class="bound">a</span> <span class="bound">s'</span> <span class="main">⇒</span> Yield <span class="bound">a</span> <span class="main">(</span>epred <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltake_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g'</span> <span class="free">g</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> ltake_trans <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ltake <span class="free">n</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lprefix_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps neq_zero_conv_eSuc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> enat_coexhaust<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ltake_trans' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span>enat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ltake_trans"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enat <span class="main">×</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">sg</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">sg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="main">(</span>ltake_trans <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">sg</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> enat_coexhaust<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltake_trans'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>ltake_trans' <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ltake <span class="free">n</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> ltake_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ldropn<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ldropn_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ldropn_trans</span> <span class="main">≡</span> drop_raw"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ldropn_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> ldropn_trans <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ldropn <span class="free">n</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lprefix_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> step.exhaust<span class="main"><span class="main">[</span></span><span class="operator">case_product</span> nat.exhaust<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> meta_allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">cont_intro</span><span class="main">]</span> <span class="main">=</span> ccpo.admissible_leI<span class="main">[</span><span class="operator">OF</span> llist_ccpo<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> meta_allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ldropn_trans' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> nat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">ldropn_trans</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> <span class="tfree">'s</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> ns<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"productive <span class="skolem">g</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">∈</span> productive_on <span class="main">(</span>ldropn_trans <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ns
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros Suc.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ldropn_trans'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>ldropn_trans' <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ldropn <span class="free">n</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> ldropn_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ldrop<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ldrop_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> enat <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ldrop_trans</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> 
    Done <span class="main">⇒</span> Done <span class="main">|</span> Skip <span class="bound">s'</span> <span class="main">⇒</span> Skip <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>
  <span class="main">|</span> Yield <span class="bound">x</span> <span class="bound">s'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Yield <span class="bound">x</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="keyword1">else</span> Skip <span class="main">(</span>epred <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ldrop_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="free">g'</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> ldrop_trans <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ldrop <span class="free">n</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lprefix_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps neq_zero_conv_eSuc <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> meta_allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> enat_coexhaust<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> meta_allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ldrop_trans_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>ldrop_trans <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ldrop <span class="free">n</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> ldrop_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ltakeWhile<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ltakeWhile_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ltakeWhile_trans</span> <span class="main">≡</span> takeWhile_raw"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltakeWhile_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">g</span> <span class="free">g'</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> ltakeWhile_trans <span class="free">P</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="free">s</span> <span class="main">=</span> ltakeWhile <span class="free">P</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lprefix_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps takeWhile_raw_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps takeWhile_raw_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ltakeWhile_trans' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">ltakeWhile_trans</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="main">(</span>ltakeWhile_trans <span class="skolem">P</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="improper">x</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> takeWhile_raw_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ltakeWhile_trans'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>ltakeWhile_trans' <span class="free">P</span> <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> ltakeWhile <span class="free">P</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> ltakeWhile_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ldropWhile<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">ldropWhile_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> bool <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ldropWhile_trans</span> <span class="main">≡</span> dropWhile_raw"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ldropWhile_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">g</span> <span class="free">g'</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> ldropWhile_trans <span class="free">P</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ldropWhile <span class="free">P</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="main">(</span>lunstream <span class="free">g'</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">g'</span> <span class="main">(</span>False<span class="main">,</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lprefix_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ldropWhile_trans_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>ldropWhile_trans <span class="free">P</span> <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>True<span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> ldropWhile <span class="free">P</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> ldropWhile_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lzip<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">lzip_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span> <span class="main">×</span> <span class="tfree">'s2</span> <span class="main">×</span> <span class="tfree">'a</span> option<span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lzip_trans</span> <span class="main">≡</span> zip_raw"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lzip_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="free">h</span> <span class="free">gh</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gh</span> <span class="main">≡</span> lzip_trans <span class="free">g</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">gh</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> lzip <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> lprefix <span class="main">(</span>lunstream <span class="free">gh</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> Some <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lzip <span class="main">(</span>LCons <span class="bound">x</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">gh</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sg</span></span> <span class="quoted"><span class="free">sh</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span> 
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">sh</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">cont_intro</span><span class="main">]</span> <span class="main">=</span> ccpo.admissible_leI<span class="main">[</span><span class="operator">OF</span> llist_ccpo<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> lprefix <span class="main">(</span>lzip <span class="main">(</span>LCons <span class="bound">x</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">gh</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> Some <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sg</span></span> <span class="quoted"><span class="free">sh</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">lunstream_g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> <span class="quoted">"3.IH"</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps fun_ord_def<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quoted"><span class="skolem">sg</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">unstream_h</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">sh</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Yield <span class="skolem">y</span> <span class="skolem">sh'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> IH <span class="quoted">"3.hyps"</span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">sg</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps fun_ord_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> monotone_lzip2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> monotoneD<span class="main"><span class="main">]</span></span> lprefix_trans<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sh</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lprefix_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lzip_trans_fusion2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>lzip_trans <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> lzip <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lzip_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lzip_trans_fusion3 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>lzip_trans <span class="free">g</span> <span class="main">(</span>lgenerator <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> lzip <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lzip_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> lzip_trans' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span> <span class="main">×</span> <span class="tfree">'s2</span> <span class="main">×</span> <span class="tfree">'a</span> option<span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"lzip_trans"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s1</span> <span class="main">×</span> <span class="tfree">'s2</span> <span class="main">×</span> <span class="tfree">'a</span> option"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">h</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sg</span></span> <span class="skolem"><span class="skolem">sh</span></span> <span class="skolem"><span class="skolem">mx</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> <span class="skolem">mx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">sg</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹productive <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh</span> <span class="main">∈</span> productive_on <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> Some <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> productive_on <span class="main">(</span>lzip_trans <span class="skolem">g</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹productive <span class="skolem">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sg</span><span class="main">,</span> <span class="skolem">sh</span><span class="main">,</span> None<span class="main">)</span> <span class="main">∈</span> productive_on <span class="main">(</span>lzip_trans <span class="skolem">g</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros calculation<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="main">(</span>lzip_trans <span class="skolem">g</span> <span class="skolem">h</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mx</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lzip_trans'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>lzip_trans' <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span><span class="free">sg</span><span class="main">,</span> <span class="free">sh</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> lzip <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lzip_trans_fusion<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lappend<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> lappend_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span> <span class="main">+</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">append_raw</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_append_raw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="free">h</span> <span class="free">sh</span> <span class="free">gh</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gh</span> <span class="main">≡</span> append_raw <span class="free">g</span> <span class="free">h</span> <span class="free">sh</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"productive <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">gh</span> <span class="main">(</span>Inl <span class="free">sg</span><span class="main">)</span> <span class="main">=</span> lappend <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">sg</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> llist.coinduct_strong<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_llist <span class="skolem">sg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sh'</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="main">(</span>lunstream <span class="free">gh</span> <span class="main">(</span>Inr <span class="skolem">sh'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="skolem">sh'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">gh</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sh'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="main">(</span>lunstream <span class="free">h</span> <span class="skolem">sh'</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">gh</span> <span class="main">(</span>Inr <span class="skolem">sh'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">h</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">sh'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">gh</span> <span class="main">(</span>Inr <span class="skolem">sh'</span><span class="main">)</span> <span class="main">=</span> lunstream <span class="free">h</span> <span class="skolem">sh'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lprefix_antisym<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> Inr <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> gh_def<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹productive <span class="free">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> productive_on <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lunstream_sels Inr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lappend_trans_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>lappend_trans <span class="free">g</span> <span class="free">h</span> <span class="free">sh</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">sg</span><span class="main">)</span> <span class="main">=</span> lappend <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lunstream_append_raw<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> lappend_trans' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator' <span class="main">⇒</span> <span class="tfree">'sh</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span> <span class="main">+</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">append_raw</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sg</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'sh</span><span class="main">)</span> lgenerator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">sh</span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"productive <span class="skolem">h</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sh'</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹productive <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sh'</span> <span class="main">∈</span> productive_on <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inr <span class="skolem">sh'</span> <span class="main">∈</span> productive_on <span class="main">(</span>append_raw <span class="skolem">g</span> <span class="skolem">h</span> <span class="skolem">sh</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">sg</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹productive <span class="skolem">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sg</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inl <span class="skolem">sg</span> <span class="main">∈</span> productive_on <span class="main">(</span>append_raw <span class="skolem">g</span> <span class="skolem">h</span> <span class="skolem">sh</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros calculation<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="main">(</span>append_raw <span class="skolem">g</span> <span class="skolem">h</span> <span class="skolem">sh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lappend_trans'_fusion <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>lappend_trans' <span class="free">g</span> <span class="free">h</span> <span class="free">sh</span><span class="main">)</span> <span class="main">(</span>Inl <span class="free">sg</span><span class="main">)</span> <span class="main">=</span> lappend <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">sg</span><span class="main">)</span> <span class="main">(</span>lunstream' <span class="free">h</span> <span class="free">sh</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lunstream_append_raw<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> lfilter<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lfilter_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lfilter_trans</span> <span class="main">=</span> filter_raw"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_lfilter_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">g</span> <span class="free">g'</span> <span class="keyword2"><span class="keyword">defines</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g'</span> <span class="main">≡</span> lfilter_trans <span class="free">P</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lunstream <span class="free">g'</span> <span class="free">s</span> <span class="main">=</span> lfilter <span class="free">P</span> <span class="main">(</span>lunstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lprefix_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?lhs</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfilter_trans_def filter_raw_def lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lprefix <span class="var">?rhs</span> <span class="var">?lhs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lunstream.fixp_induct<span class="main">)</span> 
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lfilter_trans_def filter_raw_def lunstream_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_lfilter_trans2 <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream <span class="main">(</span>lfilter_trans <span class="free">P</span> <span class="main">(</span>lgenerator <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> lfilter <span class="free">P</span> <span class="main">(</span>lunstream' <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span><span class="main">(</span><span class="operator">rule</span> lunstream_lfilter_trans<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> llist_of<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> llist_of_trans <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> generator <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> lgenerator'"</span></span>
<span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> raw_generator"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"terminates <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> terminates_on <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> terminates_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> productive_on <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> productive_on.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lunstream_llist_of_trans <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"lunstream' <span class="main">(</span>llist_of_trans <span class="free">g</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> llist_of <span class="main">(</span>unstream <span class="free">g</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> unstream.induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> llist.expand<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> llist.expand <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> llist_of_trans.rep_eq lunstream_sels lunstream'.rep_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> step.split<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We cannot define a stream version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> list_of<span class="antiquote"><span class="antiquote">}</span></span></span></span> because we would have to test
  for finiteness first and therefore traverse the list twice.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Stream_Fusion_Examples">
<div class="head">
<h1>Theory Stream_Fusion_Examples</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Stream_Fusion_Examples
  Author: Andreas Lochbihler, ETH Zurich *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples and test cases for stream fusion›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stream_Fusion_Examples <span class="keyword2"><span class="keyword">imports</span></span> <a href="Stream_Fusion_LList.html">Stream_Fusion_LList</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rhs</span> <span class="free">z</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">≡</span> nth_cons <span class="main">(</span>flatten <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">(</span>upto_prod <span class="numeral">17</span><span class="main">)</span> <span class="main">(</span>upto_prod <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> None<span class="main">)</span> <span class="numeral">8</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">(</span>List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> upto <span class="bound">x</span> <span class="numeral">17</span><span class="main">)</span> <span class="main">(</span>upto <span class="numeral">2</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="numeral">8</span> <span class="main">=</span> <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_fusion<span class="main">,</span> <span class="operator">stream_fusion_trace</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> id_apply<span class="main">)</span> <span class="comment1">― ‹fuses›</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> rhs_def<span class="main">)</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rhs</span> <span class="free">z</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">≡</span> nth_cons <span class="main">(</span>flatten <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fix_gen <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> upto_prod <span class="main">(</span>id <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>upto_prod <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> None<span class="main">)</span> <span class="numeral">8</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">(</span>List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> upto <span class="main">1</span> <span class="main">(</span>id <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>upto <span class="numeral">2</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span> <span class="numeral">8</span> <span class="main">=</span> <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_fusion<span class="main">,</span> <span class="operator">stream_fusion_trace</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> id_apply<span class="main">)</span> <span class="comment1">― ‹fuses›</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> rhs_def<span class="main">)</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rhs</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">rhs</span> <span class="main">≡</span> List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span>Suc <span class="main">0</span><span class="main">..&lt;</span>sum_list_cons <span class="main">(</span>replicate_prod <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="main">1</span><span class="main">..&lt;</span>sum_list <span class="main">(</span>replicate <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="numeral">2</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">rhs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream_fusion<span class="main">,</span> <span class="operator">stream_fusion_trace</span><span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_map_maps<span class="main">)</span> <span class="comment1">― ‹fuses partially›</span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold</span> rhs_def<span class="main">)</span> <span class="operator">rule</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Micro-benchmarks from Farmer et al. \cite{FarmerHoenerGill2014PEPM}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_enum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> id<span class="antiquote">}</span></span> required to avoid eta contraction›</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test_enum</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> upt <span class="main">1</span> <span class="main">(</span>id <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>upt <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_nested</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test_nested</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> upt <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>upt <span class="main">1</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>upt <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">test_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"integer <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">test_merge</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>List.maps <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="numeral">2</span> <span class="keyword1">dvd</span> <span class="bound">x</span> <span class="keyword1">then</span> upt <span class="main">1</span> <span class="bound">x</span> <span class="keyword1">else</span> upt <span class="numeral">2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>upt <span class="main">1</span> <span class="main">(</span>nat_of_integer <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This rule performs the merge operation from \cite[\S 5.2]{FarmerHoenerGill2014PEPM} for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>if›</span></span></span></span>.
  In general, we would also need it for all case operators.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> unstream_if <span class="main">[</span><span class="operator">stream_fusion</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unstream <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="keyword1">else</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> unstream <span class="free">g</span> <span class="free">s</span> <span class="keyword1">else</span> unstream <span class="free">g'</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> if_same <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">test_enum</span></span>
<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">test_nested</span></span>
<span class="keyword1"><span class="command">code_thms</span></span> <span class="quoted"><span class="quoted">test_merge</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Test stream fusion in the code generator›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fuse_test</span> <span class="main">::</span> <span class="quoted">integer</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fuse_test</span> <span class="main">=</span> 
  integer_of_int <span class="main">(</span>lhd <span class="main">(</span>lfilter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>lappend <span class="main">(</span>lmap <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>llist_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> undefined <span class="keyword1">else</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[</span><span class="main">-</span><span class="numeral">3</span><span class="main">..</span><span class="numeral">5</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>repeat <span class="numeral">3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">ML_val</span></span> <span class="quoted">‹<span class="keyword1"><span class="keyword">val</span></span> <span class="inner_numeral">~2</span> <span class="main">=</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">code</span> <span class="quoted">fuse_test</span><span class="antiquote">}</span></span></span>›</span> <span class="comment1">― ‹If this test fails with exception Fail, then the stream fusion simproc failed. This test exploits
  that stream fusion introduces laziness.›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>