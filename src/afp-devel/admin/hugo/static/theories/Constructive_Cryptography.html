<div id="Resource">
<div class="head">
<h1>Theory Resource</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Resource <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../CryptHOL/CryptHOL.html">CryptHOL.CryptHOL</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Resources›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type definition›</span></span>

<span class="keyword1"><span class="command">codatatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource
  <span class="main">=</span> Resource <span class="main">(</span><span class="free"><span class="entity">run_resource</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource<span class="main">)</span> spmf"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> map<span class="main">:</span> map_resource'
    rel<span class="main">:</span> rel_resource'

<span class="keyword1"><span class="command">lemma</span></span> case_resource_conv_run_resource<span class="main">:</span> <span class="quoted"><span class="quoted">"case_resource <span class="free">f</span> <span class="free">res</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>run_resource <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> resource.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functor›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">map_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a'</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b'</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span><span class="free">map_resource</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>map_prod <span class="free">b</span> <span class="free">map_resource</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">∘</span> <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span>map_resource <span class="free">res</span><span class="main">)</span> <span class="free">a'</span> <span class="main">=</span> map_spmf <span class="main">(</span>map_prod <span class="free">b</span> map_resource<span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res</span> <span class="main">(</span><span class="free">a</span> <span class="free">a'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">declare</span></span> map_resource.sel <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_ctr <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_resource <span class="main">(</span>Resource <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Resource <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="free">b</span> map_resource<span class="main">)</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">∘</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> resource.expand<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_id1<span class="main">:</span> <span class="quoted"><span class="quoted">"map_resource id <span class="free">f</span> <span class="free">res</span> <span class="main">=</span> map_resource' <span class="free">f</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map resource.map_sel <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_resource id id <span class="free">res</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_resource_id1 resource.map_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_resource <span class="free">a</span> <span class="free">b</span> <span class="main">(</span>map_resource <span class="free">a'</span> <span class="free">b'</span> <span class="free">res</span><span class="main">)</span> <span class="main">=</span> map_resource <span class="main">(</span><span class="free">a'</span> <span class="main">∘</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">∘</span> <span class="free">b'</span><span class="main">)</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI rel_spmf_reflI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map<span class="main">)</span>

<span class="keyword1"><span class="command">functor</span></span> resource<span class="main">:</span> <span class="quoted">map_resource</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relator›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">rel_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> resource <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="entity">B</span> <span class="keyword2"><span class="keyword">where</span></span>
    rel_resourceI<span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_fun <span class="free">A</span> <span class="main">(</span>rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span><span class="free">rel_resource</span> <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res1</span></span></span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res2</span></span></span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="free">rel_resource</span> <span class="free">A</span> <span class="free">B</span> <span class="free"><span class="bound"><span class="entity">res1</span></span></span> <span class="free"><span class="bound"><span class="entity">res2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> rel_resource<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> rel_resource<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">res1</span> <span class="free">res2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">res1</span> <span class="bound">res2</span><span class="main">.</span> <span class="free">X</span> <span class="bound">res1</span> <span class="bound">res2</span> <span class="main">⟹</span>
         rel_fun <span class="free">A</span> <span class="main">(</span>rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span><span class="main">λ</span><span class="bound">res1</span> <span class="bound">res2</span><span class="main">.</span> <span class="free">X</span> <span class="bound">res1</span> <span class="bound">res2</span> <span class="main">∨</span> rel_resource <span class="free">A</span> <span class="free">B</span> <span class="bound">res1</span> <span class="bound">res2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>run_resource <span class="bound">res1</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="bound">res2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="free">res1</span> <span class="free">res2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_resource.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>Resource <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Resource <span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> rel_fun <span class="free">A</span> <span class="main">(</span>rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> rel_resource.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resourceD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="free">res1</span> <span class="free">res2</span> <span class="main">⟹</span> rel_fun <span class="free">A</span> <span class="main">(</span>rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res1</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_resource.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(=)</span> <span class="main">=</span> rel_resource'"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource' <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(=)</span> <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">res2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_resource.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(=)</span> <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_resource' <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">res2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> resource.rel_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spmf_rel_mono_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_eq<span class="main">:</span> <span class="comment1">(* [relator_eq] *)</span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_resource_eq1 resource.rel_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">≤</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≤</span> <span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">≤</span> rel_resource <span class="free">A'</span> <span class="free">B'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A'</span> <span class="free">B'</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">res1</span> <span class="skolem">res2</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_resourceD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono prod.rel_mono_strong rel_fun_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_conversep<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span><span class="main">¯¯</span> <span class="free">B</span><span class="main">¯¯</span> <span class="main">=</span> <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">¯¯</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="skolem">A</span><span class="main">¯¯</span> <span class="skolem">B</span><span class="main">¯¯</span> <span class="skolem">res2</span> <span class="skolem">res1</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> <span class="main">⇒</span> <span class="tfree">'a2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c1</span> <span class="main">⇒</span> <span class="tfree">'c2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">res1</span> <span class="skolem">res2</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> rel_resourceD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">⌑</span></span></span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> rel_fun_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> spmf_rel_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rel_fun_mono
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_def conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>rel_spmf_mono prod.rel_mono_strong<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">¯¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">¯¯</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span><span class="main">¯¯</span> <span class="free">B</span><span class="main">¯¯</span> <span class="skolem">res2</span> <span class="skolem">res1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="skolem">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">res1</span> <span class="skolem">res2</span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_map_resource'1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>map_resource' <span class="free">f</span> <span class="free">res1</span><span class="main">)</span> <span class="free">res2</span> <span class="main">=</span> rel_resource <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">res1</span> <span class="free">res2</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> rel_resourceD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_resource.sel map_resource_id1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_comp spmf_rel_map prod.rel_map<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fun_mono rel_spmf_mono prod.rel_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> rel_resourceD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_resource.sel map_resource_id1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_comp spmf_rel_map prod.rel_map<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fun_mono rel_spmf_mono prod.rel_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_map_resource'2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="free">res1</span> <span class="main">(</span>map_resource' <span class="free">f</span> <span class="free">res2</span><span class="main">)</span> <span class="main">=</span> rel_resource <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">res1</span> <span class="free">res2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_resource_map_resource'1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"conversep <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">res2</span></span> <span class="quoted"><span class="free">res1</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">⌑</span></span></span>"</span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_resource_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> resource_rel_map' <span class="main">=</span> rel_resource_map_resource'1<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> rel_resource_map_resource'2

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_pos_distr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="keyword1">OO</span> rel_resource <span class="free">A'</span> <span class="free">B'</span> <span class="main">≤</span> rel_resource <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="skolem">res1</span> <span class="skolem">res3</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span> <span class="keyword1">OO</span> rel_resource <span class="free">A'</span> <span class="free">B'</span><span class="main">)</span> <span class="skolem">res1</span> <span class="skolem">res3</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">res1</span> <span class="skolem">res3</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">res1</span></span> <span class="quoted"><span class="skolem">res3</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> relcomppE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> rel_resourceD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_fun_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pos_fun_distr<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> relcomppI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_spmf_pos_distr<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_compp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prod.rel_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> left_unique_rel_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> left_total <span class="free">A</span><span class="main">;</span> left_unique <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> left_unique <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> left_unique_alt_def left_total_alt_def rel_resource_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_resource_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_resource_pos_distr<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_resource_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> right_unique_rel_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> right_total <span class="free">A</span><span class="main">;</span> right_unique <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> right_unique <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> right_unique_alt_def right_total_alt_def rel_resource_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_resource_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_resource_pos_distr<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_resource_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bi_unique_rel_resource <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bi_total <span class="free">A</span><span class="main">;</span> bi_unique <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> bi_unique <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bi_unique_alt_def bi_total_alt_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> left_unique_rel_resource right_unique_rel_resource<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_witness_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_witness_resource</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> corec_resource <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">res1</span><span class="main">,</span> <span class="bound">res2</span><span class="main">)</span><span class="main">.</span>
   map_spmf <span class="main">(</span>map_prod id Inr <span class="main">∘</span> rel_witness_prod<span class="main">)</span> <span class="main">∘</span> 
   rel_witness_spmf <span class="main">(</span>rel_prod <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>rel_resource <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">OO</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> 
   rel_witness_fun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">(</span>run_resource <span class="bound">res1</span><span class="main">,</span> run_resource <span class="bound">res2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_witness_resource_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span>rel_witness_resource <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="main">(</span><span class="free">res1</span><span class="main">,</span> <span class="free">res2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   map_spmf <span class="main">(</span>map_prod id <span class="main">(</span>rel_witness_resource <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span><span class="main">)</span> <span class="main">∘</span> rel_witness_prod<span class="main">)</span> <span class="main">∘</span> 
   rel_witness_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_resource <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> 
   rel_witness_fun <span class="free">A</span> <span class="free">A'</span> <span class="main">(</span>run_resource <span class="free">res1</span><span class="main">,</span> run_resource <span class="free">res2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_witness_resource_def o_def fun_eq_iff spmf.map_comp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_spmf_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">B</span> <span class="free">res</span> <span class="free">res'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"left_total <span class="free">A'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> rel_witness_resource1<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="main">(</span><span class="bound">b'</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">b'</span> <span class="bound">c</span><span class="main">)</span> <span class="free">res</span> <span class="main">(</span>rel_witness_resource <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">res'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> rel_witness_resource2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">b</span> <span class="bound">c'</span><span class="main">)</span> <span class="main">(</span>rel_witness_resource <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">res'</span><span class="main">)</span><span class="main">)</span> <span class="free">res'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> rel_resource
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> rel_resourceD<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comp<span class="main">)</span>
        <span class="main">(</span><span class="operator">erule</span> rel_fun_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_witness_fun1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ A A'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
          <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_witness_spmf1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> rel_resource
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> rel_resourceD<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comp<span class="main">)</span>
        <span class="main">(</span><span class="operator">erule</span> rel_fun_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_witness_fun2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ A A'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span>
          <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_witness_spmf2<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_neg_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"left_total <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">≤</span> rel_resource <span class="free">A</span> <span class="free">B</span> <span class="keyword1">OO</span> rel_resource <span class="free">A'</span> <span class="free">B'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> predicate2I relcomppI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">res</span> <span class="skolem">res''</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="skolem">res</span> <span class="skolem">res''</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?res'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_resource' <span class="main">(</span>relcompp_witness <span class="free">B</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span>rel_witness_resource <span class="free">A</span> <span class="free">A'</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">res</span><span class="main">,</span> <span class="skolem">res''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A</span> <span class="free">B</span> <span class="skolem">res</span> <span class="var">?res'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rel_witness_resource1<span class="main">[</span><span class="operator">OF</span> * A A'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> resource_rel_map'
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_resource_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> relcomppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompp_witness<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_resource <span class="free">A'</span> <span class="free">B'</span> <span class="var">?res'</span> <span class="skolem">res''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rel_witness_resource2<span class="main">[</span><span class="operator">OF</span> * A A'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> resource_rel_map'
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_resource_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> relcomppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompp_witness<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> left_total_rel_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> left_unique <span class="free">A</span><span class="main">;</span> right_total <span class="free">A</span><span class="main">;</span> left_total <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> left_total <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> left_unique_alt_def left_total_alt_def rel_resource_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_resource_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_resource_neg_distr<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_unique_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_resource_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> right_total_rel_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> right_unique <span class="free">A</span><span class="main">;</span> left_total <span class="free">A</span><span class="main">;</span> right_total <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> right_total <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> right_unique_alt_def right_total_alt_def rel_resource_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_resource_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_resource_neg_distr<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_unique_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_resource_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bi_total_rel_resource <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bi_total <span class="free">A</span><span class="main">;</span> bi_unique <span class="free">A</span><span class="main">;</span> bi_total <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> bi_total <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bi_total_alt_def bi_unique_alt_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> left_total_rel_resource right_total_rel_resource<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Resource_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span> Resource Resource"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> run_resource_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> run_resource run_resource"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_resourceD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> corec_resource_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_sum <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span>
   corec_resource corec_resource"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="skolem">s2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comp spmf_rel_map prod.rel_map<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fun_mono rel_spmf_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prod.rel_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A'</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">B</span> <span class="main">===&gt;</span> <span class="free">B'</span><span class="main">)</span> <span class="main">===&gt;</span> rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">===&gt;</span> rel_resource <span class="free">A'</span> <span class="free">B'</span><span class="main">)</span> map_resource map_resource"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_resource_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer_prover</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource'_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">===&gt;</span> <span class="free">B'</span><span class="main">)</span> <span class="main">===&gt;</span> rel_resource <span class="main">(=)</span> <span class="free">B</span> <span class="main">===&gt;</span> rel_resource <span class="main">(=)</span> <span class="free">B'</span><span class="main">)</span> map_resource' map_resource'"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_resource_id1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> case_resource_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">C</span><span class="main">)</span> <span class="main">===&gt;</span> rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">C</span><span class="main">)</span>
  case_resource case_resource"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> case_resource_conv_run_resource <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_resource_Grp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_resource <span class="main">(</span>conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">g</span><span class="main">)</span> <span class="main">=</span> BNF_Def.Grp UNIV <span class="main">(</span>map_resource <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="main">(</span><span class="operator">rule</span> ext iffI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">res</span> <span class="skolem">res'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_resource <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">res</span> <span class="skolem">res'</span> <span class="main">⟹</span> <span class="skolem">res'</span> <span class="main">=</span> map_resource <span class="free">f</span> <span class="free">g</span> <span class="skolem">res</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> map_resource_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> rel_resource_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">erule</span> map_resource_parametric<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Grp_def <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> conversep_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 _ _<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_resource_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> map_resource_parametric<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> rel_resource_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff rel_fun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Losslessness›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">lossless_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="keyword2"><span class="keyword">where</span></span>
    lossless_resourceI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lossless_resource</span> <span class="free">ℐ</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> lossless_spmf <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">res'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">lossless_resource</span> <span class="free">ℐ</span> <span class="bound">res'</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_resource_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> lossless_resource<span class="main">,</span> <span class="operator">case_conclusion</span> lossless_resource lossless step<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> lossless_resource<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">res</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">res</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">res</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> <span class="main">⟹</span> lossless_spmf <span class="main">(</span>run_resource <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="free">X</span> <span class="bound">res'</span> <span class="main">∨</span> lossless_resource <span class="free">ℐ</span> <span class="bound">res'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lossless_resource.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_resourceD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lossless_resource <span class="free">ℐ</span> <span class="free">res</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span>
  <span class="main">⟹</span> lossless_spmf <span class="main">(</span>run_resource <span class="free">res</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">∈</span>set_spmf <span class="main">(</span>run_resource <span class="free">res</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> lossless_resource <span class="free">ℐ</span> <span class="bound">res'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> lossless_resource.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_resource_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ'</span> <span class="free">res</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lossless_resourceD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_resource_mono'<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> lossless_resource <span class="free">ℐ'</span> <span class="free">res</span><span class="main">;</span> <span class="free">ℐ</span> <span class="main">≤</span> <span class="free">ℐ'</span> <span class="main">⟧</span> <span class="main">⟹</span> lossless_resource <span class="free">ℐ</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> lossless_resource_mono<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">oracle</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">)</span> spmf"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">resource_of_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span><span class="free">resource_of_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod id <span class="free">resource_of_oracle</span><span class="main">)</span> <span class="main">(</span><span class="free">oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> resource_of_oracle_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">B</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span> resource_of_oracle resource_of_oracle"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> resource_of_oracle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> map_resource_resource_of_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_resource <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>resource_of_oracle <span class="free">oracle</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> resource_of_oracle <span class="main">(</span>map_fun id <span class="main">(</span>map_fun <span class="free">f</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="free">g</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">oracle</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">s</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> resource_of_oracle_parametric<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="main">(</span>id <span class="main">::</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod.rel_Grp option.rel_Grp pmf.rel_Grp rel_fun_Grp rel_resource_Grp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> eq_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> conversep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> eq_alt
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> rel_fun_Grp<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_Grp rel_fun_def Grp_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> callee_invariant_on<span class="main">)</span> lossless_resource_of_oracle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> lossless_spmf <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="main">(</span>resource_of_oracle <span class="free">callee</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="free">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> callee_invariant<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> resource_of_oracle_rprodl<span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"resource_of_oracle <span class="main">(</span><span class="main">(</span>rprodl <span class="main">---&gt;</span> id <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod id lprodr<span class="main">)</span><span class="main">)</span> <span class="free">oracle</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span><span class="main">,</span> <span class="free">s3</span><span class="main">)</span> <span class="main">=</span> 
    resource_of_oracle <span class="free">oracle</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">,</span> <span class="free">s3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> resource_of_oracle_parametric<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV rprodl"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> rel_resource_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff rel_fun_def spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> resource_of_oracle_extend_state_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"resource_of_oracle <span class="main">(</span>extend_state_oracle <span class="free">oracle</span><span class="main">)</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> resource_of_oracle <span class="free">oracle</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> resource_of_oracle_parametric<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> rel_resource_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff rel_fun_def spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exec_gpv_resource_of_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"exec_gpv run_resource <span class="free">gpv</span> <span class="main">(</span>resource_of_oracle <span class="free">oracle</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map_spmf <span class="main">(</span>map_prod id <span class="main">(</span>resource_of_oracle <span class="free">oracle</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="free">oracle</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> spmf.map_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> pmf.rel_eq<span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> pmf.map_transfer<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exec_gpv_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">res</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">res</span> <span class="main">=</span> resource_of_oracle <span class="free">oracle</span> <span class="bound">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq rel_fun_def spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option.rel_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">parallel_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span><span class="free">parallel_resource</span> <span class="free"><span class="bound"><span class="entity">res1</span></span></span> <span class="free"><span class="bound"><span class="entity">res2</span></span></span><span class="main">)</span> <span class="main">=</span> 
   <span class="main">(</span><span class="main">λ</span><span class="bound">ac</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ac</span> <span class="keyword1">of</span> Inl <span class="bound">a</span> <span class="main">⇒</span> map_spmf <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">res1'</span><span class="main">.</span> <span class="free">parallel_resource</span> <span class="bound">res1'</span> <span class="free"><span class="bound"><span class="entity">res2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res1</span></span></span> <span class="bound">a</span><span class="main">)</span>
         <span class="main">|</span> Inr <span class="bound">c</span> <span class="main">⇒</span> map_spmf <span class="main">(</span>map_prod Inr <span class="main">(</span><span class="main">λ</span><span class="bound">res2'</span><span class="main">.</span> <span class="free">parallel_resource</span> <span class="free"><span class="bound"><span class="entity">res1</span></span></span> <span class="bound">res2'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res2</span></span></span> <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_resource_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_resource <span class="free">A</span> <span class="free">B</span> <span class="main">===&gt;</span> rel_resource <span class="free">C</span> <span class="free">D</span> <span class="main">===&gt;</span> rel_resource <span class="main">(</span>rel_sum <span class="free">A</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">B</span> <span class="free">D</span><span class="main">)</span><span class="main">)</span>
   parallel_resource parallel_resource"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_resource_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We cannot define the analogue of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">plus_oracle</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> because we no longer have access to the state,
  so state sharing is not possible!  So we can only compose resources, but we cannot build one
  resource with several interfaces this way!
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> resource_of_parallel_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"resource_of_oracle <span class="main">(</span>parallel_oracle <span class="free">oracle1</span> <span class="free">oracle2</span><span class="main">)</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span> <span class="main">=</span>
   parallel_resource <span class="main">(</span>resource_of_oracle <span class="free">oracle1</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>resource_of_oracle <span class="free">oracle2</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_resource_assoc<span class="main">:</span> <span class="comment1">― ‹There's still an ugly map operation in there to rebalance the interface trees, but well...›</span>
  <span class="quoted"><span class="quoted">"parallel_resource <span class="main">(</span>parallel_resource <span class="free">res1</span> <span class="free">res2</span><span class="main">)</span> <span class="free">res3</span> <span class="main">=</span> 
   map_resource rsuml lsumr <span class="main">(</span>parallel_resource <span class="free">res1</span> <span class="main">(</span>parallel_resource <span class="free">res2</span> <span class="free">res3</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span> <span class="quoted"><span class="free">res3</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 5 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI rel_spmf_reflI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> lossless_parallel_resource<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="free">res1</span>"</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ'</span> <span class="free">res2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>parallel_resource <span class="free">res1</span> <span class="free">res2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lossless_resourceD<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> 4 3<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-typing›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">WT_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword3">/</span><span class="keyword1">⊢res</span> _ <span class="keyword1">√</span>"</span> <span class="main">[</span>100<span class="main">,</span> 0<span class="main">]</span> 99<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="keyword2"><span class="keyword">where</span></span>
    WT_resourceI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1"><span class="free">⊢res</span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main"><span class="free">√</span></span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">r</span> <span class="bound">res'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">ℐ</span> <span class="keyword1"><span class="free">⊢res</span></span> <span class="bound">res'</span> <span class="main"><span class="free">√</span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> WT_resource_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> WT_resource<span class="main">,</span> <span class="operator">case_conclusion</span> WT_resource response WT_resource<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> WT_resource<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">res</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">res</span> <span class="bound">q</span> <span class="bound">r</span> <span class="bound">res'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">res</span><span class="main">;</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="bound">res</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟧</span>
       <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span> <span class="main">∧</span> <span class="main">(</span><span class="free">X</span> <span class="bound">res'</span> <span class="main">∨</span> <span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="bound">res'</span> <span class="main">√</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_resource.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_resourceD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">res'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="free">res</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res'</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> WT_resource.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_resource_of_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">ℐ</span> <span class="keyword1">⊢c</span> <span class="free">oracle</span> <span class="bound">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> resource_of_oracle <span class="free">oracle</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_calleeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_resource_bot <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bot <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_resource.intros<span class="main">)</span><span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_resource_full<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> callee_invariant_on<span class="main">)</span> WT_resource_of_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="keyword1">⊢res</span> resource_of_oracle <span class="free">callee</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> callee_invariant'<span class="main">)</span>

<span class="keyword1"><span class="command">named_theorems</span></span> WT_intro <span class="quoted">"Interface typing introduction rules"</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span> <span class="main">=</span> WT_gpv_map_gpv' WT_gpv_map_gpv

<span class="keyword1"><span class="command">lemma</span></span> WT_parallel_resource <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊢res</span> <span class="free">res1</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="keyword1">⊢res</span> <span class="free">res2</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span> <span class="keyword1">⊢res</span> parallel_resource <span class="free">res1</span> <span class="free">res2</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_resourceD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> callee_invariant_run_resource<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on run_resource <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span>  <span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="bound">res</span> <span class="main">√</span><span class="main">)</span> <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_resourceD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> callee_invariant_run_lossless_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"callee_invariant_on run_resource <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span> lossless_resource <span class="free">ℐ</span> <span class="bound">res</span> <span class="main">∧</span> <span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="bound">res</span> <span class="main">√</span><span class="main">)</span> <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_resourceD lossless_resourceD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> run_lossless_resource<span class="main">:</span>
  callee_invariant_on <span class="quoted">run_resource</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">res</span><span class="main">.</span> lossless_resource <span class="free">ℐ</span> <span class="bound">res</span> <span class="main">∧</span> <span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="bound">res</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ℐ</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_run_lossless_resource<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Converter">
<div class="head">
<h1>Theory Converter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Converter <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Resource.html">Resource</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Converters›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type definition›</span></span>

<span class="keyword1"><span class="command">codatatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> results'_converter<span class="main">:</span> <span class="tfree">'b</span><span class="main">,</span> outs'_converter<span class="main">:</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter
  <span class="main">=</span> Converter <span class="main">(</span><span class="free"><span class="entity">run_converter</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter<span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> map<span class="main">:</span> map_converter'
    rel<span class="main">:</span> rel_converter'
    pred<span class="main">:</span> pred_converter'

<span class="keyword1"><span class="command">lemma</span></span> case_converter_conv_run_converter<span class="main">:</span> <span class="quoted"><span class="quoted">"case_converter <span class="free">f</span> <span class="free">conv</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>run_converter <span class="free">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fact</span> converter.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functor›</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'out</span> <span class="main">⇒</span> <span class="tfree">'out'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted">"<span class="free">inn</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'in</span> <span class="main">⇒</span> <span class="tfree">'in'</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">map_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a'</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b'</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">map_converter</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span> <span class="main">=</span> 
   map_gpv <span class="main">(</span>map_prod <span class="free">b</span> <span class="free">map_converter</span><span class="main">)</span> <span class="free">out</span> <span class="main">∘</span> map_gpv' id id <span class="free">inn</span> <span class="main">∘</span> run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">∘</span> <span class="free">a</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span>map_converter <span class="free">conv</span><span class="main">)</span> <span class="free">a'</span> <span class="main">=</span> map_gpv' <span class="main">(</span>map_prod <span class="free">b</span> map_converter<span class="main">)</span> <span class="free">out</span> <span class="free">inn</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="main">(</span><span class="free">a</span> <span class="free">a'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_conv_map_gpv' map_gpv'_comp<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> map_converter.sel <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_ctr <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="main">(</span>Converter <span class="free">f</span><span class="main">)</span> <span class="main">=</span> Converter <span class="main">(</span>map_fun <span class="free">a</span> <span class="main">(</span>map_gpv' <span class="main">(</span>map_prod <span class="free">b</span> map_converter<span class="main">)</span> <span class="free">out</span> <span class="free">inn</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> converter.expand<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_id14<span class="main">:</span> <span class="quoted"><span class="quoted">"map_converter id <span class="free">b</span> <span class="free">out</span> id <span class="free">res</span> <span class="main">=</span> map_converter' <span class="free">b</span> <span class="free">out</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> converter.map_sel gpv.rel_map map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_converter id id id id <span class="free">conv</span> <span class="main">=</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_converter_id14 converter.map_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_compose <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="free">a</span> <span class="free">b</span> <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>map_converter <span class="free">a'</span> <span class="free">b'</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv</span><span class="main">)</span> <span class="main">=</span> map_converter <span class="main">(</span><span class="free">a'</span> <span class="main">∘</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">∘</span> <span class="free">b'</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span><span class="free">g'</span> <span class="main">∘</span> <span class="free">g</span><span class="main">)</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI gpv.rel_refl_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_gpv_map_gpv' map_gpv'_comp o_def prod.map_comp<span class="main">)</span>

<span class="keyword1"><span class="command">functor</span></span> converter<span class="main">:</span> <span class="quoted">map_converter</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Set functions with interfaces›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">outsp_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'out</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">out</span> <span class="keyword2"><span class="keyword">where</span></span>
  Out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">outsp_converter</span> <span class="free">out</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">out</span> <span class="main">∈</span> outs_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
<span class="main">|</span> Cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">outsp_converter</span> <span class="free">out</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span> 
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conv'</span></span></span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">outsp_converter</span> <span class="free">out</span> <span class="free"><span class="bound"><span class="entity">conv'</span></span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">outs_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="tfree">'out</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">outs_converter</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> outsp_converter <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">resultsp_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">b</span> <span class="keyword2"><span class="keyword">where</span></span>
  Result<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">resultsp_converter</span> <span class="free">b</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conv'</span></span></span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
<span class="main">|</span> Cont<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">resultsp_converter</span> <span class="free">b</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conv'</span></span></span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">resultsp_converter</span> <span class="free">b</span> <span class="free"><span class="bound"><span class="entity">conv'</span></span></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">results_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">results_converter</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> resultsp_converter <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> outsp_converter_outs_converter_eq <span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Converter.outsp_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> outs_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> outs_converter_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹Local_Theory.map_background_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"outs_converter"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">lemmas</span></span> intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span> <span class="main">=</span> outsp_converter.intros<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> Out <span class="main">=</span> outsp_converter.Out<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> Cont <span class="main">=</span> outsp_converter.Cont<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Out Cont<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> outs_converter<span class="main">]</span> <span class="main">=</span> outsp_converter.induct<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> cases <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Out Cont<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> outs_converter<span class="main">]</span> <span class="main">=</span> outsp_converter.cases<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> simps <span class="main">=</span> outsp_converter.simps<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> outs_converter_Converter <span class="main">[</span><span class="operator">to_set</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Converter.outsp_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">x</span> <span class="main">(</span>Converter <span class="free">conv</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> resultsp_converter_results_converter_eq <span class="main">[</span><span class="operator">pred_set_conv</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Converter.resultsp_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> results_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_converter_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹Local_Theory.map_background_naming <span class="main">(</span>Name_Space.mandatory_path <span class="inner_quoted">"results_converter"</span><span class="main">)</span>›</span>

<span class="keyword1"><span class="command">lemmas</span></span> intros <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span> <span class="main">=</span> resultsp_converter.intros<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> Result <span class="main">=</span> resultsp_converter.Result<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> Cont <span class="main">=</span> resultsp_converter.Cont<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> induct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Result Cont<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> results_converter<span class="main">]</span> <span class="main">=</span> resultsp_converter.induct<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> cases <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Result Cont<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword">set</span><span class="main"><span class="main">:</span></span> results_converter<span class="main">]</span> <span class="main">=</span> resultsp_converter.cases<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">and</span></span> simps <span class="main">=</span> resultsp_converter.simps<span class="main">[</span><span class="operator">to_set</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> results_converter_Converter <span class="main">[</span><span class="operator">to_set</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Converter.resultsp_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">x</span> <span class="main">(</span>Converter <span class="free">conv</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relator›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">rel_converter</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span> <span class="main">⇒</span> <span class="tfree">'out'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in</span> <span class="main">⇒</span> <span class="tfree">'in'</span> <span class="main">⇒</span> bool<span class="main">)</span> 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="entity">B</span> <span class="entity">C</span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
    rel_converterI<span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_fun <span class="free">A</span> <span class="main">(</span>rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span><span class="free">rel_converter</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv1</span></span></span><span class="main">)</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span> 
  <span class="main">⟹</span> <span class="free">rel_converter</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> rel_converter<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> rel_converter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">conv1</span> <span class="free">conv2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">conv1</span> <span class="bound">conv2</span><span class="main">.</span> <span class="free">X</span> <span class="bound">conv1</span> <span class="bound">conv2</span> <span class="main">⟹</span>
         rel_fun <span class="free">A</span> <span class="main">(</span>rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span><span class="main">λ</span><span class="bound">conv1</span> <span class="bound">conv2</span><span class="main">.</span> <span class="free">X</span> <span class="bound">conv1</span> <span class="bound">conv2</span> <span class="main">∨</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="bound">conv1</span> <span class="bound">conv2</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>
            <span class="main">(</span>run_converter <span class="bound">conv1</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="bound">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">conv1</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_converter.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">(</span>Converter <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Converter <span class="free">g</span><span class="main">)</span> <span class="main">⟷</span> 
  rel_fun <span class="free">A</span> <span class="main">(</span>rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> rel_converter.simps<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converterD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">conv1</span> <span class="free">conv2</span> 
  <span class="main">⟹</span> rel_fun <span class="free">A</span> <span class="main">(</span>rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="free">conv1</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_eq14<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="main">(=)</span> <span class="free">B</span> <span class="free">C</span> <span class="main">(=)</span> <span class="main">=</span> rel_converter' <span class="free">B</span> <span class="free">C</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv1</span></span> <span class="quoted"><span class="skolem">conv2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_converter.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_gpv_conv_rel_gpv''<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv1</span></span> <span class="quoted"><span class="skolem">conv2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> converter.rel_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gpv.rel_mono_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def rel_gpv_conv_rel_gpv''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_eq <span class="main">[</span><span class="operator">relator_eq</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">(=)</span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_converter_eq14 converter.rel_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_mono <span class="main">[</span><span class="operator">relator_mono</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">≤</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≤</span> <span class="free">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R'</span> <span class="main">≤</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">≤</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_converterD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> prod.rel_mono_strong rel_fun_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_conversep<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span><span class="main">¯¯</span> <span class="free">B</span><span class="main">¯¯</span> <span class="free">C</span><span class="main">¯¯</span> <span class="free">R</span><span class="main">¯¯</span> <span class="main">=</span> <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">¯¯</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">R</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="skolem">A</span><span class="main">¯¯</span> <span class="skolem">B</span><span class="main">¯¯</span> <span class="skolem">C</span><span class="main">¯¯</span> <span class="skolem">R</span><span class="main">¯¯</span> <span class="skolem">conv2</span> <span class="skolem">conv1</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a1</span> <span class="main">⇒</span> <span class="tfree">'a2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b1</span> <span class="main">⇒</span> <span class="tfree">'b2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c1</span> <span class="main">⇒</span> <span class="tfree">'c2</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r1</span> <span class="main">⇒</span> <span class="tfree">'r2</span> <span class="main">⇒</span> bool"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">conv2</span> <span class="skolem">conv1</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduct</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> rel_converterD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">⌑</span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_fun_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_gpv''_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_fun_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_def conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prod.rel_mono_strong rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">¯¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">¯¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">¯¯</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯¯</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span><span class="main">¯¯</span> <span class="free">B</span><span class="main">¯¯</span> <span class="free">C</span><span class="main">¯¯</span> <span class="free">R</span><span class="main">¯¯</span> <span class="skolem">conv2</span> <span class="skolem">conv1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_map_converter'1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">(</span>map_converter' <span class="free">f</span> <span class="free">g</span> <span class="free">conv1</span><span class="main">)</span> <span class="free">conv2</span> <span class="main">=</span> rel_converter <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">C</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">R</span> <span class="free">conv1</span> <span class="free">conv2</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> rel_converterD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.rel_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fun_mono rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv'_id rel_gpv''_map_gpv map_converter.sel map_converter_id14<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_comp spmf_rel_map prod.rel_map<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> rel_converterD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.rel_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fun_mono rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv'_id rel_gpv''_map_gpv map_converter.sel map_converter_id14<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_comp spmf_rel_map prod.rel_map<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_map_converter'2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">conv1</span> <span class="main">(</span>map_converter' <span class="free">f</span> <span class="free">g</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span> rel_converter <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">R</span> <span class="free">conv1</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rel_converter_map_converter'1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"conversep <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="free">R</span>"</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv1</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">_</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_converter_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> converter_rel_map' <span class="main">=</span> rel_converter_map_converter'1<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> rel_converter_map_converter'2

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_pos_distr <span class="main">[</span><span class="operator">relator_distr</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="keyword1">OO</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span> <span class="main">≤</span> rel_converter <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">OO</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> predicate2I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">OO</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R'</span><span class="main">)</span> <span class="skolem">conv1</span> <span class="skolem">conv3</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="keyword1">OO</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span><span class="main">)</span> <span class="skolem">conv1</span> <span class="skolem">conv3</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv3</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv1</span></span> <span class="quoted"><span class="skolem">conv3</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> relcomppE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> rel_converterD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_fun_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> pos_fun_distr<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> relcomppI<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_gpv''_pos_distr<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  prod.rel_compp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.rel_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> left_unique_rel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> left_total <span class="free">A</span><span class="main">;</span> left_unique <span class="free">B</span><span class="main">;</span> left_unique <span class="free">C</span><span class="main">;</span> left_total <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> left_unique <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> left_unique_alt_def left_total_alt_def rel_converter_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> rel_converter_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_converter_pos_distr<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rel_converter_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> right_unique_rel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> right_total <span class="free">A</span><span class="main">;</span> right_unique <span class="free">B</span><span class="main">;</span> right_unique <span class="free">C</span><span class="main">;</span> right_total <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> right_unique <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> right_unique_alt_def right_total_alt_def rel_converter_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> rel_converter_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_converter_pos_distr<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rel_converter_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bi_unique_rel_converter <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bi_total <span class="free">A</span><span class="main">;</span> bi_unique <span class="free">B</span><span class="main">;</span> bi_unique <span class="free">C</span><span class="main">;</span> bi_total <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> bi_unique <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bi_unique_alt_def bi_total_alt_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> left_unique_rel_converter right_unique_rel_converter<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rel_witness_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span> <span class="main">⇒</span> <span class="tfree">'out'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in</span> <span class="main">⇒</span> <span class="tfree">'in''</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in''</span> <span class="main">⇒</span> <span class="tfree">'in'</span> <span class="main">⇒</span> bool<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out</span> <span class="main">×</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in''</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rel_witness_converter</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">=</span> corec_converter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">conv1</span><span class="main">,</span> <span class="bound">conv2</span><span class="main">)</span><span class="main">.</span>
   map_gpv <span class="main">(</span>map_prod id Inr <span class="main">∘</span> rel_witness_prod<span class="main">)</span> id <span class="main">∘</span> 
   rel_witness_gpv <span class="main">(</span>rel_prod <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span>rel_converter <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">OO</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="keyword1">OO</span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">R'</span></span></span> <span class="main">∘</span> 
   rel_witness_fun <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">(</span>run_converter <span class="bound">conv1</span><span class="main">,</span> run_converter <span class="bound">conv2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_witness_converter_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span>rel_witness_converter <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">R'</span> <span class="main">(</span><span class="free">conv1</span><span class="main">,</span> <span class="free">conv2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
   map_gpv <span class="main">(</span>map_prod id <span class="main">(</span>rel_witness_converter <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">R'</span><span class="main">)</span> <span class="main">∘</span> rel_witness_prod<span class="main">)</span> id <span class="main">∘</span> 
   rel_witness_gpv <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_converter <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">B</span> <span class="free">C</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span> <span class="free">R'</span> <span class="main">∘</span> 
   rel_witness_fun <span class="free">A</span> <span class="free">A'</span> <span class="main">(</span>run_converter <span class="free">conv1</span><span class="main">,</span> run_converter <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_witness_converter_def o_def fun_eq_iff gpv.map_comp <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">B</span> <span class="free">C</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R'</span><span class="main">)</span> <span class="free">conv</span> <span class="free">conv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"left_total <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="free">R'</span>"</span></span> <span class="quoted"><span class="quoted">"left_total <span class="free">R'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> rel_witness_converter1<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="main">(</span><span class="bound">b'</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> <span class="bound">b'</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">b'</span> <span class="bound">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c</span> <span class="main">(</span><span class="bound">c'</span><span class="main">,</span> <span class="bound">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">c'</span> <span class="bound">d</span><span class="main">)</span> <span class="free">R</span> <span class="free">conv</span> <span class="main">(</span>rel_witness_converter <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">R'</span> <span class="main">(</span><span class="free">conv</span><span class="main">,</span> <span class="free">conv'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> rel_witness_converter2<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c'</span><span class="main">)</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">c'</span> <span class="main">∧</span> <span class="free">B</span> <span class="bound">b</span> <span class="bound">c'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">d'</span><span class="main">)</span> <span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">=</span> <span class="bound">d'</span> <span class="main">∧</span> <span class="free">C</span> <span class="bound">c</span> <span class="bound">d'</span><span class="main">)</span> <span class="free">R'</span> <span class="main">(</span>rel_witness_converter <span class="free">A</span> <span class="free">A'</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">R'</span> <span class="main">(</span><span class="free">conv</span><span class="main">,</span> <span class="free">conv'</span><span class="main">)</span><span class="main">)</span> <span class="free">conv'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> rel_converter
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> rel_converterD<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_fun_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_witness_fun1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ A A'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_gpv''_map_gpv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rel_witness_gpv1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ R R'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> rel_converter
    <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">THEN</span> rel_converterD<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comp<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_fun_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel_witness_fun2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ A A'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_gpv''_map_gpv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rel_witness_gpv2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ R R'<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_neg_distr <span class="main">[</span><span class="operator">relator_distr</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"left_total <span class="free">A'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"left_unique <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"right_total <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"right_unique <span class="free">R'</span>"</span></span> <span class="quoted"><span class="quoted">"left_total <span class="free">R'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">OO</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R'</span><span class="main">)</span> <span class="main">≤</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="keyword1">OO</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> predicate2I relcomppI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">conv</span> <span class="skolem">conv''</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">OO</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span><span class="free">R</span> <span class="keyword1">OO</span> <span class="free">R'</span><span class="main">)</span> <span class="skolem">conv</span> <span class="skolem">conv''</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?conv'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_converter' <span class="main">(</span>relcompp_witness <span class="free">B</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span>relcompp_witness <span class="free">C</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span>rel_witness_converter <span class="free">A</span> <span class="free">A'</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">OO</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">OO</span> <span class="free">C'</span><span class="main">)</span> <span class="free">R</span> <span class="free">R'</span> <span class="main">(</span><span class="skolem">conv</span><span class="main">,</span> <span class="skolem">conv''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="skolem">conv</span> <span class="var">?conv'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rel_witness_converter1<span class="main">[</span><span class="operator">OF</span> * A A' R R'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> converter_rel_map'
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_converter_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> relcomppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompp_witness<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span> <span class="var">?conv'</span> <span class="skolem">conv''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rel_witness_converter2<span class="main">[</span><span class="operator">OF</span> * A A' R R'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> converter_rel_map'
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_converter_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarify</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> relcomppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompp_witness<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> left_total_rel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> left_unique <span class="free">A</span><span class="main">;</span> right_total <span class="free">A</span><span class="main">;</span> left_total <span class="free">B</span><span class="main">;</span> left_total <span class="free">C</span><span class="main">;</span> left_unique <span class="free">R</span><span class="main">;</span> right_total <span class="free">R</span> <span class="main">⟧</span>
  <span class="main">⟹</span> left_total <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> left_unique_alt_def left_total_alt_def rel_converter_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_converter_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_converter_neg_distr<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_unique_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_converter_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> right_total_rel_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> right_unique <span class="free">A</span><span class="main">;</span> left_total <span class="free">A</span><span class="main">;</span> right_total <span class="free">B</span><span class="main">;</span> right_total <span class="free">C</span><span class="main">;</span> right_unique <span class="free">R</span><span class="main">;</span> left_total <span class="free">R</span> <span class="main">⟧</span>
   <span class="main">⟹</span> right_total <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> right_unique_alt_def right_total_alt_def rel_converter_conversep<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_converter_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_converter_neg_distr<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_unique_alt_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_converter_mono<span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> bi_total_rel_converter <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bi_total <span class="free">A</span><span class="main">;</span> bi_unique <span class="free">A</span><span class="main">;</span> bi_total <span class="free">B</span><span class="main">;</span> bi_total <span class="free">C</span><span class="main">;</span> bi_total <span class="free">R</span><span class="main">;</span> bi_unique <span class="free">R</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> bi_total <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bi_total_alt_def bi_unique_alt_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> left_total_rel_converter right_total_rel_converter<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">pred_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'in</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="entity">B</span> <span class="entity">C</span> <span class="entity">R</span> <span class="entity">conv</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">pred_converter</span> <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="free">conv</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>results_converter <span class="main">(</span>ℐ_uniform <span class="free">A</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="free">R</span><span class="main">)</span> <span class="free">conv</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span>"</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">out</span><span class="main">∈</span>outs_converter <span class="main">(</span>ℐ_uniform <span class="free">A</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="free">R</span><span class="main">)</span> <span class="free">conv</span><span class="main">.</span> <span class="free">C</span> <span class="bound">out</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pred_gpv'_mono_weak<span class="main">:</span> <span class="comment1">(* TODO: Generalize to R' ⊆ R *)</span>
  <span class="quoted"><span class="quoted">"pred_gpv' <span class="free">A</span> <span class="free">C</span> <span class="free">R</span> <span class="main">≤</span> pred_gpv' <span class="free">A'</span> <span class="free">C'</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≤</span> <span class="free">C'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_gpv'.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Domainp_rel_converter_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Domainp <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">≤</span> pred_converter <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Domainp <span class="free">B</span><span class="main">)</span> <span class="main">(</span>Domainp <span class="free">C</span><span class="main">)</span> <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> predicate1I pred_converter.intros strip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">conv</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">conv</span>"</span></span>  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">A</span><span class="main">)</span><span class="main">)</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>Collect <span class="main">(</span>Domainp <span class="free">R</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Domainp <span class="free">B</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> results_converter <span class="var">?ℐ</span> <span class="var">?ℐ'</span> <span class="skolem">conv</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_converter.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_funD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Domainp_rel_gpv''_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate1D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> DomainPI<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pred_gpv'.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_converter.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_funD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Domainp_rel_gpv''_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate1D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> DomainPI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pred_gpv'.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Domainp <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> outs_converter <span class="var">?ℐ</span> <span class="var">?ℐ'</span> <span class="skolem">conv</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">using</span></span> that *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_converter.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_funD<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Domainp_rel_gpv''_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate1D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> DomainPI<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pred_gpv'.cases<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_converter.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_funD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> Domainp_rel_gpv''_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate1D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> DomainPI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> pred_gpv'.cases<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_converter_Grp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rel_converter <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">(</span>BNF_Def.Grp <span class="free">B</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp <span class="free">C</span> <span class="free">h</span><span class="main">)</span> <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">k</span><span class="main">)</span><span class="main">¯¯</span> <span class="main">=</span>
   BNF_Def.Grp <span class="main">{</span><span class="bound">conv</span><span class="main">.</span> results_converter <span class="main">(</span>ℐ_uniform <span class="main">(</span>range <span class="free">f</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>range <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">conv</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">∧</span> 
    outs_converter <span class="main">(</span>ℐ_uniform <span class="main">(</span>range <span class="free">f</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>range <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">conv</span> <span class="main">⊆</span> <span class="free">C</span><span class="main">}</span>
    <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">including</span></span> lifting_syntax
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext GrpI iffI CollectI conjI subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>range <span class="free">f</span><span class="main">)</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>range <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">conv</span> <span class="skolem">conv'</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">conv</span> <span class="skolem">conv'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="skolem">conv</span> <span class="main">=</span> <span class="skolem">conv'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv</span></span> <span class="quoted"><span class="skolem">conv'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> rel_converterD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> map_converter.sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_fun_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_fun2_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_fun_comp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_fun_map_fun1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> rel_fun_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_gpv_conv_rel_gpv'' prod.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> predicate2I rel_gpv''_map_gpv'1
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span> prod.rel_mono_strong GrpE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> results_converter <span class="var">?ℐ</span> <span class="var">?ℐ'</span> <span class="skolem">conv</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="keyword1"><span class="command">using</span></span> * that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> Domainp_rel_converter_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate1D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> DomainPI<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Domainp_conversep Rangep_Grp <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Grp_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pred_converter.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">out</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">out</span> <span class="main">∈</span> outs_converter <span class="var">?ℐ</span> <span class="var">?ℐ'</span> <span class="skolem">conv</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">out</span> <span class="keyword1"><span class="command">using</span></span> * that
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> Domainp_rel_converter_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate1D<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> DomainPI<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Domainp_conversep Rangep_Grp <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> Grp_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> pred_converter.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?abr1</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> results_converter <span class="main">(</span>ℐ_uniform <span class="main">(</span>range <span class="free">f</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>range <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">conv</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?abr2</span></span></span><span class="main">=</span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> outs_converter <span class="main">(</span>ℐ_uniform <span class="main">(</span>range <span class="free">f</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>range <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="bound">conv</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">conv</span> <span class="skolem">conv'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="skolem">conv</span> <span class="skolem">conv'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span>  *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="skolem">conv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?abr1</span> <span class="skolem">conv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?abr2</span> <span class="skolem">conv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?abr1</span> <span class="skolem">conv</span> <span class="main">⟹</span> <span class="var">?abr2</span> <span class="skolem">conv</span> <span class="main">⟹</span> <span class="skolem">z</span> <span class="main">∈</span> run_converter <span class="skolem">conv</span> <span class="main">`</span> range <span class="free">f</span> <span class="main">⟹</span>
       <span class="skolem">out</span> <span class="main">∈</span> outs_gpv <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>range <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">⟹</span> BNF_Def.Grp <span class="free">C</span> <span class="free">h</span> <span class="skolem">out</span> <span class="main">(</span><span class="free">h</span> <span class="skolem">out</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv</span> <span class="skolem">z</span> <span class="skolem">out</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>  outs_converter.Out <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> f1 f2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">conv</span> <span class="skolem">conv'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">conv</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> map_converter.sel<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> map_fun_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_fun2_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> rel_fun_comp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_fun_map_fun2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_fun_refl_eq_onp<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> map_gpv_conv_map_gpv' gpv.comp comp_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> map_gpv'_id12<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_gpv''_map_gpv'2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_gpv''_map_gpv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_gpv''_refl_eq_on<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.rel_map<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> prod.rel_refl_strong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_converter.Result results_converter.Cont outs_converter.Cont <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="main">=</span> map_gpv_parametric'
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> Converter Converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> run_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>
  run_converter run_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> corec_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_sum <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>
   corec_converter corec_converter"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">s1</span> <span class="skolem">s2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s1</span></span> <span class="quoted"><span class="skolem">s2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comp prod.rel_map<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> rel_gpv''_map_gpv prod.rel_map <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod.rel_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_fun_mono rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A'</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">B</span> <span class="main">===&gt;</span> <span class="free">B'</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">C</span> <span class="main">===&gt;</span> <span class="free">C'</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">R'</span> <span class="main">===&gt;</span> <span class="free">R</span><span class="main">)</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span><span class="main">)</span>
  map_converter map_converter"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_converter_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer_prover</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter'_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">B</span> <span class="main">===&gt;</span> <span class="free">B'</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">C</span> <span class="main">===&gt;</span> <span class="free">C'</span><span class="main">)</span> <span class="main">===&gt;</span> rel_converter <span class="main">(=)</span> <span class="free">B</span> <span class="free">C</span> <span class="main">(=)</span> <span class="main">===&gt;</span> rel_converter <span class="main">(=)</span> <span class="free">B'</span> <span class="free">C'</span> <span class="main">(=)</span><span class="main">)</span>
  map_converter' map_converter'"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> map_converter_id14<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> case_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">X</span><span class="main">)</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> <span class="free">X</span><span class="main">)</span>
  case_converter case_converter"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> case_converter_conv_run_converter <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-typing›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">WT_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span><span class="keyword3">/ </span>_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">√</span>"</span> <span class="main">[</span>100<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 99<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="entity">ℐ'</span> <span class="keyword2"><span class="keyword">where</span></span>
    WT_converterI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main"><span class="free">,</span></span> <span class="free">ℐ'</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>C</sub></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main"><span class="free">√</span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> <span class="free">ℐ'</span> <span class="keyword1">⊢g</span> run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">q</span> <span class="main">√</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">r</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main"><span class="free">,</span></span> <span class="free">ℐ'</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>C</sub></span></span> <span class="bound">conv'</span> <span class="main"><span class="free">√</span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_coinduct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> WT_converter<span class="main">,</span> <span class="operator">case_conclusion</span> WT_converter WT_gpv results_gpv<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> WT_converter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">conv</span> <span class="bound">q</span> <span class="bound">r</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">conv</span><span class="main">;</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">ℐ'</span> <span class="keyword1">⊢g</span> run_converter <span class="bound">conv</span> <span class="bound">q</span> <span class="main">√</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span> <span class="main">∧</span> <span class="main">(</span><span class="free">X</span> <span class="bound">conv'</span> <span class="main">∨</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv'</span> <span class="main">√</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converterD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> WT_converterD_WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> run_converter <span class="free">conv</span> <span class="free">q</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_converterD_results<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">,</span> <span class="free">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> WT_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converterD'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> run_converter <span class="free">conv</span> <span class="free">q</span> <span class="main">√</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">q</span><span class="main">)</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv'</span> <span class="main">√</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> WT_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_bot1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bot<span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter.intros<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_mono<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ1</span><span class="main">,</span><span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span><span class="main">;</span> <span class="free">ℐ1'</span> <span class="main">≤</span> <span class="free">ℐ1</span><span class="main">;</span> <span class="free">ℐ2</span> <span class="main">≤</span> <span class="free">ℐ2'</span> <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">ℐ1'</span><span class="main">,</span><span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span> "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> WT_converterD_WT<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> outs_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> WT_gpv_mono<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> outs_ℐ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> responses_ℐ_mono<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> WT_converterD_results<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> outs_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> results_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> WT_converterD_WT<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> outs_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> responses_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">frule</span> WT_converterD_results<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> outs_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> results_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> WT_converterD_WT<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> outs_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> callee_invariant_on_run_resource <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on run_resource <span class="main">(</span>WT_resource <span class="free">ℐ</span><span class="main">)</span> <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_resourceD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> run_resource<span class="main">:</span> callee_invariant_on <span class="quoted">run_resource</span> <span class="quoted"><span class="quoted">"WT_resource <span class="free">ℐ</span>"</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ℐ</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> raw_converter_invariant_run_converter<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_converter_invariant <span class="free">ℐ</span> <span class="free">ℐ'</span> run_converter <span class="main">(</span>WT_converter <span class="free">ℐ</span> <span class="free">ℐ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> run_converter<span class="main">:</span> raw_converter_invariant <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="free">ℐ'</span></span> <span class="quoted">run_converter</span> <span class="quoted"><span class="quoted">"WT_converter <span class="free">ℐ</span> <span class="free">ℐ'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ℐ</span> <span class="free">ℐ'</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant_run_converter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_ℐ_full<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> ℐ_full <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_map_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">conv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> 
  *<span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">,</span> map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> *
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>WT_converter <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">conv'</span> <span class="skolem">conv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?WT_gpv</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT_converter
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_gpv_map_gpv' <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> WT_converterD_WT <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?results_gpv</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> strip conjI disjI1<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="skolem">conv</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">conv''</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> results<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span><span class="main">,</span> <span class="skolem">conv''</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="main">(</span>map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> conv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="skolem">conv''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> WT_converterD_results<span class="main">[</span><span class="operator">OF</span> WT_converter<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">q</span>"</span></span><span class="main">]</span> WT_converter<span class="main">(</span>2<span class="main">)</span> results 
    <span class="keyword1"><span class="command">have</span></span> r'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">∈</span> inv_into UNIV <span class="free">g</span> <span class="main">`</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> WT'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">,</span> map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">conv''</span> <span class="main">√</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> f<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> r' r <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> surj_f_inv_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> g<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">conv</span><span class="main">.</span> <span class="skolem">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> <span class="bound">conv</span> <span class="main">∧</span>
       map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">,</span> map_ℐ <span class="free">f'</span> <span class="free">g'</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> conv' WT' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Losslessness›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">plossless_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="entity">ℐ'</span> <span class="keyword2"><span class="keyword">where</span></span>
    plossless_converterI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">plossless_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> plossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">plossless_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_converter_coinduct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> plossless_converter<span class="main">,</span> <span class="operator">case_conclusion</span> plossless_converter plossless step<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> plossless_converter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">conv</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">conv</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> <span class="main">⟹</span> plossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="free">X</span> <span class="bound">conv'</span> <span class="main">∨</span> plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_converter.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_converterD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span><span class="main">;</span> <span class="free">a</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> 
  <span class="main">⟹</span> plossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> plossless_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_converter_bot1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter bot <span class="free">ℐ</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_converterI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_converter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ1'</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="main">≤</span> <span class="free">ℐ2'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ1'</span> <span class="free">ℐ2'</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> * WT
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> plossless_converterD<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">drule</span> WT_converterD'<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">erule</span> le<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> le<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> responses_ℐ_mono<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> plossless_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ le<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> results_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> subsetD<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> raw_converter_invariant_run_plossless_converter<span class="main">:</span> <span class="quoted"><span class="quoted">"raw_converter_invariant <span class="free">ℐ</span> <span class="free">ℐ'</span> run_converter <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD plossless_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> run_plossless_converter<span class="main">:</span> raw_converter_invariant
  <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="free">ℐ'</span></span> <span class="quoted">run_converter</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">ℐ</span> <span class="free">ℐ'</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> raw_converter_invariant_run_plossless_converter<span class="main">)</span>

<span class="keyword1"><span class="command">named_theorems</span></span> plossless_intro <span class="quoted">"Introduction rules for probabilistic losslessness"</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Operations›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">converter_of_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">converter_of_callee</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod id <span class="free">converter_of_callee</span><span class="main">)</span> id <span class="main">(</span><span class="free">callee</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> converter_of_callee_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_gpv'' <span class="main">(</span>rel_prod <span class="free">B</span> <span class="free">S</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">S</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>
  converter_of_callee converter_of_callee"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> converter_of_callee_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_of_callee<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
   converter_of_callee <span class="main">(</span>map_fun id <span class="main">(</span>map_fun <span class="free">f</span> <span class="main">(</span>map_gpv' <span class="main">(</span>map_prod <span class="free">g</span> id<span class="main">)</span> <span class="free">h</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">callee</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Eq_converter
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"map_gpv' <span class="main">(</span>map_prod <span class="free">g</span> id<span class="main">)</span> <span class="free">h</span> <span class="free">k</span> <span class="skolem">gpv</span> <span class="main">=</span> map_gpv <span class="main">(</span>map_prod <span class="free">g</span> id<span class="main">)</span> id <span class="main">(</span>map_gpv' id <span class="free">h</span> <span class="free">k</span> <span class="skolem">gpv</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_gpv_conv_map_gpv' gpv.compositionality<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv'_map_gpv_swap gpv.rel_map * <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_of_callee<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> <span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="free">callee</span> <span class="bound">s</span> <span class="bound">q</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">q</span> <span class="bound">r</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> converter_of_callee <span class="free">callee</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT res<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can define two versions of parallel composition. One that attaches to the same interface 
  and one that attach to different interfaces. We choose the one variant where both attach to the same interface
  because (1) this is more general and (2) we do not have to assume that the resource respects the parallel composition. 
›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">parallel_converter</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">parallel_converter</span> <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ac</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ac</span> <span class="keyword1">of</span>
     Inl <span class="bound">a</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">conv1'</span><span class="main">.</span> <span class="free">parallel_converter</span> <span class="bound">conv1'</span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="bound">a</span><span class="main">)</span>
   <span class="main">|</span> Inr <span class="bound">b</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span><span class="main">λ</span><span class="bound">conv2'</span><span class="main">.</span> <span class="free">parallel_converter</span> <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="bound">conv2'</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv2</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_callee_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_converter <span class="main">(</span>rel_sum <span class="free">A</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">B</span> <span class="free">B'</span><span class="main">)</span> <span class="free">C</span> <span class="free">R</span><span class="main">)</span>
   parallel_converter parallel_converter"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_converter_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter <span class="main">(</span>parallel_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="free">conv3</span> <span class="main">=</span>
   map_converter rsuml lsumr id id <span class="main">(</span>parallel_converter <span class="free">conv1</span> <span class="main">(</span>parallel_converter <span class="free">conv2</span> <span class="free">conv3</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv3</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 5 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI gpv.rel_refl_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map map_gpv'_id map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_parallel_converter <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> plossless_converter <span class="free">ℐ1</span> <span class="free">ℐ</span> <span class="free">conv1</span><span class="main">;</span> plossless_converter <span class="free">ℐ2</span> <span class="free">ℐ</span> <span class="free">conv2</span><span class="main">;</span> <span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span><span class="main">;</span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span> <span class="main">⟧</span>
  <span class="main">⟹</span> plossless_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">(</span>parallel_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">erule</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plossless_converterD<span class="main"><span class="keyword3">;</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> WT_converterD'<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">id_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="free">id_converter</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
   map_gpv <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">id_converter</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>Pause <span class="bound">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> Done <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> id_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">A</span> <span class="free">B</span> id_converter id_converter"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> id_converter_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> Done_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> Pause_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> converter_of_callee_id_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"converter_of_callee id_oracle <span class="free">s</span> <span class="main">=</span> id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_callee_plus_id_left<span class="main">:</span> <span class="quoted"><span class="quoted">"converter_of_callee <span class="main">(</span>plus_intercept id_oracle <span class="free">callee</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
  parallel_converter id_converter <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map id_oracle_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_callee_plus_id_right<span class="main">:</span> <span class="quoted"><span class="quoted">"converter_of_callee <span class="main">(</span>plus_intercept <span class="free">callee</span> id_oracle<span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
  parallel_converter <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI
      <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gpv.rel_refl <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map id_oracle_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_id_converter <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ</span> id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_id <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> id_converter <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_map_converter_idD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> map_converter id id <span class="free">f</span> <span class="free">g</span> id_converter <span class="main">√</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="main">≤</span> map_ℐ <span class="free">f</span> <span class="free">g</span> <span class="free">ℐ'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_ℐ_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fail_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fail_converter</span> <span class="main">=</span> Converter <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Fail<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fail_converter_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"run_converter fail_converter <span class="free">a</span> <span class="main">=</span> Fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fail_converter_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fail_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> fail_converter fail_converter"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fail_converter_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> Fail_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_fail_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> fail_converter <span class="main">⟷</span> <span class="free">ℐ</span> <span class="main">=</span> bot"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ℐ_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_fail_converterI <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter bot <span class="free">ℐ'</span> fail_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_fail_converter <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> fail_converter <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter.intros<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_id_move_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> id_converter <span class="main">=</span> map_converter <span class="main">(</span><span class="free">f'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">g'</span><span class="main">)</span> id id id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_id_move_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">f'</span> <span class="free">g'</span> id_converter <span class="main">=</span> map_converter id id <span class="main">(</span><span class="free">f'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">g'</span><span class="main">)</span> id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  And here is the version for parallel composition that assumes disjoint interfaces.
›</span></span>
<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">parallel_converter2</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'out</span> <span class="main">+</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in</span> <span class="main">+</span> <span class="tfree">'in'</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">parallel_converter2</span> <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ac</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">ac</span> <span class="keyword1">of</span>
     Inl <span class="bound">a</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inl <span class="main">(</span><span class="main">λ</span><span class="bound">conv1'</span><span class="main">.</span> <span class="free">parallel_converter2</span> <span class="bound">conv1'</span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>left_gpv <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
   <span class="main">|</span> Inr <span class="bound">b</span> <span class="main">⇒</span> map_gpv <span class="main">(</span>map_prod Inr <span class="main">(</span><span class="main">λ</span><span class="bound">conv2'</span><span class="main">.</span> <span class="free">parallel_converter2</span> <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="bound">conv2'</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>right_gpv <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv2</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_converter <span class="free">A'</span> <span class="free">B'</span> <span class="free">C'</span> <span class="free">R'</span> 
   <span class="main">===&gt;</span> rel_converter <span class="main">(</span>rel_sum <span class="free">A</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">B</span> <span class="free">B'</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">C</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">R</span> <span class="free">R'</span><span class="main">)</span><span class="main">)</span>
  parallel_converter2 parallel_converter2"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_converter2_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> left_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> right_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> map_converter_parallel_converter2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter <span class="main">(</span>map_sum <span class="free">f</span> <span class="free">f'</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="free">g</span> <span class="free">g'</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="free">h</span> <span class="free">h'</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="free">k</span> <span class="free">k'</span><span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span>
   parallel_converter2 <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv1</span><span class="main">)</span> <span class="main">(</span>map_converter <span class="free">f'</span> <span class="free">g'</span> <span class="free">h'</span> <span class="free">k'</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parallel_converter2_parametric<span class="main">[</span><span class="operator">of</span>
      <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span>  <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">h</span>"</span></span>  <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g'</span>"</span></span>  <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">h'</span>"</span></span>  <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">k'</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> sum.rel_conversep sum.rel_Grp
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_converter_Grp rel_fun_def Grp_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_parallel_converter2 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span><span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1'</span><span class="main">,</span><span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ1'</span><span class="main">,</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_gpv_left_gpv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD_WT<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD_results<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD_results<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_gpv_right_gpv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD_WT<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD_results<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD_results<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_parallel_converter2 <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ1</span> <span class="free">ℐ1'</span> <span class="free">conv1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ2</span> <span class="free">ℐ2'</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span><span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> plossless_converterD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_map1_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter2 <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv1</span><span class="main">)</span> <span class="free">conv2</span> <span class="main">=</span>
   map_converter <span class="main">(</span>map_sum <span class="free">f</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="free">g</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="free">h</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="free">k</span> id<span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_converter_parallel_converter2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_map2_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter2 <span class="free">conv1</span> <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span>
   map_converter <span class="main">(</span>map_sum id <span class="free">f</span><span class="main">)</span> <span class="main">(</span>map_sum id <span class="free">g</span><span class="main">)</span> <span class="main">(</span>map_sum id <span class="free">h</span><span class="main">)</span> <span class="main">(</span>map_sum id <span class="free">k</span><span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_converter_parallel_converter2<span class="main">)</span>


<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">left_interface</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span> <span class="main">+</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in</span> <span class="main">+</span> <span class="tfree">'in'</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">left_interface</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod id <span class="free">left_interface</span><span class="main">)</span> id <span class="main">(</span>left_gpv <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> left_interface_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>rel_sum <span class="free">C</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">R</span> <span class="free">R'</span><span class="main">)</span><span class="main">)</span> left_interface left_interface"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> left_interface_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> left_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">right_interface</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out'</span> <span class="main">+</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in'</span> <span class="main">+</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">right_interface</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod id <span class="free">right_interface</span><span class="main">)</span> id <span class="main">(</span>right_gpv <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> right_interface_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C'</span> <span class="free">R'</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>rel_sum <span class="free">C</span> <span class="free">C'</span><span class="main">)</span> <span class="main">(</span>rel_sum <span class="free">R</span> <span class="free">R'</span><span class="main">)</span><span class="main">)</span> right_interface right_interface"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> right_interface_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> right_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">=</span> parallel_converter <span class="main">(</span>left_interface <span class="free">conv1</span><span class="main">)</span> <span class="main">(</span>right_interface <span class="free">conv2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> converter.coinduct_strong<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 5 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI gpv.rel_refl_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conv_callee_parallel_id_left<span class="main">:</span> <span class="quoted"><span class="quoted">"converter_of_callee <span class="main">(</span>parallel_intercept id_oracle <span class="free">callee</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span>
  parallel_converter2 <span class="main">(</span>id_converter<span class="main">)</span> <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map left_gpv_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"id"</span></span><span class="main"><span class="main">]</span></span> 
      right_gpv_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"id"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_callee_parallel_id_right<span class="main">:</span> <span class="quoted"><span class="quoted">"converter_of_callee <span class="main">(</span>parallel_intercept <span class="free">callee</span> id_oracle<span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span>
  parallel_converter2 <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>id_converter<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map left_gpv_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"id"</span></span><span class="main"><span class="main">]</span></span> 
      right_gpv_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"id"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def  <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_callee_parallel<span class="main">:</span> <span class="quoted"><span class="quoted">"converter_of_callee <span class="main">(</span>parallel_intercept <span class="free">callee1</span> <span class="free">callee2</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">s'</span><span class="main">)</span> 
  <span class="main">=</span> parallel_converter2 <span class="main">(</span>converter_of_callee <span class="free">callee1</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>converter_of_callee <span class="free">callee2</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee1</span></span> <span class="quoted"><span class="free">callee2</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map left_gpv_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"id"</span></span><span class="main"><span class="main">]</span></span> right_gpv_map<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"id"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_refl<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_parallel_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_converter <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">converter_of_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">converter_of_resource</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_gpv <span class="main">(</span>map_prod id <span class="free">converter_of_resource</span><span class="main">)</span> id <span class="main">(</span>lift_spmf <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_of_resource <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> converter_of_resource <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_resourceD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_converter_of_resource <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="free">res</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="main">(</span>converter_of_resource <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lossless_resourceD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_converter_of_callee<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ1</span> <span class="main">⟹</span> plossless_gpv <span class="free">ℐ2</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">∈</span>results_gpv <span class="free">ℐ2</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ1</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x s <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">drule</span> assms<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">restrict_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">restrict_converter</span> <span class="free"><span class="bound"><span class="entity">cnv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span>
     map_gpv <span class="main">(</span>map_prod id <span class="main">(</span><span class="main">λ</span><span class="bound">cnv'</span><span class="main">.</span> <span class="free">restrict_converter</span> <span class="bound">cnv'</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>restrict_gpv <span class="free">ℐ</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">cnv</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>
   <span class="keyword1">else</span> Fail<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_restrict_converter <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> restrict_converter <span class="free">A</span> <span class="free">ℐ'</span> <span class="free">cnv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cnv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_results_gpv_restrict_gpvD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pgen_lossless_restrict_gpv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span> <span class="main">⟹</span> pgen_lossless_gpv <span class="free">b</span> <span class="free">ℐ</span> <span class="main">(</span>restrict_gpv <span class="free">ℐ</span> <span class="free">gpv</span><span class="main">)</span> <span class="main">=</span> pgen_lossless_gpv <span class="free">b</span> <span class="free">ℐ</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pgen_lossless_gpv_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expectation_gpv_restrict_gpv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_restrict_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="main">(</span>restrict_converter <span class="free">A</span> <span class="free">ℐ'</span> <span class="free">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_results_gpv_restrict_gpvD WT_converterD' plossless_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_map_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span>map_ℐ <span class="main">(</span>inv_into UNIV <span class="free">f</span><span class="main">)</span> <span class="main">(</span>inv_into UNIV <span class="free">g</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>map_ℐ <span class="free">h</span> <span class="free">k</span> <span class="free">ℐ'</span><span class="main">)</span> <span class="free">conv</span>"</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> plossless_converterD<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Attaching converters to resources›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="quoted">"<span class="entity">attach</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_resource <span class="main">(</span><span class="free">attach</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> 
   map_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">attach</span> <span class="bound">conv'</span> <span class="bound">res'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv run_resource <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> attach_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_resource <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_resource <span class="free">A</span> <span class="free">B</span><span class="main">)</span> attach attach"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> attach_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> exec_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_map_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv</span><span class="main">)</span> <span class="free">res</span> <span class="main">=</span> map_resource <span class="free">f</span> <span class="free">g</span> <span class="main">(</span>attach <span class="free">conv</span> <span class="main">(</span>map_resource <span class="free">h</span> <span class="free">k</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> attach_parametric<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">k</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_converter_Grp rel_resource_Grp
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"rel_fun <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>rel_fun <span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_resource_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rel_fun_def Grp_iff conversep_conversep rel_resource_Grp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_resource_attach <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span><span class="main">;</span> <span class="free">ℐ'</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="keyword1">⊢res</span> attach <span class="free">conv</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> run_resource.in_set_spmf_exec_gpv_into_results_gpv WT_converterD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_resource.exec_gpv_invariant<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lossless_attach <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ'</span> <span class="free">res</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lossless_resource <span class="free">ℐ</span> <span class="main">(</span>attach <span class="free">conv</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>lossless_resource <span class="skolem">a</span> <span class="skolem">res</span> <span class="skolem">conv</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> plossless_converterD<span class="main">[</span><span class="operator">OF</span> lossless_resource<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⟹</span> plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="bound">conv'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> WT_converterD'<span class="main">[</span><span class="operator">OF</span> lossless_resource<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> run_converter <span class="skolem">conv</span> <span class="skolem">a</span> <span class="main">√</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv'</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?lossless</span></span></span> <span class="keyword1"><span class="command">using</span></span> lossless<span class="main">(</span>1<span class="main">)</span> WT<span class="main">(</span>1<span class="main">)</span> lossless_resource<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_lossless_resource.plossless_exec_gpv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> lossless_resourceD<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">∈</span><span class="var">?set</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">b</span> <span class="bound">res'</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">res''</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">res''</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?set</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">conv'</span></span> <span class="skolem"><span class="skolem">res'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">res'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>exec_gpv run_resource <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">res</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">res''</span> <span class="main">=</span> attach <span class="skolem">conv'</span> <span class="skolem">res'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> run_lossless_resource.in_set_spmf_exec_gpv_into_results_gpv<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ℐ'</span></span><span class="main">]</span> lossless_resource<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> WT
    <span class="keyword1"><span class="command">have</span></span> conv'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv'</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> run_lossless_resource.exec_gpv_invariant<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ℐ'</span></span><span class="main">]</span> WT<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> WT<span class="main">(</span>1<span class="main">)</span> lossless<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> lossless_resource
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">b</span> <span class="skolem">res''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">attach_callee</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv<span class="main">)</span> 
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s'</span> <span class="main">⇒</span> <span class="tfree">'out</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in</span> <span class="main">×</span> <span class="tfree">'s'</span><span class="main">)</span> spmf<span class="main">)</span>
  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s'</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'s</span> <span class="main">×</span> <span class="tfree">'s'</span><span class="main">)</span> spmf<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">attach_callee</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="free"><span class="bound"><span class="entity">oracle</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_spmf rprodl <span class="main">(</span>exec_gpv <span class="free"><span class="bound"><span class="entity">oracle</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="bound">s</span> <span class="bound">q</span><span class="main">)</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> attach_callee_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach_callee <span class="free">callee</span> <span class="free">oracle</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> map_spmf rprodl <span class="main">(</span>exec_gpv <span class="free">oracle</span> <span class="main">(</span><span class="free">callee</span> <span class="free">s</span> <span class="free">q</span><span class="main">)</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_callee_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_CNV_RES<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach <span class="main">(</span>converter_of_callee <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>resource_of_oracle <span class="free">res</span> <span class="free">s'</span><span class="main">)</span> <span class="main">=</span> 
   resource_of_oracle <span class="main">(</span>attach_callee <span class="free">callee</span> <span class="free">res</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map rel_fun_def exec_gpv_map_gpv_id
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exec_gpv_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> resource_of_oracle <span class="free">res</span> <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map gpv.rel_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_stateless_callee<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach_callee <span class="main">(</span>stateless_callee <span class="free">callee</span><span class="main">)</span> <span class="free">oracle</span> <span class="main">=</span> extend_state_oracle <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> exec_gpv <span class="free">oracle</span> <span class="main">(</span><span class="free">callee</span> <span class="bound">q</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_callee_def stateless_callee_def fun_eq_iff exec_gpv_map_gpv_id spmf.map_comp o_def split_def apfst_def map_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_id_converter <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"attach id_converter <span class="free">res</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map split_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_callee_parallel_intercept<span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"attach_callee <span class="main">(</span>parallel_intercept <span class="free">callee1</span> <span class="free">callee2</span><span class="main">)</span> <span class="main">(</span>plus_oracle <span class="free">oracle1</span> <span class="free">oracle2</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span>rprodl <span class="main">---&gt;</span> id <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod id lprodr<span class="main">)</span><span class="main">)</span> <span class="main">(</span>plus_oracle <span class="main">(</span>lift_state_oracle extend_state_oracle <span class="main">(</span>attach_callee <span class="free">callee1</span> <span class="free">oracle1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>extend_state_oracle <span class="main">(</span>attach_callee <span class="free">callee2</span> <span class="free">oracle2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s1</span> <span class="skolem">s2</span> <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_plus_oracle_left exec_gpv_plus_oracle_right spmf.map_comp apfst_def o_def prod.map_comp split_def exec_gpv_map_gpv_id <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_spmf_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> attach_callee_id_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach_callee id_oracle <span class="free">oracle</span> <span class="main">=</span> extend_state_oracle <span class="free">oracle</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff id_oracle_def map_spmf_conv_bind_spmf split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_parallel2<span class="main">:</span> <span class="quoted"><span class="quoted">"attach <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">(</span>parallel_resource <span class="free">res1</span> <span class="free">res2</span><span class="main">)</span>
  <span class="main">=</span> parallel_resource <span class="main">(</span>attach <span class="free">conv1</span> <span class="free">res1</span><span class="main">)</span> <span class="main">(</span>attach <span class="free">conv2</span> <span class="free">res2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">res1</span></span> <span class="quoted"><span class="free">res2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> conv1 conv2 res1 res2 a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_map_gpv_id spmf_rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span>
        exec_gpv_parametric'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?S</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">res1res2</span> <span class="bound">res1</span><span class="main">.</span> <span class="bound">res1res2</span> <span class="main">=</span> parallel_resource <span class="bound">res1</span> <span class="skolem">res2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
          A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inl <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inl <span class="bound">r</span>"</span></span><span class="main"><span class="main">,</span></span> 
          <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD
          <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> left_gpv_Inl_transfer<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> conv1 conv2 res1 res2 a
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_map_gpv_id spmf_rel_map<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span>
        exec_gpv_parametric'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?S</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">res1res2</span> <span class="bound">res2</span><span class="main">.</span> <span class="bound">res1res2</span> <span class="main">=</span> parallel_resource <span class="skolem">res1</span> <span class="bound">res2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
          A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inr <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inr <span class="bound">r</span>"</span></span><span class="main"><span class="main">,</span></span> 
          <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD
          <span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def spmf_rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> right_gpv_Inr_transfer<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI conjI refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composing converters›</span></span>

<span class="keyword1"><span class="command">primcorec</span></span> <span class="entity">comp_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"run_converter <span class="main">(</span><span class="free">comp_converter</span> <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span>
  map_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv1'</span><span class="main">)</span><span class="main">,</span> <span class="bound">conv2'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="free">comp_converter</span> <span class="bound">conv1'</span> <span class="bound">conv2'</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>inline run_converter <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv1</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">conv2</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C</span> <span class="free">R</span> <span class="main">===&gt;</span> rel_converter <span class="free">C</span> <span class="free">R</span> <span class="free">C'</span> <span class="free">R'</span> <span class="main">===&gt;</span> rel_converter <span class="free">A</span> <span class="free">B</span> <span class="free">C'</span> <span class="free">R'</span><span class="main">)</span>
  comp_converter comp_converter"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comp_converter_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> inline_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> map_gpv_parametric'<span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_map_converter1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">conv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"comp_converter <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv</span><span class="main">)</span> <span class="free">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> id id <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="main">(</span>map_converter <span class="free">h</span> <span class="free">k</span> id id <span class="free">conv'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_converter_parametric<span class="main">[</span><span class="operator">of</span>
      <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="main">(</span>id <span class="main">::</span> <span class="tfree">'out</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="main">(</span>id <span class="main">::</span> <span class="tfree">'in</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_converter_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def Grp_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_converter_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> conversep_conversep eq_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_converter_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_map_converter2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"comp_converter <span class="free">conv</span> <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv'</span><span class="main">)</span> <span class="main">=</span> map_converter id id <span class="free">h</span> <span class="free">k</span> <span class="main">(</span>comp_converter <span class="main">(</span>map_converter id id <span class="free">f</span> <span class="free">g</span> <span class="free">conv</span><span class="main">)</span> <span class="free">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> comp_converter_parametric<span class="main">[</span><span class="operator">of</span>
      <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="main">(</span>id <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="main">(</span>id <span class="main">::</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">f</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"BNF_Def.Grp UNIV <span class="free">h</span>"</span></span> <span class="quoted"><span class="quoted">"conversep <span class="main">(</span>BNF_Def.Grp UNIV <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_converter_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def Grp_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="quasi_keyword">at</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span> <span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_converter_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> conversep_conversep rel_converter_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> eq_alt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> conversep_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">⌑</span></span> <span class="main"><span class="main">_</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"rel_converter <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">⌑</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quasi_keyword">asm</span> eq_alt<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_converter_Grp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Grp_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> attach_compose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"attach <span class="main">(</span>comp_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="free">res</span> <span class="main">=</span> attach <span class="free">conv1</span> <span class="main">(</span>attach <span class="free">conv2</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map exec_gpv_map_gpv_id exec_gpv_inline o_def split_beta<span class="main">)</span>
  <span class="keyword1"><span class="command">including</span></span> lifting_syntax
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exec_gpv_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s2</span><span class="main">.</span> <span class="bound">s2</span> <span class="main">=</span> attach <span class="bound">l</span> <span class="bound">r</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_def spmf_rel_map gpv.rel_eq split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI rel_spmf_reflI<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> comp_converter_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"comp_converter <span class="main">(</span>comp_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="free">conv3</span> <span class="main">=</span> comp_converter <span class="free">conv1</span> <span class="main">(</span>comp_converter <span class="free">conv2</span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv3</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map inline_map_gpv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> inline_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map<span class="main">)</span>
  <span class="keyword1"><span class="command">including</span></span> lifting_syntax
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> gpv.rel_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inline_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">s2</span><span class="main">.</span> <span class="bound">s2</span> <span class="main">=</span> comp_converter <span class="bound">l</span> <span class="bound">r</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 4
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq gpv.rel_map split_beta <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI gpv.rel_refl_strong<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> comp_converter_assoc_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"comp_converter <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">=</span> <span class="free">conv3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"comp_converter <span class="free">conv1</span> <span class="main">(</span>comp_converter <span class="free">conv2</span> <span class="free">conv</span><span class="main">)</span> <span class="main">=</span> comp_converter <span class="free">conv3</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fold</span> comp_converter_assoc<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_attach_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"comp_converter <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">=</span> <span class="free">conv3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"attach <span class="free">conv1</span> <span class="main">(</span>attach <span class="free">conv2</span> <span class="free">res</span><span class="main">)</span> <span class="main">=</span> attach <span class="free">conv3</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fold</span> attach_compose<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>  

<span class="keyword1"><span class="command">lemmas</span></span> comp_converter_eqs <span class="main">=</span> 
  asm_rl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> psi<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">x</span> <span class="free">y</span> <span class="main"><span class="main">::</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> converter"</span></span><span class="main">]</span>
  comp_converter_assoc_left
  comp_converter_attach_left

<span class="keyword1"><span class="command">lemma</span></span> WT_converter_comp <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span><span class="main">;</span> <span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv'</span> <span class="main">√</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> comp_converter <span class="free">conv</span> <span class="free">conv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD run_converter.results_gpv_inline <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_converter.WT_gpv_inline_invar<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ℐ'</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ℐ''</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_comp_converter <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ'</span> <span class="free">ℐ''</span> <span class="free">conv'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ</span> <span class="free">ℐ''</span> <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="free">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>plossless_converter <span class="skolem">a</span> <span class="skolem">conv</span> <span class="skolem">conv'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> conv1<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> plossless_converter<span class="main">(</span>1<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plossless_converterD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> conv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> run_converter <span class="skolem">conv</span> <span class="skolem">a</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> plossless_converter<span class="main">(</span>3<span class="main">,</span> 5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT_converterD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?plossless</span></span></span> <span class="keyword1"><span class="command">using</span></span> plossless_converter<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_plossless_converter.plossless_inline<span class="main"><span class="main">[</span></span><span class="operator">OF</span> conv1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> plossless_converterD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">∈</span><span class="var">?res</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">b</span> <span class="bound">conv'</span> <span class="main">∨</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">conv''</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv''</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?res</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">conv1</span></span> <span class="skolem"><span class="skolem">conv2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">conv''</span> <span class="main">=</span> comp_converter <span class="skolem">conv1</span> <span class="skolem">conv2</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> inline<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv1</span><span class="main">)</span><span class="main">,</span> <span class="skolem">conv2</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ''</span> <span class="main">(</span>inline run_converter <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">conv'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> run_plossless_converter.results_gpv_inline<span class="main">[</span><span class="operator">OF</span> inline conv2<span class="main">]</span> plossless_converter<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> run<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">conv1</span><span class="main">)</span> <span class="main">∈</span> results_gpv <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="skolem">conv</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ'</span> <span class="free">ℐ''</span> <span class="skolem">conv2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">conv2</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> WT_converterD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> plossless_converter<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> run<span class="main">]</span> plossless_converterD<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">,</span> <span class="operator">rule_format</span><span class="main">,</span> <span class="operator">OF</span> plossless_converter<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> run<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">b</span> <span class="skolem">conv''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_id_left<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_converter id_converter <span class="free">conv</span> <span class="main">=</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_funI gpv.rel_refl_strong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_id_right<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_converter <span class="free">conv</span> id_converter <span class="main">=</span> <span class="free">conv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> lem4<span class="main">:</span> <span class="quoted"><span class="quoted">"inline run_converter <span class="skolem">gpv</span> id_converter <span class="main">=</span> inline id_oracle <span class="skolem">gpv</span> id_converter"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gpv.rel_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> gpv.rel_mono_strong
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inline_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">=</span> id_converter"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_oracle_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI  gpv.rel_refl_strong<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lem4 gpv.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_funI gpv.rel_refl_strong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_coverter_of_callee<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_converter <span class="main">(</span>converter_of_callee <span class="free">callee1</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>converter_of_callee <span class="free">callee2</span> <span class="free">s2</span><span class="main">)</span>
  <span class="main">=</span> converter_of_callee <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> map_gpv rprodl id <span class="main">(</span>inline <span class="free">callee2</span> <span class="main">(</span><span class="free">callee1</span> <span class="bound">s1</span> <span class="bound">q</span><span class="main">)</span> <span class="bound">s2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">s1</span><span class="main">,</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">callee1</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">callee2</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map inline_map_gpv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> cal1 s1 cal2 s2 y
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> gpv.rel_mono_strong<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> inline_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> converter_of_callee <span class="skolem">cal2</span> <span class="bound">s</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq rel_fun_def gpv.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rprodl_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>exI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_converter_of_callee' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_coverter_of_callee<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_parallel2<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_converter <span class="main">(</span>parallel_converter2 <span class="free">conv1l</span> <span class="free">conv1r</span><span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv2l</span> <span class="free">conv2r</span><span class="main">)</span> <span class="main">=</span>
  parallel_converter2 <span class="main">(</span>comp_converter <span class="free">conv1l</span> <span class="free">conv2l</span><span class="main">)</span> <span class="main">(</span>comp_converter <span class="free">conv1r</span> <span class="free">conv2r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1l</span></span> <span class="quoted"><span class="free">conv1r</span></span> <span class="quoted"><span class="free">conv2l</span></span> <span class="quoted"><span class="free">conv2r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map inline_map_gpv <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> conv1l conv1r conv2l conv2r input
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> left_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map left_gpv_inline<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_gpv_conv_rel_gpv''<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inline_parametric'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="bound">c1</span> <span class="main">=</span> parallel_converter2 <span class="bound">c2</span> <span class="skolem">conv2r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inl <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inl <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map rel_gpv_conv_rel_gpv''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  gpv.rel_refl_strong rel_funI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> left_gpv_Inl_transfer<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 6 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.map_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> conv1l conv1r conv2l conv2r input
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> right_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map right_gpv_inline<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold</span> rel_gpv_conv_rel_gpv''<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_gpv''_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> inline_parametric'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">c1</span> <span class="bound">c2</span><span class="main">.</span> <span class="bound">c1</span> <span class="main">=</span> parallel_converter2 <span class="skolem">conv2l</span> <span class="bound">c2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inr <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">=</span> Inr <span class="bound">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> R'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map rel_gpv_conv_rel_gpv''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  gpv.rel_refl_strong rel_funI<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> right_gpv_Inr_transfer<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> 4 6 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.map_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_converter_parallel2' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_converter_parallel2<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_map1_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"comp_converter <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> id id <span class="free">conv</span><span class="main">)</span> <span class="free">conv'</span> <span class="main">=</span> map_converter <span class="free">f</span> <span class="free">g</span> id id <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="free">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_map_converter1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_comp1_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter2 <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="free">conv'</span><span class="main">)</span> <span class="free">conv''</span> <span class="main">=</span> comp_converter <span class="main">(</span>parallel_converter2 <span class="free">conv</span> id_converter<span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv'</span> <span class="free">conv''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_parallel2 comp_converter_id_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_comp2_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel_converter2 <span class="free">conv''</span> <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="free">conv'</span><span class="main">)</span> <span class="main">=</span> comp_converter <span class="main">(</span>parallel_converter2 id_converter <span class="free">conv</span><span class="main">)</span> <span class="main">(</span>parallel_converter2 <span class="free">conv''</span> <span class="free">conv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_parallel2 comp_converter_id_left<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Interaction bound›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">interaction_any_bounded_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter <span class="main">⇒</span> enat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interaction_any_bounded_converter</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">conv'</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span> <span class="main">∈</span> results'_gpv <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">interaction_any_bounded_converter</span> <span class="bound">conv'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converterD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">∈</span>results'_gpv <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">a</span><span class="main">)</span><span class="main">.</span> interaction_any_bounded_converter <span class="bound">conv'</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converter.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interaction_bounded_by_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_trivial <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv</span> <span class="main">∞</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> interaction_bounded_by.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> interaction_any_bounded_converter_start <span class="main">=</span> 
  interaction_any_bounded_converter_mono
  interaction_bounded_by_mono

<span class="keyword1"><span class="command">method</span></span> interaction_bound_converter_start <span class="main">=</span> <span class="main">(</span><span class="operator">rule</span> interaction_any_bounded_converter_start<span class="main">)</span>
<span class="keyword1"><span class="command">method</span></span> interaction_bound_converter_step <span class="keyword2"><span class="keyword">uses</span></span> add simp <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span><span class="operator">match</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">conclusion</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span> <span class="main"><span class="main">⇒</span></span> <span class="operator">fail</span> <span class="main"><span class="main">¦</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">_</span> <span class="main">_</span>"</span></span> <span class="main"><span class="main">⇒</span></span> <span class="operator">fail</span> <span class="main"><span class="main">¦</span></span> <span class="quoted"><span class="main">_</span></span> <span class="main"><span class="main">⇒</span></span> <span class="quoted">‹<span class="operator">solves</span> ‹<span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> <span class="dynamic"><span class="dynamic">simp</span></span>››</span><span class="main">)</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> <span class="dynamic"><span class="dynamic">add</span></span> <span class="dynamic"><span class="dynamic">interaction_bound</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">method</span></span> interaction_bound_converter_rec <span class="keyword2"><span class="keyword">uses</span></span> add simp <span class="main">=</span> 
  <span class="main">(</span><span class="operator">interaction_bound_converter_step</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">add</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">simp</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">interaction_bound_converter_rec</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">add</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">simp</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">method</span></span> interaction_bound_converter <span class="keyword2"><span class="keyword">uses</span></span> add simp <span class="main">=</span>
  <span class="main">(</span><span class="comment1">(* use in *)</span> <span class="operator">interaction_bound_converter_start</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">interaction_bound_converter_rec</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">add</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">simp</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_id <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"interaction_any_bounded_converter id_converter <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> raw_converter_invariant_interaction_any_bounded_converter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"raw_converter_invariant ℐ_full ℐ_full run_converter <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span><span class="main">.</span> interaction_any_bounded_converter <span class="bound">conv</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_gpv_ℐ_full <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_bounded_by_left_gpv <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="free">gpv</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">consider'</span> <span class="main">(</span>Inl <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">consider</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider'</span> <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ib</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> gpv <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ib</span> <span class="main">≡</span> interaction_bound <span class="free">consider</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_bound <span class="free">consider'</span> <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">ib</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interaction_bound_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">interaction_bound'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ib_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split if_split<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> … input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ile_eSuc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> … input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> … input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ib_def interaction_bounded_by.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_bounded_by_right_gpv <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider</span> <span class="free">gpv</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">consider'</span> <span class="main">(</span>Inr <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">consider</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="free">consider'</span> <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ib</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> gpv <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ib</span> <span class="main">≡</span> interaction_bound <span class="free">consider</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_bound <span class="free">consider'</span> <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">ib</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> interaction_bound_fixp_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">interaction_bound'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> ib_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> interaction_bound.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split if_split<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> … input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ile_eSuc<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> … input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> SUP_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> … input
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">input</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ib_def<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.hyps<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ib_def interaction_bounded_by.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_parallel_converter2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv1</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv2</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interaction_bounded_by_map_gpv_id <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interaction_bounded_by_left_gpv interaction_bounded_by_right_gpv <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_parallel_converter2' <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv1</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv2</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">(</span>max <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> interaction_any_bounded_converter_parallel_converter2<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> interaction_any_bounded_converter_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_compose <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv1</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv2</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>comp_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>interaction_any_bounded_converter <span class="skolem">conv1</span> <span class="free">n</span><span class="main">;</span> interaction_any_bounded_converter <span class="skolem">conv2</span> <span class="free">m</span><span class="main">⟧</span> <span class="main">⟹</span>
    interaction_any_bounded_by <span class="main">(</span>inline run_converter <span class="main">(</span>run_converter <span class="skolem">conv1</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">conv2</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">*</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">conv1</span> <span class="skolem">conv2</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interaction_bounded_by_inline_invariant<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv2</span><span class="main">.</span> interaction_any_bounded_converter <span class="bound">conv2</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> consider'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converterD<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_gpv_ℐ_full<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">intro</span> conjI strip interaction_bounded_by_map_gpv_id<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> raw_converter_invariant.results_gpv_inline<span class="main"><span class="main">[</span></span><span class="operator">OF</span> raw_converter_invariant_interaction_any_bounded_converter<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> exI conjI refl WT_gpv_full <span class="main"><span class="keyword3">|</span></span>  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> results_gpv_ℐ_full <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converterD
          raw_converter_invariant.results_gpv_inline<span class="main"><span class="main">[</span></span><span class="operator">OF</span> raw_converter_invariant_interaction_any_bounded_converter<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_of_callee <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="free">conv</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>converter_of_callee <span class="free">conv</span> <span class="free">s</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interaction_bounded_by_map_gpv_id assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_map_converter <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>map_converter <span class="free">f</span> <span class="free">g</span> <span class="free">h</span> <span class="free">k</span> <span class="free">conv</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms results'_gpv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹surj <span class="free">k</span>›</span></span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms  interaction_any_bounded_by_map_gpv' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_parallel_converter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv1</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv2</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>parallel_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interaction_bounded_by_map_gpv_id <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_parallel_converter' <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv1</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv2</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>parallel_converter <span class="free">conv1</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">(</span>max <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> interaction_any_bounded_converter_parallel_converter<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> interaction_any_bounded_converter_mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_converter_of_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>converter_of_resource <span class="free">res</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> interaction_bounded_by_map_gpv_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_converter_of_resource' <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>converter_of_resource <span class="free">res</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> interaction_any_bounded_converter_converter_of_resource<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_converter_restrict_converter <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>restrict_converter <span class="free">A</span> <span class="free">ℐ</span> <span class="free">cnv</span><span class="main">)</span> <span class="free">bound</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">cnv</span> <span class="free">bound</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cnv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converterD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_results'_gpv_restrict_gpvD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">interaction_bound</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Converter_Rewrite">
<div class="head">
<h1>Theory Converter_Rewrite</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Converter_Rewrite <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Converter.html">Converter</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Equivalence of converters restricted by interfaces›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">eq_resource_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">∼</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>100<span class="main">,</span> 99<span class="main">,</span> 99<span class="main">]</span> 99<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="keyword2"><span class="keyword">where</span></span>
    eq_resource_onI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main"><span class="free">∼</span></span> <span class="free"><span class="bound"><span class="entity">res'</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="free">eq_resource_on</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free"><span class="bound"><span class="entity">res'</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> eq_resource_on<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> eq_resource_on<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">res</span> <span class="free">res'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">res</span> <span class="bound">res'</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">res</span> <span class="bound">res'</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span>
      <span class="main">⟹</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">res</span> <span class="bound">res'</span><span class="main">.</span> <span class="free">X</span> <span class="bound">res</span> <span class="bound">res'</span> <span class="main">∨</span> <span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">res</span> <span class="main">∼</span> <span class="bound">res'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="bound">res'</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_onD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>eq_resource_on <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>run_resource <span class="free">res'</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_resource_on.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_refl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_reflI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="free">res'</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_resource_on_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res'</span> <span class="main">∼</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_resource_onD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">⌑</span></span></span>"</span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res''</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res'</span> <span class="main">∼</span> <span class="free">res''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span> <span class="quoted"><span class="free">res''</span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_resource_onD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_spmf_OO_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>rel_spmf_mono<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_UNIV_D <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="free">res'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_resource_onD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_UNIV_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span> <span class="main">⟷</span> <span class="free">res</span> <span class="main">=</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_resource_on_UNIV_D<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span><span class="main">;</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">A'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_resource_onD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_empty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_onI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_resource_on_resource_of_oracleI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">===&gt;</span> eq_on <span class="free">A</span> <span class="main">===&gt;</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free">r1</span> <span class="free">r2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> resource_of_oracle <span class="free">r1</span> <span class="free">s1</span> <span class="main">∼</span> resource_of_oracle <span class="free">r2</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> sim<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_on_def
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_on_def spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exec_gpv_eq_resource_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>eq_resource_on <span class="main">(</span>outs_ℐ <span class="free">ℐ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv run_resource <span class="free">gpv</span> <span class="free">res</span><span class="main">)</span> <span class="main">(</span>exec_gpv run_resource <span class="free">gpv</span> <span class="free">res'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> exec_gpv_fixp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="skolem">res</span> <span class="skolem">g1</span><span class="main">)</span><span class="main">;</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span>run_resource <span class="skolem">res'</span> <span class="skolem">g1</span><span class="main">)</span><span class="main">;</span>
    IO <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span><span class="main">;</span> outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">r1</span> <span class="main">∼</span> <span class="skolem">r2</span><span class="main">⟧</span> <span class="main">⟹</span> rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span>eq_resource_on <span class="main">(</span>outs_ℐ <span class="free">ℐ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="main">(</span><span class="skolem">exec_gpv'</span> <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">exec_gpv'</span> <span class="main">(</span><span class="skolem">g2</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g1</span> <span class="skolem">g2</span> <span class="skolem">r1</span> <span class="skolem">s</span> <span class="skolem">r2</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> WT_gpv_ContD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> outs_gpv.IO WT_calleeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> run_resource.WT_callee<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_resourceD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> 1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_gpv_outs_gpv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI step.prems <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> rel_spmf_bindI'<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_resource_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> outs_gpv.IO <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>  eq_resource_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> WT_gpv_outs_gpv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">eq_ℐ_generat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> generat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> generat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="entity">ℐ</span> <span class="entity">D</span> <span class="keyword2"><span class="keyword">where</span></span>
    Pure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eq_ℐ_generat</span> <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>Pure <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Pure <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
  <span class="main">|</span> IO<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eq_ℐ_generat</span> <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>IO <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>IO <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="free"><span class="bound"><span class="entity">c'</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">input</span><span class="main">.</span> <span class="bound">input</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="free"><span class="bound"><span class="entity">out</span></span></span> <span class="main">⟹</span> <span class="free">D</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c'</span></span></span> <span class="bound">input</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Pure IO

<span class="keyword1"><span class="command">inductive_simps</span></span> eq_ℐ_generat_simps <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>Pure <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Pure <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>IO <span class="free">out</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>Pure <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>Pure <span class="free">x</span><span class="main">)</span> <span class="main">(</span>IO <span class="free">out'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>IO <span class="free">out</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span>IO <span class="free">out'</span> <span class="free">c'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> eq_ℐ_generat_iff1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>Pure <span class="free">x</span><span class="main">)</span> <span class="free">g'</span>"</span></span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>IO <span class="free">out</span> <span class="free">c</span><span class="main">)</span> <span class="free">g'</span>"</span></span>

<span class="keyword1"><span class="command">inductive_simps</span></span> eq_ℐ_generat_iff2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="free">g</span> <span class="main">(</span>Pure <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="free">g</span> <span class="main">(</span>IO <span class="free">out</span> <span class="free">c</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_mono'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="free">x</span> <span class="free">y</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">A'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">D'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="free">ℐ</span> <span class="main">≤</span> <span class="free">ℐ'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> eq_ℐ_generat <span class="free">A'</span> <span class="free">ℐ'</span> <span class="free">D'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_generat.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">≤</span> eq_ℐ_generat <span class="free">A'</span> <span class="free">ℐ'</span> <span class="free">D'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≤</span> <span class="free">D'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≤</span> <span class="free">ℐ'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_mono' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> predicate2D<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_mono'' <span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">A'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">D'</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟧</span>
  <span class="main">⟹</span> eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟶</span> eq_ℐ_generat <span class="free">A'</span> <span class="free">ℐ</span> <span class="free">D'</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_mono'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_conversep<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span><span class="main">¯¯</span> <span class="free">ℐ</span> <span class="free">D</span><span class="main">¯¯</span> <span class="main">=</span> <span class="main">(</span>eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span><span class="main">)</span><span class="main">¯¯</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_reflI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> generat_pures <span class="free">generat</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">out</span> <span class="bound">c</span><span class="main">.</span> <span class="free">generat</span> <span class="main">=</span> IO <span class="bound">out</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="bound">out</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">input</span><span class="main">∈</span>responses_ℐ <span class="free">ℐ</span> <span class="bound">out</span><span class="main">.</span> <span class="free">D</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">input</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="free">generat</span> <span class="free">generat</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">generat</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_relcompp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="keyword1">OO</span> eq_ℐ_generat <span class="free">A'</span> <span class="free">ℐ</span> <span class="free">D'</span> <span class="main">=</span> eq_ℐ_generat <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">(</span><span class="free">D</span> <span class="keyword1">OO</span> <span class="free">D'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_generat.cases <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_iff1 eq_ℐ_generat_iff2 relcompp.simps<span class="main">)</span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_map1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="main">(</span>map_generat <span class="free">f</span> id <span class="main">(</span><span class="main">(∘)</span> <span class="free">g</span><span class="main">)</span> <span class="free">generat</span><span class="main">)</span> <span class="free">generat'</span> <span class="main">⟷</span>
   eq_ℐ_generat <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">D</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">generat</span> <span class="free">generat'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">generat</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">generat'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_map2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="free">D</span> <span class="free">generat</span> <span class="main">(</span>map_generat <span class="free">f</span> id <span class="main">(</span><span class="main">(∘)</span> <span class="free">g</span><span class="main">)</span> <span class="free">generat'</span><span class="main">)</span> <span class="main">⟷</span>
   eq_ℐ_generat <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">D</span> <span class="bound">x</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">generat</span> <span class="free">generat'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">generat</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">generat'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> eq_ℐ_generat_map <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> 
  eq_ℐ_generat_map1<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> eq_ℐ_generat_map2
  eq_ℐ_generat_map1<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">id</span><span class="main">,</span> <span class="operator">unfolded</span> fun.map_id0<span class="main">,</span> <span class="operator">abs_def</span><span class="main">]</span> eq_ℐ_generat_map2<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">id</span><span class="main">,</span> <span class="operator">unfolded</span> fun.map_id0<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_generat_into_rel_generat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_generat <span class="free">A</span> ℐ_full <span class="free">D</span> <span class="free">generat</span> <span class="free">generat'</span> <span class="main">⟹</span> rel_generat <span class="free">A</span> <span class="main">(=)</span> <span class="main">(</span>rel_fun <span class="main">(=)</span> <span class="free">D</span><span class="main">)</span> <span class="free">generat</span> <span class="free">generat'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">erule</span> eq_ℐ_generat.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">eq_ℐ_gpv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">A</span> <span class="entity">ℐ</span> <span class="keyword2"><span class="keyword">where</span></span>
    eq_ℐ_gpvI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eq_ℐ_gpv</span> <span class="free">A</span> <span class="free">ℐ</span> <span class="free"><span class="bound"><span class="entity">gpv</span></span></span> <span class="free"><span class="bound"><span class="entity">gpv'</span></span></span>"</span></span> 
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span><span class="free">eq_ℐ_gpv</span> <span class="free">A</span> <span class="free">ℐ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="free"><span class="bound"><span class="entity">gpv</span></span></span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="free"><span class="bound"><span class="entity">gpv'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> eq_ℐ_gpv<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> eq_ℐ_gpv<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">gpv</span> <span class="bound">gpv'</span><span class="main">.</span> <span class="free">X</span> <span class="bound">gpv</span> <span class="bound">gpv'</span>
      <span class="main">⟹</span> rel_spmf <span class="main">(</span>eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">gpv</span> <span class="bound">gpv'</span><span class="main">.</span> <span class="free">X</span> <span class="bound">gpv</span> <span class="bound">gpv'</span> <span class="main">∨</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="bound">gpv</span> <span class="bound">gpv'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="bound">gpv</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="bound">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpvD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span> <span class="main">⟹</span> rel_spmf <span class="main">(</span>eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="free">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_Done <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Done <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpvI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_Done_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Done <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">A</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_Pause<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">out</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">input</span><span class="main">.</span> <span class="bound">input</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="free">out</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span><span class="free">rpv</span> <span class="bound">input</span><span class="main">)</span> <span class="main">(</span><span class="free">rpv'</span> <span class="bound">input</span><span class="main">)</span> <span class="main">⟧</span>
  <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>Pause <span class="free">out</span> <span class="free">rpv</span><span class="main">)</span> <span class="main">(</span>Pause <span class="free">out</span> <span class="free">rpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpvI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">≤</span> eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≤</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≤</span> <span class="free">ℐ'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ'</span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">gpv</span></span> <span class="quoted"><span class="skolem">gpv'</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_spmf_mono eq_ℐ_generat_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> _ A<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> predicate2D<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_mono'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">A'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">;</span> <span class="free">ℐ</span> <span class="main">≤</span> <span class="free">ℐ'</span> <span class="main">⟧</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ'</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> predicate2D<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_mono'' <span class="main">[</span><span class="operator">mono</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span> <span class="main">⟶</span> eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">A'</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_conversep<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span><span class="main">¯¯</span> <span class="free">ℐ</span> <span class="main">=</span> <span class="main">(</span>eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span><span class="main">)</span><span class="main">¯¯</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="skolem">A</span> <span class="free">ℐ</span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="skolem">A</span><span class="main">¯¯</span> <span class="free">ℐ</span> <span class="skolem">gpv'</span> <span class="skolem">gpv</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">gpv</span></span> <span class="quoted"><span class="skolem">gpv'</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">⌑</span></span></span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.rel_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> option.rel_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_ℐ_generat_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_mono' rel_spmf_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"conversep <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span><span class="main">¯¯</span> <span class="free">ℐ</span> <span class="skolem">gpv'</span> <span class="skolem">gpv</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_reflI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> results_gpv <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">⟹</span> <span class="free">A</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">;</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span> <span class="main">⟧</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI eq_ℐ_generat_reflI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.set_cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_gpv.intros <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_into_rel_gpv<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> ℐ_full <span class="free">gpv</span> <span class="free">gpv'</span> <span class="main">⟹</span> rel_gpv <span class="free">A</span> <span class="main">(=)</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> spmf_rel_mono_strong generat.rel_mono_strong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_into_rel_generat <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_relcompp<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">=</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="keyword1">OO</span> eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext iffI relcomppI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> relcomppE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">gpv</span> <span class="skolem">gpv''</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">gpv</span> <span class="skolem">gpv''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">middle</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">middle</span> <span class="main">=</span> corec_gpv <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">gpv</span><span class="main">,</span> <span class="bound">gpv''</span><span class="main">)</span><span class="main">.</span>
    map_spmf <span class="main">(</span>map_generat <span class="main">(</span>relcompp_witness <span class="free">A</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span>relcompp_witness <span class="main">(=)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">(∘)</span> Inr <span class="main">∘</span> rel_witness_fun <span class="main">(=)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∘</span> 
              rel_witness_generat<span class="main">)</span>
    <span class="main">(</span>rel_witness_spmf <span class="main">(</span>eq_ℐ_generat <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">(</span>eq_ℐ_gpv <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="bound">gpv</span><span class="main">,</span> the_gpv <span class="bound">gpv''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> middle_sel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"the_gpv <span class="main">(</span><span class="skolem">middle</span> <span class="main">(</span><span class="skolem">gpv</span><span class="main">,</span> <span class="skolem">gpv''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
     map_spmf <span class="main">(</span>map_generat <span class="main">(</span>relcompp_witness <span class="free">A</span> <span class="free">A'</span><span class="main">)</span> <span class="main">(</span>relcompp_witness <span class="main">(=)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(</span><span class="main">(∘)</span> <span class="skolem">middle</span> <span class="main">∘</span> rel_witness_fun <span class="main">(=)</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∘</span> 
              rel_witness_generat<span class="main">)</span>
    <span class="main">(</span>rel_witness_spmf <span class="main">(</span>eq_ℐ_generat <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">ℐ</span> <span class="main">(</span>eq_ℐ_gpv <span class="main">(</span><span class="free">A</span> <span class="keyword1">OO</span> <span class="free">A'</span><span class="main">)</span> <span class="free">ℐ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">,</span> the_gpv <span class="skolem">gpv''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv</span> <span class="skolem">gpv''</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> middle_def spmf.map_comp o_def generat.map_comp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="skolem">gpv</span> <span class="main">(</span><span class="skolem">middle</span> <span class="main">(</span><span class="skolem">gpv</span><span class="main">,</span> <span class="skolem">gpv''</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">gpv</span></span> <span class="quoted"><span class="skolem">gpv''</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rel_witness_spmf1<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 3 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> relcomppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompp_witness eq_ℐ_generat.cases<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ</span> <span class="main">(</span><span class="skolem">middle</span> <span class="main">(</span><span class="skolem">gpv</span><span class="main">,</span> <span class="skolem">gpv''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">gpv''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">gpv</span></span> <span class="quoted"><span class="skolem">gpv''</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rel_witness_spmf2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 3 <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> relcomppE <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_witness_spmf2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> relcompp_witness eq_ℐ_generat.cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">gpv</span> <span class="skolem">gpv''</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A'</span> <span class="free">ℐ</span> <span class="skolem">gpv'</span> <span class="skolem">gpv''</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">gpv</span> <span class="skolem">gpv'</span> <span class="skolem">gpv''</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">gpv</span></span> <span class="quoted"><span class="skolem">gpv'</span></span> <span class="quoted"><span class="skolem">gpv''</span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rel_spmf_OO_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rel_spmf_mono
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_relcompp <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_mono'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_map_gpv1<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>map_gpv <span class="free">f</span> id <span class="free">gpv</span><span class="main">)</span> <span class="free">gpv'</span> <span class="main">⟷</span> eq_ℐ_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono eq_ℐ_generat_mono'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.map_sel spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono eq_ℐ_generat_mono'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_map_gpv2<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">(</span>map_gpv <span class="free">f</span> id <span class="free">gpv'</span><span class="main">)</span> <span class="main">=</span> eq_ℐ_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_ℐ_gpv_map_gpv1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"conversep <span class="free">A</span>"</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">gpv'</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">⌑</span></span></span>"</span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> eq_ℐ_gpv_conversep <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> eq_ℐ_gpv_map_gpv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> eq_ℐ_gpv_map_gpv1<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> eq_ℐ_gpv_map_gpv2

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> callee_invariant_on<span class="main">)</span> eq_ℐ_exec_gpv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span><span class="main">;</span> <span class="free">I</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> rel_spmf <span class="main">(</span>rel_prod <span class="free">A</span> <span class="main">(</span>eq_onp <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="free">callee</span> <span class="free">gpv</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="free">callee</span> <span class="free">gpv'</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_fixp_induct_2_2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> partial_function_definitions_spmf partial_function_definitions_spmf exec_gpv.mono exec_gpv.mono exec_gpv_def exec_gpv_def<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> lub_spmf_empty<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> adm bottom step<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span> <span class="skolem">exec_gpv''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rel_spmf_bindI
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_same_args 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_callee<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> WT_calleeD<span class="main"><span class="main">]</span></span> callee_invariant step.IH <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_coinduct_bind <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> eq_ℐ_gpv<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">gpv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">gpv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a'</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">gpv</span> <span class="bound">gpv'</span><span class="main">.</span> <span class="free">X</span> <span class="bound">gpv</span> <span class="bound">gpv'</span>
      <span class="main">⟹</span> rel_spmf <span class="main">(</span>eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">gpv</span> <span class="bound">gpv'</span><span class="main">.</span> <span class="free">X</span> <span class="bound">gpv</span> <span class="bound">gpv'</span> <span class="main">∨</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="bound">gpv</span> <span class="bound">gpv'</span> <span class="main">∨</span> 
      <span class="main">(</span><span class="main">∃</span><span class="bound">gpv''</span> <span class="bound">gpv'''</span> <span class="main">(</span><span class="bound">B</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b'</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">gpv</span> <span class="main">=</span> bind_gpv <span class="bound">gpv''</span> <span class="bound">f</span> <span class="main">∧</span> <span class="bound">gpv'</span> <span class="main">=</span> bind_gpv <span class="bound">gpv'''</span> <span class="bound">g</span> <span class="main">∧</span> eq_ℐ_gpv <span class="bound">B</span> <span class="free">ℐ</span> <span class="bound">gpv''</span> <span class="bound">gpv'''</span> <span class="main">∧</span> <span class="main">(</span>rel_fun <span class="bound">B</span> <span class="free">X</span><span class="main">)</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="bound">gpv</span><span class="main">)</span> <span class="main">(</span>the_gpv <span class="bound">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gpv''</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gpv''</span> <span class="main">≡</span> Done <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">gpv</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gpv'''</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b'</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gpv'''</span> <span class="main">≡</span> Done <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b'</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a'</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">X</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ</span> <span class="skolem">gpv''</span> <span class="skolem">gpv'''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def g_def gpv''_def gpv'''_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>bind_gpv <span class="skolem">gpv''</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>bind_gpv <span class="skolem">gpv'''</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">gpv''</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">gpv'''</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_gpv.sel spmf_rel_map <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bind_gpv_sel' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bindI <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> rel_spmf_mono<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> eq_ℐ_generat.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> meta_allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> meta_impE<span class="main">)</span>
        <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Done <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono' <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> gpv''_def gpv'''_def f_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'s2</span> <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s1</span> <span class="main">⇒</span> <span class="tfree">'out</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in</span> <span class="main">×</span> <span class="tfree">'s1</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> gpv"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s2</span> <span class="main">⇒</span> <span class="tfree">'out</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'in</span> <span class="main">×</span> <span class="tfree">'s2</span><span class="main">,</span> <span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> gpv"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'out'</span><span class="main">,</span> <span class="tfree">'in'</span><span class="main">)</span> ℐ"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> callee<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s1</span> <span class="bound">s2</span> <span class="bound">q</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">s1</span> <span class="bound">s2</span><span class="main">;</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="main">(</span>rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="free">callee1</span> <span class="bound">s1</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">callee2</span> <span class="bound">s2</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_inline1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv1</span> <span class="free">gpv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_sum <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">S</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">rpv1</span><span class="main">,</span> <span class="bound">rpv2</span><span class="main">)</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">rpv1'</span><span class="main">,</span> <span class="bound">rpv2'</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q''</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span><span class="main">.</span> 
          <span class="main">(</span><span class="main">∀</span><span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ'</span> <span class="bound">q'</span><span class="main">.</span> eq_ℐ_gpv <span class="main">(</span>rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">r'</span><span class="main">.</span> <span class="bound">r'</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q''</span><span class="main">)</span><span class="main">)</span> <span class="free">S</span><span class="main">)</span> <span class="free">ℐ'</span> <span class="main">(</span><span class="bound">rpv1</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv1'</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> 
          <span class="main">(</span><span class="main">∀</span><span class="bound">r'</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q''</span><span class="main">.</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span><span class="bound">rpv2</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">(</span><span class="bound">rpv2'</span> <span class="bound">r'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>inline1 <span class="free">callee1</span> <span class="free">gpv1</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>inline1 <span class="free">callee2</span> <span class="free">gpv2</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv1</span></span> <span class="quoted"><span class="free">gpv2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_fixp_induct_2_2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> partial_function_definitions_spmf partial_function_definitions_spmf inline1.mono inline1.mono inline1_def inline1_def<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> lub_spmf_empty<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> adm bottom step<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> adm <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> bottom <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">inline1'</span> <span class="skolem">inline1''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> step.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">erule</span> eq_ℐ_gpvD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_spmf_bindI<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> eq_ℐ_gpvD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> callee<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_spmf_bindI<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> step.IH<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> callee<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_spmf_bindI<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_inline<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">s1</span> <span class="free">s2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> gpv<span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv1</span> <span class="free">gpv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(</span>rel_prod <span class="free">A</span> <span class="free">S</span><span class="main">)</span> <span class="free">ℐ'</span> <span class="main">(</span>inline <span class="free">callee1</span> <span class="free">gpv1</span> <span class="free">s1</span><span class="main">)</span> <span class="main">(</span>inline <span class="free">callee2</span> <span class="free">gpv2</span> <span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S gpv
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv1</span></span> <span class="quoted"><span class="free">gpv2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_coinduct_bind<span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inline_sel spmf_rel_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_ℐ_gpv_inline1
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> generat.split sum.split <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> disjCI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjI2 rel_funI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rel_spmf_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_left_gpv_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A</span> <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>left_gpv <span class="free">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono eq_ℐ_generat.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_right_gpv_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ'</span> <span class="free">gpv</span> <span class="free">gpv'</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="free">A</span> <span class="main">(</span><span class="free">ℐ</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ'</span><span class="main">)</span> <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>right_gpv <span class="free">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> eq_ℐ_gpvD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_mono eq_ℐ_generat.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpvD_WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span><span class="main">;</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv'</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_iff2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_gpv_ContD eq_ℐ_gpvD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_setD2 set_spmf_parametric<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpvD_results_gpv2<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> results_gpv <span class="free">ℐ</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> results_gpv <span class="free">ℐ</span> <span class="free">gpv</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_spmf_parametric<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span> rel_setD2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_generat_iff2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> results_gpv.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">eq_ℐ_converter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_<span class="keyword1">,</span>_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span><span class="keyword3">/ </span>_ <span class="keyword1">∼</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>100<span class="main">,</span> 0<span class="main">,</span> 99<span class="main">,</span> 99<span class="main">]</span> 99<span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="entity">ℐ'</span> <span class="keyword2"><span class="keyword">where</span></span>
    eq_ℐ_converterI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main"><span class="free">,</span></span> <span class="free">ℐ'</span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>C</sub></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main"><span class="free">∼</span></span> <span class="free"><span class="bound"><span class="entity">conv'</span></span></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟹</span> eq_ℐ_gpv <span class="main">(</span>rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">eq_ℐ_converter</span> <span class="free">ℐ</span> <span class="free">ℐ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="free"><span class="bound"><span class="entity">conv'</span></span></span> <span class="bound">q</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converter_coinduct <span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> eq_ℐ_converter<span class="main">,</span> <span class="operator">coinduct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> eq_ℐ_converter<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">conv</span> <span class="free">conv'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">conv</span> <span class="bound">conv'</span> <span class="bound">q</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">X</span> <span class="bound">conv</span> <span class="bound">conv'</span><span class="main">;</span> <span class="bound">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span>
     <span class="main">⟹</span> eq_ℐ_gpv <span class="main">(</span>rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">conv</span> <span class="bound">conv'</span><span class="main">.</span> <span class="free">X</span> <span class="bound">conv</span> <span class="bound">conv'</span> <span class="main">∨</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="bound">conv</span> <span class="main">∼</span> <span class="bound">conv'</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ'</span>
           <span class="main">(</span>run_converter <span class="bound">conv</span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="bound">conv'</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter.coinduct<span class="main">)</span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converterD<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="main">(</span>rel_prod <span class="main">(</span>eq_onp <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> responses_ℐ <span class="free">ℐ</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eq_ℐ_converter <span class="free">ℐ</span> <span class="free">ℐ'</span><span class="main">)</span><span class="main">)</span> <span class="free">ℐ'</span> <span class="main">(</span>run_converter <span class="free">conv</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span>run_converter <span class="free">conv'</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_converter.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converter_reflI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_reflI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_converterD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_same_args<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converter_sym <span class="main">[</span><span class="operator">sym</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv'</span> <span class="main">∼</span> <span class="free">conv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_ℐ_converterD<span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">⌑</span></span></span></span></span></span> conversep_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span>  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_conversep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_onp_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converter_trans <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span><span class="main">;</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv'</span> <span class="main">∼</span> <span class="free">conv''</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span> <span class="quoted"><span class="free">conv''</span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_ℐ_converterD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_ℐ_gpv_relcompp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_cong<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> fun_cong<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> relcomppI<span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_OO prod.rel_compp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_onp_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1'</span> <span class="main">≤</span> <span class="free">ℐ1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="main">≤</span> <span class="free">ℐ2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1'</span><span class="main">,</span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> *
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>eq_ℐ_converterD  <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> responses_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> le<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> 
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ le<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> outs_ℐ_mono<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> subsetD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> le<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">conv1</span> <span class="main">=</span> <span class="free">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> ℐ_full <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_into_rel_gpv eq_onp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_mono_strong eq_ℐ_gpv_into_rel_gpv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>eq_ℐ_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_attach_on<span class="main">:</span> <span class="comment1">(* TODO: generalise to eq_resource_on *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="free">A</span> UNIV<span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> attach <span class="free">conv</span> <span class="free">res</span> <span class="main">∼</span> attach <span class="free">conv'</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv</span></span> <span class="quoted"><span class="free">conv'</span></span> <span class="quoted"><span class="free">res</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def spmf_rel_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI run_resource.eq_ℐ_exec_gpv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_attach_on'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> attach <span class="free">conv</span> <span class="free">res</span> <span class="main">∼</span> attach <span class="free">conv'</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> eq_ℐ_converter_mono<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on<span class="main">)</span><span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> le_ℐ_def›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_attach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ'</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span><span class="main">;</span> ℐ_full<span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> <span class="free">conv'</span> <span class="main">⟧</span> <span class="main">⟹</span> attach <span class="free">conv</span> <span class="free">res</span> <span class="main">=</span> attach <span class="free">conv'</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_UNIV_D<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_attach_on<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_comp_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv1'</span><span class="main">;</span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">∼</span> <span class="free">conv2'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> comp_converter <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">∼</span> comp_converter <span class="free">conv1'</span> <span class="free">conv2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv1'</span></span> <span class="quoted"><span class="free">conv2'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_gpv_mono'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_ℐ_gpv_inline<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"eq_ℐ_converter <span class="free">ℐ2</span> <span class="free">ℐ3</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_converter_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_converter <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">=</span> comp_converter <span class="free">conv1'</span> <span class="free">conv2'</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> ℐ_full <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">∼</span> <span class="free">conv2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_eq<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_id_id<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_converter2 id_converter id_converter <span class="main">∼</span> id_converter"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_Pause <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_same_args<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converter2_eq_ℐ_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ1'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv1'</span><span class="main">;</span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">∼</span> <span class="free">conv2'</span> <span class="main">⟧</span>
  <span class="main">⟹</span> <span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_converter2 <span class="free">conv1</span> <span class="free">conv2</span> <span class="main">∼</span> parallel_converter2 <span class="free">conv1'</span> <span class="free">conv2'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv1'</span></span> <span class="quoted"><span class="free">conv2'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_left_gpv_cong eq_ℐ_gpv_right_gpv_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> id_converter_eq_self<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> id_converter <span class="main">∼</span> id_converter"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≤</span> <span class="free">ℐ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ order_refl that<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_converter_id<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converterD_WT1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_ℐ_converterD<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD eq_ℐ_gpvD_WT1 WT_converterD_WT WT_converterD_results eq_ℐ_gpvD_results_gpv2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_converterD_WT<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> <span class="free">conv2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span> <span class="main">⟷</span> <span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD_WT1<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD_WT1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_Fail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> Fail Fail"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_gpv.intros<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_restrict_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>restrict_gpv <span class="free">ℐ</span> <span class="free">gpv</span><span class="main">)</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map pmf.rel_map option_rel_Some1 eq_ℐ_generat_iff1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pmf.rel_mono_strong eq_ℐ_generat_mono' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_restrict_converter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> restrict_converter <span class="free">A</span> <span class="free">ℐ'</span> <span class="free">cnv</span> <span class="main">∼</span> <span class="free">cnv</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cnv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">!</span><span class="main">:</span> eq_ℐ_gpv_reflI eq_ℐ_restrict_gpv <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> eq_onp_def <span class="quasi_keyword">dest</span><span class="main">:</span> WT_converterD›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_restrict_gpv_full<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> ℐ_full <span class="main">(</span>restrict_gpv <span class="free">ℐ</span> <span class="free">gpv</span><span class="main">)</span> <span class="main">(</span>restrict_gpv <span class="free">ℐ</span> <span class="free">gpv'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="free">gpv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quoted"><span class="free">gpv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpvD <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pmf.rel_map in_set_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pmf.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split generat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_restrict_converter_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">∼</span> <span class="free">cnv'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict_converter <span class="free">A</span> <span class="free">ℐ'</span> <span class="free">cnv</span> <span class="main">=</span> restrict_converter <span class="free">A</span> <span class="free">ℐ'</span> <span class="free">cnv'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">cnv</span></span> <span class="quoted"><span class="free">cnv'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_into_rel_gpv eq_ℐ_restrict_gpv_full <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_mono' <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_onp_def rel_fun_def gpv.rel_map <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> eq_ℐ_converterD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div><div id="Random_System">
<div class="head">
<h1>Theory Random_System</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Trace equivalence for resources›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Random_System <span class="keyword2"><span class="keyword">imports</span></span> <a href="Converter_Rewrite.html">Converter_Rewrite</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trace_callee</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="tfree">'s</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_callee</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_callee</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> 
   <span class="free">trace_callee</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace_callee_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'s1</span> spmf <span class="main">⇒</span> <span class="tfree">'s2</span> spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_callee_eq</span> <span class="free"><span class="bound"><span class="entity">callee1</span></span></span> <span class="free"><span class="bound"><span class="entity">callee2</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⟷</span> 
  <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> UNIV <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> trace_callee <span class="free"><span class="bound"><span class="entity">callee1</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">xs</span> <span class="bound">x</span> <span class="main">=</span> trace_callee <span class="free"><span class="bound"><span class="entity">callee2</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">xs</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace_callee_eq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="tfree">'s1</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="tfree">'s2</span> <span class="main">⇒</span> bool"</span></span>
  <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword1">'(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">')</span><span class="keyword3">)</span> <span class="keyword1">≈</span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword1">'(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword1">')</span><span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">,</span> 0<span class="main">]</span> 91<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">trace_callee_eq'</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">callee1</span></span></span> <span class="free"><span class="bound"><span class="entity">s1</span></span></span> <span class="free"><span class="bound"><span class="entity">callee2</span></span></span> <span class="free"><span class="bound"><span class="entity">s2</span></span></span> <span class="main">≡</span> trace_callee_eq <span class="free"><span class="bound"><span class="entity">callee1</span></span></span> <span class="free"><span class="bound"><span class="entity">callee2</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>return_spmf <span class="free"><span class="bound"><span class="entity">s1</span></span></span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free"><span class="bound"><span class="entity">s2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> UNIV<span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span>
    <span class="main">⟹</span> trace_callee <span class="free">callee1</span> <span class="free">p</span> <span class="bound">xs</span> <span class="bound">x</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="free">q</span> <span class="bound">xs</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> UNIV"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee1</span> <span class="free">p</span> <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="free">q</span> <span class="free">xs</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cond_spmf_fst_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> return_pmf None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_None <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee</span> <span class="main">(</span>return_pmf None<span class="main">)</span> <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> return_pmf None"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">proposition</span></span> trace'_eqI_sim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">res</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">res</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">res</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> start <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee1</span> <span class="free">p</span> <span class="skolem">xs</span> <span class="skolem">z</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="free">q</span> <span class="skolem">xs</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xs
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xy</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xy</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee1</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">xy</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> 
      trace_callee <span class="free">callee1</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf split_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> set_spmf <span class="skolem">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set_spmf <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> sim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">p</span> <span class="skolem">q</span>›</span></span> _ this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> return_pmf None"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_return_pmf_None<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> step<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="skolem">p</span> <span class="skolem">q</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">THEN</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">set_spmf</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> eq_refl<span class="main">]</span> Cons.prems False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> return_pmf None"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_eq_return_pmf_None<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_eq_return_None<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> trace_callee <span class="free">callee2</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">xy</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trace_callee_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="tfree">'s</span> spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'s</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_callee_aux</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">trace_callee_aux</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">trace_callee_aux</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">res</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="bound">res</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_conv_trace_callee_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee <span class="free">callee</span> <span class="free">p</span> <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> bind_spmf <span class="main">(</span>trace_callee_aux <span class="free">callee</span> <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_aux_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee_aux <span class="free">callee</span> <span class="free">p</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> trace_callee_aux <span class="free">callee</span> <span class="main">(</span>trace_callee_aux <span class="free">callee</span> <span class="free">p</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">trace_callee_closure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'s1</span> spmf <span class="main">⇒</span> <span class="tfree">'s2</span> spmf <span class="main">⇒</span> <span class="tfree">'s1</span> spmf <span class="main">⇒</span> <span class="tfree">'s2</span> spmf <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">callee1</span> <span class="entity">callee2</span> <span class="entity">A</span> <span class="entity">p</span> <span class="entity">q</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">trace_callee_closure</span> <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span> <span class="main">(</span>trace_callee_aux <span class="free">callee1</span> <span class="free">p</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>trace_callee_aux <span class="free">callee2</span> <span class="free">q</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"set <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> UNIV"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_closure_start<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_callee_closure <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_closure.simps exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_closure_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"trace_callee_closure <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p'</span> <span class="free">q'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">×</span> UNIV"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p'</span> <span class="main">=</span> trace_callee_aux <span class="free">callee1</span> <span class="free">p</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> trace_callee_aux <span class="free">callee2</span> <span class="free">q</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> trace_callee_eqD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> xs assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> p q <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_conv_trace_callee_aux<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_closure_sim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_callee_closure <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span> <span class="free">p'</span> <span class="free">q'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"trace_callee_closure <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>
     <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">p'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>
     <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="free">q'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> 
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>trace_callee_closure.simps assms trace_callee_aux_append split_def map_spmf_conv_bind_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>     
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">proposition</span></span> trace_callee_eq_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">S</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>                          
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">s</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="free">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"trace_callee_closure <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trace_callee_closure_start trace_callee_closure_step<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> trace_callee_closure_sim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_spmf_cond_spmf_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"set_spmf <span class="main">(</span>cond_spmf_fst <span class="free">p</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">`</span> <span class="main">(</span>set_spmf <span class="free">p</span> <span class="main">∩</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">×</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_eq_run_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trace_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_callee_eq <span class="free">callee1</span> <span class="free">callee2</span> <span class="free">A</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="free">callee1</span> <span class="free">I1</span> <span class="free">ℐ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="free">callee2</span> <span class="free">I2</span> <span class="free">ℐ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_gpv <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pq<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set_spmf <span class="free">p</span><span class="main">.</span> <span class="free">I1</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set_spmf <span class="free">q</span><span class="main">.</span> <span class="free">I2</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_spmf <span class="free">p</span> <span class="main">(</span>run_gpv <span class="free">callee1</span> <span class="free">gpv</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="free">q</span> <span class="main">(</span>run_gpv <span class="free">callee2</span> <span class="free">gpv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> trace_eq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="free">p</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
      bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">a</span> <span class="bound">s</span> <span class="bound">b</span> <span class="bound">s'</span><span class="main">.</span> <span class="main">⟦</span> <span class="skolem">S</span> <span class="bound">p</span> <span class="bound">q</span><span class="main">;</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> <span class="bound">s</span> <span class="main">∈</span> set_spmf <span class="bound">q</span><span class="main">;</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span>
      <span class="main">⟹</span> <span class="skolem">S</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>bind_spmf <span class="bound">q</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eq_complete<span class="main">)</span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">interpret</span></span> I1<span class="main">:</span> callee_invariant_on <span class="quoted"><span class="free">callee1</span></span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> I2<span class="main">:</span> callee_invariant_on <span class="quoted"><span class="free">callee2</span></span> <span class="quoted"><span class="free">I2</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="free">p</span> <span class="free">q</span>›</span></span> out pq WT I1 I2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">gpv</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_fixp_induct_2_2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> partial_function_definitions_spmf partial_function_definitions_spmf exec_gpv.mono exec_gpv.mono exec_gpv_def exec_gpv_def<span class="main"><span class="main">,</span></span> <span class="operator">case_names</span> adm bottom step<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">exec_gpv'</span> <span class="skolem">g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">generat</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span> <span class="main">⟹</span>
         <span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">generat</span> <span class="keyword1">of</span> 
             Pure <span class="bound">x</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span>
           <span class="main">|</span> IO <span class="bound">out</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="free">callee1</span> <span class="bound">xa</span> <span class="bound">out</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">exec_gpv'</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
         <span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">generat</span> <span class="keyword1">of</span> 
             Pure <span class="bound">x</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span>
           <span class="main">|</span> IO <span class="bound">out</span> <span class="bound">c</span> <span class="main">⇒</span> <span class="free">callee2</span> <span class="bound">xa</span> <span class="bound">out</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">(</span><span class="bound">c</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">generat</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">generat</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">out</span> <span class="skolem">rpv</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"IO <span class="skolem">out</span> <span class="skolem">rpv</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">generat</span> <span class="main">=</span> IO <span class="skolem">out</span> <span class="skolem">rpv</span> <span class="main">⟹</span>
        map_spmf fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">xa</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map_spmf fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">xa</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> map_bind_spmf o_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sim<span class="main">)</span> <span class="main">(</span><span class="operator">use</span> step.prems <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> outs_gpv.IO›</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>IO <span class="skolem">out</span> <span class="skolem">rpv</span> <span class="main">∈</span> set_spmf <span class="main">(</span>the_gpv <span class="skolem">gpv</span><span class="main">)</span><span class="main">;</span> <span class="skolem">generat</span> <span class="main">=</span> IO <span class="skolem">out</span> <span class="skolem">rpv</span><span class="main">;</span> <span class="skolem">x</span> <span class="main">∈</span> set_spmf <span class="skolem">q</span><span class="main">;</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> set_spmf <span class="main">(</span><span class="free">callee2</span> <span class="skolem">x</span> <span class="skolem">out</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
       cond_spmf_fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">callee1</span> <span class="bound">xa</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="skolem">exec_gpv'</span> <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">a</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       cond_spmf_fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">callee2</span> <span class="bound">xa</span> <span class="skolem">out</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf fst <span class="main">(</span><span class="skolem">g</span> <span class="main">(</span><span class="skolem">rpv</span> <span class="skolem">a</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step.IH<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> outs_gpv.IO<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> outs_gpv.Cont <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_calleeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> I2.WT_callee<span class="main"><span class="main">]</span></span> WT_gpvD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> step.prems<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>5<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sim<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="skolem">p</span> <span class="skolem">q</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">out</span></span><span class="main">]</span> step.prems<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_Union <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> outs_gpv.IO <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"set_spmf"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 4
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_Union <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 5
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> WT_calleeD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> I2.WT_callee<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 6
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_Union set_spmf_cond_spmf_fst <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> I1.callee_invariant WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 7
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step.prems <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_UNION image_Union set_spmf_cond_spmf_fst <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> I2.callee_invariant WT_gpvD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> 

      <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf o_def<span class="main">)</span>
          <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_spmf_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"bind_spmf <span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> cond_spmf_fst_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="main"><span class="keyword3">,</span></span> <span class="operator">rewrite</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> bind_spmf <span class="main"><span class="main"><span class="main">⌑</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span>"</span></span></span></span> cond_spmf_fst_inverse<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_spmf_assoc
            <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_const lossless_weight_spmfD step.prems<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_bind_spmf o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> bind_commute_spmf<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_eq'_run_gpv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">callee1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s1</span><span class="main">)</span> callee"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">callee2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'s2</span><span class="main">)</span> callee"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trace_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">callee1</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">≈</span> <span class="free">callee2</span><span class="main">(</span><span class="free">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="free">callee1</span> <span class="free">I1</span> <span class="free">ℐ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> inv1<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="free">callee2</span> <span class="free">I2</span> <span class="free">ℐ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_gpv <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I1</span> <span class="free">s1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> I2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">I2</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run_gpv <span class="free">callee1</span> <span class="free">gpv</span> <span class="free">s1</span> <span class="main">=</span> run_gpv <span class="free">callee2</span> <span class="free">gpv</span> <span class="free">s2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_callee_eq_run_gpv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>6-<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource spmf <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace_eq</span> <span class="main">≡</span> trace_callee_eq run_resource run_resource"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">trace_eq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span><span class="keyword3">/ </span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">≈</span> <span class="keyword3">(</span>_<span class="keyword3">)</span>"</span> <span class="main">[</span>90<span class="main">,</span> 90<span class="main">,</span> 90<span class="main">]</span> 91<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">⊢<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">res'</span></span></span> <span class="main">≡</span> trace_eq <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>return_spmf <span class="free"><span class="bound"><span class="entity">res</span></span></span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="free"><span class="bound"><span class="entity">res'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_resource_of_oracle2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee run_resource <span class="main">(</span>map_spmf <span class="main">(</span>resource_of_oracle <span class="free">callee</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span>
   trace_callee <span class="free">callee</span> <span class="free">p</span> <span class="free">xs</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xy</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xy</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_map_spmf o_def Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span> spmf.map_comp map_prod_vimage<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf bind_map_spmf o_def spmf.map_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_callee_resource_of_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace_callee run_resource <span class="main">(</span>return_spmf <span class="main">(</span>resource_of_oracle <span class="free">callee</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span>
   trace_callee <span class="free">callee</span> <span class="main">(</span>return_spmf <span class="free">s</span><span class="main">)</span> <span class="free">xs</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_callee_resource_of_oracle2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">callee</span></span> <span class="quoted"><span class="quoted">"return_spmf <span class="free">s</span>"</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_eq'_resource_of_oracle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> resource_of_oracle <span class="free">callee1</span> <span class="free">s1</span> <span class="main">≈</span> resource_of_oracle <span class="free">callee2</span> <span class="free">s2</span> <span class="main">=</span>
   <span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">callee1</span><span class="main">(</span><span class="free">s1</span><span class="main">)</span> <span class="main">≈</span> <span class="free">callee2</span><span class="main">(</span><span class="free">s2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trace_callee_eq_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Distinguisher">
<div class="head">
<h1>Theory Distinguisher</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Distinguisher›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Distinguisher <span class="keyword2"><span class="keyword">imports</span></span> <a href="Random_System.html">Random_System</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> gpv"</span></span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span><span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span><span class="main">)</span> distinguisher"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="main">(</span>bool<span class="main">,</span> <span class="tfree"><span class="free">'a</span></span><span class="main">,</span> <span class="tfree"><span class="free">'b</span></span><span class="main">)</span> gpv"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">connect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource <span class="main">⇒</span> bool spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">connect</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span> <span class="main">=</span> run_gpv run_resource <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">res</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">absorb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> distinguisher <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'out</span><span class="main">,</span> <span class="tfree">'in</span><span class="main">)</span> distinguisher"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">absorb</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">=</span> map_gpv fst id <span class="main">(</span>inline run_converter <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> distinguish_attach<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="free">d</span> <span class="main">(</span>attach <span class="free">conv</span> <span class="free">res</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span>absorb <span class="free">d</span> <span class="free">conv</span><span class="main">)</span> <span class="free">res</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">res</span> <span class="main">(</span><span class="bound">conv'</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">.</span> <span class="bound">res</span> <span class="main">=</span> attach <span class="bound">conv'</span> <span class="bound">res'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span>*<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="var">?R</span><span class="main">)</span> <span class="main">(</span>exec_gpv run_resource <span class="free">d</span> <span class="main">(</span>attach <span class="free">conv</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>exec_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">y</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>exec_gpv run_resource <span class="main">(</span>run_converter <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">d</span> <span class="main">(</span><span class="free">conv</span><span class="main">,</span> <span class="free">res</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> exec_gpv_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">res</span> <span class="main">(</span><span class="bound">conv'</span><span class="main">,</span> <span class="bound">res'</span><span class="main">)</span><span class="main">.</span> <span class="bound">res</span> <span class="main">=</span> attach <span class="bound">conv'</span> <span class="bound">res'</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq spmf_rel_map split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_reflI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> connect_def absorb_def exec_gpv_map_gpv_id spmf.map_comp exec_gpv_inline  o_def split_def spmf_rel_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> pmf.map_transfer<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> option.map_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Rb<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="var">?R</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fst_transfer<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> absorb_comp_converter<span class="main">:</span> <span class="quoted"><span class="quoted">"absorb <span class="free">d</span> <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="free">conv'</span><span class="main">)</span> <span class="main">=</span> absorb <span class="main">(</span>absorb <span class="free">d</span> <span class="free">conv</span><span class="main">)</span> <span class="free">conv'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">conv</span> <span class="main">(</span><span class="bound">conv'</span><span class="main">,</span> <span class="bound">conv''</span><span class="main">)</span><span class="main">.</span> <span class="bound">conv</span> <span class="main">=</span> comp_converter <span class="bound">conv'</span> <span class="bound">conv''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span>*<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_gpv <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="var">?R</span><span class="main">)</span> <span class="main">(=)</span> <span class="main">(</span>inline run_converter <span class="free">d</span> <span class="main">(</span>comp_converter <span class="free">conv</span> <span class="free">conv'</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>inline <span class="main">(</span><span class="main">λ</span><span class="bound">p</span> <span class="bound">c2</span><span class="main">.</span> map_gpv <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> id <span class="main">(</span>inline run_converter <span class="main">(</span>run_converter <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="bound">c2</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="free">d</span> <span class="main">(</span><span class="free">conv</span><span class="main">,</span> <span class="free">conv'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inline_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq gpv.rel_map split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> absorb_def inline_map_gpv gpv.map_comp inline_assoc o_def split_def id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> gpv.map_transfer<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> R1b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="var">?R</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fst_transfer id_transfer<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> connect_cong_trace<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">res1</span> <span class="free">res2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> resource"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trace_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res1</span> <span class="main">≈</span> <span class="free">res2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">d</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_gpv <span class="free">ℐ</span> <span class="free">d</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res1</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res2</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"connect <span class="free">d</span> <span class="free">res1</span> <span class="main">=</span> connect <span class="free">d</span> <span class="free">res2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> connect_def <span class="keyword1"><span class="command">using</span></span> trace_eq callee_invariant_run_resource callee_invariant_run_resource WT out WT1 WT2
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> trace_callee_eq'_run_gpv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinguish_trace_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinguish<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">distinguisher</span><span class="main">.</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="bound">distinguisher</span> <span class="main">√</span> <span class="main">⟹</span> connect <span class="bound">distinguisher</span> <span class="free">res</span> <span class="main">=</span> connect <span class="bound">distinguisher</span> <span class="free">res'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res1</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res2</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">≈</span> <span class="free">res'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ</span> <span class="main">×</span> UNIV <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">∧</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res</span><span class="main">)</span> <span class="bound">xs</span> <span class="bound">x</span> <span class="main">≠</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res'</span><span class="main">)</span> <span class="bound">xs</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Ex <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> trace_callee_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> wf_strict_prefix<span class="main">[</span><span class="operator">unfolded</span> wfP_eq_minimal<span class="main">,</span> <span class="operator">THEN</span> spec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Collect <span class="var">?P</span>"</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ</span> <span class="main">×</span> UNIV"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">x</span> <span class="main">≠</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res'</span><span class="main">)</span> <span class="skolem">xs</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> shortest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs'</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> strict_prefix <span class="bound">xs'</span> <span class="skolem">xs</span><span class="main">;</span> set <span class="bound">xs'</span> <span class="main">⊆</span>  outs_ℐ <span class="free">ℐ</span> <span class="main">×</span> UNIV<span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res</span><span class="main">)</span> <span class="bound">xs'</span> <span class="bound">x</span> <span class="main">=</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res'</span><span class="main">)</span> <span class="bound">xs'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> shortest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs'</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> strict_prefix <span class="bound">xs'</span> <span class="skolem">xs</span><span class="main">;</span> <span class="bound">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span> <span class="main">⟧</span>
      <span class="main">⟹</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res</span><span class="main">)</span> <span class="bound">xs'</span> <span class="bound">x</span> <span class="main">=</span> trace_callee run_resource <span class="main">(</span>return_spmf <span class="free">res'</span><span class="main">)</span> <span class="bound">xs'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> shortest<span class="main">)</span><span class="main">(</span><span class="operator">use</span> xs <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> 4 3 <span class="quasi_keyword">dest</span><span class="main">:</span> strict_prefix_setD›</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">≡</span> return_spmf <span class="free">res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≡</span> return_spmf <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def q_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> neq <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>trace_callee run_resource <span class="skolem">p</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">≠</span> spmf <span class="main">(</span>trace_callee run_resource <span class="skolem">q</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spmf_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def q_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>trace_callee run_resource <span class="skolem">p</span> <span class="skolem">ys</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> spmf <span class="main">(</span>trace_callee run_resource <span class="skolem">q</span> <span class="skolem">ys</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"strict_prefix <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ys</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">using</span></span> shortest<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> spmf_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def q_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="main">_</span>"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> rec_list <span class="main">(</span>Pause <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> Done <span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">xs</span> <span class="bound">rec</span><span class="main">.</span> Pause <span class="bound">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">input</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> <span class="bound">rec</span> <span class="keyword1">else</span> Done False<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> d_simps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">[]</span> <span class="main">=</span> Pause <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y'</span><span class="main">.</span> Done <span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">(</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> Pause <span class="skolem">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">input</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">input</span> <span class="main">=</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="skolem">d</span> <span class="skolem">xs</span> <span class="keyword1">else</span> Done False<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> WT_d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="skolem">d</span> <span class="skolem">xs</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xs <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span><span class="main">(</span><span class="operator">use</span> x <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> distinguish<span class="main">[</span><span class="operator">OF</span> WT_d<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>bind_spmf <span class="skolem">p</span> <span class="main">(</span>connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span>bind_spmf <span class="skolem">q</span> <span class="main">(</span>connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def q_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> y eq xs
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> connect_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> map_bind_spmf o_def split_def<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> o_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> spmf_map vimage_def eq_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xy</span> <span class="skolem">xs</span> <span class="skolem">p</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x'</span><span class="main">,</span> <span class="skolem">y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xy</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cond_spmf_fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y'</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="main">(</span>map_spmf fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="keyword1">then</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">b</span> <span class="keyword1">else</span> return_spmf False<span class="main">)</span><span class="main">)</span> True <span class="main">=</span>
      spmf <span class="main">(</span><span class="main">(</span>map_spmf fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> map_spmf <span class="main">(</span>Pair <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>cond_spmf_fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="keyword1">then</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">b</span> <span class="keyword1">else</span> return_spmf False<span class="main">)</span><span class="main">)</span> True"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cond_spmf_fst_inverse
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> connect_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> map_bind_spmf o_def split_def if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> run_gpv <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_weak_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="keyword1">then</span> cond_spmf_fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span>
                          <span class="keyword1">else</span> bind_spmf <span class="main">(</span>cond_spmf_fst <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_spmf False<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span>
      spmf <span class="main">(</span><span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⤜</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="keyword1">then</span> cond_spmf_fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span>
                            <span class="keyword1">else</span> bind_spmf <span class="main">(</span>cond_spmf_fst <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> run_resource <span class="bound">y</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> return_spmf False<span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> nothing <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">rule</span> arg_cong2<span class="main">[</span><span class="operator">where</span> f<span class="main"><span class="main">=</span></span><span class="quoted">spmf</span><span class="main">]</span>›</span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_bind_spmf bind_map_spmf o_def split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bind_spmf_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">a</span><span class="main">|</span>measure_spmf <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="keyword1">then</span> spmf <span class="main">(</span><span class="var">?p</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
      <span class="keyword1">LINT</span> <span class="bound">a</span><span class="main">|</span>measure_spmf <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y'</span> <span class="keyword1">then</span> spmf <span class="main">(</span><span class="var">?q</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> nothing <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">subst</span> spmf_bind›</span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Bochner_Integration.integral_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_spmf_const spmf_scale_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">LINT</span> <span class="bound">a</span><span class="main">|</span>measure_spmf <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> indicator <span class="main">{</span><span class="skolem">y'</span><span class="main">}</span> <span class="bound">a</span> <span class="main">*</span> spmf <span class="main">(</span><span class="var">?p</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span>
      <span class="keyword1">LINT</span> <span class="bound">a</span><span class="main">|</span>measure_spmf <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> indicator <span class="main">{</span><span class="skolem">y'</span><span class="main">}</span> <span class="bound">a</span> <span class="main">*</span> spmf <span class="main">(</span><span class="var">?q</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> box_equals<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> nothing <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">rule</span> Bochner_Integration.integral_cong›</span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y'</span> <span class="main">*</span> spmf <span class="main">(</span><span class="var">?p</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span>
      spmf <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y'</span> <span class="main">*</span> spmf <span class="main">(</span><span class="var">?q</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_conv_measure_spmf<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">]</span> Cons.prems<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="skolem">p</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y'</span> <span class="main">=</span> spmf <span class="main">(</span><span class="skolem">q</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> map_spmf fst <span class="main">(</span>run_resource <span class="bound">s</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span><span class="var">?p</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True <span class="main">=</span> spmf <span class="main">(</span><span class="var">?q</span> <span class="main">⤜</span> connect <span class="main">(</span><span class="skolem">d</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> True"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_fst_def<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_eq_0_set_spmf cond_spmf_def o_def bind_UNION <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>trace_callee run_resource <span class="var">?p</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">≠</span> spmf <span class="main">(</span>trace_callee run_resource <span class="var">?q</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>trace_callee run_resource <span class="var">?p</span> <span class="skolem">ys</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> spmf <span class="main">(</span>trace_callee run_resource <span class="var">?q</span> <span class="skolem">ys</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"strict_prefix <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> outs_ℐ <span class="free">ℐ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ys</span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xy</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> ys x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">⊆</span> outs_ℐ <span class="free">ℐ</span> <span class="main">×</span> UNIV"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> connect_eq_resource_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">distinguisher</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">res</span> <span class="main">∼</span> <span class="free">res'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"connect <span class="free">distinguisher</span> <span class="free">res</span> <span class="main">=</span> connect <span class="free">distinguisher</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> connect_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">fold</span> spmf_rel_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> map_spmf_parametric<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms exec_gpv_eq_resource_on <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_gpv_absorb <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span><span class="main">;</span> <span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">ℐ</span> <span class="keyword1">⊢g</span> absorb <span class="free">gpv</span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> absorb_def run_converter.WT_gpv_inline_invar<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_gpv_absorb <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gpv<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ'</span> <span class="free">gpv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="free">ℐ'</span> <span class="free">ℐ</span> <span class="free">conv</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span> <span class="keyword1">⊢g</span> <span class="free">gpv</span> <span class="main">√</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ</span> <span class="main">(</span>absorb <span class="free">gpv</span> <span class="free">conv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> absorb_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> run_plossless_converter.plossless_inline_invariant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gpv<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> conv <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> plossless_converterD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interaction_any_bounded_by_absorb <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gpv<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="free">gpv</span> <span class="free">bound1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="free">conv</span> <span class="free">bound2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span>absorb <span class="free">gpv</span> <span class="free">conv</span><span class="main">)</span> <span class="main">(</span><span class="free">bound1</span> <span class="main">*</span> <span class="free">bound2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> absorb_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> interaction_bounded_by_map_gpv_id<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> interaction_bounded_by_inline_invariant<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gpv<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> 2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">rule</span> conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> interaction_any_bounded_converter.cases<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Wiring">
<div class="head">
<h1>Theory Wiring</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Wiring›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Wiring <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Distinguisher.html">Distinguisher</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Notation›</span></span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Resumption.Pause Monomorphic_Monad.Pause Monomorphic_Monad.Done

<span class="keyword1"><span class="command">no_notation</span></span> Sublist.parallel <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 50<span class="main">)</span>
<span class="keyword1"><span class="command">no_notation</span></span> plus_oracle <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>"</span> 500<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> Resource <span class="main">(</span><span class="quoted">"<span class="keyword1">§R§</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> Converter <span class="main">(</span><span class="quoted">"<span class="keyword1">§C§</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">alias</span></span> RES <span class="main">=</span> resource_of_oracle
<span class="keyword1"><span class="command">alias</span></span> CNV <span class="main">=</span> converter_of_callee

<span class="keyword1"><span class="command">alias</span></span> id_intercept <span class="main">=</span> <span class="quoted">"id_oracle"</span>
<span class="keyword1"><span class="command">notation</span></span> id_oracle <span class="main">(</span><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>I</sub></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> plus_oracle <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>"</span> 504<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> parallel_oracle <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">‡<span class="hidden">⇩</span><sub>O</sub></span>"</span> 504<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> plus_intercept <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊕<span class="hidden">⇩</span><sub>I</sub></span>"</span> 504<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> parallel_intercept <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">‡<span class="hidden">⇩</span><sub>I</sub></span>"</span> 504<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> parallel_resource <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∥</span>"</span> 501<span class="main">)</span> 

<span class="keyword1"><span class="command">notation</span></span> parallel_converter <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">|<span class="hidden">⇩</span><sub>∝</sub></span>"</span> 501<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> parallel_converter2 <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">|<span class="hidden">⇩</span><sub>=</sub></span>"</span> 501<span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> comp_converter <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊙</span>"</span> 502<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> fail_converter <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥<span class="hidden">⇩</span><sub>C</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">notation</span></span> id_converter <span class="main">(</span><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> <span class="quoted">"attach"</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊳</span>"</span> 500<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Wiring primitives›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">swap_sum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap_sum</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Inr <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">swap_sum</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> Inl <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swap<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">=</span> map_converter swap_sum swap_sum id id <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rassocl<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rassocl<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">=</span> map_converter lsumr rsuml id id <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lassocr<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lassocr<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">=</span> map_converter rsuml lsumr id id <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap_rassocl</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">swap_rassocl</span> <span class="main">≡</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap_lassocr</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">swap_lassocr</span> <span class="main">≡</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span>swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parallel_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'g</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'g</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parallel_wiring</span> <span class="main">=</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">,</span> <span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ1</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_swap_lassocr <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> swap_lassocr <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_lassocr_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_comp WT_lassocr<span class="hidden">⇩</span><sub>C</sub> WT_rassocl<span class="hidden">⇩</span><sub>C</sub> WT_converter_parallel_converter2 WT_converter_id WT_swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_swap_rassocl <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">,</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> swap_rassocl <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_rassocl_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_comp WT_lassocr<span class="hidden">⇩</span><sub>C</sub> WT_rassocl<span class="hidden">⇩</span><sub>C</sub> WT_converter_parallel_converter2 WT_converter_id WT_swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_parallel_wiring <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ3</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_wiring <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring_def 
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_comp WT_lassocr<span class="hidden">⇩</span><sub>C</sub> WT_rassocl<span class="hidden">⇩</span><sub>C</sub> WT_converter_parallel_converter2 WT_converter_id WT_swap_lassocr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_swap_sum_plus_oracle<span class="main">:</span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>id <span class="main">---&gt;</span> swap_sum <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod swap_sum id<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">oracle1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">oracle2</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="free">oracle2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">oracle1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def apfst_def prod.map_comp id_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_ℐ_rsuml_lsumr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ rsuml lsumr <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ℐ_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Set.set_eqI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rsuml.cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ℐ_lsumr_rsuml <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ lsumr rsuml <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ℐ_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Set.set_eqI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsumr.cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_ℐ_swap_sum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_ℐ swap_sum swap_sum <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">=</span> <span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ℐ_eqI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Set.set_eqI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_image<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parallel_resource1_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'e</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parallel_resource1_wiring</span> <span class="main">=</span> swap_lassocr"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> WT_parallel_resource1_wiring <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">,</span> <span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> parallel_resource1_wiring <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_resource1_wiring_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_swap_lassocr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> lassocr<span class="hidden">⇩</span><sub>C</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ1</span><span class="main">)</span> swap<span class="hidden">⇩</span><sub>C</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">coinduction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_swap_lassocr <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> swap_lassocr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_lassocr_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rsuml_lsumr_parallel_converter2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter id id rsuml lsumr <span class="main">(</span><span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span> <span class="main">=</span> 
   map_converter rsuml lsumr id id <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv3</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> left_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> right_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>gpv.map_comp sum.map_id0 o_def prod.map_comp id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_gpv'_map_gpv_swap<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> rsuml_lsumr_left_gpv_left_gpv <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> rsuml_lsumr_left_gpv_right_gpv <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> rsuml_lsumr_right_gpv<span class="main">)</span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span> <span class="main">⊙</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comp_converter_map_converter2<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_right comp_converter_map1_out comp_converter_id_left rsuml_lsumr_parallel_converter2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_lassocr<span class="hidden">⇩</span><sub>C</sub>' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> lsumr_rsuml_parallel_converter2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter id id lsumr rsuml <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
   map_converter lsumr rsuml id id <span class="main">(</span><span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span> <span class="quoted"><span class="free">conv3</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> left_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> right_gpv_map<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>gpv.map_comp sum.map_id0 o_def prod.map_comp id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> map_gpv'_map_gpv_swap<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> lsumr_rsuml_left_gpv <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> lsumr_rsuml_right_gpv_left_gpv <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> lsumr_rsuml_right_gpv_right_gpv<span class="main">)</span>
      <span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_rassocl<span class="hidden">⇩</span><sub>C</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comp_converter_map_converter2<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_right comp_converter_map1_out comp_converter_id_left lsumr_rsuml_parallel_converter2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_rassocl<span class="hidden">⇩</span><sub>C</sub>' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_rassocl<span class="hidden">⇩</span><sub>C</sub><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_sum_right_gpv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_gpv' id swap_sum swap_sum <span class="main">(</span>right_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">=</span> left_gpv <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map generat.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI rel_generat_reflI rel_funI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Fail</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_sum_left_gpv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_gpv' id swap_sum swap_sum <span class="main">(</span>left_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">=</span> right_gpv <span class="free">gpv</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">gpv</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map generat.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI rel_generat_reflI rel_funI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Fail</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> swap_sum_parallel_converter2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_converter id id swap_sum swap_sum <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">=</span>
   map_converter swap_sum swap_sum id id <span class="main">(</span><span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">conv1</span></span> <span class="quoted"><span class="free">conv2</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_gpv_conv_map_gpv'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>
    <span class="main">(</span><span class="operator">subst</span> map_gpv'_map_gpv_swap<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">subst</span> swap_sum_right_gpv <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> swap_sum_left_gpv<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> 
      <span class="operator">auto</span> 4 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> gpv.rel_refl_strong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_map<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_swap<span class="hidden">⇩</span><sub>C</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">⊙</span> swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">=</span> swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">⊙</span> <span class="main">(</span><span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comp_converter_map_converter2<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_right comp_converter_map1_out comp_converter_id_left swap_sum_parallel_converter2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_swap<span class="hidden">⇩</span><sub>C</sub>' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_swap<span class="hidden">⇩</span><sub>C</sub><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_swap_lassocr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span> <span class="main">⊙</span> swap_lassocr <span class="main">=</span> swap_lassocr <span class="main">⊙</span> <span class="main">(</span><span class="free">conv2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv3</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_lassocr_def comp_rassocl<span class="hidden">⇩</span><sub>C</sub>' comp_converter_assoc comp_converter_parallel2' comp_swap<span class="hidden">⇩</span><sub>C</sub>' comp_converter_id_right
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> comp_converter_id_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> comp_converter_parallel2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_assoc comp_lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_swap_lassocr' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_swap_lassocr<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_parallel_wiring<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">C1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">C2</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="free">C3</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">C4</span><span class="main">)</span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">=</span> parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span><span class="free">C1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">C3</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="free">C2</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">C4</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring_def comp_lassocr<span class="hidden">⇩</span><sub>C</sub>' comp_converter_assoc comp_converter_parallel2' comp_swap_lassocr'
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comp_converter_id_right<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> comp_converter_id_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> comp_converter_parallel2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_assoc comp_rassocl<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> comp_parallel_wiring' <span class="main">=</span> comp_converter_eqs<span class="main">[</span><span class="operator">OF</span> comp_parallel_wiring<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_converter_of_resource_conv_parallel_resource<span class="main">:</span>
  <span class="quoted"><span class="quoted">"converter_of_resource <span class="free">res</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res'</span> <span class="main">=</span> <span class="free">res</span> <span class="main">∥</span> <span class="free">res'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_lift_spmf spmf.map_comp o_def prod.map_comp spmf_rel_map bind_map_spmf map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_converter_of_resource_conv_parallel_resource2<span class="main">:</span>
  <span class="quoted"><span class="quoted">" <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="free">res</span> <span class="main">⊳</span> <span class="free">res'</span> <span class="main">=</span> <span class="free">res'</span> <span class="main">∥</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">res'</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def map_lift_spmf spmf.map_comp o_def prod.map_comp spmf_rel_map bind_map_spmf map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_reflI<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> plossless_parallel_wiring <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ3</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ4</span><span class="main">)</span><span class="main">)</span> parallel_wiring"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> run_converter_lassocr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="free">x</span> <span class="main">=</span> Pause <span class="main">(</span>rsuml <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Done <span class="main">(</span>lsumr <span class="bound">x</span><span class="main">,</span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> run_converter_rassocl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="free">x</span> <span class="main">=</span> Pause <span class="main">(</span>lsumr <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Done <span class="main">(</span>rsuml <span class="bound">x</span><span class="main">,</span> rassocl<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> run_converter_swap <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"run_converter swap<span class="hidden">⇩</span><sub>C</sub> <span class="free">x</span> <span class="main">=</span> Pause <span class="main">(</span>swap_sum <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Done <span class="main">(</span>swap_sum <span class="bound">x</span><span class="main">,</span> swap<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def o_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lassocr_swap_sum</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lassocr_swap_sum</span> <span class="main">=</span> rsuml <span class="main">∘</span> map_sum swap_sum id <span class="main">∘</span> lsumr"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> run_converter_swap_lassocr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter swap_lassocr <span class="free">x</span> <span class="main">=</span> Pause <span class="main">(</span>lassocr_swap_sum <span class="free">x</span><span class="main">)</span> <span class="main">(</span>
     <span class="keyword1">case</span> lsumr <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> lsumr <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>lassocr_swap_sum <span class="bound">y</span><span class="main">,</span> swap_lassocr<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span>
          <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> lsumr <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>lassocr_swap_sum <span class="bound">y</span><span class="main">,</span> swap_lassocr<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inline <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
      <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_rpv_def inline_map_gpv split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> swap_lassocr_def o_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sum.case_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lsumr.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def lassocr_swap_sum_def gpv.map_comp fun_eq_iff <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sum.case_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parallel_sum_wiring</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">parallel_sum_wiring</span> <span class="main">=</span> lsumr <span class="main">∘</span> map_sum id lassocr_swap_sum <span class="main">∘</span> rsuml"</span></span>

<span class="comment1">(* TODO: simplify the case distinctions *)</span>
<span class="keyword1"><span class="command">lemma</span></span> run_converter_parallel_wiring<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run_converter parallel_wiring <span class="free">x</span> <span class="main">=</span> Pause <span class="main">(</span>parallel_sum_wiring <span class="free">x</span><span class="main">)</span> <span class="main">(</span>
    <span class="keyword1">case</span> rsuml <span class="free">x</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> rsuml <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>parallel_sum_wiring <span class="bound">y</span><span class="main">,</span> parallel_wiring<span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span>
                <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> lsumr <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> rsuml <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> lsumr <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>parallel_sum_wiring <span class="bound">y</span><span class="main">,</span> parallel_wiring<span class="main">)</span> <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail<span class="main">)</span><span class="main">)</span>
                                          <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">case</span> rsuml <span class="bound">y</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail <span class="main">|</span> Inr <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> lsumr <span class="bound">x</span> <span class="keyword1">of</span> Inl <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Fail <span class="main">|</span> Inr <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done <span class="main">(</span>parallel_sum_wiring <span class="bound">y</span><span class="main">,</span> parallel_wiring<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_wiring_def o_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sum.case_cong <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">subst</span> sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> right_rpv <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
      <span class="operator">subst</span> sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> inline <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
      <span class="operator">subst</span> sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">right_gpv</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inline_map_gpv bind_rpv_def  gpv.map_comp fun_eq_iff parallel_sum_wiring_def 
        parallel_wiring_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sum.case_distrib o_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sym <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sum.case_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum.split<span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bound_lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter lassocr<span class="hidden">⇩</span><sub>C</sub> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter rassocl<span class="hidden">⇩</span><sub>C</sub> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter swap<span class="hidden">⇩</span><sub>C</sub> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_swap_rassocl <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter swap_rassocl <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_rassocl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_swap_lassocr <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter swap_lassocr <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap_lassocr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_parallel_wiring <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter parallel_wiring <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> parallel_wiring_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Characterization of wirings›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ℐ</span> <span class="entity">ℐ'</span> <span class="entity">cnv</span>
  <span class="keyword2"><span class="keyword">where</span></span>
    wiring<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">wiring</span> <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">cnv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">∼</span> map_converter id id <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">√</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> wiringI <span class="main">=</span> wiring
<span class="keyword1"><span class="command">hide_fact</span></span> wiring

<span class="keyword1"><span class="command">lemma</span></span> wiringD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">cnv</span> <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> wiringD_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">∼</span> map_converter id id <span class="free">f</span> <span class="free">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wiringD_WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">cnv</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> wiring_intro <span class="quoted">"introduction rules for wiring"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">apply_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> oracle' <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> oracle'"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply_wiring</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> map_fun id <span class="main">(</span>map_fun <span class="bound">f</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="bound">g</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_wiring_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"apply_wiring <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> map_fun id <span class="main">(</span>map_fun <span class="free">f</span> <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="free">g</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> attach_wiring_resource_of_oracle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wiring<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="free">conv</span> <span class="free">fg</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="keyword1">⊢res</span> RES <span class="free">res</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> outs<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="free">ℐ1</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">conv</span> <span class="main">⊳</span> RES <span class="free">res</span> <span class="free">s</span> <span class="main">=</span> RES <span class="main">(</span>apply_wiring <span class="free">fg</span> <span class="free">res</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wiring
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wiring <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span><span class="free">ℐ2</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">∼</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wiring<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def outs<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> WT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">conv</span> <span class="main">⊳</span> RES <span class="free">res</span> <span class="free">s</span> <span class="main">=</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> RES <span class="free">res</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> RES <span class="main">(</span>apply_wiring <span class="free">fg</span> <span class="free">res</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_map_converter map_resource_resource_of_oracle prod.map_id0 option.map_id0 map_fun_id apply_wiring_def wiring<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wiring_id_converter <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ</span> <span class="free">ℐ</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wiring.intros<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="free">ℐ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="quoted">id</span> <span class="quoted">id</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_ℐ_converter_reflI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_wiring_id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_wiring <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="free">res</span> <span class="main">=</span> <span class="free">res</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_simps prod.map_id0 option.map_id0 map_fun_id<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">attach_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> gpv<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'s</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> gpv<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">attach_wiring</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span> map_fun id <span class="main">(</span>map_fun <span class="bound">f</span> <span class="main">(</span>map_gpv <span class="main">(</span>map_prod <span class="bound">g</span> id<span class="main">)</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> attach_wiring_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"attach_wiring <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> map_fun id <span class="main">(</span>map_fun <span class="free">f</span> <span class="main">(</span>map_gpv <span class="main">(</span>map_prod <span class="free">g</span> id<span class="main">)</span> id<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_wiring_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comp_wiring_converter_of_callee<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wiring<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ1</span> <span class="free">ℐ2</span> <span class="free">conv</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">⊙</span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">∼</span> CNV <span class="main">(</span>attach_wiring <span class="free">w</span> <span class="free">callee</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wiring
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wiring <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wiring<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span><span class="free">ℐ3</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="main">⊙</span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">∼</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> CNV <span class="free">callee</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> CNV <span class="free">callee</span> <span class="free">s</span> <span class="main">=</span> map_converter <span class="skolem">f</span> <span class="skolem">g</span> id id <span class="main">(</span>CNV <span class="free">callee</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> comp_converter_map_converter1<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_id_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> CNV <span class="main">(</span>attach_wiring <span class="free">w</span> <span class="free">callee</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_converter_of_callee attach_wiring_simps wiring<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_gpv_conv_map_gpv'<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comp_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> wiring <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> wiring"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span>"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">comp_wiring</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span><span class="main">,</span> <span class="bound">g'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f'</span> <span class="main">∘</span> <span class="bound">f</span><span class="main">,</span> <span class="bound">g</span> <span class="main">∘</span> <span class="bound">g'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comp_wiring_simps<span class="main">:</span> <span class="quoted"><span class="quoted">"comp_wiring <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span><span class="main">,</span> <span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f'</span> <span class="main">∘</span> <span class="free">f</span><span class="main">,</span> <span class="free">g</span> <span class="main">∘</span> <span class="free">g'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_wiring_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wiring_comp_converterI <span class="main">[</span><span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ</span> <span class="free">ℐ''</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">⊙</span> <span class="free">conv2</span><span class="main">)</span> <span class="main">(</span><span class="free">fg</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">fg'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ</span> <span class="free">ℐ'</span> <span class="free">conv1</span> <span class="free">fg</span>"</span></span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ'</span> <span class="free">ℐ''</span> <span class="free">conv2</span> <span class="free">fg'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> conv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span> <span class="free">ℐ'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fg</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="skolem"><span class="skolem">g'</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> conv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span><span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">∼</span> map_converter id id <span class="skolem">f'</span> <span class="skolem">g'</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ'</span><span class="main">,</span> <span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fg'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f'</span><span class="main">,</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fg</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">fg'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f'</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span> <span class="main">∘</span> <span class="skolem">g'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_wiring_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">⊙</span> <span class="free">conv2</span> <span class="main">∼</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> map_converter id id <span class="skolem">f'</span> <span class="skolem">g'</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conv1 conv2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> map_converter id id <span class="skolem">f'</span> <span class="skolem">g'</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">=</span> map_converter id id <span class="main">(</span><span class="skolem">f'</span> <span class="main">∘</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">∘</span> <span class="skolem">g'</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_map_converter2 comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span><span class="main">,</span><span class="free">ℐ''</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">⊙</span> <span class="free">conv2</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT1 WT2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parallel2_wiring</span>
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> wiring <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a'</span><span class="main">,</span> <span class="tfree">'b'</span><span class="main">,</span> <span class="tfree">'c'</span><span class="main">,</span> <span class="tfree">'d'</span><span class="main">)</span> wiring
   <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'a'</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'b'</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'c'</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'d'</span><span class="main">)</span> wiring"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span>"</span> 501<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parallel2_wiring</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">(</span><span class="bound">f'</span><span class="main">,</span> <span class="bound">g'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map_sum <span class="bound">f</span> <span class="bound">f'</span><span class="main">,</span> map_sum <span class="bound">g</span> <span class="bound">g'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel2_wiring_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"parallel2_wiring <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">f'</span><span class="main">,</span> <span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map_sum <span class="free">f</span> <span class="free">f'</span><span class="main">,</span> map_sum <span class="free">g</span> <span class="free">g'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel2_wiring_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wiring_parallel_converter2 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ1</span> <span class="free">ℐ1'</span> <span class="free">conv1</span> <span class="free">fg</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wiring <span class="free">ℐ2</span> <span class="free">ℐ2'</span> <span class="free">conv2</span> <span class="free">fg'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span><span class="main">)</span> <span class="main">(</span><span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span><span class="main">)</span> <span class="main">(</span><span class="free">fg</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">fg'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">g1</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> conv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span><span class="free">ℐ1'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">∼</span> map_converter id id <span class="skolem">f1</span> <span class="skolem">g1</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span><span class="main">,</span> <span class="free">ℐ1'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fg</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">,</span> <span class="skolem">g1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f2</span></span> <span class="skolem"><span class="skolem">g2</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> conv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span><span class="main">,</span><span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">∼</span> map_converter id id <span class="skolem">f2</span> <span class="skolem">g2</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv2</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fg'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f2</span><span class="main">,</span> <span class="skolem">g2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command">from</span></span> eq_ℐ_converterD_WT1<span class="main">[</span><span class="operator">OF</span> conv1 WT1<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ℐ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="main">≤</span> map_ℐ <span class="skolem">f1</span> <span class="skolem">g1</span> <span class="free">ℐ1'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_map_converter_idD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> eq_ℐ_converterD_WT1<span class="main">[</span><span class="operator">OF</span> conv2 WT2<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ℐ2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ2</span> <span class="main">≤</span> map_ℐ <span class="skolem">f2</span> <span class="skolem">g2</span> <span class="free">ℐ2'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_map_converter_idD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> WT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> map_converter id id <span class="main">(</span>map_sum <span class="skolem">f1</span> <span class="skolem">f2</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g1</span> <span class="skolem">g2</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_converter_map_converter WT_converter_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_converter_id order_refl<span class="main"><span class="main">]</span></span> ℐ1 ℐ2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv1</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv2</span> <span class="main">∼</span> map_converter id id <span class="skolem">f1</span> <span class="skolem">g1</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> map_converter id id <span class="skolem">f2</span> <span class="skolem">g2</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conv1 conv2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_converter id id <span class="skolem">f1</span> <span class="skolem">g1</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> map_converter id id <span class="skolem">f2</span> <span class="skolem">g2</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> map_converter id id <span class="main">(</span>map_sum <span class="skolem">f1</span> <span class="skolem">f2</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g1</span> <span class="skolem">g2</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_map2_out parallel_converter2_map1_out map_sum.comp sum.map_id0 comp_converter_map_converter2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">id</span> <span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">,</span> <span class="free">ℐ1'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2'</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">…</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> map_converter id id <span class="main">(</span>map_sum <span class="skolem">f1</span> <span class="skolem">f2</span><span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g1</span> <span class="skolem">g2</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> parallel_converter2_id_id<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_reflI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> WT1 WT2
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel2_wiring_simps comp_converter_id_left <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wiringI WT_converter_parallel_converter2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_parallel2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"apply_wiring <span class="main">(</span><span class="free">fg</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">fg'</span><span class="main">)</span> <span class="main">(</span><span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>apply_wiring <span class="free">fg</span> <span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> apply_wiring <span class="free">fg'</span> <span class="free">res2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fg</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f1</span><span class="main">,</span> <span class="skolem">g1</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">fg'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f2</span><span class="main">,</span> <span class="skolem">g2</span><span class="main">)</span> <span class="main">⟹</span>
       map_spmf <span class="main">(</span>map_prod <span class="main">(</span>map_sum <span class="skolem">g1</span> <span class="skolem">g2</span><span class="main">)</span> id<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">(</span>map_sum <span class="skolem">f1</span> <span class="skolem">f2</span> <span class="skolem">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod <span class="skolem">g1</span> id<span class="main">)</span> <span class="main">(</span><span class="free">res1</span> <span class="bound">s</span> <span class="main">(</span><span class="skolem">f1</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod <span class="skolem">g2</span> id<span class="main">)</span> <span class="main">(</span><span class="free">res2</span> <span class="bound">s</span> <span class="main">(</span><span class="skolem">f2</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f1</span> <span class="skolem">g1</span> <span class="skolem">f2</span> <span class="skolem">g2</span> <span class="skolem">s</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf.map_comp o_def apfst_def prod.map_comp <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum.splits<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fg</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">fg'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel2_wiring_simps apply_wiring_simps fun_eq_iff map_fun_def o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> apply_comp_wiring <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_wiring <span class="main">(</span><span class="free">fg</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">fg'</span><span class="main">)</span> <span class="free">res</span> <span class="main">=</span> apply_wiring <span class="free">fg</span> <span class="main">(</span>apply_wiring <span class="free">fg'</span> <span class="free">res</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">fg</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">fg'</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_wiring_simps apply_wiring_simps map_fun_def fun_eq_iff spmf.map_comp prod.map_comp o_def id_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lassocr<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">,</span> <span class="tfree">'a</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">)</span> wiring"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lassocr<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">=</span> <span class="main">(</span>rsuml<span class="main">,</span> lsumr<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rassocl<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> wiring"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rassocl<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">=</span> <span class="main">(</span>lsumr<span class="main">,</span> rsuml<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">swap<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'c</span><span class="main">)</span> wiring"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">swap<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">=</span> <span class="main">(</span>swap_sum<span class="main">,</span> swap_sum<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wiring_lassocr <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> lassocr<span class="hidden">⇩</span><sub>C</sub> lassocr<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lassocr<span class="hidden">⇩</span><sub>C</sub>_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wiringI eq_ℐ_converter_reflI WT_converter_map_converter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wiring_rassocl <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ3</span><span class="main">)</span> rassocl<span class="hidden">⇩</span><sub>C</sub> rassocl<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rassocl<span class="hidden">⇩</span><sub>C</sub>_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wiringI eq_ℐ_converter_reflI WT_converter_map_converter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wiring_swap <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">wiring_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ2</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ1</span><span class="main">)</span> swap<span class="hidden">⇩</span><sub>C</sub> swap<span class="hidden">⇩</span><sub>w</sub>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> swap<span class="hidden">⇩</span><sub>C</sub>_def swap<span class="hidden">⇩</span><sub>w</sub>_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wiringI eq_ℐ_converter_reflI WT_converter_map_converter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_lassocr<span class="hidden">⇩</span><sub>w</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_wiring lassocr<span class="hidden">⇩</span><sub>w</sub> <span class="main">(</span><span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res3</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def lassocr<span class="hidden">⇩</span><sub>w</sub>_def map_rsuml_plus_oracle<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_wiring rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="main">(</span><span class="main">(</span><span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res3</span><span class="main">)</span> <span class="main">=</span> <span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def rassocl<span class="hidden">⇩</span><sub>w</sub>_def map_lsumr_plus_oracle<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> apply_swap<span class="hidden">⇩</span><sub>w</sub> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"apply_wiring swap<span class="hidden">⇩</span><sub>w</sub> <span class="main">(</span><span class="free">res1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2</span><span class="main">)</span> <span class="main">=</span> <span class="free">res2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> apply_wiring_def swap<span class="hidden">⇩</span><sub>w</sub>_def map_swap_sum_plus_oracle<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Constructive_Cryptography">
<div class="head">
<h1>Theory Constructive_Cryptography</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Security›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Constructive_Cryptography <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Wiring.html">Wiring</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">advantage</span> <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="free"><span class="bound"><span class="entity">res1</span></span></span> <span class="free"><span class="bound"><span class="entity">res2</span></span></span> <span class="main">=</span> <span class="main">¦</span>spmf <span class="main">(</span>connect <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="free"><span class="bound"><span class="entity">res1</span></span></span><span class="main">)</span> True <span class="main">-</span> spmf <span class="main">(</span>connect <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="free"><span class="bound"><span class="entity">res2</span></span></span><span class="main">)</span> True<span class="main">¦</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructive_security_aux <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_ideal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> enat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lossless</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_real <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">real_resource</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_ideal <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">ideal_resource</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT_sim <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒜</span> <span class="main">::</span> security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher<span class="main">.</span> 
    <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒜</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span> 
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="bound">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> constructive_security <span class="main">=</span>
  constructive_security_aux <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">bound</span></span> <span class="quoted"><span class="free">lossless</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_ideal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> enat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lossless</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> wiring"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span> <span class="main">::</span> security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher<span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> 
  <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>
  <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> constructive_security2 <span class="main">=</span>
  constructive_security_aux <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">bound</span></span> <span class="quoted"><span class="free">lossless</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">real_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ideal_resource</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> resource"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> converter"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_ideal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ℐ_common</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> ℐ"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> enat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">lossless</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> wiring"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span> <span class="main">∧</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> constructive_security<span class="main">:</span>
  <span class="quoted"><span class="quoted">"constructive_security <span class="free">real_resource</span> <span class="free">ideal_resource</span> <span class="free">sim</span> <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="free">bound</span> <span class="free">lossless</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> sim <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> strip exI conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cnv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> restrict_converter <span class="main">(</span><span class="var">?A</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
    advantage <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> w<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">∼</span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong eq_ℐ_restrict_converter <span class="dynamic"><span class="dynamic">WT_intro</span></span> order_refl eq_ℐ_converter_reflI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> inverse'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong<span class="main">)</span><span class="main">(</span><span class="operator">intro</span> eq_ℐ_converter_reflI <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_id_id<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> 
        connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> attach_compose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> comp_converter_parallel2 comp_converter_id_right
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' calculation<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">∼</span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong eq_ℐ_restrict_converter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_converter_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' *<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> advantage_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq1 eq2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span>absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> w<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">η</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">∼</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
      <span class="keyword1"><span class="command">from</span></span> eq_ℐ_restrict_converter_cong<span class="main">[</span><span class="operator">OF</span> eq order_refl<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict_converter <span class="main">(</span><span class="var">?A</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
      restrict_converter <span class="main">(</span><span class="var">?A</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>map_converter <span class="skolem">f</span> <span class="skolem">g</span> id id <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">lossless</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> w<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="skolem">η</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">g</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> cnv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">∼</span> map_converter id id <span class="skolem">f</span> <span class="skolem">g</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
      <span class="keyword1"><span class="command">from</span></span> eq_ℐ_converterD_WT1<span class="main">[</span><span class="operator">OF</span> eq cnv<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> ℐ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="main">≤</span> map_ℐ <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_map_converter_idD<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> WT_converter_id <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> map_ℐ <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main">)</span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>map_ℐ <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_converter_mono<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> plossless_id_converter order_refl ℐ <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq_ℐ_restrict_converter_cong<span class="main">[</span><span class="operator">OF</span> eq order_refl<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_gpv_absorb lossless<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span> plossless_parallel_converter2 plossless_restrict_converter plossless_map_converter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> id WT_converter_map_converter<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> constructive_security <span class="quoted"><span class="free">real_resource</span></span> <span class="quoted"><span class="free">ideal_resource</span></span> <span class="quoted"><span class="free">sim</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_ideal</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">bound</span></span> <span class="quoted"><span class="free">lossless</span></span> <span class="quoted"><span class="free">w</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> constructive_security<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Composition theorems›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> composability<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">middle</span> <span class="free">ideal</span> <span class="free">sim_inner</span> <span class="free">ℐ_middle</span> <span class="free">ℐ_inner</span> <span class="free">ℐ_common</span> <span class="free">bound_inner</span> <span class="free">lossless_inner</span> <span class="free">w1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">real</span> <span class="free">middle</span> <span class="free">sim_outer</span> <span class="free">ℐ_real</span> <span class="free">ℐ_middle</span> <span class="free">ℐ_common</span> <span class="free">bound_outer</span> <span class="free">lossless_outer</span> <span class="free">w2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_converter <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_sim</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bound_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">bound_outer</span> <span class="bound">η</span> <span class="main">*</span> max <span class="main">(</span><span class="free">bound_sim</span> <span class="bound">η</span><span class="main">)</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">bound_inner</span> <span class="bound">η</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> lossless_sim <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless_inner</span> <span class="main">⟹</span> plossless_converter <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">real</span> <span class="free">ideal</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="free">ℐ_real</span> <span class="free">ℐ_inner</span> <span class="free">ℐ_common</span> <span class="free">bound_outer</span> <span class="main">(</span><span class="free">lossless_outer</span> <span class="main">∨</span> <span class="free">lossless_inner</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">w1</span> <span class="bound">η</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> inner<span class="main">:</span> constructive_security <span class="quoted"><span class="free">middle</span></span> <span class="quoted"><span class="free">ideal</span></span> <span class="quoted"><span class="free">sim_inner</span></span> <span class="quoted"><span class="free">ℐ_middle</span></span> <span class="quoted"><span class="free">ℐ_inner</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">bound_inner</span></span> <span class="quoted"><span class="free">lossless_inner</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> outer<span class="main">:</span> constructive_security <span class="quoted"><span class="free">real</span></span> <span class="quoted"><span class="free">middle</span></span> <span class="quoted"><span class="free">sim_outer</span></span> <span class="quoted"><span class="free">ℐ_real</span></span> <span class="quoted"><span class="free">ℐ_middle</span></span> <span class="quoted"><span class="free">ℐ_common</span></span> <span class="quoted"><span class="free">bound_outer</span></span> <span class="quoted"><span class="free">lossless_outer</span></span> <span class="quoted"><span class="free">w2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> <span class="free">real</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> <span class="free">ideal</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_inner</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim_outer</span> <span class="skolem">η</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'g</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'h</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">assume</span></span> bound_outer <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_outer</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">assume</span></span> lossless <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="free">lossless_outer</span> <span class="main">∨</span> <span class="free">lossless_inner</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_middle</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_inner</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span><span class="main">(</span><span class="operator">rule</span> bound_le<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_middle</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless_inner</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim_inner</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">middle</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inner.adv<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> outer.adv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT bound_outer lossless<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>negligible_plus<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim_outer</span> <span class="bound">η</span> <span class="main">⊙</span> <span class="free">sim_inner</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> negligible_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bigo_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> always_eventually<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> order_trans<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> abs_diff_triangle_ineq2<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> add_right_mono<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> comp_converter_parallel2 comp_converter_id_left<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> inner.correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv_inner</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> correct_inner<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span>
             <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_inner</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
             <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless_inner</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_inner</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_inner</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> outer.correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv_outer</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> correct_outer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_middle</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span>
             <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_outer</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
             <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless_outer</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_middle</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
           <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_outer</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_outer</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless_outer</span> <span class="main">∨</span> <span class="free">lossless_inner</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_inner</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="bound">η</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI strip conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'f</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_outer</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless_outer</span> <span class="main">∨</span> <span class="free">lossless_inner</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_inner</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cnv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="skolem">cnv_inner</span> <span class="bound">η</span> <span class="main">⊙</span> <span class="skolem">cnv_outer</span> <span class="bound">η</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_inner</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">using</span></span> bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> bound_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> interaction_bounded_by_mono order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_def<span class="main">)</span>
          <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> linorder_linear more_arith_simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> mult_left_mono zero_le<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> correct_inner<span class="main">[</span><span class="operator">OF</span> WT_D bound' lossless<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_inner</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> adv1<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_inner</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> WT_inner <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_middle</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv_inner</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> fg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">w1</span> <span class="bound">η</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">η</span><span class="main">,</span> <span class="skolem">g</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_middle</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv_inner</span> <span class="bound">η</span> <span class="main">∼</span> map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> w1
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> all_conj_distrib<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> choice_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wiring.cases<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

      <span class="keyword1"><span class="command">from</span></span> w1 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_middle</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv_inner</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒟</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> ℐ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner</span> <span class="skolem">η</span> <span class="main">≤</span> map_ℐ <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_middle</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">using</span></span> eq_ℐ_converterD_WT1<span class="main">[</span><span class="operator">OF</span> eq1 WT_inner<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_map_converter_idD<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> WT_converter_id <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner</span> <span class="skolem">η</span><span class="main">,</span> map_ℐ <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_middle</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> 
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main">)</span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> WT_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_middle</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒟</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_outer</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_left<span class="main">)</span><span class="main">(</span><span class="operator">interaction_bound</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ_inner</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>map_ℐ <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_middle</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> "</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">using</span></span> plossless_id_converter _ ℐ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_converter_mono<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> lossless
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_middle</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless_outer</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_gpv_absorb<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> plossless_parallel_converter2 plossless_map_converter<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> correct_outer<span class="main">[</span><span class="operator">OF</span> WT_D' bound' this<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> w2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_outer</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w2</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> adv2<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">middle</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_outer</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> w2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_middle</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv_outer</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_inner</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="skolem">η</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">using</span></span> w1 w2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wiring_comp_converterI<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> eq1'<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_inner</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">middle</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">middle</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' parallel_converter2_eq_ℐ_cong eq1 eq_ℐ_converter_reflI order_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">have</span></span> eq2'<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv_outer</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊙</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> attach_compose comp_converter_parallel2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' parallel_converter2_eq_ℐ_cong eq1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_ℐ_converter_reflI order_refl<span class="main"><span class="keyword3">|</span></span><span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> negligible_plus<span class="main">[</span><span class="operator">OF</span> adv1 adv2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> advantage_def eq1' eq2' comp_converter_id_right
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> negligible_le<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructive_security<span class="main">)</span> lifting<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_conv <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_converter <span class="main">(</span><span class="free">conv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound_conv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bound_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">bound'</span> <span class="bound">η</span> <span class="main">*</span> max <span class="main">(</span><span class="free">bound_conv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">bound</span> <span class="bound">η</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> plossless_converter <span class="main">(</span><span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">conv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security
     <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="free">sim</span>
     <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common'</span> <span class="free">bound'</span> <span class="free">lossless</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'g</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span> distinguisher"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> WT_𝒜 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword3"><span class="command">assume</span></span> bound_𝒜 <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound'</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword3"><span class="command">assume</span></span> lossless_𝒜 <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ideal<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> comp_converter_parallel2 comp_converter_id_left comp_converter_id_right<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> real<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span><span class="main">(</span><span class="operator">use</span> bound_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> max.commute›</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>absorb <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal real <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> advantage_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> correct'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span>
          <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
          <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
          <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
              negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound'</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI conjI strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'g</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound'</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒟</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> WT_D' <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒟</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound</span><span class="main">(</span><span class="operator">use</span> bound_le<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main"><span class="main">]</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main">:</span> max_def <span class="quasi_keyword">split</span><span class="main">:</span> if_split_asm›</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lossless that <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> correct'<span class="main">[</span><span class="operator">OF</span> WT_D' bound' this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> w1<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> adv'<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> w1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="skolem">η</span> <span class="main">⊳</span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> comp_converter_parallel2 comp_converter_id_left comp_converter_id_right<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> adv'
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">conv</span> <span class="bound">η</span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">theorem</span></span> constructive_security_trivial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">res</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">res</span> <span class="free">res</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="free">ℐ</span> <span class="free">ℐ</span> <span class="free">ℐ_common</span> <span class="free">bound</span> <span class="free">lossless</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' parallel_converter2_id_id<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI strip conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'d</span><span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on' parallel_converter2_id_id order_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> parallel_constructive_security<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">real1</span> <span class="free">ideal1</span> <span class="free">sim1</span> <span class="free">ℐ_real1</span> <span class="free">ℐ_inner1</span> <span class="free">ℐ_common1</span> <span class="free">bound1</span> <span class="free">lossless1</span> <span class="free">w1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="free">real2</span> <span class="free">ideal2</span> <span class="free">sim2</span> <span class="free">ℐ_real2</span> <span class="free">ℐ_inner2</span> <span class="free">ℐ_common2</span> <span class="free">bound2</span> <span class="free">lossless2</span> <span class="free">w2</span>"</span></span>
    <span class="comment1">(* TODO: add symmetric case for lossless1/2 *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_real1 <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless2</span> <span class="main">⟹</span> lossless_resource <span class="main">(</span><span class="free">ℐ_real1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real1</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_sim2 <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless1</span> <span class="main">⟹</span> plossless_converter <span class="main">(</span><span class="free">ℐ_real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_ideal2 <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless1</span> <span class="main">⟹</span> lossless_resource <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">sim1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> min <span class="main">(</span><span class="free">bound1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">lossless1</span> <span class="main">∨</span> <span class="free">lossless2</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">w1</span> <span class="bound">η</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sec1<span class="main">:</span> constructive_security <span class="quoted"><span class="free">real1</span></span> <span class="quoted"><span class="free">ideal1</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">ℐ_real1</span></span> <span class="quoted"><span class="free">ℐ_inner1</span></span> <span class="quoted"><span class="free">ℐ_common1</span></span> <span class="quoted"><span class="free">bound1</span></span> <span class="quoted"><span class="free">lossless1</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec2<span class="main">:</span> constructive_security <span class="quoted"><span class="free">real2</span></span> <span class="quoted"><span class="free">ideal2</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">ℐ_real2</span></span> <span class="quoted"><span class="free">ℐ_inner2</span></span> <span class="quoted"><span class="free">ℐ_common2</span></span> <span class="quoted"><span class="free">bound2</span></span> <span class="quoted"><span class="free">lossless2</span></span> <span class="quoted"><span class="free">w2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢res</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢res</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'g</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'i</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'j</span><span class="main">)</span> distinguisher"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword3"><span class="command">assume</span></span> bound <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span><span class="free">bound1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword3"><span class="command">assume</span></span> lossless <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lossless1</span> <span class="main">∨</span> <span class="free">lossless2</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">real1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     UNIV<span class="main">,</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>
    <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">∼</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> parallel_converter2_eq_ℐ_cong eq_ℐ_converter_reflI WT_converter_parallel_converter2
        WT_converter_id sec2.WT_sim parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_ℐ_converter_reflI WT_parallel_wiring<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span> <span class="main">∼</span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_parallel_wiring
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def attach_compose attach_parallel2 attach_converter_of_resource_conv_parallel_resource
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong parallel_converter2_id_id eq_ℐ_converter_reflI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ideal2<span class="main">:</span>
    <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
     connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_resource_on_trans
          <span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">intro</span> * <span class="main"><span class="keyword3">|</span></span> <span class="operator">intro</span> ** <span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> real2<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_compose attach_converter_of_resource_conv_parallel_resource<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_real2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">lossless2</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> negl2<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span>
     <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal2 real2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec2.adv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> advantage_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ideal1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
     connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span><span class="main">(</span>outs_ℐ <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;+&gt;</span>  outs_ℐ <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> 
      outs_ℐ <span class="main">(</span><span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">,</span><span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>
    <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">∼</span> <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def comp_parallel_wiring' attach_compose attach_parallel2 attach_converter_of_resource_conv_parallel_resource2
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_ℐ_converter_reflI parallel_converter2_eq_ℐ_cong eq_ℐ_converter_mono<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>outs_ℐ <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    <span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span> <span class="main">∼</span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span>  <span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> attach_compose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">intro</span> * <span class="main"><span class="keyword3">|</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def comp_parallel_wiring' attach_compose 
          attach_parallel2 attach_converter_of_resource_conv_parallel_resource2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> *<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> WT
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> **<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> real1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
     connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     UNIV<span class="main">,</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>
      <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">∼</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong WT_converter_parallel_converter2
          parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> eq_ℐ_converter_reflI WT_parallel_wiring<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span> <span class="main">∼</span>
    parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> converter_of_resource <span class="main">(</span><span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"parallel_wiring <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_comp_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def attach_compose attach_converter_of_resource_conv_parallel_resource2 attach_parallel2 
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong parallel_converter2_id_id eq_ℐ_converter_reflI<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> WT
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">fold</span> attach_compose<span class="main">)</span>
        <span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> res'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">intro</span> * ** <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> comp_parallel_wiring <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> eq_ℐ_attach_on <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_attach_on<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">lossless1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> negl1<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> 
     <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal1 real1 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sec1.adv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> advantage_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> negligible_plus<span class="main">[</span><span class="operator">OF</span> negl1 negl2<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">sim1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">sim2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span>
         <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> negligible_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eventuallyI landau_o.big_mono <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> sec1<span class="main">:</span> constructive_security <span class="quoted"><span class="free">real1</span></span> <span class="quoted"><span class="free">ideal1</span></span> <span class="quoted"><span class="free">sim1</span></span> <span class="quoted"><span class="free">ℐ_real1</span></span> <span class="quoted"><span class="free">ℐ_inner1</span></span> <span class="quoted"><span class="free">ℐ_common1</span></span> <span class="quoted"><span class="free">bound1</span></span> <span class="quoted"><span class="free">lossless1</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">interpret</span></span> sec2<span class="main">:</span> constructive_security <span class="quoted"><span class="free">real2</span></span> <span class="quoted"><span class="free">ideal2</span></span> <span class="quoted"><span class="free">sim2</span></span> <span class="quoted"><span class="free">ℐ_real2</span></span> <span class="quoted"><span class="free">ℐ_inner2</span></span> <span class="quoted"><span class="free">ℐ_common2</span></span> <span class="quoted"><span class="free">bound2</span></span> <span class="quoted"><span class="free">lossless2</span></span> <span class="quoted"><span class="free">w2</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> sec1.correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv1</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> correct1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound1</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless1</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> sec2.correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv2</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> correct2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner2</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
      <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless2</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
     <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
         negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv2</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span><span class="free">bound1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless1</span> <span class="main">∨</span> <span class="free">lossless2</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
       <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="bound">η</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
       negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI strip conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'e</span> <span class="main">+</span> <span class="tfree">'k</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'h</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'f</span> <span class="main">+</span> <span class="tfree">'l</span><span class="main">)</span> <span class="main">+</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'j</span><span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span><span class="free">bound1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless1</span> <span class="main">∨</span> <span class="free">lossless2</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="main">(</span><span class="free">ℐ_inner1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cnv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="skolem">cnv1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">cnv2</span> <span class="bound">η</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒟1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒟1</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> bound1<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒟1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒟1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless1</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> correct1<span class="main">[</span><span class="operator">OF</span> WT1 bound1 this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> w1<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> adv1<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒟1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal1</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv1</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> w1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">w1</span> <span class="bound">η</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">η</span><span class="main">,</span> <span class="skolem">g</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner1</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_real1</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv1</span> <span class="bound">η</span> <span class="main">√</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_inner1</span> <span class="bound">η</span><span class="main">,</span> <span class="free">ℐ_real1</span> <span class="bound">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv1</span> <span class="bound">η</span> <span class="main">∼</span> map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">atomize_elim</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fold</span> all_conj_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">subst</span> choice_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wiring.cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> ℐ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="main">≤</span> map_ℐ <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">using</span></span> eq_ℐ_converterD_WT1<span class="main">[</span><span class="operator">OF</span> eq1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_map_converter_idD<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> WT_converter_id order_refl <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner1</span> <span class="skolem">η</span><span class="main">,</span> map_ℐ <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> lossless1 <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_map_converter<span class="main">)</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> order_refl ℐ1 <span class="dynamic"><span class="dynamic">WT_intro</span></span> plossless_converter_mono <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒟2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒟2</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> bound2<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒟2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒟2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless2</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> correct2<span class="main">[</span><span class="operator">OF</span> WT2 bound2 this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> w2<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_inner2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> adv2<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒟2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv2</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> w2 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_inner2</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real2</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv2</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
      connect <span class="main">(</span><span class="var">?𝒟2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span><span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_common1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>
         <span class="var">?cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span> <span class="main">∼</span> 
         <span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">cnv2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on' <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong eq1 eq_ℐ_converter_reflI parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">cnv2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="skolem">η</span> <span class="main">=</span>
        parallel_wiring <span class="main">⊳</span> <span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">∥</span> <span class="main">(</span><span class="skolem">cnv2</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_parallel_wiring' attach_compose attach_parallel2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_D<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_compose attach_converter_of_resource_conv_parallel_resource<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="var">?𝒟2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="var">?𝒟1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="var">?𝒟2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> 
        connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="main">(</span><span class="main">(</span>map_converter id id <span class="main">(</span><span class="skolem">f</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_converter_of_resource_conv_parallel_resource attach_compose attach_parallel2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="main">(</span><span class="main">(</span><span class="skolem">cnv1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="free">real1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> attach_compose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> WT_D
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on' <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_comp_cong eq_ℐ_converter_reflI parallel_converter2_eq_ℐ_cong eq1 <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> connect <span class="main">(</span><span class="var">?𝒟1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv1</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real1</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_converter_of_resource_conv_parallel_resource2 attach_compose attach_parallel2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="var">?𝒟1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal1</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_D<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_converter_of_resource_conv_parallel_resource2 distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_compose <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_inner1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_inner2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real1</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real2</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w1</span> <span class="skolem">η</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w2</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">using</span></span> w1 w2 <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wiring_parallel_converter2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> negligible_plus<span class="main">[</span><span class="operator">OF</span> adv1 adv2<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_wiring <span class="main">⊳</span> <span class="free">ideal1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal2</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_wiring <span class="main">⊳</span> <span class="free">real1</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real2</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> negligible_le<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def * ** ***<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructive_security<span class="main">)</span> parallel_realisation1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> lossless_resource <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_converter2 id_converter <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_common'</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="free">bound</span> <span class="free">lossless</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="free">w</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_constructive_security<span class="main"><span class="main">[</span></span><span class="operator">OF</span> constructive_security_trivial<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lossless<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">False</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> bound<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> WT_res<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ lossless_res<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructive_security<span class="main">)</span> parallel_realisation2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> lossless_resource <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">res</span> <span class="bound">η</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_wiring <span class="main">⊳</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">res</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_converter2 <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span><span class="main">)</span> id_converter<span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_res</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_res</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common'</span> <span class="bound">η</span><span class="main">)</span> <span class="free">bound</span> <span class="free">lossless</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">w</span> <span class="bound">η</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> parallel_constructive_security<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ constructive_security_trivial<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> lossless<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">False</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> bound<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> WT_res<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ lossless_res<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> constructive_security<span class="main">)</span> parallel_resource1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> WT_res <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊢res</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless_res <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> lossless_resource <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"constructive_security <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="free">sim</span> 
    <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="free">bound</span> <span class="free">lossless</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'g</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">+</span> <span class="tfree">'h</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword3"><span class="command">assume</span></span> bound <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword3"><span class="command">assume</span></span> lossless <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>swap_lassocr <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ideal<span class="main">:</span>
    <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
     connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>outs_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_res</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> outs_ℐ <span class="main">(</span><span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>
     UNIV<span class="main">,</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>  <span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">∼</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> "</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 
          <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> parallel_converter2_eq_ℐ_cong eq_ℐ_converter_reflI<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_ℐ <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span>  <span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="skolem">η</span> <span class="main">∼</span>
      swap_lassocr <span class="main">⊙</span> <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">res</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>∝</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊳</span> <span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">ideal_resource</span> <span class="skolem">η</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_resource_on_trans<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> res'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sim</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">⊙</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="skolem">η</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> 
          <span class="operator">rule</span> eq_ℐ_attach_on<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span>  <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_ℐ_comp_cong<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_resource1_wiring_def comp_swap_lassocr attach_compose attach_parallel2 
          attach_converter_of_resource_conv_parallel_resource <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> eq_ℐ_converter_reflI<span class="main">)</span>  

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> WT
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">intro</span> *<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> real<span class="main">:</span>
    <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
     connect <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> distinguish_attach<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_compose attach_converter_of_resource_conv_parallel_resource parallel_resource1_wiring_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">sim</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span>
                        parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span>
                       <span class="main">(</span>parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> advantage_def ideal real <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> adv<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> advantage_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> correct <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cnv</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> correct'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">;</span>
          <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">;</span>
          <span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">⟧</span>
          <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
              negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span>
          <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI conjI strip<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">+</span> <span class="tfree">'g</span> <span class="main">+</span> <span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">+</span> <span class="tfree">'h</span> <span class="main">+</span> <span class="tfree">'f</span><span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_any_bounded_by <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> lossless <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">lossless</span> <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="free">ℐ_res</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒟</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> absorb <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>swap_lassocr <span class="main">⊙</span> parallel_converter <span class="main">(</span>converter_of_resource <span class="main">(</span><span class="free">res</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> WT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="var">?𝒟</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> bound'<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_by <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">bound</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> lossless'<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?𝒟</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="free">lossless</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> correct'<span class="main">[</span><span class="operator">OF</span> WT' bound' lossless'<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="var">?𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> w<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>swap_lassocr <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> swap_lassocr <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> swap_lassocr <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span>
        connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> swap_lassocr <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_D<span class="main"><span class="main">]</span></span><span class="main">)</span>                                                                
          <span class="main">(</span><span class="operator">rule</span> eq_ℐ_attach_on' <span class="dynamic"><span class="dynamic">WT_intro</span></span> parallel_converter2_eq_ℐ_cong eq_ℐ_converter_reflI parallel_converter2_id_id<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>swap_lassocr <span class="main">⊳</span> <span class="free">res</span> <span class="skolem">η</span> <span class="main">∥</span> <span class="main">(</span><span class="skolem">cnv</span> <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> <span class="free">real_resource</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_swap_lassocr' attach_compose attach_parallel2<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> adv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">ideal_resource</span> <span class="bound">η</span><span class="main">)</span>
          <span class="main">(</span><span class="skolem">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="free">res</span> <span class="bound">η</span> <span class="main">∥</span> <span class="free">real_resource</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def distinguish_attach<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_compose attach_converter_of_resource_conv_parallel_resource parallel_resource1_wiring_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="System_Construction">
<div class="head">
<h1>Theory System_Construction</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">theory</span></span> System_Construction <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Constructive_Cryptography.html">../../Constructive_Cryptography</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Random oracle resource›</span></span>

<span class="keyword1"><span class="command">locale</span></span> rorc <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rnd_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'r</span> option<span class="main">,</span> <span class="tfree">'m</span><span class="main">,</span> <span class="tfree">'r</span><span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rnd_oracle</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Some  <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>
  <span class="main">|</span> None      <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span> 
      <span class="bound">r</span> <span class="main">←</span> spmf_of_set <span class="main">(</span><span class="free">range</span><span class="main">)</span><span class="main">;</span> 
      return_spmf <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> Some <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> RES <span class="main">(</span>rnd_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rnd_oracle<span class="main">)</span> Map.empty"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Key resource›</span></span>

<span class="keyword1"><span class="command">locale</span></span> key <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">key_gen</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> spmf"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">key_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> option<span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'k</span><span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">key_oracle</span> None     <span class="main">()</span> <span class="main">=</span>  <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">k</span> <span class="main">←</span> <span class="free">key_gen</span><span class="main">;</span> return_spmf <span class="main">(</span><span class="bound">k</span><span class="main">,</span> Some <span class="bound">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">key_oracle</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">()</span> <span class="main">=</span>  return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> RES <span class="main">(</span>key_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> key_oracle<span class="main">)</span> None"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Channel resource›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> cstate <span class="main">=</span> Void <span class="main">|</span> Fail <span class="main">|</span> Store <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Collect <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> aquery <span class="main">=</span> Look <span class="main">|</span> ForwardOrEdit <span class="main">(</span><span class="free"><span class="entity">forward_or_edit</span></span><span class="main">:</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span><span class="main">)</span> <span class="main">|</span> Drop
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> insec_query <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option aquery"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> auth_query <span class="main">=</span> <span class="quoted"><span class="quoted">"unit aquery"</span></span>

<span class="keyword1"><span class="command">consts</span></span> Forward <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> aquery"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Forward_auth</span> <span class="main">::</span> <span class="quoted">auth_query</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Forward_auth</span> <span class="main">≡</span> ForwardOrEdit <span class="main">()</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Forward_insec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> insec_query"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Forward_insec</span> <span class="main">≡</span> ForwardOrEdit None"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Edit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> insec_query"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Edit</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> ForwardOrEdit <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">adhoc_overloading</span></span> Forward <span class="quoted">Forward_auth</span>
<span class="keyword1"><span class="command">adhoc_overloading</span></span> Forward <span class="quoted">Forward_insec</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="main">(</span>logic<span class="main">)</span> <span class="quoted">"<span class="keyword1">CONST</span> Forward"</span> <span class="main">&lt;=</span> <span class="main">(</span>logic<span class="main">)</span> <span class="quoted">"<span class="keyword1">CONST</span> ForwardOrEdit <span class="main">(</span><span class="keyword1">CONST</span> None<span class="main">)</span>"</span>
  <span class="main">(</span>logic<span class="main">)</span> <span class="quoted">"<span class="keyword1">CONST</span> Forward"</span> <span class="main">&lt;=</span> <span class="main">(</span>logic<span class="main">)</span> <span class="quoted">"<span class="keyword1">CONST</span> ForwardOrEdit <span class="main">(</span><span class="keyword1">CONST</span> Product_Type.Unity<span class="main">)</span>"</span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"auth_query"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"unit aquery"</span>
  <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="tfree"><span class="free">'a</span></span> insec_query"</span> <span class="main">&lt;=</span> <span class="main">(</span>type<span class="main">)</span> <span class="quoted">"<span class="tfree"><span class="free">'a</span></span> option aquery"</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Generic channel›</span></span>

<span class="keyword1"><span class="command">locale</span></span> channel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">side_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> cstate<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> option<span class="main">)</span> oracle'"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">send_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> cstate<span class="main">,</span> <span class="tfree">'m</span><span class="main">,</span> unit<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">send_oracle</span> Void <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">send_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>    <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">recv_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> cstate<span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'m</span> option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">recv_oracle</span> <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">()</span> <span class="main">=</span> return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> Fail<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">recv_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>           <span class="main">()</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">res</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">+</span> <span class="tfree">'m</span> <span class="main">+</span> unit<span class="main">,</span> <span class="tfree">'b</span> option <span class="main">+</span> unit <span class="main">+</span> <span class="tfree">'m</span> option<span class="main">)</span> resource"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">≡</span> RES <span class="main">(</span><span class="free">side_oracle</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> recv_oracle<span class="main">)</span> Void"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Insecure channel›</span></span>

<span class="keyword1"><span class="command">locale</span></span> insec_channel
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insec_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> cstate<span class="main">,</span> <span class="tfree">'m</span> insec_query<span class="main">,</span> <span class="tfree">'m</span> option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insec_oracle</span> Void      <span class="main">(</span>Edit <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>Edit <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Forward   <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Drop      <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Fail<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Look      <span class="main">=</span> return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>         <span class="main"><span class="bound"><span class="entity">_</span></span></span>         <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> channel <span class="quoted">insec_oracle</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Authenticated channel›</span></span>

<span class="keyword1"><span class="command">locale</span></span> auth_channel
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">auth_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span> cstate<span class="main">,</span> auth_query<span class="main">,</span> <span class="tfree">'m</span> option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auth_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Forward <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">auth_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Drop    <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Fail<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">auth_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Look    <span class="main">=</span> return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">auth_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>         <span class="main"><span class="bound"><span class="entity">_</span></span></span>       <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> channel <span class="quoted">auth_oracle</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insec_query_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"auth_query <span class="main">⇒</span> <span class="tfree">'m</span> insec_query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insec_query_of</span> Forward <span class="main">=</span> Forward"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_query_of</span> Drop <span class="main">=</span> Drop"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">insec_query_of</span> Look <span class="main">=</span> Look"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">auth_response_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'mac</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> option <span class="main">⇒</span> <span class="tfree">'m</span> option"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">auth_response_of</span> <span class="main">≡</span> map_option snd"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">insec_auth_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auth_query<span class="main">,</span> <span class="tfree">'m</span> option<span class="main">,</span> <span class="main">(</span><span class="tfree">'mac</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> insec_query<span class="main">,</span> <span class="main">(</span><span class="tfree">'mac</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> option<span class="main">)</span> wiring"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">insec_auth_wiring</span> <span class="main">≡</span> <span class="main">(</span>insec_query_of<span class="main">,</span> auth_response_of<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Secure channel›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sec_channel
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sec_oracle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> list cstate<span class="main">,</span> auth_query<span class="main">,</span> nat option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Forward <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Drop    <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> Fail<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sec_oracle</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> Look    <span class="main">=</span> return_spmf <span class="main">(</span>Some <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sec_oracle</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>         <span class="main"><span class="bound"><span class="entity">_</span></span></span>       <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> channel <span class="quoted">sec_oracle</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">auth_query_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"auth_query <span class="main">⇒</span> auth_query"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">auth_query_of</span> <span class="main">≡</span> id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="entity">sec_response_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list option <span class="main">⇒</span> nat option"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sec_response_of</span> <span class="main">≡</span> map_option length"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">auth_sec_wiring</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auth_query<span class="main">,</span> nat option<span class="main">,</span> auth_query<span class="main">,</span> <span class="tfree">'a</span> list option<span class="main">)</span> wiring"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">auth_sec_wiring</span> <span class="main">≡</span> <span class="main">(</span>auth_query_of<span class="main">,</span> sec_response_of<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cipher converter›</span></span>

<span class="keyword1"><span class="command">locale</span></span> cipher <span class="main">=</span>
  AUTH<span class="main">:</span> auth_channel <span class="main">+</span> KEY<span class="main">:</span> key <span class="quoted"><span class="free">key_alg</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">key_alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> spmf"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">enc_alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'c</span> spmf"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">dec_alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'m</span> option"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> unit<span class="main">,</span> unit <span class="main">+</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'k</span> <span class="main">+</span> unit<span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enc</span> <span class="main">≡</span> CNV <span class="main">(</span>stateless_callee <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">k</span> <span class="main">←</span> Pause <span class="main">(</span>Inl <span class="main">()</span><span class="main">)</span> Done<span class="main">;</span>
    <span class="bound">c</span> <span class="main">←</span> lift_spmf <span class="main">(</span><span class="free">enc_alg</span> <span class="main">(</span>projl <span class="bound">k</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> <span class="tfree">'k</span> <span class="main">+</span> unit<span class="main">)</span> <span class="main">←</span> Pause <span class="main">(</span>Inr <span class="bound">c</span><span class="main">)</span> Done<span class="main">;</span>
    Done <span class="main">(</span><span class="main">()</span><span class="main">)</span> 
  <span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'m</span> option<span class="main">,</span> unit <span class="main">+</span> unit<span class="main">,</span> <span class="tfree">'k</span> <span class="main">+</span> <span class="tfree">'c</span> option<span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="main">≡</span> CNV <span class="main">(</span>stateless_callee <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Pause <span class="main">(</span>Inr <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">c'</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">c'</span> <span class="keyword1">of</span> Inr <span class="main">(</span>Some <span class="bound">c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">k</span> <span class="main">←</span> Pause <span class="main">(</span>Inl <span class="main">()</span><span class="main">)</span> Done<span class="main">;</span>
      Done <span class="main">(</span><span class="free">dec_alg</span> <span class="main">(</span>projl <span class="bound">k</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done None<span class="main">)</span>
  <span class="main">)</span><span class="main">)</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">πE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auth_query<span class="main">,</span> <span class="tfree">'c</span> option<span class="main">,</span> auth_query<span class="main">,</span> <span class="tfree">'c</span> option<span class="main">)</span> converter"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">π<span class="hidden">⇧</span><sup>E</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π<span class="hidden">⇧</span><sup>E</sup></span></span> <span class="main">≡</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">routing</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">⊙</span> swap_lassocr <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> enc <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> dec<span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="main">(</span>KEY.res <span class="main">∥</span> AUTH.res<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> res_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"res <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> enc <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> dec<span class="main">)</span> <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span><span class="main">)</span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="main">(</span>KEY.res <span class="main">∥</span> AUTH.res<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> res_def attach_compose<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Message authentication converter›</span></span>

<span class="keyword1"><span class="command">locale</span></span> macode <span class="main">=</span> 
  INSEC<span class="main">:</span> insec_channel <span class="main">+</span> RO<span class="main">:</span> rorc <span class="quoted"><span class="free">range</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span>   <span class="free">range</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> set"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">mac_alg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'r</span> <span class="main">⇒</span> <span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'a</span> spmf"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'m</span><span class="main">,</span> unit<span class="main">,</span> <span class="tfree">'m</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span><span class="main">,</span> <span class="tfree">'r</span> <span class="main">+</span> unit<span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enm</span> <span class="main">≡</span> CNV <span class="main">(</span><span class="main">λ</span><span class="bound">bs</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">bs</span> 
    <span class="keyword1">then</span> Done <span class="main">(</span><span class="main">()</span><span class="main">,</span> True<span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">r</span> <span class="main">←</span> Pause <span class="main">(</span>Inl <span class="bound">m</span><span class="main">)</span> Done<span class="main">;</span>
      <span class="bound">a</span> <span class="main">←</span> lift_spmf <span class="main">(</span><span class="free">mac_alg</span> <span class="main">(</span>projl <span class="bound">r</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">::</span> <span class="tfree">'r</span> <span class="main">+</span> unit<span class="main">)</span> <span class="main">←</span> Pause <span class="main">(</span>Inr <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> Done<span class="main">;</span>
      Done <span class="main">(</span><span class="main">()</span><span class="main">,</span> True<span class="main">)</span>
    <span class="main">}</span><span class="main">)</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>unit<span class="main">,</span> <span class="tfree">'m</span> option<span class="main">,</span> <span class="tfree">'m</span> <span class="main">+</span> unit<span class="main">,</span> <span class="tfree">'r</span> <span class="main">+</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> option<span class="main">)</span> converter"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dem</span> <span class="main">≡</span> CNV <span class="main">(</span>stateless_callee <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Pause <span class="main">(</span>Inr <span class="main">()</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">am'</span><span class="main">.</span> 
    <span class="keyword1">case</span> <span class="bound">am'</span> <span class="keyword1">of</span> Inr <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">r</span> <span class="main">←</span> Pause <span class="main">(</span>Inl <span class="bound">m</span><span class="main">)</span> Done<span class="main">;</span>
      <span class="bound">a'</span> <span class="main">←</span> lift_spmf <span class="main">(</span><span class="free">mac_alg</span> <span class="main">(</span>projl <span class="bound">r</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>    
      Done <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> Some <span class="bound">m</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">}</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Done None<span class="main">)</span>
  <span class="main">)</span><span class="main">)</span> <span class="main">()</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">πE</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> insec_query<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> option<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> insec_query<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'m</span><span class="main">)</span> option<span class="main">)</span> converter"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">π<span class="hidden">⇧</span><sup>E</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">π<span class="hidden">⇧</span><sup>E</sup></span></span> <span class="main">≡</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">routing</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> lassocr<span class="hidden">⇩</span><sub>C</sub><span class="main">)</span> <span class="main">⊙</span> swap_lassocr <span class="main">⊙</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> swap_lassocr<span class="main">)</span> <span class="main">⊙</span> rassocl<span class="hidden">⇩</span><sub>C</sub>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> enm <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> dem<span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> <span class="main">(</span>RO.res <span class="main">∥</span> INSEC.res<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">lemma</span></span> interface_wiring<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">cnv_advr</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">cnv_send</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">cnv_recv</span><span class="main">)</span> <span class="main">⊳</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring<span class="main">)</span> <span class="main">⊳</span> parallel_resource1_wiring <span class="main">⊳</span> 
  <span class="main">(</span>RES <span class="main">(</span><span class="free">res2_send</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2_recv</span><span class="main">)</span> <span class="free">res2_s</span> <span class="main">∥</span> RES <span class="main">(</span><span class="free">res1_advr</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res1_send</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res1_recv</span><span class="main">)</span> <span class="free">res1_s</span><span class="main">)</span>
  <span class="main">=</span>
  <span class="free">cnv_advr</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">cnv_send</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="free">cnv_recv</span> <span class="main">⊳</span>
  RES <span class="main">(</span><span class="main">†</span><span class="free">res1_advr</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span><span class="free">res2_send</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="free">res1_send</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2_recv</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="free">res1_recv</span><span class="main">)</span> <span class="main">(</span><span class="free">res2_s</span><span class="main">,</span> <span class="free">res1_s</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊳</span> <span class="var">?L1</span> <span class="main">⊳</span> <span class="var">?L2</span> <span class="main">⊳</span> <span class="var">?L3</span> <span class="main">=</span> <span class="main">_</span> <span class="main">⊳</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wiring</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span>  <span class="main">(</span>lassocr<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span><span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>swap<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> lassocr<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span><span class="main">)</span> 
    <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> rassocl<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span><span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>rassocl<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>swap<span class="hidden">⇩</span><sub>w</sub> <span class="keyword1">|<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> lassocr<span class="hidden">⇩</span><sub>w</sub><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">⊳</span> <span class="var">?L2</span> <span class="main">⊳</span> <span class="var">?L3</span> <span class="main">=</span> <span class="var">?L1</span> <span class="main">⊙</span> <span class="var">?L2</span> <span class="main">⊳</span>
    RES <span class="main">(</span><span class="main">(</span><span class="free">res2_send</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="free">res2_recv</span><span class="main">†</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="free">res1_advr</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="free">res1_send</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="free">res1_recv</span><span class="main">)</span> <span class="main">(</span><span class="free">res2_s</span><span class="main">,</span> <span class="free">res1_s</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">⊳</span> RES<span class="main">(</span><span class="var">?O</span><span class="main">)</span> <span class="var">?S</span>"</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> attach_compose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> resource_of_parallel_oracle<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> parallel_oracle_conv_plus_oracle extend_state_oracle_plus_oracle extend_state_oracle2_plus_oracle<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> RES<span class="main">(</span>apply_wiring <span class="var">?wiring</span> <span class="var">?O</span><span class="main">)</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> attach_wiring_resource_of_oracle<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> parallel_wiring_def parallel_resource1_wiring_def swap_lassocr_def<span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">wiring_intro</span></span> WT_resource_of_oracle WT_plus_oracleI WT_callee_full<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"attach"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(* prevent the simplifier from rewriting id and restructuring the equations *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">id'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">id'</span> <span class="main">=</span> id"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="One_Time_Pad">
<div class="head">
<h1>Theory One_Time_Pad</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Security of one-time-pad encryption›</span></span>

<span class="keyword1"><span class="command">theory</span></span> One_Time_Pad <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="System_Construction.html">System_Construction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">≡</span> spmf_of_set <span class="main">(</span>nlists UNIV <span class="free"><span class="bound"><span class="entity">η</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">enc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enc</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> return_spmf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dec</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list option <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> list option <span class="main">×</span> <span class="tfree">'b</span> list option<span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> nat option<span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">lo</span> <span class="main">←</span> Pause <span class="free"><span class="bound"><span class="entity">q</span></span></span> Done<span class="main">;</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lo</span> <span class="keyword1">of</span> 
      Some <span class="bound">n</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> None 
        <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> 
          <span class="bound">x</span> <span class="main">←</span> lift_spmf <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
          Done <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> Some <span class="bound">x</span><span class="main">)</span><span class="main">}</span> 
        <span class="keyword1">else</span> Done <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>
    <span class="main">|</span> None   <span class="main">⇒</span> Done <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">η</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">key_channel_send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list option <span class="main">×</span> bool list  cstate
  <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="main">(</span>unit <span class="main">×</span> bool list option <span class="main">×</span> bool list cstate<span class="main">)</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">key_channel_send</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span>key.key_oracle <span class="main">(</span>key <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">†</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">()</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">←</span> enc <span class="free">η</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">†</span>channel.send_oracle <span class="bound">s</span> <span class="bound">c</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">key_channel_recv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list option <span class="main">×</span> bool list cstate
  <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>bool list option <span class="main">×</span> bool list option <span class="main">×</span> bool list cstate<span class="main">)</span> spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">key_channel_recv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span><span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">c</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">†</span>channel.recv_oracle <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">()</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">c</span> <span class="keyword1">of</span> None <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">s</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">c'</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span>key.key_oracle <span class="main">(</span>key <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">†</span> <span class="bound">s</span> <span class="main">()</span><span class="main">;</span>
      return_spmf <span class="main">(</span>dec <span class="free">η</span> <span class="bound">k</span> <span class="bound">c'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">callee_sec_channel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">callee_sec_channel</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="main">≡</span> lift_state_oracle extend_state_oracle <span class="main">(</span>attach_callee <span class="free"><span class="bound"><span class="entity">callee</span></span></span> sec_channel.sec_oracle<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list option <span class="main">×</span> unit <span class="main">×</span> bool list cstate<span class="main">)</span> spmf <span class="main">⇒</span> 
  <span class="main">(</span>bool list option <span class="main">×</span> bool list cstate<span class="main">)</span> spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span>None<span class="main">,</span> Void<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">key</span><span class="main">,</span> Store <span class="main">(</span><span class="bound">key</span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">plain</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">key</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">key</span><span class="main">,</span> Collect <span class="main">(</span><span class="bound">key</span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">plain</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> Store <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">plain</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">key</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> Collect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">plain</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">key</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">[⊕]</span> <span class="free"><span class="bound"><span class="entity">plain</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">plain</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">key</span> <span class="free">plain</span>


<span class="keyword1"><span class="command">lemma</span></span> resources_indistinguishable<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> nlists UNIV <span class="main">(</span>id' <span class="free">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> 
    RES <span class="main">(</span>callee_sec_channel sim <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle<span class="main">)</span> <span class="main">(</span>None <span class="main">::</span> bool list option<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span> 
    <span class="main">≈</span> 
    RES <span class="main">(</span><span class="main">†</span>auth_channel.auth_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> key_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> key_channel_recv<span class="main">)</span> <span class="main">(</span>None <span class="main">::</span> bool list option<span class="main">,</span> Void<span class="main">)</span>"</span></span> 
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> RES <span class="main">(</span><span class="var">?L1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L3</span><span class="main">)</span> <span class="var">?SL</span> <span class="main">≈</span> RES <span class="main">(</span><span class="var">?R1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R3</span><span class="main">)</span> <span class="var">?SR</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> 
    exec_gpv_bind spmf.map_comp o_def map_bind_spmf bind_map_spmf bind_spmf_const
    sec_channel.sec_oracle.simps auth_channel.auth_oracle.simps
    channel.send_oracle.simps key_channel_send_def
    channel.recv_oracle.simps key_channel_recv_def
    key.key_oracle.simps dec_def key_def enc_def

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?L1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L3</span><span class="main">(</span><span class="var">?SL</span><span class="main">)</span> <span class="main">≈</span> <span class="var">?R1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R3</span><span class="main">(</span><span class="var">?SR</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace'_eqI_sim<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">S</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> Init_OK Output_OK State_OK<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Init_OK
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Output_OK <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">query</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Output_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">adv_query</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Look
        <span class="keyword1"><span class="command">with</span></span> Output_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> Store_State_Channel<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">plain</span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span>*<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">plain</span> <span class="main">=</span> id' <span class="skolem">η</span> <span class="main">⟹</span> 
            map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Inl <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="main">(</span>id' <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Inl <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">[⊕]</span> <span class="skolem">plain</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
            <span class="keyword1"><span class="command">unfolding</span></span> id'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> xor_list_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> one_time_pad<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">plain</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

          <span class="keyword1"><span class="command">from</span></span> Store_State_Channel <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Output_OK<span class="main">(</span>2-<span class="main">)</span> Inl Look
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> spmf.map_comp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Inl <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> o_def<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def id'_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> S.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Snd_Rcv<span class="main">:</span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Output_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">rcv_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Output_OK Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> Collect_State_Channel<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">plain</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Output_OK<span class="main">(</span>2-<span class="main">)</span> Snd_Rcv Inr
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV id'_def<span class="main">)</span>  
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> S.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State_OK <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">query</span> <span class="skolem">state</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> State_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">adv_query</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Look
        <span class="keyword1"><span class="command">with</span></span> State_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> Store_State_Channel<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">plain</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">plain</span> <span class="main">=</span> id' <span class="free">η</span> <span class="main">⟹</span> <span class="skolem">key</span> <span class="main">∈</span> nlists UNIV <span class="free">η</span>  <span class="main">⟹</span> 
            S <span class="main">(</span>cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="bound">x</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="skolem">plain</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="main">(</span>id' <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="skolem">key</span> <span class="main">[⊕]</span> <span class="skolem">plain</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst  <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="bound">x</span> <span class="main">[⊕]</span> <span class="skolem">plain</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">x</span><span class="main">,</span> Store <span class="main">(</span><span class="bound">x</span> <span class="main">[⊕]</span> <span class="skolem">plain</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="skolem">key</span> <span class="main">[⊕]</span> <span class="skolem">plain</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">key</span> 
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">note</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> inj_on_xor_list_nlists<span class="main">,</span> <span class="operator">rotated</span><span class="main">,</span> <span class="operator">simplified</span> xor_list_commute<span class="main">]</span>
            <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def<span class="main">)</span>    
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 5
            <span class="keyword1"><span class="command">note</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> inj_on_xor_list_nlists<span class="main">,</span> <span class="operator">rotated</span><span class="main">,</span> <span class="operator">simplified</span> xor_list_commute<span class="main">]</span>
            <span class="keyword1"><span class="command">with</span></span> 5 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main">)</span>
                <span class="main">(</span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.simps id'_def inj_on_def in_nlists_UNIV <span class="main">)</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def in_nlists_UNIV min_def inj_on_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> Store_State_Channel <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Inl Look
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> * <span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> S.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> S.simps<span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Snd_Rcv<span class="main">:</span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> State_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">rcv_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> State_OK Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> Collect_State_Channel<span class="main">:</span> <span class="main">(</span>3 <span class="skolem">plain</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Snd_Rcv Inr
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.simps in_nlists_UNIV id'_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> bind_spmf_cong_simp<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> S.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> 
          <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> S.simps  in_nlists_UNIV<span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> real_resource_wiring<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cipher.res <span class="main">(</span>key <span class="free">η</span><span class="main">)</span> <span class="main">(</span>enc <span class="free">η</span><span class="main">)</span> <span class="main">(</span>dec <span class="free">η</span><span class="main">)</span> 
    <span class="main">=</span> RES <span class="main">(</span><span class="main">†</span>auth_channel.auth_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> key_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> key_channel_recv<span class="main">)</span> <span class="main">(</span>None<span class="main">,</span> Void<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">including</span></span> lifting_syntax
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">=</span> Rel_def prod.rel_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> split_def split_beta o_def exec_gpv_bind bind_map_spmf 
    resource_of_oracle_rprodl rprodl_extend_state_oracle
    conv_callee_parallel<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> extend_state_oracle_plus_oracle<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>  
    attach_CNV_RES attach_callee_parallel_intercept attach_stateless_callee 

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> channel.res_def cipher.res_def  cipher.routing_def cipher.enc_def cipher.dec_def 
      interface_wiring cipher.πE_def key.res_def key_channel_send_def key_channel_recv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conv_callee_parallel_id_left<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> option.case_cong <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">gpv</span><span class="main">.</span> exec_gpv <span class="main">_</span> <span class="bound">gpv</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> extend_state_oracle_parametric <span class="main">)</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">subst</span> lift_state_oracle_extend_state_oracle<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ideal_resource_wiring<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>CNV <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> channel.res sec_channel.sec_oracle 
    <span class="main">=</span> RES <span class="main">(</span>callee_sec_channel <span class="free">callee</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle <span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">⊳</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?L1</span> <span class="main">∼</span> <span class="var">?L1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">,</span> <span class="var">?I</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">_</span> <span class="main">∼</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong eq_ℐ_converter_reflI WT_converter_ℐ_full ℐ_full_le_plus_ℐ order_refl plus_ℐ_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 

  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="keyword1">⊢c</span> <span class="main">(</span>sec_channel.sec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.recv_oracle<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_plus_oracleI WT_parallel_oracle WT_callee_full<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> split_paired_all<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">⊳</span> RES <span class="main">(</span>sec_channel.sec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.recv_oracle<span class="main">)</span> Void <span class="main">=</span> <span class="var">?R</span>"</span></span>     
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conv_callee_parallel_id_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_CNV_RES 
        attach_callee_parallel_intercept resource_of_oracle_rprodl extend_state_oracle_plus_oracle<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> channel.res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_ℐ_attach<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_resource_of_oracle<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ℐ'</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?conv</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?L1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?conv'</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?L1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_Done1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span> <span class="free">gpv</span> <span class="main">⟷</span> lossless_spmf <span class="main">(</span>the_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set_spmf <span class="main">(</span>the_gpv <span class="free">gpv</span><span class="main">)</span><span class="main">.</span> eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">(</span>Pure <span class="free">x</span><span class="main">)</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_spmf_return_spmf1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_ℐ_gpv_Done2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span> <span class="free">gpv</span> <span class="main">(</span>Done <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> lossless_spmf <span class="main">(</span>the_gpv <span class="free">gpv</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set_spmf <span class="main">(</span>the_gpv <span class="free">gpv</span><span class="main">)</span><span class="main">.</span> eq_ℐ_generat <span class="free">A</span> <span class="free">ℐ</span> <span class="main">(</span>eq_ℐ_gpv <span class="free">A</span> <span class="free">ℐ</span><span class="main">)</span> <span class="bound">a</span> <span class="main">(</span>Pure <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv.intros <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_spmf_return_spmf2 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv.cases<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> CIPHER<span class="main">:</span> cipher <span class="quoted"><span class="quoted">"key <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"enc <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"dec <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">interpretation</span></span> S_CHAN<span class="main">:</span> sec_channel <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> one_time_pad<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">η</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">(</span>nlists UNIV <span class="bound">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"constructive_security2 CIPHER.res <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> S_CHAN.res<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> CNV sim None<span class="main">)</span>
     <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span><span class="main">)</span> False <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> auth_sec_wiring<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_key</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_enc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">(</span>nlists UNIV <span class="bound">η</span><span class="main">)</span> UNIV"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ_dec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i1 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>nlists UNIV <span class="skolem">η</span><span class="main">)</span> UNIV<span class="main">,</span> <span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_enc</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CIPHER.enc <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.enc_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def enc_def in_nlists_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i2 <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ_dec</span> <span class="skolem">η</span><span class="main">,</span> <span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_dec</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CIPHER.dec <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.dec_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def dec_def in_nlists_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">,</span> <span class="main">(</span><span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_enc</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span><span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_dec</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CIPHER.enc <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> CIPHER.dec <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ℐ_common_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>CIPHER.KEY.key_oracle <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> CIPHER.KEY.key_oracle <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>pred_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_key</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.pred_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> i3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="var">?ℐ_key</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> CIPHER.KEY.res <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.KEY.res_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> key<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> WT_auth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢c</span> CIPHER.AUTH.auth_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">η</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x y s' <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CIPHER.AUTH.auth_oracle.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_real_def in_nlists_UNIV <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> imageI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> WT_recv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ_dec</span> <span class="skolem">η</span> <span class="keyword1">⊢c</span> S_CHAN.recv_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> WT_send<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ_enc</span> <span class="skolem">η</span> <span class="keyword1">⊢c</span> S_CHAN.send_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>CIPHER.AUTH.auth_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> S_CHAN.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> S_CHAN.recv_oracle<span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="skolem">η</span><span class="main">)</span>
     <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> CIPHER.AUTH.auth_oracle.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"projr <span class="skolem">x</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_common_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_common_def WT_auth WT_recv <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> i4 <span class="main">[</span><span class="operator">unfolded</span> ℐ_common_def<span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> CIPHER.AUTH.res <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.AUTH.res_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> cipher<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> CIPHER.res <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.res_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> i3<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> secure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> S_CHAN.res <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢c</span> S_CHAN.sec_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">η</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">call</span> <span class="skolem">ret</span> <span class="skolem">s'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">call</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_CHAN.sec_oracle.cases<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_ideal_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢c</span> <span class="main">(</span>S_CHAN.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> S_CHAN.recv_oracle<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> 
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ℐ_common_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_plus_oracleI WT_send WT_recv that<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>S_CHAN.sec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> S_CHAN.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> S_CHAN.recv_oracle<span class="main">)</span> <span class="main">(</span><span class="var">?I</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> S_CHAN.sec_oracle.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"projr <span class="skolem">x</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_common_def in_nlists_UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> S_CHAN.res_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> sim <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV sim <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> None <span class="main">⟶</span> length <span class="main">(</span>the <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sim_def ℐ_ideal_def ℐ_real_def in_nlists_UNIV<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV sim None <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sim<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span>auth_query <span class="main">+</span> bool list <span class="main">+</span> unit<span class="main">,</span> bool list option <span class="main">+</span> unit <span class="main">+</span> bool list option<span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_real</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>CNV sim None <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> S_CHAN.res<span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>CIPHER.res <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
      <span class="keyword1"><span class="command">using</span></span> _ WT
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> connect_cong_trace<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV <span class="main">&lt;+&gt;</span> nlists UNIV <span class="main">(</span>id' <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> CNV sim None <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> S_CHAN.res <span class="main">≈</span> CIPHER.res <span class="skolem">η</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ideal_resource_wiring real_resource_wiring
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> resources_indistinguishable<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"outs_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">⊆</span> UNIV <span class="main">&lt;+&gt;</span> nlists UNIV <span class="main">(</span>id' <span class="skolem">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV"</span></span>
        <span class="keyword1"><span class="command">using</span></span> WT<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">η</span></span><span class="main">,</span> <span class="operator">THEN</span> WT_gpv_outs_gpv<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_real_def ℐ_common_def id'_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> CIPHER.res <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cipher<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> CNV sim None <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> S_CHAN.res <span class="main">√</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> secure <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>CNV sim None <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> S_CHAN.res<span class="main">)</span> <span class="main">(</span>CIPHER.res <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cnv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_converter id id auth_query_of sec_response_of <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> 
      <span class="main">::</span> <span class="main">(</span>auth_query<span class="main">,</span> nat option<span class="main">,</span> auth_query<span class="main">,</span> bool list option<span class="main">)</span> converter"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> map_ℐ id <span class="main">(</span>map_option length<span class="main">)</span> ℐ_full <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WT_converter_id order_refl
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> WT <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_map_converter<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_ideal_def ℐ_real_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_converter_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_converter_id order_refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eq_ℐ_converter_reflI<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="var">?cnv</span> auth_sec_wiring"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> map_converter id <span class="main">(</span>map_option length<span class="main">)</span> id id <span class="main">(</span>CNV sim <span class="skolem">s</span><span class="main">)</span> <span class="main">∼</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≠</span> None <span class="main">⟶</span> length <span class="main">(</span>the <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list option"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_converter_of_callee map_gpv_conv_map_gpv'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eq_ℐ_gpv_Pause <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_ideal_def in_nlists_UNIV eq_ℐ_gpv_Done2 gpv.map_sel eq_onp_same_args sim_def map_gpv_conv_bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> id_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="main">⊙</span> CNV sim None <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> _ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="main">⊙</span> CNV sim None<span class="main">)</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wiring.intros<span class="main">)</span><span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_converter_map_converter1 comp_converter_id_left eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> auth_sec_wiring <span class="main">∧</span>
              wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">⊙</span> CNV sim None<span class="main">)</span> <span class="main">(</span>id<span class="main">,</span> id<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Message_Authentication_Code">
<div class="head">
<h1>Theory Message_Authentication_Code</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Security of message authentication›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Message_Authentication_Code <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="System_Construction.html">System_Construction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rnd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rnd</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">≡</span> nlists UNIV <span class="free"><span class="bound"><span class="entity">η</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mac</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list spmf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mac</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> return_spmf <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vld</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vld</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">≡</span> nlists UNIV <span class="free"><span class="bound"><span class="entity">η</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_mac_query</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> insec_query <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_mac_query</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">(</span>ForwardOrEdit <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> vld <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∈</span> vld <span class="free"><span class="bound"><span class="entity">η</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">valid_mac_query</span> <span class="free"><span class="bound"><span class="entity">η</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> option <span class="main">+</span> unit <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> insec_query 
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> option <span class="main">+</span> unit<span class="main">)</span><span class="main">,</span> auth_query <span class="main">,</span> <span class="tfree">'b</span> list option<span class="main">)</span> gpv"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inr <span class="main">()</span><span class="main">)</span>             <span class="main"><span class="bound"><span class="entity">_</span></span></span>                <span class="main">=</span> Done <span class="main">(</span>None<span class="main">,</span> Inr<span class="main">()</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl None<span class="main">)</span>           <span class="main">(</span>Edit  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main"><span class="bound">_</span></span> <span class="main">←</span> Pause Drop Done<span class="main">;</span> Done <span class="main">(</span>None<span class="main">,</span> Inr <span class="main">()</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>Edit  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> 
    <span class="keyword1">then</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main"><span class="bound">_</span></span> <span class="main">←</span> Pause Forward Done<span class="main">;</span> Done <span class="main">(</span>None<span class="main">,</span> Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="main"><span class="bound">_</span></span> <span class="main">←</span> Pause Drop Done<span class="main">;</span> Done <span class="main">(</span>None<span class="main">,</span> Inr <span class="main">()</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl None<span class="main">)</span>           Forward          <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
    Pause Forward Done<span class="main">;</span>
    Done <span class="main">(</span>None<span class="main">,</span> Inl None<span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span>       Forward          <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
    Pause Forward Done<span class="main">;</span>
    Done <span class="main">(</span>None<span class="main">,</span> Inr <span class="main">()</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl None<span class="main">)</span>           Drop             <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
    Pause Drop Done<span class="main">;</span>
    Done <span class="main">(</span>None<span class="main">,</span> Inl None<span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span>       Drop             <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> 
    Pause Drop Done<span class="main">;</span>
    Done <span class="main">(</span>None<span class="main">,</span> Inr <span class="main">()</span><span class="main">)</span> <span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  Look             <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">lo</span> <span class="main">←</span> Pause Look Done<span class="main">;</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lo</span> <span class="keyword1">of</span>
      Some <span class="bound">m</span> <span class="main">⇒</span> Done <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">,</span> Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> None   <span class="main">⇒</span> Done <span class="main">(</span>None<span class="main">,</span> Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sim</span> <span class="main">(</span>Inl None<span class="main">)</span>           Look             <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">lo</span> <span class="main">←</span> Pause Look Done<span class="main">;</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">lo</span> <span class="keyword1">of</span> 
      Some <span class="bound">m</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">a</span> <span class="main">←</span> lift_spmf <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="main">(</span>length <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        Done <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">,</span> Inl <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
    <span class="main">|</span> None   <span class="main">⇒</span> Done <span class="main">(</span>None<span class="main">,</span> Inl None<span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">η</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rorc_channel_send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>bool <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> cstate<span class="main">,</span> bool list<span class="main">,</span> unit<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rorc_channel_send</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> 
    <span class="keyword1">then</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span>rorc.rnd_oracle <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">†</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
      <span class="bound">a</span> <span class="main">←</span> mac <span class="free">η</span> <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">†</span>channel.send_oracle <span class="bound">s</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span>
    <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rorc_channel_recv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>bool <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> cstate<span class="main">,</span> unit<span class="main">,</span> bool list option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rorc_channel_recv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">()</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">m</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">s</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">←</span> <span class="main">†</span><span class="main">(</span>rorc.rnd_oracle <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">†</span> <span class="bound">s</span> <span class="bound">m</span><span class="main">;</span>
        <span class="bound">a'</span> <span class="main">←</span> mac <span class="free">η</span> <span class="bound">r</span> <span class="bound">m</span><span class="main">;</span>
        return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> Some <span class="bound">m</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">rorc_channel_recv_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> cstate<span class="main">,</span> unit<span class="main">,</span> bool list option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rorc_channel_recv_f</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">am</span><span class="main">,</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">ams</span><span class="main">)</span><span class="main">)</span> <span class="main">←</span>  <span class="main">†</span>channel.recv_oracle <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">()</span><span class="main">;</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">am</span> <span class="keyword1">of</span> 
      None <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">ams</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">as</span> <span class="bound">m</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">a''</span> <span class="main">::</span> bool list <span class="main">←</span> spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span> <span class="main">-</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
          <span class="bound">a'</span>  <span class="main">←</span> spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">;</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span> 
            <span class="keyword1">then</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">as</span><span class="main">(</span><span class="bound">m</span> <span class="main">:=</span> Some <span class="bound">a''</span><span class="main">)</span><span class="main">,</span> <span class="bound">ams</span><span class="main">)</span>
            <span class="keyword1">else</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">as</span><span class="main">(</span><span class="bound">m</span> <span class="main">:=</span> Some <span class="bound">a'</span><span class="main">)</span><span class="main">,</span> <span class="bound">ams</span><span class="main">)</span><span class="main">)</span> <span class="main">}</span>
      <span class="main">|</span> Some <span class="bound">a'</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> Some <span class="bound">m</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">,</span> <span class="bound">ams</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">lazy_channel_send</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">,</span> bool list<span class="main">,</span> unit<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_send</span> <span class="main">(</span>Void<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_send</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>          <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> return_spmf <span class="main">(</span><span class="main">()</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">lazy_channel_recv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">,</span> unit<span class="main">,</span> bool list option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_recv</span> <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>   <span class="main">()</span> <span class="main">=</span> return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_recv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ms</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">()</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">←</span> spmf_of_set <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="keyword1">else</span> None<span class="main">,</span> cstate.Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">:=</span> Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
  <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="keyword1">else</span> None<span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_recv</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>                                 <span class="main">()</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">lazy_channel_insec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">,</span>
   <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> insec_query<span class="main">,</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_insec</span> <span class="main">(</span>Void<span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>       <span class="main">(</span>Edit <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_insec</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>    <span class="main">(</span>Edit <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_insec</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>       Forward         <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_insec</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>       Drop            <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span>Fail<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_insec</span> <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> Look            <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">←</span> spmf_of_set <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">:=</span> Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
  <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_insec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>                   <span class="main"><span class="bound"><span class="entity">_</span></span></span>               <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">lazy_channel_recv_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list  cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">,</span> unit<span class="main">,</span> bool list option<span class="main">)</span> oracle'"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_recv_f</span> <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>   <span class="main">()</span> <span class="main">=</span> return_spmf <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_recv_f</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ms</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">()</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">a</span> <span class="main">←</span> spmf_of_set <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">;</span>
      return_spmf <span class="main">(</span>None<span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">:=</span> Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
  <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="keyword1">else</span> None<span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lazy_channel_recv_f</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>                       <span class="main">()</span> <span class="main">=</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">callee_auth_channel</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">callee_auth_channel</span> <span class="free"><span class="bound"><span class="entity">callee</span></span></span> <span class="main">≡</span> lift_state_oracle extend_state_oracle <span class="main">(</span>attach_callee <span class="free"><span class="bound"><span class="entity">callee</span></span></span> auth_channel.auth_oracle<span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">valid_insecQ</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> insec_query<span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> 
    ForwardOrEdit <span class="main">(</span>Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> length <span class="bound">a</span> <span class="main">=</span> id' <span class="free">η</span> <span class="main">∧</span> length <span class="bound">m</span> <span class="main">=</span> id' <span class="free">η</span> 
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">)</span> spmf
  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>bool <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span>  cstate<span class="main">)</span> spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Void<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="bound">a</span><span class="main">]</span><span class="main">,</span> Store <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="bound">a</span><span class="main">]</span><span class="main">,</span> Collect <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">,</span> Store <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">,</span> Collect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="bound">a</span><span class="main">]</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Collect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> 
     <span class="main">(</span>return_spmf <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">,</span> Collect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">]</span><span class="main">,</span> Collect <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span>"</span></span>  
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> fst <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> snd <span class="bound">x</span><span class="main">]</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span> <span class="main">×</span> nlists UNIV <span class="free">η</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span><span class="main">)</span>
     <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> fst <span class="bound">p</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> snd <span class="bound">p</span><span class="main">)</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="main">(</span>mk_lossless <span class="main">(</span>pair_spmf <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="free"><span class="bound"><span class="entity">spmf_s</span></span></span>"</span></span>


<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> trace_eq_lazy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>valid_insecQ <span class="main">&lt;+&gt;</span> nlists UNIV <span class="main">(</span>id' <span class="free">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> 
    RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span> 
    <span class="main">≈</span> 
    RES <span class="main">(</span><span class="main">†</span><span class="main">†</span>insec_channel.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_recv<span class="main">)</span> <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Void<span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> RES <span class="main">(</span><span class="var">?L1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L3</span><span class="main">)</span> <span class="var">?SL</span> <span class="main">≈</span> RES <span class="main">(</span><span class="var">?R1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R3</span><span class="main">)</span> <span class="var">?SR</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> 
    spmf.map_comp o_def map_bind_spmf bind_map_spmf bind_spmf_const exec_gpv_bind
    insec_channel.insec_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps
    rorc_channel_send_def rorc_channel_recv_def rorc.rnd_oracle.simps mac_def rnd_def

  <span class="keyword1"><span class="command">have</span></span> aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span> <span class="main">×</span> nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">a'</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?aux1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> aux2<span class="main">:</span> <span class="quoted"><span class="quoted">"nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">a'</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?aux2</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">a'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a'</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="free">η</span> <span class="main">=</span> card <span class="main">(</span>nlists <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span> <span class="free">η</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_nlists<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> nlists UNIV <span class="free">η</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">≠</span> <span class="skolem">a'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nlists UNIV <span class="free">η</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fct<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span>nlists <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span> <span class="free">η</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="skolem">a'</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" card <span class="main">{</span><span class="skolem">a'</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> obt<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> obt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> o1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> o2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> nlists <span class="main">(</span>UNIV<span class="main">::</span>bool set<span class="main">)</span> <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> o1 o2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">a'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> nlists UNIV <span class="free">η</span> <span class="main">×</span> nlists UNIV <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?aux1</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">from</span></span> o1 o2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">a'</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> nlists UNIV <span class="free">η</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?aux2</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?L1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L3</span><span class="main">(</span><span class="var">?SL</span><span class="main">)</span> <span class="main">≈</span> <span class="var">?R1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R3</span><span class="main">(</span><span class="var">?SR</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace'_eqI_sim<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">S</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> Init_OK Output_OK State_OK<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Init_OK
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Output_OK <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">query</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Output_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Output_OK<span class="main">(</span>2<span class="main">)</span> Inl
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">adv_query</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> weight_spmf_of_set_finite<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms aux1 aux2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_mk_lossless lossless_spmf_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> aquery.splits option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Snd_Rcv<span class="main">:</span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">snd_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Output_OK Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">m'</span> _ <span class="skolem">as</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Output_OK<span class="main">(</span>2<span class="main">)</span> Snd_Rcv Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">snd_query</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="skolem">snd_query</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Output_OK<span class="main">(</span>2<span class="main">)</span> Snd_Rcv Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> weight_spmf_of_set_finite<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms aux1 aux2<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_mk_lossless lossless_spmf_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">rcv_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Output_OK Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Output_OK<span class="main">(</span>2<span class="main">)</span> Snd_Rcv Inr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Output_OK<span class="main">(</span>2<span class="main">)</span> Snd_Rcv Inr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> weight_spmf_of_set_finite<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms aux1 aux2<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weight_mk_lossless lossless_spmf_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State_OK <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">query</span> <span class="skolem">state</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">adv_query</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Look
        <span class="keyword1"><span class="command">with</span></span> State_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> Store_State_Channel<span class="main">:</span> <span class="main">(</span>2 <span class="skolem">m</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">a</span> <span class="main">∈</span> nlists UNIV <span class="free">η</span> <span class="main">⟹</span> 
          S <span class="main">(</span>cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> Store <span class="skolem">m</span><span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="skolem">m</span> <span class="main">↦</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>cond_spmf_fst <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>True<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="skolem">m</span> <span class="main">↦</span> <span class="bound">x</span><span class="main">]</span><span class="main">,</span> Store <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> 
          <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> cond_spmf_fst_map_Pair1<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 4
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2 3<span class="main"><span class="main">)</span></span> inv_into_f_f<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def<span class="main">)</span>
                <span class="main">(</span><span class="operator">rule</span> S.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Store_State_Channel in_nlists_UNIV id'_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def inj_on_def<span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> Store_State_Channel <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK Inl Look
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 

        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ForwardOrEdit <span class="skolem">foe</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> State_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">foe</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">am'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">am'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">am'</span></span><span class="main">)</span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> State_OK Inl ForwardOrEdit Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span>S.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> S.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Drop
        <span class="keyword1"><span class="command">with</span></span> State_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Snd_Rcv<span class="main">:</span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">snd_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> State_OK Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">with</span></span> State_OK Snd_Rcv Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
              <span class="main">(</span><span class="operator">rule</span> S.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> State_OK Snd_Rcv Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
              <span class="main">(</span><span class="operator">rule</span> S.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">m'</span> <span class="skolem">spmf_s</span> <span class="skolem">as</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> State_OK Snd_Rcv Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span>
              <span class="main">(</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> id'_def in_nlists_UNIV<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">rcv_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> State_OK Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Snd_Rcv Inr
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_def 
                cond_spmf_fst_def vimage_def aux1 aux2 assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>S.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">m</span> <span class="skolem">a</span> <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Snd_Rcv Inr
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def 
                vimage_def aux1 aux2 assms <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>S.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">a'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">with</span></span> 10 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Snd_Rcv Inr
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> cond_spmf_fst_def 
                  vimage_def aux1 aux2 assms <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> if_split <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>S.intros<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a'</span> <span class="main">∈</span> nlists UNIV <span class="free">η</span> <span class="main">⟹</span> nlists <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span> <span class="free">η</span> <span class="main">×</span> nlists UNIV <span class="free">η</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">=</span> <span class="skolem">a'</span><span class="main">}</span> <span class="main">=</span> nlists UNIV <span class="free">η</span> <span class="main">×</span> <span class="main">{</span><span class="skolem">a'</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">from</span></span> 10 False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Snd_Rcv Inr
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf<span class="main">)</span>
                <span class="main">(</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bind_bind_conv_pair_spmf split_def image_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                    cond_spmf_fst_def vimage_def cond_spmf_spmf_of_set pair_spmf_of_set <span class="main">)</span>
                  <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pair_spmf_of_set<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> spmf_of_set_singleton pair_spmf_return_spmf2 
                    map_spmf_of_set_inj_on<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_spmf_of_set_inj_on <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S.intros<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> game_difference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≡</span> ℐ_uniform <span class="main">(</span>Set.Collect <span class="main">(</span>valid_mac_query <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="free">η</span> <span class="main">×</span> nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
     <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> vld <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_bounded_by' <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free">𝒜</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ</span> <span class="free">𝒜</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¦</span>spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> 
    spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¦</span> 
    <span class="main">≤</span> <span class="free">q</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">η</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lazy_channel_insec'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_insec'</span> <span class="main">=</span> <span class="main">(</span><span class="main">†</span>lazy_channel_insec <span class="main">::</span> <span class="main">(</span>bool <span class="main">×</span> bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">,</span>
   <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> insec_query<span class="main">,</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option<span class="main">)</span> oracle'<span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lazy_channel_send'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_send'</span> <span class="main">=</span> <span class="main">(</span><span class="main">†</span>lazy_channel_send <span class="main">::</span> <span class="main">(</span>bool <span class="main">×</span> bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">,</span>
    bool list<span class="main">,</span> unit<span class="main">)</span> oracle'<span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lazy_channel_recv'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_recv'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span> <span class="main">::</span> bool <span class="main">×</span> bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">q</span> <span class="main">::</span> unit<span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">s</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> Collect <span class="bound">m</span><span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Some <span class="bound">m</span><span class="main">,</span> <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> <span class="bound">ms</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">as</span> <span class="bound">m'</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">a</span> <span class="main">←</span> spmf_of_set <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">;</span>
          return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span> <span class="keyword1">then</span> Some <span class="bound">m'</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">flg</span> <span class="main">∨</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span> <span class="main">(</span><span class="bound">m'</span> <span class="main">:=</span> Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
      <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span> <span class="keyword1">then</span> Some <span class="bound">m'</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">flg</span><span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lazy_channel_recv_f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_recv_f'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span> <span class="main">::</span> bool <span class="main">×</span> bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">q</span> <span class="main">::</span> unit<span class="main">)</span><span class="main">.</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">s</span> <span class="keyword1">of</span>
      <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> Collect <span class="bound">m</span><span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>Some <span class="bound">m</span><span class="main">,</span> <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> <span class="bound">ms</span><span class="main">,</span> Some <span class="main">(</span><span class="bound">a'</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">as</span> <span class="bound">m'</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">a</span> <span class="main">←</span> spmf_of_set <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">;</span>
          return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">flg</span> <span class="main">∨</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span><span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span> <span class="main">(</span><span class="bound">m'</span> <span class="main">:=</span> Some <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>
      <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a'</span> <span class="keyword1">then</span> Some <span class="bound">m'</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">flg</span><span class="main">,</span> Fail<span class="main">,</span> None<span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">game</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">game</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">𝒜</span> <span class="main">::</span> <span class="main">(</span><span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> insec_query <span class="main">+</span> bool list <span class="main">+</span> unit<span class="main">,</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">+</span> unit <span class="main">+</span> bool list option<span class="main">)</span> distinguisher<span class="main">)</span> <span class="bound">recv_oracle</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="main">(</span><span class="bound">b</span> <span class="main">::</span> bool<span class="main">,</span> <span class="main">(</span><span class="bound">flg</span><span class="main">,</span> <span class="bound">ams</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span><span class="main">←</span> <span class="main">(</span>exec_gpv <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="bound">recv_oracle</span><span class="main">)</span> <span class="bound">𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">;</span>
    return_spmf <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">flg</span><span class="main">)</span> <span class="main">}</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact1<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True  
    <span class="main">=</span> spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_lft</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_rgt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>lazy_channel_insec <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">flg</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def spmf_rel_map rel_prod_sel split_def option.rel_refl pmf.rel_refl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>lazy_channel_send <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lazy_channel_send'</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">flg</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ams</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf split_def lazy_channel_send'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> 

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span><span class="main">)</span>  
      <span class="main">(</span>lazy_channel_recv_f <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lazy_channel_recv_f'</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">flg</span> <span class="skolem">q</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ams</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lazy_channel_recv_f'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">am</span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">am</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">am</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f'_def rel_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f<span class="main">)</span> <span class="main">(</span><span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">query</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">query</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">flg</span> <span class="skolem">ams</span> <span class="skolem">es</span> <span class="skolem">as</span> <span class="skolem">query</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apfst_def map_prod_def split_beta<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Snd_Rcv <span class="main">=</span> this
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split_beta<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> fst <span class="bound">y</span><span class="main">)</span>
     <span class="main">(</span>exec_gpv <span class="var">?orc_lft</span> <span class="free">𝒜</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="var">?orc_rgt</span> <span class="free">𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI 
          exec_gpv_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> map_spmf_conv_bind_spmf exec_gpv_resource_of_oracle connect_def spmf_conv_measure_spmf
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_pred_def spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_eq split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True <span class="main">-</span> 
    spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv'</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¦</span> 
    <span class="main">≤</span> Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>spmf <span class="var">?L</span> <span class="main">_</span> <span class="main">-</span> spmf <span class="var">?R</span> <span class="main">_</span> <span class="main">¦</span> <span class="main">≤</span> <span class="main">_</span> "</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_lft</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span>"</span></span> 
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_rgt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv'</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="skolem">lazy_channel_insec'</span> fst <span class="main">(</span>ℐ_uniform <span class="main">(</span>Set.Collect <span class="main">(</span>valid_mac_query <span class="free">η</span><span class="main">)</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">state</span> <span class="skolem">query</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">state</span><span class="main">)</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf split_def lazy_channel_insec'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="skolem">lazy_channel_send'</span> fst <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> UNIV<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">state</span> <span class="skolem">query</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">state</span><span class="main">)</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf split_def lazy_channel_send'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant <span class="skolem">lazy_channel_recv'</span> fst"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">state</span> <span class="skolem">query</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">state</span><span class="main">)</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant <span class="skolem">lazy_channel_recv_f'</span> fst"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">state</span> <span class="skolem">query</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">state</span><span class="main">)</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span>lazy_channel_insec <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="skolem">lazy_channel_send'</span> <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_send'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="skolem">lazy_channel_recv'</span> <span class="skolem">s</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv'_def rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split cstate.split option.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lossless_spmf <span class="main">(</span><span class="skolem">lazy_channel_recv_f'</span> <span class="skolem">s</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f'_def rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split cstate.split option.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">s1'</span><span class="main">)</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">s2'</span> <span class="main">⟶</span> fst <span class="bound">s1'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> fst <span class="bound">s2'</span> <span class="main">⟶</span> <span class="main">¬</span> fst <span class="bound">s1'</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">b</span> <span class="main">∧</span> <span class="bound">s1'</span> <span class="main">=</span> <span class="bound">s2'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="var">?orc_lft</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">query</span><span class="main">)</span> <span class="main">(</span><span class="var">?orc_rgt</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">query</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">flg</span> <span class="skolem">ams</span> <span class="skolem">es</span> <span class="skolem">as</span> <span class="skolem">query</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Snd_Rcv <span class="main">=</span> this  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">snd_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">rcv_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">es</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">am'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">am'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">am'</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Snd_Rcv Some Inr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf 
                lazy_channel_recv'_def lazy_channel_recv_f'_def rel_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv'_def lazy_channel_recv_f'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ℐ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>Set.Collect <span class="main">(</span>valid_mac_query <span class="free">η</span><span class="main">)</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?𝒜</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mk_lossless_gpv <span class="main">(</span>responses_ℐ <span class="free">ℐ</span><span class="main">)</span> True <span class="free">𝒜</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="var">?ℐ</span> <span class="var">?𝒜</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lossless WT
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_gpv_mk_lossless_gpv<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span> <span class="keyword1">⊢g</span> <span class="var">?𝒜</span> <span class="main">√</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> WT <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_gpv_mk_lossless_gpv<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> fst <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>fst <span class="bound">x</span> <span class="main">⟷</span> fst <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>exec_gpv <span class="var">?orc_lft</span> <span class="var">?𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="var">?orc_rgt</span> <span class="var">?𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exec_gpv_oracle_bisim_bad_plossless<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span>
            X_bad<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?bad1.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?bad2.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ℐ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?ℐ</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_spmf_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">,</span> <span class="bound">s3</span><span class="main">)</span><span class="main">.</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s1</span> <span class="main">∧</span> pred_option <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s2</span> <span class="main">∧</span> ran <span class="bound">s3</span> <span class="main">⊆</span> nlists UNIV <span class="free">η</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span> <span class="var">?I</span> <span class="free">ℐ</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def lazy_channel_send'_def lazy_channel_recv_f'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ x'
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> projl <span class="main">(</span>projr <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_send.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm cstate.split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def option.pred_set <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI WT_calleeI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def lazy_channel_send'_def lazy_channel_recv_f'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ x
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm cstate.split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exec_gpv <span class="var">?orc_lft</span> <span class="var">?𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span> <span class="main">=</span> exec_gpv <span class="var">?orc_lft</span> <span class="free">𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WT <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.exec_gpv_mk_lossless_gpv<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv'</span><span class="main">)</span> <span class="var">?I</span> <span class="free">ℐ</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">supply</span></span></span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def lazy_channel_send'_def lazy_channel_recv'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ x'
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> projl <span class="main">(</span>projr <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_send.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm cstate.split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def option.pred_set <span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI WT_calleeI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def lazy_channel_send'_def lazy_channel_recv'_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ _ x
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm cstate.split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"exec_gpv <span class="var">?orc_rgt</span> <span class="var">?𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span> <span class="main">=</span> exec_gpv <span class="var">?orc_rgt</span> <span class="free">𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> WT <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.exec_gpv_mk_lossless_gpv<span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span><span class="main">}</span> 
          <span class="main">-</span> Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span><span class="main">}</span><span class="main">¦</span>
        <span class="main">≤</span> Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> game_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> fundamental_lemma<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?bad2.0</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"snd"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split_def<span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> spmf <span class="var">?L</span> True"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> game_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf exec_gpv_resource_of_oracle connect_def spmf_conv_measure_spmf<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_pred_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI measure_spmf_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> fst <span class="bound">l</span> <span class="main">⟷</span> <span class="bound">r</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"spmf <span class="var">?R</span> True <span class="main">=</span> Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> game_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_conv_bind_spmf exec_gpv_resource_of_oracle connect_def spmf_conv_measure_spmf<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_pred_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_spmf_bind_reflI measure_spmf_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="bound">l</span> <span class="main">⟷</span> fst <span class="bound">r</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact3<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv'</span><span class="main">)</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True  
    <span class="main">=</span> spmf <span class="main">(</span>connect <span class="free">𝒜</span> <span class="main">(</span>RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_lft</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_rgt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv"</span></span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>lazy_channel_insec <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">flg</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def spmf_rel_map rel_prod_sel split_def option.rel_refl pmf.rel_refl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span><span class="skolem">lazy_channel_send'</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>lazy_channel_send <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">flg</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_send.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf split_def lazy_channel_send'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>  
       <span class="main">(</span><span class="skolem">lazy_channel_recv'</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>lazy_channel_recv <span class="skolem">s</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">flg</span> <span class="skolem">q</span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv'_def rel_spmf_bind_reflI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split cstate.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span><span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">flg</span><span class="main">,</span> <span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">query</span><span class="main">)</span>
     <span class="main">(</span><span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv<span class="main">)</span> <span class="main">(</span><span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>  <span class="skolem">query</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">flg</span> <span class="skolem">ams</span> <span class="skolem">es</span> <span class="skolem">as</span> <span class="skolem">query</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> apfst_def map_prod_def split_beta <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> Snd_Rcv <span class="main">=</span> this
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> split_beta<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rel_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> fst <span class="bound">y</span><span class="main">)</span>
     <span class="main">(</span>exec_gpv <span class="var">?orc_lft</span> <span class="free">𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span> <span class="main">(</span>exec_gpv <span class="var">?orc_rgt</span> <span class="free">𝒜</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> rel_spmf_mono<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"rel_prod <span class="main">(=)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gpv.rel_eq split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI 
          exec_gpv_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> CALL<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> map_spmf_conv_bind_spmf exec_gpv_resource_of_oracle connect_def spmf_conv_measure_spmf
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> measure_spmf_parametric<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> rel_funD<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_pred_def spmf_rel_map map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> gpv.rel_eq split_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_funI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fact4<span class="main">:</span> <span class="quoted"><span class="quoted">"Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span><span class="main">}</span> <span class="main">≤</span> <span class="free">q</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?orc_sum</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">lazy_channel_insec'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_send'</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">lazy_channel_recv_f'</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span><span class="main">}</span> 
          <span class="main">=</span> spmf <span class="main">(</span>map_spmf <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>exec_gpv <span class="var">?orc_sum</span> <span class="free">𝒜</span> <span class="main">(</span>False<span class="main">,</span> Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span><span class="main">)</span> True"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> game_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> measure_map_spmf<span class="main">)</span>
        <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_conv_measure_spmf measure_map_spmf vimage_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span>  <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>card <span class="main">(</span>nlists <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> real <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"spmf <span class="main">(</span>map_spmf <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="var">?orc_sum</span> <span class="main">(</span>False<span class="main">,</span> <span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="skolem">query</span><span class="main">)</span><span class="main">)</span> True 
                      <span class="main">≤</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span>card <span class="main">(</span>nlists <span class="main">(</span>UNIV <span class="main">::</span> bool set<span class="main">)</span> <span class="free">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ams</span> <span class="skolem">es</span> <span class="skolem">as</span> <span class="skolem">query</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">ams</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span><span class="main">,</span> <span class="skolem">adv_query</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_insec'_def rnd_def map_spmf_conv_bind_spmf bind_spmf_const <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> Snd_Rcv <span class="main">=</span> this
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">rcv_query</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> Snd_Rcv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f'_def map_spmf_conv_bind_spmf split_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>option.split<span class="main">)</span>
              <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> spmf_of_set map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rnd_def spmf_map vimage_def spmf_conv_measure_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> split_indicator<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ams</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lazy_channel_send'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> oi_True.interaction_bounded_by_exec_gpv_bad<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> bad<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"fst"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * assms<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">η</span><span class="main">)</span> <span class="main">*</span> real <span class="free">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_nlists<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LHS</span> <span class="main">≤</span> Sigma_Algebra.measure <span class="main">(</span>measure_spmf <span class="main">(</span><span class="skolem">game</span> <span class="free">𝒜</span> <span class="skolem">lazy_channel_recv_f'</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fact1 fact2 fact3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> fact4
  <span class="keyword1"><span class="command">finally</span></span>  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">inductive</span></span> <span class="entity">S'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">+</span> unit<span class="main">)</span> <span class="main">×</span> unit <span class="main">×</span> bool list cstate<span class="main">)</span> spmf <span class="main">⇒</span>
  <span class="main">(</span>bool list cstate <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span><span class="main">)</span> spmf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> cstate.Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>cstate.Collect <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> cstate.Fail<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>cstate.Fail<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Collect <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">a'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">a'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">a'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inr <span class="main">()</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">a'</span><span class="main">.</span> <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="bound">a'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>spmf_of_set <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">S'</span> <span class="main">(</span>return_spmf <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> 
      <span class="main">(</span>return_spmf <span class="main">(</span>Fail<span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">a'</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free"><span class="bound"><span class="entity">a'</span></span></span> <span class="main">=</span> id' <span class="free">η</span>"</span></span>


<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> trace_eq_sim<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>valid_insecQ <span class="main">&lt;+&gt;</span> nlists UNIV <span class="main">(</span>id' <span class="free">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> 
    RES <span class="main">(</span>callee_auth_channel sim <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>  <span class="main">†</span><span class="main">†</span>channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle<span class="main">)</span> <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span> 
    <span class="main">≈</span> 
    RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>R</sub></span> RES <span class="main">(</span><span class="var">?L1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L3</span><span class="main">)</span> <span class="var">?SL</span> <span class="main">≈</span> RES <span class="main">(</span><span class="var">?R1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R3</span><span class="main">)</span> <span class="var">?SR</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
    spmf.map_comp o_def map_bind_spmf bind_map_spmf bind_spmf_const exec_gpv_bind
    auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps
    rorc_channel_send_def rorc_channel_recv_def rnd_def

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?L1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?L3</span><span class="main">(</span><span class="var">?SL</span><span class="main">)</span> <span class="main">≈</span> <span class="var">?R1</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R2</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="var">?R3</span><span class="main">(</span><span class="var">?SR</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> trace'_eqI_sim<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">S'</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> Init_OK Output_OK State_OK<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Init_OK
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S'.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Output_OK <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">query</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Output_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">adv_query</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ForwardOrEdit <span class="skolem">foe</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> Output_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">foe</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">am'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">am'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">am'</span></span><span class="main">)</span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> Output_OK Inl ForwardOrEdit Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> S'.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">erule</span> S'.cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Output_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>State_OK <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">query</span> <span class="skolem">state</span> <span class="skolem">answer</span> <span class="skolem">state'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">query</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Inl <span class="skolem">adv_query</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">adv_query</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> Look
        <span class="keyword1"><span class="command">with</span></span> State_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">m</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S' <span class="main">(</span>return_spmf <span class="main">(</span>Inl <span class="main">(</span>Some <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Store <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>return_spmf <span class="main">(</span>Store <span class="skolem">m</span><span class="main">,</span> None<span class="main">,</span> <span class="main">[</span><span class="skolem">m</span> <span class="main">↦</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> S'.intros<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> 2<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Inl Look
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cond_spmf_spmf_of_set spmf_of_set_singleton map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                split_beta cond_spmf_fst_def image_def vimage_def id'_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_const<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S'.intros<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ForwardOrEdit <span class="skolem">foe</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">foe</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">with</span></span> State_OK Inl ForwardOrEdit <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_const<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_def S'.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">am'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">am'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">am'</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> State_OK Inl ForwardOrEdit Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> State_OK<span class="main">(</span>2-<span class="main">)</span> Inl ForwardOrEdit Some
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> if_distrib_exec_gpv if_distrib_map_spmf split_def image_def if_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S'.intros <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_const<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>S'.intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> Drop
        <span class="keyword1"><span class="command">with</span></span> State_OK Inl <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_const<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>S'.intros<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id'_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Snd_Rcv<span class="main">:</span> <span class="main">(</span>Inr <span class="skolem">query'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> State_OK <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">query'</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_spmf_const<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> map_spmf_conv_bind_spmf<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_def<span class="main"><span class="keyword3">;</span></span>
            <span class="main">(</span><span class="operator">rule</span> S'.intros<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV id'_def<span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> real_resource_wiring<span class="main">:</span> <span class="quoted"><span class="quoted">"macode.res <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span> <span class="main">(</span>mac <span class="free">η</span><span class="main">)</span> <span class="main">=</span> 
  RES <span class="main">(</span><span class="main">†</span><span class="main">†</span>insec_channel.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_recv<span class="main">)</span> <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Void<span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">including</span></span> lifting_syntax
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> map_spmf <span class="main">(</span>map_prod id lprodr<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">A</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="skolem">B</span><span class="main">)</span> <span class="main">(</span>rprodl <span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>
          <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yl</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="main">()</span><span class="main">,</span> lprodr <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">(</span>rprodl <span class="bound">x</span><span class="main">)</span> <span class="bound">yl</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>    
            <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">yr</span><span class="main">.</span> map_spmf <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">,</span> lprodr <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">(</span>rprodl <span class="bound">x</span><span class="main">)</span> <span class="bound">yr</span><span class="main">)</span><span class="main">)</span> "</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span>    
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"map_prod id <span class="skolem">g</span> <span class="main">∘</span> apfst <span class="skolem">h</span> <span class="main">=</span> apfst <span class="skolem">h</span> <span class="main">∘</span> map_prod id <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">h</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aux plus_oracle_def spmf.map_comp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"apfst <span class="main">_</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> 
          spmf.map_comp<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_prod id lprodr"</span></span><span class="main"><span class="main">]</span></span> sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_spmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span>sum.case_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum.splits<span class="main">)</span>
        <span class="main">(</span><span class="operator">subst</span> plus_oracle_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_prod_def split_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> RES <span class="main">(</span><span class="main">†</span><span class="main">†</span>insec_channel.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span>rprodl <span class="main">---&gt;</span> id <span class="main">---&gt;</span> map_spmf <span class="main">(</span>map_prod id lprodr<span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>lift_state_oracle extend_state_oracle <span class="main">(</span>attach_callee
           <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">s</span> 
             <span class="keyword1">then</span> Done <span class="main">(</span><span class="main">()</span><span class="main">,</span> True<span class="main">)</span>
             <span class="keyword1">else</span> <span class="keyword1">do</span> <span class="main">{</span> 
               <span class="bound">r</span> <span class="main">←</span> Pause <span class="main">(</span>Inl <span class="bound">m</span><span class="main">)</span> Done<span class="main">;</span>
               <span class="bound">a</span> <span class="main">←</span> lift_spmf <span class="main">(</span>mac <span class="free">η</span> <span class="main">(</span>projl <span class="bound">r</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span><span class="main">;</span>
               <span class="main"><span class="bound">_</span></span> <span class="main">←</span> Pause <span class="main">(</span>Inr <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> Done<span class="main">;</span> 
               <span class="main">(</span> Done <span class="main">(</span><span class="main">()</span><span class="main">,</span> True<span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>rorc.rnd_oracle <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span>channel.send_oracle<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>
           <span class="main">†</span><span class="main">†</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
             <span class="main">(</span><span class="bound">amo</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">←</span> <span class="main">†</span>channel.recv_oracle <span class="bound">s</span> <span class="main">()</span><span class="main">;</span>
             <span class="keyword1">case</span> <span class="bound">amo</span> <span class="keyword1">of</span> 
               None <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>
             <span class="main">|</span> Some <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
                 <span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span>rorc.rnd_oracle <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">†</span> <span class="bound">s'</span> <span class="bound">m</span><span class="main">;</span>
                 <span class="bound">a'</span><span class="main">←</span> mac <span class="free">η</span> <span class="bound">r</span> <span class="bound">m</span><span class="main">;</span>
                 return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a'</span> <span class="main">=</span> <span class="bound">a</span> <span class="keyword1">then</span> Some <span class="bound">m</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">s''</span><span class="main">)</span><span class="main">}</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Void<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> attach_CNV_RES attach_callee_parallel_intercept attach_stateless_callee
      resource_of_oracle_rprodl Rel_def prod.rel_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> extend_state_oracle_plus_oracle<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      conv_callee_parallel<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> conv_callee_parallel_id_left<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      o_def  bind_map_spmf exec_gpv_bind split_def option.case_distrib<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">gpv</span><span class="main">.</span> exec_gpv <span class="main">_</span> <span class="bound">gpv</span> <span class="main">_</span>"</span></span><span class="main">]</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> channel.res_def rorc.res_def macode.res_def macode.routing_def
        macode.πE_def macode.enm_def macode.dem_def interface_wiring
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lift_state_oracle_extend_state_oracle <span class="main"><span class="keyword3">|</span></span> <span class="operator">auto</span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> option.case_cong_weak <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> extend_state_oracle_parametric<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rorc_channel_send_def rorc_channel_recv_def extend_state_oracle_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * split_def o_def map_fun_def spmf.map_comp extend_state_oracle_def lift_state_oracle_def 
        exec_gpv_bind if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">gpv</span><span class="main">.</span> exec_gpv <span class="main">_</span> <span class="bound">gpv</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>
      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def o_def rprodl_def Pair_fst_Unity  bind_map_spmf map_spmf_bind_spmf 
        if_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_spmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>  option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map_spmf <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong option.case_cong<span class="main">)</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> ideal_resource_wiring<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>CNV <span class="free">callee</span> <span class="free">s</span><span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> channel.res auth_channel.auth_oracle <span class="main">=</span> 
  RES <span class="main">(</span>callee_auth_channel <span class="free">callee</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle <span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span>"</span></span>   <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">⊳</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_full<span class="main">,</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?L1</span> <span class="main">∼</span> <span class="var">?L1</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span><span class="main">,</span> <span class="var">?I</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">_</span> <span class="main">∼</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_ℐ_converter_mono<span class="main">)</span>
      <span class="main">(</span><span class="operator">rule</span> parallel_converter2_eq_ℐ_cong eq_ℐ_converter_reflI WT_converter_ℐ_full ℐ_full_le_plus_ℐ order_refl plus_ℐ_mono<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 

  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="keyword1">⊢c</span> <span class="main">(</span>auth_channel.auth_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.recv_oracle<span class="main">)</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> 
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_plus_oracleI WT_parallel_oracle WT_callee_full<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">unfold</span> split_paired_all<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span><span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">⊳</span> RES <span class="main">(</span>auth_channel.auth_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> channel.recv_oracle<span class="main">)</span> Void <span class="main">=</span> <span class="var">?R</span>"</span></span>     
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conv_callee_parallel_id_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> attach_CNV_RES 
        attach_callee_parallel_intercept resource_of_oracle_rprodl extend_state_oracle_plus_oracle<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> channel.res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> eq_ℐ_attach<span class="main"><span class="main">[</span></span><span class="operator">OF</span> WT_resource_of_oracle<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ℐ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> conv<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?L1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> conv'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?L1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> all_together<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="main">≡</span> ℐ_uniform <span class="main">(</span>Set.Collect <span class="main">(</span>valid_mac_query <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="free">η</span> <span class="main">×</span> nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span>
     <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> vld <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">η</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"interaction_bounded_by' <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lossless<span class="main">:</span> <span class="quoted"><span class="quoted">"plossless_gpv <span class="free">ℐ</span> <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢g</span> <span class="free">𝒜</span> <span class="free">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">¦</span>spmf <span class="main">(</span>connect <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>CNV sim <span class="main">(</span>Inl None<span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> channel.res auth_channel.auth_oracle<span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
          spmf <span class="main">(</span>connect <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span> <span class="main">(</span>macode.res <span class="main">(</span>rnd <span class="free">η</span><span class="main">)</span> <span class="main">(</span>mac <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> True<span class="main">¦</span> <span class="main">≤</span> <span class="free">q</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="free">η</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">ma</span> <span class="main">=</span> Edit <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> length <span class="bound">a</span> <span class="main">=</span> <span class="free">η</span> <span class="main">∧</span> length <span class="bound">b</span> <span class="main">=</span> <span class="free">η</span> <span class="main">⟹</span> valid_mac_query <span class="free">η</span> <span class="skolem">ma</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ma</span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">η</span><span class="main">,</span> <span class="skolem">ma</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> valid_mac_query.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> assm4_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"outs_gpv <span class="free">ℐ</span> <span class="main">(</span><span class="free">𝒜</span> <span class="free">η</span><span class="main">)</span> <span class="main">⊆</span> valid_insecQ <span class="main">&lt;+&gt;</span> nlists UNIV <span class="main">(</span>id' <span class="free">η</span><span class="main">)</span> <span class="main">&lt;+&gt;</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> WT_gpv_outs_gpv<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> id'_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ord_le_eq_trans<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> aquery.split option.split <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ℐ_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>callee_auth_channel sim <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle<span class="main">)</span> 
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">s3</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">s1</span> <span class="main">=</span> Inl <span class="main">(</span>Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="main">∧</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s3</span><span class="main">)</span> <span class="free">ℐ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>  <span class="comment1">(*A MESS, but neither fastforce nor auto works for all 36 subgoals*)</span>
                          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_bind auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_bind auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exec_gpv_bind auth_channel.auth_oracle.simps channel.send_oracle.simps channel.recv_oracle.simps vld_def in_nlists_UNIV ℐ_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>callee_auth_channel sim <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span><span class="main">†</span>channel.recv_oracle<span class="main">)</span> <span class="main">(</span>Inl None<span class="main">,</span> <span class="main">()</span><span class="main">,</span> Void<span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f<span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">,</span> <span class="bound">s3</span><span class="main">)</span><span class="main">.</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s1</span> <span class="main">∧</span> pred_option <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s2</span> <span class="main">∧</span> ran <span class="bound">s3</span> <span class="main">⊆</span> nlists UNIV <span class="free">η</span><span class="main">)</span>
     <span class="free">ℐ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ x'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="main">(</span>projr <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_send.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI WT_calleeI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ x
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv_f<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv<span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s1</span><span class="main">,</span> <span class="bound">s2</span><span class="main">,</span> <span class="bound">s3</span><span class="main">)</span><span class="main">.</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s1</span> <span class="main">∧</span> pred_option <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s2</span> <span class="main">∧</span> ran <span class="bound">s3</span> <span class="main">⊆</span> nlists UNIV <span class="free">η</span><span class="main">)</span>
     <span class="free">ℐ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ x'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="main">(</span>projr <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_send.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def option.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI WT_calleeI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ x
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_insec.cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> lazy_channel_recv_f.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV vld_def ran_def rnd_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> WT3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span>lazy_channel_insec <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> lazy_channel_recv<span class="main">)</span> <span class="main">(</span>Void<span class="main">,</span> None<span class="main">,</span> Map.empty<span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span><span class="main">†</span><span class="main">†</span>insec_channel.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_recv<span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> ran <span class="bound">m</span> <span class="main">⊆</span> nlists UNIV <span class="free">η</span> <span class="main">∧</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="free">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="free">ℐ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> PlusE<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ x'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insec_channel.insec_oracle.cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def insec_channel.insec_oracle.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> channel.send_oracle.simps rorc_channel_send_def rorc.rnd_oracle.simps in_nlists_UNIV rnd_def vld_def mac_def ran_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rorc_channel_recv_def channel.recv_oracle.simps rorc.rnd_oracle.simps rnd_def mac_def ran_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> conjI WT_calleeI<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> _ _ _ x'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insec_channel.insec_oracle.cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV rnd_def insec_channel.insec_oracle.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rorc_channel_recv_def channel.recv_oracle.simps rorc.rnd_oracle.simps rnd_def mac_def vld_def ran_def <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> WT4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ</span> <span class="keyword1">⊢res</span> RES <span class="main">(</span><span class="main">†</span><span class="main">†</span>insec_channel.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_send <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> rorc_channel_recv<span class="main">)</span> <span class="main">(</span><span class="main">(</span>False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Void<span class="main">)</span> <span class="main">√</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">note</span></span> game_difference<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> ℐ_def<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> connect_cong_trace<span class="main">[</span><span class="operator">OF</span> trace_eq_sim WT assm4_alt WT1 WT2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> connect_cong_trace<span class="main">[</span><span class="operator">OF</span> trace_eq_lazy<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> WT assm4_alt WT3 WT4<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> ideal_resource_wiring<span class="main">[</span><span class="operator">of</span> <span class="quoted">sim</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Inl None"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> real_resource_wiring<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> MAC<span class="main">:</span> macode <span class="quoted"><span class="quoted">"rnd <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"mac <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">interpretation</span></span> A_CHAN<span class="main">:</span> auth_channel <span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> WT_enm<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> UNIV<span class="main">,</span> ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> <span class="free">X</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span><span class="free">X</span> <span class="main">×</span> vld <span class="free">η</span><span class="main">)</span> UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> MAC.enm <span class="free">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MAC.enm_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mac_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_dem<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> vld <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> ℐ_full <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="free">η</span> <span class="main">×</span> nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> MAC.dem <span class="free">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MAC.dem_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def stateless_callee_def mac_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_insec_query_of <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mac_query <span class="free">η</span> <span class="main">(</span>insec_query_of <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> secure_mac<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">{</span><span class="bound">x</span><span class="main">.</span> valid_mac_query <span class="bound">η</span> <span class="bound">x</span><span class="main">}</span> <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="bound">η</span> <span class="main">×</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">(</span>vld <span class="bound">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> vld <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"constructive_security MAC.res <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> A_CHAN.res<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> CNV sim <span class="main">(</span>Inl None<span class="main">)</span><span class="main">)</span>
     <span class="free">ℐ_real</span> <span class="free">ℐ_ideal</span> <span class="free">ℐ_common</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> enat <span class="free">q</span><span class="main">)</span> True <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> insec_auth_wiring<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> WT_res <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> MAC.res <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"pred_cstate <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="skolem">η</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>MAC.RO.rnd_oracle <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> MAC.RO.rnd_oracle <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> ran <span class="bound">m</span> <span class="main">⊆</span> vld <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>vld <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rnd_def vld_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rnd_def in_nlists_UNIV vld_def ran_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>vld <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>vld <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full <span class="keyword1">⊢res</span> MAC.RO.res <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">unfolding</span></span> MAC.RO.res_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢c</span> MAC.INSEC.insec_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> MAC.INSEC.insec_oracle.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_real_def in_nlists_UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="skolem">η</span> <span class="main">×</span> nlists UNIV <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢c</span> A_CHAN.recv_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> cstate"</span></span> <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>MAC.INSEC.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> A_CHAN.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> A_CHAN.recv_oracle<span class="main">)</span> <span class="var">?I</span>
      <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="skolem">η</span> <span class="main">×</span> vld <span class="skolem">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="skolem">η</span> <span class="main">×</span> nlists UNIV <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> MAC.INSEC.insec_oracle.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_real_def vld_def in_nlists_UNIV<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="main">(</span>ℐ_uniform <span class="main">(</span>vld <span class="skolem">η</span> <span class="main">×</span> vld <span class="skolem">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="skolem">η</span> <span class="main">×</span> nlists UNIV <span class="skolem">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢res</span> MAC.INSEC.res <span class="main">√</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> MAC.INSEC.res_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ℐ_common_def MAC.res_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span> WT_enm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"vld <span class="skolem">η</span>"</span></span><span class="main"><span class="main">]</span></span> WT_dem <span class="main"><span class="keyword3">|</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> pred_cstate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="bound">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> WT_auth<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢c</span> A_CHAN.auth_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">η</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> A_CHAN.auth_oracle.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> WT_recv<span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> vld <span class="skolem">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢c</span> A_CHAN.recv_oracle <span class="skolem">s</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I</span> <span class="skolem">η</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">s</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vld_def in_nlists_UNIV<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>A_CHAN.auth_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> A_CHAN.send_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> A_CHAN.recv_oracle<span class="main">)</span>
     <span class="main">(</span><span class="var">?I</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s'
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> projl <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> A_CHAN.auth_oracle.cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"projr <span class="skolem">x</span>"</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_common_def vld_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s <span class="keyword1"><span class="command">using</span></span> WT_auth WT_recv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_common_def ℐ_ideal_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword3"><span class="command">show</span></span> WT_auth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢res</span> A_CHAN.res <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_CHAN.res_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?I_sim</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span> <span class="main">(</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">+</span> unit<span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> Inl <span class="main">(</span>Some <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> length <span class="bound">x</span> <span class="main">=</span> <span class="bound">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="bound">η</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV sim <span class="skolem">s</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?I_sim</span> <span class="skolem">η</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">s</span> <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> q r conv' s <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sim.cases<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ℐ_real_def ℐ_ideal_def vld_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CNV sim <span class="main">(</span>Inl None<span class="main">)</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> insec_query <span class="main">+</span> bool list <span class="main">+</span> unit<span class="main">,</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> option <span class="main">+</span> unit <span class="main">+</span> bool list option<span class="main">)</span> distinguisher"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> WT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒜</span> <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">assume</span></span> bounded<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_bounded_by' <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">assume</span></span> lossless<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"True <span class="main">⟹</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="skolem">𝒜</span> <span class="skolem">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>CNV sim <span class="main">(</span>Inl None<span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> A_CHAN.res<span class="main">)</span> <span class="main">(</span>MAC.res <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="free">q</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?ov</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> negligible_poly_times<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> negligible_inverse_powerI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
      <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> spmf <span class="main">(</span>connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>CNV sim <span class="main">(</span>Inl None<span class="main">)</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> A_CHAN.res<span class="main">)</span><span class="main">)</span> True <span class="main">-</span>
           spmf <span class="main">(</span>connect <span class="main">(</span><span class="skolem">𝒜</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>MAC.res <span class="bound">η</span><span class="main">)</span><span class="main">)</span> True<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="var">?ov</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bigo_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_together<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> bounded eventually_at_top_linorderI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> 
            exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span> lossless<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ℐ_real_def ℐ_common_def<span class="main"><span class="main">]</span></span> WT<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ℐ_real_def ℐ_common_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"negligible <span class="var">?L</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> f1 f2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> negligible_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?ov</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cnv</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map_converter id id insec_query_of auth_response_of <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cnv</span><span class="main">.</span> <span class="main">∀</span><span class="bound">𝒟</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="bound">𝒟</span> <span class="bound">η</span> <span class="main">√</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> interaction_bounded_by' <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> True <span class="main">⟶</span> plossless_gpv <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="main">∀</span><span class="bound">η</span><span class="main">.</span> wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span><span class="main">)</span> <span class="main">(</span>insec_query_of<span class="main">,</span> map_option snd<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
               negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="bound">𝒟</span> <span class="bound">η</span><span class="main">)</span> A_CHAN.res <span class="main">(</span><span class="bound">cnv</span> <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> MAC.res <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="var">?cnv</span>"</span></span><span class="main"><span class="main">]</span></span> strip conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒟</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span>auth_query <span class="main">+</span> bool list <span class="main">+</span> unit<span class="main">,</span> bool list option <span class="main">+</span> unit <span class="main">+</span> bool list option<span class="main">)</span> distinguisher"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> WT_D <span class="main">[</span><span class="operator">rule_format</span><span class="main">,</span> <span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">η</span><span class="main">.</span> <span class="free">ℐ_ideal</span> <span class="bound">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="bound">η</span> <span class="keyword1">⊢g</span> <span class="skolem">𝒟</span> <span class="bound">η</span> <span class="main">√</span>"</span></span>

      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> UNIV <span class="main">&lt;+&gt;</span> nlists UNIV <span class="bound">η</span> <span class="main">&lt;+&gt;</span> UNIV"</span></span>
      <span class="keyword1"><span class="command">have</span></span> WT1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> map_ℐ insec_query_of <span class="main">(</span>map_option snd<span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> 
        <span class="keyword1"><span class="command">using</span></span> WT_converter_id order_refl <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def ℐ_ideal_def ℐ_real_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> WT0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> <span class="free">ℐ_common</span> <span class="skolem">η</span>  <span class="keyword1">⊢res</span> map_converter id id insec_query_of <span class="main">(</span>map_option snd<span class="main">)</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> MAC.res <span class="skolem">η</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT1 <span class="dynamic"><span class="dynamic">WT_intro</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">have</span></span> WT2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> map_ℐ insec_query_of <span class="main">(</span>map_option snd<span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">using</span></span> WT_converter_id order_refl
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_mono<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_ℐ_def ℐ_ideal_def ℐ_real_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> WT_cnv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">,</span> <span class="free">ℐ_real</span> <span class="skolem">η</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?cnv</span> <span class="main">√</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_map_converter<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> WT2<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> eq_ℐ_converter_reflI<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> this
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wiring <span class="main">(</span><span class="free">ℐ_ideal</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="free">ℐ_real</span> <span class="skolem">η</span><span class="main">)</span> <span class="var">?cnv</span> insec_auth_wiring"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="keyword1"><span class="command">..</span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">res'</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> auth_query <span class="main">+</span> <span class="main">(</span>bool list <span class="main">+</span> bool list <span class="main">×</span> bool list<span class="main">)</span> <span class="main">+</span> bool list <span class="main">+</span> unit <span class="main">⇒</span> <span class="main">_</span>"</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res'</span> <span class="skolem">η</span> <span class="main">=</span> 
         map_fun id <span class="main">(</span>map_fun insec_query_of <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="main">(</span>map_option snd<span class="main">)</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">†</span>MAC.INSEC.insec_oracle <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>
         <span class="main">(</span><span class="main">(</span>MAC.RO.rnd_oracle <span class="skolem">η</span><span class="main">)</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span>A_CHAN.send_oracle<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">(</span>MAC.RO.rnd_oracle <span class="skolem">η</span><span class="main">)</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span>A_CHAN.recv_oracle"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      
      <span class="keyword1"><span class="command">have</span></span> push<span class="main">:</span> <span class="quoted"><span class="quoted">"map_resource <span class="main">(</span>map_sum <span class="skolem">f</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g</span> id<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">conv</span><span class="main">)</span> <span class="main">⊳</span> <span class="skolem">res</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">conv</span><span class="main">)</span> <span class="main">⊳</span> map_resource <span class="main">(</span>map_sum <span class="skolem">f</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g</span> id<span class="main">)</span> <span class="skolem">res</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">conv</span> <span class="skolem">res</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map_resource <span class="main">(</span>map_sum <span class="skolem">f</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g</span> id<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">conv</span><span class="main">)</span> <span class="main">⊳</span> <span class="skolem">res</span><span class="main">)</span> <span class="main">=</span> map_converter <span class="skolem">f</span> <span class="skolem">g</span> id id <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">conv</span> <span class="main">⊳</span> <span class="skolem">res</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> attach_map_converter parallel_converter2_map1_out sum.map_id0<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="skolem">conv</span><span class="main">)</span> <span class="main">⊳</span> map_resource <span class="main">(</span>map_sum <span class="skolem">f</span> id<span class="main">)</span> <span class="main">(</span>map_sum <span class="skolem">g</span> id<span class="main">)</span> <span class="skolem">res</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> map_converter_id_move_right<span class="main">)</span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_map1_out sum.map_id0 attach_map_converter<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> res'<span class="main">:</span> <span class="quoted"><span class="quoted">"map_resource <span class="main">(</span>map_sum insec_query_of id<span class="main">)</span> <span class="main">(</span>map_sum <span class="main">(</span>map_option snd<span class="main">)</span> id<span class="main">)</span> <span class="main">(</span>MAC.res <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> 
        <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> MAC.enm <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> MAC.dem <span class="skolem">η</span> <span class="main">⊳</span> RES <span class="main">(</span><span class="skolem">res'</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>Map.empty<span class="main">,</span> Void<span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">unfolding</span></span> MAC.res_def MAC.RO.res_def MAC.INSEC.res_def interface_wiring push
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_map1_out sum.map_id0 attach_map_converter map_resource_resource_of_oracle map_sum_plus_oracle prod.map_id0 option.map_id0 map_fun_id res'_def<span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">res''</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> <span class="main">(</span>unit <span class="main">×</span> bool <span class="main">×</span> unit<span class="main">)</span>  <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span> <span class="main">×</span> <span class="main">_</span> cstate <span class="main">⇒</span> auth_query <span class="main">+</span> bool list <span class="main">+</span> unit <span class="main">⇒</span> <span class="main">_</span>"</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res''</span> <span class="skolem">η</span> <span class="main">=</span> map_fun rprodl <span class="main">(</span>map_fun id <span class="main">(</span>map_spmf <span class="main">(</span>map_prod id lprodr<span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span>lift_state_oracle extend_state_oracle <span class="main">†</span><span class="main">(</span>map_fun id <span class="main">(</span>map_fun insec_query_of <span class="main">(</span>map_spmf <span class="main">(</span>map_prod <span class="main">(</span>map_option snd<span class="main">)</span> id<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">†</span>MAC.INSEC.insec_oracle<span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>
           <span class="main">†</span><span class="main">(</span>map_fun rprodl <span class="main">(</span>map_fun id <span class="main">(</span>map_spmf <span class="main">(</span>map_prod id lprodr<span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>lift_state_oracle extend_state_oracle
                <span class="main">(</span>attach_callee
                  <span class="main">(</span><span class="main">λ</span><span class="bound">bs</span> <span class="bound">m</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">bs</span> <span class="keyword1">then</span> Done <span class="main">(</span><span class="main">()</span><span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> Pause <span class="main">(</span>Inl <span class="bound">m</span><span class="main">)</span> Done <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> lift_spmf <span class="main">(</span>mac <span class="skolem">η</span> <span class="main">(</span>projl <span class="bound">r</span><span class="main">)</span> <span class="bound">m</span><span class="main">)</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> Pause <span class="main">(</span>Inr <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> Done <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Done <span class="main">(</span><span class="main">()</span><span class="main">,</span> True<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="main">(</span>MAC.RO.rnd_oracle <span class="skolem">η</span><span class="main">)</span><span class="main">†</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> <span class="main">†</span>A_CHAN.send_oracle<span class="main">)</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span>
               <span class="main">†</span><span class="main">†</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="main">†</span>A_CHAN.recv_oracle <span class="bound">s</span> <span class="main">()</span> <span class="main">⤜</span>
                         <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span>None<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> return_spmf <span class="main">(</span>None<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span>
                               <span class="main">|</span> <span class="main">(</span>Some <span class="main">(</span><span class="bound">x1</span><span class="main">,</span> <span class="bound">x2a</span><span class="main">)</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>MAC.RO.rnd_oracle <span class="skolem">η</span><span class="main">)</span><span class="main">†</span> <span class="bound">s'</span> <span class="bound">x2a</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">.</span> mac <span class="skolem">η</span> <span class="bound">x</span> <span class="bound">x2a</span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> return_spmf <span class="main">(</span><span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x1</span> <span class="keyword1">then</span> Some <span class="bound">x2a</span> <span class="keyword1">else</span> None<span class="main">,</span> <span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cnv</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> MAC.res <span class="skolem">η</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> MAC.enm <span class="skolem">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> MAC.dem <span class="skolem">η</span> <span class="main">⊳</span> RES <span class="main">(</span><span class="skolem">res'</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>Map.empty<span class="main">,</span> Void<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> parallel_converter2_map1_out attach_map_converter sum.map_id0 res' attach_compose<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> comp_converter_parallel2 comp_converter_id_left<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="skolem">η</span> <span class="main">=</span> RES <span class="main">(</span><span class="skolem">res''</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">()</span><span class="main">,</span> False<span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">,</span> Map.empty<span class="main">,</span> Void<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">unfolding</span></span> MAC.enm_def MAC.dem_def conv_callee_parallel<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> conv_callee_parallel_id_left<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">()</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> attach_CNV_RES
        <span class="keyword1"><span class="command">unfolding</span></span> res'_def res''_def attach_callee_parallel_intercept attach_stateless_callee attach_callee_id_oracle prod.rel_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extend_state_oracle_plus_oracle<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rprodl_extend_state_oracle sum.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> exec_gpv <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> 
             option.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> exec_gpv <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> prod.case_distrib<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> h<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> exec_gpv <span class="main">_</span> <span class="bound">x</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> exec_gpv_bind bind_map_spmf o_def
           <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sum.case_cong option.case_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"security <span class="main">⇒</span> bool list cstate <span class="main">⇒</span> <span class="main">(</span>unit <span class="main">×</span> bool <span class="main">×</span> unit<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">⇒</span> bool list option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool list <span class="main">×</span> bool list<span class="main">)</span> cstate <span class="main">⇒</span> bool"</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">η</span> <span class="skolem">l</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">of</span>
          <span class="main">(</span>Void<span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> False<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> Void<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">m</span> <span class="main">=</span> Map.empty
        <span class="main">|</span> <span class="main">(</span>Store <span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> True<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> Store <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> length <span class="bound">z</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">[</span><span class="bound">z</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">z</span>
        <span class="main">|</span> <span class="main">(</span>Collect <span class="bound">x</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> True<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> Collect <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> length <span class="bound">y</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> length <span class="bound">z</span> <span class="main">=</span> <span class="skolem">η</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">[</span><span class="bound">z</span> <span class="main">↦</span> <span class="bound">y</span><span class="main">]</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">z</span>
        <span class="main">|</span> <span class="main">(</span>Fail<span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> True<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">,</span> <span class="bound">m</span><span class="main">,</span> Fail<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> True
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span> <span class="skolem">l</span> <span class="skolem">r</span>

      <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> spmf_rel_map bind_map_spmf exec_gpv_bind
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span><span class="var">?cnv</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> MAC.res <span class="skolem">η</span><span class="main">)</span> <span class="main">=</span> connect <span class="main">(</span><span class="skolem">𝒟</span> <span class="skolem">η</span><span class="main">)</span> A_CHAN.res"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
        <span class="keyword1"><span class="command">unfolding</span></span> calculation <span class="keyword1"><span class="command">using</span></span> WT_D _ WT_auth
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> connect_eq_resource_cong<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> A_CHAN.res_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> eq_resource_on_resource_of_oracleI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">η</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> rel_funI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' q q'
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"projl <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"projr <span class="skolem">q</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_on_def S_def res''_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> cstate.split_asm bool.split_asm<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_spmf_return_spmf1 rnd_def mac_def bind_UNION ℐ_common_def vld_def in_nlists_UNIV S_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> adv<span class="main">:</span> <span class="quoted"><span class="quoted">"negligible <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> advantage <span class="main">(</span><span class="skolem">𝒟</span> <span class="bound">η</span><span class="main">)</span> A_CHAN.res <span class="main">(</span><span class="var">?cnv</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">⊳</span> MAC.res <span class="bound">η</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> advantage_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Secure_Channel">
<div class="head">
<h1>Theory Secure_Channel</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Secure composition: Encrypt then MAC›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Secure_Channel <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="One_Time_Pad.html">One_Time_Pad</a>
  <a href="Message_Authentication_Code.html">Message_Authentication_Code</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">interpretation</span></span> INSEC<span class="main">:</span> insec_channel <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> MAC<span class="main">:</span> macode <span class="quoted"><span class="quoted">"rnd <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"mac <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">interpretation</span></span> AUTH<span class="main">:</span> auth_channel <span class="keyword1"><span class="command">.</span></span> 

<span class="keyword1"><span class="command">interpretation</span></span> CIPHER<span class="main">:</span> cipher <span class="quoted"><span class="quoted">"key <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"enc <span class="free">η</span>"</span></span> <span class="quoted"><span class="quoted">"dec <span class="free">η</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span> <span class="keyword1"><span class="command">.</span></span> 
<span class="keyword1"><span class="command">interpretation</span></span> SEC<span class="main">:</span> sec_channel <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_enc <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span>ℐ_uniform <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> UNIV<span class="main">)</span> <span class="main">(</span>CIPHER.enc <span class="free">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.enc_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_converter_of_callee<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def enc_def in_nlists_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plossless_dec <span class="main">[</span><span class="operator">plossless_intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"plossless_converter <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>CIPHER.dec <span class="free">η</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.dec_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> plossless_converter_of_callee<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def dec_def in_nlists_UNIV <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> callee_invariant_on_key_oracle<span class="main">:</span>
  <span class="quoted"><span class="quoted">"callee_invariant_on
     <span class="main">(</span>CIPHER.KEY.key_oracle <span class="free">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> CIPHER.KEY.key_oracle <span class="free">η</span><span class="main">)</span>
     <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> length <span class="bound">x'</span> <span class="main">=</span> <span class="free">η</span><span class="main">)</span>
     <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">s</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">s'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_def in_nlists_UNIV<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> WT_calleeI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm<span class="main">)</span><span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_nlists_UNIV key_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> key<span class="main">:</span> callee_invariant_on
  <span class="quoted"><span class="quoted">"CIPHER.KEY.key_oracle <span class="free">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> CIPHER.KEY.key_oracle <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">x'</span> <span class="main">⇒</span> length <span class="bound">x'</span> <span class="main">=</span> <span class="free">η</span>"</span></span>
  <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">η</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on_key_oracle<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_enc <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> UNIV<span class="main">,</span>
  ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform <span class="main">(</span>vld <span class="free">η</span><span class="main">)</span> UNIV <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span> CIPHER.enc <span class="free">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.enc_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def vld_def enc_def in_nlists_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> WT_dec <span class="main">[</span><span class="operator">WT_intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="free">η</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="free">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> vld <span class="free">η</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">⊢<span class="hidden">⇩</span><sub>C</sub></span>
    CIPHER.dec <span class="free">η</span> <span class="main">√</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.dec_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> WT_converter_of_callee<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def dec_def vld_def in_nlists_UNIV<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_enc <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>CIPHER.enc <span class="free">η</span><span class="main">)</span> <span class="main">(</span>enat <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.enc_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interaction_any_bounded_converter_of_callee<span class="main">)</span> 
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def map_gpv_id_bind_gpv zero_enat_def one_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bound_dec <span class="main">[</span><span class="operator">interaction_bound</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"interaction_any_bounded_converter <span class="main">(</span>CIPHER.dec <span class="free">η</span><span class="main">)</span> <span class="main">(</span>enat <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.dec_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> interaction_any_bounded_converter_of_callee<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stateless_callee_def map_gpv_id_bind_gpv zero_enat_def one_enat_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.split option.split<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> mac_otp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_real</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">{</span><span class="bound">x</span><span class="main">.</span> valid_mac_query <span class="bound">η</span> <span class="bound">x</span><span class="main">}</span> UNIV"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_ideal</span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> ℐ_full"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℐ_common</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">(</span>vld <span class="bound">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_full"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"constructive_security
      <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> <span class="main">(</span>CIPHER.enc <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> CIPHER.dec <span class="bound">η</span><span class="main">)</span> <span class="main">⊙</span> parallel_wiring <span class="main">⊳</span>
            parallel_resource1_wiring <span class="main">⊳</span>
            CIPHER.KEY.res <span class="bound">η</span> <span class="main">∥</span>
            <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> MAC.enm <span class="bound">η</span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> MAC.dem <span class="bound">η</span> <span class="main">⊳</span>
             <span class="keyword1">1<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">|<span class="hidden">⇩</span><sub>=</sub></span> parallel_wiring <span class="main">⊳</span>
             parallel_resource1_wiring <span class="main">⊳</span> MAC.RO.res <span class="bound">η</span> <span class="main">∥</span> INSEC.res<span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> SEC.res<span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> CNV Message_Authentication_Code.sim <span class="main">(</span>Inl None<span class="main">)</span> <span class="main">⊙</span> CNV One_Time_Pad.sim None<span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">(</span>Set.Collect <span class="main">(</span>valid_mac_query <span class="bound">η</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> <span class="main">(</span>nlists UNIV <span class="bound">η</span> <span class="main">×</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">{</span>None<span class="main">,</span> Some <span class="bound">η</span><span class="main">}</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform <span class="main">(</span>nlists UNIV <span class="bound">η</span><span class="main">)</span> UNIV <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>insert None <span class="main">(</span>Some <span class="main">`</span> nlists UNIV <span class="bound">η</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> enat <span class="free">q</span><span class="main">)</span> True <span class="main">(</span><span class="main">λ</span><span class="bound">η</span><span class="main">.</span> <span class="main">(</span>id<span class="main">,</span> map_option length<span class="main">)</span> <span class="keyword1">∘<span class="hidden">⇩</span><sub>w</sub></span> <span class="main">(</span>insec_query_of<span class="main">,</span> map_option snd<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> composability<span class="main"><span class="main">[</span></span><span class="operator">OF</span> one_time_pad<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> constructive_security2.constructive_security<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">unfolded</span> CIPHER.res_alt_def comp_converter_parallel2 comp_converter_id_left<span class="main"><span class="main"><span class="main">]</span></span></span>
  secure_mac<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> MAC.res_def<span class="main"><span class="main"><span class="main">,</span></span></span> 
        <span class="operator">THEN</span> constructive_security.parallel_resource1<span class="main"><span class="main"><span class="main">,</span></span></span>
        <span class="operator">THEN</span> constructive_security.lifting<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
      <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ℐ_res2</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">η</span><span class="main">.</span> ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="bound">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="bound">η</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?bound_conv1</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?q3</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="free">q</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> bound_sim <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">∞</span>"</span></span><span class="main"><span class="main">,</span></span>
<span class="operator">simplified</span><span class="main"><span class="main">]</span></span>
    <span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊢c</span> CIPHER.KEY.key_oracle <span class="skolem">η</span> <span class="skolem">s</span> <span class="main">√</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"pred_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s</span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> WT_calleeI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> call <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">call</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"callee_invariant_on <span class="main">(</span>CIPHER.KEY.key_oracle <span class="skolem">η</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>O</sub></span> CIPHER.KEY.key_oracle <span class="skolem">η</span><span class="main">)</span> <span class="main">(</span>pred_option <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> length <span class="bound">x</span> <span class="main">=</span> <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="skolem">η</span><span class="main">)</span> <span class="keyword1">⊕<span class="hidden">⇩</span><sub>ℐ</sub></span> ℐ_uniform UNIV <span class="main">(</span>nlists UNIV <span class="skolem">η</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">η</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x y s' <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_def in_nlists_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.KEY.res_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.WT_resource_of_oracle<span class="main">)</span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> CIPHER.KEY.res_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> callee_invariant_on.lossless_resource_of_oracle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s x <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> plus_oracle_split<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> key_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">interaction_bound_converter</span> <span class="operator">code_simp</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_2_right<span class="main">)</span>

  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">η</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> vld_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> <span class="dynamic"><span class="dynamic">plossless_intro</span></span> <span class="dynamic"><span class="dynamic">WT_intro</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> vld_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Examples <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="Secure_Channel.html">Secure_Channel/Secure_Channel</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>