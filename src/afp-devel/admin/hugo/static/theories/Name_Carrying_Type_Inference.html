<div id="Fresh">
<div class="head">
<h1>Theory Fresh</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Fresh
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">class</span></span> fresh <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">fresh_in</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="free">fresh_in</span> <span class="free">S</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nat <span class="main">::</span> <span class="quoted">fresh</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">fresh_in_nat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">fresh_in_nat</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> Set.is_empty <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Max <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="skolem">S</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Set.is_empty <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fresh_in <span class="skolem">S</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fresh_in_nat_def
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Set.is_empty_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> Set.is_empty <span class="skolem">S</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Max <span class="skolem">S</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">S</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">S</span>›</span></span> Max.coboundedI add_le_same_cancel1 not_one_le_zero
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> Set.is_empty <span class="skolem">S</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Max <span class="skolem">S</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Permutation">
<div class="head">
<h1>Theory Permutation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Permutation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> swp <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> preprm <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> swp list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preprm_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> preprm"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">preprm_id</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">swp_apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> swp <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">swp_apply</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">preprm_apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> preprm <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprm_apply</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">preprm_apply</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> swp_apply <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">preprm_apply</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preprm_compose</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> preprm <span class="main">⇒</span> <span class="tfree">'a</span> preprm <span class="main">⇒</span> <span class="tfree">'a</span> preprm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprm_compose</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preprm_unit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> preprm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprm_unit</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preprm_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> preprm <span class="main">⇒</span> <span class="tfree">'a</span> preprm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">=p</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="keyword1"><span class="free">=p</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">x</span> <span class="main">=</span> preprm_apply <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">preprm_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> preprm <span class="main">⇒</span> <span class="tfree">'a</span> preprm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preprm_inv</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">≡</span> rev <span class="free"><span class="bound"><span class="entity">π</span></span></span>"</span></span>

<span class="keyword1" id="Permutation-swp_apply_unequal"><span class="command">lemma</span></span> swp_apply_unequal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">x</span> <span class="main">≠</span> swp_apply <span class="free">s</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">y</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">y</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≠</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">y</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">a</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 3
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="free">s</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹swp_apply <span class="free">s</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_ext_reflexive"><span class="command">lemma</span></span> preprm_ext_reflexive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=p</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> preprm_ext_reflp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reflp preprm_ext"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> reflp_def <span class="keyword1"><span class="command">using</span></span> preprm_ext_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Permutation-preprm_ext_symmetric"><span class="command">lemma</span></span> preprm_ext_symmetric<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=p</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">=p</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> preprm_ext_symp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"symp preprm_ext"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> symp_def <span class="keyword1"><span class="command">using</span></span> preprm_ext_symmetric <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Permutation-preprm_ext_transitive"><span class="command">lemma</span></span> preprm_ext_transitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=p</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="keyword1">=p</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">=p</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> preprm_ext_transp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transp preprm_ext"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transp_def <span class="keyword1"><span class="command">using</span></span> preprm_ext_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Permutation-preprm_apply_composition"><span class="command">lemma</span></span> preprm_apply_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="main">(</span>preprm_compose <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> preprm_apply <span class="free">f</span> <span class="main">(</span>preprm_apply <span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_compose_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Permutation-preprm_apply_unequal"><span class="command">lemma</span></span> preprm_apply_unequal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="free">π</span> <span class="free">x</span> <span class="main">≠</span> preprm_apply <span class="free">π</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"preprm_apply <span class="main">(</span><span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> swp_apply <span class="skolem">s</span> <span class="main">(</span>preprm_apply <span class="skolem">ss</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="main">(</span><span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> swp_apply <span class="skolem">s</span> <span class="main">(</span>preprm_apply <span class="skolem">ss</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> swp_apply_unequal <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_unit_equal_id"><span class="command">lemma</span></span> preprm_unit_equal_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_unit <span class="free">a</span> <span class="free">a</span> <span class="keyword1">=p</span> preprm_id"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def preprm_unit_def preprm_id_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-preprm_unit_inaction"><span class="command">lemma</span></span> preprm_unit_inaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_unit_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-preprm_unit_action"><span class="command">lemma</span></span> preprm_unit_action<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_unit_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-preprm_unit_commutes"><span class="command">lemma</span></span> preprm_unit_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_unit <span class="free">a</span> <span class="free">b</span> <span class="keyword1">=p</span> preprm_unit <span class="free">b</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def preprm_unit_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-preprm_singleton_involution"><span class="command">lemma</span></span> preprm_singleton_involution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_compose <span class="main">[</span><span class="free">s</span><span class="main">]</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span> <span class="keyword1">=p</span> preprm_id"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def preprm_compose_def preprm_unit_def preprm_id_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> fst <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> snd <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s1</span><span class="main">,</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="free">s</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> preprm_apply <span class="main">[]</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_unit_involution"><span class="command">lemma</span></span> preprm_unit_involution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_compose <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">=p</span> preprm_id"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_unit_def
<span class="keyword1"><span class="command">using</span></span> preprm_singleton_involution<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Permutation-preprm_apply_id"><span class="command">lemma</span></span> preprm_apply_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_apply preprm_id <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_id_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-preprm_apply_injective"><span class="command">lemma</span></span> preprm_apply_injective<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>preprm_apply <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="free">π</span> <span class="skolem">x</span> <span class="main">=</span> preprm_apply <span class="free">π</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"swp_apply <span class="skolem">s</span> <span class="main">(</span>preprm_apply <span class="skolem">ss</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> swp_apply <span class="skolem">s</span> <span class="main">(</span>preprm_apply <span class="skolem">ss</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> swp_apply_unequal Cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_disagreement_composition"><span class="command">lemma</span></span> preprm_disagreement_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span>
    preprm_apply <span class="main">(</span>preprm_compose <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>preprm_unit <span class="free">b</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span>
    preprm_apply <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">c</span><span class="main">)</span> <span class="bound">x</span>
  <span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_unit_def preprm_compose_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≠</span> preprm_apply <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span><span class="main">]</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_compose_push"><span class="command">lemma</span></span> preprm_compose_push<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    preprm_compose <span class="free">π</span> <span class="main">(</span>preprm_unit <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="keyword1">=p</span>
    preprm_compose <span class="main">(</span>preprm_unit <span class="main">(</span>preprm_apply <span class="free">π</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>preprm_apply <span class="free">π</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">π</span>
  "</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def preprm_unit_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_eq preprm_apply_composition preprm_apply_injective<span class="main">)</span>

<span class="keyword1" id="Permutation-preprm_ext_compose_left"><span class="command">lemma</span></span> preprm_ext_compose_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">=p</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_compose <span class="free">π</span> <span class="free">P</span> <span class="keyword1">=p</span> preprm_compose <span class="free">π</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def
<span class="keyword1"><span class="command">using</span></span> preprm_apply_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Permutation-preprm_ext_compose_right"><span class="command">lemma</span></span> preprm_ext_compose_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">=p</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_compose <span class="free">P</span> <span class="free">π</span> <span class="keyword1">=p</span> preprm_compose <span class="free">S</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def
<span class="keyword1"><span class="command">using</span></span> preprm_apply_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Permutation-preprm_ext_uncompose"><span class="command">lemma</span></span> preprm_ext_uncompose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">=p</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"preprm_compose <span class="free">π</span> <span class="free">P</span> <span class="keyword1">=p</span> preprm_compose <span class="free">σ</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">=p</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="free">π</span> <span class="bound">x</span> <span class="main">=</span> preprm_apply <span class="free">σ</span> <span class="bound">x</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="main">(</span>preprm_compose <span class="free">π</span> <span class="free">P</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> preprm_apply <span class="main">(</span>preprm_compose <span class="free">σ</span> <span class="free">S</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="free">π</span> <span class="main">(</span>preprm_apply <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> preprm_apply <span class="free">σ</span> <span class="main">(</span>preprm_apply <span class="free">S</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preprm_apply_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="free">π</span> <span class="main">(</span>preprm_apply <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> preprm_apply <span class="free">π</span> <span class="main">(</span>preprm_apply <span class="free">S</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> preprm_apply <span class="free">P</span> <span class="bound">x</span> <span class="main">=</span> preprm_apply <span class="free">S</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preprm_apply_injective <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_inv_compose"><span class="command">lemma</span></span> preprm_inv_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_compose <span class="main">(</span>preprm_inv <span class="free">π</span><span class="main">)</span> <span class="free">π</span> <span class="keyword1">=p</span> preprm_id"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_inv_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">π</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preprm_ext_def preprm_id_def preprm_compose_def<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="main">(</span>rev <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span> <span class="keyword1">=p</span> preprm_id"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="main">(</span>rev <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=p</span> <span class="main">(</span>preprm_compose <span class="main">(</span>rev <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span>preprm_compose <span class="main">(</span>preprm_compose <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> preprm_compose_def <span class="keyword1"><span class="command">using</span></span> preprm_ext_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">=p</span> <span class="main">(</span>preprm_compose <span class="main">(</span>rev <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span>preprm_compose preprm_id <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> preprm_singleton_involution preprm_ext_compose_left preprm_ext_compose_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">=p</span> <span class="main">(</span>preprm_compose <span class="main">(</span>rev <span class="skolem">ps</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> preprm_compose_def preprm_id_def <span class="keyword1"><span class="command">using</span></span> preprm_ext_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="keyword1">=p</span> preprm_id"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> preprm_ext_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-preprm_inv_involution"><span class="command">lemma</span></span> preprm_inv_involution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_inv <span class="main">(</span>preprm_inv <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-preprm_inv_ext"><span class="command">lemma</span></span> preprm_inv_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="keyword1">=p</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"preprm_inv <span class="free">π</span> <span class="keyword1">=p</span> preprm_inv <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="main">(</span>preprm_inv <span class="main">(</span>preprm_inv <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preprm_inv <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=p</span> preprm_id"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="main">(</span>preprm_inv <span class="main">(</span>preprm_inv <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>preprm_inv <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=p</span> preprm_id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preprm_inv_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="free">π</span> <span class="main">(</span>preprm_inv <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=p</span> preprm_id"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="free">σ</span> <span class="main">(</span>preprm_inv <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=p</span> preprm_id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preprm_inv_involution <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>preprm_compose <span class="free">π</span> <span class="main">(</span>preprm_inv <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">=p</span> <span class="main">(</span>preprm_compose <span class="free">σ</span> <span class="main">(</span>preprm_inv <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preprm_ext_transitive preprm_ext_symmetric <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"preprm_inv <span class="free">π</span> <span class="keyword1">=p</span> preprm_inv <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> preprm_ext_uncompose assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="tfree">'a</span> prm <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> preprm"</span></span> <span class="main">/</span> <span class="quoted">preprm_ext</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> equivpI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reflp preprm_ext"</span></span> <span class="keyword1"><span class="command">using</span></span> preprm_ext_reflp<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp preprm_ext"</span></span> <span class="keyword1"><span class="command">using</span></span> preprm_ext_symp<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp preprm_ext"</span></span> <span class="keyword1"><span class="command">using</span></span> preprm_ext_transp<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> prm_id <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ε</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">preprm_id</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> prm_apply <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 140<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">preprm_apply</span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def
<span class="keyword1"><span class="command">using</span></span> preprm_apply.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> prm_compose <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> prm"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋄</span>"</span> 145<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">preprm_compose</span>
<span class="keyword1"><span class="command">unfolding</span></span> preprm_ext_def
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> preprm_apply_composition<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> prm_unit <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> prm"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_ <span class="keyword1">↔</span> _<span class="keyword1">]</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">preprm_unit</span><span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> prm_inv <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> prm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">preprm_inv</span>
<span class="keyword1"><span class="command">using</span></span> preprm_inv_ext<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Permutation-prm_apply_composition"><span class="command">lemma</span></span> prm_apply_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⋄</span> <span class="free">g</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">$</span> <span class="main">(</span><span class="free">g</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_apply_composition<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_apply_unequal"><span class="command">lemma</span></span> prm_apply_unequal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">π</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">$</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">π</span> <span class="main">$</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_apply_unequal<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_unit_equal_id"><span class="command">lemma</span></span> prm_unit_equal_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">a</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_unit_equal_id<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_unit_inaction"><span class="command">lemma</span></span> prm_unit_inaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_unit_inaction<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_unit_action"><span class="command">lemma</span></span> prm_unit_action<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_unit_action<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_unit_commutes"><span class="command">lemma</span></span> prm_unit_commutes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">b</span> <span class="main">↔</span> <span class="free">a</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_unit_commutes<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_unit_involution"><span class="command">lemma</span></span> prm_unit_involution<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_unit_involution<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_apply_id"><span class="command">lemma</span></span> prm_apply_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">$</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_apply_id<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_apply_injective"><span class="command">lemma</span></span> prm_apply_injective<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>prm_apply <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_apply_injective<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_inv_compose"><span class="command">lemma</span></span> prm_inv_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>prm_inv <span class="free">π</span><span class="main">)</span> <span class="main">⋄</span> <span class="free">π</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_inv_compose<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> <span class="quoted">"'a prm"</span><span class="main">:</span> semigroup <span class="quoted">prm_compose</span>
<span class="keyword1"><span class="command">unfolding</span></span> semigroup_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preprm_compose_def preprm_ext_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> <span class="quoted">"'a prm"</span><span class="main">:</span> group <span class="quoted">prm_compose</span> <span class="quoted">prm_id</span> <span class="quoted">prm_inv</span>
<span class="keyword1"><span class="command">unfolding</span></span> group_def group_axioms_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"semigroup <span class="main">(⋄)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"'a prm.semigroup_axioms"</span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">ε</span> <span class="main">⋄</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> preprm_id_def preprm_compose_def preprm_ext_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">.</span> prm_inv <span class="bound">a</span> <span class="main">⋄</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1">ε</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_inv_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semigroup <span class="main">(⋄)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">ε</span> <span class="main">⋄</span> <span class="bound">a</span> <span class="main">=</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">.</span> prm_inv <span class="bound">a</span> <span class="main">⋄</span> <span class="bound">a</span> <span class="main">=</span> <span class="keyword1">ε</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prm_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">{$}</span>"</span> 140<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prm_set</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> image <span class="main">(</span>prm_apply <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1" id="Permutation-prm_set_apply_compose"><span class="command">lemma</span></span> prm_set_apply_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">{$}</span> <span class="main">(</span><span class="free">σ</span> <span class="main">{$}</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋄</span> <span class="free">σ</span><span class="main">)</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="free">π</span> <span class="main">`</span> <span class="main">($)</span> <span class="free">σ</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">π</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">σ</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">π</span> <span class="main">$</span> <span class="main">(</span><span class="free">σ</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋄</span> <span class="free">σ</span><span class="main">)</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_apply_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋄</span> <span class="free">σ</span><span class="main">)</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="free">π</span> <span class="main">`</span> <span class="main">($)</span> <span class="free">σ</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">($)</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋄</span> <span class="free">σ</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-prm_set_membership"><span class="command">lemma</span></span> prm_set_membership<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">$</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">π</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-prm_set_notmembership"><span class="command">lemma</span></span> prm_set_notmembership<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">$</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">π</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_image_mem_iff prm_apply_injective<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_set_singleton"><span class="command">lemma</span></span> prm_set_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">{$}</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">π</span> <span class="main">$</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Permutation-prm_set_id"><span class="command">lemma</span></span> prm_set_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">{$}</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prm_set_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="keyword1">ε</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ε</span> <span class="main">$</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">($)</span> <span class="keyword1">ε</span> <span class="main">`</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-prm_set_unit_inaction"><span class="command">lemma</span></span> prm_set_unit_inaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">using</span></span> imageE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H inj_image_mem_iff prm_apply_injective prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_inaction <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-prm_set_unit_action"><span class="command">lemma</span></span> prm_set_unit_action<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">using</span></span> imageE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H inj_image_mem_iff prm_apply_injective prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_action <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_action <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> prm_set_membership <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_membership <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Permutation-prm_set_distributes_union"><span class="command">lemma</span></span> prm_set_distributes_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">{$}</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">{$}</span> <span class="free">S</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">π</span> <span class="main">{$}</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Permutation-prm_set_distributes_difference"><span class="command">lemma</span></span> prm_set_distributes_difference<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">{$}</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">{$}</span> <span class="free">S</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">π</span> <span class="main">{$}</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">using</span></span> prm_apply_injective image_set_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prm_disagreement</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ds</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prm_disagreement</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">$</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">$</span> <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Permutation-prm_disagreement_ext"><span class="command">lemma</span></span> prm_disagreement_ext<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="free">π</span> <span class="free">σ</span> <span class="main">≡</span> <span class="free">π</span> <span class="main">$</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">σ</span> <span class="main">$</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> prm_disagreement_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Permutation-prm_disagreement_composition"><span class="command">lemma</span></span> prm_disagreement_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ds</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="free">b</span> <span class="main">↔</span> <span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">c</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> prm_disagreement_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_disagreement_composition<span class="main">)</span>

<span class="keyword1" id="Permutation-prm_compose_push"><span class="command">lemma</span></span> prm_compose_push<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋄</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">π</span> <span class="main">$</span> <span class="free">a</span> <span class="main">↔</span> <span class="free">π</span> <span class="main">$</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋄</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> preprm_compose_push<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PreSimplyTyped">
<div class="head">
<h1>Theory PreSimplyTyped</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> PreSimplyTyped
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Fresh.html">Fresh</a> <a href="Permutation.html">Permutation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tvar <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">datatype</span></span> type <span class="main">=</span>
  TUnit
<span class="main">|</span> TVar <span class="quoted">tvar</span>
<span class="main">|</span> TArr <span class="quoted">type</span> <span class="quoted">type</span>
<span class="main">|</span> TPair <span class="quoted">type</span> <span class="quoted">type</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> ptrm <span class="main">=</span>
  PUnit
<span class="main">|</span> PVar <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="main">|</span> PApp <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
<span class="main">|</span> PFn <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted">type</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
<span class="main">|</span> PPair <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
<span class="main">|</span> PFst <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
<span class="main">|</span> PSnd <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ptrm_fvs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> PUnit <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> <span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> <span class="main">(</span>PApp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> <span class="main">(</span>PPair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> <span class="main">(</span>PFst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_fvs</span> <span class="main">(</span>PSnd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ptrm_fvs</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ptrm_apply_prm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> ptrm <span class="main">⇒</span> <span class="tfree">'a</span> ptrm"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">∙</span>"</span> 150<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> PUnit <span class="main">=</span> PUnit"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> PVar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PApp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> PApp <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> PFn <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PPair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> PPair <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PFst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> PFst <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>PSnd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> PSnd <span class="main">(</span><span class="free">ptrm_apply_prm</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ptrm_alpha_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm <span class="main">⇒</span> <span class="tfree">'a</span> ptrm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≈</span>"</span> 100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  unit<span class="main">:</span>       <span class="quoted"><span class="quoted">"PUnit <span class="main"><span class="free">≈</span></span> PUnit"</span></span>
<span class="main">|</span> var<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">≈</span></span> <span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>PApp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main"><span class="free">≈</span></span> <span class="main">(</span>PApp <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fn1<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main"><span class="free">≈</span></span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fn2<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">↔</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">∙</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> ptrm_fvs <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main"><span class="free">≈</span></span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair<span class="main">:</span>       <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>PPair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="main"><span class="free">≈</span></span> <span class="main">(</span>PPair <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> PFst <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> PFst <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
<span class="main">|</span> snd<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> PSnd <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">≈</span></span> PSnd <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> unitE<span class="main">:</span> <span class="quoted"><span class="quoted">"PUnit <span class="main">≈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> varE<span class="main">:</span>  <span class="quoted"><span class="quoted">"PVar <span class="free">x</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> appE<span class="main">:</span>  <span class="quoted"><span class="quoted">"PApp <span class="free">A</span> <span class="free">B</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> fnE<span class="main">:</span>   <span class="quoted"><span class="quoted">"PFn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> pairE<span class="main">:</span> <span class="quoted"><span class="quoted">"PPair <span class="free">A</span> <span class="free">B</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> fstE<span class="main">:</span>  <span class="quoted"><span class="quoted">"PFst <span class="free">P</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> sndE<span class="main">:</span>  <span class="quoted"><span class="quoted">"PSnd <span class="free">P</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_prm_apply_id"><span class="command">lemma</span></span> ptrm_prm_apply_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_apply_id<span class="main">)</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_prm_apply_compose"><span class="command">lemma</span></span> ptrm_prm_apply_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">σ</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋄</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∙</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_apply_composition<span class="main">)</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_size_prm"><span class="command">lemma</span></span> ptrm_size_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">X</span> <span class="main">=</span> size <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_size_alpha_equiv"><span class="command">lemma</span></span> ptrm_size_alpha_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">X</span> <span class="main">=</span> size <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">A</span> <span class="main">=</span> size <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_size_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_fvs_finite"><span class="command">lemma</span></span> ptrm_fvs_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ptrm_fvs <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_prm_fvs"><span class="command">lemma</span></span> ptrm_prm_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PUnit<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> PVar <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span>PVar <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span>PApp <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∪</span> ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">A</span> <span class="main">∪</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PApp.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> <span class="main">(</span>ptrm_fvs <span class="skolem">A</span> <span class="main">∪</span> ptrm_fvs <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_distributes_union <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span>PFn <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PFn.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">A</span> <span class="main">-</span> <span class="free">π</span> <span class="main">{$}</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> <span class="main">(</span>ptrm_fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_distributes_difference <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> ptrm_fvs <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> prm_set_distributes_union ptrm_apply_prm.simps<span class="main">(</span>5<span class="main">)</span> ptrm_fvs.simps<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_alpha_equiv_fvs"><span class="command">lemma</span></span> ptrm_alpha_equiv_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="free">X</span> <span class="main">=</span> ptrm_fvs <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="main">(</span>PFn <span class="skolem">a</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> ptrm_fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span><span class="main">[</span><span class="skolem">a</span> <span class="main">↔</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fn2.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">a</span> <span class="main">↔</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">B</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">↔</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">b</span> <span class="main">↔</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> prm_set_unit_action <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> Diff_insert0 Diff_insert2 Un_insert_right insert_Diff1 insert_is_Un singletonI
              sup_bot.right_neutral <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> <span class="comment1">(* why?! *)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span> <span class="main">↔</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">=</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> prm_set_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span>PFn <span class="skolem">b</span> <span class="skolem">T</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_alpha_equiv_prm"><span class="command">lemma</span></span> ptrm_alpha_equiv_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">π</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unit<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.var <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn1 <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">≠</span> <span class="free">π</span> <span class="main">$</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> prm_apply_unequal <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="main">(</span><span class="free">π</span> <span class="main">∙</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> imageE prm_apply_unequal prm_set_def ptrm_prm_fvs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">a</span> <span class="main">↔</span> <span class="free">π</span> <span class="main">$</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">π</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fn2.IH prm_compose_push ptrm_prm_apply_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_swp_transfer"><span class="command">lemma</span></span> ptrm_swp_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_prm ptrm_prm_apply_compose prm_unit_involution <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="keyword1">ε</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_prm ptrm_prm_apply_compose prm_unit_involution <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword2"><span class="keyword">and</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span> <span class="main">⟷</span> <span class="free">X</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_alpha_equiv_fvs_transfer"><span class="command">lemma</span></span> ptrm_alpha_equiv_fvs_transfer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> ptrm_fvs <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">≈</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">A</span> <span class="main">≈</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_swp_transfer <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="free">B</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_fvs ptrm_prm_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">∉</span> ptrm_fvs <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prm_set_notmembership prm_unit_action <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_apply_compose prm_unit_involution prm_set_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_prm_agreement_equiv"><span class="command">lemma</span></span> ptrm_prm_agreement_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> ptrm_fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">∙</span> <span class="free">M</span> <span class="main">≈</span> <span class="free">σ</span> <span class="main">∙</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PUnit<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PVar.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_disagreement_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.var <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_disagreement_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PFn.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> PFn.IH * ptrm_alpha_equiv.fn1 ptrm_apply_prm.simps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_disagreement_def CollectD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="main">(</span><span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>ptrm_fvs <span class="skolem">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
            <span class="keyword1"><span class="command">using</span></span> PFn <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span>›</span></span> prm_apply_unequal prm_disagreement_ext ptrm_fvs.simps<span class="main">(</span>4<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff empty_iff insert_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">σ</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prm_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="main">(</span><span class="main">[</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋄</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
            <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="main">(</span><span class="main">[</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋄</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">σ</span> <span class="main">$</span> <span class="skolem">x</span>›</span></span>
              <span class="keyword1"><span class="command">using</span></span> prm_apply_composition prm_disagreement_ext prm_unit_action prm_unit_commutes
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> * prm_apply_composition prm_apply_unequal prm_disagreement_ext prm_unit_inaction
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> PFn.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> PFn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_prm_apply_compose<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>    
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">∙</span> <span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">σ</span> <span class="main">∙</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_prm_unit_inaction"><span class="command">lemma</span></span> ptrm_prm_unit_inaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> ptrm_fvs <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="keyword1">ε</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> ptrm_fvs <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="keyword1">ε</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">ε</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prm_disagreement_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prm_apply_id prm_unit_inaction <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span> <span class="main">≈</span> <span class="keyword1">ε</span> <span class="main">∙</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ptrm_prm_agreement_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_alpha_equiv_reflexive"><span class="command">lemma</span></span> ptrm_alpha_equiv_reflexive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≈</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv.intros<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> ptrm_alpha_equiv_reflp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reflp ptrm_alpha_equiv"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> reflp_def <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_alpha_equiv_symmetric"><span class="command">lemma</span></span> ptrm_alpha_equiv_symmetric<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≈</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv.intros<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">b</span> <span class="main">↔</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">a</span> <span class="main">↔</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">A</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ptrm_swp_transfer prm_unit_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">a</span> <span class="main">↔</span> <span class="skolem">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">≠</span> <span class="skolem">b</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_fvs_transfer <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">≠</span> <span class="skolem">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">b</span> <span class="main">↔</span> <span class="skolem">a</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ptrm_alpha_equiv_symp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"symp ptrm_alpha_equiv"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> symp_def <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_symmetric <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PreSimplyTyped-ptrm_alpha_equiv_transitive"><span class="command">lemma</span></span> ptrm_alpha_equiv_transitive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≈</span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"size <span class="free">X</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">Z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">K</span> <span class="bound">Y</span> <span class="bound">Z</span> <span class="main">::</span> <span class="tfree">'a</span> ptrm<span class="main">.</span> size <span class="bound">K</span> <span class="main">&lt;</span> size <span class="skolem">X</span> <span class="main">⟹</span> <span class="bound">K</span> <span class="main">≈</span> <span class="bound">Y</span> <span class="main">⟹</span> <span class="bound">Y</span> <span class="main">≈</span> <span class="bound">Z</span> <span class="main">⟹</span> <span class="bound">K</span> <span class="main">≈</span> <span class="bound">Z</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Z</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PUnit<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PUnit"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PUnit"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.unit <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PUnit›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PVar <span class="skolem">x</span> <span class="main">≈</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PVar <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PVar <span class="skolem">x</span> <span class="main">≈</span> <span class="skolem">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PVar <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.var <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PVar <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PApp <span class="skolem">C</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">D</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> appE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PApp <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">≈</span> <span class="skolem">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PApp <span class="skolem">E</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≈</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≈</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">A</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">B</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≈</span> <span class="skolem">E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">D</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">≈</span> <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Z</span> <span class="main">=</span> PApp <span class="skolem">E</span> <span class="skolem">F</span>›</span></span> ptrm_alpha_equiv.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span><span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">A</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PFn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Y_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fnE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PFn <span class="skolem">z</span> <span class="skolem">T</span> <span class="skolem">C</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> Z_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fnE <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> PFn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">C</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">C</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Y_cases Z_cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> IH * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> X Z
            <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> IH * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> X Z
            <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> ptrm_alpha_equiv_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> IH *
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> ptrm_alpha_equiv_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> X Z
            <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 4
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> ptrm_alpha_equiv_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>›</span></span> IH * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_apply_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="keyword1">ε</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> prm_unit_involution <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> X Z
            <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 5
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_fvs <span class="skolem">B</span> <span class="main">=</span> ptrm_fvs <span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_fvs <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> 1
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">C</span> <span class="main">=</span> ptrm_fvs <span class="skolem">C</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">z</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> prm_set_unit_action prm_unit_commutes
                  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">z</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">z</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 2
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">C</span> <span class="main">=</span> ptrm_fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_set_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">{$}</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IH * <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> ptrm_alpha_equiv_prm ptrm_prm_apply_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ds</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> prm_disagreement_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> Diff_iff Diff_insert_absorb insert_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_prm_agreement_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">qed</span></span>

            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH *
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋄</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">∙</span> <span class="skolem">C</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">C</span>›</span></span> X Z
            <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PPair <span class="skolem">C</span> <span class="skolem">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">D</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pairE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"PPair <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">≈</span> <span class="skolem">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PPair <span class="skolem">E</span> <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≈</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">≈</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">A</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">B</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">E</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">≈</span> <span class="skolem">E</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">≈</span> <span class="skolem">D</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">≈</span> <span class="skolem">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Z</span> <span class="main">=</span> PPair <span class="skolem">E</span> <span class="skolem">F</span>›</span></span> ptrm_alpha_equiv.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PFst <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fstE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PFst <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PFst <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fstE <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> PFst <span class="skolem">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PFst <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">≈</span> <span class="skolem">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PFst <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Z</span> <span class="main">=</span> PFst <span class="skolem">R</span>›</span></span> ptrm_alpha_equiv.fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> PSnd <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sndE <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PSnd <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">≈</span> <span class="skolem">Y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> PSnd <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sndE <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> PSnd <span class="skolem">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">≈</span> <span class="skolem">Z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">P</span> <span class="main">&lt;</span> size <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PSnd <span class="skolem">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">≈</span> <span class="skolem">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Q</span> <span class="main">≈</span> <span class="skolem">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> PSnd <span class="skolem">P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Z</span> <span class="main">=</span> PSnd <span class="skolem">R</span>›</span></span> ptrm_alpha_equiv.snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> ptrm_alpha_equiv_transp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"transp ptrm_alpha_equiv"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> transp_def <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> typing_ctx <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇀</span> type"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ptrm_infer_type</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> typing_ctx <span class="main">⇒</span> <span class="tfree">'a</span> ptrm <span class="main">⇒</span> type option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> PUnit <span class="main">=</span> Some TUnit"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>PVar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>PApp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
     <span class="main">(</span>Some <span class="main">(</span>TArr <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">τ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">τ</span> <span class="main">=</span> <span class="bound">τ'</span> <span class="keyword1">then</span> Some <span class="bound">σ</span> <span class="keyword1">else</span> None<span class="main">)</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
   <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>PFn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ptrm_infer_type</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">of</span>
     Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="bound">σ</span><span class="main">)</span>
   <span class="main">|</span> None <span class="main">⇒</span> None
   <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>PPair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
     <span class="main">(</span>Some <span class="bound">τ</span><span class="main">,</span> Some <span class="bound">σ</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
   <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>PFst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">of</span>
     <span class="main">(</span>Some <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">τ</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
   <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>PSnd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ptrm_infer_type</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">of</span>
     <span class="main">(</span>Some <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">σ</span>
   <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
   <span class="main">)</span>"</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_infer_type_swp_types"><span class="command">lemma</span></span> ptrm_infer_type_swp_types<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PUnit<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_action<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> prm_unit_action prm_unit_commutes fun_upd_same fun_upd_twist
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ptrm_apply_prm.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> ptrm_infer_type.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>

      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_inaction<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span>
      <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span> <span class="skolem">S</span> <span class="skolem">Γ</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span>
          <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>
         <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="free">b</span> <span class="skolem">τ</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prm_unit_action ptrm_apply_prm.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_twist fun_upd_upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span>
          <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>
         <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="free">a</span> <span class="skolem">τ</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> prm_unit_action prm_unit_commutes ptrm_apply_prm.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fun_upd_upd fun_upd_twist <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span>
          <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>
         <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_inaction<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_infer_type_swp"><span class="command">lemma</span></span> ptrm_infer_type_swp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PUnit<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> PVar <span class="free">b</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prm_unit_action <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>

      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> PVar <span class="skolem">x</span> <span class="main">=</span> PVar <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> prm_unit_inaction <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="bound">σ</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="bound">σ</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
  
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">a</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PApp.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PApp.IH assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ptrm_apply_prm.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ptrm_infer_type.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">σ</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> PFn.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">τ</span> <span class="bound">Γ</span><span class="main">.</span> ptrm_infer_type <span class="main">(</span><span class="bound">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="bound">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> PFn.IH assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">σ</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="free">a</span> <span class="skolem">σ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"
              ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> PFn <span class="skolem">x</span> <span class="skolem">σ</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span>
              ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="free">b</span> <span class="skolem">σ</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_action<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * ptrm_infer_type.simps<span class="main">(</span>4<span class="main">)</span> fun_upd_upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
  
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">hence</span></span>
              <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> PFn <span class="skolem">x</span> <span class="skolem">σ</span> <span class="skolem">A</span><span class="main">)</span>
             <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">σ</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_inaction<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ'</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">σ</span><span class="main">,</span> <span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ'</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">σ</span><span class="main">,</span> <span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ'</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">σ'</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="bound">σ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">σ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>

      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
          ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span>
          ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">A</span><span class="main">)</span>
        "</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_infer_type_swp_types <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">b</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> prm_unit_action prm_unit_commutes
          <span class="keyword1"><span class="command">using</span></span> ptrm_infer_type.simps<span class="main">(</span>4<span class="main">)</span> ptrm_apply_prm.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="PreSimplyTyped-ptrm_infer_type_alpha_equiv"><span class="command">lemma</span></span> ptrm_infer_type_alpha_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≈</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="free">Γ</span> <span class="free">X</span> <span class="main">=</span> ptrm_infer_type <span class="free">Γ</span> <span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn2 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">T</span> <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">a</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">b</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ptrm_infer_type_swp prm_unit_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="SimplyTyped">
<div class="head">
<h1>Theory SimplyTyped</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> SimplyTyped
<span class="keyword2"><span class="keyword">imports</span></span> <a href="PreSimplyTyped.html">PreSimplyTyped</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="tfree">'a</span> trm <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span> <span class="main">/</span> <span class="quoted">ptrm_alpha_equiv</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> equivpI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reflp  ptrm_alpha_equiv"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_reflp<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp   ptrm_alpha_equiv"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_symp<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp ptrm_alpha_equiv"</span></span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_transp<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> Unit <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PUnit</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Var <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PVar</span><span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> App <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PApp</span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.app<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Fn  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> type <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PFn</span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fn1<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Pair <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PPair</span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.pair<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Fst <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PFst</span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.fst<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> Snd <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">PSnd</span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv.snd<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> fvs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">ptrm_fvs</span> <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_fvs<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> prm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 150<span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">ptrm_apply_prm</span>
  <span class="keyword1"><span class="command">using</span></span> ptrm_alpha_equiv_prm<span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> depth <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">size</span> <span class="keyword1"><span class="command">using</span></span> ptrm_size_alpha_equiv<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="SimplyTyped-depth_prm"><span class="command">lemma</span></span> depth_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"depth <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> depth <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_size_prm<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-depth_app"><span class="command">lemma</span></span> depth_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">B</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="SimplyTyped-depth_fn"><span class="command">lemma</span></span> depth_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-depth_pair"><span class="command">lemma</span></span> depth_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">B</span> <span class="main">&lt;</span> depth <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="SimplyTyped-depth_fst"><span class="command">lemma</span></span> depth_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">P</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-depth_snd"><span class="command">lemma</span></span> depth_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"depth <span class="free">P</span> <span class="main">&lt;</span> depth <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  
<span class="keyword1" id="SimplyTyped-unit_not_var"><span class="command">lemma</span></span> unit_not_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">≠</span> Var <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PUnit <span class="main">≈</span> PVar <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> PUnit <span class="main">≈</span> PVar <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-unit_not_app"><span class="command">lemma</span></span> unit_not_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">≠</span> App <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PUnit <span class="main">≈</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> PUnit <span class="main">≈</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-unit_not_fn"><span class="command">lemma</span></span> unit_not_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">≠</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PUnit <span class="main">≈</span> PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> PUnit <span class="main">≈</span> PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-unit_not_pair"><span class="command">lemma</span></span> unit_not_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">≠</span> Pair <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PUnit <span class="main">≈</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> PUnit <span class="main">≈</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-unit_not_fst"><span class="command">lemma</span></span> unit_not_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">≠</span> Fst <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PUnit <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> PUnit <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-unit_not_snd"><span class="command">lemma</span></span> unit_not_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">≠</span> Snd <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> PUnit <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span> PUnit <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-var_not_app"><span class="command">lemma</span></span> var_not_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">≠</span> App <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PApp <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-var_not_fn"><span class="command">lemma</span></span> var_not_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">≠</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PFn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PFn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-var_not_pair"><span class="command">lemma</span></span> var_not_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">≠</span> Pair <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PPair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-var_not_fst"><span class="command">lemma</span></span> var_not_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">≠</span> Fst <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-var_not_snd"><span class="command">lemma</span></span> var_not_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">≠</span> Snd <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PVar <span class="skolem">x</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-app_not_fn"><span class="command">lemma</span></span> app_not_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">≠</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">T</span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PFn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PFn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-app_not_pair"><span class="command">lemma</span></span> app_not_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">≠</span> Pair <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PPair <span class="skolem">C</span> <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PPair <span class="skolem">C</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-app_not_fst"><span class="command">lemma</span></span> app_not_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">≠</span> Fst <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-app_not_snd"><span class="command">lemma</span></span> app_not_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">≠</span> Snd <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PApp <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-fn_not_pair"><span class="command">lemma</span></span> fn_not_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">≠</span> Pair <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">C</span> <span class="skolem">D</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PPair <span class="skolem">C</span> <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PPair <span class="skolem">C</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-fn_not_fst"><span class="command">lemma</span></span> fn_not_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">≠</span> Fst <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-fn_not_snd"><span class="command">lemma</span></span> fn_not_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">≠</span> Snd <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-pair_not_fst"><span class="command">lemma</span></span> pair_not_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pair <span class="free">A</span> <span class="free">B</span> <span class="main">≠</span> Fst <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PPair <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PPair <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PFst <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-pair_not_snd"><span class="command">lemma</span></span> pair_not_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Pair <span class="free">A</span> <span class="free">B</span> <span class="main">≠</span> Snd <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PPair <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PPair <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">≈</span> PSnd <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-fst_not_snd"><span class="command">lemma</span></span> fst_not_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fst <span class="free">P</span> <span class="main">≠</span> Snd <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>PFst <span class="skolem">P</span> <span class="main">≈</span> PSnd <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span>PFst <span class="skolem">P</span> <span class="main">≈</span> PSnd <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-trm_simp"><span class="command">lemma</span></span> trm_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">=</span> Var <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> App <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
    <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> App <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">S</span> <span class="free">B</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="free">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"Pair <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> Pair <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
    <span class="quoted"><span class="quoted">"Pair <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> Pair <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
    <span class="quoted"><span class="quoted">"Fst <span class="free">P</span> <span class="main">=</span> Fst <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span>
    <span class="quoted"><span class="quoted">"Snd <span class="free">P</span> <span class="main">=</span> Snd <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Var <span class="free">x</span> <span class="main">=</span> Var <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject varE<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> App <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject appE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"App <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> App <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject appE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pair <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> Pair <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject pairE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Pair <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> Pair <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject pairE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fst <span class="free">P</span> <span class="main">=</span> Fst <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject fstE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Snd <span class="free">P</span> <span class="main">=</span> Snd <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> ptrm.inject sndE<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">S</span> <span class="free">B</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="free">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted">type</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">≈</span> PFn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="skolem">B</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">∉</span> ptrm_fvs <span class="skolem">B</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">≈</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">∙</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fnE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">T</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"PFn <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">B</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> *<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">C</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">z</span> <span class="skolem">C</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-fn_eq"><span class="command">lemma</span></span> fn_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="free">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_alpha_equiv.fn2<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_prm_simp"><span class="command">lemma</span></span> trm_prm_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> Unit <span class="main">=</span> Unit"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> Var <span class="free">x</span> <span class="main">=</span> Var <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> App <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> App <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="free">T</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> Pair <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> Pair <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> Fst <span class="free">P</span> <span class="main">=</span> Fst <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> Snd <span class="free">P</span> <span class="main">=</span> Snd <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv_reflexive<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv_reflexive<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_alpha_equiv_reflexive<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-trm_prm_apply_compose"><span class="command">lemma</span></span> trm_prm_apply_compose<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋄</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_prm_apply_compose ptrm_alpha_equiv_reflexive<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-fvs_finite"><span class="command">lemma</span></span> fvs_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fvs <span class="free">M</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_fvs_finite<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-fvs_simp"><span class="command">lemma</span></span> fvs_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"fvs Unit <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"fvs <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"fvs <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> fvs <span class="free">A</span> <span class="main">∪</span> fvs <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"fvs <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> fvs <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"fvs <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> fvs <span class="free">A</span> <span class="main">∪</span> fvs <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"fvs <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="main">=</span> fvs <span class="free">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"fvs <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="main">=</span> fvs <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-var_prm_action"><span class="command">lemma</span></span> var_prm_action<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> Var <span class="free">a</span> <span class="main">=</span> Var <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_action ptrm_alpha_equiv.intros<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-var_prm_inaction"><span class="command">lemma</span></span> var_prm_inaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> Var <span class="free">x</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_inaction ptrm_alpha_equiv.intros<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_prm_apply_id"><span class="command">lemma</span></span> trm_prm_apply_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">⋅</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ptrm_prm_apply_id<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_prm_unit_inaction"><span class="command">lemma</span></span> trm_prm_unit_inaction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> fvs <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> fvs <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer'</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_prm_unit_inaction<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_prm_agreement_equiv"><span class="command">lemma</span></span> trm_prm_agreement_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="keyword1">ds</span> <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="free">M</span> <span class="main">=</span> <span class="free">σ</span> <span class="main">⋅</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_prm_agreement_equiv<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_induct"><span class="command">lemma</span></span> trm_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> Unit"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>App <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="bound">A</span><span class="main">;</span> <span class="free">P</span> <span class="bound">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Fst <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Snd <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ptrm.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_trm PUnit<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Unit.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_trm <span class="main">(</span>PVar <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> Var.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">A</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">B</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> App.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> Fn.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">A</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">B</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> Pair.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="main">(</span>PFst <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> Fst.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>abs_trm <span class="skolem">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>abs_trm <span class="main">(</span>PSnd <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> Snd.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm.abs_induct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-trm_cases"><span class="command">lemma</span></span> trm_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> Unit <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> Var <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> App <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> Fst <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> Snd <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_depth_induct"><span class="command">lemma</span></span> trm_depth_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> Unit"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>App <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fst <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Fst <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Snd <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Snd <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"depth <span class="free">M</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"depth <span class="skolem">K</span> <span class="main">&lt;</span> depth <span class="skolem">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">K</span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"         <span class="skolem">M</span> <span class="main">=</span> Unit <span class="main">⟹</span>    <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span>     <span class="skolem">M</span> <span class="main">=</span> Var <span class="bound">x</span> <span class="main">⟹</span>    <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>   <span class="skolem">M</span> <span class="main">=</span> App <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>   <span class="skolem">M</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span>     <span class="skolem">M</span> <span class="main">=</span> Fst <span class="bound">A</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span>     <span class="skolem">M</span> <span class="main">=</span> Snd <span class="bound">A</span> <span class="main">⟹</span>  <span class="free">P</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_cases<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> fresh <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="SimplyTyped-fresh_fn"><span class="command">lemma</span></span> fresh_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span> <span class="main">↔</span> <span class="free">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">∧</span> <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="bound">y</span> <span class="free">T</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">A</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> fresh_in <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">A</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">A</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh_axioms * <span class="keyword1"><span class="command">unfolding</span></span> class.fresh_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="free">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="free">T</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fn_eq <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> <span class="free">S</span>›</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-trm_strong_induct"><span class="command">lemma</span></span> trm_strong_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> Unit"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="free">S</span> <span class="bound">A</span><span class="main">;</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>App <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="free">P</span> <span class="free">S</span> <span class="bound">A</span><span class="main">;</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">B</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Fst <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Snd <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">π</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span><span class="bound">π</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> trm_prm_simp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> trm_prm_simp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> trm_prm_simp<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> fresh_in <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">∪</span> fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh_axioms <span class="keyword1"><span class="command">unfolding</span></span> class.fresh_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="bound">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋄</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋄</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋄</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Fn <span class="main">(</span><span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trm_prm_apply_compose fn_eq <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">π</span> <span class="main">$</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="main">(</span><span class="skolem">π</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> trm_prm_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">A</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> trm_prm_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">A</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> trm_prm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="main">(</span><span class="keyword1">ε</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-trm_strong_cases"><span class="command">lemma</span></span> trm_strong_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"         <span class="free">M</span> <span class="main">=</span> Unit    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span>     <span class="free">M</span> <span class="main">=</span> Var <span class="bound">x</span>    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>   <span class="free">M</span> <span class="main">=</span> App <span class="bound">A</span> <span class="bound">B</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="free">M</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>   <span class="free">M</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span>     <span class="free">M</span> <span class="main">=</span> Fst <span class="bound">A</span>    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span>     <span class="free">M</span> <span class="main">=</span> Snd <span class="bound">A</span>    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-trm_strong_depth_induct"><span class="command">lemma</span></span> trm_strong_depth_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> Unit"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>App <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">K</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fst <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Fst <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="main">⟦</span><span class="main">⋀</span><span class="bound">K</span><span class="main">.</span> depth <span class="bound">K</span> <span class="main">&lt;</span> depth <span class="main">(</span>Snd <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="bound">K</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="main">(</span>Snd <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"depth <span class="free">M</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"depth <span class="skolem">K</span> <span class="main">&lt;</span> depth <span class="skolem">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">K</span>
  <span class="keyword1"><span class="command">hence</span></span>
    <span class="quoted"><span class="quoted">"         <span class="skolem">M</span> <span class="main">=</span> Unit    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span>     <span class="skolem">M</span> <span class="main">=</span> Var <span class="bound">x</span>    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>   <span class="skolem">M</span> <span class="main">=</span> App <span class="bound">A</span> <span class="bound">B</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">M</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span>   <span class="skolem">M</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span>     <span class="skolem">M</span> <span class="main">=</span> Fst <span class="bound">A</span>    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span>     <span class="skolem">M</span> <span class="main">=</span> Snd <span class="bound">A</span>    <span class="main">⟹</span> <span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">S</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_strong_cases<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">M</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-trm_prm_fvs"><span class="command">lemma</span></span> trm_prm_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> <span class="free">π</span> <span class="main">{$}</span> fvs <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ptrm_prm_fvs<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">typing</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> typing_ctx <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> type <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊢</span> _ <span class="keyword1">:</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  tunit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Unit <span class="main"><span class="free">:</span></span> TUnit"</span></span>
<span class="main">|</span> tvar<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>
<span class="main">|</span> tapp<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>TArr <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> App <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>
<span class="main">|</span> tfn<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">)</span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>TArr <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> tpair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>TPair <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> tfst<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>TPair <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span>"</span></span>
<span class="main">|</span> tsnd<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">:</span></span> <span class="main">(</span>TPair <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main"><span class="free">⊢</span></span> Snd <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">:</span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>"</span></span>

<span class="keyword1" id="SimplyTyped-typing_prm"><span class="command">lemma</span></span> typing_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> fvs <span class="free">M</span> <span class="main">⟹</span> <span class="free">Γ</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">Δ</span> <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">⊢</span> <span class="free">π</span> <span class="main">⋅</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tunit <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tunit trm_prm_simp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tvar <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tvar trm_prm_simp<span class="main">(</span>2<span class="main">)</span> fvs_simp<span class="main">(</span>2<span class="main">)</span> singletonI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tapp <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="skolem">τ</span> <span class="skolem">σ</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tapp trm_prm_simp<span class="main">(</span>3<span class="main">)</span> fvs_simp<span class="main">(</span>3<span class="main">)</span> UnCI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfn <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fvs <span class="skolem">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Δ</span><span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fun_upd_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fvs <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fvs <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> DiffI singletonD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">Δ</span> <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tfn.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_apply_unequal<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span><span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">π</span> <span class="main">⋅</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tfn.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>4<span class="main">)</span> typing.tfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tpair <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tpair trm_prm_simp<span class="main">(</span>5<span class="main">)</span> fvs_simp<span class="main">(</span>5<span class="main">)</span> UnCI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfst <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfst trm_prm_simp<span class="main">(</span>6<span class="main">)</span> fvs_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tsnd <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tsnd trm_prm_simp<span class="main">(</span>7<span class="main">)</span> fvs_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-typing_swp"><span class="command">lemma</span></span> typing_swp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fvs <span class="free">M</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>  <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fvs <span class="free">M</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">a</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>  <span class="main">=</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">b</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span> <span class="main">↔</span> <span class="free">b</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_action<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prm_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">b</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing_prm assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-typing_unitE"><span class="command">lemma</span></span> typing_unitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Unit <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> TUnit"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_not_var unit_not_app unit_not_fn unit_not_pair unit_not_fst unit_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-typing_varE"><span class="command">lemma</span></span> typing_varE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Var <span class="free">x</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> unit_not_var<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_not_app var_not_fn var_not_pair var_not_fst var_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-typing_appE"><span class="command">lemma</span></span> typing_appE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> App <span class="free">A</span> <span class="free">B</span> <span class="main">:</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="bound">τ</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 3
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> unit_not_app<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> var_not_app<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_not_fn app_not_pair app_not_fst app_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-typing_fnE"><span class="command">lemma</span></span> typing_fnE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">:</span> <span class="free">θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">θ</span> <span class="main">=</span> <span class="main">(</span>TArr <span class="free">T</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">:</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">B</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tfn typing_swp prm_unit_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> unit_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-typing_pairE"><span class="command">lemma</span></span> typing_pairE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Pair <span class="free">A</span> <span class="free">B</span> <span class="main">:</span> <span class="free">θ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span> <span class="bound">σ</span><span class="main">.</span> <span class="free">θ</span> <span class="main">=</span> <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">A</span> <span class="main">:</span> <span class="bound">τ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">:</span> <span class="bound">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tpair <span class="skolem">A</span> <span class="skolem">τ</span> <span class="skolem">B</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>5<span class="main">)</span> trm_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> unit_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-typing_fstE"><span class="command">lemma</span></span> typing_fstE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Fst <span class="free">P</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="free">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfst <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> unit_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-typing_sndE"><span class="command">lemma</span></span> typing_sndE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> Snd <span class="free">P</span> <span class="main">:</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">τ</span><span class="main">.</span> <span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">P</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="bound">τ</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tsnd <span class="skolem">P</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> unit_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> typing_weaken<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tunit <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tunit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tvar <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>2<span class="main">)</span> singletonI <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tvar.hyps fun_upd_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tapp <span class="skolem">Γ</span> <span class="skolem">f</span> <span class="skolem">τ</span> <span class="skolem">τ'</span> <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>App <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> Un_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">f</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tapp.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tapp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfn <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span> <span class="skolem">τ'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> DiffI empty_iff insert_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tfn.hyps fun_upd_upd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">,</span> <span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tfn.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">y</span> <span class="main">↦</span> <span class="free">σ</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tpair <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="skolem">τ</span> <span class="skolem">B</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tpair fvs_simp<span class="main">(</span>5<span class="main">)</span> UnCI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfst <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfst fvs_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tsnd <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tsnd fvs_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lift_definition</span></span> infer <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> typing_ctx <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> type option"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">ptrm_infer_type</span>
<span class="keyword1"><span class="command">using</span></span> ptrm_infer_type_alpha_equiv<span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">infer</span></span> <span class="quoted"><span class="quoted">fresh_nat_inst.fresh_in_nat</span></span> <span class="keyword2"><span class="keyword">in</span></span> Haskell

<span class="keyword1" id="SimplyTyped-infer_simp"><span class="command">lemma</span></span> infer_simp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> Unit <span class="main">=</span> Some TUnit"</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">Γ</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>infer <span class="free">Γ</span> <span class="free">A</span><span class="main">,</span> infer <span class="free">Γ</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">of</span>
       <span class="main">(</span>Some <span class="main">(</span>TArr <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">,</span> Some <span class="bound">τ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">τ</span> <span class="main">=</span> <span class="bound">τ'</span> <span class="keyword1">then</span> Some <span class="bound">σ</span> <span class="keyword1">else</span> None<span class="main">)</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
     <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Fn <span class="free">x</span> <span class="free">τ</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> infer <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="keyword1">of</span>
       Some <span class="bound">σ</span> <span class="main">⇒</span> Some <span class="main">(</span>TArr <span class="free">τ</span> <span class="bound">σ</span><span class="main">)</span>
     <span class="main">|</span> None <span class="main">⇒</span> None
    <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span>infer <span class="free">Γ</span> <span class="free">A</span><span class="main">,</span> infer <span class="free">Γ</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">of</span>
       <span class="main">(</span>Some <span class="bound">τ</span><span class="main">,</span> Some <span class="bound">σ</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
     <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> infer <span class="free">Γ</span> <span class="free">P</span> <span class="keyword1">of</span>
       <span class="main">(</span>Some <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">τ</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
     <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> infer <span class="free">Γ</span> <span class="free">P</span> <span class="keyword1">of</span>
       <span class="main">(</span>Some <span class="main">(</span>TPair <span class="bound">τ</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="bound">σ</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None
     <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-infer_unitE"><span class="command">lemma</span></span> infer_unitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> Unit <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> TUnit"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-infer_varE"><span class="command">lemma</span></span> infer_varE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-infer_appE"><span class="command">lemma</span></span> infer_appE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> infer <span class="free">Γ</span> <span class="free">A</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="bound">σ</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∧</span> infer <span class="free">Γ</span> <span class="free">B</span> <span class="main">=</span> Some <span class="bound">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Γ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> typing_ctx"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≠</span> TVar <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> TVar <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="main">(</span>TVar <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≠</span> TUnit"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> TUnit"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some TUnit"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≠</span> TPair <span class="skolem">τ</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">τ</span> <span class="skolem">σ</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">τ</span> <span class="skolem">σ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> TPair <span class="skolem">τ</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> TArr <span class="skolem">σ</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">T</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> Some <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">σ'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">≠</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PApp <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">τ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="bound">σ</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">∧</span> ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> Some <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-infer_fnE"><span class="command">lemma</span></span> infer_fnE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="free">τ</span> <span class="main">=</span> TArr <span class="free">T</span> <span class="bound">σ</span> <span class="main">∧</span> infer <span class="main">(</span><span class="free">Γ</span><span class="main">(</span><span class="free">x</span> <span class="main">↦</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> Some <span class="bound">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Γ</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PFn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="skolem">T</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> TArr <span class="skolem">T</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> <span class="skolem">τ</span> <span class="main">=</span> TArr <span class="skolem">T</span> <span class="bound">σ</span> <span class="main">∧</span> ptrm_infer_type <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="bound">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-infer_pairE"><span class="command">lemma</span></span> infer_pairE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">S</span><span class="main">.</span> <span class="free">τ</span> <span class="main">=</span> TPair <span class="bound">T</span> <span class="bound">S</span> <span class="main">∧</span> infer <span class="free">Γ</span> <span class="free">A</span> <span class="main">=</span> Some <span class="bound">T</span> <span class="main">∧</span> infer <span class="free">Γ</span> <span class="free">B</span> <span class="main">=</span> Some <span class="bound">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Γ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PPair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.case_eq_if<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">S</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> TPair <span class="skolem">T</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> Some <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">S</span><span class="main">.</span> <span class="skolem">τ</span> <span class="main">=</span> TPair <span class="bound">T</span> <span class="bound">S</span> <span class="main">∧</span> ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="bound">T</span> <span class="main">∧</span> ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> Some <span class="bound">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-infer_fstE"><span class="command">lemma</span></span> infer_fstE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">S</span><span class="main">.</span> infer <span class="free">Γ</span> <span class="free">P</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">=</span> <span class="bound">T</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Γ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> None"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> Some TUnit"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some TUnit"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> Some <span class="main">(</span>TVar <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TVar <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> Some <span class="main">(</span>TArr <span class="skolem">T</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span> <span class="skolem">S</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="skolem">T</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="skolem">T</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> type.distinct type.exhaust option.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PFst <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">S</span><span class="main">.</span> ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="bound">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-infer_sndE"><span class="command">lemma</span></span> infer_sndE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">S</span><span class="main">.</span> infer <span class="free">Γ</span> <span class="free">P</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">=</span> <span class="bound">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ptrm"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Γ</span> <span class="skolem">τ</span>
  <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> None"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> Some TUnit"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some TUnit"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> Some <span class="main">(</span>TVar <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TVar <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">≠</span> Some <span class="main">(</span>TArr <span class="skolem">T</span> <span class="skolem">S</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span> <span class="skolem">S</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="skolem">T</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="skolem">T</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> type.distinct type.exhaust option.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"ptrm_infer_type <span class="skolem">Γ</span> <span class="main">(</span>PSnd <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">T</span> <span class="bound">S</span><span class="main">.</span> ptrm_infer_type <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="main">=</span> Some <span class="main">(</span>TPair <span class="bound">T</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">τ</span> <span class="main">=</span> <span class="bound">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-infer_sound"><span class="command">lemma</span></span> infer_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="free">M</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> infer_unitE typing.tunit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> infer_varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹infer <span class="skolem">Γ</span> <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"infer <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infer <span class="skolem">Γ</span> <span class="skolem">B</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> infer_appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> typing.tapp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">Γ</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹infer <span class="skolem">Γ</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">τ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> TArr <span class="skolem">T</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infer <span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> infer_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> typing.tfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">Γ</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tpair infer_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span> <span class="skolem">Γ</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfst infer_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span> <span class="skolem">Γ</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing.tsnd infer_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-infer_complete"><span class="command">lemma</span></span> infer_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infer <span class="free">Γ</span> <span class="free">M</span> <span class="main">=</span> Some <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfn <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span> <span class="skolem">A</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infer_simp<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> tfn.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infer_simp<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> infer_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>infer <span class="free">Γ</span> <span class="free">M</span> <span class="main">=</span> Some <span class="free">τ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> infer_sound infer_complete <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">substitutes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">substitutes</span> Unit <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> Unit"</span></span>
<span class="main">|</span> var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>
<span class="main">|</span> var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fn<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∉</span> fvs <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> snd<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">substitutes</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟹</span> <span class="free">substitutes</span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SimplyTyped-substitutes_prm"><span class="command">lemma</span></span> substitutes_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unit <span class="skolem">y</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.unit trm_prm_simp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.var1 trm_prm_simp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.var2 trm_prm_simp<span class="main">(</span>2<span class="main">)</span> prm_apply_unequal <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.app trm_prm_simp<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">M</span> <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> substitutes.fn trm_prm_simp<span class="main">(</span>4<span class="main">)</span> prm_apply_unequal prm_set_notmembership trm_prm_fvs
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.pair trm_prm_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst <span class="skolem">P</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.fst trm_prm_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd <span class="skolem">P</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.snd trm_prm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-substitutes_fvs"><span class="command">lemma</span></span> substitutes_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="free">A'</span> <span class="main">⊆</span> fvs <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>unit <span class="skolem">y</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var1 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var2 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>2<span class="main">)</span> Un_subset_iff Un_upper2 insert_Diff_if insert_is_Un singletonD sup_commute
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">∪</span> fvs <span class="skolem">B'</span> <span class="main">⊆</span> <span class="main">(</span>fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">∪</span> fvs <span class="skolem">B'</span> <span class="main">⊆</span> <span class="main">(</span>fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">M</span> <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">y</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">∪</span> fvs <span class="skolem">B'</span> <span class="main">⊆</span> <span class="main">(</span>fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>fvs <span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">∪</span> fvs <span class="skolem">B'</span> <span class="main">⊆</span> <span class="main">(</span>fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst <span class="skolem">P</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd <span class="skolem">P</span> <span class="skolem">x</span> <span class="skolem">M</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_unitE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes Unit <span class="free">y</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_unitE"><span class="command">lemma</span></span> substitutes_unitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes Unit <span class="free">y</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Unit"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span>
  <span class="operator">rule</span> substitutes_unitE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_not_var unit_not_app unit_not_fn unit_not_pair unit_not_fst unit_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_varE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_varE"><span class="command">lemma</span></span> substitutes_varE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="free">y</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="free">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Var <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span>
  <span class="operator">rule</span> substitutes_varE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> unit_not_var<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_not_app var_not_fn var_not_pair var_not_fst var_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_appE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_appE"><span class="command">lemma</span></span> substitutes_appE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">A'</span> <span class="main">∧</span> substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">B'</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> App <span class="bound">A'</span> <span class="bound">B'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span>
  <span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitutes_appE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> unit_not_app<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_app<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_app<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_not_fn app_not_pair app_not_fst app_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_fnE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_fnE"><span class="command">lemma</span></span> substitutes_fnE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">A'</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="bound">A'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitutes_fnE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">z</span> <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="skolem">z</span> <span class="skolem">S</span> <span class="skolem">B</span>›</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> substitutes_prm <span class="quoted"><span class="quoted">‹substitutes <span class="skolem">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">$</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> prm_unit_inaction <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> trm_prm_unit_inaction <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">B'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span>
            substitutes_fvs <span class="quoted"><span class="quoted">‹substitutes <span class="skolem">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span>
            Diff_subset UnE rev_subsetD
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> Fn <span class="skolem">z</span> <span class="skolem">S</span> <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span> fn_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>      
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> unit_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_pairE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_pairE"><span class="command">lemma</span></span> substitutes_pairE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">A'</span> <span class="main">∧</span> substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">B'</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Pair <span class="bound">A'</span> <span class="bound">B'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitutes_pairE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>5<span class="main">)</span> trm_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> unit_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_fstE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_fstE"><span class="command">lemma</span></span> substitutes_fstE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Fst <span class="bound">P'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitutes_fstE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> unit_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> substitutes_sndE'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-substitutes_sndE"><span class="command">lemma</span></span> substitutes_sndE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">P'</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Snd <span class="bound">P'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> substitutes_sndE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">M</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> unit_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-substitutes_total"><span class="command">lemma</span></span> substitutes_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Unit"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> substitutes.var1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Var <span class="skolem">y</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> substitutes.var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> App <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A' B' substitutes.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.fn <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> A' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Pair <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> substitutes.pair <span class="quoted"><span class="quoted">‹substitutes <span class="skolem">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>›</span></span> <span class="quoted"><span class="quoted">‹substitutes <span class="skolem">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">P</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Fst <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.fst <span class="quoted"><span class="quoted">‹substitutes <span class="skolem">P</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="skolem">P</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Snd <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.snd <span class="quoted"><span class="quoted">‹substitutes <span class="skolem">P</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">P'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-substitutes_unique"><span class="command">lemma</span></span> substitutes_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">X</span> <span class="skolem">Y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">y</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 substitutes_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-substitutes_function"><span class="command">lemma</span></span> substitutes_function<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> substitutes_total substitutes_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">[</span>_ <span class="keyword1">::=</span> _<span class="keyword1">]</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">X</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="SimplyTyped-subst_simp_unit"><span class="command">lemma</span></span> subst_simp_unit<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Unit<span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Unit"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> substitutes.unit<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> substitutes_function substitutes.unit<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-subst_simp_var1"><span class="command">lemma</span></span> subst_simp_var1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> substitutes.var1<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> substitutes_function substitutes.var1<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-subst_simp_var2"><span class="command">lemma</span></span> subst_simp_var2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span>
  <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> substitutes.var2 assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> substitutes_function substitutes.var2 assms
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-subst_simp_app"><span class="command">lemma</span></span> subst_simp_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> App <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_def
    <span class="keyword1"><span class="command">using</span></span> substitutes_function theI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>App <span class="skolem">A'</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>App <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A' B' <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> App <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> substitutes_function * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-subst_simp_fn"><span class="command">lemma</span></span> subst_simp_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">using</span></span> substitutes_function theI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.fn assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A' <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fn <span class="free">y</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Fn <span class="free">y</span> <span class="free">T</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_function * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-subst_simp_pair"><span class="command">lemma</span></span> subst_simp_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Pair <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> <span class="main">(</span><span class="free">B</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">B'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">using</span></span> substitutes_function theI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Pair <span class="skolem">A'</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Pair <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A' B' <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Pair <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">A</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">B</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> substitutes_function * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-subst_simp_fst"><span class="command">lemma</span></span> subst_simp_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Fst <span class="main">(</span><span class="free">P</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">using</span></span> substitutes_function theI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Fst <span class="skolem">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Fst <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P' <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Fst <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_function * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-subst_simp_snd"><span class="command">lemma</span></span> subst_simp_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Snd <span class="main">(</span><span class="free">P</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P'</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">using</span></span> substitutes_function theI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Snd <span class="skolem">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes.snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="main">(</span>Snd <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P' <span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"substitutes <span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="free">x</span> <span class="free">M</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Snd <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">X</span><span class="main">.</span> substitutes <span class="free">P</span> <span class="free">x</span> <span class="free">M</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> substitutes_function * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-subst_prm"><span class="command">lemma</span></span> subst_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">M</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span><span class="main">[</span><span class="free">π</span> <span class="main">$</span> <span class="free">z</span> <span class="main">::=</span> <span class="free">π</span> <span class="main">⋅</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">using</span></span> substitutes_prm substitutes_function the1_equality <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="SimplyTyped-subst_fvs"><span class="command">lemma</span></span> subst_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="main">(</span><span class="free">M</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>fvs <span class="free">M</span> <span class="main">-</span> <span class="main">{</span><span class="free">z</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> fvs <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_def <span class="keyword1"><span class="command">using</span></span> substitutes_fvs substitutes_function theI2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="SimplyTyped-subst_free"><span class="command">lemma</span></span> subst_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">=</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">N</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>›</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">N</span>›</span></span> subst_simp_fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_fst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_snd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-subst_swp"><span class="command">lemma</span></span> subst_swp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">z</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>1<span class="main">)</span> subst_simp_unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_var1 trm_prm_simp<span class="main">(</span>2<span class="main">)</span> prm_unit_action prm_unit_commutes <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_var2 trm_prm_simp<span class="main">(</span>2<span class="main">)</span> prm_unit_inaction <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≠</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> subst_simp_app trm_prm_simp<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>›</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Fn <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prm_unit_inaction <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_simp_fn <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_simp_fn <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>5<span class="main">)</span> subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">P</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>6<span class="main">)</span> subst_simp_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="free">y</span> <span class="main">↔</span> <span class="free">z</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">P</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"7.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>7<span class="main">)</span> subst_simp_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-barendregt"><span class="command">lemma</span></span> barendregt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">z</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">N</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">L</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">N</span> <span class="main">∪</span> fvs <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_var1 subst_simp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_free <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">∉</span> fvs <span class="free">L</span>›</span></span> subst_simp_var1 subst_simp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> <span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">N</span> <span class="main">∪</span> fvs <span class="free">L</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">N</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="main">(</span><span class="free">N</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subst_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_simp_fn <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">N</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">[</span><span class="free">y</span> <span class="main">::=</span> <span class="free">N</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subst_simp_fn <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="main">(</span><span class="free">N</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">L</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">L</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-typing_subst"><span class="command">lemma</span></span> typing_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">N</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">:</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_depth_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">z</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">N</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_unit typing.tunit typing_unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">=</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="free">N</span> <span class="main">:</span> <span class="free">τ</span>›</span></span> subst_simp_var1 <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Var <span class="skolem">x</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing.tvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> subst_simp_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"depth <span class="skolem">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">∧</span> depth <span class="skolem">B</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> depth_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> App <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">σ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">σ'</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">σ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> typing_appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">σ'</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> App <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing.tapp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">N</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_weaken 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"depth <span class="skolem">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> depth_fn<span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">σ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> TArr <span class="skolem">T</span> <span class="skolem">σ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">σ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> typing_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> fun_upd_twist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">:</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfn <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="main">=</span> TArr <span class="skolem">T</span> <span class="skolem">σ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">N</span>›</span></span> subst_simp_fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> TPair <span class="skolem">T</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> typing_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">B</span> <span class="main">&lt;</span> depth <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> depth_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">:</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">:</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Pair <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">σ</span> <span class="main">=</span> TPair <span class="skolem">T</span> <span class="skolem">S</span>›</span></span> typing.tpair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">P</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> depth_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="skolem">σ</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Fst <span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="free">z</span> <span class="main">↦</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="skolem">σ'</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">P</span> <span class="main">&lt;</span> depth <span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> depth_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="skolem">σ'</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> Snd <span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">N</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing.tsnd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">beta_reduction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→β</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  beta<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> app1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fn<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> 
<span class="main">|</span> snd1<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> snd2<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1"><span class="free">→β</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduction_fvs"><span class="command">lemma</span></span> beta_reduction_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="free">M'</span> <span class="main">⊆</span> fvs <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> fvs_simp<span class="main">(</span>4<span class="main">)</span> subst_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app1 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">∪</span> fvs <span class="skolem">B</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app2 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B'</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair1 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A'</span> <span class="main">∪</span> fvs <span class="skolem">B</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair2 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B'</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>    
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduction_prm"><span class="command">lemma</span></span> beta_reduction_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">M</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">M'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> beta_reduction.intros trm_prm_simp subst_prm<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_unitE"><span class="command">lemma</span></span> beta_reduction_left_unitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Unit <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_not_app unit_not_fn unit_not_pair unit_not_fst unit_not_snd<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_varE"><span class="command">lemma</span></span> beta_reduction_left_varE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_not_app var_not_fn var_not_pair var_not_fst var_not_snd<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_appE"><span class="command">lemma</span></span> beta_reduction_left_appE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span><span class="main">[</span><span class="bound">x</span> <span class="main">::=</span> <span class="free">B</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> App <span class="bound">A'</span> <span class="free">B</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">→β</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> App <span class="free">A</span> <span class="bound">B'</span><span class="main">)</span>
  "</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span>
  <span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_not_fn app_not_pair app_not_fst app_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_fnE"><span class="command">lemma</span></span> beta_reduction_left_fnE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="bound">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fn <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">y</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fn beta_reduction_fvs beta_reduction_prm fn_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fn_not_pair fn_not_fst fn_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_pairE"><span class="command">lemma</span></span> beta_reduction_left_pairE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="bound">A'</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">→β</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="free">A</span> <span class="bound">B'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 5
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_fstE"><span class="command">lemma</span></span> beta_reduction_left_fstE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">→β</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="main">(</span>Fst <span class="bound">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-beta_reduction_left_sndE"><span class="command">lemma</span></span> beta_reduction_left_sndE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">→β</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="main">(</span>Snd <span class="bound">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="free">M'</span> <span class="main">=</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>
  
<span class="keyword1" id="SimplyTyped-preservation'"><span class="command">lemma</span></span> preservation'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">→β</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> typing.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tunit <span class="skolem">Γ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tvar <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">τ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tapp <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="skolem">τ</span> <span class="skolem">σ</span> <span class="skolem">B</span> <span class="skolem">M'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="skolem">M'</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">(</span>Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span><span class="main">[</span><span class="bound">x</span> <span class="main">::=</span> <span class="skolem">B</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> App <span class="bound">A'</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="main">|</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">B</span> <span class="keyword1">→β</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> App <span class="skolem">A</span> <span class="bound">B'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">τ</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">X</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_fnE <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">X</span>›</span></span> type.inject
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span><span class="skolem">X</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B</span><span class="main">]</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_subst <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">τ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">→β</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span>App <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">A'</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tapp.IH<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span>App <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">τ</span>›</span></span> typing.tapp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="keyword1">→β</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B'</span> <span class="main">:</span> <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tapp.IH<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B'</span><span class="main">)</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>›</span></span> typing.tapp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfn <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">→β</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A'</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tfn.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">T</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing.tfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tpair <span class="skolem">Γ</span> <span class="skolem">A</span> <span class="skolem">τ</span> <span class="skolem">B</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="bound">A'</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">B</span> <span class="keyword1">→β</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="skolem">A</span> <span class="bound">B'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">→β</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> Pair <span class="skolem">A'</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tpair typing.tpair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="keyword1">→β</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tpair typing.tpair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tfst <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">→β</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> Fst <span class="bound">P'</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→β</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> Fst <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tfst typing.tfst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>›</span></span> typing_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>tsnd <span class="skolem">Γ</span> <span class="skolem">P</span> <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">→β</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> Snd <span class="bound">P'</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="skolem">M'</span> <span class="main">=</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction_left_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">→β</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> Snd <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tsnd typing.tsnd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">P</span> <span class="main">:</span> <span class="main">(</span>TPair <span class="skolem">τ</span> <span class="skolem">σ</span><span class="main">)</span>›</span></span> typing_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">NF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  unit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NF</span> Unit"</span></span>
<span class="main">|</span> var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NF</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">NF</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> <span class="free">NF</span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">;</span> <span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">NF</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span> <span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">NF</span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">;</span> <span class="free">NF</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">NF</span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> progress<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NF <span class="free">M</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M'</span><span class="main">.</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">→β</span> <span class="bound">M'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">τ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> NF.unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> NF.var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> App <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">τ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="main">(</span>TArr <span class="skolem">σ</span> <span class="skolem">τ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">⊢</span> <span class="skolem">B</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> typing_appE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"NF <span class="skolem">A</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"NF <span class="skolem">B</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">B</span> <span class="keyword1">→β</span> <span class="bound">B'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"NF <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">B</span> <span class="keyword1">→β</span> <span class="bound">B'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"NF <span class="skolem">A</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A'</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A'</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A'</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> 1
                <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.beta <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> 2
                <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹NF <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹NF <span class="skolem">B</span>›</span></span> NF.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.app1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.app2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span> <span class="main">⊢</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">τ</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> TArr <span class="skolem">T</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> typing_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Γ</span><span class="main">(</span><span class="skolem">x</span> <span class="main">↦</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">⊢</span> <span class="skolem">A</span> <span class="main">:</span> <span class="skolem">σ</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"NF <span class="skolem">A</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">→β</span> <span class="bound">A'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> NF.fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">→β</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="skolem">M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="keyword1">→β</span> <span class="skolem">A'</span>›</span></span> beta_reduction.fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> typing_pairE beta_reduction.pair1 beta_reduction.pair2 NF.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"NF <span class="skolem">P</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">→β</span> <span class="bound">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>  
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.fst2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹NF <span class="skolem">P</span>›</span></span> NF.fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.fst1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"NF <span class="skolem">P</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">→β</span> <span class="bound">P'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> typing_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>  
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.snd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹NF <span class="skolem">P</span>›</span></span> NF.snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction.snd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">beta_reduces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  reflexive<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1"><span class="free">→β<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>
<span class="main">|</span> transitive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1"><span class="free">→β<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">M'</span></span></span> <span class="keyword1">→β</span> <span class="free"><span class="bound"><span class="entity">M''</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1"><span class="free">→β<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">M''</span></span></span>"</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_composition"><span class="command">lemma</span></span> beta_reduces_composition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A''</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">B''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_fvs"><span class="command">lemma</span></span> beta_reduces_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="free">A'</span> <span class="main">⊆</span> fvs <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fvs <span class="skolem">M''</span> <span class="main">⊆</span> fvs <span class="skolem">M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduction_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fvs <span class="skolem">M'</span> <span class="main">⊆</span> fvs <span class="skolem">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_app_left"><span class="command">lemma</span></span> beta_reduces_app_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>App <span class="free">A'</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">A''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.app1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_app_right"><span class="command">lemma</span></span> beta_reduces_app_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>App <span class="free">A</span> <span class="free">B'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">B''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.app2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_fn"><span class="command">lemma</span></span> beta_reduces_fn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">A''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_pair_left"><span class="command">lemma</span></span> beta_reduces_pair_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Pair <span class="free">A'</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.pair1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_pair_right"><span class="command">lemma</span></span> beta_reduces_pair_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Pair <span class="free">A</span> <span class="free">B'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.pair2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_fst"><span class="command">lemma</span></span> beta_reduces_fst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Fst <span class="free">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.fst1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduces_snd"><span class="command">lemma</span></span> beta_reduces_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">P'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>Snd <span class="free">P'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive beta_reduction.snd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">theorem</span></span> preservation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">M'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> preservation' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> safety<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">M'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="free">M</span> <span class="main">:</span> <span class="free">τ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"NF <span class="free">M'</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">M''</span><span class="main">.</span> <span class="main">(</span><span class="free">M'</span> <span class="keyword1">→β</span> <span class="bound">M''</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">M</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">M</span> <span class="skolem">M'</span> <span class="skolem">M''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">M'</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> preservation <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">⊢</span> <span class="skolem">M''</span> <span class="main">:</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> preservation' <span class="quoted"><span class="quoted">‹<span class="skolem">M'</span> <span class="keyword1">→β</span> <span class="skolem">M''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">parallel_reduction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">&gt;&gt;</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> eta<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fst <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span>"</span></span>
<span class="main">|</span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Snd <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span>"</span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduction_prm"><span class="command">lemma</span></span> parallel_reduction_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.beta subst_prm trm_prm_simp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span> 4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.eta trm_prm_simp<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.app trm_prm_simp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.pair trm_prm_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.fst1 trm_prm_simp<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.fst2 trm_prm_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.snd1 trm_prm_simp<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.snd2 trm_prm_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span> 7<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduction_fvs"><span class="command">lemma</span></span> parallel_reduction_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="free">A'</span> <span class="main">⊆</span> fvs <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span><span class="quoted"><span class="quoted">"fvs <span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fvs <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B'</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> fvs <span class="skolem">A'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subst_fvs<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> Un_Diff subset_Un_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> Un_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">)</span> Un_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_unitE'<span class="main">:</span> <span class="quoted"><span class="quoted">"Unit <span class="main">&gt;&gt;</span> <span class="free">A</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_unitE"><span class="command">lemma</span></span> parallel_reduction_unitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">&gt;&gt;</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> Unit"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_reduction_unitE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> unit_not_app unit_not_fn unit_not_pair unit_not_fst unit_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_varE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">A</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_varE"><span class="command">lemma</span></span> parallel_reduction_varE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free">x</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> Var <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> parallel_reduction_varE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> var_not_app var_not_fn var_not_pair var_not_fst var_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_fnE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_fnE"><span class="command">lemma</span></span> parallel_reduction_fnE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="bound">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduction_fnE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">y</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fvs parallel_reduction_prm <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">&gt;&gt;</span> <span class="skolem">B'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fn_eq <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_redexE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_redexE"><span class="command">lemma</span></span> parallel_reduction_redexE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"
    <span class="main">(</span><span class="free">X</span> <span class="main">=</span> App <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A'</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="bound">B'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="bound">A'</span><span class="main">)</span> <span class="bound">B'</span><span class="main">)</span><span class="main">)</span>
  "</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduction_redexE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">C</span> <span class="skolem">C'</span> <span class="skolem">D</span> <span class="skolem">D'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹App <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> App <span class="skolem">C</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> C <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="skolem">A'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C C' D <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> App <span class="skolem">C'</span> <span class="skolem">D'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">C</span> <span class="skolem">C'</span> <span class="skolem">D</span> <span class="skolem">D'</span> <span class="skolem">y</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹App <span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="free">B</span> <span class="main">=</span> App <span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">C</span><span class="main">)</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">C</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fvs <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">C'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction_prm <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">C'</span><span class="main">)</span><span class="main">[</span><span class="free">x</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C'</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">]</span><span class="main">)</span>›</span></span> subst_swp <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">C'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_nonredexE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_nonredexE"><span class="command">lemma</span></span> parallel_reduction_nonredexE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A'</span><span class="main">.</span> <span class="free">A</span> <span class="main">≠</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>App <span class="bound">A'</span> <span class="bound">B'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduction_nonredexE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">C</span> <span class="skolem">C'</span> <span class="skolem">D</span> <span class="skolem">D'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>2<span class="main">,</span> 3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> App <span class="skolem">C'</span> <span class="skolem">D'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> parallel_reduction.refl<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span> 3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_pairE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_pairE"><span class="command">lemma</span></span> parallel_reduction_pairE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> Pair <span class="bound">A'</span> <span class="bound">B'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduction_pairE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> B<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">B</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.pair trm_simp<span class="main">(</span>5<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_fstE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_fstE"><span class="command">lemma</span></span> parallel_reduction_fstE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="free">P</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">&gt;&gt;</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>Fst <span class="bound">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">A'</span> <span class="bound">B</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduction_fstE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.fst1 trm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.fst2 trm_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">insert</span> parallel_reduction.refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> parallel_reduction_sndE'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
<span class="keyword1" id="SimplyTyped-parallel_reduction_sndE"><span class="command">lemma</span></span> parallel_reduction_sndE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="free">P</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">&gt;&gt;</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="main">(</span>Snd <span class="bound">P'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">B'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduction_sndE'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">X</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.snd1 trm_simp<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.snd2 trm_simp<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">insert</span> parallel_reduction.refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fst_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-parallel_reduction_subst_inner"><span class="command">lemma</span></span> parallel_reduction_subst_inner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="free">X</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">z</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span> <span class="main">∪</span> fvs <span class="free">M'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_unit parallel_reduction.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> subst_simp_var1<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> subst_simp_var2 parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_app parallel_reduction.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 subst_simp_fn parallel_reduction.eta <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_pair parallel_reduction.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_fst parallel_reduction.fst1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst_simp_snd parallel_reduction.snd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduction_subst"><span class="command">lemma</span></span> parallel_reduction_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">&gt;&gt;</span> <span class="free">X'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="free">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_strong_depth_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">z</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M</span></span> <span class="main"><span class="main">∪</span></span> fvs <span class="free"><span class="free">M'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span> <span class="main">∪</span> fvs <span class="free">M'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Unit"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_unitE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.refl subst_simp_unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_varE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_subst_inner <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span><span class="main">.</span> <span class="skolem">C</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">C</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">D</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> depth_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">consider</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">D</span>"</span></span>
        <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">D'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="bound">D'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A'</span><span class="main">)</span> <span class="bound">D'</span><span class="main">)</span>"</span></span> 
        <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">D'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="bound">D'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="bound">D'</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> parallel_reduction_redexE <span class="quoted"><span class="quoted">‹<span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">X'</span>›</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 1
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_subst_inner <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 2
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">D'</span></span>
              <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span> <span class="skolem">D'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted"><span class="quoted">‹depth <span class="skolem">C</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>›</span></span> C <span class="quoted"><span class="quoted">‹<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted"><span class="quoted">‹depth <span class="skolem">D</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> App <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subst_simp_app C <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>App <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> * ** parallel_reduction.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span> <span class="skolem">D'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> 3
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> C depth_app depth_fn dual_order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span><span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span> <span class="main">∪</span> fvs <span class="free">M'</span> <span class="main">∪</span> fvs <span class="skolem">A'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span>
              <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="main">{</span><span class="free">z</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="free">M</span> <span class="main">∪</span> fvs <span class="free">M'</span> <span class="main">∪</span> fvs <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> fresh_fn C <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_prm <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted"><span class="quoted">‹depth <span class="skolem">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>›</span></span> depth_prm
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span><span class="skolem">A'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted"><span class="quoted">‹depth <span class="skolem">D</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>App <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> C subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">y</span> <span class="skolem">T</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> subst_simp_fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> parallel_reduction.beta * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="skolem">y</span> <span class="main">↔</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">[</span><span class="skolem">y</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">]</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> barendregt <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">D'</span><span class="main">]</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> subst_swp <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> fvs <span class="skolem">A'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> App <span class="skolem">C'</span> <span class="skolem">D'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction_nonredexE <span class="quoted"><span class="quoted">‹<span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">C</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">D</span> <span class="main">&lt;</span> depth <span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> depth_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">C'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">D</span> <span class="main">&gt;&gt;</span> <span class="skolem">D'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="skolem">C</span> <span class="skolem">D</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> App <span class="main">(</span><span class="skolem">C</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>App <span class="main">(</span><span class="skolem">C'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">D'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.app * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>App <span class="skolem">C'</span> <span class="skolem">D'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_subst_inner <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> depth_fn <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_fn <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.eta * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_fn <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≠</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fvs <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> Pair <span class="bound">A'</span> <span class="bound">B'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_subst_inner <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;&gt;</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Pair <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">B'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"5.IH"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">&gt;&gt;</span> <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> depth_pair<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> depth_pair<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.pair * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Pair <span class="skolem">A'</span> <span class="skolem">B'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> Fst <span class="bound">P'</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">A'</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> <span class="bound">A'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Fst <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">P'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.IH"</span> depth_fst <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Fst <span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fst <span class="main">(</span><span class="skolem">P'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.fst1 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Fst <span class="skolem">P'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">A</span> <span class="main">&lt;</span> depth <span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P depth_fst depth_pair dual_order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"6.IH"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fst <span class="skolem">P</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>Fst <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P subst_simp_fst subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.fst2 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">X'</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="bound">P'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> Snd <span class="bound">P'</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">B'</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">B</span> <span class="main">&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">X'</span> <span class="main">=</span> <span class="bound">B'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="skolem">P'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> Snd <span class="skolem">P'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">P'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"7.IH"</span> depth_snd <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="skolem">P'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> Snd <span class="main">(</span><span class="skolem">P</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Snd <span class="main">(</span><span class="skolem">P'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.snd1 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Snd <span class="skolem">P'</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> subst_simp_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;&gt;</span> <span class="skolem">B'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X'</span> <span class="main">=</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"depth <span class="skolem">B</span> <span class="main">&lt;</span> depth <span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P depth_snd depth_pair dual_order.strict_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">B'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"7.IH"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">&gt;&gt;</span> <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">M</span> <span class="main">&gt;&gt;</span> <span class="free">M'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Snd <span class="skolem">P</span><span class="main">)</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>Snd <span class="main">(</span>Pair <span class="main">(</span><span class="skolem">A</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">B</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> P subst_simp_snd subst_simp_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&gt;&gt;</span> <span class="main">(</span><span class="skolem">B'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction.snd2 * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X'</span><span class="main">[</span><span class="free">z</span> <span class="main">::=</span> <span class="free">M'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">complete_development</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">&gt;&gt;&gt;</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  unit<span class="main">:</span> <span class="quoted"><span class="quoted">"Unit <span class="main"><span class="free">&gt;&gt;&gt;</span></span> Unit"</span></span>
<span class="main">|</span> var<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> beta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">::=</span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> eta<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span>Fn <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> app<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span>App <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> pair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span>Fst <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> fst2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Fst <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span>"</span></span>
<span class="main">|</span> snd1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> Pair <span class="bound">A</span> <span class="bound">B</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="main">(</span>Snd <span class="free"><span class="bound"><span class="entity">P'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> snd2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span> <span class="main">⟹</span> <span class="main">(</span>Snd <span class="main">(</span>Pair <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="free">&gt;&gt;&gt;</span></span> <span class="free"><span class="bound"><span class="entity">B'</span></span></span>"</span></span>

<span class="keyword1" id="SimplyTyped-not_fn_prm"><span class="command">lemma</span></span> not_fn_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">.</span> <span class="free">A</span> <span class="main">≠</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">≠</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="free">M</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> prm_inv <span class="free">π</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">≠</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">⋅</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">π'</span> <span class="main">⋄</span> <span class="free">π</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">⋅</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trm_prm_apply_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">⋅</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * prm_inv_compose trm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> Fn <span class="main">(</span><span class="skolem">π'</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">T</span> <span class="main">(</span><span class="skolem">π'</span> <span class="main">⋅</span> <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-not_pair_prm"><span class="command">lemma</span></span> not_pair_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">P</span> <span class="main">≠</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="free">P</span> <span class="main">≠</span> Pair <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> classical<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> prm_inv <span class="free">π</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">P</span> <span class="main">≠</span> Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="free">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">⋅</span> <span class="free">π</span> <span class="main">⋅</span> <span class="free">P</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">⋅</span> <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">π'</span> <span class="main">⋄</span> <span class="free">π</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">P</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">⋅</span> <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trm_prm_apply_compose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">⋅</span> <span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * prm_inv_compose trm_prm_apply_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> Pair <span class="main">(</span><span class="skolem">π'</span> <span class="main">⋅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">π'</span> <span class="main">⋅</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-complete_development_prm"><span class="command">lemma</span></span> complete_development_prm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;&gt;&gt;</span> <span class="main">(</span><span class="free">π</span> <span class="main">⋅</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> unit
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.unit trm_prm_simp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.var trm_prm_simp<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.beta subst_prm trm_prm_simp<span class="main">(</span>3<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.eta trm_prm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.app <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trm_prm_simp<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_fn_prm<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.pair trm_prm_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="skolem">P</span> <span class="main">≠</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="keyword1"><span class="command">using</span></span> not_pair_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>6<span class="main">)</span> fst1.IH complete_development.fst1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>5<span class="main">,</span> 6<span class="main">)</span> complete_development.fst2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">⋅</span> <span class="skolem">P</span> <span class="main">≠</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="keyword1"><span class="command">using</span></span> not_pair_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>7<span class="main">)</span> snd1.IH complete_development.snd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_prm_simp<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span> complete_development.snd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-complete_development_fvs"><span class="command">lemma</span></span> complete_development_fvs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fvs <span class="free">A'</span> <span class="main">⊆</span> fvs <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> unit
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fvs <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B'</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> fvs <span class="skolem">A'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subst_fvs<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> fvs <span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> fvs <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">∪</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> subset_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> fvs <span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> subset_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span><span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Un_Diff subset_Un_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>3<span class="main">)</span> Un_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">)</span> Un_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvs_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span> sup.coboundedI1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvs_simp<span class="main">(</span>5<span class="main">,</span> 7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-complete_development_fnE"><span class="command">lemma</span></span> complete_development_fnE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="free">x</span> <span class="free">T</span> <span class="free">A</span><span class="main">)</span> <span class="main">&gt;&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="bound">A'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">y</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> eta <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B</span> <span class="main">∧</span> <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eta <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">=</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">B'</span>›</span></span> complete_development_fvs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">↔</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">⋅</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">B'</span>›</span></span> complete_development_prm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> Fn <span class="free">x</span> <span class="free">T</span> <span class="skolem">A'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fn_eq <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> fvs <span class="skolem">B'</span>›</span></span> A' <span class="quoted"><span class="quoted">‹<span class="free">X</span> <span class="main">=</span> Fn <span class="skolem">y</span> <span class="skolem">S</span> <span class="skolem">B'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">metis</span> unit_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> var_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> app_not_fn<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_fst<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> fn_not_snd
<span class="main">)</span>

<span class="keyword1" id="SimplyTyped-complete_development_pairE"><span class="command">lemma</span></span> complete_development_pairE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="free">A</span> <span class="free">B</span><span class="main">)</span> <span class="main">&gt;&gt;&gt;</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">A'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> Pair <span class="bound">A'</span> <span class="bound">B'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> unit_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> var_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> app_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> fn_not_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> app_not_pair<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> trm_simp<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span> 6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_fst<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_snd<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pair_not_snd<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-complete_development_exists"><span class="command">lemma</span></span> complete_development_exists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> trm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Unit"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Unit <span class="main">&gt;&gt;&gt;</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.unit <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Var <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Var <span class="skolem">x</span><span class="main">)</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">B'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">)</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">.</span> <span class="skolem">A</span> <span class="main">=</span> Fn <span class="bound">x</span> <span class="bound">T</span> <span class="bound">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">M'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">M'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> complete_development_fnE A' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">M'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B'</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> complete_development.beta <span class="quoted"><span class="quoted">‹<span class="skolem">M</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">M'</span>›</span></span> B' A <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.app A' B' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.eta A' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Pair <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> complete_development_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.fst2 <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.fst1 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">P</span><span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="skolem">P</span> <span class="main">=</span> Pair <span class="bound">A</span> <span class="bound">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Pair <span class="skolem">A'</span> <span class="skolem">B'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> complete_development_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.snd2 <span class="quoted"><span class="quoted">‹<span class="skolem">P</span> <span class="main">=</span> Pair <span class="skolem">A</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> complete_development.snd1 7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-complete_development_triangle"><span class="command">lemma</span></span> complete_development_triangle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> complete_development.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> unit
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_unitE parallel_reduction.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>var <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_varE parallel_reduction.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">C</span> <span class="skolem">C'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">C</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A''</span> <span class="bound">C''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="bound">C''</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="bound">A''</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="bound">C''</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A''</span> <span class="bound">C''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A''</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="bound">C''</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A''</span><span class="main">)</span> <span class="bound">C''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_redexE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.beta <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A''</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">C''</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C''</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> B parallel_reduction_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">C''</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span><span class="main">)</span> <span class="skolem">C''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C''</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> beta.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">thm</span></span> parallel_reduction_fnE
          <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
            <span class="quoted"><span class="quoted">"Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span>"</span></span>
          <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A'''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A'''</span><span class="main">)</span> <span class="main">∧</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A'''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> 1
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction.refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> 2
              <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'''</span>"</span></span> <span class="quoted"><span class="quoted">"Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> B <span class="quoted"><span class="quoted">‹<span class="skolem">C''</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>›</span></span> parallel_reduction.beta <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A''</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="bound">A''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fnE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eta.IH parallel_reduction.refl parallel_reduction.eta <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> eta.IH parallel_reduction.eta <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">C</span> <span class="skolem">C'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> App <span class="skolem">A''</span> <span class="skolem">C''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_nonredexE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">&gt;&gt;</span> <span class="skolem">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C''</span> <span class="main">&gt;&gt;</span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> app.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> B parallel_reduction.app <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">C</span> <span class="skolem">C'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">B</span>›</span></span> <span class="keyword2"><span class="keyword">and</span></span> parallel_reduction_pairE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Pair <span class="skolem">A''</span> <span class="skolem">C''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> pair.IH parallel_reduction.pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="skolem">P''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Fst <span class="skolem">P''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fstE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fst1.IH parallel_reduction.fst1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">C</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="bound">P''</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> Fst <span class="bound">P''</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="bound">A''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">=</span> <span class="bound">A''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_fstE<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">P''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Fst <span class="skolem">P''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P''</span> <span class="main">=</span> Pair <span class="skolem">A''</span> <span class="skolem">C''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fst2 parallel_reduction.fst2 <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">=</span> Fst <span class="skolem">P''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">A''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fst2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">&gt;&gt;</span> <span class="skolem">P''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Snd <span class="skolem">P''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_sndE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> snd1.IH parallel_reduction.snd1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">C</span> <span class="skolem">A'</span> <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">P''</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="bound">P''</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">B</span> <span class="main">=</span> Snd <span class="bound">P''</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C''</span><span class="main">.</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="bound">C''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">=</span> <span class="bound">C''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_sndE<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> trm_simp<span class="main">(</span>5<span class="main">,</span> 6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Pair <span class="skolem">A</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">&gt;&gt;</span> <span class="skolem">P''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Snd <span class="skolem">P''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A''</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P''</span> <span class="main">=</span> Pair <span class="skolem">A''</span> <span class="skolem">C''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> parallel_reduction_pairE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snd2 parallel_reduction.snd2 <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">=</span> Snd <span class="skolem">P''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">C''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">C''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> snd2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduction_diamond"><span class="command">lemma</span></span> parallel_reduction_diamond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="main">&gt;&gt;</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;&gt;</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complete_development_exists <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complete_development_triangle assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">parallel_reduces</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>
<span class="main">|</span> transitive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">;</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">&gt;&gt;</span> <span class="free"><span class="bound"><span class="entity">A''</span></span></span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span></span> <span class="free"><span class="bound"><span class="entity">A''</span></span></span>"</span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduces_diamond'"><span class="command">lemma</span></span> parallel_reduces_diamond'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="main">&gt;&gt;</span> <span class="bound">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces.reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">A''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">&gt;&gt;</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A'</span> <span class="main">&gt;&gt;</span> <span class="skolem">C</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A'</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">&gt;&gt;</span> <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">&gt;&gt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> parallel_reduction_diamond <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces.transitive <span class="quoted"><span class="quoted">‹<span class="free">B</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduces_diamond"><span class="command">lemma</span></span> parallel_reduces_diamond<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces.reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">A''</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A''</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span> <span class="main">&gt;&gt;</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A'</span> <span class="main">&gt;&gt;</span> <span class="skolem">A''</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A'</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C'</span>›</span></span> parallel_reduces_diamond' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces.transitive <span class="quoted"><span class="quoted">‹<span class="free">C</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">C'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-beta_reduction_is_parallel_reduction"><span class="command">lemma</span></span> beta_reduction_is_parallel_reduction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.beta parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.app parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.app parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.eta<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.pair parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.pair parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.fst1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.fst2 parallel_reduction.refl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.snd1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> parallel_reduction.snd2 parallel_reduction.refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="SimplyTyped-parallel_reduction_is_beta_reduction"><span class="command">lemma</span></span> parallel_reduction_is_beta_reduction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>beta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A</span><span class="main">)</span> <span class="skolem">B</span><span class="main">)</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span> <span class="skolem">B'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">A'</span>›</span></span>
      beta_reduces_fn beta_reduces_app_left beta_reduces_app_right beta_reduces_composition
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>App <span class="main">(</span>Fn <span class="skolem">x</span> <span class="skolem">T</span> <span class="skolem">A'</span><span class="main">)</span> <span class="skolem">B'</span><span class="main">)</span> <span class="keyword1">→β</span> <span class="main">(</span><span class="skolem">A'</span><span class="main">[</span><span class="skolem">x</span> <span class="main">::=</span> <span class="skolem">B'</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> beta_reduction.beta<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>eta <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">x</span> <span class="skolem">T</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces_fn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces_app_left beta_reduces_app_right beta_reduces_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>pair <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span> <span class="skolem">B'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces_pair_left beta_reduces_pair_right beta_reduces_composition <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fst2 <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> beta_reduces_pair_left beta_reduction.fst2 beta_reduces.intros beta_reduces_composition
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd1 <span class="skolem">P</span> <span class="skolem">P'</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snd2 <span class="skolem">B</span> <span class="skolem">B'</span> <span class="skolem">A</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> beta_reduces_pair_left beta_reduction.snd2 beta_reduces.intros beta_reduces_composition
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="SimplyTyped-parallel_beta_reduces_equivalent"><span class="command">lemma</span></span> parallel_beta_reduces_equivalent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> →<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> parallel_reduces.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">A</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">A''</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> beta_reduces_composition parallel_reduction_is_beta_reduction <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> ←<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> beta_reduces.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>reflexive <span class="skolem">A</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces.reflexive<span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>transitive <span class="skolem">A</span> <span class="skolem">A'</span> <span class="skolem">A''</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces.transitive beta_reduction_is_parallel_reduction <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> ←→ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> confluence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_beta_reduces_equivalent <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="main">&gt;&gt;<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_reduces_diamond <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">C</span> <span class="keyword1">→β<span class="hidden">⇧</span><sup>*</sup></span> <span class="bound">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> parallel_beta_reduces_equivalent <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>