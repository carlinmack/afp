<div id="Term_Utils">
<div class="head">
<h1>Theory Term_Utils</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Term_Utils
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Monad_Syntax.html">HOL-Library.Monad_Syntax</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/State_Monad.html">HOL-Library.State_Monad</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map2</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">map2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">map2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">map2</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Term_Utils-map2_elemE"><span class="command">lemma</span></span> map2_elemE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-map2_elemE1"><span class="command">lemma</span></span> map2_elemE1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-map2_elemE2"><span class="command">lemma</span></span> map2_elemE2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>map2 <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-map2_cong"><span class="command">lemma</span></span> map2_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs1</span> <span class="main">=</span> <span class="free">xs2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys1</span> <span class="main">=</span> <span class="free">ys2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs1</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys1</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map2 <span class="free">f</span> <span class="free">xs1</span> <span class="free">ys1</span> <span class="main">=</span> map2 <span class="free">g</span> <span class="free">xs2</span> <span class="free">ys2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map2 <span class="free">f</span> <span class="free">xs1</span> <span class="free">ys1</span> <span class="main">=</span> map2 <span class="free">g</span> <span class="free">xs1</span> <span class="free">ys1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fg
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs1</span></span> <span class="quoted"><span class="free">ys1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> map2.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Utils-option_bindE"><span class="command">lemma</span></span> option_bindE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Some <span class="free">x'</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x'</span> <span class="main">=</span> Some <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-rel_option_bind"><span class="command">lemma</span></span> rel_option_bind<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="free">R</span> <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">R</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> rel_option <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="free">R</span> <span class="main">(</span><span class="free">x</span> <span class="main">⤜</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">⤜</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option.rel_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Utils-list_split"><span class="command">lemma</span></span> list_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">xs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">xs<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">xs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">xs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="var">?xs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="var">?xs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="var">?xs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="var">?xs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Term_Utils-ffUnion_alt_def"><span class="command">lemma</span></span> ffUnion_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> ffUnion <span class="free">A</span> <span class="main">⟷</span> fBex <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">blast</span>

<span class="keyword1" id="Term_Utils-funion_image_bind_eq"><span class="command">lemma</span></span> funion_image_bind_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ffUnion <span class="main">(</span><span class="free">f</span> <span class="main">|`|</span> <span class="free">M</span><span class="main">)</span> <span class="main">=</span> fbind <span class="free">M</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-fbind_funion"><span class="command">lemma</span></span> fbind_funion<span class="main">:</span> <span class="quoted"><span class="quoted">"fbind <span class="main">(</span><span class="free">M</span> <span class="main">|∪|</span> <span class="free">N</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> fbind <span class="free">M</span> <span class="free">f</span> <span class="main">|∪|</span> fbind <span class="free">N</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-ffUnion_least"><span class="command">lemma</span></span> ffUnion_least<span class="main">:</span> <span class="quoted"><span class="quoted">"fBall <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">|⊆|</span> <span class="free">C</span><span class="main">)</span> <span class="main">⟹</span> ffUnion <span class="free">A</span> <span class="main">|⊆|</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">blast</span>

<span class="keyword1" id="Term_Utils-fbind_iff"><span class="command">lemma</span></span> fbind_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∈|</span> fbind <span class="free">S</span> <span class="free">f</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="free">x</span> <span class="main">|∈|</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">|∈|</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Utils-fBall_pred_weaken"><span class="command">lemma</span></span> fBall_pred_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> <span class="free">M</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> fBall <span class="free">M</span> <span class="free">P</span> <span class="main">⟹</span> fBall <span class="free">M</span> <span class="free">Q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Term_Utils-fmmap_fmupd"><span class="command">lemma</span></span> fmmap_fmupd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fmmap <span class="free">f</span> <span class="main">(</span>fmupd <span class="free">k</span> <span class="free">v</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> fmupd <span class="free">k</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span>fmmap <span class="free">f</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fmlookup_default</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fmlookup_default</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Find_First">
<div class="head">
<h1>Theory Find_First</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Find_First
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Finite_Map.html">HOL-Library.Finite_Map</a>"</span>
  <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_first</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">find_first</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">find_first</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> map_option Suc <span class="main">(</span><span class="free">find_first</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Find_First-find_first_correct"><span class="command">lemma</span></span> find_first_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 2 <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">case</span></span> 3 <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Find_First-find_first_none"><span class="command">lemma</span></span> find_first_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Find_First-find_first_some_strong"><span class="command">lemma</span></span> find_first_some_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.prems<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_pos_if_in_set length_take min.absorb2<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons.IH<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="skolem">ys</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="skolem">thesis</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_ConsD take_Cons'<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> length <span class="skolem">ys</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def le_diff_conv list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Find_First-find_first_some"><span class="command">lemma</span></span> find_first_some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl take_all find_first_some_strong<span class="main">)</span>

<span class="keyword1" id="Find_First-find_first_some_index"><span class="command">lemma</span></span> find_first_some_index<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> find_first <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_first <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> map_option Suc <span class="main">(</span>Some <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Find_First-find_first_append"><span class="command">lemma</span></span> find_first_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> find_first <span class="free">x</span> <span class="free">ys</span> <span class="keyword1">of</span> None <span class="main">⇒</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> length <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>find_first <span class="free">x</span> <span class="free">zs</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> Some <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> option.map_comp comp_def map_option.identity <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Find_First-find_first_first"><span class="command">lemma</span></span> find_first_first<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="free">xs</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="var">?zs</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="var">?ys</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_none<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span><span class="var">?ys</span> <span class="main">@</span> <span class="var">?zs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> find_first_append
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Find_First-find_first_prefix"><span class="command">lemma</span></span> find_first_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> find_first_first<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_correct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min.absorb1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Find_First-find_first_later"><span class="command">lemma</span></span> find_first_later<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">≠</span> Some <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> find_first_some_strong<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_first<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Find_First-find_first_in_map"><span class="command">lemma</span></span> find_first_in_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmlookup <span class="main">(</span>fmap_of_list <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ys</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Skolem_list_nth le_0_eq length_greater_0_conv less_nat_zero_code list.set_cases listrel_Cons1 listrel_iff_nth nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">common_prefix</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">common_prefix</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">common_prefix</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">common_prefix</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Find_First-common_prefix_find"><span class="command">lemma</span></span> common_prefix_find<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> set <span class="main">(</span>common_prefix <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">z</span> <span class="free">xs</span> <span class="main">=</span> find_first <span class="free">z</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> common_prefix.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Find_First-find_first_insert_nth_eq"><span class="command">lemma</span></span> find_first_insert_nth_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span>insert_nth <span class="free">n</span> <span class="free">x</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_first_append find_first_none <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Find_First-insert_nth_induct"><span class="command">lemma</span></span> insert_nth_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">a2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">0</span> <span class="bound">x</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">n</span> <span class="bound">x</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="bound">x</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a0</span> <span class="free">a1</span> <span class="free">a2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction_schema</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">pat_completeness</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">lexicographic_order</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Find_First-find_first_insert_nth_neq"><span class="command">lemma</span></span> find_first_insert_nth_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"find_first <span class="free">x</span> <span class="main">(</span>insert_nth <span class="free">n</span> <span class="free">y</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="bound">i</span> <span class="keyword1">else</span> Suc <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>find_first <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> insert_nth_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">note</span></span> insert_nth_take_drop<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> option.map_comp
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> option.map_cong0<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Name">
<div class="head">
<h1>Theory Name</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Names as a unique datatype›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Name
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  I would like to model names as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">string</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s. Unfortunately, there is no default order on lists,
  as there could be multiple reasonable implementations: e.g.\ lexicographic and point-wise.
  For both choices, users can import the corresponding instantiation.

  In Isabelle, only at most one implementation of a given type class for a given type may be present
  in the same theory. Consequently, I avoided importing a list ordering from the library, because it
  may cause conflicts with users who use another ordering. The general approach for these situations
  is to introduce a type copy.

  The full flexibility of strings (i.e.\ string manipulations) is only required where fresh names
  are being produced. Otherwise, only a linear order on terms is needed. Conveniently, Sternagel and
  Thiemann <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> sternagel2015deriving<span class="antiquote"><span class="antiquote">}</span></span></span></span> provide tooling to automatically generate such a
  lexicographic order.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> name <span class="main">=</span> Name <span class="main">(</span><span class="free"><span class="entity">as_string</span></span><span class="main">:</span> <span class="quoted">string</span><span class="main">)</span>

<span class="comment1">― ‹Mostly copied from <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>List_Lexorder›</span></span>›</span>

<span class="keyword1"><span class="command">instantiation</span></span> name <span class="main">::</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_name</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> as_string <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">∈</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>of_char <span class="bound">u</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_name</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">::</span> name<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> name <span class="main">::</span> <span class="quoted">order</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_name_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≤</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_name_def less_name_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≤</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_name_def less_name_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_irreflexive <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> notE<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">&lt;</span> <span class="skolem">ys</span> <span class="main">⟷</span> <span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">ys</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">ys</span> <span class="main">≤</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_name_def less_eq_name_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_irreflexive <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> notE<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_irreflexive <span class="main"><span class="main">[</span></span><span class="operator">THEN</span> notE<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> lexord_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> name <span class="main">::</span> <span class="quoted">linorder</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>as_string <span class="skolem">xs</span><span class="main">,</span> as_string <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>of_char <span class="bound">u</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="bound">v</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">∨</span> <span class="main">(</span>as_string <span class="skolem">ys</span><span class="main">,</span> as_string <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> lexord <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>of_char <span class="bound">u</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="bound">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodI lexord_linear linorder_neqE_nat mem_Collect_eq name.expand of_char_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">ys</span> <span class="main">∨</span> <span class="skolem">ys</span> <span class="main">≤</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_name_def less_name_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Name-less_name_code"><span class="command">lemma</span></span> less_name_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Name <span class="free">xs</span> <span class="main">&lt;</span> Name <span class="main">[]</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"Name <span class="main">[]</span> <span class="main">&lt;</span> Name <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"Name <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">&lt;</span> Name <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>of_char <span class="free">x</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> Name <span class="free">xs</span> <span class="main">&lt;</span> Name <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> less_name_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Name-le_name_code"><span class="command">lemma</span></span> le_name_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Name <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> Name <span class="main">[]</span> <span class="main">⟷</span> False"</span></span>
  <span class="quoted"><span class="quoted">"Name <span class="main">[]</span> <span class="main">≤</span> Name <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> True"</span></span>
  <span class="quoted"><span class="quoted">"Name <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> Name <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>of_char <span class="free">x</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> of_char <span class="free">y</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> Name <span class="free">xs</span> <span class="main">≤</span> Name <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> less_eq_name_def less_name_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> name <span class="main">⇒</span> name"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">append</span> <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="free"><span class="bound"><span class="entity">v2</span></span></span> <span class="main">=</span> Name <span class="main">(</span>as_string <span class="free"><span class="bound"><span class="entity">v1</span></span></span> <span class="main">@</span> as_string <span class="free"><span class="bound"><span class="entity">v2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Name-name_append_less"><span class="command">lemma</span></span> name_append_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> Name <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"append <span class="free">ys</span> <span class="free">xs</span> <span class="main">&gt;</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Name <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">&gt;</span> Name <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> less_name_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> less_name_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> append_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Fresh_Monad">
<div class="head">
<h1>Theory Fresh_Monad</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹A monad for generating fresh names›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fresh_Monad
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/State_Monad.html">HOL-Library.State_Monad</a>"</span>
  <a href="Term_Utils.html">Term_Utils</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Generation of fresh names in general can be thought of as picking a string that is not an element
  of a (finite) set of already existing names. For Isabelle, the <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹Nominal›</span></span> framework
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> urban2008nominal <span class="quasi_keyword"><span class="quasi_keyword">and</span></span> urban2013nominal<span class="antiquote"><span class="antiquote">}</span></span></span></span> provides support for reasoning over fresh names, but
  unfortunately, its definitions are not executable.

  Instead, I chose to model generation of fresh names as a monad based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> state<span class="antiquote"><span class="antiquote">}</span></span></span></span>. With this,
  it becomes possible to write programs using <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>do›</span></span></span></span>-notation. This is implemented abstractly as a
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">command</span></span> locale<span class="antiquote"><span class="antiquote">}</span></span></span></span> that expects two operations:

  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>next›</span></span></span></span> expects a value and generates a larger value, according to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> linorder<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>arb›</span></span></span></span> produces any value, similarly to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> undefined<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but executable
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> fresh <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free">next</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">arb</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">update_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update_next</span> <span class="main">≡</span> State_Monad.update <span class="free">next</span>"</span></span>

<span class="keyword1" id="Fresh_Monad-update_next_strict_mono"><span class="command">lemma</span></span> update_next_strict_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono_state update_next"</span></span>
<span class="keyword1"><span class="command">using</span></span> next_ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> update_strict_mono<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-update_next_mono"><span class="command">lemma</span></span> update_next_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono_state update_next"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> strict_mono_implies_mono<span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> update_next_strict_mono<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">create</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">create</span> <span class="main">=</span> update_next <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> State_Monad.get<span class="main">)</span>"</span></span>

<span class="keyword1" id="Fresh_Monad-create_alt_def"><span class="command">lemma</span></span> create_alt_def<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"create <span class="main">=</span> State <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="free">next</span> <span class="bound">a</span><span class="main">,</span> <span class="free">next</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> create_def State_Monad.update_def State_Monad.get_def State_Monad.set_def State_Monad.bind_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fresh_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fresh_in</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Ball <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">(≥)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fresh_Monad-next_ge_all"><span class="command">lemma</span></span> next_ge_all<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> fresh_in <span class="free">S</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">next</span> <span class="free">s</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym less_imp_le less_irrefl next_ge<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">Next</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="free">arb</span> <span class="keyword1">else</span> <span class="free">next</span> <span class="main">(</span>Max <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Fresh_Monad-Next_ge_max"><span class="command">lemma</span></span> Next_ge_max<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Next <span class="free">S</span> <span class="main">&gt;</span> Max <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Next_def <span class="keyword1"><span class="command">using</span></span> next_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Fresh_Monad-Next_not_member_subset"><span class="command">lemma</span></span> Next_not_member_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> Next <span class="free">S'</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Next_def <span class="keyword1"><span class="command">using</span></span> next_ge
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Max_ge Max_mono empty_iff finite_subset leD less_le_trans subset_empty<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-Next_not_member"><span class="command">lemma</span></span> Next_not_member<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> Next <span class="free">S</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Next_not_member_subset<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Fresh_Monad-Next_geq_not_member"><span class="command">lemma</span></span> Next_geq_not_member<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≥</span> Next <span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> Next_def <span class="keyword1"><span class="command">using</span></span> next_ge
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Max_ge all_not_in_conv leD le_less_trans<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-next_not_member"><span class="command">lemma</span></span> next_not_member<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">≥</span> Next <span class="free">S</span> <span class="main">⟹</span> <span class="free">next</span> <span class="free">s</span> <span class="main">∉</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Next_geq_not_member less_imp_le next_ge order_trans<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-create_mono"><span class="command">lemma</span></span> create_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mono_state create"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> create_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_mono_strong<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-create_strict_mono"><span class="command">lemma</span></span> create_strict_mono<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"strict_mono_state create"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> create_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bind_strict_mono_strong2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">run_fresh</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">run_fresh</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>run_state <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">fresh_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fresh_fin</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> fBall <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">(≥)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Fresh_Monad-next_ge_fall"><span class="command">lemma</span></span> next_ge_fall<span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_fin <span class="free">S</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">next</span> <span class="free">s</span> <span class="main">|∉|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">next</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> next_ge_all<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> fNext <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> fset <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Next</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Fresh_Monad-fNext_ge_max"><span class="command">lemma</span></span> fNext_ge_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{||}</span> <span class="main">⟹</span> fNext <span class="free">S</span> <span class="main">&gt;</span> fMax <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> Next_ge_max<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-next_not_fmember"><span class="command">lemma</span></span> next_not_fmember<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≥</span> fNext <span class="free">S</span> <span class="main">⟹</span> <span class="free">next</span> <span class="free">s</span> <span class="main">|∉|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> next_not_member<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-fNext_geq_not_member"><span class="command">lemma</span></span> fNext_geq_not_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≥</span> fNext <span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">|∉|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> Next_geq_not_member<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-fNext_not_member"><span class="command">lemma</span></span> fNext_not_member<span class="main">:</span> <span class="quoted"><span class="quoted">"fNext <span class="free">S</span> <span class="main">|∉|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> Next_not_member<span class="main">)</span>

<span class="keyword1" id="Fresh_Monad-fNext_not_member_subset"><span class="command">lemma</span></span> fNext_not_member_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">|⊆|</span> <span class="free">S'</span> <span class="main">⟹</span> fNext <span class="free">S'</span> <span class="main">|∉|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> Next_not_member_subset<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">frun_fresh</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">frun_fresh</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>run_state <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>fNext <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Fresh_Class">
<div class="head">
<h1>Theory Fresh_Class</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fresh monad operations as class operations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Fresh_Class
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Fresh_Monad.html">Fresh_Monad</a>
  <a href="Name.html">Name</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fresh<span class="antiquote"><span class="antiquote">}</span></span></span></span> locale allows arbitrary instantiations. However, this may be inconvenient to
  use. The following class serves as a global instantiation that can be used without interpretation.
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>arb›</span></span></span></span> parameter of the locale redirects to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> default<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  Some instantiations are provided. For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">name</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s, underscores are appended to generate a fresh
  name.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> fresh <span class="main">=</span> linorder <span class="main">+</span> default <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="quoted">"<span class="free"><span class="free"><span class="free">next</span></span></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> next_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Fresh_Monad.fresh <span class="quoted"><span class="quoted">"next"</span></span> <span class="quoted">default</span>
  <span class="keyword2"><span class="keyword">defines</span></span> fresh_create <span class="main">=</span> <span class="quoted">create</span>
      <span class="keyword2"><span class="keyword">and</span></span> fresh_Next <span class="main">=</span> <span class="quoted">Next</span>
      <span class="keyword2"><span class="keyword">and</span></span> fresh_fNext <span class="main">=</span> <span class="quoted">fNext</span>
      <span class="keyword2"><span class="keyword">and</span></span> fresh_frun <span class="main">=</span> <span class="quoted">frun_fresh</span>
      <span class="keyword2"><span class="keyword">and</span></span> fresh_run <span class="main">=</span> <span class="quoted">run_fresh</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> next <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> next_ge<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_frun <span class="free">m</span> <span class="free">S</span> <span class="main">=</span> fst <span class="main">(</span>run_state <span class="free">m</span> <span class="main">(</span>fresh_fNext <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fNext_def fresh_frun_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fresh_run <span class="free">m</span> <span class="free">S</span> <span class="main">=</span> fst <span class="main">(</span>run_state <span class="free">m</span> <span class="main">(</span>fresh_Next <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_Next_def fresh_run_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> nat <span class="main">::</span> <span class="quoted">fresh</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">default_nat</span></span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">default_nat</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">next_nat</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">next_nat</span> <span class="main">=</span> Suc"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> next_nat_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> char <span class="main">::</span> <span class="quoted">default</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">default_char</span></span> <span class="main">::</span> <span class="quoted">char</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">default_char</span> <span class="main">=</span> <span class="keyword1">CHR</span> <span class="inner_quoted">''_''</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> name <span class="main">::</span> <span class="quoted">fresh</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">default_name</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">default_name</span> <span class="main">=</span> Name <span class="inner_quoted">''_''</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">next_name</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">next_name</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> Name.append <span class="free"><span class="bound"><span class="entity">xs</span></span></span> default"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted">name</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">&lt;</span> next <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> next_name_def default_name_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> name_append_less<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">export_code</span></span>
  <span class="quoted"><span class="quoted">fresh_create</span></span> <span class="quoted"><span class="quoted">fresh_Next</span></span> <span class="quoted"><span class="quoted">fresh_fNext</span></span> <span class="quoted"><span class="quoted">fresh_frun</span></span> <span class="quoted"><span class="quoted">fresh_run</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> Scala<span class="main">?</span> SML<span class="main">?</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Term_Class">
<div class="head">
<h1>Theory Term_Class</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Terms›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term_Class
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="../Datatype_Order_Generator/Order_Generator.html">Datatype_Order_Generator.Order_Generator</a>
  <a href="Name.html">Name</a>
  <a href="Term_Utils.html">Term_Utils</a>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Disjoint_FSets.html">HOL-Library.Disjoint_FSets</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_type</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> <span class="quoted">"term"</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A simple term type, modelled after Pure's <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>term›</span></span></span></span> type›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="quoted">"term"</span> <span class="main">=</span>
  Const <span class="quoted">name</span> <span class="main">|</span>
  Free <span class="quoted">name</span> <span class="main">|</span>
  Abs <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Λ</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>71<span class="main">]</span> 71<span class="main">)</span> <span class="main">|</span>
  Bound <span class="quoted">nat</span> <span class="main">|</span>
  App <span class="quoted"><span class="quoted">"term"</span></span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted"><span class="quoted">"term"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A type class describing terms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The type class is split into two parts, <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹pre-terms›</span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹terms›</span></span>. The only difference is that
  terms assume more axioms about substitution (see below).

  A term must provide the following generic constructors that behave like regular free constructors:

  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>const :: name ⇒ τ›</span></span></span></span>
  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>free :: name ⇒ τ›</span></span></span></span>
  <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>app :: τ ⇒ τ ⇒ τ›</span></span></span></span>
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Conversely, there are also three corresponding destructors that could be defined in terms of
  Hilbert's choice operator. However, I have instead opted to let instances define destructors
  directly, which is simpler for execution purposes.

  Besides the generic constructors, terms may also contain other constructors. Those are abstractly
  called <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹abstractions›</span></span>, even though that name is not entirely accurate (bound variables may also
  fall under this).

  Additionally, there must be operations that compute the list of all free variables (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>frees›</span></span></span></span>),
  constants (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>consts›</span></span></span></span>), and substitutions (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>subst›</span></span></span></span>). Pre-terms only assume some basic properties of
  substitution on the generic constructors.

  Most importantly, substitution is not specified for environments containing terms with free
  variables. Term types are not required to implement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span>-renaming to prevent capturing of
  variables.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_term <span class="main">=</span> size <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free"><span class="free"><span class="free">frees</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free"><span class="free"><span class="free">subst</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted">"<span class="free"><span class="free"><span class="free">consts</span></span></span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name fset"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free"><span class="free"><span class="free">app</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free"><span class="free"><span class="free">unapp</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free"><span class="free"><span class="free">const</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free"><span class="free"><span class="free">unconst</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name option"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free"><span class="free"><span class="free">free</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free"><span class="free"><span class="free">unfree</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name option"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unapp_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">unapp</span> <span class="main">(</span><span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app_unapp<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">unapp</span> <span class="free">u</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span><span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> size <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> size <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unconst_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">unconst</span> <span class="main">(</span><span class="free">const</span> <span class="free">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> const_unconst<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">unconst</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">name</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">const</span> <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unfree_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">unfree</span> <span class="main">(</span><span class="free">free</span> <span class="free">name</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free_unfree<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">unfree</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">name</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">=</span> <span class="free">free</span> <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app_const_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">const</span> <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app_free_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≠</span> <span class="free">free</span> <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free_const_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">const</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> frees_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">frees</span> <span class="main">(</span><span class="free">const</span> <span class="free">name</span><span class="main">)</span> <span class="main">=</span> fempty"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> frees_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">frees</span> <span class="main">(</span><span class="free">free</span> <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free">name</span> <span class="main">|}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> frees_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">frees</span> <span class="main">(</span><span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> <span class="free">frees</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consts_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">consts</span> <span class="main">(</span><span class="free">free</span> <span class="free">name</span><span class="main">)</span> <span class="main">=</span> fempty"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consts_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">consts</span> <span class="main">(</span><span class="free">const</span> <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free">name</span> <span class="main">|}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> consts_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">consts</span> <span class="main">(</span><span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> <span class="free">consts</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> <span class="free">app</span> <span class="main">(</span><span class="free">subst</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span><span class="free">subst</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">env</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free">const</span> <span class="free">name</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> <span class="free">const</span> <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free">free</span> <span class="free">name</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free">env</span> <span class="free">name</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">free</span> <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> free_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">free</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">free</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> const_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">const</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">const</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app_inject<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">app</span> <span class="free">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>4</sub></span> <span class="main">⟹</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">u<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">∧</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">u<span class="hidden">⇩</span><sub>4</sub></span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"term"</span> <span class="main">::</span> <span class="quoted">pre_term</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_term</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unapp_term</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">const_term</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_term</span> <span class="main">=</span> Const"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unconst_term</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_term</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_term</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_term</span> <span class="main">=</span> Free"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unfree_term</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_term</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">frees_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">frees_term</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">frees_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_term</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">subst_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> term<span class="main">)</span> fmap <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> Free <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">$</span> <span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="keyword1">Λ</span> <span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">consts_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consts_term</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">consts_term</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_term</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_term</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
      <span class="main">(</span><span class="operator">auto</span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def const_term_def free_term_def
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> unapp_term.elims unconst_term.elims unfree_term.elims
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> pre_term <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">freess</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">freess</span> <span class="main">=</span> ffUnion <span class="main">∘</span> fset_of_list <span class="main">∘</span> map frees"</span></span>

<span class="keyword1" id="Term_Class-freess_cons"><span class="command">lemma</span></span> freess_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"freess <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">x</span> <span class="main">|∪|</span> freess <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> freess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-freess_single"><span class="command">lemma</span></span> freess_single<span class="main">:</span> <span class="quoted"><span class="quoted">"freess <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> frees <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> freess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-freess_empty"><span class="command">lemma</span></span> freess_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"freess <span class="main">[]</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> freess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-freess_app"><span class="command">lemma</span></span> freess_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"freess <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> freess <span class="free">xs</span> <span class="main">|∪|</span> freess <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> freess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-freess_subset"><span class="command">lemma</span></span> freess_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> set <span class="free">ys</span> <span class="main">⟹</span> freess <span class="free">xs</span> <span class="main">|⊆|</span> freess <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> freess_def comp_apply
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ffunion_mono fset_of_list_subset<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">id_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">id_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> free <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closed_except</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name fset <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closed_except</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> frees <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|⊆|</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">closed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> closed_except <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> term_inject <span class="main">=</span> free_inject const_inject app_inject

<span class="keyword1"><span class="command">lemmas</span></span> term_distinct<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  app_const_distinct app_const_distinct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  app_free_distinct app_free_distinct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  free_const_distinct free_const_distinct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>

<span class="keyword1" id="Term_Class-app_size1"><span class="command">lemma</span></span> app_size1<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> size <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-app_size2"><span class="command">lemma</span></span> app_size2<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">&lt;</span> size <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-unx_some_lemmas"><span class="command">lemma</span></span> unx_some_lemmas<span class="main">:</span>
  <span class="quoted"><span class="quoted">"unapp <span class="free">u</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> unconst <span class="free">u</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unapp <span class="free">u</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> unfree <span class="free">u</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unconst <span class="free">u</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> unapp <span class="free">u</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unconst <span class="free">u</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> unfree <span class="free">u</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unfree <span class="free">u</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟹</span> unconst <span class="free">u</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unfree <span class="free">u</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟹</span> unapp <span class="free">u</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_unapp const_unconst app_const_distinct not_None_eq surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_free_distinct app_unapp free_unfree option.exhaust surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_unapp const_unconst app_const_distinct old.prod.exhaust option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.expand option.sel<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> const_unconst free_const_distinct free_unfree option.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> const_unconst free_const_distinct free_unfree option.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_free_distinct app_unapp free_unfree not_Some_eq surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Term_Class-unx_none_simps"><span class="command">lemma</span></span> unx_none_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unapp <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unapp <span class="main">(</span>free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unconst <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unconst <span class="main">(</span>free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unfree <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="quoted"><span class="quoted">"unfree <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_unapp app_const_distinct not_None_eq surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_free_distinct app_unapp option.exhaust surj_pair<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> const_unconst app_const_distinct option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.expand option.sel<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> const_unconst free_const_distinct option.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> free_const_distinct free_unfree option.exhaust<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> app_free_distinct free_unfree not_Some_eq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Term_Class-term_cases"><span class="command">lemma</span></span> term_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>free<span class="main">)</span> <span class="free">name</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> free <span class="free">name</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>const<span class="main">)</span> <span class="free">name</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> const <span class="free">name</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>app<span class="main">)</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>other<span class="main">)</span> <span class="quoted"><span class="quoted">"unfree <span class="free">t</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"unapp <span class="free">t</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"unconst <span class="free">t</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unfree <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unconst <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unapp <span class="free">t</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_const</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_const</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span>unconst <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">const_name</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_name</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> unconst <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Some <span class="bound">name</span> <span class="main">⇒</span> <span class="bound">name</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-is_const_simps"><span class="command">lemma</span></span> is_const_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>const <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_const <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_const <span class="main">(</span>free <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_const_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Class-const_name_simps"><span class="command">lemma</span></span> const_name_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"const_name <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="free">name</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_const <span class="free">t</span> <span class="main">⟹</span> const <span class="main">(</span>const_name <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> const_name_def is_const_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_free</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_free</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span>unfree <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">free_name</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_name</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> unfree <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Some <span class="bound">name</span> <span class="main">⇒</span> <span class="bound">name</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-is_free_simps"><span class="command">lemma</span></span> is_free_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_free <span class="main">(</span>free <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_free <span class="main">(</span>const <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_free <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Class-free_name_simps"><span class="command">lemma</span></span> free_name_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"free_name <span class="main">(</span>free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="free">name</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_free <span class="free">t</span> <span class="main">⟹</span> free <span class="main">(</span>free_name <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> free_name_def is_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_app</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_app</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span>unapp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">left</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">left</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> unapp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">l</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">right</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">right</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> unapp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">r</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-app_simps"><span class="command">lemma</span></span> app_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_app <span class="main">(</span>const <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_app <span class="main">(</span>free <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_app <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_app_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Class-left_right_simps"><span class="command">lemma</span></span> left_right_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"left <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="quoted"><span class="quoted">"right <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"is_app <span class="free">t</span> <span class="main">⟹</span> app <span class="main">(</span>left <span class="free">t</span><span class="main">)</span> <span class="main">(</span>right <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_app_def left_def right_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ids</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">ids</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> frees <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|∪|</span> consts <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term_Class-closed_except_const"><span class="command">lemma</span></span> closed_except_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">closed_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">closed_env</span> <span class="main">≡</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> closed<span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-closed_except_self"><span class="command">lemma</span></span> closed_except_self<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> <span class="quoted">"term"</span> <span class="main">=</span> pre_term <span class="main">+</span> size <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free"><span class="free"><span class="free">abs_pred</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    raw_induct<span class="main">[</span><span class="operator">case_names</span> const free app abs<span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>const <span class="bound">name</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>free <span class="bound">name</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>app <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">abs_pred</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span>
        <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    raw_subst_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">abs_pred</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span><span class="main">.</span> id_env <span class="bound">env</span> <span class="main">⟶</span> subst <span class="bound">t</span> <span class="bound">env</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    raw_subst_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">abs_pred</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="main">|∉|</span> frees <span class="bound">t</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env</span><span class="main">.</span> subst <span class="bound">t</span> <span class="main">(</span>fmdrop <span class="free">x</span> <span class="bound">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="bound">t</span> <span class="bound">env</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    raw_subst_indep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">abs_pred</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> closed_env <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟶</span> fdisjnt <span class="main">(</span>fmdom <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>fmdom <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟶</span> subst <span class="bound">t</span> <span class="main">(</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="bound">t</span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    raw_subst_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">abs_pred</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">env</span><span class="main">.</span> closed_env <span class="bound">env</span> <span class="main">⟶</span> frees <span class="main">(</span>subst <span class="bound">t</span> <span class="bound">env</span><span class="main">)</span> <span class="main">=</span> frees <span class="bound">t</span> <span class="main">|-|</span> fmdom <span class="bound">env</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    raw_subst_consts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">abs_pred</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> consts <span class="main">(</span>subst <span class="bound">a</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> consts <span class="bound">a</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="bound">x</span> <span class="main">(</span>frees <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    abs_pred_trivI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">abs_pred</span> <span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Term_Class-subst_id"><span class="command">lemma</span></span> subst_id<span class="main">:</span> <span class="quoted"><span class="quoted">"id_env <span class="free">env</span> <span class="main">⟹</span> subst <span class="free">t</span> <span class="free">env</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_subst_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_drop"><span class="command">lemma</span></span> subst_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">|∉|</span> frees <span class="free">t</span> <span class="main">⟹</span> subst <span class="free">t</span> <span class="main">(</span>fmdrop <span class="free">x</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_subst_drop<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_frees"><span class="command">lemma</span></span> subst_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> closed<span class="main">)</span> <span class="free">env</span> <span class="main">⟹</span> frees <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span> <span class="main">|-|</span> fmdom <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_subst_frees<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_consts'"><span class="command">lemma</span></span> subst_consts'<span class="main">:</span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">t</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>consts <span class="main">|`|</span> fmimage <span class="free">env</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ffUnion_alt_def fmlookup_ran_iff fmlookup_image_iff fmlookup_dom_iff
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fBexI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_subst_consts'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> funion_image_bind_eq finter_funion_distrib fbind_funion<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">←</span> unapp <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">;</span>
  <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">←</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
  <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">←</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
  Some <span class="main">(</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
<span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> unconst <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> None
  <span class="main">|</span> Some <span class="bound">name'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">=</span> <span class="bound">name'</span> <span class="keyword1">then</span> Some fmempty <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> Some <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>Bound <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>Abs <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1" id="Term_Class-match_simps"><span class="command">lemma</span></span> match_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">←</span> match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">;</span>
    <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">←</span> match <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">;</span>
    Some <span class="main">(</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"match <span class="main">(</span>Const <span class="free">name</span><span class="main">)</span> <span class="main">(</span>const <span class="free">name'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">name</span> <span class="main">=</span> <span class="free">name'</span> <span class="keyword1">then</span> Some fmempty <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-match_some_induct"><span class="command">lemma</span></span> match_some_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> app const free<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> match <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> match <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>app <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Const <span class="bound">name</span><span class="main">)</span> <span class="main">(</span>const <span class="bound">name</span><span class="main">)</span> fmempty"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">u</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Free <span class="bound">name</span><span class="main">)</span> <span class="bound">u</span> <span class="main">(</span>fmupd <span class="bound">name</span> <span class="bound">u</span> fmempty<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">u</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_bindE<span class="main">)</span>

<span class="keyword1" id="Term_Class-match_dom"><span class="command">lemma</span></span> match_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span> <span class="main">⟹</span> fmdom <span class="free">env</span> <span class="main">=</span> frees <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">env</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_bindE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Class-match_vars"><span class="command">lemma</span></span> match_vars<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free">p</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span> <span class="main">⟹</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">u</span><span class="main">.</span> frees <span class="bound">u</span> <span class="main">|⊆|</span> frees <span class="free">t</span><span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_some_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">using</span></span> app
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmpred_mono_strong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-match_appE_split"><span class="command">lemma</span></span> match_appE_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">env</span> <span class="main">=</span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_bindE<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_consts"><span class="command">lemma</span></span> subst_consts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"consts <span class="free">t</span> <span class="main">|⊆|</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">u</span><span class="main">.</span> consts <span class="bound">u</span> <span class="main">|⊆|</span> <span class="free">S</span><span class="main">)</span> <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_consts'<span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ffUnion_least<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_empty"><span class="command">lemma</span></span> subst_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> fmempty <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_id<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_drop_fset"><span class="command">lemma</span></span> subst_drop_fset<span class="main">:</span> <span class="quoted"><span class="quoted">"fdisjnt <span class="free">S</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> subst <span class="free">t</span> <span class="main">(</span>fmdrop_fset <span class="free">S</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_drop fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_restrict"><span class="command">lemma</span></span> subst_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">|⊆|</span> <span class="free">M</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="free">M</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="free">M</span> <span class="free">env</span> <span class="main">=</span> fmdrop_fset <span class="main">(</span>fmdom <span class="free">env</span> <span class="main">-</span> <span class="free">M</span><span class="main">)</span> <span class="free">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_drop_fset<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_restrict'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_restrict<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">|∈|</span> frees <span class="free">t</span> <span class="main">⟹</span> fmlookup <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> fmlookup <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">Γ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">Γ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fmap_ext<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_restrict'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_add_disjnt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_restrict'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmempty <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmfilter_false<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_add_shadowed_env<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">|⊆|</span> fmdom <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>fmdom <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fmadd_drop_left_dom<span class="main">)</span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>fmdom <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_restrict'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fmdrop_fset <span class="main">(</span>fmdom <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmempty <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fmfilter_alt_defs
    <span class="keyword1"><span class="command">using</span></span> fsubsetD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> subst_restrict_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="free">S</span> <span class="main">⟹</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="free">S</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_restrict closed_except_def<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_closed_except_id"><span class="command">lemma</span></span> subst_closed_except_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="free">env</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="free">env</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fdisjnt_subset_right fmdom_drop_fset fminus_cancel fmrestrict_fset_dom
          fmrestrict_fset_null closed_except_def subst_drop_fset subst_empty<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_closed_except_preserved"><span class="command">lemma</span></span> subst_closed_except_preserved<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">t</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="free">env</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_closed_except_id<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_closed_id<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> subst <span class="free">t</span> <span class="free">env</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_closed_except_id fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> subst_closed_preserved<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> closed <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subst_closed_except_preserved fdisjnt_alt_def<span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Term_Class-subst_indep0"><span class="command">lemma</span></span> subst_indep0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>fmdom <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">env<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> raw_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed_env <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmpred_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">name</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_closed_id<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> raw_subst_indep<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-subst_indep"><span class="command">lemma</span></span> subst_indep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_restrict'<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fmlookup_add fmlookup_restrict_fset subst_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span> <span class="main">|-|</span> fmdom <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subst_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmfilter_alt_defs<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="free">t</span> <span class="main">|-|</span> fmdom <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_indep0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> fmdom_restrict_fset
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="main">(</span>fmrestrict_fset <span class="main">(</span>frees <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subst_frees<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Class-subst_indep'"><span class="command">lemma</span></span> subst_indep'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ'</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fmdom <span class="free">Γ'</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="main">(</span><span class="free">Γ'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ</span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_indep fmadd_disjnt<span class="main">)</span>

<span class="keyword1" id="Term_Class-subst_twice"><span class="command">lemma</span></span> subst_twice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>subst <span class="free">t</span> <span class="free">Γ'</span><span class="main">)</span> <span class="free">Γ</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span><span class="free">Γ</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_indep<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> subst <span class="free">t</span> <span class="free">Γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subst_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Γ'</span> <span class="keyword1">⊆<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">Γ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fmsubset_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">matchs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">matchs</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> Some fmempty"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">matchs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span> <span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">←</span> match <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">;</span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">←</span> <span class="free">matchs</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">us</span></span></span><span class="main">;</span> Some <span class="main">(</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">matchs</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> matchs_induct <span class="main">=</span> matchs.induct<span class="main">[</span><span class="operator">case_names</span> empty cons<span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Term_Class-matchs_alt_def0"><span class="command">lemma</span></span> matchs_alt_def0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map_option <span class="main">(</span><span class="main">λ</span><span class="bound">env</span><span class="main">.</span> <span class="free">m</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env</span><span class="main">)</span> <span class="main">(</span>matchs <span class="free">ps</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 match <span class="free">ps</span> <span class="free">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match <span class="skolem">x</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> x_y<span class="main">:</span> Some
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"matchs <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">with</span></span> x_y Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> Some
          <span class="keyword1"><span class="command">with</span></span> x_y <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> option.map_comp<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_option_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-matchs_alt_def"><span class="command">lemma</span></span> matchs_alt_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ps</span> <span class="free">vs</span> <span class="main">=</span> map_option <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> fmempty<span class="main">)</span> <span class="main">(</span>those <span class="main">(</span>map2 match <span class="free">ps</span> <span class="free">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> matchs_alt_def0<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">fmempty</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.map_ident<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Term_Class-matchs_neq_length_none"><span class="command">lemma</span></span> matchs_neq_length_none<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≠</span> length <span class="free">ys</span> <span class="main">⟹</span> matchs <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> matchs_some_eq_length<span class="main">:</span> <span class="quoted"><span class="quoted">"matchs <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">env</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> matchs_neq_length_none<span class="main">)</span>

<span class="keyword1" id="Term_Class-matchs_app"><span class="command">lemma</span></span> matchs_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> length <span class="free">ys<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span><span class="free">xs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">xs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">ys<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="free">ys<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span>
          matchs <span class="free">xs<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">ys<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> matchs <span class="free">xs<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">ys<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⤜</span> <span class="main">(</span><span class="main">λ</span><span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> Some <span class="main">(</span><span class="bound">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="bound">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ys<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> matchs_appI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">xs'</span> <span class="free">ys'</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">xs'</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">ys'</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Option.bind_lunit matchs_app matchs_some_eq_length<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> matchs_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ps</span> <span class="free">ts</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmdom <span class="free">env</span> <span class="main">=</span> freess <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs_induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> match_dom <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_bindE<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap <span class="main">×</span> term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">find_match</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">find_match</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> match <span class="free"><span class="bound"><span class="entity">pat</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">env</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="free">find_match</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-find_match_map"><span class="command">lemma</span></span> find_match_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"find_match <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">pat</span><span class="main">,</span> <span class="free">f</span> <span class="bound">pat</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span>
    map_option <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">pat</span><span class="main">,</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">env</span><span class="main">,</span> <span class="bound">pat</span><span class="main">,</span> <span class="free">f</span> <span class="bound">pat</span> <span class="bound">rhs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_match <span class="free">cs</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-find_match_elem"><span class="command">lemma</span></span> find_match_elem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_match <span class="free">cs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-match_subst_closed"><span class="command">lemma</span></span> match_subst_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"closed_except <span class="free">rhs</span> <span class="main">(</span>frees <span class="free">pat</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>subst <span class="free">rhs</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fminusE fmpred_iff fset_mp fsubsetI closed_except_def match_vars match_dom subst_frees<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rewrite_step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rewrite_step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> map_option <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">(</span>match <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rewrite_step'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword3">/ </span><span class="keyword1">⊢</span><span class="keyword3">/ </span>_ <span class="keyword1">→</span><span class="keyword3">/ </span>_"</span> <span class="main">[</span>50<span class="main">,</span>0<span class="main">,</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main"><span class="free">⊢</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> rewrite_step <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Term_Class-rewrite_step_closed"><span class="command">lemma</span></span> rewrite_step_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|⊆|</span> frees <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊢</span> <span class="free">u</span> <span class="main">→</span> <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span>subst <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> match_subst_closed<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> pat <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> closed_except_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≲</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">≲</span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">env</span><span class="main">.</span> subst <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">env</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-matchesI"><span class="command">lemma</span></span> matchesI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="free">env</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≲</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-matchesE"><span class="command">lemma</span></span> matchesE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≲</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">env</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> <span class="free">env</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">overlapping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">overlapping</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≲</span> <span class="bound">u</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≲</span> <span class="bound">u</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-overlapping_refl"><span class="command">lemma</span></span> overlapping_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"overlapping <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Term_Class-overlapping_sym"><span class="command">lemma</span></span> overlapping_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"overlapping <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> overlapping <span class="free">u</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-overlappingI"><span class="command">lemma</span></span> overlappingI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≲</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≲</span> <span class="free">u</span> <span class="main">⟹</span> overlapping <span class="free">s</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-overlappingE"><span class="command">lemma</span></span> overlappingE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"overlapping <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">u</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≲</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≲</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> overlapping_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">non_overlapping</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">¬</span> overlapping <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">corollary</span></span> non_overlapping_implies_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"non_overlapping <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≠</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> overlapping_refl<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">rewrite_first</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>term<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
match<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free"><span class="bound"><span class="entity">pat</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⟹</span> <span class="free">rewrite_first</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>subst <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
nomatch<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free"><span class="bound"><span class="entity">pat</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">rewrite_first</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">⟹</span> <span class="free">rewrite_first</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">pat</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="main">(</span>modes<span class="main">:</span> i ⇒ i ⇒ o ⇒ bool<span class="main">)</span> <span class="quoted"><span class="quoted">rewrite_first</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Term_Class-rewrite_firstE"><span class="command">lemma</span></span> rewrite_firstE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rewrite_first <span class="free">cs</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">pat</span> <span class="free">rhs</span> <span class="free">env</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">cs</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">=</span> subst <span class="free">rhs</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This doesn't follow from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] find_match_elem<span class="antiquote"><span class="antiquote">}</span></span></span></span>, because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rewrite_first<span class="antiquote"><span class="antiquote">}</span></span></span></span> requires
  the first match, not just any.
›</span></span>

<span class="keyword1" id="Term_Class-find_match_rewrite_first"><span class="command">lemma</span></span> find_match_rewrite_first<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_match <span class="free">cs</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">env</span><span class="main">,</span> <span class="free">pat</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rewrite_first <span class="free">cs</span> <span class="free">t</span> <span class="main">(</span>subst <span class="free">rhs</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">c</span> <span class="skolem">cs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pat0</span></span> <span class="skolem"><span class="skolem">rhs0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">pat0</span><span class="main">,</span> <span class="skolem">rhs0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match <span class="skolem">pat0</span> <span class="free">t</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rewrite_first.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">term_cases</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>name <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">term_cases</span> <span class="free"><span class="bound"><span class="entity">if_const</span></span></span> <span class="free"><span class="bound"><span class="entity">if_free</span></span></span> <span class="free"><span class="bound"><span class="entity">if_app</span></span></span> <span class="free"><span class="bound"><span class="entity">otherwise</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> unconst <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">name</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">if_const</span></span></span> <span class="bound">name</span> <span class="main">|</span>
    None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> unfree <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
      Some <span class="bound">name</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">if_free</span></span></span> <span class="bound">name</span> <span class="main">|</span>
      None <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">case</span> unapp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
          Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">if_app</span></span></span> <span class="bound">t</span> <span class="bound">u</span>
        <span class="main">|</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">otherwise</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-term_cases_cong"><span class="command">lemma</span></span> term_cases_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">otherwise1</span> <span class="main">=</span> <span class="free">otherwise2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> const <span class="bound">name</span> <span class="main">⟹</span> <span class="free">if_const1</span> <span class="bound">name</span> <span class="main">=</span> <span class="free">if_const2</span> <span class="bound">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> free <span class="bound">name</span> <span class="main">⟹</span> <span class="free">if_free1</span> <span class="bound">name</span> <span class="main">=</span> <span class="free">if_free2</span> <span class="bound">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> app <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">if_app1</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">if_app2</span> <span class="bound">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"term_cases <span class="free">if_const1</span> <span class="free">if_free1</span> <span class="free">if_app1</span> <span class="free">otherwise1</span> <span class="free">t</span> <span class="main">=</span> term_cases <span class="free">if_const2</span> <span class="free">if_free2</span> <span class="free">if_app2</span> <span class="free">otherwise2</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">unfolding</span></span> term_cases_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-term_cases"><span class="command">lemma</span></span> term_cases<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"term_cases <span class="free">if_const</span> <span class="free">if_free</span> <span class="free">if_app</span> <span class="free">otherwise</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="free">if_const</span> <span class="free">name</span>"</span></span>
  <span class="quoted"><span class="quoted">"term_cases <span class="free">if_const</span> <span class="free">if_free</span> <span class="free">if_app</span> <span class="free">otherwise</span> <span class="main">(</span>free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="free">if_free</span> <span class="free">name</span>"</span></span>
  <span class="quoted"><span class="quoted">"term_cases <span class="free">if_const</span> <span class="free">if_free</span> <span class="free">if_app</span> <span class="free">otherwise</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">if_app</span> <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> term_cases_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-term_cases_template"><span class="command">lemma</span></span> term_cases_template<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> term_cases <span class="free">if_const</span> <span class="free">if_free</span> <span class="free">if_app</span> <span class="free">otherwise</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="free">if_const</span> <span class="free">name</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>free <span class="free">name</span><span class="main">)</span> <span class="main">=</span> <span class="free">if_free</span> <span class="free">name</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="free">if_app</span> <span class="free">t</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term_cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="quoted">"term"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">strip_comb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">strip_comb</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> unapp <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span>
    Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">args</span><span class="main">)</span> <span class="main">=</span> <span class="free">strip_comb</span> <span class="bound">t</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">args</span> <span class="main">@</span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="comment1">(* FIXME why is this not automatic? *)</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure size"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Term_Class-strip_comb_simps"><span class="command">lemma</span></span> strip_comb_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"strip_comb <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">args</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="free">t</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">args</span> <span class="main">@</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"unapp <span class="free">t</span> <span class="main">=</span> None <span class="main">⟹</span> strip_comb <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> strip_comb.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_Class-strip_comb_induct"><span class="command">lemma</span></span> strip_comb_induct<span class="main">[</span><span class="operator">case_names</span> app no_app<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>app <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> unapp <span class="bound">t</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> strip_comb.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unapp <span class="skolem">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> 1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Class-strip_comb_size"><span class="command">lemma</span></span> strip_comb_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> set <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">t'</span> <span class="main">&lt;</span> size <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-sstrip_comb_termination"><span class="command">lemma</span></span> sstrip_comb_termination<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> strip_comb <span class="free">t</span> <span class="main">⟹</span> <span class="free">t'</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> size <span class="free">t'</span> <span class="main">&lt;</span> size <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv strip_comb_size<span class="main">)</span>

<span class="keyword1" id="Term_Class-strip_comb_empty"><span class="command">lemma</span></span> strip_comb_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> fst <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-strip_comb_app"><span class="command">lemma</span></span> strip_comb_app<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>strip_comb <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">list_comb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">list_comb</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">list_comb</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">list_comb</span> <span class="main">(</span>app <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1" id="Term_Class-list_comb_app"><span class="command">lemma</span></span> list_comb_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_comb <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> list_comb <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> list_comb_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"app <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> list_comb <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term_Class-list_comb_size"><span class="command">lemma</span></span> list_comb_size<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> size <span class="free">f</span> <span class="main">+</span> size_list size <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-subst_list_comb"><span class="command">lemma</span></span> subst_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> list_comb <span class="main">(</span>subst <span class="free">f</span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> subst <span class="bound">t</span> <span class="free">env</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">const_list_comb</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$$</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_list_comb</span> <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="main">≡</span> list_comb <span class="main">(</span>const <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_Class-list_strip_comb"><span class="command">lemma</span></span> list_strip_comb<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_comb <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Term_Class-strip_list_comb"><span class="command">lemma</span></span> strip_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_comb <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">f</span><span class="main">)</span><span class="main">,</span> snd <span class="main">(</span>strip_comb <span class="free">f</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1" id="Term_Class-strip_list_comb_const"><span class="command">lemma</span></span> strip_list_comb_const<span class="main">:</span> <span class="quoted"><span class="quoted">"strip_comb <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>const <span class="free">name</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb<span class="main">)</span>

<span class="keyword1" id="Term_Class-frees_list_comb"><span class="command">lemma</span></span> frees_list_comb<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>list_comb <span class="free">t</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span> <span class="main">|∪|</span> freess <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> freess_def<span class="main">)</span>

<span class="keyword1" id="Term_Class-consts_list_comb"><span class="command">lemma</span></span> consts_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">f</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>fset_of_list <span class="main">(</span>map consts <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-ids_list_comb"><span class="command">lemma</span></span> ids_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"ids <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> ids <span class="free">f</span> <span class="main">|∪|</span> ffUnion <span class="main">(</span>fset_of_list <span class="main">(</span>map ids <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> ids_def frees_list_comb consts_list_comb freess_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> fbind_iff finsert_absorb finsert_fsubset funion_image_bind_eq inf_sup_ord<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fbind_iff funionCI funion_image_bind_eq<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fbind_iff funionE funion_image_bind_eq<span class="main">)</span>

<span class="keyword1" id="Term_Class-frees_strip_comb"><span class="command">lemma</span></span> frees_strip_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">=</span> frees <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">|∪|</span> freess <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_strip_comb frees_list_comb<span class="main">)</span>

<span class="keyword1" id="Term_Class-list_comb_cases'"><span class="command">lemma</span></span> list_comb_cases'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>app<span class="main">)</span> <span class="quoted"><span class="quoted">"is_app <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>empty<span class="main">)</span> <span class="quoted"><span class="quoted">"list_comb <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(* FIXME case names? *)</span>
<span class="keyword1" id="Term_Class-list_comb_cases"><span class="command">lemma</span></span> list_comb_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> list_comb <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>head<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>app<span class="main">)</span> <span class="free">u</span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> app <span class="free">u</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_comb_cases' left_right_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">left_nesting</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">left_nesting</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> term_cases <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> Suc <span class="main">(</span><span class="free">left_nesting</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> left_nesting_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> term_cases_template<span class="main">[</span><span class="operator">OF</span> left_nesting.simps<span class="main">]</span>

<span class="keyword1" id="Term_Class-list_comb_nesting"><span class="command">lemma</span></span> list_comb_nesting<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"left_nesting <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> left_nesting <span class="free">f</span> <span class="main">+</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-list_comb_cond_inj"><span class="command">lemma</span></span> list_comb_cond_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_comb <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> list_comb <span class="free">g</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="free">f</span> <span class="main">=</span> left_nesting <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"list_comb <span class="skolem">f</span> <span class="main">[]</span> <span class="main">=</span> list_comb <span class="skolem">g</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="skolem">f</span> <span class="main">=</span> left_nesting <span class="skolem">g</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="skolem">f</span> <span class="main">=</span> left_nesting <span class="skolem">g</span> <span class="main">+</span> length <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">ys</span>
  <span class="keyword3"><span class="command">assume</span></span> prems<span class="main">:</span> <span class="quoted"><span class="quoted">"list_comb <span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> list_comb <span class="skolem">g</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="skolem">f</span> <span class="main">=</span> left_nesting <span class="skolem">g</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="main">(</span>list_comb <span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> left_nesting <span class="main">(</span>list_comb <span class="skolem">g</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>left_nesting <span class="skolem">f</span> <span class="main">+</span> length <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> left_nesting <span class="skolem">g</span> <span class="main">+</span> length <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Suc_conv<span class="main">)</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prems Cons<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">zs</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"app <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">x</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"app <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">z</span></span>"</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> app_inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Class-list_comb_inj_second"><span class="command">lemma</span></span> list_comb_inj_second<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>list_comb <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> injI list_comb_cond_inj<span class="main">)</span>

<span class="keyword1" id="Term_Class-list_comb_semi_inj"><span class="command">lemma</span></span> list_comb_semi_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_comb <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> list_comb <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> left_nesting <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="free">f</span> <span class="main">=</span> left_nesting <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_comb_nesting <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_comb_cond_inj<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">no_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">no_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> term_cases <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="free">no_abs</span> <span class="bound">t</span> <span class="main">∧</span> <span class="free">no_abs</span> <span class="bound">u</span><span class="main">)</span> False <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> no_abs_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> term_cases_template<span class="main">[</span><span class="operator">OF</span> no_abs.simps<span class="main">]</span>

<span class="keyword1" id="Term_Class-no_abs_induct"><span class="command">lemma</span></span> no_abs_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> free const app<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> no_abs<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>free <span class="bound">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>const <span class="bound">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> no_abs <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> no_abs <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>app <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> no_abs.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pre_term_class.term_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹no_abs <span class="skolem">t</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> other
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹no_abs <span class="skolem">t</span>›</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> no_abs.simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> term_cases_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Class-no_abs_cases"><span class="command">lemma</span></span> no_abs_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">cases</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">pred</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> no_abs<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>free<span class="main">)</span> <span class="free">name</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> free <span class="free">name</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>const<span class="main">)</span> <span class="free">name</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> const <span class="free">name</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>app<span class="main">)</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> app <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pre_term_class.term_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹no_abs <span class="free">t</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> other
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹no_abs <span class="free">t</span>›</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> no_abs.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_cases_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_abs</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> term_cases <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> False<span class="main">)</span> True <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> is_abs_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> term_cases_template<span class="main">[</span><span class="operator">OF</span> is_abs_def<span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abs_ish</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">abs_ish</span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span> <span class="free"><span class="bound"><span class="entity">rhs</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">pats</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∨</span> is_abs <span class="free"><span class="bound"><span class="entity">rhs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> simple_syntactic_and <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">t</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">u</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Term_Class-list_comb"><span class="command">lemma</span></span> list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">f</span> <span class="main">∧</span> list_all <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> list_combE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_comb list_all_iff<span class="main">)</span>

<span class="keyword1" id="Term_Class-match"><span class="command">lemma</span></span> match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_some_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-matchs"><span class="command">lemma</span></span> matchs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">pats</span> <span class="free">ts</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pats</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> matchs.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_bindE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> subst_syntactic_and <span class="main">=</span> simple_syntactic_and <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="main">⟹</span> fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">P</span><span class="main">)</span> <span class="free">env</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Term_Class-rewrite_step"><span class="command">lemma</span></span> rewrite_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">lhs</span><span class="main">,</span> <span class="free">rhs</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">t</span> <span class="main">→</span> <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">rhs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> match subst<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> simple_syntactic_or <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>app <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">t</span> <span class="main">∨</span> <span class="free">P</span> <span class="free">u</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">notes</span></span> app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Term_Class-list_comb"><span class="command">lemma</span></span> list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">P</span> <span class="free">f</span> <span class="main">∨</span> list_ex <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-match"><span class="command">lemma</span></span> match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">pat</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_some_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> neg<span class="main">:</span> simple_syntactic_and <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> no_abs<span class="main">:</span> simple_syntactic_and <span class="quoted">no_abs</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> closed<span class="main">:</span> simple_syntactic_and <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> closed_except <span class="bound">t</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> closed<span class="main">:</span> subst_syntactic_and <span class="quoted">closed</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">rule</span> subst_closed_preserved<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> closed_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">args</span><span class="main">)</span> <span class="main">⟷</span> list_all closed <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closed.list_comb<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> term_struct_rel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>term <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_t_const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> const <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_const_const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_t_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> app <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_app_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>app <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">P_env</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">P_env</span> <span class="main">≡</span> fmrel <span class="free">P</span>"</span></span>

<span class="keyword1" id="Term_Class-related_match"><span class="command">lemma</span></span> related_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">x</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">env'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env'</span>"</span></span> <span class="quoted"><span class="quoted">"P_env <span class="free">env'</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_some_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> app <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P_t_app<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">t</span> <span class="main">(</span>app <span class="skolem">w<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> app <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"P_env <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"P_env <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>app <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> app.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">v<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="skolem">v<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"P_env <span class="main">(</span><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> P_t_const<span class="main">)</span>

<span class="keyword1" id="Term_Class-list_combI"><span class="command">lemma</span></span> list_combI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">us<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">us<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>list_comb <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">us<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">us<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.rel_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> P_app_app<span class="main">)</span>

<span class="keyword1" id="Term_Class-list_combE"><span class="command">lemma</span></span> list_combE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">args</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">args'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="free">args'</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">args'</span> <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">args</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> const <span class="free">name</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P_t_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t</span> <span class="main">(</span>app <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> app <span class="skolem">t'</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t'</span> <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P_t_app<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">t</span> <span class="main">(</span>app <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="skolem">ys</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> snoc.prems<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> app <span class="skolem">t'</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="skolem">ys</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">y</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="free">P</span> <span class="skolem">ys</span> <span class="skolem">xs</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_appendI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> term_struct_rel_strong <span class="main">=</span> term_struct_rel <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_const_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> const <span class="free">name</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_app_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>app <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> app <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∧</span> <span class="free">P</span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">P</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Term_Class-unconst_rel"><span class="command">lemma</span></span> unconst_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> unconst <span class="free">t</span> <span class="main">=</span> unconst <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P_const_t P_t_const const_name_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> is_const_def unconst_const<span class="main">)</span>

<span class="keyword1" id="Term_Class-unapp_rel"><span class="command">lemma</span></span> unapp_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> rel_option <span class="main">(</span>rel_prod <span class="free">P</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>unapp <span class="free">t</span><span class="main">)</span> <span class="main">(</span>unapp <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> P_app_t P_t_app is_app_def left_right_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.rel_sel option.sel option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rel_prod_inject unapp_app<span class="main">)</span>

<span class="keyword1" id="Term_Class-match_rel"><span class="command">lemma</span></span> match_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option P_env <span class="main">(</span>match <span class="free">p</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>match <span class="free">p</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unconst_rel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">p1</span> <span class="skolem">p2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod <span class="free">P</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span>unapp <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>unapp <span class="skolem">u</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unapp_rel<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> App
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_option_bind<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-find_match_rel"><span class="command">lemma</span></span> find_match_rel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">P</span><span class="main">)</span> <span class="free">cs</span> <span class="free">cs'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span>rel_prod P_env <span class="main">(</span>rel_prod <span class="main">(=)</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>find_match <span class="free">cs</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>find_match <span class="free">cs'</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">px</span></span> <span class="skolem"><span class="skolem">tx</span></span> <span class="skolem"><span class="skolem">py</span></span> <span class="skolem"><span class="skolem">ty</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">px</span><span class="main">,</span> <span class="skolem">tx</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">py</span><span class="main">,</span> <span class="skolem">ty</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> match_rel<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> p <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="skolem">px</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option.rel_cases<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">convert_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>term <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">convert_term</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> term_cases const free <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> app <span class="main">(</span><span class="free">convert_term</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">convert_term</span> <span class="bound">u</span><span class="main">)</span><span class="main">)</span> undefined <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> convert_term_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> term_cases_template<span class="main">[</span><span class="operator">OF</span> convert_term.simps<span class="main">]</span>

<span class="keyword1" id="Term_Class-convert_term_id"><span class="command">lemma</span></span> convert_term_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"convert_term <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-convert_term_no_abs"><span class="command">lemma</span></span> convert_term_no_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-convert_term_inj"><span class="command">lemma</span></span> convert_term_inj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t'</span>"</span></span> <span class="quoted"><span class="quoted">"convert_term <span class="free">t</span> <span class="main">=</span> convert_term <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> term_inject<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">cases</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> term_inject<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹no_abs <span class="skolem">t'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">cases</span>
    <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> term_inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_Class-convert_term_idem"><span class="command">lemma</span></span> convert_term_idem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"convert_term <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-convert_term_frees"><span class="command">lemma</span></span> convert_term_frees<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1" id="Term_Class-convert_term_consts"><span class="command">lemma</span></span> convert_term_consts<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consts <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma does not generalize to when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹match <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">u</span></span> <span class="main"><span class="main">=</span></span> None›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Assume matching
  return <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> None<span class="antiquote"><span class="antiquote">}</span></span></span></span>, because the pattern is an application and the object is a term satisfying
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> is_abs<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Now, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> convert_term<span class="antiquote"><span class="antiquote">}</span></span></span></span> applied to the object will produce <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> undefined<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Of course we don't know anything about that and whether or not that matches. A workaround would
  be to require implementations of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> term<span class="antiquote"><span class="antiquote">}</span></span></span></span> to prove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">‹<span class="main"><span class="main">∃</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">.</span></span> is_abs <span class="bound"><span class="bound">t</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, such that
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> convert_term<span class="antiquote"><span class="antiquote">}</span></span></span></span> could use that instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> undefined<span class="antiquote"><span class="antiquote">}</span></span></span></span>. This seems to be too much of a
  special case in order to be useful.
›</span></span>

<span class="keyword1" id="Term_Class-convert_term_match"><span class="command">lemma</span></span> convert_term_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="main">(</span>convert_term <span class="free">u</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>fmmap convert_term <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match_some_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Related work›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Schmidt-Schau{\ss} and Siekmann <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> schmidt1988unification<span class="antiquote"><span class="antiquote">}</span></span></span></span> discuss the concept of
  <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹unification algebras›</span></span>. They generalize terms to <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹objects›</span></span> and substitutions to <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹mappings›</span></span>.
  A unification problem can be rephrased to finding a mapping such that a set of objects are mapped
  to the same object. The advantage of this generalization is that other -- superficially unrelated
  -- problems like solving algebraic equations or querying logic programs can be seen as unification
  problems.

  In particular, the authors note that among the similarities of such problems are that ``objects
  [have] variables'' whose ``names do not matter'' and ``there exists an operation like substituting
  objects into variables''. The major difference between this formalization and their work is that I
  use concrete types for variables and mappings. Otherwise, some similarities to here can be found.

  Eder <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> eder1985properties<span class="antiquote"><span class="antiquote">}</span></span></span></span> discusses properties of substitutions with a special focus on a
  partial ordering between substitutions. However, Eder constructs and uses a concrete type of
  first-order terms, similarly to Sternagel and Thiemann <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> sternagel2018terms<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  Williams <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> williams1991instantiation<span class="antiquote"><span class="antiquote">}</span></span></span></span> defines substitutions as elements in a monoid.
  In this setting, instantiations can be represented as <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹monoid actions›</span></span>. Williams then proceeds to
  define -- for arbitrary sets of terms and variables -- the notion of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹instantiation systems,›</span></span>
  heavily drawing on notation from Schmidt-Schau{\ss} and Siekmann. Some of the presented axioms
  are also present in this formalization, as are some theorems that have a direct correspondence.
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Term">
<div class="head">
<h1>Theory Term</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Instantiation of class <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>term›</span></span></span></span> for type <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>term›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Term_Class.html">Term_Class</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"term"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  All of these definitions need to be marked as <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>code del›</span></span></span></span>; otherwise the code generator will
  attempt to generate these, which will fail because they are not executable.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_pred_term</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>term <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Bound <span class="bound">x</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="keyword1">Λ</span> <span class="bound">t'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_term_def const_term_def free_term_def app_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_term_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Term-is_const_free"><span class="command">lemma</span></span> is_const_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_const <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_const_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-is_free_app"><span class="command">lemma</span></span> is_free_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_free <span class="main">(</span><span class="free">t</span> <span class="main">$</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-is_free_free"><span class="command">lemma</span></span> is_free_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_free <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_free_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-is_const_const"><span class="command">lemma</span></span> is_const_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>Const <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_const_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Term-list_comb_free"><span class="command">lemma</span></span> list_comb_free<span class="main">:</span> <span class="quoted"><span class="quoted">"is_free <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> is_free <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> app_term_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Term-const_list_comb_free"><span class="command">lemma</span></span> const_list_comb_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_free <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">args</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_comb_free <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> const_list_comb_neq_free<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">$$</span> <span class="free">args</span> <span class="main">≠</span> free <span class="free">name'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> const_list_comb_free is_free_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> const_list_comb_neq_free<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Term-match_list_comb_list_comb_eq_lengths"><span class="command">lemma</span></span> match_list_comb_list_comb_eq_lengths<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> match <span class="free">f</span> <span class="free">g</span> <span class="keyword1">of</span>
      Some <span class="bound">env</span> <span class="main">⇒</span>
        <span class="main">(</span><span class="keyword1">case</span> those <span class="main">(</span>map2 match <span class="free">ps</span> <span class="free">vs</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="bound">envs</span> <span class="main">⇒</span> Some <span class="main">(</span>foldl <span class="keyword1">(++<span class="hidden">⇩</span><sub>f</sub>)</span> <span class="bound">env</span> <span class="bound">envs</span><span class="main">)</span>
        <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>
    <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>

<span class="keyword1" id="Term-matchs_match_list_comb"><span class="command">lemma</span></span> matchs_match_list_comb<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> matchs <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> snoc0 <span class="main">=</span> snoc
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">xs</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> matchs <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">zs</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> snoc <span class="keyword1"><span class="command">using</span></span> snoc0
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nat fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bounds</span> <span class="main">(</span>Bound <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bounds</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">bounds</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">bounds</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bounds</span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">|`|</span> <span class="main">(</span><span class="free">bounds</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="main">{|</span> <span class="main">0</span> <span class="main">|}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bounds</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shift_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">shift_nat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> nat <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> nat <span class="main">¦</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">¦</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">incr_bounds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">incr_bounds</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span>Bound <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> Bound <span class="main">(</span>shift_nat <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Bound <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr_bounds</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Λ</span> <span class="free">incr_bounds</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr_bounds</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">incr_bounds</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free">incr_bounds</span> <span class="free"><span class="bound"><span class="entity">inc</span></span></span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">incr_bounds</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term-incr_bounds_frees"><span class="command">lemma</span></span> incr_bounds_frees<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>incr_bounds <span class="free">n</span> <span class="free">k</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> incr_bounds.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-incr_bounds_zero"><span class="command">lemma</span></span> incr_bounds_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"incr_bounds <span class="main">0</span> <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replace_bound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> term <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">replace_bound</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span>Bound <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> Bound <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="keyword1">then</span> incr_bounds <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">lev</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> Bound <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">replace_bound</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free">replace_bound</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">replace_bound</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">replace_bound</span> <span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="keyword1">Λ</span> <span class="free">replace_bound</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lev</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">replace_bound</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">β_reduce</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> term <span class="main">⇒</span> term"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">[</span>_<span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="keyword1"><span class="free">]<span class="hidden">⇩</span><sub>β</sub></span></span> <span class="main">≡</span> replace_bound <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1" id="Term-replace_bound_frees"><span class="command">lemma</span></span> replace_bound_frees<span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>replace_bound <span class="free">n</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span> <span class="main">|⊆|</span> frees <span class="free">t</span> <span class="main">|∪|</span> frees <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> replace_bound.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-replace_bound_eq"><span class="command">lemma</span></span> replace_bound_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">|∉|</span> bounds <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replace_bound <span class="free">i</span> <span class="free">t</span> <span class="free">t'</span> <span class="main">=</span> incr_bounds <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wellformed'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">wellformed'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">wellformed'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Bound <span class="free"><span class="bound"><span class="entity">n'</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">wellformed'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed'</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1" id="Term-wellformed_inc"><span class="command">lemma</span></span> wellformed_inc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">k</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wellformed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wellformed</span> <span class="main">≡</span> wellformed' <span class="main">0</span>"</span></span>

<span class="keyword1" id="Term-wellformed'_replace_bound_eq"><span class="command">lemma</span></span> wellformed'_replace_bound_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"replace_bound <span class="free">k</span> <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Term-wellformed_replace_bound_eq"><span class="command">lemma</span></span> wellformed_replace_bound_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span> <span class="main">⟹</span> replace_bound <span class="free">k</span> <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wellformed'_replace_bound_eq<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term-incr_bounds_eq"><span class="command">lemma</span></span> incr_bounds_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">k</span> <span class="main">⟹</span> wellformed' <span class="free">k</span> <span class="free">t</span> <span class="main">⟹</span> incr_bounds <span class="free">i</span> <span class="free">n</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term-incr_bounds_subst"><span class="command">lemma</span></span> incr_bounds_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> fmran' <span class="free">env</span> <span class="main">⟹</span> wellformed <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"incr_bounds <span class="free">i</span> <span class="free">n</span> <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span> <span class="main">=</span> subst <span class="main">(</span>incr_bounds <span class="free">i</span> <span class="free">n</span> <span class="free">t</span><span class="main">)</span> <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fmlookup <span class="free">env</span> <span class="skolem">name</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmran'I<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"incr_bounds <span class="free">i</span> <span class="skolem">n</span> <span class="skolem">t</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> incr_bounds_eq<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term-incr_bounds_wellformed"><span class="command">lemma</span></span> incr_bounds_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">m</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>incr_bounds <span class="main">(</span>int <span class="free">k</span><span class="main">)</span> <span class="free">n</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term-replace_bound_wellformed"><span class="command">lemma</span></span> replace_bound_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">k</span> <span class="main">(</span>replace_bound <span class="free">i</span> <span class="free">t</span> <span class="free">u</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">using</span></span> incr_bounds_wellformed<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">using</span></span> wellformed_inc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Term-subst_wellformed"><span class="command">lemma</span></span> subst_wellformed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> wellformed<span class="main">)</span> <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span> <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wellformed_inc<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> wellformed<span class="main">:</span> simple_syntactic_and <span class="quoted"><span class="quoted">"wellformed' <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">n</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>

<span class="keyword1"><span class="command">global_interpretation</span></span> wellformed<span class="main">:</span> subst_syntactic_and <span class="quoted">wellformed</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> subst_wellformed<span class="main">)</span>

<span class="keyword1" id="Term-match_list_combE"><span class="command">lemma</span></span> match_list_combE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">xs</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ys</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">from</span></span> Nil<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> app <span class="skolem">t'</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="main">_</span> <span class="skolem">t</span> <span class="main">=</span> Some <span class="skolem">env</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> option_bindE<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">t'</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env</span> <span class="main">=</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> option_bindE<span class="main">)</span>

      <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"matchs <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> snoc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"matchs <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">env</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹matchs <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-left_nesting_neq_match"><span class="command">lemma</span></span> left_nesting_neq_match<span class="main">:</span>
  <span class="quoted"><span class="quoted">"left_nesting <span class="free">f</span> <span class="main">≠</span> left_nesting <span class="free">g</span> <span class="main">⟹</span> is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> match <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">f1</span> <span class="skolem">f2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1_g<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>left_nesting <span class="skolem">f1</span><span class="main">)</span> <span class="main">≠</span> left_nesting <span class="skolem">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="skolem">f1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_term_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unapp <span class="skolem">g</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">g'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g1</span></span> <span class="skolem"><span class="skolem">g2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">g1</span><span class="main">,</span> <span class="skolem">g2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> app <span class="skolem">g1</span> <span class="skolem">g2</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> f1_g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="skolem">f1</span> <span class="main">≠</span> left_nesting <span class="skolem">g1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> f1 App <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">f1</span> <span class="skolem">g1</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">g'</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">g</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Term-match_list_comb_list_comb_none_structure"><span class="command">lemma</span></span> match_list_comb_list_comb_none_structure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="free">f</span> <span class="main">≠</span> left_nesting <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta left_nesting_neq_match<span class="main">)</span>

<span class="keyword1" id="Term-match_list_comb_list_comb_some"><span class="command">lemma</span></span> match_list_comb_list_comb_some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">env</span>"</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="free">f</span> <span class="main">=</span> left_nesting <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="free">f</span> <span class="free">g</span> <span class="main">≠</span> None"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="free">f</span> <span class="free">g</span> <span class="main">≠</span> None <span class="main">∧</span> length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free">vs</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free">ps</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span> <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>app <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>app <span class="skolem">g</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">≠</span> None <span class="main">∧</span> length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="main">(</span>app <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="main">(</span>app <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> left_nesting <span class="main">(</span>app <span class="skolem">g</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="main">(</span>app <span class="skolem">f</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="main">(</span>app <span class="skolem">g</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> app_term_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> match.elims option_bindE<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">=</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_split<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="main">(</span>list_comb <span class="free">g</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> match_list_comb_list_comb_none_structure<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="free">f</span> <span class="main">≠</span> left_nesting <span class="main">(</span>list_comb <span class="free">g</span> <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">vs<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">vs</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">ps<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">=</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">@</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> length <span class="free">vs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> list_split<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="main">(</span>list_comb <span class="free">f</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> match_list_comb_list_comb_none_structure<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"left_nesting <span class="main">(</span>list_comb <span class="free">f</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> left_nesting <span class="free">g</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_const <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="main">(</span>list_comb <span class="free">f</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_list_comb<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span>list_comb <span class="free">g</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ps</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"match <span class="free">f</span> <span class="free">g</span> <span class="main">≠</span> None"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Term-match_list_comb_list_comb_none_name"><span class="command">lemma</span></span> match_list_comb_list_comb_none_name<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">≠</span> <span class="free">name'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">name'</span> <span class="main">$$</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">name'</span> <span class="main">$$</span> <span class="free">vs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">name'</span> <span class="main">$$</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span>const <span class="free">name</span><span class="main">)</span> <span class="main">(</span>const <span class="free">name'</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_list_comb_list_comb_some<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_const_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">name</span> <span class="main">=</span> <span class="free">name'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> const_term_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term-match_list_comb_list_comb_none_length"><span class="command">lemma</span></span> match_list_comb_list_comb_none_length<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">≠</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">name'</span> <span class="main">$$</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">name'</span> <span class="main">$$</span> <span class="free">vs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="free">name'</span> <span class="main">$$</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ps</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_list_comb_list_comb_some<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_const_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> term_struct_rel <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">corollary</span></span> related_matchs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ps</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ps</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"P_env <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">name</span> <span class="comment1">― ‹dummy›</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> P_const_const list_combI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"match <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ps</span><span class="main">)</span> <span class="main">(</span><span class="skolem">name</span> <span class="main">$$</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"P_env <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> related_match<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"matchs <span class="free">ps</span> <span class="free">ts<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Pats">
<div class="head">
<h1>Theory Pats</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Wellformedness of patterns›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Pats
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Term.html">Term</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> term<span class="antiquote"><span class="antiquote">}</span></span></span></span> class already defines a generic definition of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹matching›</span></span> a <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹pattern›</span></span> with a
  term. Importantly, the type of patterns is neither generic, nor a dedicated pattern type; instead,
  it is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">term</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> itself.

  Patterns are a proper subset of terms, with the restriction that no abstractions may occur and
  there must be at most a single occurrence of any variable (usually known as <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹linearity›</span></span>).
  The first restriction can be modelled in a datatype, the second cannot. Consequently, I define a
  predicate that captures both properties.

  Using linearity, many more generic properties can be proved, for example that substituting the
  environment produced by matching yields the matched term.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">linear</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">linear</span> <span class="main">(</span>Free <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">linear</span> <span class="main">(</span>Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">linear</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">linear</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> <span class="free">linear</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">∧</span> <span class="main">¬</span> is_free <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">∧</span> fdisjnt <span class="main">(</span>frees <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span>frees <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">linear</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">⟷</span> False"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> linear_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span>
  linear.simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> const_term_def<span class="main">]</span>
  linear.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> app_term_def<span class="main">]</span>

<span class="keyword1" id="Pats-linear_implies_no_abs"><span class="command">lemma</span></span> linear_implies_no_abs<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span> <span class="main">⟹</span> no_abs <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> Const
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def free_term_def app_term_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Free
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def free_term_def app_term_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> App
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def free_term_def app_term_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">linears</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">linears</span> <span class="main">[]</span> <span class="main">⟷</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">linears</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">⟷</span> linear <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> fdisjnt <span class="main">(</span>frees <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>freess <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">linears</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1" id="Pats-linears_butlastI"><span class="command">lemma</span></span> linears_butlastI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"linears <span class="free">ts</span> <span class="main">⟹</span> linears <span class="main">(</span>butlast <span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span>butlast <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" fdisjnt <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>freess <span class="main">(</span>butlast <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_right<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"freess <span class="main">(</span>butlast <span class="skolem">ts</span><span class="main">)</span> <span class="main">|⊆|</span> freess <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> freess_subset<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_set_butlastD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">ts</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pats-linears_appI"><span class="command">lemma</span></span> linears_appI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">zs</span> <span class="main">|∪|</span> freess <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_union_right<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linears <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">z</span> <span class="main">|⊆|</span> freess <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> freess_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_left<span class="main">)</span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">zs</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> freess_subset fdisjnt_subset_left<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pats-linears_linear"><span class="command">lemma</span></span> linears_linear<span class="main">:</span> <span class="quoted"><span class="quoted">"linears <span class="free">ts</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> linear <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pats-linears_singleI"><span class="command">lemma</span></span> linears_singleI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span> <span class="main">⟹</span> linears <span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freess_def fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1" id="Pats-linear_strip_comb"><span class="command">lemma</span></span> linear_strip_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span> <span class="main">⟹</span> linear <span class="main">(</span>fst <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1" id="Pats-linears_strip_comb"><span class="command">lemma</span></span> linears_strip_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span> <span class="main">⟹</span> linears <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> linears_appI linears_singleI<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"freess <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> frees_strip_comb<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_left<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freess <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pats-linears_appendD"><span class="command">lemma</span></span> linears_appendD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>freess <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_right<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"freess <span class="skolem">xs</span> <span class="main">|⊆|</span> freess <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_right<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"freess <span class="free">ys</span> <span class="main">|⊆|</span> freess <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>freess <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1" id="Pats-linear_list_comb"><span class="command">lemma</span></span> linear_list_comb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="free">f</span><span class="main">)</span> <span class="main">(</span>freess <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span>list_comb <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">x</span> <span class="main">|∪|</span> freess <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span>list_comb <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fdisjnt_subset_right<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">f</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fdisjnt_subset_right<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>freess <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fdisjnt_union_left<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> linear_list_comb'<span class="main">:</span> <span class="quoted"><span class="quoted">"linears <span class="free">xs</span> <span class="main">⟹</span> linear <span class="main">(</span><span class="free">name</span> <span class="main">$$</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> linear_list_comb <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>

<span class="keyword1" id="Pats-linear_strip_comb_cases"><span class="command">lemma</span></span> linear_strip_comb_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">pat</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>comb<span class="main">)</span> <span class="free">s</span> <span class="free">args</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="free">pat</span> <span class="main">=</span> <span class="main">(</span>Const <span class="free">s</span><span class="main">,</span> <span class="free">args</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pat</span> <span class="main">=</span> <span class="free">s</span> <span class="main">$$</span> <span class="free">args</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>free<span class="main">)</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="free">pat</span> <span class="main">=</span> <span class="main">(</span>Free <span class="free">s</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">pat</span> <span class="main">=</span> Free <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">pat</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> strip_comb_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"app.IH"</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span>Free <span class="skolem">s</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Free <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv strip_comb_empty<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">args</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"strip_comb <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span>Const <span class="skolem">s</span><span class="main">,</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> app <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strip_comb_app<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>no_app <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pats-wellformed_linearI"><span class="command">lemma</span></span> wellformed_linearI<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span> <span class="main">⟹</span> wellformed' <span class="free">n</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Pats-pat_cases"><span class="command">lemma</span></span> pat_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>free<span class="main">)</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Free <span class="free">s</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>comb<span class="main">)</span> <span class="free">name</span> <span class="free">args</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="free">args</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>nonlinear<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> linear <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Free
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> free <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Bound
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> nonlinear <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Abs
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> nonlinear <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Const <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="skolem">name</span> <span class="main">$$</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Const <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_term_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> comb<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">u</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> nonlinear <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_strip_comb_cases<span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> free
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">name</span> <span class="skolem">args</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"linears <span class="main">(</span>snd <span class="main">(</span>strip_comb <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> linears_strip_comb<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linears <span class="skolem">args</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="free">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> that comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> linear_pat_cases<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>free<span class="main">)</span> <span class="free">s</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> Free <span class="free">s</span>"</span></span>
        <span class="main">|</span> <span class="main">(</span>comb<span class="main">)</span> <span class="free">name</span> <span class="free">args</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"linears <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">name</span> <span class="main">$$</span> <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pat_cases<span class="main">)</span>

<span class="keyword1" id="Pats-linear_pat_induct"><span class="command">lemma</span></span> linear_pat_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> free comb<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Free <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">name</span> <span class="bound">args</span><span class="main">.</span> linears <span class="bound">args</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">arg</span><span class="main">.</span> <span class="bound">arg</span> <span class="main">∈</span> set <span class="bound">args</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">arg</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">name</span> <span class="main">$$</span> <span class="bound">args</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> wf_measure<span class="main">[</span><span class="operator">of</span> <span class="quoted">size</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹linear <span class="free">t</span>›</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">t</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linear_pat_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>comb <span class="skolem">name</span> <span class="skolem">args</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> assms comb <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main">)</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">arg</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">arg</span> <span class="main">∈</span> set <span class="skolem">args</span>"</span></span>

              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">arg</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> measure size"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">args</span></span><span class="main">)</span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">arg</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">arg</span> <span class="main">∈</span> set <span class="skolem">args</span>›</span></span> <span class="quoted"><span class="quoted">‹linears <span class="skolem">args</span>›</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> linears_linear<span class="main">)</span>

              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">arg</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Pats-match_subst_correctness0"><span class="command">lemma</span></span> match_subst_correctness0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> match <span class="free">t</span> <span class="free">u</span> <span class="keyword1">of</span>
          None <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound">env</span><span class="main">.</span> subst <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="bound">env</span> <span class="main">≠</span> <span class="free">u</span><span class="main">)</span> <span class="main">|</span>
          Some <span class="bound">env</span> <span class="main">⇒</span> subst <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="bound">env</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Free
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> match.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> free_term_def<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Const
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> match.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> const_term_def<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>App <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> linear<span class="main">:</span> <span class="quoted"><span class="quoted">"linear <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"unapp <span class="skolem">u</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_term_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> app_simps<span class="main">(</span>3<span class="main">)</span> is_app_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">u'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"unapp <span class="skolem">u</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> app <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> App<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> App<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹linear <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> u
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_term_def<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>convert_term <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"match <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> None
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> u
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_term_def<span class="main">)</span>
                <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>convert_term <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

              <span class="keyword1"><span class="command">note</span></span> match <span class="main">=</span> <span class="quoted"><span class="quoted">‹match <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹match <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>›</span></span>

              <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?env</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">++<span class="hidden">⇩</span><sub>f</sub></span> <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
              <span class="keyword1"><span class="command">from</span></span> match <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmdom <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> match_dom<span class="main">)</span>
              <span class="keyword1"><span class="command">with</span></span> linear <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> fmrestrict_fset <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?env</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> fmrestrict_fset <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="var">?env</span>"</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmfilter_alt_defs<span class="main">)</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmfilter_false<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
              <span class="keyword1"><span class="command">with</span></span> s1 s2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>convert_term <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?env</span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>convert_term <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="var">?env</span> <span class="main">=</span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> linear
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subst_restrict' convert_term_frees linear_implies_no_abs<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> match <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span> <span class="main">=</span> <span class="main">_</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> app_term_def<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pats-match_subst_some"><span class="command">lemma</span></span> match_subst_some<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env</span> <span class="main">⟹</span> linear <span class="free">t</span> <span class="main">⟹</span> subst <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> match_subst_correctness0 option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Pats-match_subst_none"><span class="command">lemma</span></span> match_subst_none<span class="main">:</span>
  <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> None <span class="main">⟹</span> linear <span class="free">t</span> <span class="main">⟹</span> subst <span class="main">(</span>convert_term <span class="free">t</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> <span class="free">u</span> <span class="main">⟹</span> False"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> match_subst_correctness0 option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* FIXME inverse direction? *)</span>

<span class="keyword1" id="Pats-match_matches"><span class="command">lemma</span></span> match_matches<span class="main">:</span> <span class="quoted"><span class="quoted">"match <span class="free">t</span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env</span> <span class="main">⟹</span> linear <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≲</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> match_subst_some linear_implies_no_abs convert_term_id matchesI<span class="main">)</span>

<span class="keyword1" id="Pats-overlapping_var1I"><span class="command">lemma</span></span> overlapping_var1I<span class="main">:</span> <span class="quoted"><span class="quoted">"overlapping <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> overlappingI matchesI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> fmempty <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pats-overlapping_var2I"><span class="command">lemma</span></span> overlapping_var2I<span class="main">:</span> <span class="quoted"><span class="quoted">"overlapping <span class="free">t</span> <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> overlappingI matchesI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>Free <span class="free">name</span><span class="main">)</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free">name</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subst <span class="free">t</span> fmempty <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Pats-non_overlapping_appI1"><span class="command">lemma</span></span> non_overlapping_appI1<span class="main">:</span> <span class="quoted"><span class="quoted">"non_overlapping <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> non_overlapping <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pats-non_overlapping_appI2"><span class="command">lemma</span></span> non_overlapping_appI2<span class="main">:</span> <span class="quoted"><span class="quoted">"non_overlapping <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> non_overlapping <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">u<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Pats-non_overlapping_app_constI"><span class="command">lemma</span></span> non_overlapping_app_constI<span class="main">:</span> <span class="quoted"><span class="quoted">"non_overlapping <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span>Const <span class="free">name</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pats-non_overlapping_const_appI"><span class="command">lemma</span></span> non_overlapping_const_appI<span class="main">:</span> <span class="quoted"><span class="quoted">"non_overlapping <span class="main">(</span>Const <span class="free">name</span><span class="main">)</span> <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pats-non_overlapping_const_constI"><span class="command">lemma</span></span> non_overlapping_const_constI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> non_overlapping <span class="main">(</span>Const <span class="free">x</span><span class="main">)</span> <span class="main">(</span>Const <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> overlapping_def matches_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Pats-match_overlapping"><span class="command">lemma</span></span> match_overlapping<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"linear <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">u</span> <span class="main">=</span> Some <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"overlapping <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="main">(</span>fmmap convert_term <span class="free">env<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="main">(</span>name<span class="main">,</span> term<span class="main">)</span> fmap<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="main">=</span> <span class="main">(</span>fmmap convert_term <span class="free">env<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="main">(</span>name<span class="main">,</span> term<span class="main">)</span> fmap<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>convert_term <span class="free">u</span> <span class="main">::</span> term<span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"match <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span>convert_term <span class="free">u</span> <span class="main">::</span> term<span class="main">)</span> <span class="main">=</span> Some <span class="skolem">env<span class="hidden">⇩</span><sub>2</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> env<span class="hidden">⇩</span><sub>1</sub>'_def env<span class="hidden">⇩</span><sub>2</sub>'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> convert_term_match<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> overlappingI match_matches<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Nterm">
<div class="head">
<h1>Theory Nterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Terms with explicit bound variable names›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Nterm
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Term_Class.html">Term_Class</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nterm›</span></span></span></span> type is similar to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">term</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but removes the distinction between bound and free
  variables. Instead, there are only named variables.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> nterm <span class="main">=</span>
  Nconst <span class="quoted">name</span> <span class="main">|</span>
  Nvar <span class="quoted">name</span> <span class="main">|</span>
  Nabs <span class="quoted">name</span> <span class="quoted">nterm</span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">.</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>0<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span> <span class="main">|</span>
  Napp <span class="quoted">nterm</span> <span class="quoted">nterm</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">nterm</span>

<span class="keyword1"><span class="command">instantiation</span></span> nterm <span class="main">::</span> <span class="quoted">pre_term</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_nterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unapp_nterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_nterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_nterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">const_nterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_nterm</span> <span class="main">=</span> Nconst"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unconst_nterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_nterm</span> <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_nterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_nterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_nterm</span> <span class="main">=</span> Nvar"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">unfree_nterm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_nterm</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_nterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">frees_nterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">frees_nterm</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_nterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">frees_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_nterm</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">frees_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">frees_nterm</span> <span class="main">(</span>Nconst <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">subst_nterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> nterm<span class="main">)</span> fmap <span class="main">⇒</span> nterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_nterm</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">|</span> None <span class="main">⇒</span> Nvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_nterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free">subst_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">subst_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_nterm</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free">subst_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>fmdrop <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity"><span class="class_parameter">consts_nterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consts_nterm</span> <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_nterm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">|∪|</span> <span class="free">consts_nterm</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_nterm</span> <span class="main">(</span>Nabs <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_nterm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_nterm</span> <span class="main">(</span>Nvar <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_nterm_def const_nterm_def free_nterm_def
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> unapp_nterm.elims unconst_nterm.elims unfree_nterm.elims
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> nterm <span class="main">::</span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_pred_nterm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nterm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"abs_pred <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t'</span> <span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x</span><span class="main">.</span> <span class="bound">t'</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">t'</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_nterm_def const_nterm_def free_nterm_def app_nterm_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_nterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fmdrop_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_nterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fmdrop <span class="improper">x</span> <span class="improper">env<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"fmdrop <span class="improper">x</span> <span class="improper">env<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 5
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_nterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> t' x env
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> allE<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fmdrop <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">env</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 6
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_pred_nterm_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarify</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems<span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span> <span class="keyword2"><span class="keyword">for</span></span> t x env
      <span class="keyword1"><span class="command">unfolding</span></span> consts_nterm.simps subst_nterm.simps frees_nterm.simps
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prems<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> fmimage_drop fmdom_drop
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(|∪|)</span></span> <span class="main"><span class="main">(</span></span>consts <span class="skolem"><span class="skolem">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">ffUnion</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> consts <span class="main"><span class="main">|`|</span></span> fmimage <span class="skolem"><span class="skolem">env</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_nterm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Nterm-no_abs_abs"><span class="command">lemma</span></span> no_abs_abs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> no_abs <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">x</span><span class="main">.</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> no_abs.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> term_cases_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Term_to_Nterm">
<div class="head">
<h1>Theory Term_to_Nterm</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Converting between <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>term›</span></span></span></span>s and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>nterm›</span></span></span></span>s›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Term_to_Nterm
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Fresh_Class.html">Fresh_Class</a>
  <a href="Find_First.html">Find_First</a>
  <a href="Term.html">Term</a>
  <a href="Nterm.html">Nterm</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>α›</span></span></span></span>-equivalence›</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">alpha_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> name<span class="main">)</span> fmap <span class="main">⇒</span> nterm <span class="main">⇒</span> nterm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|∉|</span> fmdom <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|∉|</span> fmran <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⟹</span> <span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
var2<span class="main">:</span> <span class="quoted"><span class="quoted">"fmlookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
abs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alpha_equiv</span> <span class="main">(</span>fmupd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">⟹</span> <span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">⟹</span> <span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟹</span> <span class="free">alpha_equiv</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">code_pred</span></span> <span class="quoted"><span class="quoted">alpha_equiv</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">alpha_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> nterm <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">alpha_eq</span> <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span> <span class="main">≡</span> alpha_equiv fmempty <span class="free"><span class="bound"><span class="entity">n1</span></span></span> <span class="free"><span class="bound"><span class="entity">n2</span></span></span>"</span></span>

<span class="keyword1" id="Term_to_Nterm-alpha_equiv_refl"><span class="command">lemma</span></span> alpha_equiv_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fmpred <span class="main">(=)</span> <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alpha_equiv <span class="free">Γ</span> <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Napp
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alpha_equiv.app<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> Napp<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Napp.prems <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alpha_equiv.intros<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> alpha_eq_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"alpha_eq <span class="free">t</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alpha_equiv_refl<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹From <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">term</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">term_to_nterm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name list <span class="main">⇒</span> term <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> nterm<span class="main">)</span> state"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> State_Monad.return <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Free <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> State_Monad.return <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Bound <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> State_Monad.return <span class="main">(</span>Nvar <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="keyword1">Λ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">n</span> <span class="main">←</span> fresh_create<span class="main">;</span>
  <span class="bound">e</span> <span class="main">←</span> <span class="free">term_to_nterm</span> <span class="main">(</span><span class="bound">n</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
  State_Monad.return <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">n</span><span class="main">.</span> <span class="bound">e</span><span class="main">)</span>
<span class="main">}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="bound">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">←</span> <span class="free">term_to_nterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">;</span>
  <span class="bound">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">←</span> <span class="free">term_to_nterm</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">;</span>
  State_Monad.return <span class="main">(</span><span class="bound">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">e<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> term_to_nterm_induct <span class="main">=</span> term_to_nterm.induct<span class="main">[</span><span class="operator">case_names</span> const free bound abs app<span class="main">]</span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm"><span class="command">lemma</span></span> term_to_nterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> free_term_def free_nterm_def const_term_def const_nterm_def app_term_def app_nterm_def split_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">term_to_nterm'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"term <span class="main">⇒</span> nterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">term_to_nterm'</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> frun_fresh <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span>frees <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm_mono"><span class="command">lemma</span></span> term_to_nterm_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_state <span class="main">(</span>term_to_nterm <span class="free">Γ</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term_to_nterm.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bind_mono_strong<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm_vars0"><span class="command">lemma</span></span> term_to_nterm_vars0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="free">Γ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> frees <span class="free">t</span> <span class="main">|∪|</span> fset_of_list <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term_to_nterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bound <span class="skolem">Γ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">|∈|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> State_Monad.return_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"next <span class="skolem">s</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> abs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">(</span><span class="var">?x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="var">?x</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> <span class="main">{|</span><span class="var">?x</span><span class="main">|}</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_alt_def split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> term_to_nterm_vars<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>fresh_frun <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free">t</span><span class="main">)</span> <span class="free">F</span><span class="main">)</span> <span class="main">|⊆|</span> frees <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Γ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="var">?Γ</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="var">?Γ</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>fNext <span class="free">F</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|⊆|</span> <span class="main">(</span>frees <span class="free">t</span> <span class="main">|∪|</span> fset_of_list <span class="var">?Γ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> term_to_nterm_vars0<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_fNext_def fresh_frun_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> term_to_nterm_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> wellformed <span class="free">t</span> <span class="main">⟹</span> closed <span class="main">(</span>term_to_nterm' <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> term_to_nterm_vars<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> F <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> t <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">unfolding</span></span> closed_except_def term_to_nterm'_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fresh_frun_def<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm_consts"><span class="command">lemma</span></span> term_to_nterm_consts<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_state <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> consts <span class="bound">t'</span> <span class="main">=</span> consts <span class="free">t</span><span class="main">)</span> <span class="main">(</span>term_to_nterm <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> pred_stateI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹From <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">term</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nterm_to_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name list <span class="main">⇒</span> nterm <span class="main">⇒</span> term"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_term</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Nconst <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> Const <span class="free"><span class="bound"><span class="entity">name</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_term</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_first <span class="free"><span class="bound"><span class="entity">name</span></span></span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> Bound <span class="bound">n</span> <span class="main">|</span> None <span class="main">⇒</span> Free <span class="free"><span class="bound"><span class="entity">name</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_term</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nterm_to_term</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">$</span> <span class="free">nterm_to_term</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">nterm_to_term</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">Λ</span> <span class="free">nterm_to_term</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">Γ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term"><span class="command">lemma</span></span> nterm_to_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="free">Γ</span> <span class="free">t</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> free_nterm_def free_term_def fdisjnt_alt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> find_first_none<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fset_of_list_elem<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>const <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> const_nterm_def const_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> convert_term <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> convert_term <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def finter_funion_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> app_nterm_def app_term_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">nterm_to_term'</span> <span class="main">≡</span> nterm_to_term <span class="main">[]</span>"</span></span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term'"><span class="command">lemma</span></span> nterm_to_term'<span class="main">:</span> <span class="quoted"><span class="quoted">"no_abs <span class="free">t</span> <span class="main">⟹</span> nterm_to_term' <span class="free">t</span> <span class="main">=</span> convert_term <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def nterm_to_term<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_frees"><span class="command">lemma</span></span> nterm_to_term_frees<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">t</span> <span class="main">-</span> fset_of_list <span class="free">Γ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">including</span></span> fset.lifting
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> find_first_some option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> None <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">u</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∈|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">including</span></span> fset.lifting
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> find_first_none option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some proofs in this section have been contributed by Yu Zhang.›</span></span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm_nterm_to_term0"><span class="command">lemma</span></span> term_to_nterm_nterm_to_term0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="free">Γ</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>frees <span class="free">t</span> <span class="main">|∪|</span> fset_of_list <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="free">Γ</span> <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> term_to_nterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">Γ</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ</span><span class="main">)</span> <span class="main">{|</span><span class="skolem">name</span><span class="main">|}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">∉</span> set <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjnt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_first_none<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> State_Monad.return_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>bound <span class="skolem">Γ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> State_Monad.return_def find_first_some_index<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"frees <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">|∪|</span></span> frees <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_subset_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> N <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"frees <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main"><span class="main">|∪|</span></span> frees <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≤</span> snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> state_io_relD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> term_to_nterm_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> app <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">using</span></span> app s <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">t</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next <span class="skolem">s</span> <span class="main">|∉|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> abs<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> next_ge_fall<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="main">(</span>next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="main">(</span>next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>next <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> abs<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="main">(</span>next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="main">(</span>next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fdisjnt_insert<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹next <span class="skolem">s</span> <span class="main">|∉|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ</span>›</span></span> abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹next <span class="skolem">s</span> <span class="main">|∉|</span> frees <span class="skolem">t</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_of_list_elem<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>frees <span class="skolem">t</span> <span class="main">|∪|</span> fset_of_list <span class="main">(</span>next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> next <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> abs<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fBall_pred_weaken<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="skolem"><span class="skolem">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dual_order.strict_implies_order dual_order.strict_trans2 fresh_class.next_ge<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> State_Monad.return_def<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm_nterm_to_term"><span class="command">lemma</span></span> term_to_nterm_nterm_to_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">|⊆|</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term' <span class="main">(</span>frun_fresh <span class="main">(</span>term_to_nterm <span class="main">[]</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> term_to_nterm_nterm_to_term0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="main">[]</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>frees <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> fresh.fNext next default <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fNext_geq_not_member fresh_fNext_def le_less_linear fBallI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> fresh.fNext next default <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fBall_pred_weaken less_eq_name_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fBall <span class="main">(</span>frees <span class="free">t</span> <span class="main">|∪|</span> fset_of_list <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> fresh.fNext next default <span class="main">(</span><span class="free">S</span> <span class="main">|∪|</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹frees <span class="free">t</span> <span class="main">|⊆|</span> <span class="free">S</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> term_to_nterm_nterm_to_term_simple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term' <span class="main">(</span>term_to_nterm' <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> term_to_nterm'_def <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl sup.idem term_to_nterm_nterm_to_term<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_eq"><span class="command">lemma</span></span> nterm_to_term_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">u</span> <span class="main">|⊆|</span> fset_of_list <span class="main">(</span>common_prefix <span class="free">Γ</span> <span class="free">Γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="free">Γ</span> <span class="free">u</span> <span class="main">=</span> nterm_to_term <span class="free">Γ'</span> <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">Γ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">∈</span> set <span class="main">(</span>common_prefix <span class="skolem">Γ</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> frees_nterm.simps
    <span class="keyword1"><span class="command">including</span></span> fset.lifting
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> common_prefix_find<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"frees <span class="skolem">t</span> <span class="main">-</span> <span class="main">{|</span><span class="skolem">x</span><span class="main">|}</span> <span class="main">|⊆|</span> fset_of_list <span class="main">(</span>common_prefix <span class="skolem">Γ</span> <span class="skolem">Γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Nabs<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> * Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> nterm_to_term_eq_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> nterm_to_term <span class="free">Γ</span> <span class="free">t</span> <span class="main">=</span> nterm_to_term <span class="free">Γ'</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nterm_to_term_eq<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closed_except_def<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_wellformed"><span class="command">lemma</span></span> nterm_to_term_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_first_correct <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> nterm_to_term_closed_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> wellformed <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ex_list_of_length nterm_to_term_eq_closed nterm_to_term_wellformed<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_term_to_nterm"><span class="command">lemma</span></span> nterm_to_term_term_to_nterm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"frees <span class="free">t</span> <span class="main">|⊆|</span> fset_of_list <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Γ</span> <span class="main">=</span> length <span class="free">Γ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alpha_equiv <span class="main">(</span>fmap_of_list <span class="main">(</span>zip <span class="free">Γ</span> <span class="free">Γ'</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ'</span> <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">Γ'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>nterm_to_term.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">Γ</span> <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alpha_equiv.abs<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"next <span class="skolem">s</span> <span class="main">#</span> <span class="skolem">Γ'</span>"</span></span><span class="main">]</span> <span class="quoted">"4.prems"</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> create_alt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alpha_equiv.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> find_first_some <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> alpha_equiv.intros
         <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fset_of_list_elem find_first_in_map split_beta fdisjnt_alt_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">corollary</span></span> nterm_to_term_term_to_nterm'<span class="main">:</span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="keyword1">≈<span class="hidden">⇩</span><sub>α</sub></span> term_to_nterm' <span class="main">(</span>nterm_to_term' <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> term_to_nterm'_def closed_except_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nterm_to_term_term_to_nterm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Γ' <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">[]</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1" id="Term_to_Nterm-term_to_nterm_alpha_equiv0"><span class="command">lemma</span></span> term_to_nterm_alpha_equiv0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">Γ1</span> <span class="main">=</span> length <span class="free">Γ2</span> <span class="main">⟹</span> distinct <span class="free">Γ1</span> <span class="main">⟹</span> distinct <span class="free">Γ2</span> <span class="main">⟹</span> wellformed' <span class="main">(</span>length <span class="free">Γ1</span><span class="main">)</span> <span class="free">t1</span> <span class="main">⟹</span>
   fresh_fin <span class="main">(</span>frees <span class="free">t1</span> <span class="main">|∪|</span> fset_of_list <span class="free">Γ1</span><span class="main">)</span> <span class="free">s1</span> <span class="main">⟹</span> fdisjnt <span class="main">(</span>fset_of_list <span class="free">Γ1</span><span class="main">)</span> <span class="main">(</span>frees <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
   fresh_fin <span class="main">(</span>frees <span class="free">t1</span> <span class="main">|∪|</span> fset_of_list <span class="free">Γ2</span><span class="main">)</span> <span class="free">s2</span> <span class="main">⟹</span> fdisjnt <span class="main">(</span>fset_of_list <span class="free">Γ2</span><span class="main">)</span> <span class="main">(</span>frees <span class="free">t1</span><span class="main">)</span> <span class="main">⟹</span>
   alpha_equiv <span class="main">(</span>fmap_of_list <span class="main">(</span>zip <span class="free">Γ1</span> <span class="free">Γ2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst<span class="main">(</span> run_state <span class="main">(</span>term_to_nterm <span class="free">Γ1</span> <span class="free">t1</span><span class="main">)</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span> run_state <span class="main">(</span>term_to_nterm <span class="free">Γ2</span> <span class="free">t1</span><span class="main">)</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Γ1</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ2</span></span> <span class="quoted"><span class="free">s1</span></span> <span class="quoted"><span class="free">s2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>term_to_nterm_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>free <span class="skolem">Γ1</span> <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmdom <span class="main">(</span>fmap_of_list <span class="main">(</span>zip <span class="skolem">Γ1</span> <span class="skolem">Γ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fmran <span class="main">(</span>fmap_of_list <span class="main">(</span>zip <span class="skolem">Γ1</span> <span class="skolem">Γ2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fmran_of_list<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fset_of_list_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> distinct_clearjunk_id<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> map_fst_zip<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> map_snd_zip<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">using</span></span> free <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>alpha_equiv.intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>abs <span class="skolem">Γ</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"next <span class="skolem">s1</span> <span class="main">&gt;</span> <span class="skolem">s1</span>"</span></span> <span class="quoted"><span class="quoted">"next <span class="skolem">s2</span> <span class="main">&gt;</span> <span class="skolem">s2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> next_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> abs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"next <span class="skolem">s1</span> <span class="main">∉</span> set <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"next <span class="skolem">s2</span> <span class="main">∉</span> set <span class="skolem">Γ2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fBall_funion fset_of_list_elem next_ge_fall<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>frees <span class="skolem">t</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>next <span class="skolem">s1</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>frees <span class="skolem">t</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ2</span><span class="main">)</span> <span class="main">(</span>next <span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * abs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> dual_order.trans fBall_pred_weaken frees_term.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_imp_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>finsert <span class="main">(</span>next <span class="skolem">s1</span><span class="main">)</span> <span class="main">(</span>fset_of_list <span class="skolem">Γ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>finsert <span class="main">(</span>next <span class="skolem">s2</span><span class="main">)</span> <span class="main">(</span>fset_of_list <span class="skolem">Γ2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">using</span></span> abs frees_term.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fdisjnt_alt_def finter_finsert_right funionCI inf_commute next_ge_fall<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">Γ2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed'.simps abs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> abs.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"next <span class="skolem"><span class="skolem">s2</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">Γ2</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>app <span class="skolem">Γ1</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="skolem">Γ1</span><span class="main">)</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="skolem">Γ1</span><span class="main">)</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ1</span><span class="main">)</span> <span class="skolem">s1</span>"</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ2</span><span class="main">)</span> <span class="skolem">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ1</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ2</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ1</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="skolem">Γ2</span><span class="main">)</span> <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> app
    <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inf_sup_distrib1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">≤</span> snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ1</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">s1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">≤</span> snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ2</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">s2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> term_to_nterm_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_io_rel_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ1</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ1</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">s1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fresh_fin <span class="main">(</span>frees <span class="main">(</span><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">$</span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ1</span><span class="main">)</span> <span class="skolem">s1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>frees <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">|∪|</span> fset_of_list <span class="skolem">Γ2</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="skolem">Γ2</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">using</span></span> app frees_term.simps <span class="quoted"><span class="quoted">‹<span class="skolem">s2</span> <span class="main">≤</span> <span class="main">_</span>›</span></span> dual_order.trans
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fbspec funion_iff<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta create_alt_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> alpha_equiv.app<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> app<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">fact</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> alpha_equiv.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmlookup_of_list in_set_zip<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Term_to_Nterm-term_to_nterm_alpha_equiv"><span class="command">lemma</span></span> term_to_nterm_alpha_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Γ1</span> <span class="main">=</span> length <span class="free">Γ2</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Γ1</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">Γ2</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellformed' <span class="main">(</span>length <span class="free">Γ1</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>fset_of_list <span class="free">Γ1</span><span class="main">)</span> <span class="free">s1</span>"</span></span> <span class="quoted"><span class="quoted">"fresh_fin <span class="main">(</span>fset_of_list <span class="free">Γ2</span><span class="main">)</span> <span class="free">s2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"alpha_equiv <span class="main">(</span>fmap_of_list <span class="main">(</span>zip <span class="free">Γ1</span> <span class="free">Γ2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ1</span> <span class="free">t</span><span class="main">)</span> <span class="free">s1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>run_state <span class="main">(</span>term_to_nterm <span class="free">Γ2</span> <span class="free">t</span><span class="main">)</span> <span class="free">s2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹An instantiated version of this lemma with <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">‹<span class="free">Γ1</span> <span class="main">=</span> <span class="main">[]</span>›</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">prop</span> <span class="quoted">‹<span class="free">Γ2</span> <span class="main">=</span> <span class="main">[]</span>›</span><span class="antiquote">}</span></span>
      would not make sense because then it would just be a special case of
      <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> [source=true] alpha_eq_refl<span class="antiquote">}</span></span>.›</span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdisjnt_alt_def closed_except_def term_to_nterm_alpha_equiv0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> nrelated<span class="main">:</span> term_struct_rel_strong <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> nterm_to_term <span class="free">Γ</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Γ</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">name</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def const_nterm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">u<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">u<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_term_def app_nterm_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> const_term_def const_nterm_def app_term_def app_nterm_def<span class="main">)</span>

<span class="keyword1" id="Term_to_Nterm-env_nrelated_closed"><span class="command">lemma</span></span> env_nrelated_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nrelated.P_env <span class="free">Γ</span> <span class="free">env</span> <span class="free">nenv</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">nenv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nrelated.P_env <span class="free">Γ'</span> <span class="free">env</span> <span class="free">nenv</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> nterm_to_term <span class="free">Γ</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">env</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">nenv</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"rel_option <span class="main">(</span><span class="main">λ</span><span class="bound">t</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> nterm_to_term <span class="free">Γ'</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">env</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>fmlookup <span class="free">nenv</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> option.rel_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmdomI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nterm_to_term_eq_closed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Term_to_Nterm-nrelated_subst"><span class="command">lemma</span></span> nrelated_subst<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nrelated.P_env <span class="free">Γ</span> <span class="free">env</span> <span class="free">nenv</span>"</span></span> <span class="quoted"><span class="quoted">"closed_env <span class="free">nenv</span>"</span></span> <span class="quoted"><span class="quoted">"fdisjnt <span class="main">(</span>fset_of_list <span class="free">Γ</span><span class="main">)</span> <span class="main">(</span>fmdom <span class="free">nenv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subst <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> nterm_to_term <span class="free">Γ</span> <span class="main">(</span>subst <span class="free">t</span> <span class="free">nenv</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">env</span></span> <span class="quoted"><span class="free">nenv</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> fmrel_cases<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">name</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>some <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> Nvar <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">|∉|</span> fset_of_list <span class="skolem">Γ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fmdomI<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">including</span></span> fset.lifting <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_none<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> some <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> subst_drop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Nabs<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">unfolding</span></span> fdisjnt_alt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> env_nrelated_closed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_insert_dupl"><span class="command">lemma</span></span> nterm_to_term_insert_dupl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">Γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="free">Γ</span> <span class="free">t</span> <span class="main">=</span> incr_bounds <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="main">(</span>insert_nth <span class="free">n</span> <span class="free">y</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">name</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> Nvar <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> find_first_some_strong<span class="main">)</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_first_prefix<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹find_first <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="main">=</span> Some <span class="skolem">i</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> find_first_append<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted"><span class="quoted">‹find_first <span class="skolem">name</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> insert_nth_take_drop<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> find_first_insert_nth_neq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Nabs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_bounds_dupl"><span class="command">lemma</span></span> nterm_to_term_bounds_dupl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Γ</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">Γ</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">|∉|</span> bounds <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Γ</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">k</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">|∈|</span> bounds <span class="main">(</span>nterm_to_term <span class="skolem">Γ</span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Some <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span> <span class="main">≠</span> Some <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> find_first_later<span class="main">)</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">name</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> find_first_correct<span class="main">)</span> <span class="operator">fact</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Γ</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">name</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Nvar <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">|∈|</span> bounds <span class="main">(</span>nterm_to_term <span class="skolem">Γ</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">x</span><span class="main">.</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">|∈|</span> bounds <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">|∈|</span> bounds <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">|∉|</span> bounds <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Nabs<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst_single</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nterm <span class="main">⇒</span> name <span class="main">⇒</span> nterm <span class="main">⇒</span> nterm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_single</span> <span class="main">(</span>Nvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">else</span> Nvar <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_single</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="free">subst_single</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">$<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">subst_single</span> <span class="free"><span class="bound"><span class="entity">t<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_single</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Λ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="free">subst_single</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_single</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Term_to_Nterm-subst_single_eq"><span class="command">lemma</span></span> subst_single_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"subst_single <span class="free">t</span> <span class="free">s</span> <span class="free">t'</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">t'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">x</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">s</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fmfilter_alt_defs<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Term_to_Nterm-nterm_to_term_subst_replace_bound"><span class="command">lemma</span></span> nterm_to_term_subst_replace_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">Γ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">Γ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="free">Γ</span> <span class="main">(</span>subst_single <span class="free">u</span> <span class="free">x</span> <span class="free">u'</span><span class="main">)</span> <span class="main">=</span> replace_bound <span class="free">n</span> <span class="main">(</span>nterm_to_term <span class="main">(</span>insert_nth <span class="free">n</span> <span class="free">x</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="free">Γ</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">u</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">Γ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nvar <span class="skolem">name</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> insert_nth_take_drop<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">name</span> <span class="main">=</span> <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Nvar
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_first_insert_nth_eq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> incr_bounds_eq<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> k <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nterm_to_term_closed_wellformed<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> find_first_insert_nth_neq<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"find_first <span class="skolem">name</span> <span class="skolem">Γ</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nabs <span class="skolem">y</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> insert_nth_take_drop<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> replace_bound <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> insert_nth <span class="skolem">n</span> <span class="skolem">y</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="skolem">Γ</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> replace_bound_eq<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">|∉|</span> bounds <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> insert_nth <span class="skolem">n</span> <span class="skolem">y</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nterm_to_term_bounds_dupl<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Nabs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_nth_take_drop<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nth_insert_nth_index_eq<span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> incr_bounds <span class="main">(</span><span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> insert_nth <span class="skolem">n</span> <span class="skolem">y</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nterm_to_term_insert_dupl<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Γ <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">y</span></span> <span class="main"><span class="main">#</span></span> <span class="skolem"><span class="skolem">Γ</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> y <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="main">(</span>subst_single <span class="skolem">t</span> <span class="free">x</span> <span class="free">u'</span><span class="main">)</span> <span class="main">=</span> replace_bound <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> insert_nth <span class="skolem">n</span> <span class="free">x</span> <span class="skolem">Γ</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>nterm_to_term <span class="skolem">Γ</span> <span class="free">u'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> Nabs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">n</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> False Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nterm_to_term_eq_closed<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> Nabs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> nterm_to_term_subst_β<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">u'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nterm_to_term <span class="free">Γ</span> <span class="main">(</span>subst <span class="free">u</span> <span class="main">(</span>fmap_of_list <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">u'</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> nterm_to_term <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">Γ</span><span class="main">)</span> <span class="free">u</span> <span class="main">[</span>nterm_to_term <span class="free">Γ</span> <span class="free">u'</span><span class="keyword1">]<span class="hidden">⇩</span><sub>β</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nterm_to_term_subst_replace_bound<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> n <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> subst_single_eq<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Unification_Compat">
<div class="head">
<h1>Theory Unification_Compat</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Instantiation for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOL-ex.Unification›</span></span></span></span> from session <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOL-ex›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Unification_Compat
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-ex/Unification.html">HOL-ex.Unification</a>"</span>
  <a href="Term_Class.html">Term_Class</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The Isabelle library provides a unification algorithm on lambda-free terms. To illustrate
  flexibility of the term algebra, I instantiate my class with that term type. The major issue is
  that those terms are parameterized over the constant and variable type, which cannot easily be
  supported by the classy approach, where those types are fixed to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">name</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As a workaround, I
  introduce a class that requires the constant and variable type to be isomorphic to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">name</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Unification.subst

<span class="keyword1"><span class="command">class</span></span> is_name <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">of_name</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">of_name</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">to_name</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> name"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">to_name</span> <span class="main">=</span> inv of_name"</span></span>

<span class="keyword1" id="Unification_Compat-to_of_name"><span class="command">lemma</span></span> to_of_name<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_name <span class="main">(</span>of_name <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> to_name_def <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_inv_eq_iff<span class="main">)</span>

<span class="keyword1" id="Unification_Compat-of_to_name"><span class="command">lemma</span></span> of_to_name<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"of_name <span class="main">(</span>to_name <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> to_name_def <span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> bij_inv_eq_iff<span class="main">)</span>

<span class="keyword1" id="Unification_Compat-of_name_inj"><span class="command">lemma</span></span> of_name_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"of_name <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> of_name <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">name<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">name<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> bij <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> to_of_name<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> name <span class="main">::</span> <span class="quoted">is_name</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">of_name_name</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"name <span class="main">⇒</span> name"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">of_name_name</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> of_name_name_def bij_betw_def inj_on_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>to_name <span class="main">::</span> name <span class="main">⇒</span> name<span class="main">)</span> <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> to_name_def of_name_name_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instantiation</span></span> trm <span class="main">::</span> <span class="main">(</span><span class="quoted">is_name</span><span class="main">)</span> <span class="quoted"><span class="quoted">"pre_term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_trm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_trm</span> <span class="main">=</span> Comb"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unapp_trm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Comb <span class="bound">t</span> <span class="bound">u</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">const_trm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_trm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> trm.Const <span class="main">(</span>of_name <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unconst_trm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> trm.Const <span class="bound">a</span> <span class="main">⇒</span> Some <span class="main">(</span>to_name <span class="bound">a</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_trm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_trm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Var <span class="main">(</span>of_name <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unfree_trm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_trm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Var <span class="bound">a</span> <span class="main">⇒</span> Some <span class="main">(</span>to_name <span class="bound">a</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">consts_trm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">consts_trm</span> <span class="main">(</span>Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_trm</span> <span class="main">(</span>trm.Const <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> to_name <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">|}</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">consts_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">consts_trm</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">|∪|</span> <span class="free">consts_trm</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">frees_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> to_name <span class="main">`</span> vars_of <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Unification_Compat-frees_trm"><span class="command">lemma</span></span> frees_trm<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"frees <span class="main">(</span>Var <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">{|</span> to_name <span class="free">v</span> <span class="main">|}</span>"</span></span>
  <span class="quoted"><span class="quoted">"frees <span class="main">(</span>trm.Const <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">{||}</span>"</span></span>
  <span class="quoted"><span class="quoted">"frees <span class="main">(</span><span class="free">M</span> <span class="main">⋅</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">M</span> <span class="main">|∪|</span> frees <span class="free">N</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity"><span class="class_parameter">subst_trm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> <span class="tfree">'a</span> trm<span class="main">)</span> fmap <span class="main">⇒</span> <span class="tfree">'a</span> trm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_trm</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>to_name <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="bound">v'</span> <span class="main">⇒</span> <span class="bound">v'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> Var <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_trm</span> <span class="main">(</span>trm.Const <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> trm.Const <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">subst_trm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span> <span class="free">subst_trm</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">⋅</span> <span class="free">subst_trm</span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_trm_def unapp_trm_def const_trm_def unconst_trm_def free_trm_def unfree_trm_def of_name_inj
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> trm.splits option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> trm <span class="main">::</span> <span class="main">(</span><span class="quoted">is_name</span><span class="main">)</span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_pred_trm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> trm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">abs_pred_trm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Var
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> free_trm_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_to_name<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Const
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> const_trm_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_to_name<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_trm_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_trm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Unification_Compat-assoc_alt_def"><span class="command">lemma</span></span> assoc_alt_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"assoc <span class="free">x</span> <span class="free">y</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">t</span> <span class="free">x</span> <span class="keyword1">of</span> Some <span class="bound">y'</span> <span class="main">⇒</span> <span class="bound">y'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Unification_Compat-subst_eq"><span class="command">lemma</span></span> subst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Unification.subst <span class="free">t</span> <span class="free">s</span> <span class="main">=</span> subst <span class="free">t</span> <span class="main">(</span>fmap_of_list <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmlookup_of_list<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lambda_Free_Compat">
<div class="head">
<h1>Theory Lambda_Free_Compat</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Instantiation for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>λ›</span></span></span></span>-free terms according to Blanchette›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lambda_Free_Compat
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Unification_Compat.html">Unification_Compat</a> <span class="quoted">"<a href="../Lambda_Free_RPOs/Lambda_Free_Term.html">Lambda_Free_RPOs.Lambda_Free_Term</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Another instantiation of the algebra for Blanchette et al.'s term type
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">cite</span></span> blanchette2016lambda<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Lambda_Free_Term.subst

<span class="keyword1"><span class="command">instantiation</span></span> tm <span class="main">::</span> <span class="main">(</span><span class="quoted">is_name</span><span class="main">,</span> <span class="quoted">is_name</span><span class="main">)</span> <span class="quoted"><span class="quoted">"pre_term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">app_tm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">app_tm</span> <span class="main">=</span> tm.App"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unapp_tm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unapp_tm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> App <span class="bound">t</span> <span class="bound">u</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">u</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">const_tm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">const_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Hd <span class="main">(</span>Sym <span class="main">(</span>of_name <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unconst_tm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unconst_tm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Hd <span class="main">(</span>Sym <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>to_name <span class="bound">a</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">free_tm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">free_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Hd <span class="main">(</span>Var <span class="main">(</span>of_name <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">unfree_tm</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">unfree_tm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Hd <span class="main">(</span>Var <span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>to_name <span class="bound">a</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> fset.lifting
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">frees_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> to_name <span class="main">`</span> vars <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">consts_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm <span class="main">⇒</span> name fset"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> to_name <span class="main">`</span> syms <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Lambda_Free_Compat-frees_tm"><span class="command">lemma</span></span> frees_tm<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"frees <span class="main">(</span>App <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> frees <span class="free">f</span> <span class="main">|∪|</span> frees <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"frees <span class="main">(</span>Hd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="keyword1">of</span> Sym <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> fempty <span class="main">|</span> Var <span class="bound">v</span> <span class="main">⇒</span> <span class="main">{|</span> to_name <span class="bound">v</span> <span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Lambda_Free_Compat-consts_tm"><span class="command">lemma</span></span> consts_tm<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"consts <span class="main">(</span>App <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> consts <span class="free">f</span> <span class="main">|∪|</span> consts <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"consts <span class="main">(</span>Hd <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="keyword1">of</span> Var <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> fempty <span class="main">|</span> Sym <span class="bound">v</span> <span class="main">⇒</span> <span class="main">{|</span> to_name <span class="bound">v</span> <span class="main">|}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">including</span></span> fset.lifting
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">subst_tm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm <span class="main">⇒</span> <span class="main">(</span>name<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm<span class="main">)</span> fmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">subst_tm</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">=</span>
  Lambda_Free_Term.subst <span class="main">(</span>fmlookup_default <span class="free"><span class="bound"><span class="entity">env</span></span></span> <span class="main">(</span>Hd <span class="main">∘</span> Var <span class="main">∘</span> of_name<span class="main">)</span> <span class="main">∘</span> to_name<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Lambda_Free_Compat-subst_tm"><span class="command">lemma</span></span> subst_tm<span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"subst <span class="main">(</span>App <span class="free">t</span> <span class="free">u</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> App <span class="main">(</span>subst <span class="free">t</span> <span class="free">env</span><span class="main">)</span> <span class="main">(</span>subst <span class="free">u</span> <span class="free">env</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"subst <span class="main">(</span>Hd <span class="free">h</span><span class="main">)</span> <span class="free">env</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">h</span> <span class="keyword1">of</span>
    Sym <span class="bound">s</span> <span class="main">⇒</span> Hd <span class="main">(</span>Sym <span class="bound">s</span><span class="main">)</span> <span class="main">|</span>
    Var <span class="bound">x</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> fmlookup <span class="free">env</span> <span class="main">(</span>to_name <span class="bound">x</span><span class="main">)</span> <span class="keyword1">of</span>
      Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">t'</span>
    <span class="main">|</span> None <span class="main">⇒</span> Hd <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> subst_tm_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fmlookup_default_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> hd.splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>
   <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_tm_def unapp_tm_def const_tm_def unconst_tm_def free_tm_def unfree_tm_def of_name_inj
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.splits hd.splits option.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> tm <span class="main">::</span> <span class="main">(</span><span class="quoted">is_name</span><span class="main">,</span> <span class="quoted">is_name</span><span class="main">)</span> <span class="quoted"><span class="quoted">"term"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">abs_pred_tm</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> tm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">abs_pred_tm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> True"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Hd <span class="skolem">h</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">h</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> free_tm_def const_tm_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> of_to_name<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_tm_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> abs_pred_tm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Lambda_Free_Compat-apps_list_comb"><span class="command">lemma</span></span> apps_list_comb<span class="main">:</span> <span class="quoted"><span class="quoted">"apps <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> list_comb <span class="free">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> app_tm_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>