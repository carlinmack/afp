<div id="Median_Of_Medians_Selection">
<div class="head">
<h1>Theory Median_Of_Medians_Selection</h1>
</div>
<pre class="source"><span class="comment1">(*
  File:     Median_Of_Medians_Selection.thy
  Author:   Manuel Eberl, TU München

  The median-of-medians selection algorithm, which runs deterministically in linear time.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Median-of-Medians Selection Algorithm›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Median_Of_Medians_Selection
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some facts about lists and multisets›</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-mset_concat"><span class="command">lemma</span></span> mset_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map mset <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Median_Of_Medians_Selection-set_mset_sum_list"><span class="command">lemma</span></span> set_mset_sum_list <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>sum_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> set_mset <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-filter_mset_image_mset"><span class="command">lemma</span></span> filter_mset_image_mset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">(</span>image_mset <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> image_mset <span class="free">f</span> <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-filter_mset_sum_list"><span class="command">lemma</span></span> filter_mset_sum_list<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="main">(</span>sum_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span>filter_mset <span class="free">P</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Median_Of_Medians_Selection-sum_mset_mset_mono"><span class="command">lemma</span></span> sum_mset_mset_mono<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊆#</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subset_mset.add_mono<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-mset_filter_mono"><span class="command">lemma</span></span> mset_filter_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆#</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="free">A</span> <span class="main">⊆#</span> filter_mset <span class="free">Q</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mset_subset_eqI<span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mset_subset_eq_count count_eq_zero_iff<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-size_mset_sum_mset_distrib"><span class="command">lemma</span></span> size_mset_sum_mset_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>sum_mset <span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> multiset<span class="main">)</span> <span class="main">=</span> sum_mset <span class="main">(</span>image_mset size <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-sum_mset_mono"><span class="command">lemma</span></span> sum_mset_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>ordered_ab_semigroup_add<span class="main">,</span>comm_monoid_add<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="free">A</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-filter_mset_is_empty_iff"><span class="command">lemma</span></span> filter_mset_is_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_mset <span class="free">P</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">A</span> <span class="main">⟶</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> multiset_eq_iff count_eq_zero_iff<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-sorted_filter_less_subset_take"><span class="command">lemma</span></span> sorted_filter_less_subset_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#}</span> <span class="main">⊆#</span> mset <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_mset_is_empty_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">#}</span> <span class="main">⊆#</span> add_mset <span class="skolem">x</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="skolem">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> add_mset <span class="skolem">x</span> <span class="main">(</span>mset <span class="main">(</span>take <span class="skolem">i'</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mset_subset_eq_add_mset_cancel <span class="keyword1"><span class="command">using</span></span> Cons.prems Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.IH<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mset <span class="main">(</span>take <span class="skolem">i</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-sorted_filter_greater_subset_drop"><span class="command">lemma</span></span> sorted_filter_greater_subset_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">x</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#}</span> <span class="main">⊆#</span> mset <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append filter_mset_is_empty_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">#}</span> <span class="main">⊆#</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="skolem">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">#}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> mset <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Cons.IH<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> mset <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The dual order type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following type is a copy of a given ordered base type, but with the ordering reversed.
  This will be useful later because we can do some of our reasoning simply by symmetry.
›</span></span>
<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> dual_ord <span class="main">=</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">::</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">morphisms</span></span> of_dual_ord to_dual_ord
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_dual_ord

<span class="keyword1"><span class="command">instantiation</span></span> dual_ord <span class="main">::</span> <span class="main">(</span><span class="quoted">ord</span><span class="main">)</span> <span class="quoted">ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_dual_ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dual_ord <span class="main">⇒</span> <span class="tfree">'a</span> dual_ord <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≥</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_dual_ord</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dual_ord <span class="main">⇒</span> <span class="tfree">'a</span> dual_ord <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&gt;</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> dual_ord <span class="main">::</span> <span class="main">(</span><span class="quoted">preorder</span><span class="main">)</span> <span class="quoted">preorder</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_le_not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">instance</span></span> dual_ord <span class="main">::</span> <span class="main">(</span><span class="quoted">linorder</span><span class="main">)</span> <span class="quoted">linorder</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Chopping a list into equal-sized sublists›</span></span>

<span class="comment1">(* TODO: Move to library? *)</span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">chop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">chop</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">chop</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">chop</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">#</span> <span class="free">chop</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">lexicographic_order</span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-chop_transfer"><span class="command">lemma</span></span> chop_transfer <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> list_all2 <span class="free">R</span> <span class="main">===&gt;</span> list_all2 <span class="main">(</span>list_all2 <span class="free">R</span><span class="main">)</span><span class="main">)</span> chop chop"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> rel_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>list_all2 <span class="free">R</span><span class="main">)</span> <span class="main">(</span>chop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>chop <span class="skolem">n</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>list_all2 <span class="free">R</span><span class="main">)</span> <span class="main">(</span>chop <span class="skolem">m</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>chop <span class="skolem">n</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-chop_reduce"><span class="command">lemma</span></span> chop_reduce<span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">#</span> chop <span class="free">n</span> <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-concat_chop"><span class="command">lemma</span></span> concat_chop <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> concat <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-chop_elem_not_Nil"><span class="command">lemma</span></span> chop_elem_not_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq_commute<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-chop_eq_Nil_iff"><span class="command">lemma</span></span> chop_eq_Nil_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"chop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span> <span class="operator">auto</span>  

<span class="keyword1" id="Median_Of_Medians_Selection-chop_ge_length_eq"><span class="command">lemma</span></span> chop_ge_length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> length <span class="free">xs</span> <span class="main">⟹</span> chop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="free">xs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Median_Of_Medians_Selection-length_chop_part_le"><span class="command">lemma</span></span> length_chop_part_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">ys</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-length_nth_chop"><span class="command">lemma</span></span> length_nth_chop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> 
             <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> length <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span><span class="free">n</span> <span class="keyword1">dvd</span> length <span class="free">xs</span> <span class="keyword1">then</span> length <span class="free">xs</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">xs</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> dvd_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chop <span class="skolem">n</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> chop <span class="skolem">n</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> length <span class="main">(</span>chop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">n</span> <span class="keyword1">dvd</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span>
                                <span class="keyword1">then</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">n</span> <span class="keyword1">else</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted">"3.IH"</span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> Suc <span class="quoted">"3.prems"</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">dvd</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">n</span> <span class="keyword1">dvd</span> length <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> dvd_minus_self<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">n</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span> <span class="keyword1">mod</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> le_mod_geq <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-length_chop"><span class="command">lemma</span></span> length_chop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> nat <span class="main">⌈</span>length <span class="free">xs</span> <span class="main">/</span> <span class="free">n</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chop.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span>real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">n</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ceiling_unique<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> <span class="quoted">"3.hyps"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> chop_ge_length_eq not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> real <span class="skolem">n</span> <span class="main">+</span> real <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> real <span class="skolem">n</span> <span class="main">=</span> real <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ceiling <span class="main">…</span> <span class="main">=</span> ceiling <span class="main">(</span>real <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">n</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">…</span> <span class="main">=</span> nat <span class="main">(</span>ceiling <span class="main">(</span>real <span class="main">(</span>length <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> real <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> nat <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nat_add_distrib<span class="main"><span class="main">[</span></span><span class="operator">OF</span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ ceiling_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>chop <span class="skolem">n</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="quoted">"3.hyps"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="quoted">"3.IH"</span> <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-sum_msets_chop"><span class="command">lemma</span></span> sum_msets_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">←</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">.</span> mset <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> mset <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mset_concat <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Median_Of_Medians_Selection-UN_sets_chop"><span class="command">lemma</span></span> UN_sets_chop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>chop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> set <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> set_concat <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> concat_chop<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-in_set_chopD"><span class="command">lemma</span></span> in_set_chopD <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> UN_sets_chop <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹$k$-th order statistics and medians›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This returns the $k$-th smallest element of a list. This is also known as the $k$-th order
  statistic.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">select</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">select</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> sort <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The median of a list, where, for lists of even lengths, the smaller one is favoured:
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">median</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">median</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> select <span class="main">(</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-select_in_set"><span class="command">lemma</span></span> select_in_set <span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort <span class="free">xs</span> <span class="main">!</span> <span class="free">k</span> <span class="main">∈</span> set <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_mem<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_in_set"><span class="command">lemma</span></span> median_in_set <span class="main">[</span><span class="operator">intro</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"median <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> median_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We show that selection and medians does not depend on the order of the elements:
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-sort_cong"><span class="command">lemma</span></span> sort_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span> <span class="main">⟹</span> sort <span class="free">xs</span> <span class="main">=</span> sort <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> properties_for_sort<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Median_Of_Medians_Selection-select_cong"><span class="command">lemma</span></span> select_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="main">⟹</span> mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">xs'</span> <span class="main">⟹</span> select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> select <span class="free">k'</span> <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> select_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sort_cong<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_cong"><span class="command">lemma</span></span> median_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">xs'</span> <span class="main">⟹</span> median <span class="free">xs</span> <span class="main">=</span> median <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> median_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> select_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mset_eq_length<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Selection distributes over appending lists under certain conditions:
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-sort_append"><span class="command">lemma</span></span> sort_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sort <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> sort <span class="free">xs</span> <span class="main">@</span> sort <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> properties_for_sort<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-select_append"><span class="command">lemma</span></span> select_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">⟹</span> select <span class="free">k</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> select <span class="free">k</span> <span class="free">ys</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="main">{</span>length <span class="free">ys</span><span class="main">..&lt;</span>length <span class="free">ys</span> <span class="main">+</span> length <span class="free">zs</span><span class="main">}</span> <span class="main">⟹</span>
             select <span class="free">k</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> length <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> select_def sort_append nth_append<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-select_append'"><span class="command">lemma</span></span> select_append'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">ys</span> <span class="keyword1">then</span> select <span class="free">k</span> <span class="free">ys</span> <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> length <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> select_append<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can find simple upper bounds for the number of elements that are strictly less than (resp.
  greater than) the median of a list.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-size_less_than_median"><span class="command">lemma</span></span> size_less_than_median<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> median <span class="free">xs</span><span class="main">#}</span> <span class="main">≤</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> median <span class="free">xs</span><span class="main">#}</span> <span class="main">≤</span> 
           size <span class="main">(</span>mset <span class="main">(</span>take <span class="main">(</span><span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> median_def select_def <span class="keyword1"><span class="command">using</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> size_mset_mono sorted_filter_less_subset_take<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Median_Of_Medians_Selection-size_greater_than_median"><span class="command">lemma</span></span> size_greater_than_median<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> median <span class="free">xs</span><span class="main">#}</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> median <span class="free">xs</span><span class="main">#}</span> <span class="main">≤</span> 
           size <span class="main">(</span>mset <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span><span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sort <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> median_def select_def <span class="keyword1"><span class="command">using</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> size_mset_mono sorted_filter_greater_subset_drop<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> median <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
           length <span class="free">xs</span> <span class="main">-</span> Suc <span class="main">(</span><span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A more liberal notion of medians›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define a more relaxed version of being ``a median'' as opposed to being ``\emph{the}
  median''. A value is a median if at most half the values in the list are strictly smaller 
  than it and at most half are strictly greater. Note that, by this definition, the median does
  not even have to be in the list itself.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_median</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_median</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">⟷</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∧</span>
                      length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">≤</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We set up some transfer rules for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> is_median<span class="antiquote"><span class="antiquote">}</span></span></span></span>. In particular, we have a rule that
  shows that something is a median for a list iff it is a median on that list w.\,r.\,t.\ 
  the dual order, which will later allow us to argue by symmetry.
›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-transfer_is_median"><span class="command">lemma</span></span> transfer_is_median <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">===&gt;</span> <span class="free">r</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">(&lt;)</span> <span class="main">(&lt;)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">===&gt;</span> list_all2 <span class="free">r</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> is_median is_median"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_median_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer_prover</span>

<span class="keyword1" id="Median_Of_Medians_Selection-list_all2_eq_fun_conv_map"><span class="command">lemma</span></span> list_all2_eq_fun_conv_map<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> map <span class="free">f</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">ys</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-transfer_is_median_dual_ord"><span class="command">lemma</span></span> transfer_is_median_dual_ord <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>pcr_dual_ord <span class="main">(=)</span> <span class="main">===&gt;</span> list_all2 <span class="main">(</span>pcr_dual_ord <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span><span class="main">)</span> is_median is_median"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pcr_dual_ord_def cr_dual_ord_def OO_def rel_fun_def is_median_def 
        list_all2_eq_fun_conv_map o_def less_dual_ord.rep_eq<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-is_median_to_dual_ord_iff"><span class="command">lemma</span></span> is_median_to_dual_ord_iff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>to_dual_ord <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map to_dual_ord <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> is_median <span class="free">x</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_median_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following is an obviously equivalent definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> is_median<span class="antiquote"><span class="antiquote">}</span></span></span></span> in terms of
  multisets that is occasionally nicer to use.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-is_median_altdef"><span class="command">lemma</span></span> is_median_altdef<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="free">xs</span> <span class="main">⟷</span> size <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">∧</span>
                      size <span class="main">(</span>filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="skolem">P</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> size <span class="main">(</span>filter_mset <span class="skolem">P</span> <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> mset_filter<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> is_median_def *<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-is_median_cong"><span class="command">lemma</span></span> is_median_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="free">xs</span> <span class="main">⟷</span> is_median <span class="free">y</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_median_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms mset_eq_length<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If an element is the median of a list of odd length, we can add any element to the list
  and the element is still a median. Conversely, if we want to compute a median of a list with
  even length $n$, we can simply drop one element and reduce the problem to a median of a list
  of size $n - 1$.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-is_median_Cons_odd"><span class="command">lemma</span></span> is_median_Cons_odd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"odd <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_median_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  And, of course, \emph{the} median is a median.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-is_median_median"><span class="command">lemma</span></span> is_median_median <span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>median <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> size_less_than_median<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> size_greater_than_median<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_median_def size_mset <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> mset_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of a median-of-medians›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We can now bound the number of list elements that can be strictly smaller than a 
  median-of-medians of a chopped-up list (where each part has length $d$ except for the last one,
  which can also be shorter).

  The core argument is that at least roughly half of the medians of the sublists are greater or 
  equal to the median-of-medians, and about $\frac{d}{2}$ elements in each such sublist are greater
  than or equal to their median and thereby also than the median-of-medians.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-size_less_than_median_of_medians_strong"><span class="command">lemma</span></span> size_less_than_median_of_medians_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> median<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟹</span> is_median <span class="main">(</span><span class="free">med</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> median'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≡</span> length <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="comment1">― ‹The medians of the sublists›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> mset <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> mset <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹The sublists with a smaller median than the median-of-medians <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">x</span></span><span class="antiquote">}</span></span> and the rest.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS1</span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> <span class="free">med</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS2</span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">ys</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="free">med</span> <span class="bound">ys</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mset <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="comment1">― ‹At most roughly half of the lists have a median that is smaller than <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">M</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">YS1</span> <span class="main">=</span> size <span class="main">(</span>image_mset <span class="free">med</span> <span class="skolem">YS1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"image_mset <span class="free">med</span> <span class="skolem">YS1</span> <span class="main">=</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> YS1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_mset_image_mset <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">…</span> <span class="main">≤</span> <span class="main">(</span>length <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> median' <span class="keyword1"><span class="command">unfolding</span></span> is_median_altdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> size_YS1<span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="skolem">YS1</span> <span class="main">≤</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> size <span class="main">(</span>mset <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mset <span class="main">(</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">YS1</span> <span class="main">+</span> <span class="skolem">YS2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> YS1_def YS2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_partition<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> m_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> size <span class="skolem">YS1</span> <span class="main">+</span> size <span class="skolem">YS2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="comment1">― ‹We estimate the number of elements less than <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">x</span></span><span class="antiquote">}</span></span> by grouping them into elements
      coming from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">YS1</span></span><span class="antiquote">}</span></span> and elements coming from <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">YS2</span></span><span class="antiquote">}</span></span>. In the first case, we 
      just note that no more than <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">d</span></span><span class="antiquote">}</span></span> elements can come from each sublist, whereas in
      the second case, we make the analysis more precise and note that only elements that are
      less than the median of their sublist can be less than <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">x</span></span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">←</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">.</span> mset <span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_msets_chop<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">←</span>chop <span class="free">d</span> <span class="free">xs</span><span class="main">.</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_mset_sum_list<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS</span><span class="main">.</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> YS_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_mset_sum_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> <span class="skolem">YS1</span> <span class="main">+</span> <span class="skolem">YS2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> YS_def YS1_def YS2_def not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="main">…</span><span class="main">.</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> 
               <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS1</span><span class="main">.</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS2</span><span class="main">.</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆#</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS1</span><span class="main">.</span> mset <span class="bound">ys</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS2</span><span class="main">.</span> <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">med</span> <span class="bound">ys</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> subset_mset.add_mono sum_mset_mset_mono mset_filter_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> YS2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">#}</span> <span class="main">⊆#</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span> <span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">#}</span> <span class="main">≤</span> size <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> size_mset_mono<span class="main">)</span>

  <span class="comment1">― ‹We do some further straightforward estimations and arrive at our goal.›</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS1</span><span class="main">.</span> length <span class="bound">ys</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈#</span><span class="skolem">YS2</span><span class="main">.</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">x</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">med</span> <span class="bound">x</span><span class="main">#}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_mset_sum_mset_distrib multiset.map_comp o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS1</span><span class="main">.</span> length <span class="bound">ys</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS1</span><span class="main">.</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mset_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> YS1_def length_chop_part_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size <span class="skolem">YS1</span> <span class="main">*</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">YS1</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> size <span class="skolem">YS1</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">YS1</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> d<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS2</span><span class="main">.</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="bound">ys</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">med</span> <span class="bound">ys</span><span class="main">#}</span><span class="main">)</span> <span class="main">≤</span>
               <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS2</span><span class="main">.</span> length <span class="bound">ys</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mset_mono size_less_than_median<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">≤</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> YS2_def length_chop_part_le<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> median<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_median_altdef<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">ys</span><span class="main">∈#</span><span class="skolem">YS2</span><span class="main">.</span> <span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> sum_mset_mono div_le_mono diff_le_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> YS2_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> length_chop_part_le<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size <span class="skolem">YS2</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">YS1</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">YS1</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">…</span> <span class="main">=</span>
               <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> size <span class="skolem">YS1</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_eq <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="skolem">YS1</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mult_right_mono size_YS1<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">≤</span>
                  <span class="free">m</span> <span class="main">*</span> <span class="main">(</span><span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="free">m</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now focus on the case of an odd chopping size and make some further estimations to 
  simplify the above result a little bit.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> size_less_than_median_of_medians<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> median<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">≤</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> is_median <span class="main">(</span><span class="free">med</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> median'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> real <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">≤</span> nat <span class="main">⌈</span><span class="free">c</span> <span class="main">*</span> <span class="free">n</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> length <span class="main">(</span>chop <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">(</span>nat <span class="main">⌈</span>real <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="free">d</span><span class="main">)</span><span class="main">⌉</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> m_def length_chop n_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>nat <span class="main">⌈</span>real <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="free">d</span><span class="main">)</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span>
               of_int <span class="main">⌈</span>real <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="free">d</span><span class="main">)</span><span class="main">⌉</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> of_nat_nat<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="main">(</span>real <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> real <span class="free">d</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_right_mono<span class="main">)</span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> real <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"real <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="skolem">m</span> <span class="main">+</span> Suc <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> size_less_than_median_of_medians_strong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">med</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> Suc <span class="free">d</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_left_mono<span class="main">)</span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">m</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real <span class="main">(</span>size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">#}</span><span class="main">)</span> <span class="main">≤</span> real <span class="main">…</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> of_nat_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> real <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">+</span> real <span class="free">d</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> of_nat_add of_nat_mult of_nat_1 of_nat_numeral
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono mult_mono order.refl m<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> m_def length_chop n_def add_ac<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> real <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> real <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> c_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> real <span class="main">(</span>nat <span class="main">⌈</span><span class="free">c</span> <span class="main">*</span> <span class="free">n</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> of_nat_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> add_mono<span class="main">)</span> <span class="main">(</span><span class="operator">linarith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> of_nat_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_ac<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We get the analogous result for the number of elements that are greater than a median-of-medians
  by looking at the dual order and using the \emph{transfer} method.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> size_greater_than_median_of_medians<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">d</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> median<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">≤</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="main">⟹</span> is_median <span class="main">(</span><span class="free">med</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> median'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≡</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≡</span> <span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> real <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">≤</span> nat <span class="main">⌈</span><span class="free">c</span> <span class="main">*</span> <span class="free">n</span><span class="main">⌉</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">5</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">include</span></span> lifting_syntax
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">med'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">med'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> to_dual_ord <span class="main">(</span><span class="free">med</span> <span class="main">(</span>map of_dual_ord <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map of_dual_ord <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"list_all2 cr_dual_ord <span class="skolem">xs</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ys</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cr_dual_ord_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>list_all2 <span class="main">(</span>pcr_dual_ord <span class="main">(=)</span><span class="main">)</span> <span class="main">===&gt;</span> pcr_dual_ord <span class="main">(=)</span><span class="main">)</span> <span class="free">med</span> <span class="skolem">med'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_fun_def pcr_dual_ord_def OO_def med'_def cr_dual_ord_def 
                   dual_ord.to_dual_ord_inverse<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="free">xs</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">#}</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> size_mset <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_filter<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>map to_dual_ord <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> to_dual_ord <span class="bound">y</span> <span class="main">&lt;</span> to_dual_ord <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map to_dual_ord <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map to_dual_ord <span class="main">(</span>filter <span class="main">…</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> to_dual_ord <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map to_dual_ord <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_map o_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> size <span class="main">{#</span><span class="bound">y</span> <span class="main">∈#</span> mset <span class="main">(</span>map to_dual_ord <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> to_dual_ord <span class="free">x</span><span class="main">#}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> size_mset <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mset_filter<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> nat <span class="main">⌈</span><span class="main">(</span><span class="numeral">3</span> <span class="main">*</span> real <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> real <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> length <span class="main">(</span>map to_dual_ord <span class="free">xs</span><span class="main">)</span><span class="main">⌉</span>
                    <span class="main">+</span> <span class="numeral">5</span> <span class="main">*</span> <span class="free">d</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> size_less_than_median_of_medians<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dual_ord list"</span></span> <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≤</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> xs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span><span class="skolem">med'</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> median<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>to_dual_ord <span class="free">x</span><span class="main">)</span> <span class="main">(</span>map <span class="skolem">med'</span> <span class="main">(</span>chop <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map to_dual_ord <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> median' <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def c_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The most important case is that of chopping size 5, since that is the most practical one
  for the median-of-medians selection algorithm. For it, we obtain the following nice
  and simple bounds:
›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> size_less_greater_median_of_medians_5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">≤</span> <span class="numeral">5</span> <span class="main">⟹</span> is_median <span class="main">(</span><span class="free">med</span> <span class="bound">xs</span><span class="main">)</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_median <span class="free">x</span> <span class="main">(</span>map <span class="free">med</span> <span class="main">(</span>chop <span class="numeral">5</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> nat <span class="main">⌈</span><span class="numeral">0.7</span> <span class="main">*</span> length <span class="free">xs</span><span class="main">⌉</span> <span class="main">+</span> <span class="numeral">6</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> nat <span class="main">⌈</span><span class="numeral">0.7</span> <span class="main">*</span> length <span class="free">xs</span><span class="main">⌉</span> <span class="main">+</span> <span class="numeral">6</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> size_less_than_median_of_medians<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">med</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
        size_greater_than_median_of_medians<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">med</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size_mset <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mset_filter mult_ac add_ac <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> size_mset<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The recursive step›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now turn to the actual selection algorithm itself. The following simple reduction lemma 
  illustrates the idea of the algorithm quite well already, but it has the disadvantage that,
  if one were to use it as a recursive algorithm, it would only work for lists with distinct
  elements. If the list contains repeated elements, this may not even terminate.

  The basic idea is that we choose some pivot element, partition the list into elements that 
  are bigger than the pivot and those that are not, and then recurse into one of these (hopefully
  smaller) lists.
›</span></span>
<span class="keyword1"><span class="command">theorem</span></span> select_rec_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
           <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> partition <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>
           <span class="keyword1">in</span>  <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="bound">ys</span> <span class="keyword1">then</span> select <span class="free">k</span> <span class="bound">ys</span> <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> length <span class="bound">ys</span><span class="main">)</span> <span class="bound">zs</span>
          <span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> select <span class="free">k</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> select_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys_def zs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="skolem">ys</span> <span class="keyword1">then</span> select <span class="free">k</span> <span class="skolem">ys</span> <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> length <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> select_append'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ys_def zs_def sum_length_filter_compl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ys_def zs_def Let_def o_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following variant uses a three-way partitioning function instead. This way, the size of
  the list in the final recursive call decreases by a factor of at least $\frac{3d'+1}{2(2d'+1)}$ 
  by the previous estimates, given that the chopping size is $d = 2d'+1$. For a chopping size of 5,
  we get a factor of $0.7$. 
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">threeway_partition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">::</span> linorder list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">threeway_partition</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-threeway_partition_code"><span class="command">lemma</span></span> threeway_partition_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"threeway_partition <span class="free">x</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"threeway_partition <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">case</span> threeway_partition <span class="free">x</span> <span class="free">ys</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">gs</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">gs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">gs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">gs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> threeway_partition_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> select_rec_threeway_partition<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
           <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">gs</span><span class="main">)</span> <span class="main">=</span> threeway_partition <span class="free">x</span> <span class="free">xs</span><span class="main">;</span>
               <span class="bound">nl</span> <span class="main">=</span> length <span class="bound">ls</span><span class="main">;</span> <span class="bound">ne</span> <span class="main">=</span> length <span class="bound">es</span>
           <span class="keyword1">in</span>
             <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">nl</span> <span class="keyword1">then</span> select <span class="free">k</span> <span class="bound">ls</span> 
             <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">nl</span> <span class="main">+</span> <span class="bound">ne</span> <span class="keyword1">then</span> <span class="free">x</span>
             <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">nl</span> <span class="main">-</span> <span class="bound">ne</span><span class="main">)</span> <span class="bound">gs</span>
          <span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
                    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nl</span></span> <span class="skolem"><span class="skolem">ne</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nl</span> <span class="main">=</span> length <span class="skolem">ls</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ne</span> <span class="main">=</span> length <span class="skolem">es</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> mset_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mset <span class="free">xs</span> <span class="main">=</span> mset <span class="skolem">ls</span> <span class="main">+</span> mset <span class="skolem">es</span> <span class="main">+</span> mset <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ls_def es_def gs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> length_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="skolem">ls</span> <span class="main">+</span> length <span class="skolem">es</span> <span class="main">+</span> length <span class="skolem">gs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ls_def es_def gs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"select <span class="skolem">i</span> <span class="skolem">es</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">es</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"select <span class="skolem">i</span> <span class="skolem">es</span> <span class="main">∈</span> set <span class="main">(</span>sort <span class="skolem">es</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> select_def
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_mem<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"select <span class="skolem">i</span> <span class="skolem">es</span> <span class="main">∈</span> set <span class="skolem">es</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> select_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">es</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> es_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">es</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> select <span class="free">k</span> <span class="main">(</span><span class="skolem">ls</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="skolem">gs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> select_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="keyword1">then</span> select <span class="free">k</span> <span class="skolem">ls</span> <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span><span class="main">)</span> <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="skolem">gs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> nl_ne_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> select_append'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ls_def es_def gs_def length_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="keyword1">then</span> select <span class="free">k</span> <span class="skolem">ls</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="main">+</span> <span class="skolem">ne</span> <span class="keyword1">then</span> <span class="free">x</span>
                    <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs'</span> <span class="main">=</span> <span class="var">?rhs'</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs'</span> <span class="main">=</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span><span class="main">)</span> <span class="main">(</span><span class="skolem">es</span> <span class="main">@</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">&lt;</span> <span class="skolem">ne</span> <span class="keyword1">then</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span><span class="main">)</span> <span class="skolem">es</span> <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> nl_ne_def <span class="keyword1"><span class="command">using</span></span> assms False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> select_append'<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ls_def es_def gs_def length_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">&lt;</span> <span class="skolem">ne</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> threeway_partition_def Let_def ls_def es_def gs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By the above results, it can be seen quite easily that, in each recursive step, the algorithm
  takes a list of length $n$, does $O(n)$ work for the chopping, computing the medians of the
  sublists, and partitioning, and it calls itself recursively with lists of size at most
  $\lceil 0.2n\rceil$ and $\lceil 0.7n\rceil + 6$, respectively. This means that the runtime
  of the algorithm is bounded above by the Akra--Bazzi-style recurrence
    \[T(n) = T(\lceil 0.2n\rceil) + T(\lceil 0.7n\rceil + 6) + O(n)\]
  which, by the Akra--Bazzi theorem, can be shown to fulfil $T\in \Theta(n)$.

  However, a proper analysis of this would require an actual execution model and some way of 
  measuring the runtime of the algorithm, which is not what we aim to do here. Additionally, the
  entire algorithm can be performed in-place in an imperative way, but this because quite tedious.

  Instead of this, we will now focus on developing the above recursion into an executable 
  functional algorithm.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Medians of lists of length at most 5›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show some basic results about how to efficiently find a median of a list of size
  at most 5. For length 1 or 2, this is trivial, since we can just pick any element. For length 
  3 and 4, we need at most three comparisons. For length 5, we need at most six comparisons.

  This allows us to save some comparisons compared with the naive method of performing insertion
  sort and then returning the element in the middle.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">median_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">median_3</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> max <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>
      <span class="keyword1">else</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">else</span> min <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_3"><span class="command">lemma</span></span> median_3<span class="main">:</span> <span class="quoted"><span class="quoted">"median_3 <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="main">=</span> median <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> median_3_def median_def select_def min_def max_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">median_5_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">median_5_aux</span> <span class="free"><span class="bound"><span class="entity">x1</span></span></span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="keyword1">then</span> min <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="keyword1">else</span> min <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="keyword1">then</span> min <span class="free"><span class="bound"><span class="entity">x3</span></span></span> <span class="free"><span class="bound"><span class="entity">x5</span></span></span> <span class="keyword1">else</span> min <span class="free"><span class="bound"><span class="entity">x2</span></span></span> <span class="free"><span class="bound"><span class="entity">x4</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_5_aux"><span class="command">lemma</span></span> median_5_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≤</span> <span class="free">x2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x4</span> <span class="main">≤</span> <span class="free">x5</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x1</span> <span class="main">≤</span> <span class="free">x4</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"median_5_aux <span class="free">x1</span> <span class="free">x2</span> <span class="free">x3</span> <span class="free">x4</span> <span class="free">x5</span> <span class="main">=</span> median <span class="main">[</span><span class="free">x1</span><span class="main">,</span><span class="free">x2</span><span class="main">,</span><span class="free">x3</span><span class="main">,</span><span class="free">x4</span><span class="main">,</span><span class="free">x5</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> median_5_aux_def median_def select_def min_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">median_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder <span class="main">⇒</span> <span class="main">_</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">median_5</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">let</span> <span class="main">(</span><span class="bound">x1</span><span class="main">,</span> <span class="bound">x2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
         <span class="main">(</span><span class="bound">x4</span><span class="main">,</span> <span class="bound">x5</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">in</span>
         <span class="keyword1">if</span> <span class="bound">x1</span> <span class="main">≤</span> <span class="bound">x4</span> <span class="keyword1">then</span> median_5_aux <span class="bound">x1</span> <span class="bound">x2</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x4</span> <span class="bound">x5</span> <span class="keyword1">else</span> median_5_aux <span class="bound">x4</span> <span class="bound">x5</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">x1</span> <span class="bound">x2</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_5"><span class="command">lemma</span></span> median_5<span class="main">:</span> <span class="quoted"><span class="quoted">"median_5 <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="free">e</span> <span class="main">=</span> median <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> median_5_def Let_def median_5_aux <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> median_cong<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">median_le_5</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">median_le_5</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">median_le_5</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">median_le_5</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span> <span class="main">=</span> median_3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">median_le_5</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span> <span class="main">=</span> median_3 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">median_le_5</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span> <span class="main">=</span> median_5 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">median_le_5</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_5_in_set"><span class="command">lemma</span></span> median_5_in_set<span class="main">:</span> <span class="quoted"><span class="quoted">"median_5 <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="free">e</span> <span class="main">∈</span> <span class="main">{</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">,</span> <span class="free">e</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"median_5 <span class="free">a</span> <span class="free">b</span> <span class="free">c</span> <span class="free">d</span> <span class="free">e</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">d</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> median_5 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> median_in_set<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_le_5_in_set"><span class="command">lemma</span></span> median_le_5_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">5</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"median_le_5 <span class="free">xs</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> median_le_5.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> median_5_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="skolem">e</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> median_3_def min_def max_def<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-median_le_5"><span class="command">lemma</span></span> median_le_5<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">5</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>median_le_5 <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> median_le_5.cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>median <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"median <span class="free">xs</span> <span class="main">=</span> median_3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> median_3 3<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>median <span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"median <span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">]</span> <span class="main">=</span> median_3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> median_3 4<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>median_3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> is_median_Cons_odd<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?this</span> <span class="main">⟷</span> is_median <span class="main">(</span>median_3 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">d</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> is_median_cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_median <span class="main">(</span>median <span class="free">xs</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"median <span class="free">xs</span> <span class="main">=</span> median_5 <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> median_5 5<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_median_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Median-of-medians selection algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The fast selection function now simply computes the median-of-medians of the chopped-up list
  as a pivot, partitions the list into with respect to that pivot, and recurses into one of 
  the resulting sublists.
›</span></span>
<span class="keyword1"><span class="command">function</span></span> <span class="entity">fast_select</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fast_select</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≤</span> <span class="numeral">20</span> <span class="keyword1">then</span>
       sort <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span>
     <span class="keyword1">else</span>
       <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">fast_select</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
           <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">gs</span><span class="main">)</span> <span class="main">=</span> threeway_partition <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
       <span class="keyword1">in</span>
         <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="bound">ls</span> <span class="keyword1">then</span> <span class="free">fast_select</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">ls</span> 
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">&lt;</span> length <span class="bound">ls</span> <span class="main">+</span> length <span class="bound">es</span> <span class="keyword1">then</span> <span class="bound">x</span>
         <span class="keyword1">else</span> <span class="free">fast_select</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">-</span> length <span class="bound">ls</span> <span class="main">-</span> length <span class="bound">es</span><span class="main">)</span> <span class="bound">gs</span>
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The correctness of this is obvious from the above theorems, but the proof is still
  somewhat complicated by the fact that termination depends on the correctness of the
  function.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-fast_select_correct_aux"><span class="command">lemma</span></span> fast_select_correct_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fast_select_dom <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fast_select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> select <span class="free">k</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≤</span> <span class="numeral">20</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="quoted">"1.hyps"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fast_select.psimps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> select_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> fast_select <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">es</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">es</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nl</span></span> <span class="skolem"><span class="skolem">ne</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nl</span> <span class="main">=</span> length <span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ne</span> <span class="main">=</span> length <span class="skolem">es</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> nl_def ne_def x_def ls_def es_def gs_def
    <span class="keyword1"><span class="command">have</span></span> tw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">gs</span><span class="main">)</span> <span class="main">=</span> threeway_partition <span class="main">(</span>fast_select <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>
                               <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> threeway_partition_def defs One_nat_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">have</span></span> tw'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">gs</span><span class="main">)</span> <span class="main">=</span> threeway_partition <span class="skolem">x</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tw x_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fast_select <span class="skolem">k</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="keyword1">then</span> fast_select <span class="skolem">k</span> <span class="skolem">ls</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="main">+</span> <span class="skolem">ne</span> <span class="keyword1">then</span> <span class="skolem">x</span>
                                <span class="keyword1">else</span> fast_select <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.hyps"</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fast_select.psimps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> threeway_partition_def defs <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="keyword1">then</span> select <span class="skolem">k</span> <span class="skolem">ls</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="main">+</span> <span class="skolem">ne</span> <span class="keyword1">then</span> <span class="skolem">x</span> 
                       <span class="keyword1">else</span> select <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> if_cong refl<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fast_select <span class="skolem">k</span> <span class="skolem">ls</span> <span class="main">=</span> select <span class="skolem">k</span> <span class="skolem">ls</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> refl tw<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> 
           <span class="main">(</span><span class="operator">insert</span> *<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> False threeway_partition_def ls_def x_def nl_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">nl</span> <span class="main">+</span> <span class="skolem">ne</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">ls</span> <span class="main">+</span> length <span class="skolem">es</span> <span class="main">+</span> length <span class="skolem">gs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ls_def es_def gs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fast_select <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span> <span class="main">=</span> select <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="skolem">nl</span> <span class="main">-</span> <span class="skolem">ne</span><span class="main">)</span> <span class="skolem">gs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> nl_def ne_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">rule</span> refl tw<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> False * ** <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nl_def ne_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> select <span class="skolem">k</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> select_rec_threeway_partition<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral"><span class="numeral">5</span></span></span><span class="main"><span class="main"><span class="main">::</span></span></span>nat"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">unfold</span> Let_def nl_def ne_def ls_def gs_def es_def x_def threeway_partition_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Termination of the algorithm is reasonably obvious because the lists that are recursed into
  never contain the pivot (the median-of-medians), while the original list clearly does.
  The proof is still somewhat technical though.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-fast_select_termination"><span class="command">lemma</span></span> fast_select_termination<span class="main">:</span> <span class="quoted"><span class="quoted">"All fast_select_dom"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">k</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_chop nat_less_iff ceiling_less_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="skolem">ls</span> <span class="skolem">es</span> <span class="skolem">gs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> fast_select <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="skolem">xs</span> <span class="main">≤</span> <span class="numeral">20</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ls</span><span class="main">,</span> <span class="skolem">es</span><span class="main">,</span> <span class="skolem">gs</span><span class="main">)</span> <span class="main">=</span> threeway_partition <span class="skolem">x</span> <span class="skolem">xs</span>"</span></span>
            <span class="quoted"><span class="quoted">"fast_select_dom <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">,</span> 
                             map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ls</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">gs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_def threeway_partition_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">=</span> nat <span class="main">⌈</span>length <span class="skolem">xs</span> <span class="main">/</span> <span class="numeral">5</span><span class="main">⌉</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌈</span>real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">5</span><span class="main">⌉</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="main">&lt;</span> nat <span class="main">⌈</span>real <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">5</span><span class="main">⌉</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> select <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fast_select_correct_aux A<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_chop len<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> median <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> median_def len length_chop<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> median_in_set<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span>median_le_5 <span class="bound">ys</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ys</span><span class="main">∈</span>set <span class="main">(</span>chop <span class="numeral">5</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> set <span class="bound">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> UN_mono<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> median_le_5_in_set length_chop_part_le<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> UN_sets_chop<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>  
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">ls</span><span class="main">)</span><span class="main">,</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> length <span class="skolem">ls</span> <span class="main">-</span> length <span class="skolem">es</span><span class="main">,</span> <span class="skolem">gs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> measure <span class="main">(</span>length <span class="main">∘</span> snd<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> length_filter_less<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now have all the ingredients to show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fast_select<span class="antiquote"><span class="antiquote">}</span></span></span></span> terminates and does,
  indeed, compute the $k$-th order statistic.
›</span></span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">fast_select</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fast_select_termination<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fast_select_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> fast_select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> select <span class="free">k</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fast_select_termination <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> fast_select_correct_aux<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following version is then suitable for code export.
›</span></span>
<span class="keyword1" id="Median_Of_Medians_Selection-fast_select_code"><span class="command">lemma</span></span> fast_select_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"fast_select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
     <span class="keyword1">if</span> length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">20</span> <span class="keyword1">then</span>
       fold insort <span class="free">xs</span> <span class="main">[]</span> <span class="main">!</span> <span class="free">k</span>
     <span class="keyword1">else</span>
       <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> fast_select <span class="main">(</span><span class="main">(</span><span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="numeral">4</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">5</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>map median_le_5 <span class="main">(</span>chop <span class="numeral">5</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
           <span class="main">(</span><span class="bound">ls</span><span class="main">,</span> <span class="bound">es</span><span class="main">,</span> <span class="bound">gs</span><span class="main">)</span> <span class="main">=</span> threeway_partition <span class="bound">x</span> <span class="free">xs</span><span class="main">;</span>
           <span class="bound">nl</span> <span class="main">=</span> length <span class="bound">ls</span><span class="main">;</span> <span class="bound">ne</span> <span class="main">=</span> <span class="bound">nl</span> <span class="main">+</span> length <span class="bound">es</span>
       <span class="keyword1">in</span>
         <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">nl</span> <span class="keyword1">then</span> fast_select <span class="free">k</span> <span class="bound">ls</span> 
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> <span class="bound">ne</span> <span class="keyword1">then</span> <span class="bound">x</span>
         <span class="keyword1">else</span> fast_select <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="bound">ne</span><span class="main">)</span> <span class="bound">gs</span>
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fast_select.simps<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span> sort_conv_fold<span class="main">)</span>

<span class="keyword1" id="Median_Of_Medians_Selection-select_code"><span class="command">lemma</span></span> select_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"select <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="keyword1">then</span> fast_select <span class="free">k</span> <span class="free">xs</span> 
                    <span class="keyword1">else</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''Selection index out of bounds.''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> select <span class="free">k</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> if_True fast_select_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Code.abort_def if_False<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>